
/* ==== IN√çCIO: public/scripts/01_Create_Obra/features/calculations/air-flow.js ==== */
/**
 * features/calculations/air-flow.js
 * Sistema unificado de c√°lculos de vaz√£o de ar - FUS√ÉO: airFlowCalculations.js + airFlowDisplay.js
 * C√°lculos de fluxo de ar baseados em pressuriza√ß√£o e portas
 */

import { CALCULATION_CONSTANTS } from '../../core/constants.js';
import {  
    waitForSystemConstants, 
    validateSystemConstants, 
    collectClimatizationInputs,
    findClimatizationSection,
    safeNumber 
} from './calculations-core.js';

// =============================================================================
// C√ÅLCULOS DE FLUXO DE AR
// =============================================================================

/**
 * Calcula fluxo de ar individual por porta
 * @param {number} doorCount - N√∫mero de portas
 * @param {number} doorVariable - Vari√°vel espec√≠fica da porta
 * @param {number} pressure - Pressuriza√ß√£o em Pa
 * @returns {number} Fluxo de ar em m¬≥/h
 */
function calculateDoorFlow(doorCount, doorVariable, pressure) {
    const count = safeNumber(doorCount);
    const variable = safeNumber(doorVariable);
    const press = safeNumber(pressure);

    const pressureExponent = press > 0 ? Math.pow(press, CALCULATION_CONSTANTS.PRESSURE_EXPONENT) : 0;

    return CALCULATION_CONSTANTS.FLOW_COEFFICIENT *
           count *
           variable *
           pressureExponent *
           CALCULATION_CONSTANTS.SECONDS_PER_HOUR;
}

/**
 * Calcula vaz√£o total de ar baseada em portas e pressuriza√ß√£o
 * @param {Object} inputData - Dados de entrada
 * @returns {number} Vaz√£o total em l/s
 */
function computeAirFlowRate(inputData) {
    const numPortasDuplas = safeNumber(inputData.numPortasDuplas);
    const numPortasSimples = safeNumber(inputData.numPortasSimples);
    const pressure = inputData.pressurizacao ? safeNumber(inputData.setpointTemp) : 0;

    // Valida√ß√£o de constantes
    if (!window.systemConstants?.VARIAVEL_PD || !window.systemConstants?.VARIAVEL_PS) {
        console.error("Constantes do sistema n√£o dispon√≠veis");
        return 0;
    }

    const doubleDoorFlow = calculateDoorFlow(numPortasDuplas, window.systemConstants.VARIAVEL_PD, pressure);
    const singleDoorFlow = calculateDoorFlow(numPortasSimples, window.systemConstants.VARIAVEL_PS, pressure);

    const totalFlow = doubleDoorFlow + singleDoorFlow;
    const adjustedFlow = totalFlow / CALCULATION_CONSTANTS.FLOW_DIVISOR;
    const finalFlow = adjustedFlow * CALCULATION_CONSTANTS.SAFETY_FACTOR;

    return Math.ceil(finalFlow);
}

// =============================================================================
// ORQUESTRA√á√ÉO DE C√ÅLCULOS
// =============================================================================

/**
 * Executa c√°lculo completo de vaz√£o de ar
 * @param {string} roomId - ID √∫nico da sala
 * @param {boolean} calculateThermal - Calcular ganhos t√©rmicos ap√≥s
 * @returns {Promise<number>} Vaz√£o calculada em l/s
 */
async function calculateVazaoAr(roomId, calculateThermal = true) {
    try {
        if (!roomId) {
            console.error("ID de sala inv√°lido");
            return 0;
        }

        await waitForSystemConstants();

        if (!validateSystemConstants()) {
            console.error("Constantes do sistema inv√°lidas");
            return 0;
        }

        const climaSection = findClimatizationSection(roomId);
        if (!climaSection) {
            console.error(`Se√ß√£o de climatiza√ß√£o n√£o encontrada: ${roomId}`);
            return 0;
        }

        const inputData = collectClimatizationInputs(climaSection, roomId);
        const flowRate = computeAirFlowRate(inputData);

        updateFlowRateDisplay(roomId, flowRate);

        // C√°lculo de ganhos t√©rmicos se solicitado
        if (calculateThermal) {
            const { calculateThermalGains } = await import('./thermal-gains.js');
            await calculateThermalGains(roomId, flowRate);
        }

        return flowRate;

    } catch (error) {
        console.error(`Erro no c√°lculo de vaz√£o para ${roomId}:`, error);
        return 0;
    }
}

/**
 * Coordena c√°lculo sequencial de vaz√£o e ganhos t√©rmicos
 * @param {string} roomId - ID √∫nico da sala
 * @returns {Promise<void>}
 */
async function calculateVazaoArAndThermalGains(roomId) {
    try {
        if (!roomId) {
            console.error("ID de sala inv√°lido");
            return;
        }
        
        const flowRate = await calculateVazaoAr(roomId, false);
        
        const { calculateThermalGains } = await import('./thermal-gains.js');
        await calculateThermalGains(roomId, flowRate);
        
    } catch (error) {
        console.error(`Erro no c√°lculo coordenado para ${roomId}:`, error);
    }
}

// =============================================================================
// ATUALIZA√á√ÉO DE DISPLAY
// =============================================================================

/**
 * Atualiza exibi√ß√£o do resultado de vaz√£o na interface
 * @param {string} roomId - ID da sala
 * @param {number} flowRate - Vaz√£o calculada
 */
function updateFlowRateDisplay(roomId, flowRate) {
    const resultElement = document.getElementById(`vazao-ar-${roomId}`);
    if (resultElement) {
        resultElement.textContent = flowRate;
        console.log(`‚úÖ Vaz√£o atualizada para ${roomId}: ${flowRate} l/s`);
    } else {
        console.error(`Elemento de vaz√£o n√£o encontrado: vazao-ar-${roomId}`);
    }
}

// =============================================================================
// VALIDA√á√ïES E UTILIT√ÅRIOS
// =============================================================================

/**
 * Valida dados de entrada para c√°lculo de vaz√£o
 * @param {Object} inputData - Dados de entrada
 * @returns {boolean} True se dados s√£o v√°lidos
 */
function validateAirFlowInputs(inputData) {
    const required = ['numPortasDuplas', 'numPortasSimples'];
    const missing = required.filter(field => 
        inputData[field] === undefined || inputData[field] === null || inputData[field] === ''
    );
    
    if (missing.length > 0) {
        console.warn(`Campos obrigat√≥rios faltando: ${missing.join(', ')}`);
        return false;
    }
    
    // Valida√ß√µes num√©ricas
    if (safeNumber(inputData.numPortasDuplas) < 0 || safeNumber(inputData.numPortasSimples) < 0) {
        console.warn("Quantidade de portas n√£o pode ser negativa");
        return false;
    }
    
    if (inputData.pressurizacao && safeNumber(inputData.setpointTemp) < 0) {
        console.warn("Pressuriza√ß√£o n√£o pode ser negativa");
        return false;
    }
    
    return true;
}

/**
 * Prepara dados para c√°lculo de vaz√£o
 * @param {Object} rawData - Dados brutos
 * @returns {Object} Dados preparados
 */
function prepareAirFlowData(rawData) {
    const prepared = { ...rawData };
    
    // Converter campos num√©ricos
    const numericFields = ['numPortasDuplas', 'numPortasSimples', 'setpointTemp'];
    numericFields.forEach(field => {
        if (prepared[field] !== undefined) {
            prepared[field] = safeNumber(prepared[field]);
        }
    });
    
    // Garantir valores padr√£o
    if (prepared.numPortasDuplas === undefined) prepared.numPortasDuplas = 0;
    if (prepared.numPortasSimples === undefined) prepared.numPortasSimples = 0;
    if (prepared.pressurizacao === undefined) prepared.pressurizacao = false;
    if (prepared.setpointTemp === undefined) prepared.setpointTemp = 0;
    
    return prepared;
}

/**
 * Obt√©m estat√≠sticas do c√°lculo de vaz√£o
 * @param {Object} inputData - Dados de entrada
 * @param {number} result - Resultado do c√°lculo
 * @returns {Object} Estat√≠sticas
 */
function getAirFlowStats(inputData, result) {
    const numPortasDuplas = safeNumber(inputData.numPortasDuplas);
    const numPortasSimples = safeNumber(inputData.numPortasSimples);
    const pressure = inputData.pressurizacao ? safeNumber(inputData.setpointTemp) : 0;
    
    return {
        totalPortas: numPortasDuplas + numPortasSimples,
        portasDuplas: numPortasDuplas,
        portasSimples: numPortasSimples,
        pressurizacaoAtiva: inputData.pressurizacao,
        pressurizacaoValue: pressure,
        vazaoResultante: result,
        timestamp: new Date().toISOString()
    };
}

// =============================================================================
// EXPORTA√á√ïES
// =============================================================================

export {
    // C√°lculos principais
    calculateDoorFlow,
    computeAirFlowRate,
    calculateVazaoAr,
    calculateVazaoArAndThermalGains,
    
    // Display
    updateFlowRateDisplay,
    
    // Valida√ß√µes e utilit√°rios
    validateAirFlowInputs,
    prepareAirFlowData,
    getAirFlowStats
};

// =============================================================================
// DISPONIBILIZA√á√ÉO GLOBAL
// =============================================================================

if (typeof window !== 'undefined') {
    window.airFlowCalculations = {
        calculateVazaoAr,
        calculateVazaoArAndThermalGains,
        updateFlowRateDisplay,
        computeAirFlowRate
    };
}
/* ==== FIM: public/scripts/01_Create_Obra/features/calculations/air-flow.js ==== */

/* ==== IN√çCIO: public/scripts/01_Create_Obra/data/modules/machines/capacity-calculator.js ==== */
// capacityCalculator.js

import { updateElementText } from '../../../utils/core-utils.js';


/**
 * Encontra o ID da sala a partir de um elemento dentro dela
 * @param {HTMLElement} element - Elemento dentro da sala
 * @returns {string|null} ID da sala ou null se n√£o encontrado
 */
function findRoomId(element) {
    if (!element) return null;
    
    // Buscar o elemento room-block mais pr√≥ximo
    const roomBlock = element.closest('.room-block');
    if (roomBlock) {
        return roomBlock.dataset.roomId || null;
    }
    
    // Tentar extrair do ID do elemento de conte√∫do
    const roomContent = element.closest('[id^="room-content-"]');
    if (roomContent) {
        const match = roomContent.id.match(/room-content-(.+)/);
        if (match) return match[1];
    }
    
    // Tentar extrair de elementos com data-room-id
    const roomElement = element.closest('[data-room-id]');
    if (roomElement) {
        return roomElement.dataset.roomId;
    }
    
    console.warn('‚ùå N√£o foi poss√≠vel encontrar o ID da sala para o elemento:', element);
    return null;
}

// Configura√ß√µes para inicializa√ß√£o do sistema de capacidade
const capacityConfig = {
  maxInitAttempts: 3,
  initDelay: 500
}

// Estado global para controle de inicializa√ß√£o por sala
const capacityState = new Map()

/**
 * Constr√≥i a tabela de c√°lculo de capacidade de refrigera√ß√£o para uma sala
 * @param {string} roomId - ID da sala
 * @returns {string} HTML da tabela de capacidade
 */
function buildCapacityCalculationTable(roomId) {
  scheduleCapacityInit(roomId)
  const backupValue = getBackupFromClimaInputs(roomId)

  return `
    <div class="capacity-calculation-table">
      <h5 class="table-title">C√°lculo de Capacidade de Refrigera√ß√£o</h5>
      <div class="table-container">
        <table class="thermal-capacity-table">
          <thead>
            <tr>
              <th>Carga Estimada (TR)</th>
              <th>Fator de Seg.</th>
              <th>Cap. Unit. (TR)</th>
              <th>Solu√ß√£o</th>
              <th>Com back-up</th>
              <th>TOTAL (TR)</th>
              <th>FOLGA (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="carga-estimada-${roomId}">0</td> 
              <td>
                <input type="number" id="fator-seguranca-${roomId}" step="1" 
                      class="capacity-input" 
                      onchange="calculateCapacitySolution('${roomId}')"
                      oninput="calculateCapacitySolution('${roomId}')">
              </td>
              <td>
                <select id="capacidade-unitaria-${roomId}" class="capacity-select" 
                        onchange="calculateCapacitySolution('${roomId}')">
                  ${[1, 2, 3, 4, 5, 7.5, 10, 12.5, 15, 20, 25, 30]
                    .map((tr) => `<option value="${tr}">${tr} TR</option>`)
                    .join("")}
                </select>
              </td>
              <td id="solucao-${roomId}">0</td>
              <td class="backup-cell">
                <div class="backup-selection">
                  <select class="backup-select" onchange="updateBackupConfiguration(this)">
                    ${["n", "n+1", "n+2"]
                      .map((opt) => `<option value="${opt}" ${backupValue === opt ? "selected" : ""}>${opt}</option>`)
                      .join("")}
                  </select>
                </div>
                <div class="backup-solution">
                  <span id="solucao-backup-${roomId}">0</span>
                </div>
              </td>
              <td id="total-capacidade-${roomId}">0</td>
              <td id="folga-${roomId}">0%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `
}

/**
 * Inicializa a tabela de capacidade est√°tica (para casos espec√≠ficos)
 * @returns {void}
 */
function initializeStaticCapacityTable() {
  const staticTable = document.querySelector(".capacity-calculation-table")
  if (staticTable) {
    scheduleCapacityInit("Projeto1-Sala1")
  }
}

/**
 * Agenda a inicializa√ß√£o do sistema de capacidade para uma sala
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function scheduleCapacityInit(roomId) {
  if (capacityState.has(roomId)) return

  capacityState.set(roomId, { initialized: false, attempts: 0 })
  setTimeout(() => initializeCapacitySystem(roomId), capacityConfig.initDelay)
}

/**
 * Inicializa o sistema de capacidade com tentativas controladas
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function initializeCapacitySystem(roomId) {
  const state = capacityState.get(roomId)
  if (!state || state.initialized) return

  state.attempts++

  const systemConstantsReady = window.systemConstants?.FATOR_SEGURANCA_CAPACIDADE !== undefined

  if (systemConstantsReady || state.attempts >= capacityConfig.maxInitAttempts) {
    const fatorSeguranca = systemConstantsReady
      ? window.systemConstants.FATOR_SEGURANCA_CAPACIDADE
      : 10 // Valor padr√£o sem fallback complexo

    applyFatorSeguranca(roomId, fatorSeguranca)
    state.initialized = true
  }
}

/**
 * Aplica o fator de seguran√ßa ao input correspondente
 * @param {string} roomId - ID da sala
 * @param {number} fatorSeguranca - Valor do fator de seguran√ßa
 * @returns {void}
 */
function applyFatorSeguranca(roomId, fatorSeguranca) {
  const inputFator = document.getElementById(`fator-seguranca-${roomId}`)
  if (!inputFator) return

  inputFator.value = fatorSeguranca
  calculateCapacitySolution(roomId)
}

/**
 * Obt√©m a carga t√©rmica em TR (Tons de Refrigera√ß√£o) para uma sala
 * @param {string} roomId - ID da sala
 * @returns {number} Carga t√©rmica em TR
 */
function getThermalLoadTR(roomId) {
  try {
    const totalTRElement = document.getElementById(`total-tr-${roomId}`)
    if (totalTRElement?.textContent) {
      return Number.parseFloat(totalTRElement.textContent) || 0
    }

    const totalGanhosWElement = document.getElementById(`total-ganhos-w-${roomId}`)
    if (totalGanhosWElement?.textContent) {
      const totalW = Number.parseFloat(totalGanhosWElement.textContent) || 0
      return totalW / 3517
    }

    return 0
  } catch (error) {
    console.error(`Erro ao obter carga t√©rmica para sala ${roomId}:`, error)
    return 0
  }
}

/**
 * Calcula a solu√ß√£o de capacidade de refrigera√ß√£o baseada nos par√¢metros
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function calculateCapacitySolution(roomId) {
  try {
    const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`)
    const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`)
    const cargaEstimadaInput = document.querySelector(`carga-estimada-${roomId} input`)

    if (!fatorSegurancaInput || !capacidadeUnitariaSelect) return

    // Usa o valor do input se existir, sen√£o usa o c√°lculo autom√°tico
    const cargaEstimada = cargaEstimadaInput ? 
      (Number.parseInt(cargaEstimadaInput.value) || 0) : 
      getThermalLoadTR(roomId)

    const fatorSeguranca = Number.parseFloat(fatorSegurancaInput.value) / 100
    const capacidadeUnitaria = Number.parseFloat(capacidadeUnitariaSelect.value)
    const backupType = getBackupFromClimatization(roomId)

    const capacidadeNecessaria = cargaEstimada * (1 + fatorSeguranca)
    const unidadesOperacionais = Math.ceil(capacidadeNecessaria / capacidadeUnitaria)
    const unidadesTotais = applyBackupConfiguration(unidadesOperacionais, backupType)

    const total = unidadesOperacionais * capacidadeUnitaria
    const folga = cargaEstimada > 0 ? (total / cargaEstimada - 1) * 100 : 0

    updateCapacityDisplay(roomId, cargaEstimada, unidadesOperacionais, unidadesTotais, total, folga, backupType)
    
    // ‚úÖ CORRE√á√ÉO: Salvar usando roomId em vez de projectName/roomName
    saveCapacityData(roomId)
  } catch (error) {
    console.error(`Erro ao calcular capacidade para sala ${roomId}:`, error)
  }
}

/**
 * Obt√©m os dados atuais de capacidade de uma sala
 * @param {string} roomId - ID da sala
 * @returns {Object|null} Dados de capacidade ou null se n√£o encontrado
 */
function getCapacityData(roomId) {
  const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`)
  const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`)
  const backupSelect = document.querySelector(`#room-content-${roomId} .backup-select`)

  if (!fatorSegurancaInput || !capacidadeUnitariaSelect || !backupSelect) return null

  return {
    fatorSeguranca: Number.parseFloat(fatorSegurancaInput.value) || 10,
    capacidadeUnitaria: Number.parseFloat(capacidadeUnitariaSelect.value) || 1,
    backup: backupSelect.value || "n",
    cargaEstimada: getThermalLoadTR(roomId),
    solucao: document.getElementById(`solucao-${roomId}`)?.textContent || "0",
    solucaoBackup: document.getElementById(`solucao-backup-${roomId}`)?.textContent || "0",
    totalCapacidade: document.getElementById(`total-capacidade-${roomId}`)?.textContent || "0",
    folga: document.getElementById(`folga-${roomId}`)?.textContent || "0%"
  }
}

/**
 * ‚úÖ CORRE√á√ÉO COMPLETA: Salva os dados de capacidade no servidor usando roomId
 * @param {string} roomId - ID √∫nico da sala
 * @returns {void}
 */
function saveCapacityData(roomId) {
  try {
    const capacityData = getCapacityData(roomId)
    
    if (!capacityData) {
      console.warn(`[CAPACITY] Nenhum dado de capacidade para sala ${roomId}`)
      return
    }

    console.log(`[CAPACITY] Salvando dados para sala: ${roomId}`)

    // ‚úÖ CORRE√á√ÉO: Verificar primeiro se a sala existe localmente (rec√©m-criada)
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomElement) {
      console.log(`[CAPACITY] Sala ${roomId} n√£o encontrada localmente - ignorando save`)
      return;
    }

    // Buscar todas as obras
    fetch(`/obras`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
        return response.json()
      })
      .then(obras => {
        console.log(`[CAPACITY] Obras carregadas:`, obras.map(o => ({ id: o.id, nome: o.nome })))
        
        let obraUpdated = false
        let obraParaAtualizar = null
        
        // Buscar pela sala usando roomId
        for (const obra of obras) {
          for (const projeto of obra.projetos || []) {
            for (const sala of projeto.salas || []) {
              if (sala.id === roomId) {
                // Encontrou a sala pelo ID √∫nico
                if (!sala.capacidade) {
                  sala.capacidade = {}
                }
                
                sala.capacidade = capacityData
                obraUpdated = true
                obraParaAtualizar = obra
                console.log(`[CAPACITY] Dados atualizados na obra ${obra.nome}, projeto ${projeto.nome}, sala ${sala.nome}`)
                break
              }
            }
            if (obraUpdated) break
          }
          if (obraUpdated) break
        }

        if (!obraUpdated) {
          console.log(`[CAPACITY] Sala ${roomId} ainda n√£o salva no servidor - dados mantidos localmente`)
          return
        }

        // Atualizar apenas a obra espec√≠fica
        return fetch(`/obras/${obraParaAtualizar.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(obraParaAtualizar)
        })
      })
      .then(response => {
        if (response && response.ok) {
          console.log(`[CAPACITY] Dados de capacidade salvos para sala ${roomId}`)
        } else if (response) {
          console.log(`[CAPACITY] Erro HTTP ${response.status} ao salvar`)
        }
      })
      .catch(error => {
        console.log(`[CAPACITY] Erro ao buscar obras: ${error.message}`)
      })
      
  } catch (error) {
    console.log(`[CAPACITY] Erro inesperado: ${error.message}`)
  }
}

/**
 * ‚úÖ CORRE√á√ÉO COMPLETA: Carrega os dados de capacidade do servidor para uma sala
 * @param {string} roomId - ID √∫nico da sala
 * @returns {boolean} True se os dados foram carregados com sucesso
 */
function loadCapacityData(roomId) {
  try {
    console.log(`[CAPACITY] Tentando carregar dados para sala ${roomId}`)
    
    // Buscar obras
    fetch(`/obras`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
        return response.json()
      })
      .then(obras => {
        console.log(`[CAPACITY] Obras carregadas:`, obras.map(o => o.nome))
        
        // ‚úÖ CORRE√á√ÉO: Buscar pela sala usando roomId
        for (const obra of obras) {
          for (const projeto of obra.projetos || []) {
            for (const sala of projeto.salas || []) {
              if (sala.id === roomId && sala.capacidade) {
                console.log(`[CAPACITY] Dados encontrados na obra ${obra.nome}, projeto ${projeto.nome}`)
                applyCapacityData(roomId, sala.capacidade)
                return true
              }
            }
          }
        }

        console.log(`[CAPACITY] Nenhum dado de capacidade encontrado para sala ${roomId}`)
        return false
      })
      .catch(error => {
        console.error('[CAPACITY] Erro ao carregar obras:', error)
        return false
      })
      
  } catch (error) {
    console.error('[CAPACITY] Erro geral:', error)
    return false
  }
}

/**
 * Aplica os dados de capacidade carregados aos elementos da interface
 * @param {string} roomId - ID da sala
 * @param {Object} capacityData - Dados de capacidade a serem aplicados
 * @returns {void}
 */
function applyCapacityData(roomId, capacityData) {
  const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`)
  const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`)
  const backupSelect = document.querySelector(`#room-content-${roomId} .backup-select`)

  if (fatorSegurancaInput && capacityData.fatorSeguranca) {
    fatorSegurancaInput.value = capacityData.fatorSeguranca
  }

  if (capacidadeUnitariaSelect && capacityData.capacidadeUnitaria) {
    capacidadeUnitariaSelect.value = capacityData.capacidadeUnitaria
  }

  if (backupSelect && capacityData.backup) {
    backupSelect.value = capacityData.backup
  }

  // Recalcular ap√≥s carregar os dados
  setTimeout(() => {
    calculateCapacitySolution(roomId)
  }, 100)
}

/**
 * Aplica a configura√ß√£o de backup ao n√∫mero de unidades
 * @param {number} unidadesOperacionais - N√∫mero de unidades operacionais
 * @param {string} backupType - Tipo de backup ("n", "n+1", "n+2")
 * @returns {number} N√∫mero total de unidades considerando backup
 */
function applyBackupConfiguration(unidadesOperacionais, backupType) {
  switch (backupType) {
    case "n+1":
      return unidadesOperacionais + 1
    case "n+2":
      return unidadesOperacionais + 2
    default:
      return unidadesOperacionais
  }
}

/**
 * Obt√©m o tipo de backup configurado para climatiza√ß√£o da sala
 * @param {string} roomId - ID da sala
 * @returns {string} Tipo de backup ("n", "n+1", "n+2")
 */
function getBackupFromClimatization(roomId) {
  const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`)
  if (capacityTable) {
    const backupSelect = capacityTable.querySelector(".backup-select")
    if (backupSelect) return backupSelect.value
  }

  return getBackupFromClimaInputs(roomId)
}

/**
 * Obt√©m o backup dos inputs de clima da sala
 * @param {string} roomId - ID da sala
 * @returns {string} Tipo de backup ("n", "n+1", "n+2")
 */
function getBackupFromClimaInputs(roomId) {
  const roomContent = document.getElementById(`room-content-${roomId}`)
  if (roomContent) {
    const backupInput = roomContent.querySelector(`.clima-input[data-field="backup"]`)
    if (backupInput?.value) return backupInput.value
  }
  return "n"
}

/**
 * Atualiza a exibi√ß√£o dos resultados de capacidade na tabela
 * @param {string} roomId - ID da sala
 * @param {number} cargaEstimada - Carga t√©rmica estimada em TR
 * @param {number} solucao - N√∫mero de unidades da solu√ß√£o
 * @param {number} solucaoComBackup - N√∫mero de unidades com backup
 * @param {number} total - Capacidade total em TR
 * @param {number} folga - Percentual de folga
 * @param {string} backupType - Tipo de backup
 * @returns {void}
 */
function updateCapacityDisplay(roomId, cargaEstimada, solucao, solucaoComBackup, total, folga, backupType) {
  
  // Atualizar o campo de carga estimada com input edit√°vel (valor inteiro)
  updateCargaEstimadaInput(roomId, Math.round(cargaEstimada))
  updateElementText(`solucao-${roomId}`, solucao)
  updateElementText(`solucao-backup-${roomId}`, solucaoComBackup)
  updateElementText(`total-capacidade-${roomId}`, total.toFixed(1))
  updateElementText(`folga-${roomId}`, folga.toFixed(1) + "%")

  const backupSelect = document.querySelector(`#room-content-${roomId} .backup-select`)
  if (backupSelect) {
    backupSelect.value = backupType
    backupSelect.disabled = false
  }
}

/**
 * Atualiza ou cria o input para carga estimada (apenas inteiros)
 * @param {string} roomId - ID da sala
 * @param {number} value - Valor a ser definido (inteiro)
 * @returns {void}
 */
function updateCargaEstimadaInput(roomId, value) {
  const cargaEstimadaElement = document.getElementById(`carga-estimada-${roomId}`)
  
  if (!cargaEstimadaElement) return

  // Verificar se j√° existe um input
  let input = cargaEstimadaElement.querySelector('input')
  
  if (!input) {
    // Criar input se n√£o existir
    input = document.createElement('input')
    input.type = 'number'
    input.className = 'capacity-input'
    input.min = '0'
    input.step = '1' // For√ßa n√∫meros inteiros
    input.value = value
    
    // Adicionar evento apenas para salvar, n√£o para recalcular
    input.addEventListener('change', () => {
      // ‚úÖ CORRE√á√ÉO: Salvar usando roomId
      saveCapacityData(roomId)
    })
    
    // Limpar conte√∫do anterior e adicionar o input
    cargaEstimadaElement.innerHTML = ''
    cargaEstimadaElement.appendChild(input)
  } else {
    // Atualiza com o valor calculado quando a fun√ß√£o √© chamada
    input.value = Math.round(value)
  }
}

/**
 * Atualiza a configura√ß√£o de backup quando alterada pelo usu√°rio
 * @param {HTMLSelectElement} selectElement - Elemento select do backup
 * @returns {void}
 */
function updateBackupConfiguration(selectElement) {
  const roomId = findRoomId(selectElement.closest(".capacity-calculation-table"))
  if (roomId) {
    const newBackupValue = selectElement.value
    syncBackupWithClimaInputs(roomId, newBackupValue)
    calculateCapacitySolution(roomId)
    
    // ‚úÖ CORRE√á√ÉO: Salvar usando roomId
    saveCapacityData(roomId)
  }
}

/**
 * Manipula mudan√ßas no backup provenientes dos inputs de clima
 * @param {string} roomId - ID da sala
 * @param {string} newBackupValue - Novo valor de backup
 * @returns {void}
 */
function handleClimaInputBackupChange(roomId, newBackupValue) {
  const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`)

  if (capacityTable) {
    const backupSelect = capacityTable.querySelector(".backup-select")
    if (backupSelect && backupSelect.value !== newBackupValue) {
      backupSelect.value = newBackupValue
      calculateCapacitySolution(roomId)
      
      // ‚úÖ CORRE√á√ÉO: Salvar usando roomId
      saveCapacityData(roomId)
    }
  }
}

/**
 * Sincroniza o backup com os inputs de clima da sala
 * @param {string} roomId - ID da sala
 * @param {string} backupValue - Valor de backup a ser sincronizado
 * @returns {void}
 */
function syncBackupWithClimaInputs(roomId, backupValue) {
  const roomContent = document.getElementById(`room-content-${roomId}`)
  if (roomContent) {
    const backupInputs = roomContent.querySelectorAll(`.clima-input[data-field="backup"]`)

    backupInputs.forEach((input) => {
      if (input.value !== backupValue) {
        input.value = backupValue
        input.dispatchEvent(new Event("change", { bubbles: true }))
      }
    })
  }
}

/**
 * Sincroniza o backup da tabela de capacidade com os valores atuais
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function syncCapacityTableBackup(roomId) {
  setTimeout(() => {
    const backupFromInputs = getBackupFromClimaInputs(roomId)
    const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`)

    if (capacityTable) {
      const backupSelect = capacityTable.querySelector(".backup-select")
      if (backupSelect && backupSelect.value !== backupFromInputs) {
        backupSelect.value = backupFromInputs
        calculateCapacitySolution(roomId)
      }
    }
  }, 500)
}

// Exporta√ß√£o das fun√ß√µes do m√≥dulo
export {
  buildCapacityCalculationTable,
  calculateCapacitySolution,
  getCapacityData,
  saveCapacityData,
  loadCapacityData,
  applyCapacityData,
  updateBackupConfiguration,
  handleClimaInputBackupChange,
  syncCapacityTableBackup,
  initializeStaticCapacityTable
}
/* ==== FIM: public/scripts/01_Create_Obra/data/modules/machines/capacity-calculator.js ==== */

/* ==== IN√çCIO: public/scripts/01_Create_Obra/data/modules/climatizacao.js ==== */
// climatizacao.js - VERS√ÉO ATUALIZADA COM VALIDA√á√ïES
import { calculateVazaoArAndThermalGains } from '../../features/calculations/air-flow.js';

/**
 * Constr√≥i se√ß√£o completa de climatiza√ß√£o para uma sala espec√≠fica
 * Organiza inputs de dados e resultados de c√°lculos t√©rmicos de forma hier√°rquica
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomName - Nome da sala
 * @param {string} finalRoomId - ID √∫nico da sala
 * @returns {string} HTML completo da se√ß√£o de climatiza√ß√£o
 */
function buildClimatizationSection(obraId, projectId, roomName, finalRoomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico da sala
    if (!finalRoomId || finalRoomId === 'undefined' || finalRoomId === 'null') {
        console.error(`ERRO FALBACK (buildClimatizationSection) climatizacao.js [Room ID inv√°lido: ${finalRoomId}]`);
        return '';
    }
    
    const roomId = finalRoomId;
    console.log(`üîß Construindo se√ß√£o de climatiza√ß√£o para sala: ${roomName} (ID: ${roomId})`);
    
    return `
    <div class="section-block">
      <div class="section-header">
        <button class="minimizer" onclick="toggleSection('${roomId}-clima')">+</button>
        <h4 class="section-title">Climatiza√ß√£o</h4>
      </div>
      <div class="section-content collapsed" id="section-content-${roomId}-clima">
        <div class="subsection-block">
          <div class="subsection-header">
            <button class="minimizer" onclick="toggleSubsection('${roomId}-clima-table')">+</button>
            <h5 class="subsection-title">Tabela de Inputs</h5>
          </div>
          <div class="subsection-content collapsed" id="subsection-content-${roomId}-clima-table">
            ${buildClimatizationTable(roomId)}
          </div>
        </div>
        ${buildThermalGainsSection(roomId)}
      </div>
    </div>
  `
}

// =============================================================================
// SE√á√ÉO: CONSTRU√á√ÉO DA INTERFACE DE INPUTS
// =============================================================================

/**
 * Constr√≥i tabela completa de inputs para dados de climatiza√ß√£o
 * Agrupa campos relacionados para melhor organiza√ß√£o visual e usabilidade
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML da tabela de inputs de climatiza√ß√£o
 */
function buildClimatizationTable(roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildClimatizationTable) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '';
    }
    
    console.log(`üîß Construindo tabela de climatiza√ß√£o para sala ID: ${roomId}`);
    
    return `
    <div class="clima-table">
      ${buildClimaRow(
    [
      { label: "Ambiente:", field: "ambiente", type: "text", placeholder: "Ex: Sala de Servidores" },
      { label: "Back-up:", field: "backup", type: "select", options: ["", "n", "n+1", "n+2"] },
    ],
    roomId,
  )}
      ${buildClimaRow(
    [
      { label: "√Årea (m¬≤):", field: "area", type: "number", placeholder: "Ex: 50" },
      {
        label: "Tipo de Constru√ß√£o:",
        field: "tipoConstrucao",
        type: "select",
        options: ["", "Alvenaria", "Eletrocentro"],
      },
    ],
    roomId,
  )}
      ${buildClimaRow(
    [
      { label: "Parede Oeste (m):", field: "paredeOeste", type: "number", placeholder: "Ex: 5.5" },
      { label: "Parede Leste (m):", field: "paredeLeste", type: "number", placeholder: "Ex: 5.5" },
    ],
    roomId,
  )}
      ${buildClimaRow(
    [
      { label: "Parede Norte (m):", field: "paredeNorte", type: "number", placeholder: "Ex: 8.0" },
      { label: "Parede Sul (m):", field: "paredeSul", type: "number", placeholder: "Ex: 8.0" },
    ],
    roomId,
  )}
      ${buildClimaRow(
    [{ label: "P√© Direito (m):", field: "peDireito", type: "number", placeholder: "Ex: 3.0" }, null],
    roomId,
  )}
      ${buildClimaRow(
    [
      {
        label: "Divis√≥ria √Årea N√£o Climatizada 1 (m¬≤):",
        field: "divisoriaNaoClima1",
        type: "number",
        placeholder: "Ex: 10",
      },
      {
        label: "Divis√≥ria √Årea N√£o Climatizada 2 (m¬≤):",
        field: "divisoriaNaoClima2",
        type: "number",
        placeholder: "Ex: 10",
      },
    ],
    roomId,
  )}
      ${buildClimaRow(
    [
      {
        label: "Divis√≥ria √Årea Climatizada 1 (m¬≤):",
        field: "divisoriaClima1",
        type: "number",
        placeholder: "Ex: 15",
      },
      {
        label: "Divis√≥ria √Årea Climatizada 2 (m¬≤):",
        field: "divisoriaClima2",
        type: "number",
        placeholder: "Ex: 15",
      },
    ],
    roomId,
  )}
      ${buildClimaRow(
    [
      { label: "Dissipa√ß√£o (W):", field: "dissipacao", type: "number", placeholder: "Ex: 5000" },
      { label: "N¬∞ Pessoas:", field: "numPessoas", type: "number", placeholder: "Ex: 10" },
    ],
    roomId,
  )}
      ${buildPressurizationRow(roomId)}
      ${buildResultRow(roomId)}
    </div>
  `
}

/**
 * Constr√≥i linha espec√≠fica para pressuriza√ß√£o com l√≥gica Sim/N√£o
 * Inclui campos condicionais que aparecem apenas quando pressuriza√ß√£o √© ativada
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML da linha de pressuriza√ß√£o
 */
function buildPressurizationRow(roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildPressurizationRow) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '';
    }
    
    return `
    <!-- Linha 1: r√°dios -->
    <div class="clima-row clima-row-2cols">
      <div class="clima-cell">
        <div class="radio-group">
          <label>Pressuriza√ß√£o (TR):</label>
          <label class="radio-label">
            <input type="radio" 
                   name="pressurizacao-${roomId}" 
                   value="sim"
                   onchange="togglePressurizationFields('${roomId}', true)">
            Sim
          </label>
          <label class="radio-label">
            <input type="radio" 
                   name="pressurizacao-${roomId}" 
                   value="nao" 
                   checked
                   onchange="togglePressurizationFields('${roomId}', false)">
            N√£o
          </label>
        </div>
        <input type="number"
          class="form-input clima-input"
          data-field="pressurizacaoSetpoint"
          data-room-id="${roomId}"
          placeholder="Ex: 25"
          value="25"
          step="1"
          disabled
          onchange="calculateVazaoArAndThermalGains('${roomId}')">
      

      </div>
      <!-- c√©lula vazia p/ grid 2 colunas -->
      <div class="clima-cell">
        <label>Setpoint ¬∞C:</label>

        <input type="number"
               class="form-input clima-input"
               data-field="setpointTemp"
               data-room-id="${roomId}"
               placeholder="Ex: 25"
               value="25"
               step="0.1"
               onchange="calculateVazaoArAndThermalGains('${roomId}')">
      </div>
    </div>

    <!-- Linha 3: portas (mostra somente se Sim) -->
    <div class="clima-row clima-row-2cols" id="pressurizacao-portas-${roomId}" style="display:none;">
      <div class="clima-cell">
        <label>N¬∞ Portas Duplas:</label>
        <input type="number"
              class="form-input clima-input"
              data-field="numPortasDuplas"
              data-room-id="${roomId}"
              placeholder="Ex: 2"
              min="0"
              disabled
              onchange="calculateVazaoArAndThermalGains('${roomId}')">
      </div>
      
      <div class="clima-cell">
        <label>N¬∞ Portas Simples:</label>
        <input type="number"
               class="form-input clima-input"
               data-field="numPortasSimples"
               data-room-id="${roomId}"
               placeholder="Ex: 3"
               min="0"
               disabled
               onchange="calculateVazaoArAndThermalGains('${roomId}')">
      </div>
    </div>
  `;
}

/**
 * Constr√≥i linha da tabela com campos de input
 * Permite c√©lulas vazias para layout flex√≠vel de formul√°rio
 * @param {Array} fields - Array de defini√ß√µes de campos
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML da linha da tabela
 */
function buildClimaRow(fields, roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildClimaRow) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '<div class="clima-row"><div class="clima-cell">Erro: ID inv√°lido</div></div>';
    }
    
    const cells = fields
    .map((field) => {
        if (!field) return '<div class="clima-cell clima-cell-empty"></div>'
        return buildClimaCell(field, roomId)
    })
    .join("")

    return `<div class="clima-row">${cells}</div>`
}

/**
 * Constr√≥i c√©lula individual com label e campo de input
 * Define estrutura consistente para diferentes tipos de campos
 * @param {Object} field - Defini√ß√£o do campo (label, type, placeholder, etc)
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML da c√©lula com campo de input
 */
function buildClimaCell(field, roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildClimaCell) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '<div class="clima-cell">Erro: ID inv√°lido</div>';
    }
    
    const input = field.type === "select" ? buildSelectInput(field, roomId) : buildTextInput(field, roomId)

    return `
    <div class="clima-cell">
      <label>${field.label}</label>
      ${input}
    </div>
  `
}

/**
 * Constr√≥i elemento select com op√ß√µes pr√©-definidas
 * Inclui placeholder padr√£o para indicar sele√ß√£o obrigat√≥ria
 * @param {Object} field - Defini√ß√£o do campo select
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML do elemento select
 */
function buildSelectInput(field, roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildSelectInput) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '<select class="form-input clima-input" disabled><option>Erro: ID inv√°lido</option></select>';
    }
    
    const options = field.options
    .map((opt) => `<option value="${opt}">${opt === "" ? "Selecione" : opt}</option>`)
    .join("")

    return `
    <select class="form-input clima-input" data-field="${field.field}" onchange="calculateVazaoArAndThermalGains('${roomId}')">
      ${options}
    </select>
  `
}

/**
 * Constr√≥i campo de input textual ou num√©rico
 * Aplica valida√ß√µes espec√≠ficas baseadas no tipo de campo
 * @param {Object} field - Defini√ß√£o do campo de input
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML do campo de input
 */
function buildTextInput(field, roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildTextInput) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '<input type="text" class="form-input clima-input" disabled placeholder="Erro: ID inv√°lido">';
    }
    
    const step = field.type === "number" ? 'step="1"' : ""

    // Prevenir valores negativos para quantidades
    const min = field.field.includes("num") ? 'min="0"' : "" 
    const value = field.value ? `value="${field.value}"` : ""

    return `
    <input
      type="${field.type}"
      class="form-input clima-input"
      data-field="${field.field}"
      placeholder="${field.placeholder}"
      ${step}
      ${min}
      ${value}
      onchange="calculateVazaoArAndThermalGains('${roomId}')"
    >
  `
}

/**
 * Constr√≥i linha de exibi√ß√£o de resultado calculado
 * Mostra vaz√£o de ar externo como resultado prim√°rio dos c√°lculos
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML da linha de resultados
 */
function buildResultRow(roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildResultRow) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '<div class="clima-row"><div class="clima-cell">Erro: ID inv√°lido</div></div>';
    }
    
    return `
    <div class="clima-row">
      <div class="clima-cell clima-cell-result">
        <label>Vaz√£o de Ar Externo (l/s):</label>
        <div class="result-value-inline" id="vazao-ar-${roomId}">0</div>
      </div>
      <div class="clima-cell">
        <label>Combate a Inc√™ndio:</label>
        <select class="form-input clima-input" data-field="combateIncendio" onchange="calculateVazaoArAndThermalGains('${roomId}')">
          <option value="">Selecione</option>
          <option value="manual">Manual</option>
          <option value="fm200">FM200</option>
          <option value="novec">Novec</option>
          <option value="firepro">FirePro</option>
          <option value="ni">NI</option>
        </select>
      </div>
    </div>
  `
}

// =============================================================================
// FUN√á√ïES DE CONTROLE DE PRESSURIZA√á√ÉO
// =============================================================================

/**
 * Controla a exibi√ß√£o e estado dos campos de pressuriza√ß√£o
 * Habilita/desabilita campos baseado na sele√ß√£o do usu√°rio
 * @param {string} roomId - ID √∫nico da sala
 * @param {boolean} enabled - Se a pressuriza√ß√£o est√° habilitada
 * @returns {void}
 */
function togglePressurizationFields(roomId, enabled) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (togglePressurizationFields) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return;
    }
    
    const pressurizacaoInput = document.querySelector(`input[data-field="pressurizacaoSetpoint"][data-room-id="${roomId}"]`);
    const portasSection = document.getElementById(`pressurizacao-portas-${roomId}`);
    const portasSimples = document.querySelector(`input[data-field="numPortasSimples"][data-room-id="${roomId}"]`);
    const portasDuplas = document.querySelector(`input[data-field="numPortasDuplas"][data-room-id="${roomId}"]`);
    const setpointInput = document.querySelector(`input[data-field="setpointTemp"][data-room-id="${roomId}"]`);

    if (enabled) {
        pressurizacaoInput.disabled = false;
        portasSection.style.display = 'grid';
        portasSimples.disabled = false;
        portasDuplas.disabled = false;
    } else {
        pressurizacaoInput.disabled = true;
        pressurizacaoInput.value = '25';

        portasSection.style.display = 'none';
        portasSimples.disabled = true; portasSimples.value = '';
        portasDuplas.disabled = true; portasDuplas.value = '';

        // mant√©m o setpoint coerente e o badge formatado
        if (setpointInput && setpointInput.value === '') setpointInput.value = '25';
    }

    calculateVazaoArAndThermalGains(roomId);
}

// =============================================================================
// SE√á√ÉO: CONSTRU√á√ÉO DA INTERFACE DE RESULTADOS T√âRMICOS
// =============================================================================

/**
 * Constr√≥i se√ß√£o completa de resultados de ganhos t√©rmicos
 * Organiza dados calculados em tabelas categorizadas para an√°lise detalhada
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML completo da se√ß√£o de ganhos t√©rmicos
 */
function buildThermalGainsSection(roomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildThermalGainsSection) climatizacao.js [Room ID inv√°lido: ${roomId}]`);
        return '';
    }
    
    console.log(`üîß Construindo se√ß√£o de ganhos t√©rmicos para sala ID: ${roomId}`);
    
    return `
    <div class="subsection-block">
      <div class="subsection-header">
        <button class="minimizer" onclick="toggleSubsection('${roomId}-ganhos')">+</button>
        <h5 class="subsection-title">C√°lculo de Ganhos T√©rmicos</h5>
      </div>
      <div class="subsection-content collapsed" id="subsection-content-${roomId}-ganhos">
        <!-- Conte√∫do dos ganhos t√©rmicos -->
        <div class="thermal-summary">
          <div class="thermal-summary-item">
            <span class="thermal-summary-label">Total de Ganhos T√©rmicos:</span>
            <span class="thermal-summary-value" id="total-ganhos-w-${roomId}">0</span>
            <span class="thermal-summary-unit">W</span>
          </div>
          <div class="thermal-summary-item">
            <span class="thermal-summary-label">Total em TR:</span>
            <span class="thermal-summary-value" id="total-tr-${roomId}">0</span>
            <span class="thermal-summary-unit">TR</span>
          </div>
        </div>
        <!-- Tabela de Paredes Externas e Teto -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Ganhos por Paredes Externas e Teto</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Elemento</th>
                <th>√Årea (m¬≤)</th>
                <th>U-Value</th>
                <th>ŒîT (¬∞C)</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Teto</td>
                <td id="area-teto-${roomId}">0</td>
                <td id="uvalue-teto-${roomId}">0</td>
                <td id="deltat-teto-${roomId}">0</td>
                <td id="ganho-teto-${roomId}">0</td>
              </tr>
              <tr>
                <td>Parede Oeste</td>
                <td id="area-parede-oeste-${roomId}">0</td>
                <td id="uvalue-parede-oeste-${roomId}">0</td>
                <td id="deltat-parede-oeste-${roomId}">0</td>
                <td id="ganho-parede-oeste-${roomId}">0</td>
              </tr>
              <tr>
                <td>Parede Leste</td>
                <td id="area-parede-leste-${roomId}">0</td>
                <td id="uvalue-parede-leste-${roomId}">0</td>
                <td id="deltat-parede-leste-${roomId}">0</td>
                <td id="ganho-parede-leste-${roomId}">0</td>
              </tr>
              <tr>
                <td>Parede Norte</td>
                <td id="area-parede-norte-${roomId}">0</td>
                <td id="uvalue-parede-norte-${roomId}">0</td>
                <td id="deltat-parede-norte-${roomId}">0</td>
                <td id="ganho-parede-norte-${roomId}">0</td>
              </tr>
              <tr>
                <td>Parede Sul</td>
                <td id="area-parede-sul-${roomId}">0</td>
                <td id="uvalue-parede-sul-${roomId}">0</td>
                <td id="deltat-parede-sul-${roomId}">0</td>
                <td id="ganho-parede-sul-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="4">Total Paredes Externas e Teto</td>
                <td id="total-externo-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabela de Divis√≥rias -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Ganhos por Divis√≥rias</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>√Årea (m¬≤)</th>
                <th>U-Value</th>
                <th>ŒîT (¬∞C)</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Divis√≥ria N√£o Climatizada 1</td>
                <td id="area-divi-nc1-${roomId}">0</td>
                <td id="uvalue-divi-nc1-${roomId}">0</td>
                <td id="deltat-divi-nc1-${roomId}">0</td>
                <td id="ganho-divi-nc1-${roomId}">0</td>
              </tr>
              <tr>
                <td>Divis√≥ria N√£o Climatizada 2</td>
                <td id="area-divi-nc2-${roomId}">0</td>
                <td id="uvalue-divi-nc2-${roomId}">0</td>
                <td id="deltat-divi-nc2-${roomId}">0</td>
                <td id="ganho-divi-nc2-${roomId}">0</td>
              </tr>
              <tr>
                <td>Divis√≥ria Climatizada 1</td>
                <td id="area-divi-c1-${roomId}">0</td>
                <td id="uvalue-divi-c1-${roomId}">0</td>
                <td id="deltat-divi-c1-${roomId}">0</td>
                <td id="ganho-divi-c1-${roomId}">0</td>
              </tr>
              <tr>
                <td>Divis√≥ria Climatizada 2</td>
                <td id="area-divi-c2-${roomId}">0</td>
                <td id="uvalue-divi-c2-${roomId}">0</td>
                <td id="deltat-divi-c2-${roomId}">0</td>
                <td id="ganho-divi-c2-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="4">Total Divis√≥rias</td>
                <td id="total-divisoes-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabela de Piso -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Ganhos por Piso</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Elemento</th>
                <th>√Årea (m¬≤)</th>
                <th>U-Value</th>
                <th>ŒîT (¬∞C)</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Piso</td>
                <td id="area-piso-${roomId}">0</td>
                <td id="uvalue-piso-${roomId}">0</td>
                <td id="deltat-piso-${roomId}">0</td>
                <td id="ganho-piso-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="4">Total Piso</td>
                <td id="total-piso-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabela de Ilumina√ß√£o -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Ganhos por Ilumina√ß√£o</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Elemento</th>
                <th>√Årea (m¬≤)</th>
                <th>Fator</th>
                <th>Fs</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ilumina√ß√£o</td>
                <td id="area-iluminacao-${roomId}">0</td>
                <td id="fator-iluminacao-${roomId}">0</td>
                <td id="fs-iluminacao-${roomId}">0</td>
                <td id="ganho-iluminacao-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="4">Total Ilumina√ß√£o</td>
                <td id="total-iluminacao-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabela de Dissipa√ß√£o T√©rmica Interna -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Dissipa√ß√£o T√©rmica Interna</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Elemento</th>
                <th>Fator Convers√£o</th>
                <th>Pe (W)</th>
                <th>Fs (%)</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Equipamentos</td>
                <td id="fator-conversao-dissi-${roomId}">0</td>
                <td id="pe-dissi-${roomId}">0</td>
                <td id="fs-dissi-${roomId}">0</td>
                <td id="ganho-dissi-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="4">Total Equipamentos</td>
                <td id="total-dissi-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabela de Ocupa√ß√£o de Pessoas -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Ganhos por Ocupa√ß√£o de Pessoas</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Elemento</th>
                <th>Csp</th>
                <th>Clp</th>
                <th>O</th>
                <th>Fs (%)</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Pessoas</td>
                <td id="csp-pessoas-${roomId}">0</td>
                <td id="clp-pessoas-${roomId}">0</td>
                <td id="o-pessoas-${roomId}">0</td>
                <td id="fs-pessoas-${roomId}">0</td>
                <td id="ganho-pessoas-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="5">Total Pessoas</td>
                <td id="total-pessoas-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabela de Ar Externo Sens√≠vel -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Ganhos de Ar Externo - Sens√≠vel</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Elemento</th>
                <th>m</th>
                <th>c</th>
                <th>ŒîT (¬∞C)</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ar Externo Sens√≠vel</td>
                <td id="m-ar-sensivel-${roomId}">0</td>
                <td id="c-ar-sensivel-${roomId}">0</td>
                <td id="deltat-ar-sensivel-${roomId}">0</td>
                <td id="ganho-ar-sensivel-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="4">Total Ar Externo Sens√≠vel</td>
                <td id="total-ar-sensivel-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabela de Ar Externo Latente -->
        <div class="thermal-table-container">
          <h6 class="thermal-table-title">Ganhos de Ar Externo - Latente</h6>
          <table class="thermal-table">
            <thead>
              <tr>
                <th>Elemento</th>
                <th>Var</th>
                <th>f</th>
                <th>ŒîUa</th>
                <th>Ganho (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ar Externo Latente</td>
                <td id="var-ar-latente-${roomId}">0</td>
                <td id="f-ar-latente-${roomId}">0</td>
                <td id="deltaua-ar-latente-${roomId}">0</td>
                <td id="ganho-ar-latente-${roomId}">0</td>
              </tr>
              <tr class="thermal-table-total">
                <td colspan="4">Total Ar Externo Latente</td>
                <td id="total-ar-latente-${roomId}">0</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `
}

// Exportar a nova fun√ß√£o para controle global
window.togglePressurizationFields = togglePressurizationFields

export {
  buildClimatizationSection,
  buildClimatizationTable,
  buildClimaRow,
  buildClimaCell,
  buildSelectInput,
  buildTextInput,
  buildResultRow,
  buildThermalGainsSection,
  buildPressurizationRow,
  togglePressurizationFields
}
/* ==== FIM: public/scripts/01_Create_Obra/data/modules/climatizacao.js ==== */

/* ==== IN√çCIO: public/scripts/02_Obras_manager/utils/global-stubs.js ==== */
/**
 * utils/global-stubs.js
 * Stubs para fun√ß√µes globais que podem n√£o estar dispon√≠veis
 */


console.log('üöÄ global-stubs.js CARREGANDO...');

// Verificar se toggleSection j√° existe ANTES de definir o stub
console.log(`üîç toggleSection existe antes do stub? ${typeof window.toggleSection}`);
console.log(`üîç toggleSubsection existe antes do stub? ${typeof window.toggleSubsection}`);


// Stub para calculateVazaoArAndThermalGains
if (typeof window.calculateVazaoArAndThermalGains !== 'function') {
    window.calculateVazaoArAndThermalGains = function(roomId) {
        console.log(`üîß calculateVazaoArAndThermalGains stub chamado para sala: ${roomId}`);
        // Esta fun√ß√£o ser√° substitu√≠da quando o m√≥dulo real for carregado
    };
}

// Stub para toggleObra
if (typeof window.toggleObra !== 'function') {
    window.toggleObra = function(obraId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleObra stub chamado para obra: ${obraId}`);
        
        const obraContent = document.getElementById(`obra-content-${obraId}`);
        const minimizer = event?.target;
        
        if (obraContent && minimizer) {
            const isCollapsed = obraContent.classList.contains('collapsed');
            obraContent.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
        }
    };
}

// Stub para toggleRoom
if (typeof window.toggleRoom !== 'function') {
    window.toggleRoom = function(roomId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleRoom stub chamado para sala: ${roomId}`);
        
        const roomContent = document.getElementById(`room-content-${roomId}`);
        const minimizer = event?.target;
        
        if (roomContent && minimizer) {
            const isCollapsed = roomContent.classList.contains('collapsed');
            roomContent.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
        }
    };
}

// Stub para toggleProject
if (typeof window.toggleProject  !== 'function') {
    window.toggleProject  = function(projectId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleProject  stub chamado para sala: ${projectId}`);
        
        const projectContent = document.getElementById(`project-content-${projectId}`);
        const minimizer = event?.target;
        
        if (projectContent && minimizer) {
            const isCollapsed = projectContent.classList.contains('collapsed');
            projectContent.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
        }
    };
}

// Stub para toggleSection - VERS√ÉO DEFINITIVA
if (typeof window.toggleSection !== 'function') {
    window.toggleSection = function(sectionId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleSection stub chamado para se√ß√£o: ${sectionId}`);
        
        // ‚úÖ USAR O ID EXATO QUE EST√Å NO DOM
        const contentId = `section-content-${sectionId}`;
        const content = document.getElementById(contentId);
        const minimizer = event?.target;
        
        if (content && minimizer) {
            const isCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
            
            // Tamb√©m alternar a classe no bloco pai para estiliza√ß√£o
            const sectionBlock = content.closest('.section-block');
            if (sectionBlock) {
                sectionBlock.classList.toggle('collapsed', !isCollapsed);
            }
            
            console.log(`‚úÖ Se√ß√£o ${sectionId} ${isCollapsed ? 'expandida' : 'recolhida'}`);
        } else {
            console.error(`‚ùå Conte√∫do da se√ß√£o n√£o encontrado: ${contentId}`);
            console.log('üîç Tentando m√©todo alternativo...');
            
            // ‚úÖ M√âTODO ALTERNATIVO: Encontrar pelo minimizer
            if (minimizer) {
                const sectionBlock = minimizer.closest('.section-block');
                if (sectionBlock) {
                    const altContent = sectionBlock.querySelector('.section-content');
                    if (altContent) {
                        const isCollapsed = altContent.classList.contains('collapsed');
                        altContent.classList.toggle('collapsed', !isCollapsed);
                        minimizer.textContent = isCollapsed ? '‚àí' : '+';
                        sectionBlock.classList.toggle('collapsed', !isCollapsed);
                        console.log(`‚úÖ Se√ß√£o encontrada via m√©todo alternativo: ${isCollapsed ? 'expandida' : 'recolhida'}`);
                        return;
                    }
                }
            }
            
            console.error(`‚ùå Falha total ao encontrar se√ß√£o: ${sectionId}`);
        }
    };
}

// Stub para toggleSubsection - VERS√ÉO DEFINITIVA
if (typeof window.toggleSubsection !== 'function') {
    window.toggleSubsection = function(subsectionId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleSubsection stub chamado para subse√ß√£o: ${subsectionId}`);
        
        // ‚úÖ USAR O ID EXATO QUE EST√Å NO DOM
        const contentId = `subsection-content-${subsectionId}`;
        const content = document.getElementById(contentId);
        const minimizer = event?.target;
        
        if (content && minimizer) {
            const isCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
            
            // Tamb√©m alternar a classe no bloco pai para estiliza√ß√£o
            const subsectionBlock = content.closest('.subsection-block');
            if (subsectionBlock) {
                subsectionBlock.classList.toggle('collapsed', !isCollapsed);
            }
            
            console.log(`‚úÖ Subse√ß√£o ${subsectionId} ${isCollapsed ? 'expandida' : 'recolhida'}`);
        } else {
            console.error(`‚ùå Conte√∫do da subse√ß√£o n√£o encontrado: ${contentId}`);
            
            // ‚úÖ M√âTODO ALTERNATIVO
            if (minimizer) {
                const subsectionBlock = minimizer.closest('.subsection-block');
                if (subsectionBlock) {
                    const altContent = subsectionBlock.querySelector('.subsection-content');
                    if (altContent) {
                        const isCollapsed = altContent.classList.contains('collapsed');
                        altContent.classList.toggle('collapsed', !isCollapsed);
                        minimizer.textContent = isCollapsed ? '‚àí' : '+';
                        subsectionBlock.classList.toggle('collapsed', !isCollapsed);
                        console.log(`‚úÖ Subse√ß√£o encontrada via m√©todo alternativo: ${isCollapsed ? 'expandida' : 'recolhida'}`);
                    }
                }
            }
        }
    };
}


// Stub para toggleMachineSection - VERS√ÉO DEFINITIVA
if (typeof window.toggleMachineSection !== 'function') {
    window.toggleMachineSection = function(machineId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleMachineSection stub chamado para m√°quina: ${machineId}`);
        
        // ‚úÖ USAR O ID EXATO QUE EST√Å NO DOM
        const contentId = `machine-content-${machineId}`;
        const content = document.getElementById(contentId);
        const minimizer = event?.target;
        
        if (content && minimizer) {
            const isCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
            
            console.log(`‚úÖ M√°quina ${machineId} ${isCollapsed ? 'expandida' : 'recolhida'}`);
        } else {
            console.error(`‚ùå Conte√∫do da m√°quina n√£o encontrado: ${contentId}`);
            
            // ‚úÖ M√âTODO ALTERNATIVO
            if (minimizer) {
                const machineElement = minimizer.closest('.climatization-machine, .machine-block');
                if (machineElement) {
                    const altContent = machineElement.querySelector('.machine-content');
                    if (altContent) {
                        const isCollapsed = altContent.classList.contains('collapsed');
                        altContent.classList.toggle('collapsed', !isCollapsed);
                        minimizer.textContent = isCollapsed ? '‚àí' : '+';
                        console.log(`‚úÖ M√°quina encontrada via m√©todo alternativo: ${isCollapsed ? 'expandida' : 'recolhida'}`);
                    }
                }
            }
        }
    };
}

// Stub para makeEditable
if (typeof window.makeEditable !== 'function') {
    window.makeEditable = function(element, type) {
        console.log(`üîß makeEditable stub chamado para: ${type}`);
        
        if (element.getAttribute('contenteditable') === 'true') return;
        
        element.setAttribute('contenteditable', 'true');
        element.classList.add('editing');
        element.focus();
        
        const originalText = element.textContent;
        
        function saveChanges() {
            element.setAttribute('contenteditable', 'false');
            element.classList.remove('editing');
            console.log(`‚úÖ ${type} atualizado: ${element.textContent}`);
        }
        
        element.addEventListener('blur', saveChanges, { once: true });
        element.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveChanges();
            } else if (e.key === 'Escape') {
                element.textContent = originalText;
                saveChanges();
            }
        });
    };
}

// Stub para outras fun√ß√µes comuns
const stubFunctions = [
    'toggleMachineSection',
    'updateMachineTitle', 
    'deleteMachine',
    'updateMachineOptions',
    'handlePowerChange',
    'calculateMachinePrice',
    'updateBackupConfiguration',
    'initializeFatorSeguranca',
    'syncCapacityTableBackup'
];

stubFunctions.forEach(funcName => {
    if (typeof window[funcName] !== 'function') {
        window[funcName] = function(...args) {
            console.log(`üîß ${funcName} stub chamado com:`, args);
            // Stub vazio - ser√° substitu√≠do quando o m√≥dulo real for carregado
        };
    }
});

console.log('‚úÖ Stubs globais carregados');
/* ==== FIM: public/scripts/02_Obras_manager/utils/global-stubs.js ==== */

/* ==== IN√çCIO: public/scripts/01_Create_Obra/ui/helpers.js ==== */
/**
 * ui/helpers.js
 * üéØ FUS√ÉO: ui-helpers.js ‚Üí ui/helpers.js
 * ‚ö° REFATORA√á√ÉO: Import atualizado + compatibilidade global
 */

import { UI_CONSTANTS } from '../core/constants.js';

/**
 * Utilit√°rios de interface do usu√°rio - SISTEMA UNIFICADO
 */

/**
 * Alterna a visibilidade de um elemento (expandir/recolher)
 * @param {string} contentId - ID do elemento a ser alternado
 * @param {HTMLElement} minimizerElement - Bot√£o minimizador
 */
function toggleElementVisibility(contentId, minimizerElement) {
  const content = document.getElementById(contentId);
  if (!content) {
    console.error(`‚ùå Elemento ${contentId} n√£o encontrado para toggle`);
    return;
  }

  const isCollapsed = content.classList.contains(UI_CONSTANTS.COLLAPSED_CLASS);

  if (isCollapsed) {
    expandElement(content, minimizerElement);
  } else {
    collapseElement(content, minimizerElement);
  }
}

/**
 * Expande um elemento na interface
 * @param {HTMLElement} element - Elemento a ser expandido
 * @param {HTMLElement} minimizerElement - Bot√£o minimizador
 */
function expandElement(element, minimizerElement) {
  element.classList.remove(UI_CONSTANTS.COLLAPSED_CLASS);
  minimizerElement.textContent = UI_CONSTANTS.EXPANDED_SYMBOL;
}

/**
 * Recolhe um elemento na interface
 * @param {HTMLElement} element - Elemento a ser recolhido
 * @param {HTMLElement} minimizerElement - Bot√£o minimizador
 */
function collapseElement(element, minimizerElement) {
  element.classList.add(UI_CONSTANTS.COLLAPSED_CLASS);
  minimizerElement.textContent = UI_CONSTANTS.MINIMIZED_SYMBOL;
}

/**
 * Calcula estat√≠sticas de preenchimento de uma sala
 * @param {HTMLElement} room - Elemento da sala
 * @returns {Object} Estat√≠sticas de preenchimento
 */
function calculateRoomCompletionStats(room) {
  const inputs = room.querySelectorAll(".form-input, .clima-input");
  const filledInputs = Array.from(inputs).filter((input) => {
    if (input.type === 'checkbox' || input.type === 'radio') {
      return input.checked;
    }
    return input.value && input.value.trim() !== "";
  }).length;

  const totalInputs = inputs.length;
  const percentage = totalInputs > 0 ? ((filledInputs / totalInputs) * 100).toFixed(1) : 0;

  return {
    filled: filledInputs,
    total: totalInputs,
    percentage: percentage,
  };
}

/**
 * Remove a mensagem de "obra vazia" quando projetos s√£o adicionados
 * @param {string} obraName - Nome da obra
 */
function removeEmptyObraMessage(obraName) {
  const projectsContainer = document.getElementById(`projects-${obraName}`);
  if (projectsContainer) {
    const emptyMessage = projectsContainer.querySelector(".empty-message");
    if (emptyMessage) {
      console.log(`üóëÔ∏è Removendo mensagem de obra vazia: ${obraName}`);
      emptyMessage.remove();
    }
  }
}

/**
 * Exibe mensagem de "obra vazia" se n√£o houver projetos
 * @param {string} obraName - Nome da obra
 */
function showEmptyObraMessageIfNeeded(obraName) {
  const projectsContainer = document.getElementById(`projects-${obraName}`);
  if (projectsContainer) {
    const projects = projectsContainer.querySelectorAll(".project-block");
    
    if (projects.length === 0) {
      const existingMessage = projectsContainer.querySelector(".empty-message");
      if (!existingMessage) {
        console.log(`üìù Exibindo mensagem de obra vazia: ${obraName}`);
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = 'Adicione projetos a esta obra...';
        projectsContainer.appendChild(emptyMessage);
      }
    } else {
      removeEmptyObraMessage(obraName);
    }
  }
}

/**
 * Remove a mensagem de "projeto vazio" quando salas s√£o adicionadas
 * @param {HTMLElement} projectContent - Elemento do conte√∫do do projeto
 */
function removeEmptyProjectMessage(projectContent) {
  const emptyMessage = projectContent.querySelector(".empty-message");
  if (emptyMessage) {
    console.log(`üóëÔ∏è Removendo mensagem de projeto vazio`);
    emptyMessage.remove();
  }
}

/**
 * Exibe mensagem de "projeto vazio" se n√£o houver salas
 * @param {HTMLElement} projectContent - Elemento do conte√∫do do projeto
 */
function showEmptyProjectMessageIfNeeded(projectContent) {
  const remainingRooms = projectContent.querySelectorAll(".room-block");

  if (remainingRooms.length === 0) {
    const existingMessage = projectContent.querySelector(".empty-message");
    if (!existingMessage) {
      console.log(`üìù Exibindo mensagem de projeto vazio`);
      const addRoomSection = projectContent.querySelector(".add-room-section");
      if (addRoomSection) {
        addRoomSection.insertAdjacentHTML("beforebegin", '<p class="empty-message">Adicione salas a este projeto...</p>');
      }
    }
  } else {
    removeEmptyProjectMessage(projectContent);
  }
}

/**
 * üÜï FUN√á√ÉO ADICIONAL: Verifica se elemento est√° vis√≠vel
 * @param {string} elementId - ID do elemento
 * @returns {boolean} True se vis√≠vel
 */
function isElementVisible(elementId) {
  const element = document.getElementById(elementId);
  return element && !element.classList.contains(UI_CONSTANTS.COLLAPSED_CLASS);
}

/**
 * üÜï FUN√á√ÉO ADICIONAL: Alterna todos os elementos de um container
 * @param {string} containerId - ID do container
 * @param {boolean} expand - True para expandir, false para recolher
 */
function toggleAllElements(containerId, expand = true) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const minimizers = container.querySelectorAll('.minimizer');
  const contents = container.querySelectorAll('.collapsible-content');

  contents.forEach((content, index) => {
    const minimizer = minimizers[index];
    if (minimizer && content) {
      if (expand) {
        expandElement(content, minimizer);
      } else {
        collapseElement(content, minimizer);
      }
    }
  });
}

// Exporta√ß√µes para m√≥dulos ES6
export {
  toggleElementVisibility,
  expandElement,
  collapseElement,
  calculateRoomCompletionStats,
  removeEmptyObraMessage,
  showEmptyObraMessageIfNeeded,
  removeEmptyProjectMessage,
  showEmptyProjectMessageIfNeeded,
  isElementVisible,
  toggleAllElements
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
  window.toggleElementVisibility = toggleElementVisibility;
  window.expandElement = expandElement;
  window.collapseElement = collapseElement;
  window.calculateRoomCompletionStats = calculateRoomCompletionStats;
  window.removeEmptyObraMessage = removeEmptyObraMessage;
  window.showEmptyObraMessageIfNeeded = showEmptyObraMessageIfNeeded;
  window.removeEmptyProjectMessage = removeEmptyProjectMessage;
  window.showEmptyProjectMessageIfNeeded = showEmptyProjectMessageIfNeeded;
  window.isElementVisible = isElementVisible;
  window.toggleAllElements = toggleAllElements;
}
/* ==== FIM: public/scripts/01_Create_Obra/ui/helpers.js ==== */

/* ==== IN√çCIO: public/scripts/02_Obras_manager/features/managers/obras-manager.js ==== */
/**
 * features/managers/obras-manager.js
 * Gerenciador principal da P√°gina 2 - Coordena carregamento e renderiza√ß√£o
 */

import { loadBackupObras, removeObraFromBackup } from '../../data/adapters/obras-adapter.js';
import { getObraStats, formatObraStats, applyFilters as applyObraFilters } from '../../data/builders/obras-builder.js';
import { showSystemStatus } from '../../../01_Create_Obra/ui/components/status.js';
import { showConfirmationModal } from '../../../01_Create_Obra/ui/components/modal/modal.js';
import { waitForConstants, validateRequiredConstants } from '../../data/adapters/constants-adapter.js';

// Cache para fun√ß√µes da P√°gina 1
let page1Functions = null;
let globalFunctionsLoaded = false;

/**
 * Carrega TODOS os m√≥dulos necess√°rios da P√°gina 1
 */
async function loadAllPage1Modules() {
    const modules = [
        // M√≥dulos de interface e constru√ß√£o
        () => import('../../../01_Create_Obra/features/managers/obra-manager.js'),
        () => import('../../../01_Create_Obra/data/builders/ui-builders.js'),
        () => import('../../../01_Create_Obra/ui/helpers.js'),
        
        // M√≥dulos de componentes (que definem as fun√ß√µes de toggle)
        () => import('../../../01_Create_Obra/data/modules/rooms.js'),
        () => import('../../../01_Create_Obra/data/modules/climatizacao.js'),
        () => import('../../../01_Create_Obra/data/modules/configuracao.js'),
        () => import('../../../01_Create_Obra/data/modules/machines/machines-core.js'),
        
        // M√≥dulos de c√°lculos
        () => import('../../../01_Create_Obra/features/calculations/calculations-core.js'),
        () => import('../../../01_Create_Obra/features/calculations/air-flow.js'),
        () => import('../../../01_Create_Obra/features/calculations/thermal-gains.js')
    ];

    for (const moduleLoader of modules) {
        try {
            await moduleLoader();
            console.log('‚úÖ M√≥dulo carregado');
        } catch (error) {
            console.error('‚ùå Erro ao carregar m√≥dulo:', error);
        }
    }
}

/**
 * Carrega fun√ß√µes espec√≠ficas que est√£o faltando
 */
async function loadMissingFunctions(missingFunctions) {
    console.log('üîß Tentando carregar fun√ß√µes faltantes...', missingFunctions);
    
    for (const funcName of missingFunctions) {
        try {
            switch (funcName) {
                case 'toggleObra':
                case 'toggleRoom':
                case 'toggleProject':
                    // Estas fun√ß√µes s√£o definidas em helpers.js
                    await import('../../../01_Create_Obra/ui/helpers.js');
                    console.log(`‚úÖ ${funcName} carregada via helpers.js`);
                    break;
                    
                case 'toggleSection':
                case 'toggleSubsection':
                    // Estas fun√ß√µes s√£o definidas em climatizacao.js
                    await import('../../../01_Create_Obra/data/modules/climatizacao.js');
                    console.log(`‚úÖ ${funcName} carregada via climatizacao.js`);
                    break;
                    
                case 'makeEditable':
                    // Esta fun√ß√£o √© definida em edit.js
                    await import('../../../01_Create_Obra/ui/components/edit.js');
                    console.log(`‚úÖ ${funcName} carregada via edit.js`);
                    break;
                    
                case 'calculateVazaoArAndThermalGains':
                    // Esta fun√ß√£o √© definida em air-flow.js
                    await import('../../../01_Create_Obra/features/calculations/air-flow.js');
                    console.log(`‚úÖ ${funcName} carregada via air-flow.js`);
                    break;
                    
                default:
                    console.warn(`‚ö†Ô∏è N√£o h√° carregador espec√≠fico para: ${funcName}`);
            }
        } catch (error) {
            console.error(`‚ùå Erro ao carregar ${funcName}:`, error);
        }
    }
}

/**
 * Verifica e tenta carregar fun√ß√µes necess√°rias
 */
async function verifyRequiredFunctions() {
    const requiredFunctions = [
        'toggleObra', 'toggleRoom', 'toggleProject', 'toggleSection', 'toggleSubsection',
        'toggleMachineSection', 'calculateVazaoArAndThermalGains', 'makeEditable'
    ];
    
    let loadedFunctions = [];
    let missingFunctions = [];
    
    // Verificar fun√ß√µes carregadas
    requiredFunctions.forEach(funcName => {
        if (typeof window[funcName] === 'function') {
            loadedFunctions.push(funcName);
        } else {
            missingFunctions.push(funcName);
        }
    });
    
    console.log(`üìä Fun√ß√µes carregadas: ${loadedFunctions.length}/${requiredFunctions.length}`);
    console.log('‚úÖ Carregadas:', loadedFunctions);
    
    if (missingFunctions.length > 0) {
        console.warn('‚ö†Ô∏è Faltando:', missingFunctions);
        
        // Tentar carregar fun√ß√µes faltantes
        await loadMissingFunctions(missingFunctions);
        
        // Verificar novamente ap√≥s tentativa
        const stillMissing = requiredFunctions.filter(funcName => 
            typeof window[funcName] !== 'function'
        );
        
        if (stillMissing.length > 0) {
            console.warn('‚ö†Ô∏è Fun√ß√µes ainda faltando ap√≥s tentativa:', stillMissing);
            
            // Para fun√ß√µes cr√≠ticas de toggle, usar implementa√ß√£o b√°sica
            stillMissing.forEach(funcName => {
                if (funcName.startsWith('toggle')) {
                    console.log(`üîß Criando implementa√ß√£o b√°sica para ${funcName}`);
                    createBasicToggleFunction(funcName);
                }
            });
        } else {
            console.log('‚úÖ Todas as fun√ß√µes foram carregadas com sucesso');
        }
    }
}

/**
 * Cria fun√ß√£o de toggle b√°sica para fun√ß√µes faltantes
 */
function createBasicToggleFunction(funcName) {
    if (typeof window[funcName] === 'function') return;
    
    window[funcName] = function(elementId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß ${funcName} b√°sica chamada para: ${elementId}`);
        
        const contentId = `${funcName.replace('toggle', '').toLowerCase()}-content-${elementId}`;
        const content = document.getElementById(contentId);
        const minimizer = event?.target;
        
        if (content && minimizer) {
            const isCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
        }
    };
}

/**
 * Carrega TODAS as fun√ß√µes globais da P√°gina 1
 */
async function loadAllPage1Functions() {
    if (globalFunctionsLoaded) return;
    
    try {
        console.log('üì¶ Carregando TODAS as fun√ß√µes da P√°gina 1...');
        
        // 1. PRIMEIRO: Garantir que constantes est√£o carregadas
        await waitForConstants();
        console.log('‚úÖ Constantes verificadas antes de carregar fun√ß√µes da P√°gina 1');
        
        // 2. Validar constantes (n√£o bloquear se faltarem algumas)
        const constantsValid = validateRequiredConstants();
        if (!constantsValid) {
            console.warn('‚ö†Ô∏è Algumas constantes podem estar faltando, mas continuando...');
        }
        
        // 3. Carregar TODOS os m√≥dulos da P√°gina 1
        await loadAllPage1Modules();
        
        // 4. Coletar fun√ß√µes espec√≠ficas
        const obraManager = await import('../../../01_Create_Obra/features/managers/obra-manager.js');
        const uiBuilders = await import('../../../01_Create_Obra/data/builders/ui-builders.js');
        
        page1Functions = {
            createEmptyObra: obraManager.createEmptyObra,
            insertObraIntoDOM: obraManager.insertObraIntoDOM,
            populateObraData: uiBuilders.populateObraData,
            updateObraButtonAfterSave: obraManager.updateObraButtonAfterSave,
        };
        
        console.log('‚úÖ TODAS as fun√ß√µes da P√°gina 1 carregadas');
        
        // 5. Verificar e carregar fun√ß√µes faltantes
        await verifyRequiredFunctions();
        
        globalFunctionsLoaded = true;
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar fun√ß√µes da P√°gina 1:', error);
        throw error;
    }
}

/**
 * Garante que as constantes est√£o dispon√≠veis para c√°lculos
 */
async function ensureConstantsForCalculations() {
    try {
        // Verificar se waitForSystemConstants existe
        if (typeof window.waitForSystemConstants === 'function') {
            await window.waitForSystemConstants();
        } else {
            // Usar nosso pr√≥prio m√©todo
            await waitForConstants();
        }
        
        // ‚úÖ CORRE√á√ÉO: N√£o bloquear se faltarem algumas constantes
        const constantsValid = validateRequiredConstants();
        if (!constantsValid) {
            console.warn('‚ö†Ô∏è Algumas constantes podem estar faltando, mas continuando com c√°lculos...');
        }
        
        console.log('‚úÖ Constantes verificadas para c√°lculos');
        return true;
        
    } catch (error) {
        console.error('‚ùå Erro ao garantir constantes para c√°lculos:', error);
        return false;
    }
}

/**
 * Renderiza uma obra usando as fun√ß√µes da P√°gina 1
 */
async function renderObra(obraData) {
    try {
        // ‚úÖ CARREGAR TODAS AS FUN√á√ïES E CONSTANTES PRIMEIRO
        await loadAllPage1Functions();
        
        // ‚úÖ GARANTIR que constantes est√£o dispon√≠veis para c√°lculos
        const constantsReady = await ensureConstantsForCalculations();
        if (!constantsReady) {
            console.warn(`‚ö†Ô∏è Constantes n√£o prontas para obra ${obraData.nome}, pulando c√°lculos`);
        }
        
        const { createEmptyObra, populateObraData } = page1Functions;
        
        console.log(`üé® Renderizando obra: ${obraData.nome} (ID: ${obraData.id})`);
        
        // Criar obra vazia usando fun√ß√£o da P√°gina 1
        const obraCreated = await createEmptyObra(obraData.nome, obraData.id);
        
        if (!obraCreated) {
            console.error(`‚ùå Falha ao criar obra: ${obraData.nome}`);
            return false;
        }
        
        // Aguardar a obra ser inserida no DOM
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Popular dados completos usando fun√ß√£o da P√°gina 1
        await populateObraData(obraData);
        
        console.log(`‚úÖ Obra renderizada: ${obraData.nome}`);
        return true;
        
    } catch (error) {
        console.error(`‚ùå Erro ao renderizar obra ${obraData.nome}:`, error);
        return false;
    }
}

/**
 * Aplica p√≥s-processamento espec√≠fico da P√°gina 2
 */
function applyPage2PostProcessing() {
    console.log('üîß Aplicando p√≥s-processamento da P√°gina 2...');
    
    // 1. Esconder bot√µes de Salvar
    const saveButtons = document.querySelectorAll('.btn-salvar');
    saveButtons.forEach(btn => {
        btn.style.display = 'none';
    });
    
    // 2. Esconder se√ß√µes de adicionar projeto/sala
    const addSections = document.querySelectorAll('.add-project-section, .add-room-section');
    addSections.forEach(section => {
        section.style.display = 'none';
    });
    
    // 3. Atualizar textos e adicionar badge
    const obraHeaders = document.querySelectorAll('.obra-header');
    obraHeaders.forEach(header => {
        // Atualizar a√ß√£o de deletar para usar adapter da P√°gina 2
        const deleteBtn = header.querySelector('.btn-delete');
        if (deleteBtn) {
            const obraId = deleteBtn.closest('.obra-block').dataset.obraId;
            const obraName = deleteBtn.closest('.obra-block').dataset.obraName;
            
            deleteBtn.textContent = 'Excluir do Backup';
            deleteBtn.className = 'btn btn-manager-delete';
            deleteBtn.onclick = () => handleObraDeletion(obraId, obraName);
        }
    });
    
    // 4. Adicionar estat√≠sticas √†s obras
    const obraBlocks = document.querySelectorAll('.obra-block');
    obraBlocks.forEach(obraBlock => {
        const obraId = obraBlock.dataset.obraId;
        addObraStatsToHeader(obraBlock, obraId);
    });
    
    console.log('‚úÖ P√≥s-processamento aplicado');
}

/**
 * Adiciona estat√≠sticas ao header da obra
 */
function addObraStatsToHeader(obraBlock, obraId) {
    const obraHeader = obraBlock.querySelector('.obra-header');
    const spacer = obraBlock.querySelector('.obra-header-spacer');
    
    if (spacer) {
        // Buscar dados da obra para calcular estat√≠sticas
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (obraElement) {
            const projetos = obraElement.querySelectorAll('.project-block');
            let totalSalas = 0;
            let totalMaquinas = 0;
            
            projetos.forEach(projeto => {
                const salas = projeto.querySelectorAll('.room-block');
                totalSalas += salas.length;
                
                salas.forEach(sala => {
                    const maquinas = sala.querySelectorAll('.climatization-machine, .machine-block');
                    totalMaquinas += maquinas.length;
                });
            });
            
            const statsText = formatObraStats({
                projetos: projetos.length,
                salas: totalSalas,
                maquinas: totalMaquinas
            });
            
            spacer.innerHTML = `<span>${statsText}</span>`;
        }
    }
}

/**
 * Manipula a exclus√£o de obra (P√°gina 2)
 */
async function handleObraDeletion(obraId, obraName) {
    console.log(`üóëÔ∏è Iniciando exclus√£o da obra: ${obraName} (ID: ${obraId})`);
    
    // Usar modal de confirma√ß√£o da P√°gina 1, mas com comportamento da P√°gina 2
    showConfirmationModal(obraName, obraId, document.querySelector(`[data-obra-id="${obraId}"]`));
    
    // Sobrescrever o comportamento padr√£o do modal
    window.confirmDeletion = async () => {
        console.log(`‚úÖ Confirmada exclus√£o da obra: ${obraName}`);
        
        try {
            // Remover do backup usando adapter da P√°gina 2
            const success = await removeObraFromBackup(obraId);
            
            if (success) {
                // Remover do DOM
                const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
                if (obraBlock) {
                    obraBlock.remove();
                    console.log(`‚úÖ Obra ${obraName} removida do DOM`);
                }
                
                showSystemStatus(`Obra "${obraName}" removida do backup`, 'success');
            } else {
                // Fallback: remover apenas do DOM se o servidor n√£o suportar
                console.log('üîÑ Fallback: removendo apenas do DOM');
                const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
                if (obraBlock) {
                    obraBlock.remove();
                    showSystemStatus(`Obra "${obraName}" removida da visualiza√ß√£o`, 'warning');
                }
            }
            
        } catch (error) {
            console.error('‚ùå Erro na exclus√£o:', error);
            showSystemStatus('Erro ao remover obra', 'error');
        }
    };
}

/**
 * Carrega e renderiza todas as obras do backup
 */
export async function loadAndRenderObras() {
    try {
        console.log('üöÄ Iniciando carregamento e renderiza√ß√£o de obras...');
        showSystemStatus('Carregando obras...', 'info');
        
        // ‚úÖ GARANTIR que constantes e fun√ß√µes est√£o carregadas antes de prosseguir
        await loadAllPage1Functions();
        
        // ‚úÖ VERIFICAR novamente as constantes antes do carregamento
        if (!window.systemConstants) {
            console.error('‚ùå Constantes n√£o dispon√≠veis ap√≥s loadAllPage1Functions');
            await waitForConstants();
        }
        
        // Carregar obras do backup
        const obras = await loadBackupObras();
        
        if (obras.length === 0) {
            showSystemStatus('Nenhuma obra encontrada no backup', 'warning');
            return;
        }
        
        console.log(`üìä ${obras.length} obra(s) para renderizar`);
        
        // Renderizar cada obra
        let successCount = 0;
        for (const obra of obras) {
            const success = await renderObra(obra);
            if (success) successCount++;
            
            // Pequena pausa entre renderiza√ß√µes
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // Aplicar p√≥s-processamento da P√°gina 2
        applyPage2PostProcessing();
        
        console.log(`üéâ Renderiza√ß√£o conclu√≠da: ${successCount}/${obras.length} obra(s)`);
        showSystemStatus(`${successCount} obra(s) carregada(s)`, 'success');
        
    } catch (error) {
        console.error('‚ùå Erro no carregamento e renderiza√ß√£o:', error);
        showSystemStatus('Erro ao carregar obras', 'error');
    }
}

/**
 * Stub para filtros futuros
 */
export function applyFilters(criteria = {}) {
    console.log('üîç Aplicando filtros (stub):', criteria);
    
    // Usar a fun√ß√£o do builder com alias para evitar conflito
    const filteredObras = applyObraFilters([], criteria); // Array vazio por enquanto
    
    // Esta fun√ß√£o ser√° conectada ao UI de busca quando implementado
    return {
        criteria,
        filteredCount: filteredObras.length,
        message: 'Sistema de filtros ser√° implementado futuramente',
        timestamp: new Date().toISOString()
    };
}

// Exporta√ß√µes
export {
    renderObra,
    applyPage2PostProcessing,
    handleObraDeletion,
    loadAllPage1Functions
};
/* ==== FIM: public/scripts/02_Obras_manager/features/managers/obras-manager.js ==== */

/* ==== IN√çCIO: public/scripts/01_Create_Obra/features/calculations/thermal-gains.js ==== */
/**
 * thermal-gains.js
 * üéØ FUS√ÉO COMPLETA: thermalCalculations + thermalComponents + thermalDisplay
 * ‚ö° REDU√á√ÉO: 3 arquivos ‚Üí 1 arquivo (~600 ‚Üí ~350 linhas)
 */


import { 
    waitForSystemConstants, 
    validateSystemConstants,
    collectClimatizationInputs,
} from './calculations-core.js'  

import { safeNumber, updateElementText } from '../../utils/core-utils.js';

/**
 * üî• C√ÅLCULOS DE COMPONENTES T√âRMICOS (thermalComponents.js)
 */

function calculateCeilingGain(area, uValue, deltaT) {
  const areaNum = safeNumber(area);
  const uValueNum = safeNumber(uValue);
  const deltaTNum = safeNumber(deltaT);
  const result = areaNum * uValueNum * deltaTNum;
  console.log(`[DEBUG DETAIL] calculateCeilingGain: ${areaNum} * ${uValueNum} * ${deltaTNum} = ${result}`);
  return result;
}

function calculateWallGain(comprimento, peDireito, uValue, deltaT) {
  const compNum = safeNumber(comprimento);
  const peDireitoNum = safeNumber(peDireito);
  const uValueNum = safeNumber(uValue);
  const deltaTNum = safeNumber(deltaT);
  const area = compNum * peDireitoNum;
  const result = area * uValueNum * deltaTNum;
  console.log(`[DEBUG DETAIL] calculateWallGain: (${compNum} * ${peDireitoNum}) = ${area}m¬≤ * ${uValueNum} * ${deltaTNum} = ${result}`);
  return result;
}

function calculatePartitionGain(inputArea, peDireito, uValue, deltaT) {
  const area = safeNumber(inputArea) * safeNumber(peDireito);
  const result = area * uValue * deltaT;
  return result;
}

function calculateFloorGain(area, constants) {
  const uValue = window.systemConstants?.AUX_U_Value_Piso || 2.7;
  const deltaT = window.systemConstants?.deltaT_piso || 7.5;
  const result = safeNumber(area) * uValue * deltaT;
  return result;
}

function calculateLightingGain(area, constants) {
  const fatorIluminacao = window.systemConstants?.AUX_Fator_Iluminacao || 7;
  const fsIluminacao = window.systemConstants?.AUX_Fs_Iluminacao || 1;
  const result = safeNumber(area) * fatorIluminacao * fsIluminacao;
  return result;
}

function calculateDissipationGain(dissipacao, constants) {
  const fatorConversao = window.systemConstants?.AUX_Fator_Conver_Painel || 1;
  const fsPaineis = window.systemConstants?.AUX_Fs_Paineis || 100;
  const result = (fatorConversao * safeNumber(dissipacao) * fsPaineis) / 100;
  return result;
}

function calculatePeopleGain(numPessoas, constants) {
  const csp = window.systemConstants?.AUX_OCp_Csp || 86.5;
  const clp = window.systemConstants?.AUX_OCp_Clp || 133.3;
  const fsPessoas = 100;
  const pessoas = safeNumber(numPessoas);
  const ganhoSensivel = (csp * pessoas * fsPessoas) / 100;
  const ganhoLatente = (clp * pessoas * fsPessoas) / 100;
  const result = ganhoSensivel + ganhoLatente;
  return result;
}

function calculateExternalAirSensibleGain(vazaoArExterno, auxVars, constants) {
  const c_ArExterno = window.systemConstants?.AUX_c_ArExterno || 0.24;
  const deltaT_ArExterno = window.systemConstants?.AUX_deltaT_ArExterno || 10;
  
  const calc_Gsens_ArE = auxVars.m_ArExterno * c_ArExterno * deltaT_ArExterno;
  const resultado = (calc_Gsens_ArE / 1000) * 1.16;
  
  return resultado;
}

function calculateExternalAirLatentGain(vazaoArExterno, constants) {
  const f_ArExterno = window.systemConstants?.AUX_f_ArExterno || 3.01;
  const deltaUa_ArExterno = window.systemConstants?.AUX_deltaUa_ArExterno || 8.47;
  
  const vazao = safeNumber(vazaoArExterno);
  const ganho = vazao * f_ArExterno * deltaUa_ArExterno;
  
  return ganho;
}

/**
 * üìä C√ÅLCULOS DE TOTAIS E DISPLAY (thermalDisplay.js)
 */

function calculateTotals(gains) {
  const totalExterno = gains.teto + gains.paredeOeste + gains.paredeLeste + gains.paredeNorte + gains.paredeSul;
  const totalDivisoes = gains.divisoriaNaoClima1 + gains.divisoriaNaoClima2 + gains.divisoriaClima1 + gains.divisoriaClima2;
  const totalPiso = gains.piso;
  const totalIluminacao = gains.iluminacao;
  const totalEquipamentos = gains.dissipacao;
  const totalPessoas = gains.pessoas;
  const totalArSensivel = gains.arSensivel;
  const totalArLatente = gains.arLatente;
  const totalArExterno = totalArSensivel + totalArLatente;

  const totalGeralW = totalExterno + totalDivisoes + totalPiso + totalIluminacao + totalEquipamentos + totalPessoas + totalArExterno;
  const totalGeralTR = totalGeralW / 3517;

  const totals = {
    externo: Math.ceil(totalExterno),
    divisoes: Math.ceil(totalDivisoes),
    piso: Math.ceil(totalPiso),
    iluminacao: Math.ceil(totalIluminacao),
    equipamentos: Math.ceil(totalEquipamentos),
    pessoas: Math.ceil(totalPessoas),
    arSensivel: Math.ceil(totalArSensivel),
    arLatente: Math.ceil(totalArLatente),
    arExterno: Math.ceil(totalArExterno),
    geralW: Math.ceil(totalGeralW),
    geralTR: Math.ceil(totalGeralTR),
  };

  return totals;
}

function updateWallDisplay(roomId, direction, gain, uValue, inputWidth, peDireito, deltaT) {
  const area = safeNumber(inputWidth) * safeNumber(peDireito);
  updateElementText(`area-parede-${direction}-${roomId}`, Math.ceil(area));
  updateElementText(`uvalue-parede-${direction}-${roomId}`, uValue.toFixed(3));
  updateElementText(`deltat-parede-${direction}-${roomId}`, deltaT || 0);
  updateElementText(`ganho-parede-${direction}-${roomId}`, Math.ceil(gain));
}

function updatePartitionDisplay(roomId, type, gain, uValue, inputArea, peDireito, deltaT) {
  const areaCalculada = safeNumber(inputArea) * safeNumber(peDireito);
  updateElementText(`area-divi-${type}-${roomId}`, Math.ceil(areaCalculada));
  updateElementText(`uvalue-divi-${type}-${roomId}`, uValue.toFixed(3));
  updateElementText(`deltat-divi-${type}-${roomId}`, deltaT || 0);
  updateElementText(`ganho-divi-${type}-${roomId}`, Math.ceil(gain));
}

function updateThermalGainsDisplay(roomId, gains, totals, uValues, inputData) {
  console.log(`üî• Atualizando display t√©rmico para sala: ${roomId}`);
  
  updateElementText(`total-ganhos-w-${roomId}`, totals.geralW);
  updateElementText(`total-tr-${roomId}`, totals.geralTR);

  updateElementText(`area-teto-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`uvalue-teto-${roomId}`, uValues.teto.toFixed(3));
  updateElementText(`deltat-teto-${roomId}`, window.systemConstants?.deltaT_teto || 20);
  updateElementText(`ganho-teto-${roomId}`, Math.ceil(gains.teto));

  updateWallDisplay(roomId, "oeste", gains.paredeOeste, uValues.parede, inputData.paredeOeste, inputData.peDireito, window.systemConstants?.deltaT_parede_Oes || 0);
  updateWallDisplay(roomId, "leste", gains.paredeLeste, uValues.parede, inputData.paredeLeste, inputData.peDireito, window.systemConstants?.deltaT_parede_Les || 0);
  updateWallDisplay(roomId, "norte", gains.paredeNorte, uValues.parede, inputData.paredeNorte, inputData.peDireito, window.systemConstants?.deltaT_parede_Nor || 0);
  updateWallDisplay(roomId, "sul", gains.paredeSul, uValues.parede, inputData.paredeSul, inputData.peDireito, window.systemConstants?.deltaT_parede_Sul || 0);

  updatePartitionDisplay(roomId, "nc1", gains.divisoriaNaoClima1, uValues.parede, inputData.divisoriaNaoClima1, inputData.peDireito, window.systemConstants?.deltaT_divi_N_clim1 || 0);
  updatePartitionDisplay(roomId, "nc2", gains.divisoriaNaoClima2, uValues.parede, inputData.divisoriaNaoClima2, inputData.peDireito, window.systemConstants?.deltaT_divi_N_clim2 || 0);
  updatePartitionDisplay(roomId, "c1", gains.divisoriaClima1, uValues.parede, inputData.divisoriaClima1, inputData.peDireito, window.systemConstants?.deltaT_divi_clim1 || 0);
  updatePartitionDisplay(roomId, "c2", gains.divisoriaClima2, uValues.parede, inputData.divisoriaClima2, inputData.peDireito, window.systemConstants?.deltaT_divi_clim2 || 0);

  updateElementText(`area-piso-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`uvalue-piso-${roomId}`, uValues.piso.toFixed(3));
  updateElementText(`deltat-piso-${roomId}`, window.systemConstants?.deltaT_piso || 5);
  updateElementText(`ganho-piso-${roomId}`, Math.ceil(gains.piso));
  updateElementText(`total-piso-${roomId}`, totals.piso);

  updateElementText(`area-iluminacao-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`fator-iluminacao-${roomId}`, window.systemConstants?.AUX_Fator_Iluminacao || 7);
  updateElementText(`fs-iluminacao-${roomId}`, window.systemConstants?.AUX_Fs_Iluminacao || 1);
  updateElementText(`ganho-iluminacao-${roomId}`, Math.ceil(gains.iluminacao));
  updateElementText(`total-iluminacao-${roomId}`, totals.iluminacao);

  updateElementText(`fator-conversao-dissi-${roomId}`, window.systemConstants?.AUX_Fator_Conver_Painel || 1);
  updateElementText(`pe-dissi-${roomId}`, inputData.dissipacao || 0);
  updateElementText(`fs-dissi-${roomId}`, window.systemConstants?.AUX_Fs_Paineis || 100);
  updateElementText(`ganho-dissi-${roomId}`, Math.ceil(gains.dissipacao));
  updateElementText(`total-dissi-${roomId}`, totals.equipamentos);

  updateElementText(`csp-pessoas-${roomId}`, window.systemConstants?.AUX_OCp_Csp || 86.5);
  updateElementText(`clp-pessoas-${roomId}`, window.systemConstants?.AUX_OCp_Clp || 133.3);
  updateElementText(`o-pessoas-${roomId}`, inputData.numPessoas || 0);
  updateElementText(`fs-pessoas-${roomId}`, 100);
  updateElementText(`ganho-pessoas-${roomId}`, Math.ceil(gains.pessoas));
  updateElementText(`total-pessoas-${roomId}`, totals.pessoas);

  const densiAr = window.systemConstants?.Densi_ar || 1.17;
  const m_ArExterno = (inputData.vazaoArExterno || 0) * 3.6 * densiAr * 1000;

  updateElementText(`m-ar-sensivel-${roomId}`, Math.ceil(m_ArExterno));
  updateElementText(`c-ar-sensivel-${roomId}`, window.systemConstants?.AUX_c_ArExterno || 0.24);
  updateElementText(`deltat-ar-sensivel-${roomId}`, window.systemConstants?.AUX_deltaT_ArExterno || 10);
  updateElementText(`ganho-ar-sensivel-${roomId}`, Math.ceil(gains.arSensivel));
  updateElementText(`total-ar-sensivel-${roomId}`, totals.arSensivel);

  updateElementText(`var-ar-latente-${roomId}`, inputData.vazaoArExterno || 0);
  updateElementText(`f-ar-latente-${roomId}`, window.systemConstants?.AUX_f_ArExterno || 3.01);
  updateElementText(`deltaua-ar-latente-${roomId}`, window.systemConstants?.AUX_deltaUa_ArExterno || 8.47);
  updateElementText(`ganho-ar-latente-${roomId}`, Math.ceil(gains.arLatente));
  updateElementText(`total-ar-latente-${roomId}`, totals.arLatente);

  updateElementText(`total-externo-${roomId}`, totals.externo);
  updateElementText(`total-divisoes-${roomId}`, totals.divisoes);
  
  console.log(`‚úÖ Display t√©rmico atualizado para sala: ${roomId}`);
}

/**
 * üîç FUN√á√ïES AUXILIARES DE BUSCA (thermalCalculations.js)
 */

function findRoomContentThermal(roomId) {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (findRoomContentThermal) thermalCalculations.js [ID de sala inv√°lido: ${roomId}]`);
        return null;
    }
    
    console.log(`üîç [THERMAL] Procurando sala: "${roomId}"`);
    
    let roomContent = document.getElementById(`room-content-${roomId}`);
    
    if (roomContent) {
        console.log(`‚úÖ [THERMAL] Sala encontrada pelo ID: room-content-${roomId}`);
        return roomContent;
    }
    
    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    
    if (roomBlock) {
        const foundId = roomBlock.dataset.roomId;
        console.log(`‚úÖ [THERMAL] Sala encontrada pelo data-room-id: ${foundId}`);
        
        const finalRoomContent = document.getElementById(`room-content-${foundId}`);
        if (finalRoomContent) {
            return finalRoomContent;
        }
    }
  
    console.error(`‚ùå [THERMAL] Sala n√£o encontrada: ${roomId}`);
    const allRooms = document.querySelectorAll('.room-block');
    console.log('üîç [THERMAL] Todas as salas dispon√≠veis no DOM:');
    allRooms.forEach(room => {
        console.log(`  - ID: "${room.dataset.roomId}", Nome: "${room.dataset.roomName}", Projeto: "${room.dataset.projectId}", Obra: "${room.dataset.obraId}"`);
    });
    
    return null;
}

function calculateUValues(tipoConstrucao) {
  const U_VALUE_ALVENARIA_TETO = 3.961;
  const U_VALUE_ALVENARIA_PAREDE = 2.546;
  const U_VALUE_LA_ROCHA_TETO = 1.145;
  const U_VALUE_LA_ROCHA_PAREDE = 1.12;

  console.log(`[THERMAL UVALUES] tipoConstrucao recebido: "${tipoConstrucao}"`);

  let uValueParede, uValueTeto;

  const tipoLower = tipoConstrucao ? tipoConstrucao.toLowerCase() : "";
  
  if (tipoLower === "eletrocentro") {
    uValueParede = U_VALUE_LA_ROCHA_PAREDE;
    uValueTeto = U_VALUE_LA_ROCHA_TETO;
  } else if (tipoLower === "alvenaria") {
    uValueParede = U_VALUE_ALVENARIA_PAREDE;
    uValueTeto = U_VALUE_ALVENARIA_TETO;
  } else {
    uValueParede = 0;
    uValueTeto = 0;
  }

  const result = {
    parede: uValueParede,
    teto: uValueTeto,
    piso: window.systemConstants?.AUX_U_Value_Piso || 2.7,
  };

  console.log("[THERMAL UVALUES] UValues calculados:", result);
  return result;
}

function calculateAuxiliaryVariables(inputData) {
  const vazaoArExterno = safeNumber(inputData.vazaoArExterno);
  const densiAr = window.systemConstants?.Densi_ar || 1.17;

  const m_ArExterno = vazaoArExterno * 3.6 * densiAr * 1000;

  return {
    m_ArExterno: m_ArExterno,
    vazaoArExterno: vazaoArExterno
  };
}

/**
 * üéØ FUN√á√ÉO PRINCIPAL DE C√ÅLCULO (thermalCalculations.js)
 */

async function calculateThermalGains(roomId, vazaoArExterno = 0) {
  try {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (calculateThermalGains) thermalCalculations.js [ID de sala inv√°lido: ${roomId}]`);
        return;
    }
    
    console.log(`üî• [THERMAL] Iniciando c√°lculos para sala: ${roomId}`);
    
    await waitForSystemConstants();

    if (!validateSystemConstants()) {
      console.error(`[THERMAL] validateSystemConstants FALHOU para ${roomId}`);
      return;
    }

    const roomContent = findRoomContentThermal(roomId);
    if (!roomContent) {
      console.error(`[THERMAL] room-content-${roomId} N√ÉO ENCONTRADO`);
      return;
    }

    const climaSection = roomContent.querySelector('[id*="-clima"]');
    if (!climaSection) {
      console.error(`[THERMAL] Se√ß√£o clima N√ÉO ENCONTRADA para ${roomId}`);
      return;
    }

    const inputData = collectClimatizationInputs(climaSection, roomId);

    const calcData = {
      ...inputData,
      area: safeNumber(inputData.area),
      paredeOeste: safeNumber(inputData.paredeOeste),
      paredeLeste: safeNumber(inputData.paredeLeste),
      paredeNorte: safeNumber(inputData.paredeNorte),
      paredeSul: safeNumber(inputData.paredeSul),
      peDireito: safeNumber(inputData.peDireito),
      divisoriaNaoClima1: safeNumber(inputData.divisoriaNaoClima1),
      divisoriaNaoClima2: safeNumber(inputData.divisoriaNaoClima2),
      divisoriaClima1: safeNumber(inputData.divisoriaClima1),
      divisoriaClima2: safeNumber(inputData.divisoriaClima2),
      dissipacao: safeNumber(inputData.dissipacao),
      numPessoas: safeNumber(inputData.numPessoas),
      vazaoArExterno: vazaoArExterno
    };

    const uValues = calculateUValues(calcData.tipoConstrucao);
    const auxVars = calculateAuxiliaryVariables({...calcData, vazaoArExterno});

    const gains = {
      teto: calculateCeilingGain(calcData.area, uValues.teto, window.systemConstants.deltaT_teto),
      paredeOeste: calculateWallGain(calcData.paredeOeste, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Oes),
      paredeLeste: calculateWallGain(calcData.paredeLeste, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Les),
      paredeNorte: calculateWallGain(calcData.paredeNorte, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Nor),
      paredeSul: calculateWallGain(calcData.paredeSul, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Sul),
      divisoriaNaoClima1: calculatePartitionGain(calcData.divisoriaNaoClima1, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_N_clim1),
      divisoriaNaoClima2: calculatePartitionGain(calcData.divisoriaNaoClima2, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_N_clim2),
      divisoriaClima1: calculatePartitionGain(calcData.divisoriaClima1, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_clim1),
      divisoriaClima2: calculatePartitionGain(calcData.divisoriaClima2, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_clim2),
      piso: calculateFloorGain(calcData.area, window.systemConstants),
      iluminacao: calculateLightingGain(calcData.area, window.systemConstants),
      dissipacao: calculateDissipationGain(calcData.dissipacao, window.systemConstants),
      pessoas: calculatePeopleGain(calcData.numPessoas, window.systemConstants),
      arSensivel: calculateExternalAirSensibleGain(vazaoArExterno, auxVars, window.systemConstants),
      arLatente: calculateExternalAirLatentGain(vazaoArExterno, window.systemConstants),
    };

    const totals = calculateTotals(gains);

    console.log(`üî• [THERMAL] Ganhos calculados para ${roomId}:`, gains);
    console.log(`üî• [THERMAL] Totais para ${roomId}:`, totals);
    console.log("üî• [THERMAL] ===== FIM DO C√ÅLCULO DE GANHOS T√âRMICOS =====");

    updateThermalGainsDisplay(roomId, gains, totals, uValues, {...inputData, vazaoArExterno});

    console.log(`üî• [THERMAL] Tentando atualizar tabela de capacidade para ${roomId}`);
    setTimeout(() => {
      if (typeof calculateCapacitySolution === 'function') {
        calculateCapacitySolution(roomId);
      } else if (typeof window.calculateCapacitySolution === 'function') {
        window.calculateCapacitySolution(roomId);
      } else if (typeof updateCapacityFromThermalGains === 'function') {
        updateCapacityFromThermalGains(roomId);
      } else if (typeof window.updateCapacityFromThermalGains === 'function') {
        window.updateCapacityFromThermalGains(roomId);
      } else {
        console.error(`[THERMAL] Nenhuma fun√ß√£o de capacidade encontrada para ${roomId}`);
        
        const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);
        if (capacityTable) {
          console.log(`[THERMAL] Tabela de capacidade encontrada, tentando inicializa√ß√£o manual`);
          const cargaEstimadaElement = document.getElementById(`carga-estimada-${roomId}`);
          const totalTRElement = document.getElementById(`total-tr-${roomId}`);
          
          if (totalTRElement && cargaEstimadaElement) {
            const totalTR = parseFloat(totalTRElement.textContent) || 0;
            cargaEstimadaElement.textContent = totalTR.toFixed(1);
            console.log(`[THERMAL] Carga estimada atualizada manualmente: ${totalTR}`);
          }
        }
      }
    }, 300);
    
  } catch (error) {
    console.error(`[THERMAL] Erro em calculateThermalGains para ${roomId}:`, error);
  }
}

/**
 * üåê EXPORTA√á√ïES E COMPATIBILIDADE GLOBAL
 */

// Exporta√ß√µes para m√≥dulos ES6
export {
  calculateThermalGains,
  calculateUValues,
  calculateAuxiliaryVariables,
  findRoomContentThermal,
  calculateCeilingGain,
  calculateWallGain,
  calculatePartitionGain,
  calculateFloorGain,
  calculateLightingGain,
  calculateDissipationGain,
  calculatePeopleGain,
  calculateExternalAirSensibleGain,
  calculateExternalAirLatentGain,
  calculateTotals,
  updateThermalGainsDisplay,
  updateWallDisplay,
  updatePartitionDisplay
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
  window.calculateThermalGains = calculateThermalGains;
  window.calculateUValues = calculateUValues;
  window.calculateAuxiliaryVariables = calculateAuxiliaryVariables;
  window.findRoomContentThermal = findRoomContentThermal;
  window.calculateCeilingGain = calculateCeilingGain;
  window.calculateWallGain = calculateWallGain;
  window.calculatePartitionGain = calculatePartitionGain;
  window.calculateFloorGain = calculateFloorGain;
  window.calculateLightingGain = calculateLightingGain;
  window.calculateDissipationGain = calculateDissipationGain;
  window.calculatePeopleGain = calculatePeopleGain;
  window.calculateExternalAirSensibleGain = calculateExternalAirSensibleGain;
  window.calculateExternalAirLatentGain = calculateExternalAirLatentGain;
  window.calculateTotals = calculateTotals;
  window.updateThermalGainsDisplay = updateThermalGainsDisplay;
  window.updateWallDisplay = updateWallDisplay;
  window.updatePartitionDisplay = updatePartitionDisplay;
}
/* ==== FIM: public/scripts/01_Create_Obra/features/calculations/thermal-gains.js ==== */
