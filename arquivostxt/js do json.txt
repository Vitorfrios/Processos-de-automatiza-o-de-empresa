
/* ==== IN√çCIO: config/ExpImpJsonFilles/json-editor.js ==== */
// json-editor.js - C√ìDIGO COMPLETO E FUNCIONAL

// ==================== ESTADO GLOBAL ====================
window.stagingData = null;
window.hasPendingChanges = false;
let scrollSyncInitialized = false;
let isSyncing = false;

// ==================== FUN√á√ïES PRINCIPAIS ====================

/**
 * Atualiza os n√∫meros das linhas DINAMICAMENTE
 */
export function updateLineNumbers() {
    const editor = document.getElementById('jsonEditor');
    const lineNumbers = document.getElementById('lineNumbers');
    
    if (!editor || !lineNumbers) {
        console.warn('Elementos do editor n√£o encontrados');
        return;
    }
    
    // Conta as linhas do texto
    const text = editor.value;
    let lines = text.split('\n');
    
    // Se o texto terminar com quebra de linha, adiciona linha extra
    if (text.endsWith('\n')) {
        lines.push('');
    }
    
    const totalLines = Math.max(lines.length, 1);
    
    // Gera os n√∫meros das linhas
    let numbersHTML = '';
    for (let i = 1; i <= totalLines; i++) {
        numbersHTML += `<div data-line="${i}">${i}</div>`;
    }
    
    // Atualiza o HTML
    lineNumbers.innerHTML = numbersHTML;
    
    // Ajusta as alturas e sincroniza
    adjustEditorLayout();
}

/**
 * Ajusta o layout do editor (alturas e sincroniza√ß√£o)
 */
function adjustEditorLayout() {
    const editor = document.getElementById('jsonEditor');
    const lineNumbers = document.getElementById('lineNumbers');
    const editorWrapper = document.querySelector('.json-editor-wrapper');
    
    if (!editor || !lineNumbers || !editorWrapper) return;
    
    // Calcula a altura necess√°ria
    const contentHeight = editor.scrollHeight;
    const wrapperHeight = editorWrapper.clientHeight;
    
    // Define as alturas
    editor.style.height = contentHeight + 'px';
    lineNumbers.style.height = contentHeight + 'px';
    
    // Inicializa a sincroniza√ß√£o do scroll se necess√°rio
    if (!scrollSyncInitialized) {
        initScrollSync();
        scrollSyncInitialized = true;
    }
    
    // Garante que o wrapper tenha altura correta
    editorWrapper.style.height = wrapperHeight + 'px';
}

/**
 * Inicializa a sincroniza√ß√£o do scroll entre editor e n√∫meros
 */
function initScrollSync() {
    const editorWrapper = document.querySelector('.json-editor-wrapper');
    const lineNumbers = document.getElementById('lineNumbers');
    
    if (!editorWrapper || !lineNumbers) return;
    
    // Sincroniza o scroll vertical
    editorWrapper.addEventListener('scroll', function() {
        if (isSyncing) return;
        
        isSyncing = true;
        lineNumbers.style.transform = `translateY(-${this.scrollTop}px)`;
        
        setTimeout(() => {
            isSyncing = false;
        }, 10);
    });
    
    // Observa mudan√ßas no editor
    const editor = document.getElementById('jsonEditor');
    if (editor) {
        // Atualiza quando o conte√∫do muda
        editor.addEventListener('input', function() {
            requestAnimationFrame(() => {
                updateLineNumbers();
            });
        });
        
        // Atualiza quando o tamanho muda
        const resizeObserver = new ResizeObserver(() => {
            requestAnimationFrame(adjustEditorLayout);
        });
        
        resizeObserver.observe(editor);
        resizeObserver.observe(editorWrapper);
    }
    
    // Atualiza quando a janela √© redimensionada
    window.addEventListener('resize', () => {
        requestAnimationFrame(adjustEditorLayout);
    });
}

/**
 * Destaca uma linha espec√≠fica
 * @param {number} lineNumber - N√∫mero da linha a destacar
 * @param {string} type - Tipo de highlight ('error', 'warning', 'info')
 */
export function highlightLine(lineNumber, type = 'error') {
    const lineNumbers = document.getElementById('lineNumbers');
    if (!lineNumbers) return;
    
    // Remove destaque anterior
    const lines = lineNumbers.querySelectorAll('div');
    lines.forEach(line => {
        line.className = '';
    });
    
    // Aplica o novo destaque
    if (lineNumber > 0 && lineNumber <= lines.length) {
        const lineElement = lines[lineNumber - 1];
        lineElement.classList.add(`${type}-line`);
        
        // Scroll para a linha
        scrollToLine(lineNumber);
    }
}

/**
 * Faz scroll para uma linha espec√≠fica
 * @param {number} lineNumber - N√∫mero da linha
 */
function scrollToLine(lineNumber) {
    const editorWrapper = document.querySelector('.json-editor-wrapper');
    if (!editorWrapper) return;
    
    const lineHeight = 20; // Altura de cada linha em pixels
    const scrollPosition = (lineNumber - 1) * lineHeight;
    
    editorWrapper.scrollTo({
        top: Math.max(0, scrollPosition - 100),
        behavior: 'smooth'
    });
}

/**
 * Encontra a linha de um erro no JSON
 * @param {string} jsonString - String JSON com erro
 * @param {Error} error - Objeto de erro
 * @returns {number} N√∫mero da linha ou -1 se n√£o encontrado
 */
export function findErrorLine(jsonString, error) {
    if (!error || !error.message || !jsonString) return -1;
    
    try {
        // Padr√µes comuns em mensagens de erro
        const patterns = [
            /position (\d+)/,
            /at line (\d+)/,
            /line (\d+)/,
            /linha (\d+)/
        ];
        
        for (const pattern of patterns) {
            const match = error.message.match(pattern);
            if (match && match[1]) {
                return parseInt(match[1]);
            }
        }
        
        // Fallback: conta linhas at√© a posi√ß√£o
        if (error.message.includes('position')) {
            const positionMatch = error.message.match(/position (\d+)/);
            if (positionMatch) {
                const position = parseInt(positionMatch[1]);
                const lines = jsonString.substring(0, position).split('\n');
                return lines.length;
            }
        }
    } catch (e) {
        console.error('Erro ao encontrar linha:', e);
    }
    
    return -1;
}

// ==================== INICIALIZA√á√ÉO DO EDITOR ====================

/**
 * Inicializa o editor JSON
 */
export function initJSONEditor() {
    console.log('üöÄ Inicializando editor JSON...');
    
    const editor = document.getElementById('jsonEditor');
    if (!editor) {
        console.error('‚ùå Elemento #jsonEditor n√£o encontrado!');
        return;
    }
    
    // Carrega dados iniciais
    const systemData = window.systemData || {};
    let initialContent = '';
    
    if (Object.keys(systemData).length > 0) {
        // Formata os dados existentes
        try {
            initialContent = JSON.stringify(systemData, null, 2);
        } catch (error) {
            console.warn('Erro ao formatar dados iniciais:', error);
            initialContent = '{\n  "constants": {},\n  "machines": [],\n  "materials": {},\n  "empresas": []\n}';
        }
    } else {
        // Conte√∫do inicial padr√£o
        initialContent = '{\n  "constants": {},\n  "machines": [],\n  "materials": {},\n  "empresas": []\n}';
    }
    
    editor.value = initialContent;
    
    // Configura eventos
    editor.addEventListener('input', updateLineNumbers);
    
    // Inicializa√ß√£o inicial
    setTimeout(() => {
        updateLineNumbers();
        updateJSONStatus('‚úÖ Editor JSON pronto. Digite ou cole seu JSON.', 'success');
    }, 50);
    
    // For√ßa uma atualiza√ß√£o ap√≥s carregamento completo
    window.addEventListener('load', () => {
        setTimeout(() => {
            updateLineNumbers();
        }, 200);
    });
}

// ==================== FUN√á√ïES DE FORMATAR/VALIDAR ====================

/**
 * Formata o JSON no editor
 */
export function formatJSON() {
    const editor = document.getElementById('jsonEditor');
    if (!editor) return;
    
    try {
        const parsed = JSON.parse(editor.value);
        editor.value = JSON.stringify(parsed, null, 2);
        
        updateLineNumbers();
        highlightLine(-1); // Remove highlight
        updateJSONStatus('‚úÖ JSON formatado com sucesso!', 'success');
    } catch (error) {
        const errorLine = findErrorLine(editor.value, error);
        
        if (errorLine > 0) {
            highlightLine(errorLine, 'error');
        }
        
        updateJSONStatus(`‚ùå Erro de formata√ß√£o: ${error.message}`, 'error');
    }
}

/**
 * Valida o JSON no editor
 * @returns {boolean} true se v√°lido, false se inv√°lido
 */
export function validateJSON() {
    const editor = document.getElementById('jsonEditor');
    if (!editor) return false;
    
    try {
        const parsed = JSON.parse(editor.value);
        
        // Valida estrutura b√°sica
        const validation = validateJSONStructure(parsed);
        
        if (!validation.valid) {
            throw new Error(validation.errors.join('; '));
        }
        
        highlightLine(-1); // Remove highlight
        updateJSONStatus('‚úÖ JSON v√°lido e com estrutura correta', 'success');
        return true;
        
    } catch (error) {
        const errorLine = findErrorLine(editor.value, error);
        
        if (errorLine > 0) {
            highlightLine(errorLine, 'error');
        }
        
        updateJSONStatus(`‚ùå JSON inv√°lido: ${error.message}`, 'error');
        return false;
    }
}

/**
 * Valida a estrutura do JSON
 * @param {object} data - Dados JSON
 * @returns {object} Resultado da valida√ß√£o
 */
export function validateJSONStructure(data) {
    const errors = [];
    
    if (!data.constants || typeof data.constants !== 'object') {
        errors.push('"constants" deve ser um objeto');
    }
    
    if (!data.machines || !Array.isArray(data.machines)) {
        errors.push('"machines" deve ser um array');
    }
    
    if (!data.materials || typeof data.materials !== 'object') {
        errors.push('"materials" deve ser um objeto');
    }
    
    if (!data.empresas || !Array.isArray(data.empresas)) {
        errors.push('"empresas" deve ser um array');
    }
    
    return {
        valid: errors.length === 0,
        errors: errors
    };
}

// ==================== FUN√á√ïES AUXILIARES ====================

/**
 * Atualiza a mensagem de status
 * @param {string} message - Mensagem a mostrar
 * @param {string} type - Tipo ('success', 'error', 'warning', 'info')
 */
export function updateJSONStatus(message, type = 'info') {
    const status = document.getElementById('jsonStatus');
    if (!status) return;
    
    status.textContent = message;
    status.className = 'json-status';
    status.classList.add(type);
}

/**
 * Atualiza o estado do bot√£o "Aplicar JSON"
 */
export function updateApplyButtonState() {
    const applyButton = document.getElementById('applyJsonBtn');
    if (!applyButton) return;
    
    if (window.hasPendingChanges) {
        applyButton.disabled = false;
        applyButton.classList.remove('disabled');
        applyButton.innerHTML = '<i class="icon-check"></i> Aplicar JSON';
        applyButton.title = 'Aplicar altera√ß√µes do JSON';
    } else {
        applyButton.disabled = true;
        applyButton.classList.add('disabled');
        applyButton.innerHTML = '<i class="icon-check"></i> Nada para aplicar';
        applyButton.title = 'Nenhuma altera√ß√£o pendente';
    }
}

/**
 * Converte arquivo para base64
 * @param {File} file - Arquivo a converter
 * @returns {Promise<string>} Promise com base64
 */
export function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
        };
        reader.onerror = reject;
    });
}

// ==================== EXPORTA√á√ÉO GLOBAL ====================

// Inicializa√ß√£o autom√°tica quando o DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            if (window.initJSONEditor) {
                window.initJSONEditor();
            }
        }, 100);
    });
} else {
    setTimeout(() => {
        if (window.initJSONEditor) {
            window.initJSONEditor();
        }
    }, 100);
}
/* ==== FIM: config/ExpImpJsonFilles/json-editor.js ==== */

/* ==== IN√çCIO: config/ExpImpJsonFilles/json-import-export.js ==== */
// json-import-export.js
import { showError, showSuccess, showWarning } from '../ui.js';
import { updateLineNumbers, updateJSONStatus, updateApplyButtonState, fileToBase64 } from './json-editor.js';

// Fun√ß√£o para exportar JSON
export function exportToJSON() {
    try {
        const systemData = window.systemData || {};
        const dataStr = JSON.stringify(systemData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `sistema_dados_${new Date().toISOString().slice(0,10)}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.style.display = 'none';
        document.body.appendChild(linkElement);
        linkElement.click();
        document.body.removeChild(linkElement);
        
        showSuccess('JSON exportado com sucesso!');
        
    } catch (error) {
        console.error('Erro ao exportar JSON:', error);
        showError('Erro ao exportar JSON.');
    }
}

// Fun√ß√£o para importar JSON
export function importFromJSON() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.style.display = 'none';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                // Validar estrutura b√°sica
                const validation = validateJSONStructure(importedData);
                
                if (!validation.valid) {
                    throw new Error(validation.errors.join('; '));
                }
                
                // Armazenar em staging
                window.stagingData = importedData;
                window.hasPendingChanges = true;
                
                // Exibir no editor JSON Bruto
                const editor = document.getElementById('jsonEditor');
                if (editor) {
                    editor.value = JSON.stringify(importedData, null, 2);
                    updateLineNumbers();
                    switchTab('raw');
                }
                
                showWarning('JSON carregado na √°rea de staging. Clique em "Aplicar JSON" para confirmar as altera√ß√µes.');
                updateJSONStatus('JSON carregado em staging. Aguardando aplica√ß√£o.', 'warning');
                updateApplyButtonState();
                
            } catch (error) {
                console.error('Erro ao importar JSON:', error);
                showError(`Erro ao importar JSON: ${error.message}`);
                updateJSONStatus(`‚ùå JSON inv√°lido: ${error.message}`, 'error');
            }
        };
        
        reader.onerror = function() {
            showError('Erro ao ler o arquivo.');
        };
        
        reader.readAsText(file);
    };
    
    document.body.appendChild(input);
    input.click();
    
    setTimeout(() => {
        if (document.body.contains(input)) {
            document.body.removeChild(input);
        }
    }, 100);
}

// Fun√ß√£o para importar Excel
export function importFromExcel() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx,.xls';
    input.style.display = 'none';
    
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            showError('Por favor, selecione um arquivo Excel (.xlsx ou .xls)');
            return;
        }
        
        showWarning('Convertendo Excel para JSON...');
        
        try {
            const base64File = await fileToBase64(file);
            
            const response = await fetch('/api/excel/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: file.name,
                    file: base64File
                })
            });
            
            if (!response.ok) {
                throw new Error(`Erro na convers√£o: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Erro desconhecido na convers√£o');
            }
            
            // Armazenar em staging
            window.stagingData = result.data;
            window.hasPendingChanges = true;
            
            // Exibir no editor
            const editor = document.getElementById('jsonEditor');
            if (editor) {
                editor.value = JSON.stringify(result.data, null, 2);
                updateLineNumbers();
                switchTab('raw');
            }
            
            showSuccess('Excel convertido para JSON com sucesso!');
            updateJSONStatus('‚úÖ Excel convertido. Dados em staging.', 'success');
            updateApplyButtonState();
            
        } catch (error) {
            console.error('Erro ao importar Excel:', error);
            showError(`Erro ao importar Excel: ${error.message}`);
            updateJSONStatus(`‚ùå Erro na convers√£o: ${error.message}`, 'error');
        }
    };
    
    document.body.appendChild(input);
    input.click();
    
    setTimeout(() => {
        if (document.body.contains(input)) {
            document.body.removeChild(input);
        }
    }, 100);
}

// Fun√ß√£o para exportar Excel
export async function exportToExcel() {
    try {
        const systemData = window.systemData || {};
        
        const validation = validateJSONStructure(systemData);
        if (!validation.valid) {
            showError('Dados do sistema inv√°lidos para exporta√ß√£o');
            return;
        }
        
        showWarning('Gerando arquivo Excel...');
        
        const response = await fetch('/api/excel/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(systemData)
        });
        
        if (!response.ok) {
            throw new Error(`Erro na gera√ß√£o: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Erro desconhecido na gera√ß√£o');
        }
        
        // Decodificar base64 e fazer download
        const binaryString = atob(result.data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        
        const blob = new Blob([bytes], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        const url = window.URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = result.filename || 'sistema_export.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showSuccess('Excel exportado com sucesso!');
        
    } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        showError(`Erro ao exportar Excel: ${error.message}`);
    }
}

// Fun√ß√£o auxiliar para mudar de tab
function switchTab(tabName) {
    if (typeof window.switchTab === 'function') {
        window.switchTab(tabName);
    }
}

// Fun√ß√£o auxiliar para valida√ß√£o de estrutura JSON
function validateJSONStructure(data) {
    const errors = [];
    
    if (!data.constants || typeof data.constants !== 'object') {
        errors.push('constants deve ser um objeto');
    }
    
    if (!data.machines || !Array.isArray(data.machines)) {
        errors.push('machines deve ser um array');
    }
    
    if (!data.materials || typeof data.materials !== 'object') {
        errors.push('materials deve ser um objeto');
    }
    
    if (!data.empresas || !Array.isArray(data.empresas)) {
        errors.push('empresas deve ser um array');
    }
    
    return {
        valid: errors.length === 0,
        errors: errors
    };
}
/* ==== FIM: config/ExpImpJsonFilles/json-import-export.js ==== */

/* ==== IN√çCIO: config/ExpImpJsonFilles/json-utils.js ==== */
// json-utils.js - Arquivo principal que coordena tudo
import { 
    initJSONEditor, 
    updateLineNumbers, 
    formatJSON, 
    validateJSON,
    updateApplyButtonState,
    updateJSONStatus
} from './json-editor.js';

import {
    exportToJSON,
    importFromJSON,
    importFromExcel,
    exportToExcel
} from './json-import-export.js';

import { showError, showSuccess, showWarning } from '../ui.js';

// ==================== FUN√á√ÉO APLICAR JSON ====================

export async function applyJSON() {
    const editor = document.getElementById('jsonEditor');
    if (!editor) {
        showError('Editor JSON n√£o encontrado');
        return;
    }
    
    try {
        const proposedData = JSON.parse(editor.value);
        const validation = validateJSONStructure(proposedData);
        
        if (!validation.valid) {
            showError('JSON inv√°lido. Corrija os erros antes de aplicar.');
            updateJSONStatus(`‚ùå JSON inv√°lido: ${validation.errors.join(', ')}`, 'error');
            return;
        }
        
        const currentData = window.systemData || {};
        const hasCurrentData = Object.keys(currentData).length > 0;
        
        if (hasCurrentData) {
            const comparison = await compareJSONData(currentData, proposedData);
            
            if (!comparison.summary.has_changes) {
                showWarning('Nenhuma altera√ß√£o detectada entre os dados atuais e propostos.');
                return;
            }
            
            const confirmed = await showJsonConfirmationModal(comparison);
            
            if (!confirmed) {
                showWarning('Aplica√ß√£o cancelada pelo usu√°rio.');
                return;
            }
            
            const applied = applyChangesIncremental(currentData, proposedData, comparison.differences);
            
            if (applied) {
                window.systemData = currentData;
                window.stagingData = null;
                window.hasPendingChanges = false;
                
                await saveSystemData(currentData);
                
                window.dispatchEvent(new CustomEvent('dataApplied', { 
                    detail: { data: currentData, changes: comparison.differences }
                }));
                
                updateAllTabsUI();
                editor.value = JSON.stringify(currentData, null, 2);
                updateLineNumbers();
                
                showSuccess('JSON aplicado com sucesso!');
                updateJSONStatus('‚úÖ JSON aplicado ao sistema.', 'success');
                updateApplyButtonState();
            }
        } else {
            window.systemData = proposedData;
            window.stagingData = null;
            window.hasPendingChanges = false;
            
            await saveSystemData(proposedData);
            
            window.dispatchEvent(new CustomEvent('dataImported', { 
                detail: proposedData 
            }));
            
            updateAllTabsUI();
            
            showSuccess('JSON aplicado com sucesso!');
            updateJSONStatus('‚úÖ JSON aplicado ao sistema.', 'success');
            updateApplyButtonState();
        }
        
    } catch (error) {
        console.error('Erro ao aplicar JSON:', error);
        showError(`Erro ao aplicar JSON: ${error.message}`);
        updateJSONStatus(`‚ùå Erro na aplica√ß√£o: ${error.message}`, 'error');
    }
}

// ==================== FUN√á√ïES AUXILIARES ====================

// Salva dados no servidor
async function saveSystemData(data) {
    try {
        const response = await fetch('/api/system-data/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Erro ao salvar dados no servidor');
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Erro ao salvar dados');
        }
        
        console.log('‚úÖ Dados salvos no servidor');
        return true;
        
    } catch (error) {
        console.error('Erro ao salvar dados:', error);
        showError('Erro ao salvar dados no servidor. As altera√ß√µes foram aplicadas apenas localmente.');
        return false;
    }
}

// Atualiza todas as tabs
function updateAllTabsUI() {
    if (window.loadConstants) window.loadConstants();
    if (window.loadMachines) window.loadMachines();
    if (window.loadMaterials) window.loadMaterials();
    if (window.loadEmpresas) window.loadEmpresas();
    if (window.populateMachineFilter) window.populateMachineFilter();
    if (window.loadJSONEditor) window.loadJSONEditor();
}

// Compara dados JSON
async function compareJSONData(current, proposed) {
    try {
        const response = await fetch('/api/system/apply-json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current: current,
                proposed: proposed
            })
        });
        
        if (!response.ok) {
            throw new Error('Erro na compara√ß√£o');
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Erro na compara√ß√£o');
        }
        
        return result;
        
    } catch (error) {
        console.error('Erro na compara√ß√£o:', error);
        return performLocalComparison(current, proposed);
    }
}

// Compara√ß√£o local
function performLocalComparison(current, proposed) {
    const differences = {
        constants: { added: [], modified: [], removed: [] },
        machines: { added: [], modified: [], removed: [] },
        materials: { added: [], modified: [], removed: [] },
        empresas: { added: [], modified: [], removed: [] }
    };
    
    // Compara√ß√£o de constants
    const currentConstKeys = Object.keys(current.constants || {});
    const proposedConstKeys = Object.keys(proposed.constants || {});
    
    for (const key of proposedConstKeys) {
        if (!currentConstKeys.includes(key)) {
            differences.constants.added.push(key);
        } else if (JSON.stringify(proposed.constants[key]) !== JSON.stringify(current.constants[key])) {
            differences.constants.modified.push(key);
        }
    }
    
    for (const key of currentConstKeys) {
        if (!proposedConstKeys.includes(key)) {
            differences.constants.removed.push(key);
        }
    }
    
    // C√°lculo de totais
    const totalAdded = differences.constants.added.length + differences.machines.added.length + 
                      differences.materials.added.length + differences.empresas.added.length;
    const totalModified = differences.constants.modified.length + differences.machines.modified.length + 
                         differences.materials.modified.length + differences.empresas.modified.length;
    const totalRemoved = differences.constants.removed.length + differences.machines.removed.length + 
                        differences.materials.removed.length + differences.empresas.removed.length;
    
    return {
        success: true,
        differences: differences,
        summary: {
            total_changes: totalAdded + totalModified + totalRemoved,
            total_added: totalAdded,
            total_modified: totalModified,
            total_removed: totalRemoved,
            has_changes: (totalAdded + totalModified + totalRemoved) > 0
        }
    };
}

// Aplica mudan√ßas incrementais
function applyChangesIncremental(current, proposed, differences) {
    try {
        if (!current.constants) current.constants = {};
        if (!current.machines) current.machines = [];
        if (!current.materials) current.materials = {};
        if (!current.empresas) current.empresas = [];
        
        // Aplicar constants
        for (const added of differences.constants.added) {
            current.constants[added] = proposed.constants[added];
        }
        for (const modified of differences.constants.modified) {
            current.constants[modified] = proposed.constants[modified];
        }
        
        // Aplicar machines
        for (const added of differences.machines.added) {
            const newMachine = proposed.machines.find(m => m.type === added);
            if (newMachine) {
                current.machines.push(newMachine);
            }
        }
        for (const modified of differences.machines.modified) {
            const updatedMachine = proposed.machines.find(m => m.type === modified);
            const index = current.machines.findIndex(m => m.type === modified);
            if (index !== -1 && updatedMachine) {
                current.machines[index] = updatedMachine;
            }
        }
        
        // Aplicar materials
        for (const added of differences.materials.added) {
            current.materials[added] = proposed.materials[added];
        }
        for (const modified of differences.materials.modified) {
            current.materials[modified] = proposed.materials[modified];
        }
        
        // Aplicar empresas
        for (const added of differences.empresas.added) {
            const newEmpresa = proposed.empresas.find(e => {
                const key = Object.keys(e)[0];
                return key === added;
            });
            if (newEmpresa) {
                current.empresas.push(newEmpresa);
            }
        }
        for (const modified of differences.empresas.modified) {
            const updatedEmpresa = proposed.empresas.find(e => {
                const key = Object.keys(e)[0];
                return key === modified;
            });
            const index = current.empresas.findIndex(e => {
                const key = Object.keys(e)[0];
                return key === modified;
            });
            if (index !== -1 && updatedEmpresa) {
                current.empresas[index] = updatedEmpresa;
            }
        }
        
        return true;
        
    } catch (error) {
        console.error('Erro ao aplicar mudan√ßas:', error);
        return false;
    }
}

// Modal de confirma√ß√£o
async function showJsonConfirmationModal(comparison) {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        
        if (!modal || !modalTitle || !modalMessage) {
            const confirmed = confirm(
                `Confirmar aplica√ß√£o de JSON?\n\n` +
                `Adicionados: ${comparison.summary.total_added}\n` +
                `Modificados: ${comparison.summary.total_modified}\n` +
                `Removidos: ${comparison.summary.total_removed}\n\n` +
                `Total: ${comparison.summary.total_changes} altera√ß√µes`
            );
            resolve(confirmed);
            return;
        }
        
        modalTitle.textContent = 'Confirmar Aplica√ß√£o de JSON';
        
        let messageHtml = `
            <div class="comparison-summary">
                <h4>Resumo das Altera√ß√µes:</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>Adicionados:</strong> ${comparison.summary.total_added}</li>
                    <li><strong>Modificados:</strong> ${comparison.summary.total_modified}</li>
                    <li><strong>Removidos:</strong> ${comparison.summary.total_removed}</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Total de altera√ß√µes:</strong> ${comparison.summary.total_changes}</p>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    <i class="icon-info"></i> Os itens marcados como "removidos" ser√£o mantidos no sistema.
                    Para remover itens, edite manualmente.
                </p>
            </div>
        `;
        
        modalMessage.innerHTML = messageHtml;
        modal.style.display = 'flex';
        
        const originalCallback = window.confirmCallback;
        
        window.confirmCallback = function() {
            window.confirmCallback = originalCallback;
            modal.style.display = 'none';
            resolve(true);
        };
        
        const cancelButton = modal.querySelector('.btn-secondary');
        if (cancelButton) {
            const originalOnClick = cancelButton.onclick;
            cancelButton.onclick = function() {
                modal.style.display = 'none';
                resolve(false);
                return false;
            };
        }
    });
}

// Valida estrutura b√°sica do JSON
function validateJSONStructure(data) {
    const errors = [];
    
    if (!data.constants || typeof data.constants !== 'object') {
        errors.push('constants deve ser um objeto');
    }
    
    if (!data.machines || !Array.isArray(data.machines)) {
        errors.push('machines deve ser um array');
    }
    
    if (!data.materials || typeof data.materials !== 'object') {
        errors.push('materials deve ser um objeto');
    }
    
    if (!data.empresas || !Array.isArray(data.empresas)) {
        errors.push('empresas deve ser um array');
    }
    
    return {
        valid: errors.length === 0,
        errors: errors
    };
}

// ==================== FUN√á√ïES DE SISTEMA ====================

// Salva dados
export async function saveData() {
    try {
        if (!window.systemData) {
            showError('Nenhum dado para salvar');
            return;
        }
        
        const response = await fetch('/api/system-data/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(window.systemData)
        });
        
        if (response.ok) {
            showSuccess('Dados salvos com sucesso!');
        } else {
            throw new Error('Erro ao salvar dados');
        }
        
    } catch (error) {
        console.error('Erro ao salvar:', error);
        showError('Erro ao salvar dados');
    }
}

// Carrega dados
export async function loadData() {
    try {
        const response = await fetch('/api/system-data');
        
        if (response.ok) {
            const data = await response.json();
            window.systemData = data;
            
            window.dispatchEvent(new CustomEvent('dataLoaded', { 
                detail: data 
            }));
            
            window.stagingData = null;
            window.hasPendingChanges = false;
            updateApplyButtonState();
            
            showSuccess('Dados carregados com sucesso!');
            
        } else {
            throw new Error('Erro ao carregar dados');
        }
        
    } catch (error) {
        console.error('Erro ao carregar:', error);
        showError('Erro ao carregar dados do servidor');
    }
}

// ==================== EXPORTA√á√ÉO GLOBAL ====================

// Exporta todas as fun√ß√µes para o escopo global
window.exportToJSON = exportToJSON;
window.importFromJSON = importFromJSON;
window.importFromExcel = importFromExcel;
window.exportToExcel = exportToExcel;
window.applyJSON = applyJSON;
window.formatJSON = formatJSON;
window.validateJSON = validateJSON;
window.saveData = saveData;
window.loadData = loadData;
window.updateLineNumbers = updateLineNumbers;
window.initJSONEditor = initJSONEditor;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initJSONEditor, 100);
    
    window.addEventListener('dataLoaded', function() {
        setTimeout(initJSONEditor, 50);
    });
    
    window.addEventListener('dataImported', function() {
        setTimeout(initJSONEditor, 50);
    });
    
    window.addEventListener('dataApplied', function(event) {
        setTimeout(initJSONEditor, 50);
    });
});
/* ==== FIM: config/ExpImpJsonFilles/json-utils.js ==== */

/* ==== IN√çCIO: main.js ==== */
import { loadModules } from './loader.js';
import { createSmartLogger } from '../01_Create_Obra/core/logger.js';

// // ‚úÖ INICIALIZAR LOGGER
// window.logger = createSmartLogger();

// // ‚úÖ EXPOR FUN√á√ÉO GLOBAL PARA CONTROLE DO LOGGER
// window.toggleSystemLogger = function(enable = null) {
//     if (window.logger && typeof window.toggleLogger === 'function') {
//         return window.toggleLogger(enable);
//     } else {
//         console.warn('‚ö†Ô∏è Logger n√£o dispon√≠vel para controle');
//         return false;
//     }
// };

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Sistema de Edi√ß√£o de Dados iniciado');
    
    // Carregar todos os m√≥dulos
    await loadModules();
    
    // Inicializar sistema de staging
    window.stagingData = null;
    window.hasPendingChanges = false;
    
    // Carregar dados iniciais
    setTimeout(() => {
        if (typeof window.loadData === 'function') {
            window.loadData();
        }
        
        // Inicializar bot√£o Aplicar JSON
        if (typeof updateApplyButtonState === 'function') {
            updateApplyButtonState();
        }
    }, 500);
});

// Fun√ß√µes globais para modais (existentes)
window.confirmAction = function(confirmed) {
    const modal = document.getElementById('confirmationModal');
    if (modal) modal.style.display = 'none';
    
    if (confirmed && window.confirmCallback) {
        window.confirmCallback();
        window.confirmCallback = null;
    }
};

window.closeEditModal = function() {
    const modal = document.getElementById('editModal');
    if (modal) modal.style.display = 'none';
};

window.saveEdit = function() {
    closeEditModal();
};

// Arquivo adicional para JSON Editor (existente)
const jsonEditorModule = {
    loadJSONEditor: function() {
        const editor = document.getElementById('jsonEditor');
        if (!editor) return;
        
        const systemData = window.systemData || {};
        editor.value = JSON.stringify(systemData, null, 2);
        this.updateJSONStatus('JSON carregado', 'info');
    },
    
    formatJSON: function() {
        const editor = document.getElementById('jsonEditor');
        try {
            const parsed = JSON.parse(editor.value);
            editor.value = JSON.stringify(parsed, null, 2);
            this.updateJSONStatus('JSON formatado com sucesso', 'success');
        } catch (error) {
            this.updateJSONStatus(`Erro de formata√ß√£o: ${error.message}`, 'error');
        }
    },
    
    validateJSON: function() {
        const editor = document.getElementById('jsonEditor');
        try {
            const parsed = JSON.parse(editor.value);
            
            const requiredKeys = ['constants', 'machines', 'materials', 'empresas'];
            const missingKeys = requiredKeys.filter(key => !(key in parsed));
            
            if (missingKeys.length > 0) {
                throw new Error(`Campos ausentes: ${missingKeys.join(', ')}`);
            }
            
            if (typeof parsed.constants !== 'object') {
                throw new Error('constants deve ser um objeto');
            }
            if (!Array.isArray(parsed.machines)) {
                throw new Error('machines deve ser um array');
            }
            if (typeof parsed.materials !== 'object') {
                throw new Error('materials deve ser um objeto');
            }
            if (!Array.isArray(parsed.empresas)) {
                throw new Error('empresas deve ser um array');
            }
            
            this.updateJSONStatus('‚úÖ JSON v√°lido e com estrutura correta', 'success');
            return true;
            
        } catch (error) {
            this.updateJSONStatus(`‚ùå JSON inv√°lido: ${error.message}`, 'error');
            return false;
        }
    },
    
    updateJSONStatus: function(message, type) {
        const status = document.getElementById('jsonStatus');
        if (!status) return;
        
        status.textContent = message;
        status.className = 'json-status-message';
        
        switch (type) {
            case 'success':
                status.classList.add('success');
                break;
            case 'error':
                status.classList.add('error');
                break;
            case 'info':
                status.classList.add('info');
                break;
            default:
                status.classList.add('info');
        }
    }
};

// Atribuir fun√ß√µes globais
window.loadJSONEditor = jsonEditorModule.loadJSONEditor.bind(jsonEditorModule);
window.formatJSON = jsonEditorModule.formatJSON.bind(jsonEditorModule);
window.validateJSON = jsonEditorModule.validateJSON.bind(jsonEditorModule);
window.updateJSONStatus = jsonEditorModule.updateJSONStatus.bind(jsonEditorModule);

// Disparar evento quando os dados s√£o carregados
window.addEventListener('dataLoaded', function(event) {
    const data = event.detail;
    
    // Atualizar todas as visualiza√ß√µes
    if (window.loadConstants) window.loadConstants();
    if (window.loadMachines) window.loadMachines();
    if (window.loadMaterials) window.loadMaterials();
    if (window.loadEmpresas) window.loadEmpresas();
    if (window.populateMachineFilter) window.populateMachineFilter();
    if (window.loadJSONEditor) window.loadJSONEditor();
    
    // Limpar staging
    window.stagingData = null;
    window.hasPendingChanges = false;
    if (typeof updateApplyButtonState === 'function') {
        updateApplyButtonState();
    }
});

// Disparar evento quando os dados s√£o importados (via staging)
window.addEventListener('dataImported', function(event) {
    const data = event.detail;
    window.systemData = data;
    
    // Atualizar todas as visualiza√ß√µes
    if (window.loadConstants) window.loadConstants();
    if (window.loadMachines) window.loadMachines();
    if (window.loadMaterials) window.loadMaterials();
    if (window.loadEmpresas) window.loadEmpresas();
    if (window.populateMachineFilter) window.populateMachineFilter();
    if (window.loadJSONEditor) window.loadJSONEditor();
    
    // Limpar staging
    window.stagingData = null;
    window.hasPendingChanges = false;
    if (typeof updateApplyButtonState === 'function') {
        updateApplyButtonState();
    }
});

// NOVO EVENTO: Dados aplicados via bot√£o "Aplicar JSON"
window.addEventListener('dataApplied', function(event) {
    const data = event.detail.data;
    const changes = event.detail.changes;
    
    console.log('Dados aplicados via bot√£o "Aplicar JSON":', changes);
    
    // Atualizar JSON Editor com os novos dados
    if (window.loadJSONEditor) {
        window.loadJSONEditor();
    }
    
    // Registrar no logger se dispon√≠vel
    if (window.logger && window.logger.log) {
        window.logger.log('Sistema', `JSON aplicado: ${changes.summary.total_changes} altera√ß√µes`);
    }
});

// Fun√ß√£o para switchTab (se n√£o existir)
if (typeof window.switchTab === 'undefined') {
    window.switchTab = function(tabName) {
        // Esconder todas as tabs
        document.querySelectorAll('.tab-pane').forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        
        // Remover active de todos os bot√µes
        document.querySelectorAll('.tabs .tab').forEach(tabBtn => {
            tabBtn.classList.remove('active');
        });
        
        // Mostrar tab selecionada
        const tabElement = document.getElementById(tabName + 'Tab');
        if (tabElement) {
            tabElement.classList.add('active');
            tabElement.style.display = 'block';
        }
        
        // Ativar bot√£o correspondente
        const tabButtons = document.querySelectorAll('.tabs .tab');
        tabButtons.forEach(btn => {
            if (btn.textContent.toLowerCase().includes(tabName.toLowerCase()) || 
                btn.getAttribute('onclick')?.includes(tabName)) {
                btn.classList.add('active');
            }
        });
    };
}
/* ==== FIM: main.js ==== */
