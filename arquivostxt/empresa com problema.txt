
/* ==== IN√çCIO: empresa-autocomplete.js ==== */
// empresa-autocomplete.js
/**
 * üîç EMPRESA-AUTOCOMPLETE.JS - Sistema de Busca/Autocomplete de Empresas
 * ‚úÖ Responsabilidade: Input h√≠brido, filtragem, navega√ß√£o por teclado, sele√ß√£o
 * ‚úÖ Arquivo 2 de 5 na refatora√ß√£o do sistema de empresa
 */

import {
    carregarEmpresasComCache,
    EmpresaCadastroInline
} from './empresa-core.js';
import {
    inicializarDetectorBackspace,
    corrigirPosicaoDropdown,
    mostrarAvisoAutocompletado,
    limparDadosSelecao
} from './empresa-ui-helpers.js';




/* ==== SE√á√ÉO 1: INICIALIZA√á√ÉO DO INPUT H√çBRIDO ==== */

/**
 * INICIALIZAR INPUT H√çBRIDO - OTIMIZADO
 */
async function inicializarInputEmpresaHibrido(obraId) {
    console.log(`üîß [INPUT H√çBRIDO] Inicializando para obra: ${obraId}`);

    const input = document.getElementById(`empresa-input-${obraId}`);
    const dropdown = document.getElementById(`empresa-dropdown-${obraId}`);
    const optionsContainer = document.getElementById(`empresa-options-${obraId}`);

    if (!input) {
        console.error(`‚ùå [INPUT H√çBRIDO] Input n√£o encontrado para obra ${obraId}`);
        return;
    }

    // üî• CORRE√á√ÉO: CARREGAR EMPRESAS COM CACHE
    let empresas = [];
    try {
        empresas = await carregarEmpresasComCache();
        console.log(`‚úÖ [INPUT H√çBRIDO] ${empresas.length} empresas dispon√≠veis`);
    } catch (error) {
        console.error(`‚ùå [INPUT H√çBRIDO] Erro ao carregar empresas:`, error);
        empresas = [];
    }

    // üî• DEBOUNCE PARA EVITAR MUITAS BUSCAS R√ÅPIDAS
    let timeoutBusca;

    // üî• INICIALIZAR DETECTOR DE BACKSPACE
    inicializarDetectorBackspace(input, obraId);

    // üî• EVENTO DE INPUT OTIMIZADO
    input.addEventListener('input', function (e) {
        const termo = e.target.value.trim();

        // Limpa timeout anterior
        if (timeoutBusca) {
            clearTimeout(timeoutBusca);
        }

        // üî• DEBOUNCE: Aguarda 150ms antes de processar
        timeoutBusca = setTimeout(() => {
            processarInputEmpresa(termo, input, dropdown, optionsContainer, obraId, empresas);
        }, 150);
    });

    // üî• EVENTO DE FOCO - MAIS R√ÅPIDO
    input.addEventListener('focus', function () {
        window.usuarioEstaApagando = false;
        window.ultimoValorInput = this.value;

        const valorAtual = this.value.trim();
        const empresaJaSelecionada = this.dataset.siglaSelecionada;

        if (valorAtual.length === 0) {
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        } else if (empresaJaSelecionada && valorAtual === `${this.dataset.siglaSelecionada} - ${this.dataset.nomeSelecionado}`) {
            dropdown.style.display = 'none';
        } else {
            const sugestoes = filtrarEmpresas(valorAtual, empresas);
            exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
        }
    });

    // üî• EVENTO DE BLUR
    input.addEventListener('blur', function () {
        if (timeoutBusca) {
            clearTimeout(timeoutBusca);
        }
        setTimeout(() => {
            window.usuarioEstaApagando = false;
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }, 200);
    });

    // üî• EVENTO DE TECLADO OTIMIZADO
    input.addEventListener('keydown', function (e) {
        if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Tab'].includes(e.key)) {
            e.preventDefault();

            switch (e.key) {
                case 'ArrowDown':
                    navegarDropdown('down', optionsContainer, input, dropdown, obraId);
                    break;
                case 'ArrowUp':
                    navegarDropdown('up', optionsContainer, input, dropdown, obraId);
                    break;
                case 'Enter':
                case 'Tab':
                    if (dropdown.style.display === 'block') {
                        selecionarOpcaoAtiva(optionsContainer, input, dropdown, obraId);
                    } else {
                        dropdown.style.display = 'none';
                        input.blur();
                    }
                    break;
                case 'Escape':
                    dropdown.style.display = 'none';
                    input.blur();
                    break;
            }
        }
    });

    // üî• EVENTO DE CLIQUE FORA - OTIMIZADO
    const fecharDropdownHandler = function (e) {
        if (input && dropdown && !input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    };

    document.addEventListener('click', fecharDropdownHandler);

    // üî• LIMPEZA AO DESTRUIR COMPONENTE
    input._cleanup = () => {
        document.removeEventListener('click', fecharDropdownHandler);
        if (timeoutBusca) {
            clearTimeout(timeoutBusca);
        }
    };

    console.log(`‚úÖ [INPUT H√çBRIDO] Inicializado com sucesso para obra ${obraId}`);
}

/* ==== SE√á√ÉO 2: PROCESSAMENTO E FILTRAGEM ==== */

/**
 * PROCESSAR INPUT COM DEBOUNCE
 */
function processarInputEmpresa(termo, input, dropdown, optionsContainer, obraId, empresas) {
    console.log(`üîç [INPUT] Processando: "${termo}" | Apagando: ${window.usuarioEstaApagando}`);

    // üî• SE USU√ÅRIO EST√Å APAGANDO, N√ÉO FAZER AUTOCOMPLETE
    if (window.usuarioEstaApagando) {
        console.log('üö´ Autocomplete bloqueado - usu√°rio apagando');

        if (termo.length === 0) {
            limparDadosSelecao(input, obraId);
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        } else {
            const sugestoes = filtrarEmpresas(termo, empresas);
            exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
        }

        setTimeout(() => {
            window.usuarioEstaApagando = false;
        }, 100);
        return;
    }

    // üî• COMPORTAMENTO NORMAL
    if (termo.length === 0) {
        limparDadosSelecao(input, obraId);
        exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        return;
    }

    const sugestoes = filtrarEmpresas(termo, empresas);

    // üî• AUTOCOMPLETE S√ì SE N√ÉO ESTIVER APAGANDO
    if (sugestoes.length === 1 && termo.length > 0 && !window.usuarioEstaApagando) {
        const [sigla, nome] = Object.entries(sugestoes[0])[0];
        const matchForte = termo === sigla || termo.length >= 3;

        if (matchForte) {
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'autocomplete');
            return;
        }
    }

    exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
}

/**
 * FILTRAR EMPRESAS OTIMIZADO
 */
function filtrarEmpresas(termo, empresas) {
    if (!termo || termo.length < 1) return [];

    const termoNormalizado = termo.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    return empresas.filter(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

        return sigla === termoNormalizado ||
            sigla.includes(termoNormalizado) ||
            nomeNormalizado.includes(termoNormalizado);
    });
}

/* ==== SE√á√ÉO 3: EXIBI√á√ÉO DE SUGEST√ïES ==== */

/**
 * EXIBIR SUGEST√ïES OTIMIZADO - COM SUPORTE TOUCHPAD
 */
function exibirSugestoes(sugestoes, container, input, dropdown, obraId) {
    const valorAtual = input.value.trim();
    const empresaJaSelecionada = input.dataset.siglaSelecionada;

    if (empresaJaSelecionada && valorAtual === `${input.dataset.siglaSelecionada} - ${input.dataset.nomeSelecionado}`) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }

    if (!sugestoes || sugestoes.length === 0) {
        container.innerHTML = valorAtual.length > 0
            ? `<div class="dropdown-no-results">üìù Nenhuma empresa encontrada<br><small>Criando nova empresa: "${valorAtual}"</small></div>`
            : '<div class="dropdown-no-results">Digite para buscar empresas</div>';

        dropdown.style.display = 'block';
        return;
    }

    const sugestoesLimitadas = sugestoes.slice(0, 50);

    // üî• BLOQUEAR SELE√á√ÉO AUTOM√ÅTICA SE EST√Å APAGANDO
    if (sugestoesLimitadas.length === 1 && valorAtual.length > 0 && !window.usuarioEstaApagando) {
        const [sigla, nome] = Object.entries(sugestoesLimitadas[0])[0];
        const matchForte = valorAtual === sigla || valorAtual.length >= 3;

        if (matchForte) {
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'autocomplete');
            return;
        }
    }

    // üî• RENDERIZA√á√ÉO MAIS R√ÅPIDA
    container.innerHTML = sugestoesLimitadas.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}" title="${nome}">
                <strong>${sigla}</strong> 
                <div class="nome-empresa">- ${nome}</div>
            </div>
        `;
    }).join('');

    dropdown.style.display = 'block';
    setTimeout(corrigirPosicaoDropdown, 10);

    // Selecionar primeira op√ß√£o
    const primeiraOpcao = container.querySelector('.dropdown-option');
    if (primeiraOpcao) {
        primeiraOpcao.classList.add('active');
    }

    // ‚úÖ CORRE√á√ÉO: APLICAR EVENT LISTENERS DIRETOS PARA SUPORTE TOUCHPAD
    aplicarEventListenersDiretos(container, input, dropdown, obraId);

    console.log(`üîç [EMPRESA] Exibindo ${sugestoesLimitadas.length} sugest√µes`);
}

/**
 * EXIBIR TODAS AS EMPRESAS - COM SUPORTE TOUCHPAD
 */
function exibirTodasEmpresas(empresas, container, input, dropdown, obraId) {
    const empresaJaSelecionada = input.dataset.siglaSelecionada;

    if (empresaJaSelecionada) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }

    if (!empresas || empresas.length === 0) {
        container.innerHTML = `
            <div class="dropdown-no-results">
                üìù Nenhuma empresa cadastrada<br>
                <small>Digite o nome para criar uma nova</small>
            </div>
        `;
        dropdown.style.display = 'block';
        return;
    }

    const empresasLimitadas = empresas.slice(0, 50);

    const html = empresasLimitadas.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];

        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}" title="${nome}">
                <strong>${sigla}</strong> 
                <div class="nome-empresa">- ${nome}</div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
    dropdown.style.display = 'block';
    setTimeout(corrigirPosicaoDropdown, 10);

    setTimeout(() => {
        if (dropdown.scrollHeight > 200) {
            dropdown.style.overflowY = 'auto';
            dropdown.style.maxHeight = '200px';
        }
    }, 10);

    // ‚úÖ CORRE√á√ÉO: APLICAR EVENT LISTENERS DIRETOS PARA SUPORTE TOUCHPAD
    aplicarEventListenersDiretos(container, input, dropdown, obraId);

    console.log(`üìä [EMPRESA] Exibindo ${empresasLimitadas.length} de ${empresas.length} empresas`);
}

/* ==== SE√á√ÉO 4: NAVEGA√á√ÉO E SELE√á√ÉO ==== */

/**
 * NAVEGAR NO DROPDOWN COM TECLADO - COM LOOP (FINAL ‚Üí IN√çCIO)
 */
function navegarDropdown(direcao, container, input, dropdown, obraId) {
    const options = container.querySelectorAll('.dropdown-option');
    if (options.length === 0) return;

    const activeOption = container.querySelector('.dropdown-option.active');
    let nextIndex = 0;

    if (activeOption) {
        const currentIndex = Array.from(options).indexOf(activeOption);

        // üî• COMPORTAMENTO EXCEL COM LOOP
        if (direcao === 'down') {
            // Para baixo: se est√° no √∫ltimo, volta para o primeiro
            nextIndex = currentIndex === options.length - 1 ? 0 : currentIndex + 1;
        } else {
            // Para cima: se est√° no primeiro, vai para o √∫ltimo
            nextIndex = currentIndex === 0 ? options.length - 1 : currentIndex - 1;
        }

        console.log(`üîÑ Navega√ß√£o: ${currentIndex} ‚Üí ${nextIndex} (total: ${options.length})`);
    } else {
        // Se n√£o h√° op√ß√£o ativa, come√ßa na primeira (down) ou √∫ltima (up)
        nextIndex = direcao === 'down' ? 0 : options.length - 1;
    }

    // Remove active de todas e aplica na nova
    options.forEach(opt => opt.classList.remove('active'));
    options[nextIndex].classList.add('active');

    // üî• COMPORTAMENTO EXCEL: Atualiza o input em tempo real durante navega√ß√£o
    const sigla = options[nextIndex].dataset.sigla;
    const nome = options[nextIndex].dataset.nome;
    input.value = `${sigla} - ${nome}`;

    // Scroll para a op√ß√£o ativa
    options[nextIndex].scrollIntoView({
        block: 'nearest',
        behavior: 'smooth'
    });

    console.log(`üéØ Navegando para: ${sigla} - ${nome} (${nextIndex + 1}/${options.length})`);
}

/**
 * SELECIONAR EMPRESA - COM ATUALIZA√á√ÉO DO N√öMERO DO CLIENTE
 */
function selecionarEmpresa(sigla, nome, input, dropdown, obraId, tipoSelecao = 'manual') {
    console.log('üéØ Selecionando empresa:', sigla, nome, 'Tipo:', tipoSelecao);

    // üî• 1. Atualizar o campo da empresa
    if (input) {
        // Remover atributo value hardcoded
        input.removeAttribute('value');

        // Definir novo valor
        if (input.readOnly || input.disabled) {
            input.setAttribute('value', `${sigla} - ${nome}`);
        }
        input.value = `${sigla} - ${nome}`;

        // Definir data attributes
        input.dataset.siglaSelecionada = sigla;
        input.dataset.nomeSelecionado = nome;
    }

    // üî• 2. Atualizar dados da obra
    const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (obraElement) {
        obraElement.dataset.empresaSigla = sigla;
        obraElement.dataset.empresaNome = nome;
        obraElement.dataset.dataCadastro = new Date().toLocaleDateString('pt-BR');
    }

    // üî• 3. FECHAR DROPDOWN
    if (dropdown) {
        dropdown.style.display = 'none';
    }

    // üî• 4. CALCULAR NOVO N√öMERO DO CLIENTE (CR√çTICO!)
    if (window.empresaCadastro && typeof window.empresaCadastro.calcularNumeroClienteFinal === 'function') {
        window.empresaCadastro.calcularNumeroClienteFinal(sigla, obraId);
    } else {
        const empresaCadastro = new EmpresaCadastroInline();
        empresaCadastro.calcularNumeroClienteFinal(sigla, obraId);
    }

    // üî• 5. LIMPAR OUTROS CAMPOS DO FORMUL√ÅRIO
    setTimeout(() => {
        if (obraElement) {
            const formEmpresa = obraElement.querySelector('.empresa-formulario-ativo');
            if (formEmpresa) {
                // Limpar campos de cliente final, c√≥digo e or√ßamentista
                const camposParaLimpar = [
                    '.cliente-final-input',
                    '.codigo-cliente-input',
                    '.orcamentista-responsavel-input'
                ];

                camposParaLimpar.forEach(seletor => {
                    const campo = formEmpresa.querySelector(seletor);
                    if (campo) {
                        campo.value = '';
                    }
                });
            }
        }

        // Remover foco do input
        if (input) input.blur();
    }, 50);

    console.log(`‚úÖ Empresa selecionada: ${sigla} - ${nome}`);
}

/**
 * SELECIONAR OP√á√ÉO ATIVA (ENTER/TAB)
 */
function selecionarOpcaoAtiva(container, input, dropdown, obraId) {
    const activeOption = container.querySelector('.dropdown-option.active');
    if (activeOption) {
        const sigla = activeOption.dataset.sigla;
        const nome = activeOption.dataset.nome;
        console.log('‚å®Ô∏è Sele√ß√£o por teclado');

        // üî• TIPO: manual (usu√°rio usou teclado)
        selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
    }
}

/* ==== SE√á√ÉO 5: EVENT LISTENERS E TOUCH SUPPORT ==== */

/**
 * APLICAR EVENT LISTENERS DIRETOS - SUPORTE TOUCHPAD
 */
function aplicarEventListenersDiretos(container, input, dropdown, obraId) {
    const options = container.querySelectorAll('.dropdown-option');

    options.forEach(option => {
        // Remove listeners antigos
        option._clickHandler && option.removeEventListener('click', option._clickHandler);
        option._pointerHandler && option.removeEventListener('pointerdown', option._pointerHandler);
        option._touchHandler && option.removeEventListener('touchend', option._touchHandler);

        // Novo handler para click
        option._clickHandler = function (e) {
            e.preventDefault();
            e.stopPropagation();
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            console.log('üñ±Ô∏è Sele√ß√£o por CLICK direto');
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
        };

        // Novo handler para pointer (touchpad)
        option._pointerHandler = function (e) {
            e.preventDefault();
            e.stopPropagation();
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            console.log('üñ±Ô∏è Sele√ß√£o por POINTER direto');
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
        };

        // Novo handler para touch
        option._touchHandler = function (e) {
            e.preventDefault();
            e.stopPropagation();
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            console.log('üñ±Ô∏è Sele√ß√£o por TOUCH direto');
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
        };

        // Aplicar todos os listeners
        option.addEventListener('click', option._clickHandler);
        option.addEventListener('pointerdown', option._pointerHandler);
        option.addEventListener('touchend', option._touchHandler);
    });
}

/**
 * INICIALIZAR EVENT DELEGATION PARA CLIQUE NAS OP√á√ïES
 * ‚úÖ CORRE√á√ÉO: Suporte para touchpad, mouse e touch
 */
function inicializarEventDelegationClique() {
    // Event delegation global para todos os dropdowns de empresa
    // Captura m√∫ltiplos tipos de eventos para suporte completo

    const eventos = ['click', 'pointerdown', 'touchend'];

    eventos.forEach(eventType => {
        document.addEventListener(eventType, function (e) {
            const option = e.target.closest('.dropdown-option');
            if (option) {
                e.preventDefault();
                e.stopPropagation();

                // Encontrar o input e dropdown pai
                const dropdown = option.closest('.empresa-dropdown');
                if (!dropdown) return;

                const dropdownId = dropdown.id;
                const obraId = dropdownId.replace('empresa-dropdown-', '');
                const input = document.getElementById(`empresa-input-${obraId}`);

                if (input && dropdown) {
                    const sigla = option.dataset.sigla;
                    const nome = option.dataset.nome;
                    console.log(`üñ±Ô∏è Sele√ß√£o por ${eventType}`);

                    selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
                }
            }
        });
    });
}

/* ==== SE√á√ÉO 6: INICIALIZA√á√ÉO GLOBAL ==== */

// ‚úÖ INICIALIZAR EVENT DELEGATION QUANDO O M√ìDULO FOR CARREGADO
document.addEventListener('DOMContentLoaded', function () {
    inicializarEventDelegationClique();
    console.log('‚úÖ [EMPRESA-AUTOCOMPLETE] Event delegation inicializado');
});



export {
    inicializarInputEmpresaHibrido,
    processarInputEmpresa,
    filtrarEmpresas,
    exibirSugestoes,
    exibirTodasEmpresas,
    navegarDropdown,
    selecionarEmpresa,
    selecionarOpcaoAtiva,
    aplicarEventListenersDiretos,
    inicializarEventDelegationClique
}

// Compatibilidade global
if (typeof window !== 'undefined') {
    window.inicializarInputEmpresaHibrido = inicializarInputEmpresaHibrido;
    window.processarInputEmpresa = processarInputEmpresa;
    window.filtrarEmpresas = filtrarEmpresas;
    window.exibirSugestoes = exibirSugestoes;
    window.exibirTodasEmpresas = exibirTodasEmpresas;
    window.navegarDropdown = navegarDropdown;
    window.selecionarEmpresa = selecionarEmpresa;
    window.selecionarOpcaoAtiva = selecionarOpcaoAtiva;
    window.aplicarEventListenersDiretos = aplicarEventListenersDiretos;
    window.inicializarEventDelegationClique = inicializarEventDelegationClique;
}
/* ==== FIM: empresa-autocomplete.js ==== */

/* ==== IN√çCIO: empresa-core.js ==== */
// empresa-core.js
/**
 * EMPRESA-CORE.JS - N√∫cleo do Sistema de Empresas
 * Responsabilidade: Inicializa√ß√£o, cache, fun√ß√µes fundamentais, classe principal
 */

/* ==== SE√á√ÉO 1: SISTEMA DE CACHE DE EMPRESAS ==== */

// üÜï CACHE DE EMPRESAS - EVITA M√öLTIPLAS REQUISI√á√ïES
window.empresasCache = null;
window.cacheTimestamp = null;
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

/**
 * CARREGAR EMPRESAS COM CACHE
 */
async function carregarEmpresasComCache() {
    const agora = Date.now();

    // Se tem cache v√°lido, retorna do cache
    if (window.empresasCache && window.cacheTimestamp && (agora - window.cacheTimestamp) < CACHE_DURATION) {
        console.log('üì¶ [CACHE] Retornando empresas do cache');
        return window.empresasCache;
    }

    try {
        console.log('üì¶ [CACHE] Carregando empresas do servidor...');
        const response = await fetch('/api/dados/empresas');

        if (response.ok) {
            const data = await response.json();
            const empresas = data.empresas || [];

            // Atualiza cache
            window.empresasCache = empresas;
            window.cacheTimestamp = agora;

            console.log(`‚úÖ [CACHE] ${empresas.length} empresas carregadas e cacheadas`);
            return empresas;
        } else {
            console.error('‚ùå [CACHE] Erro ao carregar empresas:', response.status);
            return [];
        }
    } catch (error) {
        console.error('‚ùå [CACHE] Erro no carregamento:', error);
        return window.empresasCache || []; // Retorna cache antigo se dispon√≠vel
    }
}

/**
 * LIMPAR CACHE (para ser chamado quando novas empresas forem adicionadas)
 */
function limparCacheEmpresas() {
    window.empresasCache = null;
    window.cacheTimestamp = null;
    console.log('üßπ [CACHE] Cache de empresas limpo');
}

/* ==== SE√á√ÉO 2: CLASSE PRINCIPAL - EMPRESA CADASTRO INLINE ==== */

import { showSystemStatus } from '../../ui/components/status.js';

export class EmpresaCadastroInline {
    constructor() {
        this.empresas = [];
        this.obrasExistentes = [];
        this.container = null;
        this.isActive = false;

        this.init();
    }

    async init() {
        await this.carregarDados();
        this.vincularEventos();
    }

    async carregarDados() {
        try {
            // Carregar empresas do dados.json
            const responseEmpresas = await fetch('/api/dados/empresas');
            if (responseEmpresas.ok) {
                const dados = await responseEmpresas.json();
                this.empresas = dados.empresas || [];
            }

            // Carregar obras existentes do backup.json
            const responseBackup = await fetch('/api/backup-completo');
            if (responseBackup.ok) {
                const backup = await responseBackup.json();
                this.obrasExistentes = backup.obras || [];
            }

            console.log(`üìä Dados carregados: ${this.empresas.length} empresas, ${this.obrasExistentes.length} obras`);
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados:', error);
        }
    }

    vincularEventos() {
        // Encontrar todos os spans de cadastro de empresas e transformar em bot√µes
        const spansCadastro = document.querySelectorAll('.projetc-header-record.very-dark span');

        spansCadastro.forEach(span => {
            // Transformar span em bot√£o
            const button = document.createElement('button');
            button.className = 'btn-empresa-cadastro';
            button.textContent = span.textContent;
            button.setAttribute('type', 'button');

            // Substituir span por bot√£o
            span.parentNode.replaceChild(button, span);

            // Vincular eventos
            button.addEventListener('click', (e) => this.ativarCadastro(e));
            button.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.ativarCadastro(e);
                }
            });
        });
    }

    ativarCadastro(event) {
        if (this.isActive) return;

        const span = event.target;
        this.container = span.closest('.projetc-header-record');

        if (!this.container) {
            console.error('‚ùå Container n√£o encontrado');
            return;
        }

        // Ocultar span e mostrar formul√°rio inline
        span.style.display = 'none';
        this.renderizarFormulario();
        this.isActive = true;

        // Inicializar campo de n√∫mero do cliente
        const obraElement = this.container.closest('.obra-block');
        if (obraElement) {
            this.inicializarCampoNumeroCliente(obraElement);
        }

        console.log('‚úÖ Cadastro inline ativado');
    }

    renderizarFormulario() {
        const formHTML = this.criarHTMLFormulario();
        this.container.insertAdjacentHTML('beforeend', formHTML);

        this.configurarEstadoCampos();
        this.vincularEventosFormulario();

        setTimeout(() => {
            const empresaInput = this.container.querySelector('#empresa-input');
            if (empresaInput) empresaInput.focus();
        }, 100);
    }

    configurarEstadoCampos() {
        const camposLiberados = [
            'empresa-input',
            'cliente-final',
            'codigo-cliente',
            'data-cadastro',
            'orcamentista-responsavel'
        ];

        camposLiberados.forEach(campoId => {
            const campo = this.container.querySelector(`#${campoId}`);
            if (campo) {
                campo.removeAttribute('readonly');
                campo.removeAttribute('disabled');
                campo.readOnly = false;
                campo.disabled = false;
                campo.style.backgroundColor = '#ffffff';
                campo.style.borderColor = '#007bff';
                campo.style.cursor = 'text';
                campo.style.color = '#000000';
            }
        });

        const camposBloqueados = [
            'numero-cliente-final'
        ];

        camposBloqueados.forEach(campoId => {
            const campo = this.container.querySelector(`#${campoId}`);
            if (campo) {
                campo.readOnly = true;
                campo.setAttribute('readonly', 'true');
                campo.style.backgroundColor = '#f8f9fa';
                campo.style.borderColor = '#ced4da';
                campo.style.cursor = 'not-allowed';
                campo.style.color = '#6c757d';
            }
        });

        this.configurarCampoData();
    }

    configurarCampoData() {
        const dataCampo = this.container.querySelector('#data-cadastro');
        if (dataCampo) {
            dataCampo.removeAttribute('readonly');
            dataCampo.readOnly = false;
            dataCampo.disabled = false;
            dataCampo.title = "Clique para editar a data (DD/MM/AAAA)";
            dataCampo.placeholder = "DD/MM/AAAA";
            dataCampo.style.backgroundColor = '#ffffff';
            dataCampo.style.borderColor = '#007bff';
            dataCampo.style.cursor = 'text';
            dataCampo.style.color = '#000000';

            dataCampo.addEventListener('input', (e) => {
                this.aplicarMascaraData(e.target);
            });

            dataCampo.addEventListener('blur', (e) => {
                this.validarData(e.target);
            });
        }
    }

    aplicarMascaraData(input) {
        let value = input.value.replace(/\D/g, '');

        if (value.length > 8) {
            value = value.substring(0, 8);
        }

        if (value.length > 4) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4);
        } else if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }

        input.value = value;
    }

    validarData(input) {
        const valor = input.value.trim();

        if (!valor) return true;

        const regexData = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        const match = valor.match(regexData);

        if (!match) {
            showSystemStatus('Formato de data inv√°lido. Use DD/MM/AAAA', 'warning');
            input.focus();
            return false;
        }

        const dia = parseInt(match[1], 10);
        const mes = parseInt(match[2], 10);
        const ano = parseInt(match[3], 10);

        if (mes < 1 || mes > 12) {
            showSystemStatus('M√™s deve estar entre 01 e 12', 'warning');
            input.focus();
            return false;
        }

        if (dia < 1 || dia > 31) {
            showSystemStatus('Dia deve estar entre 01 e 31', 'warning');
            input.focus();
            return false;
        }

        const data = new Date(ano, mes - 1, dia);
        if (data.getDate() !== dia || data.getMonth() + 1 !== mes || data.getFullYear() !== ano) {
            showSystemStatus('Data inv√°lida para o m√™s especificado', 'warning');
            input.focus();
            return false;
        }

        return true;
    }

    criarHTMLFormulario() {
        const obraId = this.container?.closest('.obra-block')?.dataset?.obraId || 'temp';

        return `
        <div class="empresa-formulario-ativo" id="empresa-formulario-${obraId}">
            <h4>Cadastro de Empresa</h4>

            <div class="empresa-form-grid-horizontal">
                <div class="form-group-horizontal">
                    <label>Empresa *</label>
                    <div class="empresa-input-container">
                        <input type="text" 
                            class="empresa-input-cadastro" 
                            id="empresa-input-${obraId}"
                            placeholder="Digite sigla ou nome ou selecione..."
                            autocomplete="off">
                        <div class="empresa-dropdown" id="empresa-dropdown-${obraId}">
                            <div class="dropdown-options" id="empresa-options-${obraId}"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group-horizontal">
                    <label>N¬∫ Cliente</label>
                    <input type="text" 
                        class="numero-cliente-final-cadastro" 
                        id="numero-cliente-${obraId}"
                        placeholder="Ser√° calculado automaticamente (pode editar)">
                </div>

                <div class="form-group-horizontal">
                    <label>Cliente Final</label>
                    <input type="text" 
                        class="cliente-final-cadastro" 
                        id="cliente-final-${obraId}"
                        placeholder="Nome do cliente final">
                </div>

                <div class="form-group-horizontal">
                    <label>C√≥digo</label>
                    <input type="text" 
                        class="codigo-cliente-cadastro" 
                        id="codigo-cliente-${obraId}"
                        placeholder="C√≥digo do cliente">
                </div>

                <div class="form-group-horizontal">
                    <label>Data</label>
                    <div class="date-input-container">
                        <input type="text" 
                            class="data-cadastro-cadastro" 
                            id="data-cadastro-${obraId}"
                            placeholder="DD/MM/AAAA"
                            value="${new Date().toLocaleDateString('pt-BR')}"
                            maxlength="10">
                        <span class="calendar-icon" onclick="window.alternarDatePicker('${obraId}', 'cadastro')">üìÖ</span>
                    </div>
                </div>

                <div class="form-group-horizontal">
                    <label>Or√ßamentista</label>
                    <input type="text" 
                        class="orcamentista-responsavel-cadastro" 
                        id="orcamentista-${obraId}"
                        placeholder="Nome do or√ßamentista">
                </div>
            </div>

            <div class="empresa-form-actions">
                <button type="button" class="btn-cancel" 
                        onclick="window.empresaCadastro.cancelarCadastro()">
                    Cancelar
                </button>
            </div>
        </div>
        `;
    }

    vincularEventosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.addEventListener('input', (e) => this.buscarEmpresas(e.target.value));
            empresaInput.addEventListener('blur', () => {
                setTimeout(() => this.ocultarSugestoes(), 200);
            });
            empresaInput.addEventListener('keydown', (e) => this.tratarTecladoAutocomplete(e));
            this.observarMudancasEmpresa();
        }

        const dataCampo = this.container.querySelector('#data-cadastro');
        if (dataCampo) {
            dataCampo.addEventListener('change', () => {
                this.validarData(dataCampo);
            });
        }
    }

    async buscarEmpresas(termo) {
        if (!termo || termo.length < 2) {
            this.ocultarSugestoes();
            return;
        }

        const termoNormalizado = this.normalizarTermo(termo);
        const sugestoes = this.filtrarEmpresas(termoNormalizado);

        this.exibirSugestoes(sugestoes);
    }

    normalizarTermo(termo) {
        return termo.trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    filtrarEmpresas(termo) {
        return this.empresas.filter(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const primeiroNome = nome.split(' ')[0].toUpperCase();

            return sigla === termo ||
                nomeNormalizado.includes(termo) ||
                primeiroNome.includes(termo);
        });
    }

    exibirSugestoes(sugestoes) {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (!containerSugestoes) return;

        if (sugestoes.length === 0) {
            this.ocultarSugestoes();
            return;
        }

        const html = sugestoes.map(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const primeiroNome = nome.split(' ')[0];

            return `
                <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}">
                    <strong>${sigla}</strong> - ${primeiroNome}
                </div>
            `;
        }).join('');

        containerSugestoes.innerHTML = html;
        containerSugestoes.style.display = 'block';

        containerSugestoes.querySelectorAll('.dropdown-option').forEach(item => {
            item.addEventListener('click', () => {
                const sigla = item.dataset.sigla;
                const nome = item.dataset.nome;
                this.selecionarEmpresa(sigla, nome);
            });
        });
    }

    ocultarSugestoes() {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (containerSugestoes) {
            containerSugestoes.style.display = 'none';
        }
    }

    tratarTecladoAutocomplete(event) {
        const sugestoes = this.container.querySelectorAll('.dropdown-option');
        if (sugestoes.length === 0) return;

        const sugestaoAtiva = this.container.querySelector('.dropdown-option.active');

        switch (event.key) {
            case 'ArrowDown':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, 1);
                break;
            case 'ArrowUp':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, -1);
                break;
            case 'Enter':
                event.preventDefault();
                if (sugestaoAtiva) {
                    const sigla = sugestaoAtiva.dataset.sigla;
                    const nome = sugestaoAtiva.dataset.nome;
                    this.selecionarEmpresa(sigla, nome);
                }
                break;
            case 'Escape':
                this.ocultarSugestoes();
                break;
        }
    }

    navegarSugestoes(sugestoes, atual, direcao) {
        let index = Array.from(sugestoes).indexOf(atual);

        if (index === -1) index = direcao > 0 ? -1 : sugestoes.length;

        index = (index + direcao + sugestoes.length) % sugestoes.length;

        sugestoes.forEach(s => s.classList.remove('active'));
        sugestoes[index].classList.add('active');
    }

    selecionarEmpresa(sigla, nome) {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.value = `${sigla} - ${nome}`;
            empresaInput.dataset.siglaSelecionada = sigla;
            empresaInput.dataset.nomeSelecionado = nome;
        }

        this.ocultarSugestoes();

        this.sincronizarTrocaEmpresa(sigla, empresaInput.dataset.siglaAnterior);

        empresaInput.dataset.siglaAnterior = sigla;
    }

    /**
     * CALCULAR N√öMERO DO CLIENTE FINAL PARA NOVA EMPRESA
     */
    calcularNumeroClienteFinal(sigla, obraId = null) {
        try {
            console.log(`üî¢ [EMPRESA] Calculando n√∫mero para empresa: ${sigla}, obra: ${obraId}`);

            if (!sigla) {
                console.log('‚ùå [EMPRESA] Sigla n√£o fornecida');
                return 0;
            }

            // üî• Buscar obras da empresa espec√≠fica
            const obrasDaEmpresa = this.obrasExistentes.filter(obra => {
                return obra.empresaSigla === sigla ||
                    obra.empresa_id === sigla;
            });

            console.log(`üìä [EMPRESA] Encontradas ${obrasDaEmpresa.length} obras para ${sigla}`);

            let maiorNumero = 0;
            obrasDaEmpresa.forEach(obra => {
                if (obra.numeroClienteFinal) {
                    const numero = parseInt(obra.numeroClienteFinal);
                    if (!isNaN(numero) && numero > maiorNumero) {
                        maiorNumero = numero;
                    }
                }
            });

            const novoNumero = maiorNumero + 1;

            // üî• Atualizar campo no DOM se tiver obraId
            if (obraId) {
                this.atualizarCampoNumeroCliente(obraId, novoNumero);
            }

            return novoNumero;

        } catch (error) {
            console.error('‚ùå [EMPRESA] Erro ao calcular n√∫mero do cliente final:', error);
            return 0;
        }
    }

    // üî• NOVO M√âTODO PARA ATUALIZAR O CAMPO
    atualizarCampoNumeroCliente(obraId, numero) {
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) return;

        // üî• REMOVER readonly (CR√çTICO)
        const numeroInput = obraElement.querySelector('.numero-cliente-final-cadastro');
        if (numeroInput) {
            numeroInput.readOnly = false;
            numeroInput.removeAttribute('readonly');
            numeroInput.value = numero;
            console.log(`‚úÖ [EMPRESA] Campo n√∫mero atualizado: ${numero} (edit√°vel)`);
        }
    }

    atualizarNumeroClienteVisivel(sigla, numero) {
        const obraElement = this.container.closest('.obra-block');
        if (!obraElement) return;

        const numeroClienteInput = obraElement.querySelector('.numero-cliente-final-readonly');

        if (numeroClienteInput) {
            numeroClienteInput.value = numero;
            numeroClienteInput.setAttribute('data-sigla-empresa', sigla);

            obraElement.dataset.numeroClienteFinal = numero;
            obraElement.dataset.empresaSigla = sigla;
        }
    }

    sincronizarTrocaEmpresa(novaSigla, siglaAnterior = null) {
        try {
            const obraElement = this.container?.closest('.obra-block');
            if (!obraElement) return;

            this.calcularNumeroClienteFinal(novaSigla);

            console.log(`üîÑ Empresa alterada de ${siglaAnterior || 'nenhuma'} para ${novaSigla}`);

        } catch (error) {
            console.error('‚ùå Erro ao sincronizar troca de empresa:', error);
        }
    }

    observarMudancasEmpresa() {
        const empresaInput = this.container?.querySelector('#empresa-input');
        if (!empresaInput) return;

        let valorAnterior = empresaInput.value;

        empresaInput.addEventListener('input', () => {
            const valorAtual = empresaInput.value;

            if (!valorAtual.trim() && valorAnterior.trim()) {
                this.limparDadosEmpresa();
            }

            valorAnterior = valorAtual;
        });

        empresaInput.addEventListener('blur', () => {
            if (!empresaInput.value.trim() && empresaInput.dataset.siglaSelecionada) {
                this.removerEmpresaSelecionada();
            }
        });
    }

    limparDadosEmpresa() {
        const obraElement = this.container?.closest('.obra-block');
        if (!obraElement) return;

        this.resetarNumeroClienteVisivel(obraElement);
        this.limparDadosTemporarios(obraElement);

        const headerSpacer = obraElement.querySelector('.obra-header-spacer span');
        if (headerSpacer) {
            this.resetHeaderObra(headerSpacer);
        }

        this.restaurarTituloOriginal(obraElement);
    }

    removerEmpresaSelecionada() {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            delete empresaInput.dataset.siglaSelecionada;
            delete empresaInput.dataset.nomeSelecionado;
            delete empresaInput.dataset.siglaAnterior;
        }

        this.limparDadosEmpresa();
    }

    inicializarCampoNumeroCliente(obraElement) {
        const numeroClienteInput = obraElement.querySelector('.numero-cliente-final-readonly');

        if (numeroClienteInput) {
            const empresaSigla = obraElement.dataset.empresaSigla;

            if (empresaSigla) {
                this.calcularNumeroClienteFinal(empresaSigla);
            } else {
                numeroClienteInput.value = '';
                numeroClienteInput.placeholder = 'Selecione uma empresa';
            }

            numeroClienteInput.readOnly = true;
        }
    }

    atualizarHeaderObra(obraElement, dadosEmpresa) {
        try {
            const headerSpacer = obraElement.querySelector('.obra-header-spacer');
            if (!headerSpacer) {
                console.error('‚ùå Elemento .obra-header-spacer n√£o encontrado');
                return;
            }

            headerSpacer.innerHTML = '';

            if (dadosEmpresa.empresaSigla && dadosEmpresa.numeroClienteFinal) {
                const span = document.createElement('span');
                span.className = 'empresa-identifier-display';
                const textoHeader = `${dadosEmpresa.empresaSigla}-${dadosEmpresa.numeroClienteFinal}`;
                span.textContent = textoHeader;
                span.setAttribute('data-tooltip', this.criarTooltipEmpresa(dadosEmpresa));

                this.inicializarTooltipJavaScript(span);

                headerSpacer.appendChild(span);

                this.sincronizarTituloObra(obraElement, dadosEmpresa);

                console.log(`‚úÖ Header da obra atualizado: ${textoHeader}`);
            } else {
                this.resetHeaderObra(headerSpacer);
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar header da obra:', error);
        }
    }

    sincronizarTituloObra(obraElement, dadosEmpresa) {
        try {
            const tituloElement = obraElement.querySelector('.obra-title');

            if (!tituloElement) {
                console.warn('‚ö†Ô∏è Elemento .obra-title n√£o encontrado na obra');
                return;
            }

            const identificadorObra = `${dadosEmpresa.empresaSigla}-${dadosEmpresa.numeroClienteFinal}`;

            // APENAS [SIGLA-NUMERO] - conforme solicitado
            tituloElement.textContent = identificadorObra;

            if (tituloElement.hasAttribute('data-editable-content')) {
                tituloElement.setAttribute('data-editable-content', identificadorObra);
            }

            this.dispararEventoTituloAtualizado(obraElement, identificadorObra, identificadorObra);

            console.log(`‚úÖ T√≠tulo da obra sincronizado: ${identificadorObra}`);

        } catch (error) {
            console.error('‚ùå Erro ao sincronizar t√≠tulo da obra:', error);
        }
    }

    restaurarTituloOriginal(obraElement) {
        const tituloElement = obraElement.querySelector('.obra-title');
        if (!tituloElement) return;

        tituloElement.textContent = 'Nova Obra';

        if (tituloElement.hasAttribute('data-editable-content')) {
            tituloElement.setAttribute('data-editable-content', 'Nova Obra');
        }
    }

    dispararEventoTituloAtualizado(obraElement, novoTitulo, identificadorObra) {
        const evento = new CustomEvent('obra:titulo-atualizado', {
            bubbles: true,
            detail: {
                obraElement: obraElement,
                tituloCompleto: novoTitulo,
                identificadorObra: identificadorObra,
                timestamp: new Date().toISOString()
            }
        });

        obraElement.dispatchEvent(evento);
    }

    criarTooltipEmpresa(dadosEmpresa) {
        const partes = [];

        if (dadosEmpresa.empresaNome) {
            partes.push(`Empresa: ${dadosEmpresa.empresaNome}`);
        }
        if (dadosEmpresa.clienteFinal) {
            partes.push(`Cliente: ${dadosEmpresa.clienteFinal}`);
        }
        if (dadosEmpresa.codigoCliente) {
            partes.push(`C√≥digo: ${dadosEmpresa.codigoCliente}`);
        }
        if (dadosEmpresa.dataCadastro) {
            const dataFormatada = this.formatarDataParaTooltip(dadosEmpresa.dataCadastro);
            partes.push(`Data: ${dataFormatada}`);
        }
        if (dadosEmpresa.orcamentistaResponsavel) {
            partes.push(`Or√ßamentista: ${dadosEmpresa.orcamentistaResponsavel}`);
        }

        return partes.join('\n');
    }

    formatarDataParaTooltip(dataString) {
        if (!dataString) return '';

        try {
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }

            const data = new Date(dataString);

            if (isNaN(data.getTime())) {
                return dataString;
            }

            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();

            return `${dia}/${mes}/${ano}`;

        } catch (error) {
            return dataString;
        }
    }

    resetHeaderObra(headerSpacer) {
        headerSpacer.innerHTML = '';
    }


    prepararDadosObra(dados) {
        const obraBlock = this.container.closest('.obra-block');
        if (obraBlock) {
            obraBlock.dataset.empresaSigla = dados.sigla;
            obraBlock.dataset.empresaNome = dados.nomeEmpresa;
            obraBlock.dataset.numeroClienteFinal = dados.numeroClienteFinal;
            obraBlock.dataset.clienteFinal = dados.clienteFinal;
            obraBlock.dataset.codigoCliente = dados.codigoCliente;

            const dataFormatada = this.formatarData(dados.dataCadastro);
            obraBlock.dataset.dataCadastro = dataFormatada;

            obraBlock.dataset.orcamentistaResponsavel = dados.orcamentistaResponsavel;
            obraBlock.dataset.idGerado = `obra_${dados.sigla}_${dados.numeroClienteFinal}`;
            obraBlock.dataset.identificadorObra = `${dados.sigla}-${dados.numeroClienteFinal}`;

            this.atualizarHeaderObra(obraBlock, {
                empresaSigla: dados.sigla,
                empresaNome: dados.nomeEmpresa,
                numeroClienteFinal: dados.numeroClienteFinal,
                clienteFinal: dados.clienteFinal,
                codigoCliente: dados.codigoCliente,
                dataCadastro: dataFormatada,
                orcamentistaResponsavel: dados.orcamentistaResponsavel
            });
        }
    }

    async prepararDados() {
        const dados = this.coletarDadosFormulario();

        if (!this.validarDados(dados)) {
            return;
        }

        if (!dados.empresaExistente) {
            const sucesso = await this.cadastrarNovaEmpresa(dados.sigla, dados.nomeEmpresa);
            if (!sucesso) return;
        }

        this.prepararDadosObra(dados);

        showSystemStatus('Dados da empresa preparados! Agora salve a obra.', 'success');

        this.ocultarFormulario();
    }

    coletarDadosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        const siglaSelecionada = empresaInput?.dataset.siglaSelecionada;
        const nomeSelecionado = empresaInput?.dataset.nomeSelecionado;

        return {
            empresaInput: empresaInput?.value || '',
            sigla: siglaSelecionada,
            nomeEmpresa: nomeSelecionado,
            empresaExistente: !!siglaSelecionada,
            numeroClienteFinal: this.container.querySelector('#numero-cliente-final')?.value || '',
            clienteFinal: this.container.querySelector('#cliente-final')?.value || '',
            codigoCliente: this.container.querySelector('#codigo-cliente')?.value || '',
            dataCadastro: this.container.querySelector('#data-cadastro')?.value || '',
            orcamentistaResponsavel: this.container.querySelector('#orcamentista-responsavel')?.value || ''
        };
    }

    validarDados(dados) {
        if (!dados.empresaInput.trim()) {
            showSystemStatus('Por favor, informe a empresa', 'error');
            return false;
        }

        if (!dados.empresaExistente) {
            const regexSigla = /^[A-Z]{2,6}$/;

            if (regexSigla.test(dados.empresaInput)) {
                const nomeCompleto = prompt(`Voc√™ digitou apenas a sigla "${dados.empresaInput}". Por favor, informe o nome completo da empresa:`);
                if (!nomeCompleto || !nomeCompleto.trim()) {
                    showSystemStatus('Nome completo da empresa √© obrigat√≥rio', 'error');
                    return false;
                }

                if (nomeCompleto.trim().length < 3) {
                    showSystemStatus('Nome da empresa deve ter pelo menos 3 caracteres', 'error');
                    return false;
                }

                dados.nomeEmpresa = nomeCompleto.trim();
                dados.sigla = dados.empresaInput.toUpperCase();

            } else {
                const primeiraPalavra = dados.empresaInput.split(' ')[0];
                const siglaSugerida = primeiraPalavra.substring(0, 3).toUpperCase();

                let siglaConfirmada = prompt(`Empresa n√£o encontrada. Sugerimos a sigla "${siglaSugerida}". Confirme ou digite outra sigla (2-6 letras mai√∫sculas):`, siglaSugerida);

                if (!siglaConfirmada) {
                    showSystemStatus('Sigla √© obrigat√≥ria', 'error');
                    return false;
                }

                siglaConfirmada = siglaConfirmada.trim().toUpperCase().replace(/[^A-Z]/g, '');

                if (!regexSigla.test(siglaConfirmada)) {
                    showSystemStatus('Sigla deve conter 2 a 6 letras mai√∫sculas, sem espa√ßos ou caracteres especiais', 'error');
                    return false;
                }

                dados.sigla = siglaConfirmada;
                dados.nomeEmpresa = dados.empresaInput;
            }
        }

        return true;
    }

    async cadastrarNovaEmpresa(sigla, nome) {
        try {
            const siglaExistente = this.empresas.find(empresaObj => {
                const [siglaExistente] = Object.keys(empresaObj);
                return siglaExistente === sigla;
            });

            if (siglaExistente) {
                showSystemStatus(`Sigla ${sigla} j√° est√° em uso. Escolha outra sigla.`, 'error');
                return false;
            }

            const novaEmpresa = { [sigla]: nome };
            this.empresas.push(novaEmpresa);

            const response = await fetch('/api/dados/empresas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(novaEmpresa)
            });

            if (!response.ok) {
                throw new Error('Erro ao salvar empresa');
            }

            showSystemStatus(`Empresa ${sigla} - ${nome} cadastrada com sucesso!`, 'success');
            return true;

        } catch (error) {
            console.error('‚ùå Erro ao cadastrar nova empresa:', error);
            showSystemStatus('Erro ao cadastrar empresa', 'error');
            return false;
        }
    }

    /**
     * üî• CORRE√á√ÉO COMPLETA: CANCELAR CADASTRO
     */
    cancelarCadastro() {
        try {
            const obraBlock = this.container?.closest('.obra-block');

            if (obraBlock) {
                // üî• 1. PRIMEIRO: Limpar campos readonly usando setAttribute
                const camposReadonly = obraBlock.querySelectorAll('input[readonly], input:disabled');
                camposReadonly.forEach(campo => {
                    campo.setAttribute('value', '');
                    campo.value = '';

                    // Restaurar placeholder espec√≠fico
                    if (campo.classList.contains('numero-cliente-final-readonly')) {
                        campo.setAttribute('placeholder', 'N√∫mero do cliente');
                    }
                });

                // üî• 2. SEGUNDO: Limpar campos edit√°veis
                const camposEditaveis = obraBlock.querySelectorAll('input:not([readonly]):not(:disabled)');
                camposEditaveis.forEach(campo => {
                    campo.value = '';

                    // Restaurar placeholders espec√≠ficos
                    if (campo.classList.contains('empresa-input-cadastro') ||
                        campo.classList.contains('empresa-input')) {
                        campo.placeholder = 'Digite sigla ou nome...';
                    }
                });

                // üî• 3. REMOVER VALOR HARDCODED do HTML (se existir)
                const empresaInputs = obraBlock.querySelectorAll('.empresa-input-cadastro, .empresa-input');
                empresaInputs.forEach(input => {
                    // Remove atributo value completamente
                    input.removeAttribute('value');
                    // Limpa data attributes do autocomplete
                    delete input.dataset.siglaSelecionada;
                    delete input.dataset.nomeSelecionado;
                });

                // üî• 4. Limpar dados da obra
                this.limparDadosTemporarios(obraBlock);

                const tinhaDadosEmpresa = obraBlock.dataset.empresaSigla;

                if (tinhaDadosEmpresa) {
                    this.restaurarTituloOriginal(obraBlock);
                }
            }

            // üî• 5. Ocultar formul√°rio e mostrar bot√£o
            this.ocultarFormulario();
            this.mostrarSpanOriginal();

            if (this.container) {
                const spanOriginal = this.container.querySelector('span');
                if (spanOriginal) {
                    spanOriginal.textContent = '+ Cadastrar Empresa';
                }
            }

            console.log('‚úÖ Cadastro cancelado - todos os campos limpos');

        } catch (error) {
            console.error('‚ùå Erro ao cancelar cadastro:', error);
        }
    }

    // üî• NOVA FUN√á√ÉO: Resetar todos os campos da empresa
    resetarTodosCamposEmpresa(obraElement) {
        // Lista de todos os campos de empresa poss√≠veis
        const camposEmpresa = [
            '.empresa-input-cadastro',
            '.empresa-input',
            '.numero-cliente-final-cadastro',
            '.numero-cliente-final-readonly',
            '.cliente-final-cadastro',
            '.cliente-final-input',
            '.codigo-cliente-cadastro',
            '.codigo-cliente-input',
            '.data-cadastro-cadastro',
            '.data-cadastro-input',
            '.orcamentista-responsavel-cadastro',
            '.orcamentista-responsavel-input'
        ];

        camposEmpresa.forEach(selector => {
            const campo = obraElement.querySelector(selector);
            if (campo) {
                // üî• CORRE√á√ÉO: Para campos readonly, usar setAttribute
                if (campo.readOnly || campo.disabled) {
                    campo.setAttribute('value', '');
                    campo.value = '';

                    // Restaurar placeholder se existir
                    if (campo.classList.contains('numero-cliente-final-readonly')) {
                        campo.setAttribute('placeholder', 'N√∫mero do cliente');
                    }
                } else {
                    campo.value = '';
                }

                // Limpar data attributes espec√≠ficos
                if (campo.dataset.siglaSelecionada) {
                    delete campo.dataset.siglaSelecionada;
                }
                if (campo.dataset.nomeSelecionado) {
                    delete campo.dataset.nomeSelecionado;
                }

                console.log(`üîÑ Campo ${selector} limpo`);
            }
        });

        // Resetar campo espec√≠fico de n√∫mero do cliente
        this.resetarNumeroClienteVisivel(obraElement);
    }

    // üî• ATUALIZAR: resetarNumeroClienteVisivel
    resetarNumeroClienteVisivel(obraElement) {
        const numeroClienteInput = obraElement.querySelector('.numero-cliente-final-readonly');

        if (numeroClienteInput) {
            // üî• CORRE√á√ÉO: Para readonly, usar setAttribute
            numeroClienteInput.setAttribute('value', '');
            numeroClienteInput.value = '';
            numeroClienteInput.setAttribute('placeholder', 'N√∫mero do cliente');
            console.log('üîÑ N√∫mero do cliente resetado (readonly)');
        }

        const formNumeroInput = this.container?.querySelector('#numero-cliente-final');
        if (formNumeroInput) {
            formNumeroInput.value = '';
            formNumeroInput.placeholder = 'Ser√° calculado automaticamente';
        }
    }

    limparDadosTemporarios(obraElement) {
        const camposParaLimpar = [
            'empresaSigla',
            'empresaNome',
            'numeroClienteFinal',
            'identificadorObra',
            'clienteFinal',
            'codigoCliente',
            'dataCadastro',
            'orcamentistaResponsavel',
            'idGerado'
        ];

        camposParaLimpar.forEach(campo => {
            delete obraElement.dataset[campo];
        });
    }

    ocultarFormulario() {
        const form = this.container.querySelector('#empresa-cadastro-inline');
        if (form) {
            form.remove();
        }
        this.isActive = false;
    }

    mostrarSpanOriginal() {
        const span = this.container.querySelector('span');
        if (span) {
            span.style.display = 'inline';
        }
    }

    obterDadosPreparados(obraId) {
        const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraBlock) return null;

        return {
            empresaSigla: obraBlock.dataset.empresaSigla,
            empresaNome: obraBlock.dataset.empresaNome,
            numeroClienteFinal: obraBlock.dataset.numeroClienteFinal ? parseInt(obraBlock.dataset.numeroClienteFinal) : null,
            clienteFinal: obraBlock.dataset.clienteFinal,
            codigoCliente: obraBlock.dataset.codigoCliente,
            dataCadastro: obraBlock.dataset.dataCadastro,
            orcamentistaResponsavel: obraBlock.dataset.orcamentistaResponsavel,
            idGerado: obraBlock.dataset.idGerado
        };
    }

    formatarData(dataString) {
        if (!dataString) return '';

        try {
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }

            const data = new Date(dataString);

            if (isNaN(data.getTime())) {
                return dataString;
            }

            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();

            return `${dia}/${mes}/${ano}`;

        } catch (error) {
            return dataString;
        }
    }

    inicializarTooltipJavaScript(element) {
        const isMobile = window.innerWidth <= 768;
        let autoCloseTimer = null;

        element.style.position = 'relative';
        element.style.overflow = 'visible';
        element.style.zIndex = '100';

        const tooltip = document.createElement('div');
        tooltip.className = 'empresa-tooltip';

        if (isMobile) {
            tooltip.classList.add('empresa-tooltip-mobile');

            const closeButton = document.createElement('button');
            closeButton.className = 'empresa-tooltip-close';
            closeButton.innerHTML = '√ó';
            closeButton.setAttribute('aria-label', 'Fechar tooltip');
            tooltip.appendChild(closeButton);

            closeButton.addEventListener('click', (e) => {
                e.stopPropagation();
                esconderTooltip();
            });
        }

        document.body.appendChild(tooltip);

        const iniciarAutoCloseTimer = () => {
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
            }
            autoCloseTimer = setTimeout(() => {
                esconderTooltip();
            }, 5000);
        };

        const cancelarAutoCloseTimer = () => {
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
                autoCloseTimer = null;
            }
        };

        const atualizarPosicaoTooltip = () => {
            const rect = element.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const isMobileNow = window.innerWidth <= 768;

            if (isMobileNow) {
                tooltip.style.position = 'fixed';
                tooltip.style.left = '50%';
                tooltip.style.top = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                tooltip.style.bottom = 'auto';
                tooltip.style.right = 'auto';
                tooltip.style.width = '90vw';
                tooltip.style.maxWidth = '320px';
                tooltip.style.maxHeight = '70vh';
                tooltip.style.overflowY = 'auto';
                tooltip.style.zIndex = '100000';
            } else {
                tooltip.style.position = 'fixed';
                tooltip.style.left = (rect.left + scrollX + (rect.width / 2)) + 'px';
                tooltip.style.bottom = (window.innerHeight - rect.top - scrollY + 8) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.width = 'auto';
                tooltip.style.maxWidth = '380px';
                tooltip.style.maxHeight = 'none';
            }
        };

        const mostrarTooltip = () => {
            const tooltipText = element.getAttribute('data-tooltip');
            if (tooltipText) {
                const closeBtn = tooltip.querySelector('.empresa-tooltip-close');
                tooltip.innerHTML = tooltipText;
                if (closeBtn && isMobile) {
                    tooltip.appendChild(closeBtn);
                }

                tooltip.classList.add('show');
                atualizarPosicaoTooltip();

                if (isMobile) {
                    iniciarAutoCloseTimer();
                }
            }
        };

        const esconderTooltip = () => {
            tooltip.classList.remove('show');
            cancelarAutoCloseTimer();
        };

        if (isMobile) {
            element.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (tooltip.classList.contains('show')) {
                    esconderTooltip();
                } else {
                    mostrarTooltip();
                }
            });

            document.addEventListener('click', (e) => {
                if (!element.contains(e.target) && !tooltip.contains(e.target)) {
                    esconderTooltip();
                }
            });

            window.addEventListener('scroll', esconderTooltip);
            window.addEventListener('orientationchange', esconderTooltip);

        } else {
            element.addEventListener('mouseenter', mostrarTooltip);
            element.addEventListener('mouseleave', esconderTooltip);
        }

        if (isMobile) {
            tooltip.addEventListener('touchstart', () => {
                cancelarAutoCloseTimer();
                iniciarAutoCloseTimer();
            });

            tooltip.addEventListener('click', () => {
                cancelarAutoCloseTimer();
                iniciarAutoCloseTimer();
            });
        }

        window.addEventListener('scroll', () => {
            if (tooltip.classList.contains('show')) {
                atualizarPosicaoTooltip();
            }
        });

        window.addEventListener('resize', () => {
            if (tooltip.classList.contains('show')) {
                atualizarPosicaoTooltip();
            }

            const novaCondicaoMobile = window.innerWidth <= 768;
            if (isMobile !== novaCondicaoMobile) {
                esconderTooltip();
                tooltip.remove();
                this.inicializarTooltipJavaScript(element);
            }
        });

        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.removedNodes.length > 0) {
                    const removed = Array.from(mutation.removedNodes);
                    if (removed.includes(element) || element.parentNode === null) {
                        tooltip.remove();
                        cancelarAutoCloseTimer();
                        window.removeEventListener('scroll', atualizarPosicaoTooltip);
                        window.removeEventListener('resize', atualizarPosicaoTooltip);
                        document.removeEventListener('click', esconderTooltip);
                        window.removeEventListener('orientationchange', esconderTooltip);
                        observer.disconnect();
                    }
                }
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    }
}

/* ==== SE√á√ÉO 3: FUN√á√ïES GLOBAIS (ex-obra-adapter.js) ==== */

/**
 * üÜï FUN√á√ÉO GLOBAL PARA EDITAR DADOS DA EMPRESA
 */
window.editarDadosEmpresa = function (button, obraId = null) {
    try {
        const visualizacao = button.closest('.empresa-dados-visualizacao');
        let obraBlock;

        if (obraId) {
            // Se recebeu obraId, buscar por ID
            obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        } else {
            // Buscar pelo DOM
            obraBlock = visualizacao.closest('.obra-block');
        }

        if (!obraBlock) {
            console.error('‚ùå [EMPRESA] Obra n√£o encontrada para edi√ß√£o');
            return;
        }

        // Remover visualiza√ß√£o se existir
        if (visualizacao) {
            visualizacao.remove();
        }

        // Mostrar span original para ativar cadastro
        const spanOriginal = obraBlock.querySelector('.projetc-header-record.very-dark span');
        if (spanOriginal) {
            spanOriginal.style.display = 'inline';

            // Simular clique para ativar cadastro
            if (window.empresaCadastro && typeof window.empresaCadastro.ativarCadastro === 'function') {
                const event = new Event('click');
                spanOriginal.dispatchEvent(event);
            } else {
                spanOriginal.click();
            }
        }

    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro ao editar dados da empresa:', error);
    }
};

/**
 * üÜï ATUALIZAR DADOS DA EMPRESA EM TEMPO REAL
 */
window.atualizarDadosEmpresa = function (input, campo, obraId) {
    try {
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra ${obraId} n√£o encontrada`);
            return;
        }

        // Atualizar data attribute
        obraElement.dataset[campo] = input.value;

        console.log(`üìù [EMPRESA] Campo ${campo} atualizado para:`, input.value);

        // Se for cliente final ou or√ßamentista, atualizar tooltip do header
        if (campo === 'clienteFinal' || campo === 'orcamentistaResponsavel') {
            if (window.empresaCadastro && typeof window.empresaCadastro.atualizarHeaderObra === 'function') {
                const dadosAtuais = obterDadosEmpresaDaObra(obraId);
                if (dadosAtuais) {
                    window.empresaCadastro.atualizarHeaderObra(obraElement, dadosAtuais);
                }
            }
        }

    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao atualizar campo ${campo}:`, error);
    }
};

/**
 * üÜï FUN√á√ÉO GLOBAL PARA ATIVAR CADASTRO DE EMPRESA - CORRIGIDA
 */
window.ativarCadastroEmpresa = function (obraId) {
    try {
        console.log(`üéØ [EMPRESA] Ativando cadastro para obra: ${obraId}`);

        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra ${obraId} n√£o encontrada`);
            return;
        }

        // Encontrar container de empresa
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (!empresaContainer) {
            console.error(`‚ùå [EMPRESA] Container de empresa n√£o encontrado`);
            return;
        }

        // ‚úÖ CORRE√á√ÉO: Verificar se j√° existe formul√°rio ativo
        const formularioExistente = empresaContainer.querySelector('.empresa-formulario-ativo');
        if (formularioExistente) {
            console.log(`‚úÖ [EMPRESA] Formul√°rio j√° est√° ativo para obra ${obraId}`);
            return; // ‚úÖ IMPEDE EXECU√á√ÉO DUPLICADA
        }

        // Ocultar bot√£o
        const botao = empresaContainer.querySelector('.btn-empresa-cadastro');
        if (botao) {
            botao.style.display = 'none';
        }

        // Verificar se h√° dados de empresa existentes
        const dadosEmpresa = obterDadosEmpresaDaObra(obraId);

        if (dadosEmpresa) {
            // Se j√° tem dados, criar formul√°rio com dados existentes
            console.log(`üìä [EMPRESA] Criando formul√°rio com dados existentes para obra ${obraId}`);
            // Fun√ß√£o ser√° importada de empresa-form-manager.js
            if (typeof criarVisualizacaoEmpresa === 'function') {
                criarVisualizacaoEmpresa({ ...dadosEmpresa, id: obraId }, empresaContainer);
            }
        } else {
            // Se n√£o tem dados, criar formul√°rio vazio para cadastro
            console.log(`üÜï [EMPRESA] Criando novo formul√°rio para obra ${obraId}`);
            // Fun√ß√£o ser√° importada de empresa-form-manager.js
            if (typeof criarFormularioVazioEmpresa === 'function') {
                criarFormularioVazioEmpresa(obraId, empresaContainer);
            }
        }

    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao ativar cadastro para obra ${obraId}:`, error);
    }
};

/**
 * üÜï OBT√âM DADOS DE EMPRESA DE UMA OBRA ESPEC√çFICA
 */
function obterDadosEmpresaDaObra(obraId) {
    try {
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra com ID ${obraId} n√£o encontrada`);
            return null;
        }

        const camposEmpresa = [
            'empresaSigla', 'empresaNome', 'numeroClienteFinal',
            'clienteFinal', 'codigoCliente', 'dataCadastro',
            'orcamentistaResponsavel', 'idGerado', 'empresa_id'
        ];

        const dadosEmpresa = {};
        let temDados = false;

        camposEmpresa.forEach(campo => {
            if (obraElement.dataset[campo]) {
                dadosEmpresa[campo] = obraElement.dataset[campo];
                temDados = true;
            }
        });

        if (temDados) {
            console.log(`‚úÖ [EMPRESA] Dados recuperados para obra ${obraId}:`, dadosEmpresa);
        } else {
            console.log(`üì≠ [EMPRESA] Nenhum dado de empresa encontrado para obra ${obraId}`);
        }

        return temDados ? dadosEmpresa : null;

    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao obter dados de empresa:`, error);
        return null;
    }
}


/**
 * Atualizar texto do bot√£o de cadastro de empresa
 */
function atualizarTextoBotaoEmpresa(obraId, texto = "Visualizar campos de cadastro de empresas") {
    const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraElement) return false;

    const botao = obraElement.querySelector('.btn-empresa-cadastro');
    if (botao) {
        botao.textContent = texto;
        return true;
    }

    return false;
}

/**
 * FUN√á√ÉO PARA ATUALIZAR TODOS OS BOT√ïES DE EMPRESA (para obras existentes)
 */
function atualizarTodosBotoesEmpresa() {
    const botoes = document.querySelectorAll('.btn-empresa-cadastro');
    let atualizados = 0;

    botoes.forEach(botao => {
        const textoAtual = botao.textContent.trim();
        if (textoAtual === "Adicionar campos de cadastro de empresas") {
            botao.textContent = "Visualizar campos de cadastro de empresas";
            atualizados++;
        }
    });

    return atualizados;
}


/* ==== SE√á√ÉO 4: INICIALIZA√á√ÉO DO SISTEMA ==== */

/**
 * INICIALIZAR SISTEMA DE EMPRESA
 */
function inicializarSistemaEmpresa() {
    console.log('üè¢ [EMPRESA] Inicializando sistema de empresa...');

    try {
        // Criar inst√¢ncia global da classe
        window.empresaCadastro = new EmpresaCadastroInline();

        // Configurar evento de DOMContentLoaded se necess√°rio
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('‚úÖ [EMPRESA] Sistema de empresa inicializado ap√≥s DOM carregado');
            });
        } else {
            console.log('‚úÖ [EMPRESA] Sistema de empresa inicializado');
        }

        return true;
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro ao inicializar sistema:', error);
        return false;
    }
}

export {
    carregarEmpresasComCache,
    limparCacheEmpresas,
    obterDadosEmpresaDaObra,
    atualizarTextoBotaoEmpresa,
    atualizarTodosBotoesEmpresa,
    inicializarSistemaEmpresa,

}

// Compatibilidade global
if (typeof window !== 'undefined') {
    window.carregarEmpresasComCache = carregarEmpresasComCache;
    window.limparCacheEmpresas = limparCacheEmpresas;
    window.obterDadosEmpresaDaObra = obterDadosEmpresaDaObra;
    window.atualizarTextoBotaoEmpresa = atualizarTextoBotaoEmpresa;
    window.atualizarTodosBotoesEmpresa = atualizarTodosBotoesEmpresa;
    window.inicializarSistemaEmpresa = inicializarSistemaEmpresa
}
/* ==== FIM: empresa-core.js ==== */

/* ==== IN√çCIO: empresa-data-extractor.js ==== */
// empresa-data-extractor.js
/**
 * üìä EMPRESA-DATA-EXTRACTOR.JS - Extra√ß√£o e Processamento de Dados de Empresa
 * ‚úÖ Responsabilidade: Extrair dados do DOM, preparar para salvamento, c√°lculos
 * ‚úÖ Arquivo 4 de 5 na refatora√ß√£o do sistema de empresa
 */

import { calcularNumeroLocal } from './empresa-ui-helpers.js';

/* ==== SE√á√ÉO 1: EXTRA√á√ÉO DE DADOS DO DOM ==== */

/**
 * Extrai dados de empresa cadastrados inline
 */
function extractEmpresaData(obraElement) {
    const empresaData = {};
    
    if (!obraElement) {
        console.error('‚ùå Elemento da obra √© nulo para extra√ß√£o de empresa');
        return empresaData;
    }

    console.log('üîç [EXTRACT EMPRESA] INICIANDO extra√ß√£o para obra:', obraElement.dataset.obraId);

    const camposEmpresa = [
        'empresaSigla', 'empresaNome', 'numeroClienteFinal', 
        'clienteFinal', 'codigoCliente', 'dataCadastro', 
        'orcamentistaResponsavel', 'idGerado'
    ];

    console.log('üîç [EXTRACT EMPRESA] FASE 1 - Buscando nos INPUTS ATUAIS do formul√°rio...');
    
    const formEmpresa = obraElement.querySelector('.empresa-formulario-ativo');
    if (formEmpresa) {
        console.log('üìã [EXTRACT EMPRESA] Formul√°rio ativo encontrado, extraindo dados atuais...');
        
        // üÜï PRIORIDADE 1: Buscar dados do autocomplete (s√£o os mais confi√°veis)
        const empresaInput = formEmpresa.querySelector('.empresa-input-cadastro');
        if (empresaInput && empresaInput.dataset.siglaSelecionada) {
            console.log('üéØ [EXTRACT EMPRESA] Dados do autocomplete encontrados:', {
                sigla: empresaInput.dataset.siglaSelecionada,
                nome: empresaInput.dataset.nomeSelecionado
            });
            
            empresaData.empresaSigla = empresaInput.dataset.siglaSelecionada;
            empresaData.empresaNome = empresaInput.dataset.nomeSelecionado || '';
        }
        
        // üÜï PRIORIDADE 2: Buscar nos campos de empresa (caso autocomplete n√£o tenha dados)
        if (!empresaData.empresaSigla || !empresaData.empresaNome) {
            console.log('üîç [EXTRACT EMPRESA] Buscando em campos de input...');
            
            // Buscar em todos os campos de empresa poss√≠veis
            const empresaInputs = [
                ...formEmpresa.querySelectorAll('.empresa-input-cadastro, .empresa-input-readonly')
            ];
            
            for (const input of empresaInputs) {
                if (input && input.value && input.value.trim() !== '') {
                    const valor = input.value.trim();
                    console.log(`üè¢ [EXTRACT EMPRESA] Campo empresa encontrado: "${valor}"`);
                    
                    // Verificar se est√° no formato "SIGLA - Nome"
                    if (valor.includes(' - ')) {
                        const partes = valor.split(' - ');
                        if (!empresaData.empresaSigla) empresaData.empresaSigla = partes[0].trim();
                        if (!empresaData.empresaNome) empresaData.empresaNome = partes.slice(1).join(' - ').trim();
                        console.log(`‚úÖ [EXTRACT EMPRESA] Empresa extra√≠da do formato combinado: ${empresaData.empresaSigla} - ${empresaData.empresaNome}`);
                    } else {
                        // Se n√£o tem h√≠fen, verificar se √© sigla ou nome
                        if (!empresaData.empresaSigla && valor.length <= 10) {
                            // Se for curto, assume que √© sigla
                            empresaData.empresaSigla = valor;
                            console.log(`üè¢ [EXTRACT EMPRESA] Sigla identificada: ${empresaData.empresaSigla}`);
                        } else if (!empresaData.empresaNome) {
                            // Se for mais longo, assume que √© nome
                            empresaData.empresaNome = valor;
                            console.log(`üè¢ [EXTRACT EMPRESA] Nome identificado: ${empresaData.empresaNome}`);
                        }
                    }
                    break;
                }
            }
        }

        // üÜï BUSCAR CAMPOS SEPARADOS ESPEC√çFICOS (se existirem campos dedicados)
        console.log('üîç [EXTRACT EMPRESA] Buscando campos espec√≠ficos...');
        
        // Mapeamento dos outros campos
        const mapeamentoCampos = {
            // Campos de empresa separados (caso existam)
            'empresa-sigla-input': ['empresaSigla'],
            'empresa-nome-input': ['empresaNome'],
            
            // Outros campos
            'numero-cliente-final-cadastro': ['numeroClienteFinal'], 
            'cliente-final-cadastro': ['clienteFinal'],
            'codigo-cliente-cadastro': ['codigoCliente'],
            'data-cadastro-cadastro': ['dataCadastro'],
            'orcamentista-responsavel-cadastro': ['orcamentistaResponsavel'],
            
            // Inputs de visualiza√ß√£o/readonly
            'numero-cliente-final-readonly': ['numeroClienteFinal'],
            'cliente-final-input': ['clienteFinal'],
            'codigo-cliente-input': ['codigoCliente'], 
            'data-cadastro-readonly': ['dataCadastro'],
            'orcamentista-responsavel-input': ['orcamentistaResponsavel']
        };

        Object.entries(mapeamentoCampos).forEach(([inputClass, camposAlvo]) => {
            const input = formEmpresa.querySelector(`.${inputClass}`);
            
            if (input && input.value && input.value.trim() !== '') {
                let valor = input.value.trim();
                console.log(`‚úÖ [EXTRACT EMPRESA] Input ${inputClass} encontrado: "${valor}"`);
                
                camposAlvo.forEach(campo => {
                    if (!empresaData[campo]) { // S√≥ preenche se ainda n√£o tem valor
                        if (campo === 'numeroClienteFinal') {
                            empresaData[campo] = parseInt(valor) || 0;
                            console.log(`üî¢ [EXTRACT EMPRESA] ${campo} convertido para n√∫mero: ${empresaData[campo]}`);
                        } else if (campo === 'empresaSigla' && valor.includes(' - ')) {
                            // Extrair s√≥ a sigla do formato "SIGLA - Nome"
                            const partes = valor.split(' - ');
                            empresaData.empresaSigla = partes[0].trim();
                            console.log(`üè¢ [EXTRACT EMPRESA] Sigla extra√≠da de campo combinado: ${empresaData.empresaSigla}`);
                        } else if (campo === 'empresaNome' && valor.includes(' - ')) {
                            // Extrair s√≥ o nome do formato "SIGLA - Nome"
                            const partes = valor.split(' - ');
                            empresaData.empresaNome = partes.slice(1).join(' - ').trim();
                            console.log(`üè¢ [EXTRACT EMPRESA] Nome extra√≠do de campo combinado: ${empresaData.empresaNome}`);
                        } else {
                            empresaData[campo] = valor;
                        }
                    }
                });
            }
        });
    } else {
        console.log('‚ùå [EXTRACT EMPRESA] Formul√°rio ativo n√£o encontrado');
    }

    // üÜï FASE 2: Buscar nos data attributes os campos que ainda est√£o faltando
    console.log('üîç [EXTRACT EMPRESA] FASE 2 - Buscando campos faltantes nos data attributes...');
    
    const camposFaltantes = camposEmpresa.filter(campo => !empresaData[campo]);
    console.log(`üìã [EXTRACT EMPRESA] Campos ainda faltantes: ${camposFaltantes.join(', ')}`);
    
    camposFaltantes.forEach(campo => {
        const valorDataAttr = obraElement.dataset[campo];
        if (valorDataAttr !== undefined && valorDataAttr !== null && valorDataAttr !== '') {
            console.log(`üì¶ [EXTRACT EMPRESA] Data-attribute ${campo}: "${valorDataAttr}"`);
            
            if (campo === 'numeroClienteFinal') {
                empresaData[campo] = parseInt(valorDataAttr) || 0;
            } else if (campo === 'empresaSigla') {
                // Extrair sigla do data-attribute
                if (valorDataAttr.includes(' - ')) {
                    const partes = valorDataAttr.split(' - ');
                    empresaData.empresaSigla = partes[0].trim();
                    console.log(`üè¢ [EXTRACT EMPRESA] Sigla extra√≠da do data-attribute combinado: ${empresaData.empresaSigla}`);
                    
                    // Se tamb√©m precisar do nome e n√£o tiver ainda
                    if (!empresaData.empresaNome && partes[1]) {
                        empresaData.empresaNome = partes.slice(1).join(' - ').trim();
                        console.log(`üè¢ [EXTRACT EMPRESA] Nome extra√≠do do data-attribute combinado: ${empresaData.empresaNome}`);
                    }
                } else {
                    empresaData.empresaSigla = valorDataAttr;
                }
            } else if (campo === 'empresaNome') {
                // Extrair nome do data-attribute
                if (valorDataAttr.includes(' - ')) {
                    const partes = valorDataAttr.split(' - ');
                    empresaData.empresaNome = partes.slice(1).join(' - ').trim();
                    console.log(`üè¢ [EXTRACT EMPRESA] Nome extra√≠do do data-attribute combinado: ${empresaData.empresaNome}`);
                    
                    // Se tamb√©m precisar da sigla e n√£o tiver ainda
                    if (!empresaData.empresaSigla && partes[0]) {
                        empresaData.empresaSigla = partes[0].trim();
                        console.log(`üè¢ [EXTRACT EMPRESA] Sigla extra√≠da do data-attribute combinado: ${empresaData.empresaSigla}`);
                    }
                } else {
                    empresaData.empresaNome = valorDataAttr;
                }
            } else {
                empresaData[campo] = valorDataAttr;
            }
        }
    });

    console.log('üîç [EXTRACT EMPRESA] FASE 3 - Valida√ß√£o final...');
    
    // VERIFICA√á√ÉO FINAL - garantir que temos pelo menos sigla ou nome
    if (!empresaData.empresaSigla && empresaData.empresaNome) {
        console.log('‚ö†Ô∏è [EXTRACT EMPRESA] Temos nome mas n√£o sigla');
    } else if (empresaData.empresaSigla && !empresaData.empresaNome) {
        console.log('‚ö†Ô∏è [EXTRACT EMPRESA] Temos sigla mas n√£o nome');
    } else if (empresaData.empresaSigla && empresaData.empresaNome) {
        console.log(`‚úÖ [EXTRACT EMPRESA] Empresa completa: ${empresaData.empresaSigla} - ${empresaData.empresaNome}`);
    } else {
        console.log('‚ùå [EXTRACT EMPRESA] Nenhum dado de empresa encontrado');
    }

    console.log('üè¢ [EXTRACT EMPRESA] DADOS FINAIS EXTRA√çDOS:', empresaData);
    
    // VERIFICA√á√ÉO CR√çTICA
    const statusCampos = {};
    camposEmpresa.forEach(campo => {
        statusCampos[campo] = empresaData[campo] !== undefined 
            ? `‚úÖ ${empresaData[campo]}` 
            : '‚ùå AUSENTE';
    });
    
    console.log('üìã [EXTRACT EMPRESA] STATUS FINAL:', statusCampos);
    
    return empresaData;
}

/* ==== SE√á√ÉO 2: PREPARA√á√ÉO DE DADOS PARA SALVAMENTO ==== */

/**
 * üÜï VERIFICA E PREPARA EMPRESA PARA SALVAMENTO (APENAS NA HORA DE SALVAR OBRA)
 * Detecta quando o usu√°rio digitou uma empresa n√£o cadastrada e a prepara para salvar junto com a obra
 */
async function prepararEmpresaParaSalvamento(obraElement) {
    try {
        console.log('üîç [EMPRESA] Verificando empresa para salvamento com obra...');
        
        // Buscar inputs de empresa
        const empresaInput = obraElement.querySelector('.empresa-input-cadastro, .empresa-input-readonly');
        const numeroInput = obraElement.querySelector('.numero-cliente-final-cadastro');
        
        if (!empresaInput || !empresaInput.value) {
            console.log('‚ùå [EMPRESA] Nenhuma empresa digitada');
            return false;
        }
        
        // Se j√° tem sigla selecionada (empresa j√° cadastrada), n√£o faz nada
        if (empresaInput.dataset.siglaSelecionada) {
            console.log('‚úÖ [EMPRESA] Empresa j√° cadastrada:', empresaInput.dataset.siglaSelecionada);
            return true;
        }
        
        const nomeEmpresa = empresaInput.value.trim();
        if (!nomeEmpresa) {
            console.log('‚ùå [EMPRESA] Nome da empresa vazio');
            return false;
        }
        
        console.log('üÜï [EMPRESA] Nova empresa detectada para salvar com obra:', nomeEmpresa);
        
        // Extrair sigla (primeiras 3 letras em mai√∫sculo)
        let sigla = nomeEmpresa.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, '');
        
        // Garantir que a sigla tenha pelo menos 2 caracteres
        if (sigla.length < 2) {
            sigla = nomeEmpresa.substring(0, 2).toUpperCase() + 'X';
        }
        if (sigla.length > 6) {
            sigla = sigla.substring(0, 6);
        }
        
        console.log(`üÜï [EMPRESA] Preparando empresa: ${sigla} - ${nomeEmpresa}`);
        
        // üÜï N√ÉO SALVA A EMPRESA AQUI - APENAS PREPARA OS DADOS
        // A empresa ser√° salva junto com a obra no processo normal
        
        // Atualizar a obra com os dados da nova empresa
        obraElement.dataset.empresaSigla = sigla;
        obraElement.dataset.empresaNome = nomeEmpresa;
        obraElement.dataset.numeroClienteFinal = '1'; // N√∫mero inicial para empresa nova
        
        // Atualizar inputs
        if (empresaInput) {
            empresaInput.value = `${sigla} - ${nomeEmpresa}`;
            empresaInput.dataset.siglaSelecionada = sigla;
            empresaInput.dataset.nomeSelecionado = nomeEmpresa;
        }
        
        if (numeroInput) {
            numeroInput.value = '1';
        }
        
        console.log(`‚úÖ [EMPRESA] Empresa preparada para salvamento: ${sigla} - ${nomeEmpresa}`);
        
        // Usar showSystemStatus se dispon√≠vel
        if (typeof window.showSystemStatus === 'function') {
            window.showSystemStatus(`Empresa ${sigla} preparada para salvar com a obra!`, 'success');
        }
        
        return true;
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro ao preparar empresa:', error);
        if (typeof window.showSystemStatus === 'function') {
            window.showSystemStatus('Erro ao preparar empresa para salvamento', 'error');
        }
        return false;
    }
}

/**
 * üÜï PREPARA DADOS DE EMPRESA NA OBRA CARREGADA - VERS√ÉO CORRIGIDA
 */
async function prepararDadosEmpresaNaObra(obraData, obraElement) {
    try {
        // Verificar se a obra tem dados de empresa
        const camposEmpresa = [
            'empresaSigla', 'empresaNome', 'numeroClienteFinal', 
            'clienteFinal', 'codigoCliente', 'dataCadastro', 
            'orcamentistaResponsavel', 'idGerado'
        ];
        
        // Log detalhado dos dados recebidos
        console.log('üè¢ [EMPRESA] Preparando dados para obra:', obraData.nome || obraData.id);
        console.log('üì¶ [EMPRESA] Dados dispon√≠veis:', {
            empresaSigla: obraData.empresaSigla,
            empresaNome: obraData.empresaNome,
            numeroClienteFinal: obraData.numeroClienteFinal,
            empresa_id: obraData.empresa_id // üî• IMPORTANTE: verificar este campo tamb√©m
        });
        
        // Verificar se temos dados de empresa
        const temDadosEmpresa = camposEmpresa.some(campo => 
            obraData[campo] && obraData[campo].trim() !== ''
        ) || (obraData.empresa_id && obraData.empresa_id.trim() !== '');
        
        if (!temDadosEmpresa) {
            console.log('üì≠ [EMPRESA] Obra n√£o possui dados de empresa identific√°veis');
            return;
        }
        
        console.log('‚úÖ [EMPRESA] Dados de empresa detectados, preparando...');
        
        // Mapear todos os campos poss√≠veis
        const mapeamentoCampos = {
            empresaSigla: obraData.empresaSigla,
            empresaNome: obraData.empresaNome,
            numeroClienteFinal: obraData.numeroClienteFinal,
            clienteFinal: obraData.clienteFinal,
            codigoCliente: obraData.codigoCliente,
            dataCadastro: obraData.dataCadastro,
            orcamentistaResponsavel: obraData.orcamentistaResponsavel,
            idGerado: obraData.idGerado,
            empresa_id: obraData.empresa_id // üî• Adicionar este campo
        };
        
        // Atribuir aos data attributes
        Object.entries(mapeamentoCampos).forEach(([campo, valor]) => {
            if (valor && valor.toString().trim() !== '') {
                const valorAntigo = obraElement.dataset[campo];
                obraElement.dataset[campo] = valor.toString().trim();
                console.log(`‚úÖ [EMPRESA] ${campo}: "${valorAntigo || 'vazio'}" ‚Üí "${valor}"`);
            }
        });
        
        // üî• CHAVE: Atualizar a interface COM OS DADOS DA OBRA
        // A fun√ß√£o ser√° importada de empresa-form-manager.js
        if (typeof window.atualizarInterfaceComEmpresa === 'function') {
            await window.atualizarInterfaceComEmpresa(obraElement, obraData);
        } else if (typeof atualizarInterfaceComEmpresa === 'function') {
            // Se estiver no escopo local (import direto)
            await atualizarInterfaceComEmpresa(obraElement, obraData);
        }
        
        console.log('‚úÖ [EMPRESA] Prepara√ß√£o conclu√≠da com sucesso');
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro ao preparar dados:', error);
    }
}

/* ==== SE√á√ÉO 3: C√ÅLCULO DE N√öMERO DO CLIENTE ==== */

/**
 * üÜï ATUALIZAR INPUT DO N√öMERO DO CLIENTE
 */
function atualizarNumeroClienteInput(numero, obraId) {
    const numeroInput = document.querySelector(`[data-obra-id="${obraId}"] .numero-cliente-final-cadastro`);
    if (numeroInput) {
        numeroInput.value = numero;
    }
}

/* ==== SE√á√ÉO 4: FUN√á√ïES AUXILIARES PARA DEBUG ==== */

/**
 * üî• FUN√á√ÉO AUXILIAR: For√ßar atualiza√ß√£o de empresa em uma obra espec√≠fica
 */
async function forcarAtualizacaoEmpresa(obraId) {
    try {
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [FOR√áAR EMPRESA] Obra ${obraId} n√£o encontrada`);
            return false;
        }
        
        // Obter dados atualizados do servidor
        const response = await fetch(`/obras/${obraId}`);
        if (!response.ok) {
            console.error(`‚ùå [FOR√áAR EMPRESA] Erro ao buscar obra ${obraId}`);
            return false;
        }
        
        const obraData = await response.json();
        
        // Atualizar dados da empresa
        await prepararDadosEmpresaNaObra(obraData, obraElement);
        
        console.log(`‚úÖ [FOR√áAR EMPRESA] Empresa atualizada para obra ${obraId}`);
        return true;
        
    } catch (error) {
        console.error(`‚ùå [FOR√áAR EMPRESA] Erro:`, error);
        return false;
    }
}

/**
 * Atualizar dados da empresa em todas as obras
 */
// REMO√á√ÉO POSSIVEL VERIFICAR DEPOIS
async function atualizarEmpresaEmTodasObras(empresaData) {
    const obras = document.querySelectorAll('.obra-block[data-obra-id]');

    for (const obraElement of obras) {
        try {
            const obraId = obraElement.dataset.obraId;

            if (typeof window.obterDadosEmpresaDaObra === 'function') {
                const dadosObra = window.obterDadosEmpresaDaObra(obraId);

                if (dadosObra && typeof window.prepararDadosEmpresaNaObra === 'function') {
                    await window.prepararDadosEmpresaNaObra(dadosObra, obraElement);
                }
            }
        } catch (error) {
            console.error(`‚ùå Erro ao atualizar empresa na obra ${obraId}:`, error);
        }
    }
}

/**
 * Fun√ß√£o para debug
 */
async function debugExtractEmpresaData() {
    console.log("üêõ [DEBUG] Testando extra√ß√£o de dados de empresa...");
    
    const obras = document.querySelectorAll('.obra-block');
    console.log(`üîç ${obras.length} obras encontradas no DOM`);
    
    obras.forEach((obra, index) => {
        const obraId = obra.dataset.obraId;
        console.log(`üì¶ Obra ${index + 1}: ${obraId}`);
        
        const dados = extractEmpresaData(obra);
        console.log(`üìä Dados extra√≠dos:`, dados);
    });
}

/* ==== SE√á√ÉO 5: EXPORTS E INICIALIZA√á√ÉO ==== */

export {
    extractEmpresaData,
    prepararEmpresaParaSalvamento,
    prepararDadosEmpresaNaObra,
    atualizarNumeroClienteInput,
    forcarAtualizacaoEmpresa,
    atualizarEmpresaEmTodasObras,
    debugExtractEmpresaData
}

// Compatibilidade global
if (typeof window !== 'undefined') {
    window.extractEmpresaData = extractEmpresaData;
    window.prepararEmpresaParaSalvamento = prepararEmpresaParaSalvamento;
    window.prepararDadosEmpresaNaObra = prepararDadosEmpresaNaObra;
    window.atualizarNumeroClienteInput = atualizarNumeroClienteInput;
    window.forcarAtualizacaoEmpresa = forcarAtualizacaoEmpresa;
    window.atualizarEmpresaEmTodasObras = atualizarEmpresaEmTodasObras;
    window.debugExtractEmpresaData = debugExtractEmpresaData;
}
console.log('‚úÖ empresa-data-extractor.js carregado com sucesso');
/* ==== FIM: empresa-data-extractor.js ==== */

/* ==== IN√çCIO: empresa-form-manager.js ==== */
// empresa-form-manager.js
/**
 * üìù EMPRESA-FORM-MANAGER.JS - Gerenciamento de Formul√°rios de Empresa
 * ‚úÖ Responsabilidade: Formul√°rios inline, datepicker, valida√ß√£o, campos de data
 * ‚úÖ Arquivo 3 de 5 na refatora√ß√£o do sistema de empresa
 */

import { EmpresaCadastroInline } from './empresa-core.js';
import { inicializarInputEmpresaHibrido } from './empresa-autocomplete.js';
import { 
    formatarDataEmTempoReal, 
    validarDataInput, 
    permitirApenasNumerosEControles 
} from './empresa-ui-helpers.js';

const empresa = new EmpresaCadastroInline();

/* ==== SE√á√ÉO 1: GERENCIAMENTO DE FORMUL√ÅRIOS ==== */

/**
 * üÜï ATUALIZA A INTERFACE COM OS DADOS DA EMPRESA
 */
async function atualizarInterfaceComEmpresa(obraElement, obraData) {
    try {
        // Encontrar o container de cadastro de empresas
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (!empresaContainer) {
            console.log(`‚ùå [EMPRESA] Container de empresa n√£o encontrado na obra "${obraData.nome}"`);
            return;
        }
        
        // üÜï ATUALIZAR HEADER DA OBRA COM SPAN (n√£o bot√£o)
        if (window.empresaCadastro && typeof window.empresaCadastro.atualizarHeaderObra === 'function') {
            window.empresaCadastro.atualizarHeaderObra(obraElement, obraData);
        }
        
        console.log(`‚úÖ [EMPRESA] Interface atualizada com SPAN no header`);
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao atualizar interface:`, error);
    }
}

/**
 * üÜï ATUALIZA CAMPOS DO FORMUL√ÅRIO DE EMPRESA EXISTENTE - COM DATA FORMATADA
 */
function atualizarCamposEmpresaForm(obraData, formElement) {
    const camposMapping = {
        'empresaSigla': 'empresa-input',
        'numeroClienteFinal': 'numero-cliente-final',
        'clienteFinal': 'cliente-final',
        'codigoCliente': 'codigo-cliente',
        'dataCadastro': 'data-cadastro',
        'orcamentistaResponsavel': 'orcamentista-responsavel'
    };
    
    Object.entries(camposMapping).forEach(([dataField, inputId]) => {
        const input = formElement.querySelector(`#${inputId}`);
        if (input && obraData[dataField]) {
            // üÜï FORMATAR DATA SE FOR O CAMPO dataCadastro
            if (dataField === 'dataCadastro') {
                input.value = empresa.formatarData(obraData[dataField]);
            } else {
                input.value = obraData[dataField];
            }
            
            // Configurar dados adicionais para empresa
            if (dataField === 'empresaSigla' && obraData.empresaNome) {
                input.dataset.siglaSelecionada = obraData.empresaSigla;
                input.dataset.nomeSelecionado = obraData.empresaNome;
            }
        }
    });
    
    // Atualizar preview do ID da obra
    const idObraValue = formElement.querySelector('#obra-id-value');
    if (idObraValue && obraData.idGerado) {
        idObraValue.textContent = obraData.idGerado;
    }
}

/**
 * üÜï CRIA FORMUL√ÅRIO DE EMPRESA COM DADOS EXISTENTES - SEM VALOR HARDCODED
 */
function criarVisualizacaoEmpresa(obraData, container) {
    // Ocultar bot√£o se existir
    const botao = container.querySelector('.btn-empresa-cadastro');
    if (botao) {
        botao.style.display = 'none';
    }
    
    // üî• CORRE√á√ÉO: N√ÉO usar valores hardcoded, apenas placeholders
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Dados da Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <div class="form-group-horizontal">
                <label>Empresa</label>
                <div class="empresa-input-container">
                    <input type="text" 
                           class="empresa-input-cadastro" 
                           id="empresa-input-${obraData.id}"
                           ${obraData.empresaSigla && obraData.empresaNome ? `value="${obraData.empresaSigla} - ${obraData.empresaNome}"` : ''}
                           placeholder="Digite sigla ou nome ou selecione..."
                           autocomplete="off">
                    <div class="empresa-dropdown" id="empresa-dropdown-${obraData.id}">
                        <div class="dropdown-options" id="empresa-options-${obraData.id}"></div>
                    </div>
                </div>
            </div>

            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" 
                       class="numero-cliente-final-readonly" 
                       ${obraData.numeroClienteFinal ? `value="${obraData.numeroClienteFinal}"` : ''}
                       placeholder="N√∫mero do cliente"
                       >
            </div>

            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" 
                       class="cliente-final-input" 
                       ${obraData.clienteFinal ? `value="${obraData.clienteFinal}"` : ''}
                       placeholder="Nome do cliente final">
            </div>

            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" 
                       class="codigo-cliente-input" 
                       ${obraData.codigoCliente ? `value="${obraData.codigoCliente}"` : ''}
                       placeholder="C√≥digo do cliente">
            </div>

            <!-- üÜï CAMPO DE DATA COM DATEPICKER DIN√ÇMICO -->
            <div class="form-group-horizontal">
                <label>Data</label>
                <div class="date-input-container">
                    <input type="text" 
                           class="data-cadastro-input" 
                           id="data-cadastro-${obraData.id}"
                           ${obraData.dataCadastro ? `value="${empresa.formatarData(obraData.dataCadastro)}"` : ''}
                           placeholder="DD/MM/AAAA"
                           maxlength="10">
                    <span class="calendar-icon" onclick="window.alternarDatePicker('${obraData.id}', 'edit')">üìÖ</span>
                </div>
            </div>

            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" 
                       class="orcamentista-responsavel-input" 
                       ${obraData.orcamentistaResponsavel ? `value="${obraData.orcamentistaResponsavel}"` : ''}
                       placeholder="Nome do or√ßamentista">
            </div>
        </div>

        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraData.id}')">
                Ocultar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    
    // üÜï INICIALIZAR AUTOCOMPLETE COM A FUN√á√ÉO EXISTENTE
    setTimeout(() => {
        inicializarInputEmpresaHibrido(obraData.id);
        
        // üÜï CONFIGURAR AUTO-FORMATA√á√ÉO PARA O CAMPO DE DATA
        const dataCampo = container.querySelector(`#data-cadastro-${obraData.id}`);
        if (dataCampo) {
            configurarCampoDataEspecifico(dataCampo);
        }
        
        // üÜï VINCULAR EVENTOS DE MUDAN√áA PARA OS OUTROS CAMPOS
        vincularEventosMudanca(obraData.id, container);
        
    }, 100);
    
    console.log(`‚úÖ [EMPRESA] Formul√°rio criado para obra ${obraData.id}`);
}

/**
 * üÜï VINCULAR EVENTOS DE MUDAN√áA PARA OS CAMPOS
 */
function vincularEventosMudanca(obraId, container) {
    // Vincular evento change para cada campo edit√°vel
    const campos = [
        { selector: '.cliente-final-input', campo: 'clienteFinal' },
        { selector: '.codigo-cliente-input', campo: 'codigoCliente' },
        { selector: '.orcamentista-responsavel-input', campo: 'orcamentistaResponsavel' }
    ];
    
    campos.forEach(({ selector, campo }) => {
        const input = container.querySelector(selector);
        if (input) {
            // Remover event listener anterior se existir
            input.removeEventListener('change', input._changeHandler);
            
            // Adicionar novo handler
            input._changeHandler = function() {
                window.atualizarDadosEmpresa(this, campo, obraId);
            };
            
            input.addEventListener('change', input._changeHandler);
        }
    });
}

/**
 * üÜï CRIA FORMUL√ÅRIO VAZIO DE EMPRESA
 */
function criarFormularioVazioEmpresa(obraId, container) {
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Cadastro de Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <div class="form-group-horizontal">
                <label>Empresa *</label>
                <div class="empresa-input-container">
                    <input type="text" 
                           class="empresa-input-cadastro" 
                           id="empresa-input-${obraId}"
                           placeholder="Digite sigla ou nome ou selecione..."
                           autocomplete="off">
                    <div class="empresa-dropdown" id="empresa-dropdown-${obraId}">
                        <div class="dropdown-options" id="empresa-options-${obraId}"></div>
                    </div>
                </div>
            </div>

            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" class="numero-cliente-final-cadastro"
                    placeholder="Ser√° gerado automaticamente">
            </div>

            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" class="cliente-final-cadastro" 
                    placeholder="Nome do cliente final">
            </div>

            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" class="codigo-cliente-cadastro" 
                    placeholder="C√≥digo do cliente">
            </div>

            <div class="form-group-horizontal">
                <label>Data</label>
                <div class="date-input-container">
                    <input type="text" 
                           class="data-cadastro-cadastro" 
                           id="data-cadastro-${obraId}"
                           placeholder="DD/MM/AAAA"
                           value="${dataAtual}"
                           maxlength="10">
                    <span class="calendar-icon" onclick="window.alternarDatePicker('${obraId}', 'cadastro')">üìÖ</span>
                </div>
            </div>

            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" class="orcamentista-responsavel-cadastro" 
                    placeholder="Nome do or√ßamentista">
            </div>
        </div>

        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraId}')">
                Cancelar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    
    setTimeout(() => {
        inicializarInputEmpresaHibrido(obraId);
        
        // üÜï CONFIGURAR AUTO-FORMATA√á√ÉO PARA O CAMPO DE DATA
        const dataCampo = container.querySelector(`#data-cadastro-${obraId}`);
        if (dataCampo) {
            configurarCampoDataEspecifico(dataCampo);
        }
        
    }, 300);
}

/* ==== SE√á√ÉO 2: SISTEMA DE DATEPICKER E FORMATA√á√ÉO DE DATA ==== */

/**
 * üÜï CONFIGURAR AUTO-FORMATA√á√ÉO PARA TODOS OS CAMPOS DE DATA
 */
function configurarAutoFormatacaoData() {
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('data-cadastro-cadastro') || 
            e.target.classList.contains('data-cadastro-input')) {
            formatarDataEmTempoReal(e.target);
        }
    });
    
    // Tamb√©m prevenir caracteres n√£o num√©ricos
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('data-cadastro-cadastro') || 
            e.target.classList.contains('data-cadastro-input')) {
            permitirApenasNumerosEControles(e);
        }
    });
    
    // Valida√ß√£o ao sair do campo
    document.addEventListener('blur', function(e) {
        if (e.target.classList.contains('data-cadastro-cadastro') || 
            e.target.classList.contains('data-cadastro-input')) {
            validarDataInput(e.target);
        }
    }, true);
    
    console.log('‚úÖ Sistema de auto-formata√ß√£o de data configurado');
}

/**
 * üÜï CONFIGURA AUTO-FORMATA√á√ÉO PARA UM CAMPO ESPEC√çFICO
 */
function configurarCampoDataEspecifico(inputElement) {
    if (!inputElement) return;
    
    inputElement.addEventListener('input', function() {
        formatarDataEmTempoReal(this);
    });
    
    inputElement.addEventListener('keydown', function(e) {
        permitirApenasNumerosEControles(e);
    });
    
    inputElement.addEventListener('blur', function() {
        validarDataInput(this);
    });
    
    // üÜï CONFIGURA PLACEHOLDER E ATRIBUTOS
    inputElement.placeholder = 'DD/MM/AAAA';
    inputElement.maxLength = 10;
    
    console.log('‚úÖ Campo de data configurado com auto-formata√ß√£o:', inputElement.id);
}

/**
 * üÜï ALTERNA ENTRE INPUT TEXT E DATE QUANDO CLICA NO √çCONE
 */
window.alternarDatePicker = function(obraId, tipo) {
    const textInput = document.getElementById(`data-cadastro-${tipo === 'edit' ? '' : ''}${obraId}`);
    const container = textInput?.closest('.date-input-container');
    
    if (!textInput || !container) return;
    
    textInput.style.display = 'none';
    
    const datePickerHTML = `
        <div class="date-picker-visible-wrapper" id="date-picker-wrapper-${obraId}">
            <input type="date" 
                   class="date-picker-visible"
                   id="date-picker-temp-${obraId}"
                   onchange="window.aplicarDataDoDatePicker('${obraId}', '${tipo}', this.value)"
                   onblur="window.restaurarInputTexto('${obraId}', '${tipo}')">
            <div class="date-display-overlay" id="date-display-${obraId}"></div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', datePickerHTML);
    
    const datePicker = container.querySelector('.date-picker-visible');
    const dateDisplay = container.querySelector(`#date-display-${obraId}`);
    
    let dataInicial = 'DD/MM/AAAA';
    if (textInput.value && /^\d{2}\/\d{2}\/\d{4}$/.test(textInput.value)) {
        const [dia, mes, ano] = textInput.value.split('/');
        datePicker.value = `${ano}-${mes}-${dia}`;
        dataInicial = textInput.value;
    }
    
    atualizarDisplayData(dateDisplay, dataInicial);
    
    datePicker.addEventListener('input', function() {
        if (this.value) {
            const [ano, mes, dia] = this.value.split('-');
            const dataBrasileira = `${dia}/${mes}/${ano}`;
            atualizarDisplayData(dateDisplay, dataBrasileira);
        } else {
            atualizarDisplayData(dateDisplay, 'DD/MM/AAAA');
        }
    });
    
    datePicker.addEventListener('change', function() {
        if (this.value) {
            const [ano, mes, dia] = this.value.split('-');
            const dataBrasileira = `${dia}/${mes}/${ano}`;
            atualizarDisplayData(dateDisplay, dataBrasileira);
        }
    });
    
    setTimeout(() => {
        datePicker.focus();
        datePicker.showPicker();
    }, 100);
    
    console.log('‚úÖ Date picker ativado para obra:', obraId);
};

/**
 * üÜï APLICA A DATA SELECIONADA NO DATEPICKER AO CAMPO DE TEXTO
 */
window.aplicarDataDoDatePicker = function(obraId, tipo, dataISO) {
    const container = document.querySelector(`#data-cadastro-${obraId}`)?.closest('.date-input-container');
    const textInput = container?.querySelector(`#data-cadastro-${obraId}`);
    
    const datePickerWrapper = document.getElementById(`date-picker-wrapper-${obraId}`);
    if (datePickerWrapper && datePickerWrapper.parentNode) {
        try {
            datePickerWrapper.remove();
        } catch (error) {
            console.log('‚ö†Ô∏è Date picker j√° foi removido:', error.message);
        }
    }
    
    if (dataISO && textInput) {
        const [ano, mes, dia] = dataISO.split('-');
        const dataBrasileira = `${dia}/${mes}/${ano}`;
        textInput.value = dataBrasileira;
    }
    
    if (textInput) {
        textInput.style.display = 'block';
        setTimeout(() => {
            textInput.focus();
            textInput.setSelectionRange(textInput.value.length, textInput.value.length);
        }, 50);
    }
    
    if (dataISO && textInput) {
        const event = new Event('change', { bubbles: true });
        textInput.dispatchEvent(event);
        console.log('‚úÖ Data do date picker aplicada:', textInput.value);
    }
};

/**
 * üÜï RESTAURA O INPUT DE TEXTO SE O USU√ÅRIO CANCELAR
 */
window.restaurarInputTexto = function(obraId, tipo) {
    const container = document.querySelector(`#data-cadastro-${obraId}`)?.closest('.date-input-container');
    const textInput = container?.querySelector(`#data-cadastro-${obraId}`);
    
    const datePickerWrapper = document.getElementById(`date-picker-wrapper-${obraId}`);
    if (datePickerWrapper && datePickerWrapper.parentNode) {
        try {
            datePickerWrapper.remove();
        } catch (error) {
            console.log('‚ö†Ô∏è Date picker j√° foi removido (blur):', error.message);
        }
    }
    
    if (textInput) {
        textInput.style.display = 'block';
        setTimeout(() => {
            textInput.focus();
            textInput.setSelectionRange(textInput.value.length, textInput.value.length);
        }, 50);
    }
    
    console.log('‚úÖ Input de texto restaurado');
};

/**
 * üÜï ATUALIZA O DISPLAY VISUAL DA DATA
 */
function atualizarDisplayData(dateDisplay, dataFormatada) {
    if (!dateDisplay) return;
    
    dateDisplay.textContent = dataFormatada;
    
    if (dataFormatada && /^\d{2}\/\d{2}\/\d{4}$/.test(dataFormatada)) {
        dateDisplay.style.color = '#000';
        dateDisplay.style.fontWeight = 'normal';
        dateDisplay.style.fontStyle = 'normal';
    } else {
        dateDisplay.style.color = '#999';
        dateDisplay.style.fontWeight = 'normal';
        dateDisplay.style.fontStyle = 'italic';
    }
}

/* ==== SE√á√ÉO 3: UTILIT√ÅRIOS DE DATA ==== */

/**
 * üÜï OBT√âM DATA FORMATADA DO CAMPO
 * Retorna no formato DD/MM/AAAA para armazenamento (igual ao JSON)
 */
function obterDataFormatadaDoCampo(inputElement) {
    if (!inputElement || !inputElement.value) return null;
    
    const value = inputElement.value;
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(value)) return null;
    
    // üÜï RETORNA NO FORMATO DD/MM/AAAA (igual ao JSON)
    return value;
}

/**
 * üÜï DEFINE DATA NO CAMPO FORMATADO
 * Aceita formato YYYY-MM-DD ou DD/MM/AAAA
 */
function definirDataNoCampo(inputElement, data) {
    if (!inputElement || !data) return;
    
    let dataFormatada;
    
    if (data.includes('-')) {
        // Formato YYYY-MM-DD
        const [ano, mes, dia] = data.split('-');
        dataFormatada = `${dia}/${mes}/${ano}`;
    } else if (data.includes('/')) {
        // J√° est√° no formato DD/MM/AAAA
        dataFormatada = data;
    } else {
        console.warn('Formato de data n√£o reconhecido:', data);
        return;
    }
    
    inputElement.value = dataFormatada;
    validarDataInput(inputElement);
}

/**
 * üÜï VALIDA TODOS OS CAMPOS DE DATA DO FORMUL√ÅRIO
 */
function validarTodosCamposDataNoFormulario(formElement) {
    const camposData = formElement.querySelectorAll('.data-cadastro-cadastro, .data-cadastro-input');
    let todosValidos = true;
    
    camposData.forEach(campo => {
        if (!validarDataInput(campo)) {
            todosValidos = false;
        }
    });
    
    return todosValidos;
}

/**
 * üÜï LIMPA E RESETA CAMPO DE DATA
 */
function limparCampoData(inputElement) {
    if (!inputElement) return;
    
    inputElement.value = '';
    inputElement.style.borderColor = '';
    inputElement.placeholder = 'DD/MM/AAAA';
}

/* ==== SE√á√ÉO 4: OCULTAR FORMUL√ÅRIO E LIMPEZA ==== */

/**
 * üÜï FUN√á√ÉO PARA FOR√áAR LIMPEZA COMPLETA DOS CAMPOS
 * (Pode ser chamada de qualquer lugar)
 */
function limparCamposEmpresaCompletamente(obraId) {
    try {
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) return;
        
        console.log(`üßπ [EMPRESA] For√ßando limpeza completa para obra ${obraId}`);
        
        // üî• 1. Todos os inputs de empresa (em qualquer formul√°rio)
        const todosInputsEmpresa = obraElement.querySelectorAll(`
            .empresa-input-cadastro, 
            .empresa-input,
            .numero-cliente-final-cadastro,
            .numero-cliente-final-readonly,
            .cliente-final-cadastro,
            .cliente-final-input,
            .codigo-cliente-cadastro,
            .codigo-cliente-input,
            .data-cadastro-cadastro,
            .data-cadastro-input,
            .orcamentista-responsavel-cadastro,
            .orcamentista-responsavel-input
        `);
        
        todosInputsEmpresa.forEach(input => {
            // Remover atributo value
            input.removeAttribute('value');
            
            // Limpar valor
            if (input.readOnly || input.disabled) {
                input.setAttribute('value', '');
            }
            input.value = '';
            
            // Limpar data attributes
            delete input.dataset.siglaSelecionada;
            delete input.dataset.nomeSelecionado;
            
            // Restaurar placeholders
            if (input.classList.contains('empresa-input-cadastro') || 
                input.classList.contains('empresa-input')) {
                input.placeholder = 'Digite sigla ou nome...';
            } else if (input.classList.contains('numero-cliente-final-readonly') ||
                      input.classList.contains('numero-cliente-final-cadastro')) {
                input.placeholder = 'N√∫mero do cliente';
            }
        });
        
        // üî• 2. Remover dropdowns de autocomplete
        const dropdowns = obraElement.querySelectorAll('.empresa-dropdown');
        dropdowns.forEach(dropdown => dropdown.remove());
        
        // üî• 3. Limpar data attributes da obra
        const camposParaLimpar = [
            'empresaSigla', 'empresaNome', 'numeroClienteFinal',
            'clienteFinal', 'codigoCliente', 'dataCadastro',
            'orcamentistaResponsavel', 'idGerado', 'identificadorObra'
        ];
        
        camposParaLimpar.forEach(campo => {
            delete obraElement.dataset[campo];
        });
        
        // üî• 4. Restaurar bot√£o se necess√°rio
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (empresaContainer && !empresaContainer.querySelector('.btn-empresa-cadastro')) {
            empresaContainer.innerHTML = '';
            const botao = document.createElement('button');
            botao.className = 'btn-empresa-cadastro';
            botao.textContent = 'Adicionar campos de cadastro de empresas';
            botao.onclick = () => window.ativarCadastroEmpresa(obraId);
            empresaContainer.appendChild(botao);
        }
        
        console.log(`‚úÖ [EMPRESA] Limpeza completa realizada para obra ${obraId}`);
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro na limpeza completa:', error);
    }
}

/**
 * üÜï OCULTAR FORMUL√ÅRIO DE EMPRESA E LIMPAR CAMPOS COMPLETAMENTE
 */
window.ocultarFormularioEmpresa = function(button, obraId) {
    try {
        const formulario = button?.closest('.empresa-formulario-ativo');
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra ${obraId} n√£o encontrada`);
            return;
        }
        
        // üî• 1. ANTES de remover o formul√°rio, limpar TODOS os campos
        if (formulario) {
            const todosOsCampos = formulario.querySelectorAll('input');
            todosOsCampos.forEach(campo => {
                // üî• PARA CAMPOS READONLY: usar setAttribute
                if (campo.readOnly || campo.disabled) {
                    campo.setAttribute('value', '');
                    campo.value = '';
                } else {
                    // üî• PARA CAMPOS EDIT√ÅVEIS: limpar normalmente
                    campo.value = '';
                }
                
                // üî• REMOVER ATRIBUTO VALUE HARDCODED
                campo.removeAttribute('value');
                
                // üî• RESTAURAR PLACEHOLDERS
                if (campo.classList.contains('empresa-input-cadastro')) {
                    campo.placeholder = 'Digite sigla ou nome ou selecione...';
                } else if (campo.classList.contains('numero-cliente-final-readonly') || 
                          campo.classList.contains('numero-cliente-final-cadastro')) {
                    campo.placeholder = 'Ser√° calculado automaticamente';
                }
                
                // üî• LIMPAR DATA ATTRIBUTES DO AUTOCOMPLETE
                if (campo.classList.contains('empresa-input-cadastro')) {
                    delete campo.dataset.siglaSelecionada;
                    delete campo.dataset.nomeSelecionado;
                }
            });
            
            // üî• 2. REMOVER DROPDOWNS DO AUTOCOMPLETE (se existirem)
            const dropdowns = formulario.querySelectorAll('.empresa-dropdown');
            dropdowns.forEach(dropdown => dropdown.remove());
            
            // üî• 3. S√≥ ent√£o remover o formul√°rio
            formulario.remove();
        }
        
        // üî• 4. Limpar dados da obra
        const camposEmpresa = [
            'empresaSigla', 'empresaNome', 'numeroClienteFinal',
            'clienteFinal', 'codigoCliente', 'dataCadastro',
            'orcamentistaResponsavel', 'idGerado', 'identificadorObra'
        ];
        
        camposEmpresa.forEach(campo => {
            delete obraElement.dataset[campo];
        });
        
        // üî• 5. Restaurar bot√£o de cadastro
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (empresaContainer) {
            // Limpar container primeiro
            empresaContainer.innerHTML = '';
            
            // Criar novo bot√£o limpo
            const botao = document.createElement('button');
            botao.className = 'btn-empresa-cadastro';
            botao.textContent = 'Adicionar campos de cadastro de empresas';
            botao.onclick = () => window.ativarCadastroEmpresa(obraId);
            
            empresaContainer.appendChild(botao);
        }
        
        // üî• 6. Restaurar t√≠tulo original se necess√°rio
        const tituloElement = obraElement.querySelector('.obra-title');
        if (tituloElement && tituloElement.textContent.includes('-')) {
            tituloElement.textContent = 'Nova Obra';
        }
        
        console.log(`‚úÖ [EMPRESA] Formul√°rio ocultado e CAMPOS COMPLETAMENTE LIMPOS para obra ${obraId}`);
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro ao ocultar formul√°rio:', error);
    }
};

/* ==== SE√á√ÉO 5: INICIALIZA√á√ÉO ==== */
export { 
    atualizarInterfaceComEmpresa,
    atualizarCamposEmpresaForm,
    criarVisualizacaoEmpresa,
    vincularEventosMudanca,
    criarFormularioVazioEmpresa,
    configurarAutoFormatacaoData,
    configurarCampoDataEspecifico,
    atualizarDisplayData,
    obterDataFormatadaDoCampo,
    definirDataNoCampo,
    validarTodosCamposDataNoFormulario,
    limparCampoData,
    limparCamposEmpresaCompletamente
}

// Compatibilidade global
if (typeof window !== 'undefined') {
    window.atualizarInterfaceComEmpresa = atualizarInterfaceComEmpresa;
    window.atualizarCamposEmpresaForm = atualizarCamposEmpresaForm;
    window.criarVisualizacaoEmpresa = criarVisualizacaoEmpresa;
    window.vincularEventosMudanca = vincularEventosMudanca;
    window.criarFormularioVazioEmpresa = criarFormularioVazioEmpresa;
    window.configurarAutoFormatacaoData = configurarAutoFormatacaoData;
    window.configurarCampoDataEspecifico = configurarCampoDataEspecifico;
    window.atualizarDisplayData = atualizarDisplayData;
    window.obterDataFormatadaDoCampo = obterDataFormatadaDoCampo;
    window.definirDataNoCampo = definirDataNoCampo;
    window.validarTodosCamposDataNoFormulario = validarTodosCamposDataNoFormulario;
    window.limparCampoData = limparCampoData;
    window.limparCamposEmpresaCompletamente = limparCamposEmpresaCompletamente;
}


// üÜï INICIALIZAR CONFIGURA√á√ÉO DE DATA QUANDO O M√ìDULO FOR CARREGADO
document.addEventListener('DOMContentLoaded', function() {
    configurarAutoFormatacaoData();
    console.log('‚úÖ empresa-form-manager.js carregado com sucesso');
});
/* ==== FIM: empresa-form-manager.js ==== */

/* ==== IN√çCIO: empresa-ui-helpers.js ==== */
// empresa-ui-helpers.js
/**
 * üé® EMPRESA-UI-HELPERS.JS - Helpers de UI e Eventos para Sistema de Empresa
 * ‚úÖ Responsabilidade: Eventos, detectores, corre√ß√µes de UI, tooltips, formata√ß√£o
 */

/* ==== SE√á√ÉO 1: DETECTORES DE BACKSPACE E EVENTOS ==== */

/**
 * üÜï DETECTAR BACKSPACE/DELETE DE FORMA MAIS PRECISA
 */
function criarSistemaBackspaceDetector(input) {
    let pressionandoBackspace = false;
    let timeoutBackspace;

    input.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            pressionandoBackspace = true;
            window.usuarioEstaApagando = true;

            // Limpar timeout anterior
            if (timeoutBackspace) clearTimeout(timeoutBackspace);

            // Timeout para resetar se parou de apertar
            timeoutBackspace = setTimeout(() => {
                pressionandoBackspace = false;
                window.usuarioEstaApagando = false;
            }, 500);

            console.log('‚å´ Tecla de apagar pressionada');
        }
    });

    input.addEventListener('keyup', function (e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            // Pequeno delay para garantir que o input foi processado
            setTimeout(() => {
                if (!pressionandoBackspace) {
                    window.usuarioEstaApagando = false;
                }
            }, 50);
        }
    });

    // Detectar sele√ß√£o total (Ctrl+A) + Backspace
    input.addEventListener('input', function (e) {
        if (pressionandoBackspace && this.value.length === 0) {
            console.log('üéØ Usu√°rio apagou tudo - reset completo');
            limparDadosSelecao(input, input.closest('[data-obra-id]')?.dataset.obraId);
        }
    });
}

/**
 * üÜï INICIALIZAR DETECTOR DE BACKSPACE SEPARADAMENTE
 */
function inicializarDetectorBackspace(input, obraId) {
    console.log(`‚å´ [BACKSPACE] Inicializando detector para obra ${obraId}`);

    let pressionandoBackspace = false;
    let timeoutBackspace;

    input.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            window.usuarioEstaApagando = true;
            pressionandoBackspace = true;

            console.log('‚å´ Tecla de apagar pressionada - bloqueando autocomplete');

            // Limpar timeout anterior
            if (timeoutBackspace) clearTimeout(timeoutBackspace);

            // Timeout para resetar se parou de apertar
            timeoutBackspace = setTimeout(() => {
                pressionandoBackspace = false;
                window.usuarioEstaApagando = false;
                console.log('üîÑ Resetando flag de apagamento');
            }, 500);
        }

        // Salvar valor atual para compara√ß√£o
        window.ultimoValorInput = this.value;
    });

    input.addEventListener('keyup', function (e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            // Pequeno delay para garantir que o input foi processado
            setTimeout(() => {
                if (!pressionandoBackspace) {
                    window.usuarioEstaApagando = false;
                    console.log('üîÑ Tecla de apagar liberada');
                }
            }, 50);
        }
    });

    // Detectar sele√ß√£o total (Ctrl+A) + Backspace
    input.addEventListener('input', function (e) {
        if (pressionandoBackspace && this.value.length === 0) {
            console.log('üéØ Usu√°rio apagou tudo - reset completo');
            limparDadosSelecao(input, obraId);
        }
    });
}

/**
 * üÜï LIMPAR DADOS DE SELE√á√ÉO
 */
function limparDadosSelecao(input, obraId) {
    if (input) {
        delete input.dataset.siglaSelecionada;
        delete input.dataset.nomeSelecionado;
    }
    limparNumeroCliente(obraId);
    console.log('üîÑ Dados de sele√ß√£o limpos');
}

/* ==== SE√á√ÉO 2: CORRE√á√ïES DE UI E POSICIONAMENTO ==== */

/**
 * üÜï CORRIGIR POSI√á√ÉO DO DROPDOWN EM DISPOSITIVOS M√ìVEIS
 */
function corrigirPosicaoDropdown() {
    const dropdowns = document.querySelectorAll('.empresa-dropdown');

    dropdowns.forEach(dropdown => {
        const input = dropdown.previousElementSibling;
        if (input && input.classList.contains('empresa-input-cadastro')) {
            // üî• GARANTIR QUE O DROPDOWN FIQUE EXATAMENTE ABAIXO DO INPUT
            const rect = input.getBoundingClientRect();
            dropdown.style.width = rect.width + 'px';
            dropdown.style.left = '0';
            dropdown.style.right = 'auto';
        }
    });
}

/**
 * üÜï LIMPAR N√öMERO DO CLIENTE QUANDO EMPRESA FOR REMOVIDA
 */
function limparNumeroCliente(obraId) {
    const numeroInput = document.querySelector(`[data-obra-id="${obraId}"] .numero-cliente-final-cadastro`);
    if (numeroInput) {
        numeroInput.value = '';
        console.log(`üîÑ [EMPRESA] N√∫mero do cliente limpo para obra ${obraId}`);
    }
}

/* ==== SE√á√ÉO 3: AVISOS E NOTIFICA√á√ïES ==== */

/**
 * üÜï MOSTRAR AVISO DE AUTOCOMPLETE - CSS EXTERNO
 */
function mostrarAvisoAutocompletado(input, tipoSelecao = 'manual') {
    if (tipoSelecao !== 'autocomplete') return;

    // Remove avisos anteriores
    document.querySelectorAll('.aviso-autocomplete-relativo').forEach(aviso => aviso.remove());

    // Encontrar container
    const container = input.closest('.form-group-horizontal') ||
        input.closest('.empresa-input-container') ||
        input.parentNode;

    if (!container) return;

    // Criar aviso
    const aviso = document.createElement('div');
    aviso.className = 'aviso-autocomplete-relativo';
    aviso.textContent = 'Empresa autocompletada ‚úì';

    // Adicionar ao container
    container.appendChild(aviso);

    // Anima√ß√£o
    setTimeout(() => aviso.classList.add('show'), 50);

    // Remover
    setTimeout(() => {
        aviso.classList.remove('show');
        setTimeout(() => aviso.remove(), 300);
    }, 1200);
}

/* ==== SE√á√ÉO 4: FORMATA√á√ÉO E VALIDA√á√ÉO DE DATA ==== */

/**
 * üÜï FORMATA DATA EM TEMPO REAL
 */
function formatarDataEmTempoReal(input) {
    let value = input.value.replace(/\D/g, ''); // Remove n√£o n√∫meros

    // Aplica formata√ß√£o autom√°tica
    if (value.length > 2) {
        value = value.substring(0, 2) + '/' + value.substring(2);
    }
    if (value.length > 5) {
        value = value.substring(0, 5) + '/' + value.substring(5, 9);
    }

    input.value = value;

    // üÜï VALIDA√á√ÉO B√ÅSICA DA DATA
    validarDataInput(input);
}

/**
 * üÜï PERMITE APENAS N√öMEROS E TECLAS DE CONTROLE
 */
function permitirApenasNumerosEControles(event) {
    const teclasPermitidas = [
        'Backspace', 'Delete', 'Tab', 'Escape', 'Enter',
        'ArrowLeft', 'ArrowRight', 'Home', 'End'
    ];

    if (teclasPermitidas.includes(event.key)) {
        return; // Permite teclas de controle
    }

    // Permite apenas n√∫meros
    if (!/^\d$/.test(event.key)) {
        event.preventDefault();
        return;
    }

    // üÜï LIMITA O TAMANHO M√ÅXIMO (10 caracteres com formata√ß√£o)
    const input = event.target;
    if (input.value.replace(/\D/g, '').length >= 8 && !teclasPermitidas.includes(event.key)) {
        event.preventDefault();
        return;
    }
}

/**
 * üÜï VALIDA√á√ÉO B√ÅSICA DA DATA
 */
function validarDataInput(input) {
    const value = input.value;

    // Verifica se est√° vazio
    if (!value) {
        input.style.borderColor = '';
        return true;
    }

    // Verifica formato b√°sico
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
        input.style.borderColor = '#ff4444';
        return false;
    }

    // Extrai dia, m√™s e ano
    const [dia, mes, ano] = value.split('/').map(Number);

    // Valida√ß√µes b√°sicas
    if (dia < 1 || dia > 31) {
        input.style.borderColor = '#ff4444';
        return false;
    }

    if (mes < 1 || mes > 12) {
        input.style.borderColor = '#ff4444';
        return false;
    }

    if (ano < 1900 || ano > 2100) {
        input.style.borderColor = '#ff4444';
        return false;
    }

    // Valida meses com 30 dias
    const meses30Dias = [4, 6, 9, 11];
    if (meses30Dias.includes(mes) && dia > 30) {
        input.style.borderColor = '#ff4444';
        return false;
    }

    // Valida fevereiro e anos bissextos
    if (mes === 2) {
        const isBissexto = (ano % 4 === 0 && ano % 100 !== 0) || (ano % 400 === 0);
        if (dia > (isBissexto ? 29 : 28)) {
            input.style.borderColor = '#ff4444';
            return false;
        }
    }

    // Data v√°lida
    input.style.borderColor = '#4CAF50';
    return true;
}

/* ==== SE√á√ÉO 5: C√ÅLCULO LOCAL DE N√öMERO DO CLIENTE ==== */

/**
 * üÜï CALCULAR N√öMERO LOCALMENTE COMO FALLBACK
 */
async function calcularNumeroLocal(sigla, obraId) {
    try {
        // Buscar todas as obras para calcular localmente
        const response = await fetch('/api/backup-completo');
        if (!response.ok) {
            throw new Error('N√£o foi poss√≠vel carregar obras');
        }

        const backup = await response.json();
        const obrasExistentes = backup.obras || [];

        // Filtrar obras da mesma empresa
        const obrasDaEmpresa = obrasExistentes.filter(obra =>
            obra.empresaSigla === sigla ||
            (obra.idGerado && obra.idGerado.startsWith(`obra_${sigla}_`))
        );

        // Encontrar maior n√∫mero
        let maiorNumero = 0;
        obrasDaEmpresa.forEach(obra => {
            if (obra.numeroClienteFinal && obra.numeroClienteFinal > maiorNumero) {
                maiorNumero = obra.numeroClienteFinal;
            }

            if (obra.idGerado) {
                const match = obra.idGerado.match(new RegExp(`obra_${sigla}_(\\d+)`));
                if (match) {
                    const numero = parseInt(match[1]);
                    if (numero > maiorNumero) maiorNumero = numero;
                }
            }
        });

        const novoNumero = maiorNumero + 1;
        atualizarNumeroClienteInput(novoNumero, obraId);
        console.log(`üî¢ [EMPRESA] N√∫mero local: ${novoNumero} para ${sigla}`);

    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro no c√°lculo local:', error);
        // Fallback final: n√∫mero aleat√≥rio
        const numeroFallback = Math.floor(Math.random() * 100) + 1;
        atualizarNumeroClienteInput(numeroFallback, obraId);
        console.log(`üîÑ [EMPRESA] N√∫mero fallback: ${numeroFallback} para ${sigla}`);
    }
}

/**
 * üÜï ATUALIZAR INPUT DO N√öMERO DO CLIENTE
 */
function atualizarNumeroClienteInput(numero, obraId) {
    const numeroInput = document.querySelector(`[data-obra-id="${obraId}"] .numero-cliente-final-cadastro`);
    if (numeroInput) {
        numeroInput.value = numero;
    }
}

/* ==== SE√á√ÉO 6: FORMATA√á√ÉO DE DATA ==== */

/**
 * üÜï FORMATA DATA PARA dd/mm/aaaa
 */
function formatarData(dataString) {
    if (!dataString) return '';

    try {
        // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
        if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return dataString;
        }

        // Tentar parse como Date
        const data = new Date(dataString);

        // Verificar se √© uma data v√°lida
        if (isNaN(data.getTime())) {
            console.warn(`‚ö†Ô∏è [EMPRESA] Data inv√°lida: ${dataString}`);
            return dataString; // Retorna original se n√£o conseguir formatar
        }

        // Formatar para dd/mm/aaaa
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();

        return `${dia}/${mes}/${ano}`;

    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao formatar data ${dataString}:`, error);
        return dataString; // Retorna original em caso de erro
    }
}

/* ==== SE√á√ÉO 7: EVENT LISTENERS GLOBAIS ==== */

// Event listeners globais para corre√ß√£o de dropdown
window.addEventListener('resize', corrigirPosicaoDropdown);
window.addEventListener('scroll', corrigirPosicaoDropdown);

// üî• INICIALIZAR DETECTOR EM TODOS OS INPUTS EXISTENTES
document.addEventListener('DOMContentLoaded', function () {
    setTimeout(() => {
        const inputs = document.querySelectorAll('.empresa-input-cadastro');
        inputs.forEach(input => {
            criarSistemaBackspaceDetector(input);
        });

        console.log('‚úÖ [EMPRESA-UI-HELPERS] Sistema de backspace inicializado');
    }, 1000);
});

export {
    criarSistemaBackspaceDetector,
    inicializarDetectorBackspace,
    limparDadosSelecao,
    corrigirPosicaoDropdown,
    limparNumeroCliente,
    mostrarAvisoAutocompletado,
    formatarDataEmTempoReal,
    permitirApenasNumerosEControles,
    validarDataInput,
    calcularNumeroLocal,
    atualizarNumeroClienteInput,
    formatarData
}

// Compatibilidade global
if (typeof window !== 'undefined') {
    window.criarSistemaBackspaceDetector = criarSistemaBackspaceDetector;
    window.inicializarDetectorBackspace = inicializarDetectorBackspace;
    window.limparDadosSelecao = limparDadosSelecao;
    window.corrigirPosicaoDropdown = corrigirPosicaoDropdown;
    window.limparNumeroCliente = limparNumeroCliente;
    window.mostrarAvisoAutocompletado = mostrarAvisoAutocompletado;
    window.formatarDataEmTempoReal = formatarDataEmTempoReal;
    window.permitirApenasNumerosEControles = permitirApenasNumerosEControles;
    window.validarDataInput = validarDataInput;
    window.calcularNumeroLocal = calcularNumeroLocal;
    window.atualizarNumeroClienteInput = atualizarNumeroClienteInput;
    window.formatarData = formatarData;
}
console.log('‚úÖ empresa-ui-helpers.js carregado com sucesso');
/* ==== FIM: empresa-ui-helpers.js ==== */
