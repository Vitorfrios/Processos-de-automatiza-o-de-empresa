
/* ==== IN√çCIO: data/adapters/obra-adapter-folder/empresa-autocomplete.js ==== */
// empresa-autocomplete.js

import {
    inicializarDetectorBackspace,
    corrigirPosicaoDropdown,
    calcularNumeroClienteFinal,
    mostrarAvisoAutocompletado,
    limparDadosSelecao
} from './ui-helpers-obra-adapter.js'

// üÜï CACHE DE EMPRESAS - EVITA M√öLTIPLAS REQUISI√á√ïES
window.empresasCache = null;
window.cacheTimestamp = null;
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

/**
 * CARREGAR EMPRESAS COM CACHE
 */
async function carregarEmpresasComCache() {
    const agora = Date.now();
    
    // Se tem cache v√°lido, retorna do cache
    if (window.empresasCache && window.cacheTimestamp && (agora - window.cacheTimestamp) < CACHE_DURATION) {
        console.log('üì¶ [CACHE] Retornando empresas do cache');
        return window.empresasCache;
    }
    
    try {
        console.log('üì¶ [CACHE] Carregando empresas do servidor...');
        const response = await fetch('/api/dados/empresas');
        
        if (response.ok) {
            const data = await response.json();
            const empresas = data.empresas || [];
            
            // Atualiza cache
            window.empresasCache = empresas;
            window.cacheTimestamp = agora;
            
            console.log(`‚úÖ [CACHE] ${empresas.length} empresas carregadas e cacheadas`);
            return empresas;
        } else {
            console.error('‚ùå [CACHE] Erro ao carregar empresas:', response.status);
            return [];
        }
    } catch (error) {
        console.error('‚ùå [CACHE] Erro no carregamento:', error);
        return window.empresasCache || []; // Retorna cache antigo se dispon√≠vel
    }
}

/**
 * INICIALIZAR INPUT H√çBRIDO - OTIMIZADO
 */
async function inicializarInputEmpresaHibrido(obraId) {
    console.log(`üîß [INPUT H√çBRIDO] Inicializando para obra: ${obraId}`);
    
    const input = document.getElementById(`empresa-input-${obraId}`);
    const dropdown = document.getElementById(`empresa-dropdown-${obraId}`);
    const optionsContainer = document.getElementById(`empresa-options-${obraId}`);
    
    if (!input) {
        console.error(`‚ùå [INPUT H√çBRIDO] Input n√£o encontrado para obra ${obraId}`);
        return;
    }
    
    // üî• CORRE√á√ÉO: CARREGAR EMPRESAS COM CACHE
    let empresas = [];
    try {
        empresas = await carregarEmpresasComCache();
        console.log(`‚úÖ [INPUT H√çBRIDO] ${empresas.length} empresas dispon√≠veis`);
    } catch (error) {
        console.error(`‚ùå [INPUT H√çBRIDO] Erro ao carregar empresas:`, error);
        empresas = [];
    }

    // üî• DEBOUNCE PARA EVITA MUITAS BUSCAS R√ÅPIDAS
    let timeoutBusca;
    
    // üî• INICIALIZAR DETECTOR DE BACKSPACE
    inicializarDetectorBackspace(input, obraId);
    
    // üî• EVENTO DE INPUT OTIMIZADO
    input.addEventListener('input', function(e) {
        const termo = e.target.value.trim();
        
        // Limpa timeout anterior
        if (timeoutBusca) {
            clearTimeout(timeoutBusca);
        }
        
        // üî• DEBOUNCE: Aguarda 150ms antes de processar
        timeoutBusca = setTimeout(() => {
            processarInputEmpresa(termo, input, dropdown, optionsContainer, obraId, empresas);
        }, 150);
    });
    
    // üî• EVENTO DE FOCO - MAIS R√ÅPIDO
    input.addEventListener('focus', function() {
        window.usuarioEstaApagando = false;
        window.ultimoValorInput = this.value;
        
        const valorAtual = this.value.trim();
        const empresaJaSelecionada = this.dataset.siglaSelecionada;
        
        if (valorAtual.length === 0) {
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        } else if (empresaJaSelecionada && valorAtual === `${this.dataset.siglaSelecionada} - ${this.dataset.nomeSelecionado}`) {
            dropdown.style.display = 'none';
        } else {
            const sugestoes = filtrarEmpresas(valorAtual, empresas);
            exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
        }
    });
    
    // üî• EVENTO DE BLUR
    input.addEventListener('blur', function() {
        if (timeoutBusca) {
            clearTimeout(timeoutBusca);
        }
        setTimeout(() => {
            window.usuarioEstaApagando = false;
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }, 200);
    });
    
    // üî• EVENTO DE TECLADO OTIMIZADO
    input.addEventListener('keydown', function(e) {
        if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Tab'].includes(e.key)) {
            e.preventDefault();
            
            switch(e.key) {
                case 'ArrowDown':
                    navegarDropdown('down', optionsContainer, input, dropdown, obraId);
                    break;
                case 'ArrowUp':
                    navegarDropdown('up', optionsContainer, input, dropdown, obraId);
                    break;
                case 'Enter':
                case 'Tab':
                    if (dropdown.style.display === 'block') {
                        selecionarOpcaoAtiva(optionsContainer, input, dropdown, obraId);
                    } else {
                        dropdown.style.display = 'none';
                        input.blur();
                    }
                    break;
                case 'Escape':
                    dropdown.style.display = 'none';
                    input.blur();
                    break;
            }
        }
    });
    
    // üî• EVENTO DE CLIQUE FORA - OTIMIZADO
    const fecharDropdownHandler = function(e) {
        if (input && dropdown && !input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    };
    
    document.addEventListener('click', fecharDropdownHandler);
    
    // üî• LIMPEZA AO DESTRUIR COMPONENTE
    input._cleanup = () => {
        document.removeEventListener('click', fecharDropdownHandler);
        if (timeoutBusca) {
            clearTimeout(timeoutBusca);
        }
    };
    
    console.log(`‚úÖ [INPUT H√çBRIDO] Inicializado com sucesso para obra ${obraId}`);
}

/**
 * PROCESSAR INPUT COM DEBOUNCE
 */
function processarInputEmpresa(termo, input, dropdown, optionsContainer, obraId, empresas) {
    console.log(`üîç [INPUT] Processando: "${termo}" | Apagando: ${window.usuarioEstaApagando}`);
    
    // üî• SE USU√ÅRIO EST√Å APAGANDO, N√ÉO FAZER AUTOCOMPLETE
    if (window.usuarioEstaApagando) {
        console.log('üö´ Autocomplete bloqueado - usu√°rio apagando');
        
        if (termo.length === 0) {
            limparDadosSelecao(input, obraId);
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        } else {
            const sugestoes = filtrarEmpresas(termo, empresas);
            exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
        }
        
        setTimeout(() => {
            window.usuarioEstaApagando = false;
        }, 100);
        return;
    }
    
    // üî• COMPORTAMENTO NORMAL
    if (termo.length === 0) {
        limparDadosSelecao(input, obraId);
        exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        return;
    }
    
    const sugestoes = filtrarEmpresas(termo, empresas);
    
    // üî• AUTOCOMPLETE S√ì SE N√ÉO ESTIVER APAGANDO
    if (sugestoes.length === 1 && termo.length > 0 && !window.usuarioEstaApagando) {
        const [sigla, nome] = Object.entries(sugestoes[0])[0];
        const matchForte = termo === sigla || termo.length >= 3;
        
        if (matchForte) {
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'autocomplete');
            return;
        }
    }
    
    exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
}

/**
 * FILTRAR EMPRESAS OTIMIZADO
 */
function filtrarEmpresas(termo, empresas) {
    if (!termo || termo.length < 1) return [];
    
    const termoNormalizado = termo.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    
    return empresas.filter(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        
        return sigla === termoNormalizado || 
               sigla.includes(termoNormalizado) ||
               nomeNormalizado.includes(termoNormalizado);
    });
}

/**
 * APLICAR EVENT LISTENERS DIRETOS - SUPORTE TOUCHPAD
 */
function aplicarEventListenersDiretos(container, input, dropdown, obraId) {
    const options = container.querySelectorAll('.dropdown-option');
    
    options.forEach(option => {
        // Remove listeners antigos
        option._clickHandler && option.removeEventListener('click', option._clickHandler);
        option._pointerHandler && option.removeEventListener('pointerdown', option._pointerHandler);
        option._touchHandler && option.removeEventListener('touchend', option._touchHandler);
        
        // Novo handler para click
        option._clickHandler = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            console.log('üñ±Ô∏è Sele√ß√£o por CLICK direto');
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
        };
        
        // Novo handler para pointer (touchpad)
        option._pointerHandler = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            console.log('üñ±Ô∏è Sele√ß√£o por POINTER direto');
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
        };
        
        // Novo handler para touch
        option._touchHandler = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            console.log('üñ±Ô∏è Sele√ß√£o por TOUCH direto');
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
        };
        
        // Aplicar todos os listeners
        option.addEventListener('click', option._clickHandler);
        option.addEventListener('pointerdown', option._pointerHandler);
        option.addEventListener('touchend', option._touchHandler);
    });
}

/**
 * EXIBIR SUGEST√ïES OTIMIZADO - COM SUPORTE TOUCHPAD
 */
function exibirSugestoes(sugestoes, container, input, dropdown, obraId) {
    const valorAtual = input.value.trim();
    const empresaJaSelecionada = input.dataset.siglaSelecionada;
    
    if (empresaJaSelecionada && valorAtual === `${input.dataset.siglaSelecionada} - ${input.dataset.nomeSelecionado}`) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }
    
    if (!sugestoes || sugestoes.length === 0) {
        container.innerHTML = valorAtual.length > 0 
            ? `<div class="dropdown-no-results">üìù Nenhuma empresa encontrada<br><small>Criando nova empresa: "${valorAtual}"</small></div>`
            : '<div class="dropdown-no-results">Digite para buscar empresas</div>';
        
        dropdown.style.display = 'block';
        return;
    }
    
    const sugestoesLimitadas = sugestoes.slice(0, 50);
    
    // üî• BLOQUEAR SELE√á√ÉO AUTOM√ÅTICA SE EST√Å APAGANDO
    if (sugestoesLimitadas.length === 1 && valorAtual.length > 0 && !window.usuarioEstaApagando) {
        const [sigla, nome] = Object.entries(sugestoesLimitadas[0])[0];
        const matchForte = termo === sigla || termo.length >= 3;
        
        if (matchForte) {
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'autocomplete');
            return;
        }
    }
    
    // üî• RENDERIZA√á√ÉO MAIS R√ÅPIDA
    container.innerHTML = sugestoesLimitadas.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}" title="${nome}">
                <strong>${sigla}</strong> 
                <div class="nome-empresa">- ${nome}</div>
            </div>
        `;
    }).join('');
    
    dropdown.style.display = 'block';
    setTimeout(corrigirPosicaoDropdown, 10);

    // Selecionar primeira op√ß√£o
    const primeiraOpcao = container.querySelector('.dropdown-option');
    if (primeiraOpcao) {
        primeiraOpcao.classList.add('active');
    }
    
    // ‚úÖ CORRE√á√ÉO: APLICAR EVENT LISTENERS DIRETOS PARA SUPORTE TOUCHPAD
    aplicarEventListenersDiretos(container, input, dropdown, obraId);
    
    console.log(`üîç [EMPRESA] Exibindo ${sugestoesLimitadas.length} sugest√µes`);
}

/**
 * EXIBIR TODAS AS EMPRESAS - COM SUPORTE TOUCHPAD
 */
function exibirTodasEmpresas(empresas, container, input, dropdown, obraId) {
    const empresaJaSelecionada = input.dataset.siglaSelecionada;
    
    if (empresaJaSelecionada) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }
    
    if (!empresas || empresas.length === 0) {
        container.innerHTML = `
            <div class="dropdown-no-results">
                üìù Nenhuma empresa cadastrada<br>
                <small>Digite o nome para criar uma nova</small>
            </div>
        `;
        dropdown.style.display = 'block';
        return;
    }
    
    const empresasLimitadas = empresas.slice(0, 50);
    
    const html = empresasLimitadas.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        
        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}" title="${nome}">
                <strong>${sigla}</strong> 
                <div class="nome-empresa">- ${nome}</div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
    dropdown.style.display = 'block';
    setTimeout(corrigirPosicaoDropdown, 10);

    setTimeout(() => {
        if (dropdown.scrollHeight > 200) {
            dropdown.style.overflowY = 'auto';
            dropdown.style.maxHeight = '200px';
        }
    }, 10);
    
    // ‚úÖ CORRE√á√ÉO: APLICAR EVENT LISTENERS DIRETOS PARA SUPORTE TOUCHPAD
    aplicarEventListenersDiretos(container, input, dropdown, obraId);
    
    console.log(`üìä [EMPRESA] Exibindo ${empresasLimitadas.length} de ${empresas.length} empresas`);
}

/**
 * NAVEGAR NO DROPDOWN COM TECLADO - COM LOOP (FINAL ‚Üí IN√çCIO)
 */
function navegarDropdown(direcao, container, input, dropdown, obraId) {
    const options = container.querySelectorAll('.dropdown-option');
    if (options.length === 0) return;
    
    const activeOption = container.querySelector('.dropdown-option.active');
    let nextIndex = 0;
    
    if (activeOption) {
        const currentIndex = Array.from(options).indexOf(activeOption);
        
        // üî• COMPORTAMENTO EXCEL COM LOOP
        if (direcao === 'down') {
            // Para baixo: se est√° no √∫ltimo, volta para o primeiro
            nextIndex = currentIndex === options.length - 1 ? 0 : currentIndex + 1;
        } else {
            // Para cima: se est√° no primeiro, vai para o √∫ltimo
            nextIndex = currentIndex === 0 ? options.length - 1 : currentIndex - 1;
        }
        
        console.log(`üîÑ Navega√ß√£o: ${currentIndex} ‚Üí ${nextIndex} (total: ${options.length})`);
    } else {
        // Se n√£o h√° op√ß√£o ativa, come√ßa na primeira (down) ou √∫ltima (up)
        nextIndex = direcao === 'down' ? 0 : options.length - 1;
    }
    
    // Remove active de todas e aplica na nova
    options.forEach(opt => opt.classList.remove('active'));
    options[nextIndex].classList.add('active');
    
    // üî• COMPORTAMENTO EXCEL: Atualiza o input em tempo real durante navega√ß√£o
    const sigla = options[nextIndex].dataset.sigla;
    const nome = options[nextIndex].dataset.nome;
    input.value = `${sigla} - ${nome}`;
    
    // Scroll para a op√ß√£o ativa
    options[nextIndex].scrollIntoView({ 
        block: 'nearest',
        behavior: 'smooth' 
    });
    
    console.log(`üéØ Navegando para: ${sigla} - ${nome} (${nextIndex + 1}/${options.length})`);
}

/**
 * SELECIONAR EMPRESA - COM CONTROLE DE TIPO DE SELE√á√ÉO
 */
function selecionarEmpresa(sigla, nome, input, dropdown, obraId, tipoSelecao = 'manual') {
    console.log('üéØ Selecionando empresa:', sigla, nome, 'Tipo:', tipoSelecao);
    
    // Preenche o input
    input.value = `${sigla} - ${nome}`;
    input.dataset.siglaSelecionada = sigla;
    input.dataset.nomeSelecionado = nome;
    
    // ‚úÖ CORRE√á√ÉO: SALVAR TODOS OS DADOS NOS DATA ATTRIBUTES DA OBRA
    const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (obraElement) {
        // Dados b√°sicos da empresa
        obraElement.dataset.empresaSigla = sigla;
        obraElement.dataset.empresaNome = nome;
        obraElement.dataset.dataCadastro = new Date().toLocaleDateString('pt-BR');
        
        // ‚úÖ BUSCAR E SALVAR OS DEMAIS CAMPOS DO FORMUL√ÅRIO
        const formEmpresa = obraElement.querySelector('.empresa-formulario-ativo');
        if (formEmpresa) {
            // Buscar n√∫mero do cliente
            const numeroClienteInput = formEmpresa.querySelector('.numero-cliente-final-cadastro');
            if (numeroClienteInput?.value) {
                obraElement.dataset.numeroClienteFinal = numeroClienteInput.value;
            }
            
            // Buscar cliente final
            const clienteFinalInput = formEmpresa.querySelector('.cliente-final-cadastro');
            if (clienteFinalInput?.value) {
                obraElement.dataset.clienteFinal = clienteFinalInput.value;
            }
            
            // Buscar c√≥digo do cliente
            const codigoClienteInput = formEmpresa.querySelector('.codigo-cliente-cadastro');
            if (codigoClienteInput?.value) {
                obraElement.dataset.codigoCliente = codigoClienteInput.value;
            }
            
            // Buscar or√ßamentista
            const orcamentistaInput = formEmpresa.querySelector('.orcamentista-responsavel-cadastro');
            if (orcamentistaInput?.value) {
                obraElement.dataset.orcamentistaResponsavel = orcamentistaInput.value;
            }
        }
        
        console.log(`üíæ TODOS os dados salvos na obra ${obraId}:`, {
            empresaSigla: sigla,
            empresaNome: nome,
            numeroClienteFinal: obraElement.dataset.numeroClienteFinal,
            clienteFinal: obraElement.dataset.clienteFinal,
            codigoCliente: obraElement.dataset.codigoCliente,
            orcamentistaResponsavel: obraElement.dataset.orcamentistaResponsavel
        });
    }
    
    // Fecha dropdown
    if (dropdown) {
        dropdown.style.display = 'none';
    }
    
    // Remove foco do input
    setTimeout(() => {
        input.blur();
        
        // üî• MOSTRAR AVISO APENAS SE FOR AUTOCOMPLETE
        mostrarAvisoAutocompletado(input, tipoSelecao);
    }, 10);
    
    // Calcula o n√∫mero do cliente
    calcularNumeroClienteFinal(sigla, obraId);
    
    console.log(`‚úÖ Empresa selecionada e TODOS os dados salvos: ${sigla} - ${nome}`);
}

/**
 * SELECIONAR OP√á√ÉO ATIVA (ENTER/TAB)
 */
function selecionarOpcaoAtiva(container, input, dropdown, obraId) {
    const activeOption = container.querySelector('.dropdown-option.active');
    if (activeOption) {
        const sigla = activeOption.dataset.sigla;
        const nome = activeOption.dataset.nome;
        console.log('‚å®Ô∏è Sele√ß√£o por teclado');
        
        // üî• TIPO: manual (usu√°rio usou teclado)
        selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
    }
}

/**
 * INICIALIZAR EVENT DELEGATION PARA CLIQUE NAS OP√á√ïES
 * ‚úÖ CORRE√á√ÉO: Suporte para touchpad, mouse e touch
 */
function inicializarEventDelegationClique() {
    // Event delegation global para todos os dropdowns de empresa
    // Captura m√∫ltiplos tipos de eventos para suporte completo
    
    const eventos = ['click', 'pointerdown', 'touchend'];
    
    eventos.forEach(eventType => {
        document.addEventListener(eventType, function(e) {
            const option = e.target.closest('.dropdown-option');
            if (option) {
                e.preventDefault();
                e.stopPropagation();
                
                // Encontrar o input e dropdown pai
                const dropdown = option.closest('.empresa-dropdown');
                if (!dropdown) return;
                
                const dropdownId = dropdown.id;
                const obraId = dropdownId.replace('empresa-dropdown-', '');
                const input = document.getElementById(`empresa-input-${obraId}`);
                
                if (input && dropdown) {
                    const sigla = option.dataset.sigla;
                    const nome = option.dataset.nome;
                    console.log(`üñ±Ô∏è Sele√ß√£o por ${eventType}`);
                    
                    selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
                }
            }
        });
    });
}

/**
 * LIMPAR CACHE (para ser chamado quando novas empresas forem adicionadas)
 */
function limparCacheEmpresas() {
    window.empresasCache = null;
    window.cacheTimestamp = null;
    console.log('üßπ [CACHE] Cache de empresas limpo');
}

// ‚úÖ INICIALIZAR EVENT DELEGATION QUANDO O M√ìDULO FOR CARREGADO
inicializarEventDelegationClique();

// EXPORTS NO FINAL
export {
    inicializarInputEmpresaHibrido,
    filtrarEmpresas,
    exibirSugestoes,
    exibirTodasEmpresas,
    navegarDropdown,
    selecionarEmpresa,
    selecionarOpcaoAtiva,
    carregarEmpresasComCache,
    limparCacheEmpresas,
    aplicarEventListenersDiretos
};
/* ==== FIM: data/adapters/obra-adapter-folder/empresa-autocomplete.js ==== */

/* ==== IN√çCIO: data/builders/empresa-cadastro-inline.js ==== */
/**
 * features/empresa-cadastro-inline.js
 * Sistema de cadastro inline de empresas para P√°gina 1
 * Integra√ß√£o com dados.json (empresas) e backup.json (obras)
 */

import { showSystemStatus } from '../../ui/components/status.js';
import { extractNumberFromText } from '../../data/utils/data-utils.js';

class EmpresaCadastroInline {
    constructor() {
        this.empresas = [];
        this.obrasExistentes = [];
        this.container = null;
        this.isActive = false;
        
        this.init();
    }

    async init() {
        await this.carregarDados();
        this.vincularEventos();
    }

    async carregarDados() {
        try {
            // Carregar empresas do dados.json
            const responseEmpresas = await fetch('/api/dados/empresas');
            if (responseEmpresas.ok) {
                const dados = await responseEmpresas.json();
                this.empresas = dados.empresas || [];
            }

            // Carregar obras existentes do backup.json
            const responseBackup = await fetch('/api/backup-completo');
            if (responseBackup.ok) {
                const backup = await responseBackup.json();
                this.obrasExistentes = backup.obras || [];
            }

            console.log(`üìä Dados carregados: ${this.empresas.length} empresas, ${this.obrasExistentes.length} obras`);
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados:', error);
        }
    }

    vincularEventos() {
        // Encontrar todos os spans de cadastro de empresas e transformar em bot√µes
        const spansCadastro = document.querySelectorAll('.projetc-header-record.very-dark span');
        
        spansCadastro.forEach(span => {
            // Transformar span em bot√£o
            const button = document.createElement('button');
            button.className = 'btn-empresa-cadastro';
            button.textContent = span.textContent;
            button.setAttribute('type', 'button');
            
            // Substituir span por bot√£o
            span.parentNode.replaceChild(button, span);
            
            // Vincular eventos
            button.addEventListener('click', (e) => this.ativarCadastro(e));
            button.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.ativarCadastro(e);
                }
            });
        });
    }

    ativarCadastro(event) {
        if (this.isActive) return;

        const span = event.target;
        this.container = span.closest('.projetc-header-record');
        
        if (!this.container) {
            console.error('‚ùå Container n√£o encontrado');
            return;
        }

        // Ocultar span e mostrar formul√°rio inline
        span.style.display = 'none';
        this.renderizarFormulario();
        this.isActive = true;

        console.log('‚úÖ Cadastro inline ativado');
    }

    /**
     * üÜï RENDERIZAR FORMUL√ÅRIO COM CAMPOS CORRETAMENTE LIBERADOS/BLOQUEADOS
     */
    renderizarFormulario() {
        const formHTML = this.criarHTMLFormulario();
        this.container.insertAdjacentHTML('beforeend', formHTML);
        
        // üÜï CONFIGURAR ESTADO DOS CAMPOS AP√ìS RENDERIZA√á√ÉO
        this.configurarEstadoCampos();
        
        // Vincular eventos do formul√°rio
        this.vincularEventosFormulario();
        
        // Focar no primeiro campo
        setTimeout(() => {
            const empresaInput = this.container.querySelector('#empresa-input');
            if (empresaInput) empresaInput.focus();
        }, 100);
    }

    /**
     * üÜï CONFIGURAR ESTADO CORRETO DOS CAMPOS - LIBERADOS vs BLOQUEADOS
     */
    configurarEstadoCampos() {
        // üü¢ CAMPOS QUE DEVEM FICAR SEMPRE LIBERADOS (edit√°veis)
        const camposLiberados = [
            'empresa-input',
            'cliente-final', 
            'codigo-cliente',
            'data-cadastro',
            'orcamentista-responsavel'
        ];
        
        camposLiberados.forEach(campoId => {
            const campo = this.container.querySelector(`#${campoId}`);
            if (campo) {
                // üü¢ REMOVER COMPLETAMENTE READONLY E DISABLED
                campo.removeAttribute('readonly');
                campo.removeAttribute('disabled');
                
                // üü¢ GARANTIR QUE ESTEJAM EDIT√ÅVEIS
                campo.readOnly = false;
                campo.disabled = false;
                
                // üü¢ ESTILOS VISUAIS DE CAMPO EDIT√ÅVEL
                campo.style.backgroundColor = '#ffffff';
                campo.style.borderColor = '#007bff';
                campo.style.cursor = 'text';
                campo.style.color = '#000000';
                
                console.log(`üü¢ Campo LIBERADO: ${campoId}`);
            }
        });
        
        // üî¥ CAMPOS QUE DEVEM FICAR BLOQUEADOS (somente leitura)
        const camposBloqueados = [
            'numero-cliente-final'
        ];
        
        camposBloqueados.forEach(campoId => {
            const campo = this.container.querySelector(`#${campoId}`);
            if (campo) {
                // üî¥ MANTER COMO SOMENTE LEITURA
                campo.readOnly = true;
                campo.setAttribute('readonly', 'true');
                
                // üî¥ ESTILOS VISUAIS DE CAMPO BLOQUEADO
                campo.style.backgroundColor = '#f8f9fa';
                campo.style.borderColor = '#ced4da';
                campo.style.cursor = 'not-allowed';
                campo.style.color = '#6c757d';
                
                console.log(`üî¥ Campo BLOQUEADO: ${campoId}`);
            }
        });
        
        // üü¢ CONFIGURA√á√ÉO ESPECIAL PARA O CAMPO DE DATA
        this.configurarCampoData();
    }

    /**
     * üÜï CONFIGURAR CAMPO DE DATA COMO EDIT√ÅVEL
     */
    configurarCampoData() {
        const dataCampo = this.container.querySelector('#data-cadastro');
        if (dataCampo) {
            // üü¢ REMOVER COMPLETAMENTE O READONLY
            dataCampo.removeAttribute('readonly');
            dataCampo.readOnly = false;
            
            // üü¢ TORNAR EDIT√ÅVEL
            dataCampo.disabled = false;
            
            // üü¢ MELHORAR USABILIDADE
            dataCampo.title = "Clique para editar a data (DD/MM/AAAA)";
            dataCampo.placeholder = "DD/MM/AAAA";
            
            // üü¢ ESTILOS DE CAMPO EDIT√ÅVEL
            dataCampo.style.backgroundColor = '#ffffff';
            dataCampo.style.borderColor = '#007bff';
            dataCampo.style.cursor = 'text';
            dataCampo.style.color = '#000000';
            
            // üü¢ ADICIONAR M√ÅSCARA DE DATA EM TEMPO REAL
            dataCampo.addEventListener('input', (e) => {
                this.aplicarMascaraData(e.target);
            });
            
            // üü¢ VALIDAR DATA AO PERDER O FOCO
            dataCampo.addEventListener('blur', (e) => {
                this.validarData(e.target);
            });
            
            console.log('üü¢ Campo de DATA configurado como edit√°vel');
        }
    }

    /**
     * üÜï APLICAR M√ÅSCARA DE DATA EM TEMPO REAL
     */
    aplicarMascaraData(input) {
        let value = input.value.replace(/\D/g, '');
        
        // Limitar a 8 d√≠gitos (DDMMAAAA)
        if (value.length > 8) {
            value = value.substring(0, 8);
        }
        
        // Aplicar m√°scara
        if (value.length > 4) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4);
        } else if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        
        input.value = value;
    }

    /**
     * üÜï VALIDAR DATA AO PERDER FOCO
     */
    validarData(input) {
        const valor = input.value.trim();
        
        if (!valor) return true; // Campo vazio √© v√°lido
        
        // Validar formato DD/MM/AAAA
        const regexData = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        const match = valor.match(regexData);
        
        if (!match) {
            showSystemStatus('Formato de data inv√°lido. Use DD/MM/AAAA', 'warning');
            input.focus();
            return false;
        }
        
        const dia = parseInt(match[1], 10);
        const mes = parseInt(match[2], 10);
        const ano = parseInt(match[3], 10);
        
        // Validar valores
        if (mes < 1 || mes > 12) {
            showSystemStatus('M√™s deve estar entre 01 e 12', 'warning');
            input.focus();
            return false;
        }
        
        if (dia < 1 || dia > 31) {
            showSystemStatus('Dia deve estar entre 01 e 31', 'warning');
            input.focus();
            return false;
        }
        
        // Validar fevereiro e meses com 30 dias
        const data = new Date(ano, mes - 1, dia);
        if (data.getDate() !== dia || data.getMonth() + 1 !== mes || data.getFullYear() !== ano) {
            showSystemStatus('Data inv√°lida para o m√™s especificado', 'warning');
            input.focus();
            return false;
        }
        
        return true;
    }

    criarHTMLFormulario() {
        return `
        <div class="empresa-cadastro-inline" id="empresa-cadastro-inline">
            <div class="empresa-form-grid">
                <!-- Empresa üü¢ EDIT√ÅVEL -->
                <div class="form-group">
                    <label for="empresa-input">Empresa *</label>
                    <input type="text" 
                        id="empresa-input" 
                        class="empresa-input" 
                        placeholder="Digite sigla ou nome..."
                        autocomplete="off">
                    <div class="autocomplete-suggestions" id="empresa-suggestions"></div>
                </div>

                <!-- N√∫mero Cliente Final üî¥ SOMENTE LEITURA -->
                <div class="form-group">
                    <label for="numero-cliente-final">N√∫mero Cliente Final</label>
                    <input type="text" 
                        id="numero-cliente-final" 
                        class="numero-cliente-final" 
                        readonly
                        placeholder="Ser√° calculado automaticamente">
                </div>

                <!-- Cliente Final üü¢ EDIT√ÅVEL -->
                <div class="form-group">
                    <label for="cliente-final">Cliente Final</label>
                    <input type="text" 
                        id="cliente-final" 
                        class="cliente-final" 
                        placeholder="Nome do cliente final">
                </div>

                <!-- C√≥digo Cliente üü¢ EDIT√ÅVEL -->
                <div class="form-group">
                    <label for="codigo-cliente">C√≥digo Cliente</label>
                    <input type="text" 
                        id="codigo-cliente" 
                        class="codigo-cliente" 
                        placeholder="C√≥digo interno do cliente">
                </div>

                <!-- Data do Cadastro üü¢ EDIT√ÅVEL -->
                <div class="form-group">
                    <label for="data-cadastro">Data do Cadastro</label>
                    <input type="text" 
                        id="data-cadastro" 
                        class="data-cadastro" 
                        placeholder="DD/MM/AAAA"
                        value="${new Date().toLocaleDateString('pt-BR')}">
                </div>

                <!-- Or√ßamentista Respons√°vel üü¢ EDIT√ÅVEL -->
                <div class="form-group">
                    <label for="orcamentista-responsavel">Or√ßamentista Respons√°vel</label>
                    <input type="text" 
                        id="orcamentista-responsavel" 
                        class="orcamentista-responsavel" 
                        placeholder="Nome do or√ßamentista">
                </div>
            </div>

            <div class="empresa-form-actions">
                <button type="button" class="btn btn-cancel" onclick="window.empresaCadastro.cancelarCadastro()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-confirm" onclick="window.empresaCadastro.prepararDados()">
                    Confirmar Dados
                </button>
            </div>
        </div>
        `;
    }

    vincularEventosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.addEventListener('input', (e) => this.buscarEmpresas(e.target.value));
            empresaInput.addEventListener('blur', () => {
                setTimeout(() => this.ocultarSugestoes(), 200);
            });
            empresaInput.addEventListener('keydown', (e) => this.tratarTecladoAutocomplete(e));
        }
    }

    async buscarEmpresas(termo) {
        if (!termo || termo.length < 2) {
            this.ocultarSugestoes();
            return;
        }

        const termoNormalizado = this.normalizarTermo(termo);
        const sugestoes = this.filtrarEmpresas(termoNormalizado);
        
        this.exibirSugestoes(sugestoes);
    }

    normalizarTermo(termo) {
        return termo.trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    filtrarEmpresas(termo) {
        return this.empresas.filter(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const primeiroNome = nome.split(' ')[0].toUpperCase();
            
            return sigla === termo || 
                   nomeNormalizado.includes(termo) ||
                   primeiroNome.includes(termo);
        });
    }

    exibirSugestoes(sugestoes) {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (!containerSugestoes) return;

        if (sugestoes.length === 0) {
            this.ocultarSugestoes();
            return;
        }

        const html = sugestoes.map(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const primeiroNome = nome.split(' ')[0];

            return `
                <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}">
                    <strong>${sigla}</strong> - ${primeiroNome}
                </div>
            `;
        }).join('');

        containerSugestoes.innerHTML = html;
        containerSugestoes.style.display = 'block';

        // Vincular eventos de clique nas sugest√µes
        containerSugestoes.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                const sigla = item.dataset.sigla;
                const nome = item.dataset.nome;
                this.selecionarEmpresa(sigla, nome);
            });
        });
    }

    ocultarSugestoes() {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (containerSugestoes) {
            containerSugestoes.style.display = 'none';
        }
    }

    tratarTecladoAutocomplete(event) {
        const sugestoes = this.container.querySelectorAll('.suggestion-item');
        if (sugestoes.length === 0) return;

        const sugestaoAtiva = this.container.querySelector('.suggestion-item.active');
        
        switch (event.key) {
            case 'ArrowDown':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, 1);
                break;
            case 'ArrowUp':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, -1);
                break;
            case 'Enter':
                event.preventDefault();
                if (sugestaoAtiva) {
                    const sigla = sugestaoAtiva.dataset.sigla;
                    const nome = sugestaoAtiva.dataset.nome;
                    this.selecionarEmpresa(sigla, nome);
                }
                break;
            case 'Escape':
                this.ocultarSugestoes();
                break;
        }
    }

    navegarSugestoes(sugestoes, atual, direcao) {
        let index = Array.from(sugestoes).indexOf(atual);
        
        if (index === -1) index = direcao > 0 ? -1 : sugestoes.length;
        
        index = (index + direcao + sugestoes.length) % sugestoes.length;
        
        sugestoes.forEach(s => s.classList.remove('active'));
        sugestoes[index].classList.add('active');
    }

    selecionarEmpresa(sigla, nome) {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.value = `${sigla} - ${nome}`;
            empresaInput.dataset.siglaSelecionada = sigla;
            empresaInput.dataset.nomeSelecionado = nome;
        }

        this.ocultarSugestoes();
        this.calcularNumeroClienteFinal(sigla);
    }

    calcularNumeroClienteFinal(sigla) {
        // Filtrar obras existentes pela sigla
        const obrasDaEmpresa = this.obrasExistentes.filter(obra => {
            return obra.empresaSigla === sigla || 
                   (obra.idGerado && obra.idGerado.startsWith(`obra_${sigla}_`));
        });

        // Encontrar maior n√∫mero existente
        let maiorNumero = 0;
        obrasDaEmpresa.forEach(obra => {
            if (obra.numeroClienteFinal && obra.numeroClienteFinal > maiorNumero) {
                maiorNumero = obra.numeroClienteFinal;
            }
            
            // Tamb√©m tentar extrair do ID gerado
            if (obra.idGerado) {
                const match = obra.idGerado.match(new RegExp(`obra_${sigla}_(\\d+)`));
                if (match) {
                    const numero = parseInt(match[1]);
                    if (numero > maiorNumero) maiorNumero = numero;
                }
            }
        });

        const novoNumero = maiorNumero + 1;
        
        const numeroInput = this.container.querySelector('#numero-cliente-final');
        if (numeroInput) {
            numeroInput.value = novoNumero;
        }

        // Atualizar preview do ID da obra
        this.atualizarPreviewIdObra(sigla, novoNumero);
    }

    atualizarPreviewIdObra(sigla, numero) {
        const idObraValue = this.container.querySelector('#obra-id-value');
        
        if (idObraContainer && idObraValue) {
            const idObra = `obra_${sigla}_${numero}`;
            idObraValue.textContent = idObra;
            idObraContainer.style.display = 'block';
        }
    }

    async prepararDados() {
        const dados = this.coletarDadosFormulario();
        
        if (!this.validarDados(dados)) {
            return;
        }

        // Verificar se precisa cadastrar nova empresa
        if (!dados.empresaExistente) {
            const sucesso = await this.cadastrarNovaEmpresa(dados.sigla, dados.nomeEmpresa);
            if (!sucesso) return;
        }

        // Preparar dados para a obra
        this.prepararDadosObra(dados);
        
        showSystemStatus('Dados da empresa preparados! Agora salve a obra.', 'success');
        
        // Ocultar formul√°rio mas manter dados preparados
        this.ocultarFormulario();
    }

    coletarDadosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        const siglaSelecionada = empresaInput?.dataset.siglaSelecionada;
        const nomeSelecionado = empresaInput?.dataset.nomeSelecionado;
        
        return {
            empresaInput: empresaInput?.value || '',
            sigla: siglaSelecionada,
            nomeEmpresa: nomeSelecionado,
            empresaExistente: !!siglaSelecionada,
            numeroClienteFinal: this.container.querySelector('#numero-cliente-final')?.value || '',
            clienteFinal: this.container.querySelector('#cliente-final')?.value || '',
            codigoCliente: this.container.querySelector('#codigo-cliente')?.value || '',
            dataCadastro: this.container.querySelector('#data-cadastro')?.value || '',
            orcamentistaResponsavel: this.container.querySelector('#orcamentista-responsavel')?.value || ''
        };
    }

    /**
     * üÜï VALIDA√á√ÉO CORRIGIDA DA SIGLA - COM REGEX E TOOLTIP
     */
    validarDados(dados) {
        if (!dados.empresaInput.trim()) {
            showSystemStatus('Por favor, informe a empresa', 'error');
            return false;
        }

        if (!dados.empresaExistente) {
            // üÜï VALIDA√á√ÉO CORRIGIDA DA SIGLA - REGEX MELHORADO
            const regexSigla = /^[A-Z]{2,6}$/; // 2 a 6 letras mai√∫sculas
            
            // Verificar se usu√°rio digitou apenas sigla
            if (regexSigla.test(dados.empresaInput)) {
                // Usu√°rio digitou apenas sigla - solicitar nome completo
                const nomeCompleto = prompt(`Voc√™ digitou apenas a sigla "${dados.empresaInput}". Por favor, informe o nome completo da empresa:`);
                if (!nomeCompleto || !nomeCompleto.trim()) {
                    showSystemStatus('Nome completo da empresa √© obrigat√≥rio', 'error');
                    return false;
                }
                
                // üÜï VALIDAR FORMATO DO NOME
                if (nomeCompleto.trim().length < 3) {
                    showSystemStatus('Nome da empresa deve ter pelo menos 3 caracteres', 'error');
                    return false;
                }
                
                dados.nomeEmpresa = nomeCompleto.trim();
                dados.sigla = dados.empresaInput.toUpperCase();
                
            } else {
                // Usu√°rio digitou nome - sugerir sigla v√°lida
                const primeiraPalavra = dados.empresaInput.split(' ')[0];
                const siglaSugerida = primeiraPalavra.substring(0, 3).toUpperCase();
                
                // üÜï GARANTIR QUE SIGLA TENHA FORMATO V√ÅLIDO
                let siglaConfirmada = prompt(`Empresa n√£o encontrada. Sugerimos a sigla "${siglaSugerida}". Confirme ou digite outra sigla (2-6 letras mai√∫sculas):`, siglaSugerida);
                
                if (!siglaConfirmada) {
                    showSystemStatus('Sigla √© obrigat√≥ria', 'error');
                    return false;
                }
                
                // üÜï NORMALIZAR SIGLA
                siglaConfirmada = siglaConfirmada.trim().toUpperCase().replace(/[^A-Z]/g, '');
                
                // üÜï VALIDAR FORMATO DA SIGLA
                if (!regexSigla.test(siglaConfirmada)) {
                    showSystemStatus('Sigla deve conter 2 a 6 letras mai√∫sculas, sem espa√ßos ou caracteres especiais', 'error');
                    return false;
                }
                
                dados.sigla = siglaConfirmada;
                dados.nomeEmpresa = dados.empresaInput;
            }
        }

        return true;
    }

    async cadastrarNovaEmpresa(sigla, nome) {
        try {
            // Verificar se sigla j√° existe
            const siglaExistente = this.empresas.find(empresaObj => {
                const [siglaExistente] = Object.keys(empresaObj);
                return siglaExistente === sigla;
            });

            if (siglaExistente) {
                showSystemStatus(`Sigla ${sigla} j√° est√° em uso. Escolha outra sigla.`, 'error');
                return false;
            }

            // Adicionar nova empresa
            const novaEmpresa = { [sigla]: nome };
            this.empresas.push(novaEmpresa);

            // Salvar no dados.json
            const response = await fetch('/api/dados/empresas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(novaEmpresa)
            });

            if (!response.ok) {
                throw new Error('Erro ao salvar empresa');
            }

            showSystemStatus(`Empresa ${sigla} - ${nome} cadastrada com sucesso!`, 'success');
            return true;

        } catch (error) {
            console.error('‚ùå Erro ao cadastrar nova empresa:', error);
            showSystemStatus('Erro ao cadastrar empresa', 'error');
            return false;
        }
    }

    /**
     * Atualiza o header da obra com a sigla e numera√ß√£o
     * @param {HTMLElement} obraElement - Elemento da obra
     * @param {Object} dadosEmpresa - Dados da empresa
     */

    atualizarHeaderObra(obraElement, dadosEmpresa) {
        try {
            const headerSpacer = obraElement.querySelector('.obra-header-spacer');
            if (!headerSpacer) {
                console.error('‚ùå Elemento .obra-header-spacer n√£o encontrado');
                return;
            }

            // Limpar conte√∫do atual
            headerSpacer.innerHTML = '';

            if (dadosEmpresa.empresaSigla && dadosEmpresa.numeroClienteFinal) {
                // üÜï CRIAR SPAN COM IDENTIFICADOR DA EMPRESA (n√£o bot√£o)
                const span = document.createElement('span');
                span.className = 'empresa-identifier-display';
                const textoHeader = `${dadosEmpresa.empresaSigla}-${dadosEmpresa.numeroClienteFinal}`;
                span.textContent = textoHeader;
                span.setAttribute('data-tooltip', this.criarTooltipEmpresa(dadosEmpresa));
                
                // üÜï ADICIONAR SISTEMA DE TOOLTIP VIA JAVASCRIPT
                this.inicializarTooltipJavaScript(span);
                
                headerSpacer.appendChild(span);
                console.log(`‚úÖ Header da obra atualizado para SPAN: ${textoHeader}`);
            } else {
                // Bot√£o padr√£o para cadastro
                this.resetHeaderObra(headerSpacer);
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar header da obra:', error);
        }
    }

    /**
     * üÜï INICIALIZAR TOOLTIP - VERS√ÉO COM AUTO-CLOSE NO MOBILE
     */
    inicializarTooltipJavaScript(element) {
        console.log('üîß Inicializando tooltip RESPONSIVO com auto-close');
        
        // üÜï DETECTAR SE √â MOBILE
        const isMobile = window.innerWidth <= 768;
        
        // üÜï VARI√ÅVEL PARA CONTROLAR O TIMER
        let autoCloseTimer = null;
        
        // FOR√áAR ESTILOS PARA GARANTIR VISIBILIDADE
        element.style.position = 'relative';
        element.style.overflow = 'visible';
        element.style.zIndex = '100';
        
        // Criar tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'empresa-tooltip';
        
        // üÜï ADICIONAR CLASSE PARA MOBILE
        if (isMobile) {
            tooltip.classList.add('empresa-tooltip-mobile');
            
            // üÜï ADICIONAR BOT√ÉO DE FECHAR NO MOBILE
            const closeButton = document.createElement('button');
            closeButton.className = 'empresa-tooltip-close';
            closeButton.innerHTML = '√ó';
            closeButton.setAttribute('aria-label', 'Fechar tooltip');
            tooltip.appendChild(closeButton);
            
            // üÜï EVENTO PARA FECHAR COM BOT√ÉO
            closeButton.addEventListener('click', (e) => {
                e.stopPropagation();
                esconderTooltip();
            });
        }
        
        // üÜï POSICIONAR O TOOLTIP FORA DA HIERARQUIA DO ELEMENTO
        document.body.appendChild(tooltip);
        
        // üÜï FUN√á√ÉO PARA INICIAR TIMER DE AUTO-CLOSE
        const iniciarAutoCloseTimer = () => {
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
            }
            // üÜï FECHAR AUTOMATICAMENTE AP√ìS 5 SEGUNDOS NO MOBILE
            autoCloseTimer = setTimeout(() => {
                console.log('‚è∞ Auto-close do tooltip no mobile');
                esconderTooltip();
            }, 5000); // 5 segundos
        };
        
        // üÜï FUN√á√ÉO PARA CANCELAR TIMER
        const cancelarAutoCloseTimer = () => {
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
                autoCloseTimer = null;
            }
        };
        
        // üÜï FUN√á√ÉO PARA ATUALIZAR POSI√á√ÉO DO TOOLTIP - VERS√ÉO RESPONSIVA
        const atualizarPosicaoTooltip = () => {
            const rect = element.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const isMobileNow = window.innerWidth <= 768;
            
            if (isMobileNow) {
                // üÜï POSICIONAMENTO PARA MOBILE
                tooltip.style.position = 'fixed';
                tooltip.style.left = '50%';
                tooltip.style.top = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                tooltip.style.bottom = 'auto';
                tooltip.style.right = 'auto';
                tooltip.style.width = '90vw';
                tooltip.style.maxWidth = '320px';
                tooltip.style.maxHeight = '70vh';
                tooltip.style.overflowY = 'auto';
                tooltip.style.zIndex = '100000';
            } else {
                // üÜï POSICIONAMENTO PARA DESKTOP
                tooltip.style.position = 'fixed';
                tooltip.style.left = (rect.left + scrollX + (rect.width / 2)) + 'px';
                tooltip.style.bottom = (window.innerHeight - rect.top - scrollY + 8) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.width = 'auto';
                tooltip.style.maxWidth = '380px';
                tooltip.style.maxHeight = 'none';
            }
        };
        
        // üÜï FUN√á√ÉO PARA MOSTRAR TOOLTIP
        const mostrarTooltip = () => {
            console.log('üê≠ Mouse ENTER/TAP no span');
            const tooltipText = element.getAttribute('data-tooltip');
            if (tooltipText) {
                // üÜï ATUALIZAR CONTE√öDO (exceto bot√£o de fechar se existir)
                const closeBtn = tooltip.querySelector('.empresa-tooltip-close');
                tooltip.innerHTML = tooltipText;
                if (closeBtn && isMobile) {
                    tooltip.appendChild(closeBtn);
                }
                
                tooltip.classList.add('show');
                atualizarPosicaoTooltip();
                
                // üÜï INICIAR TIMER DE AUTO-CLOSE NO MOBILE
                if (isMobile) {
                    iniciarAutoCloseTimer();
                }
                
                console.log('üî¶ Tooltip mostrado:', tooltipText);
            }
        };
        
        // üÜï FUN√á√ÉO PARA ESCONDER TOOLTIP
        const esconderTooltip = () => {
            console.log('üê≠ Escondendo tooltip');
            tooltip.classList.remove('show');
            cancelarAutoCloseTimer(); // üÜï CANCELAR TIMER AO ESCONDER
        };
        
        // üÜï EVENT LISTENERS DIFERENCIADOS PARA MOBILE/DESKTOP
        if (isMobile) {
            // üÜï PARA MOBILE: USAR CLICK/TOUCH
            element.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (tooltip.classList.contains('show')) {
                    esconderTooltip();
                } else {
                    mostrarTooltip();
                }
            });
            
            // üÜï FECHAR TOOLTIP AO CLICAR FORA (MOBILE)
            document.addEventListener('click', (e) => {
                if (!element.contains(e.target) && !tooltip.contains(e.target)) {
                    esconderTooltip();
                }
            });
            
            // üÜï FECHAR TOOLTIP AO ROLAR (MOBILE)
            window.addEventListener('scroll', esconderTooltip);
            
            // üÜï FECHAR TOOLTIP AO MUDAR ORIENTA√á√ÉO (MOBILE)
            window.addEventListener('orientationchange', esconderTooltip);
            
        } else {
            // üÜï PARA DESKTOP: USAR HOVER
            element.addEventListener('mouseenter', mostrarTooltip);
            element.addEventListener('mouseleave', esconderTooltip);
        }
        
        // üÜï REINICIAR TIMER SE O USU√ÅRIO INTERAGIR COM O TOOLTIP (MOBILE)
        if (isMobile) {
            tooltip.addEventListener('touchstart', () => {
                cancelarAutoCloseTimer(); // Cancelar timer atual
                iniciarAutoCloseTimer();  // Reiniciar timer
            });
            
            tooltip.addEventListener('click', () => {
                cancelarAutoCloseTimer(); // Cancelar timer atual  
                iniciarAutoCloseTimer();  // Reiniciar timer
            });
        }
        
        // üÜï ATUALIZAR POSI√á√ÉO AO ROLAR/REDIMENSIONAR
        window.addEventListener('scroll', () => {
            if (tooltip.classList.contains('show')) {
                atualizarPosicaoTooltip();
            }
        });
        
        window.addEventListener('resize', () => {
            if (tooltip.classList.contains('show')) {
                atualizarPosicaoTooltip();
            }
            
            // üÜï RECARREGAR COMPORTAMENTO AO REDIMENSIONAR ENTRE MOBILE/DESKTOP
            const novaCondicaoMobile = window.innerWidth <= 768;
            if (isMobile !== novaCondicaoMobile) {
                console.log('üîÑ Mudan√ßa entre mobile/desktop detectada');
                esconderTooltip();
                // Recriar tooltip com novo comportamento
                tooltip.remove();
                this.inicializarTooltipJavaScript(element);
            }
        });
        
        // üÜï LIMPAR EVENT LISTENERS QUANDO ELEMENTO FOR REMOVIDO
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.removedNodes.length > 0) {
                    const removed = Array.from(mutation.removedNodes);
                    if (removed.includes(element) || element.parentNode === null) {
                        tooltip.remove();
                        cancelarAutoCloseTimer();
                        window.removeEventListener('scroll', atualizarPosicaoTooltip);
                        window.removeEventListener('resize', atualizarPosicaoTooltip);
                        document.removeEventListener('click', esconderTooltip);
                        window.removeEventListener('orientationchange', esconderTooltip);
                        observer.disconnect();
                    }
                }
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        
        console.log('‚úÖ Tooltip inicializado (com auto-close) - Mobile:', isMobile);
    }



    /**
     * Cria texto de tooltip com informa√ß√µes completas da empresa
     * @param {Object} dadosEmpresa - Dados da empresa
     * @returns {string} Texto do tooltip
     */
    criarTooltipEmpresa(dadosEmpresa) {
        const partes = [];
        
        if (dadosEmpresa.empresaNome) {
            partes.push(`Empresa: ${dadosEmpresa.empresaNome}`);
        }
        if (dadosEmpresa.clienteFinal) {
            partes.push(`Cliente: ${dadosEmpresa.clienteFinal}`);
        }
        if (dadosEmpresa.codigoCliente) {
            partes.push(`C√≥digo: ${dadosEmpresa.codigoCliente}`);
        }
        if (dadosEmpresa.dataCadastro) {
            // üÜï FORMATAR DATA PARA dd/mm/aaaa
            const dataFormatada = this.formatarDataParaTooltip(dadosEmpresa.dataCadastro);
            partes.push(`Data: ${dataFormatada}`);
        }
        if (dadosEmpresa.orcamentistaResponsavel) {
            partes.push(`Or√ßamentista: ${dadosEmpresa.orcamentistaResponsavel}`);
        }
        
        return partes.join('\n');
    }

    /**
     * Formata data para o formato dd/mm/aaaa no tooltip
     * @param {string} dataString - Data em qualquer formato
     * @returns {string} Data formatada como dd/mm/aaaa
     */
    formatarDataParaTooltip(dataString) {
        if (!dataString) return '';
        
        try {
            // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }
            
            // Tentar converter para Date
            const data = new Date(dataString);
            
            if (isNaN(data.getTime())) {
                console.warn(`‚ö†Ô∏è Data inv√°lida no tooltip: ${dataString}`);
                return dataString;
            }
            
            // Formatar para dd/mm/aaaa
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            
            return `${dia}/${mes}/${ano}`;
            
        } catch (error) {
            console.error(`‚ùå Erro ao formatar data para tooltip ${dataString}:`, error);
            return dataString;
        }
    }

    /**
     * Reseta o header para o estado original
     * @param {HTMLElement} headerSpacer - Elemento do header
     */
    resetHeaderObra(headerSpacer) {
        const button = document.createElement('button');
        button.className = 'btn-empresa-cadastro';
        button.textContent = 'Adicionar campos de cadastro de empresas';
        button.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const obraBlock = headerSpacer.closest('.obra-block');
            if (obraBlock && obraBlock.dataset.obraId) {
                window.ativarCadastroEmpresa(obraBlock.dataset.obraId);
            }
        };
        
        headerSpacer.innerHTML = '';
        headerSpacer.appendChild(button);
    }

    /**
     * Prepara dados da obra e atualiza o header
     * @param {Object} dados - Dados coletados do formul√°rio
     */
    prepararDadosObra(dados) {
        // Armazenar dados no container da obra para uso posterior
        const obraBlock = this.container.closest('.obra-block');
        if (obraBlock) {
            obraBlock.dataset.empresaSigla = dados.sigla;
            obraBlock.dataset.empresaNome = dados.nomeEmpresa;
            obraBlock.dataset.numeroClienteFinal = dados.numeroClienteFinal;
            obraBlock.dataset.clienteFinal = dados.clienteFinal;
            obraBlock.dataset.codigoCliente = dados.codigoCliente;
            
            // üÜï USAR DATA FORMATADA
            const dataFormatada = this.formatarData(dados.dataCadastro);
            obraBlock.dataset.dataCadastro = dataFormatada;
            
            obraBlock.dataset.orcamentistaResponsavel = dados.orcamentistaResponsavel;
            obraBlock.dataset.idGerado = `obra_${dados.sigla}_${dados.numeroClienteFinal}`;
            
            // üÜï ATUALIZAR HEADER DA OBRA
            this.atualizarHeaderObra(obraBlock, {
                empresaSigla: dados.sigla,
                empresaNome: dados.nomeEmpresa,
                numeroClienteFinal: dados.numeroClienteFinal,
                clienteFinal: dados.clienteFinal,
                codigoCliente: dados.codigoCliente,
                dataCadastro: dataFormatada, // üÜï DATA FORMATADA
                orcamentistaResponsavel: dados.orcamentistaResponsavel
            });
            
            console.log('üì¶ Dados da obra preparados:', obraBlock.dataset);
        }
    }

    cancelarCadastro() {
        this.ocultarFormulario();
        this.mostrarSpanOriginal();
        
        // üÜï RESETAR HEADER SE N√ÉO HOUVER DADOS DE EMPRESA
        const obraBlock = this.container.closest('.obra-block');
        if (obraBlock) {
            const headerSpacer = obraBlock.querySelector('.obra-header-spacer span');
            if (headerSpacer && !obraBlock.dataset.empresaSigla) {
                this.resetHeaderObra(headerSpacer);
            }
        }
    }

    ocultarFormulario() {
        const form = this.container.querySelector('#empresa-cadastro-inline');
        if (form) {
            form.remove();
        }
        this.isActive = false;
    }

    mostrarSpanOriginal() {
        const span = this.container.querySelector('span');
        if (span) {
            span.style.display = 'inline';
        }
    }

    // M√©todo para obter dados preparados (usado pelo sistema de salvamento)
    obterDadosPreparados(obraId) {
        const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraBlock) return null;

        return {
            empresaSigla: obraBlock.dataset.empresaSigla,
            empresaNome: obraBlock.dataset.empresaNome,
            numeroClienteFinal: obraBlock.dataset.numeroClienteFinal ? parseInt(obraBlock.dataset.numeroClienteFinal) : null,
            clienteFinal: obraBlock.dataset.clienteFinal,
            codigoCliente: obraBlock.dataset.codigoCliente,
            dataCadastro: obraBlock.dataset.dataCadastro,
            orcamentistaResponsavel: obraBlock.dataset.orcamentistaResponsavel,
            idGerado: obraBlock.dataset.idGerado
        };
    }
    /**
     * Formata data para dd/mm/aaaa
     */
    formatarData(dataString) {
        if (!dataString) return '';
        
        try {
            // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }
            
            const data = new Date(dataString);
            
            if (isNaN(data.getTime())) {
                console.warn(`‚ö†Ô∏è Data inv√°lida: ${dataString}`);
                return dataString;
            }
            
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            
            return `${dia}/${mes}/${ano}`;
            
        } catch (error) {
            console.error(`‚ùå Erro ao formatar data ${dataString}:`, error);
            return dataString;
        }
    }
}

// Exporta√ß√£o e inicializa√ß√£o
export default EmpresaCadastroInline;

if (typeof window !== 'undefined') {
    window.EmpresaCadastroInline = EmpresaCadastroInline;
    
    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        window.empresaCadastro = new EmpresaCadastroInline();
    });
}


/* ==== FIM: data/builders/empresa-cadastro-inline.js ==== */

/* ==== IN√çCIO: data/builders/data-builders-folder/empresa-data-extractor.js ==== */
// data/builders/data-builders-folder/empresa-data-extractor.js

/**
 * Extrai dados de empresa cadastrados inline
 */


function extractEmpresaData(obraElement) {
    const empresaData = {};
    
    if (!obraElement) {
        console.error('‚ùå Elemento da obra √© nulo para extra√ß√£o de empresa');
        return empresaData;
    }

    console.log('üîç [EXTRACT EMPRESA] INICIANDO extra√ß√£o para obra:', obraElement.dataset.obraId);

    const camposEmpresa = [
        'empresaSigla', 'empresaNome', 'numeroClienteFinal', 
        'clienteFinal', 'codigoCliente', 'dataCadastro', 
        'orcamentistaResponsavel', 'idGerado'
    ];

    // üÜï ESTRAT√âGIA: PRIMEIRO buscar nos INPUTS ATUAIS (valores mais recentes)
    console.log('üîç [EXTRACT EMPRESA] FASE 1 - Buscando nos INPUTS ATUAIS do formul√°rio...');
    
    const formEmpresa = obraElement.querySelector('.empresa-formulario-ativo');
    if (formEmpresa) {
        console.log('üìã [EXTRACT EMPRESA] Formul√°rio ativo encontrado, extraindo dados atuais...');
        
        const mapeamentoCampos = {
            // üÜï PRIORIDADE: Inputs de cadastro/edi√ß√£o (valores mais recentes)
            'empresa-input-cadastro': ['empresaSigla', 'empresaNome'],
            'numero-cliente-final-cadastro': ['numeroClienteFinal'], 
            'cliente-final-cadastro': ['clienteFinal'],
            'codigo-cliente-cadastro': ['codigoCliente'],
            'data-cadastro-cadastro': ['dataCadastro'],
            'orcamentista-responsavel-cadastro': ['orcamentistaResponsavel'],
            
            // üÜï Inputs de visualiza√ß√£o/readonly
            'empresa-input-readonly': ['empresaSigla', 'empresaNome'],
            'numero-cliente-final-readonly': ['numeroClienteFinal'],
            'cliente-final-input': ['clienteFinal'],
            'codigo-cliente-input': ['codigoCliente'], 
            'data-cadastro-readonly': ['dataCadastro'],
            'orcamentista-responsavel-input': ['orcamentistaResponsavel']
        };

        Object.entries(mapeamentoCampos).forEach(([inputClass, camposAlvo]) => {
            const input = formEmpresa.querySelector(`.${inputClass}`);
            
            if (input && input.value && input.value.trim() !== '') {
                let valor = input.value.trim();
                console.log(`‚úÖ [EXTRACT EMPRESA] Input ${inputClass} encontrado: "${valor}"`);
                
                camposAlvo.forEach(campo => {
                    if (!empresaData[campo]) { // S√≥ preenche se ainda n√£o tem valor
                        if (campo === 'numeroClienteFinal') {
                            empresaData[campo] = parseInt(valor) || 0;
                            console.log(`üî¢ [EXTRACT EMPRESA] ${campo} convertido para n√∫mero: ${empresaData[campo]}`);
                        } else if (campo === 'empresaSigla' && valor.includes(' - ')) {
                            // Extrair sigla e nome do formato "SIGLA - Nome"
                            const partes = valor.split(' - ');
                            empresaData.empresaSigla = partes[0];
                            if (partes[1]) {
                                empresaData.empresaNome = partes[1];
                            }
                            console.log(`üè¢ [EXTRACT EMPRESA] Empresa extra√≠da: ${empresaData.empresaSigla} - ${empresaData.empresaNome}`);
                        } else if (campo === 'empresaNome' && !valor.includes(' - ')) {
                            // Se for apenas o nome, sem sigla
                            empresaData[campo] = valor;
                        } else if (campo !== 'empresaSigla') {
                            // Para outros campos
                            empresaData[campo] = valor;
                        }
                    }
                });
            }
        });

        // üÜï BUSCAR DADOS DO AUTOCOMPLETE (prioridade m√°xima)
        const empresaInput = formEmpresa.querySelector('.empresa-input-cadastro');
        if (empresaInput && empresaInput.dataset.siglaSelecionada) {
            console.log('üéØ [EXTRACT EMPRESA] Dados do autocomplete encontrados:', {
                sigla: empresaInput.dataset.siglaSelecionada,
                nome: empresaInput.dataset.nomeSelecionado
            });
            
            // üÜï SOBRESCREVER com dados do autocomplete (s√£o os mais confi√°veis)
            empresaData.empresaSigla = empresaInput.dataset.siglaSelecionada;
            empresaData.empresaNome = empresaInput.dataset.nomeSelecionado;
        }
    } else {
        console.log('‚ùå [EXTRACT EMPRESA] Formul√°rio ativo n√£o encontrado');
    }

    // üÜï FASE 2: S√≥ buscar nos data attributes os campos que ainda est√£o faltando
    console.log('üîç [EXTRACT EMPRESA] FASE 2 - Buscando campos faltantes nos data attributes...');
    
    const camposFaltantes = camposEmpresa.filter(campo => !empresaData[campo]);
    console.log(`üìã [EXTRACT EMPRESA] Campos ainda faltantes: ${camposFaltantes.join(', ')}`);
    
    camposFaltantes.forEach(campo => {
        const valorDataAttr = obraElement.dataset[campo];
        if (valorDataAttr) {
            if (campo === 'numeroClienteFinal') {
                empresaData[campo] = parseInt(valorDataAttr) || 0;
            } else {
                empresaData[campo] = valorDataAttr;
            }
            console.log(`üì¶ [EXTRACT EMPRESA] ${campo} extra√≠do do data-attribute: ${empresaData[campo]}`);
        }
    });

    // üÜï VALIDA√á√ÉO FINAL E CORRE√á√ïES
    console.log('üîç [EXTRACT EMPRESA] FASE 3 - Valida√ß√£o final...');
    
    // üÜï CORRIGIR: Se temos empresaSigla mas n√£o temos empresaNome (ou vice-versa)
    if (empresaData.empresaSigla && !empresaData.empresaNome) {
        console.log('‚ö†Ô∏è [EXTRACT EMPRESA] Temos sigla mas n√£o nome, buscando nome...');
        // Tentar buscar o nome de outra fonte
        const empresaInput = formEmpresa?.querySelector('.empresa-input-cadastro, .empresa-input-readonly');
        if (empresaInput?.value && empresaInput.value.includes(' - ')) {
            const partes = empresaInput.value.split(' - ');
            if (partes[0] === empresaData.empresaSigla && partes[1]) {
                empresaData.empresaNome = partes[1];
                console.log(`‚úÖ [EXTRACT EMPRESA] Nome recuperado: ${empresaData.empresaNome}`);
            }
        }
    }

    // üÜï CORRIGIR: Formatar data se necess√°rio
    if (empresaData.dataCadastro && !empresaData.dataCadastro.includes('T')) {
        console.log(`üìÖ [EXTRACT EMPRESA] Data no formato local: ${empresaData.dataCadastro}`);
        // Manter formato local se n√£o for ISO
    }

    console.log('üè¢ [EXTRACT EMPRESA] DADOS FINAIS EXTRA√çDOS:', empresaData);
    
    // üÜï VERIFICA√á√ÉO CR√çTICA
    const statusCampos = {};
    camposEmpresa.forEach(campo => {
        statusCampos[campo] = empresaData[campo] 
            ? `‚úÖ ${empresaData[campo]}` 
            : '‚ùå AUSENTE';
    });
    
    console.log('üìã [EXTRACT EMPRESA] STATUS FINAL:', statusCampos);
    
    return empresaData;
}



// EXPORTS NO FINAL
export {
    extractEmpresaData
};
/* ==== FIM: data/builders/data-builders-folder/empresa-data-extractor.js ==== */

/* ==== IN√çCIO: data/adapters/obra-adapter-folder/empresa-form-manager.js ==== */
// empresa-form-manager.js
import { formatarData } from './ui-helpers-obra-adapter.js'
import { inicializarInputEmpresaHibrido } from './empresa-autocomplete.js'

/**
 * üÜï ATUALIZA A INTERFACE COM OS DADOS DA EMPRESA
 */
async function atualizarInterfaceComEmpresa(obraElement, obraData) {
    try {
        // Encontrar o container de cadastro de empresas
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (!empresaContainer) {
            console.log(`‚ùå [EMPRESA] Container de empresa n√£o encontrado na obra "${obraData.nome}"`);
            return;
        }
        
        // üÜï ATUALIZAR HEADER DA OBRA COM SPAN (n√£o bot√£o)
        if (window.empresaCadastro && typeof window.empresaCadastro.atualizarHeaderObra === 'function') {
            window.empresaCadastro.atualizarHeaderObra(obraElement, obraData);
        }
        
        console.log(`‚úÖ [EMPRESA] Interface atualizada com SPAN no header`);
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao atualizar interface:`, error);
    }
}

/**
 * üÜï ATUALIZA CAMPOS DO FORMUL√ÅRIO DE EMPRESA EXISTENTE - COM DATA FORMATADA
 */
function atualizarCamposEmpresaForm(obraData, formElement) {
    const camposMapping = {
        'empresaSigla': 'empresa-input',
        'numeroClienteFinal': 'numero-cliente-final',
        'clienteFinal': 'cliente-final',
        'codigoCliente': 'codigo-cliente',
        'dataCadastro': 'data-cadastro',
        'orcamentistaResponsavel': 'orcamentista-responsavel'
    };
    
    Object.entries(camposMapping).forEach(([dataField, inputId]) => {
        const input = formElement.querySelector(`#${inputId}`);
        if (input && obraData[dataField]) {
            // üÜï FORMATAR DATA SE FOR O CAMPO dataCadastro
            if (dataField === 'dataCadastro') {
                input.value = formatarData(obraData[dataField]);
            } else {
                input.value = obraData[dataField];
            }
            
            // Configurar dados adicionais para empresa
            if (dataField === 'empresaSigla' && obraData.empresaNome) {
                input.dataset.siglaSelecionada = obraData.empresaSigla;
                input.dataset.nomeSelecionado = obraData.empresaNome;
            }
        }
    });
    
    // Atualizar preview do ID da obra
    const idObraValue = formElement.querySelector('#obra-id-value');
    if (idObraContainer && idObraValue && obraData.idGerado) {
        idObraValue.textContent = obraData.idGerado;
        idObraContainer.style.display = 'block';
    }
}

/**
 * üÜï CRIA FORMUL√ÅRIO DE EMPRESA COM DADOS EXISTENTES - COM DATA FORMATADA E DATEPICKER DIN√ÇMICO
 */
function criarVisualizacaoEmpresa(obraData, container) {
    // Ocultar bot√£o se existir
    const botao = container.querySelector('.btn-empresa-cadastro');
    if (botao) {
        botao.style.display = 'none';
    }
    
    // üÜï FORMATAR DATA
    const dataFormatada = formatarData(obraData.dataCadastro);
    
    // Criar formul√°rio
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Dados da Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <div class="form-group-horizontal">
                <label>Empresa</label>
                <input type="text" class="empresa-input-readonly" 
                    value="${obraData.empresaSigla || ''} - ${obraData.empresaNome || ''}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" class="numero-cliente-final-readonly" 
                    value="${obraData.numeroClienteFinal || ''}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" class="cliente-final-input" 
                    value="${obraData.clienteFinal || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'clienteFinal', '${obraData.id}')">
            </div>

            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" class="codigo-cliente-input" 
                    value="${obraData.codigoCliente || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'codigoCliente', '${obraData.id}')">
            </div>

            <!-- üÜï CAMPO DE DATA COM DATEPICKER DIN√ÇMICO -->
            <div class="form-group-horizontal">
                <label>Data</label>
                <div class="date-input-container">
                    <input type="text" 
                           class="data-cadastro-input" 
                           id="data-cadastro-edit-${obraData.id}"
                           value="${dataFormatada}" 
                           placeholder="DD/MM/AAAA"
                           maxlength="10"
                           onchange="atualizarDadosEmpresa(this, 'dataCadastro', '${obraData.id}')">
                    <span class="calendar-icon" onclick="alternarDatePicker('${obraData.id}', 'edit')">üìÖ</span>
                </div>
            </div>

            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" class="orcamentista-responsavel-input" 
                    value="${obraData.orcamentistaResponsavel || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'orcamentistaResponsavel', '${obraData.id}')">
            </div>
        </div>

        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraData.id}')">
                Ocultar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    
    // üÜï CONFIGURAR AUTO-FORMATA√á√ÉO PARA O CAMPO DE DATA
    setTimeout(() => {
        const dataCampo = container.querySelector(`#data-cadastro-edit-${obraData.id}`);
        if (dataCampo) {
            configurarCampoDataEspecifico(dataCampo);
        }
    }, 100);
    
    console.log(`‚úÖ [EMPRESA] Formul√°rio criado para obra ${obraData.id} com data: ${dataFormatada}`);
}

/**
 * üÜï CRIA FORMUL√ÅRIO VAZIO DE EMPRESA COM DATEPICKER DIN√ÇMICO
 */
function criarFormularioVazioEmpresa(obraId, container) {
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Cadastro de Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <!-- Empresa üü¢ EDIT√ÅVEL -->
            <div class="form-group-horizontal">
                <label>Empresa *</label>
                <div class="empresa-input-container">
                    <input type="text" 
                           class="empresa-input-cadastro" 
                           id="empresa-input-${obraId}"
                           placeholder="Digite sigla ou nome ou selecione..."
                           autocomplete="off">
                    <div class="empresa-dropdown" id="empresa-dropdown-${obraId}">
                        <div class="dropdown-options" id="empresa-options-${obraId}"></div>
                    </div>
                </div>
            </div>

            <!-- N¬∫ Cliente üî¥ SOMENTE LEITURA -->
            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" class="numero-cliente-final-cadastro" readonly
                    placeholder="Ser√° gerado automaticamente">
            </div>

            <!-- Cliente Final üü¢ EDIT√ÅVEL -->
            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" class="cliente-final-cadastro" 
                    placeholder="Nome do cliente final">
            </div>

            <!-- C√≥digo üü¢ EDIT√ÅVEL -->
            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" class="codigo-cliente-cadastro" 
                    placeholder="C√≥digo do cliente">
            </div>

            <!-- Data üü¢ EDIT√ÅVEL COM DATEPICKER DIN√ÇMICO -->
            <div class="form-group-horizontal">
                <label>Data</label>
                <div class="date-input-container">
                    <input type="text" 
                           class="data-cadastro-cadastro" 
                           id="data-cadastro-${obraId}"
                           placeholder="DD/MM/AAAA"
                           value="${dataAtual}"
                           maxlength="10">
                    <span class="calendar-icon" onclick="alternarDatePicker('${obraId}', 'cadastro')">üìÖ</span>
                </div>
            </div>

            <!-- Or√ßamentista üü¢ EDIT√ÅVEL -->
            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" class="orcamentista-responsavel-cadastro" 
                    placeholder="Nome do or√ßamentista">
            </div>
        </div>

        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraId}')">
                Cancelar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    
    // üî• INICIALIZAR COM TIMEOUT
    setTimeout(() => {
        inicializarInputEmpresaHibrido(obraId);
        
        // üÜï CONFIGURAR AUTO-FORMATA√á√ÉO PARA O CAMPO DE DATA
        const dataCampo = container.querySelector(`#data-cadastro-${obraId}`);
        if (dataCampo) {
            configurarCampoDataEspecifico(dataCampo);
            console.log('‚úÖ Auto-formata√ß√£o de data configurada');
        }
        
    }, 300);
}

/**
 * üÜï ALTERNA ENTRE INPUT TEXT E DATE QUANDO CLICA NO √çCONE
 */
function alternarDatePicker(obraId, tipo) {
    const textInput = document.getElementById(`data-cadastro-${tipo === 'edit' ? 'edit-' : ''}${obraId}`);
    const container = textInput.closest('.date-input-container');
    
    if (!textInput) return;
    
    // üÜï N√ÉO ESCONDE O √çCONE - apenas o texto
    textInput.style.display = 'none';
    
    // üÜï CRIA UM INPUT DATE VIS√çVEL MAS COM FORMATA√á√ÉO BRASILEIRA
    const datePickerHTML = `
        <div class="date-picker-visible-wrapper" id="date-picker-wrapper-${obraId}">
            <input type="date" 
                   class="date-picker-visible"
                   id="date-picker-temp-${obraId}"
                   onchange="aplicarDataDoDatePicker('${obraId}', '${tipo}', this.value)"
                   onblur="restaurarInputTexto('${obraId}', '${tipo}')">
            <div class="date-display-overlay" id="date-display-${obraId}"></div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', datePickerHTML);
    
    const datePicker = container.querySelector('.date-picker-visible');
    const dateDisplay = container.querySelector(`#date-display-${obraId}`);
    
    // Define valor inicial baseado no texto atual
    let dataInicial = 'DD/MM/AAAA';
    if (textInput.value && /^\d{2}\/\d{2}\/\d{4}$/.test(textInput.value)) {
        const [dia, mes, ano] = textInput.value.split('/');
        datePicker.value = `${ano}-${mes}-${dia}`;
        dataInicial = textInput.value;
    }
    
    // üÜï ATUALIZA O DISPLAY VISUAL COM FORMATA√á√ÉO BRASILEIRA
    atualizarDisplayData(dateDisplay, dataInicial);
    
    // üÜï OBSERVA MUDAN√áAS NO DATE PICKER PARA ATUALIZAR O DISPLAY
    datePicker.addEventListener('input', function() {
        if (this.value) {
            const [ano, mes, dia] = this.value.split('-');
            const dataBrasileira = `${dia}/${mes}/${ano}`;
            atualizarDisplayData(dateDisplay, dataBrasileira);
        } else {
            atualizarDisplayData(dateDisplay, 'DD/MM/AAAA');
        }
    });
    
    datePicker.addEventListener('change', function() {
        if (this.value) {
            const [ano, mes, dia] = this.value.split('-');
            const dataBrasileira = `${dia}/${mes}/${ano}`;
            atualizarDisplayData(dateDisplay, dataBrasileira);
        }
    });
    
    // Foca e abre o calend√°rio
    setTimeout(() => {
        datePicker.focus();
        datePicker.showPicker();
    }, 100);
    
    console.log('‚úÖ Date picker com formata√ß√£o brasileira ativado para obra:', obraId);
}

/**
 * üÜï APLICA A DATA SELECIONADA NO DATEPICKER AO CAMPO DE TEXTO
 */
function aplicarDataDoDatePicker(obraId, tipo, dataISO) {
    const container = document.querySelector(`#data-cadastro-${tipo === 'edit' ? 'edit-' : ''}${obraId}`).closest('.date-input-container');
    const textInput = container.querySelector(`#data-cadastro-${tipo === 'edit' ? 'edit-' : ''}${obraId}`);
    
    // üÜï VERIFICA√á√ÉO MAIS ROBUSTA PARA REMOVER O DATE PICKER
    const datePickerWrapper = document.getElementById(`date-picker-wrapper-${obraId}`);
    if (datePickerWrapper && datePickerWrapper.parentNode) {
        try {
            datePickerWrapper.remove();
            console.log('‚úÖ Date picker removido com sucesso');
        } catch (error) {
            console.log('‚ö†Ô∏è Date picker j√° foi removido:', error.message);
        }
    }
    
    if (dataISO) {
        // Converte YYYY-MM-DD para DD/MM/AAAA
        const [ano, mes, dia] = dataISO.split('-');
        const dataBrasileira = `${dia}/${mes}/${ano}`;
        
        // Aplica ao campo de texto
        textInput.value = dataBrasileira;
    }
    
    // Restaura a visualiza√ß√£o normal
    if (textInput) {
        textInput.style.display = 'block';
        // Foca no campo de texto para continuar a digita√ß√£o
        setTimeout(() => {
            textInput.focus();
            // Posiciona o cursor no final do texto
            textInput.setSelectionRange(textInput.value.length, textInput.value.length);
        }, 50);
    }
    
    // Dispara evento change se houve altera√ß√£o
    if (dataISO) {
        const event = new Event('change', { bubbles: true });
        textInput.dispatchEvent(event);
        validarDataInput(textInput);
        console.log('‚úÖ Data do date picker aplicada:', textInput.value);
    } else {
        console.log('‚úÖ Date picker cancelado');
    }
}

/**
 * üÜï RESTAURA O INPUT DE TEXTO SE O USU√ÅRIO CANCELAR
 */
function restaurarInputTexto(obraId, tipo) {
    const container = document.querySelector(`#data-cadastro-${tipo === 'edit' ? 'edit-' : ''}${obraId}`).closest('.date-input-container');
    const textInput = container.querySelector(`#data-cadastro-${tipo === 'edit' ? 'edit-' : ''}${obraId}`);
    
    // üÜï VERIFICA√á√ÉO MAIS ROBUSTA PARA REMOVER O DATE PICKER
    const datePickerWrapper = document.getElementById(`date-picker-wrapper-${obraId}`);
    if (datePickerWrapper && datePickerWrapper.parentNode) {
        try {
            datePickerWrapper.remove();
            console.log('‚úÖ Date picker removido com sucesso (blur)');
        } catch (error) {
            console.log('‚ö†Ô∏è Date picker j√° foi removido (blur):', error.message);
        }
    }
    
    // Restaura o input de texto
    if (textInput) {
        textInput.style.display = 'block';
        setTimeout(() => {
            textInput.focus();
            textInput.setSelectionRange(textInput.value.length, textInput.value.length);
        }, 50);
    }
    
    console.log('‚úÖ Input de texto restaurado');
}


/**
 * üÜï ATUALIZA O DISPLAY VISUAL DA DATA
 */
function atualizarDisplayData(dateDisplay, dataFormatada) {
    dateDisplay.textContent = dataFormatada;
    
    // Destaca visualmente se for uma data v√°lida
    if (dataFormatada && /^\d{2}\/\d{2}\/\d{4}$/.test(dataFormatada)) {
        dateDisplay.style.color = '#000';
        dateDisplay.style.fontWeight = 'normal';
        dateDisplay.style.fontStyle = 'normal';
    } else {
        dateDisplay.style.color = '#999';
        dateDisplay.style.fontWeight = 'normal';
        dateDisplay.style.fontStyle = 'italic';
    }
}



/**
 * üÜï FORMATA AUTOMATICAMENTE O CAMPO DE DATA ENQUANTO DIGITA
 * Formato: DD/MM/AAAA
 */
function configurarAutoFormatacaoData() {
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('data-cadastro-cadastro') || 
            e.target.classList.contains('data-cadastro-input')) {
            formatarDataEmTempoReal(e.target);
        }
    });
    
    // Tamb√©m prevenir caracteres n√£o num√©ricos
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('data-cadastro-cadastro') || 
            e.target.classList.contains('data-cadastro-input')) {
            permitirApenasNumerosEControles(e);
        }
    });
    
    // Valida√ß√£o ao sair do campo
    document.addEventListener('blur', function(e) {
        if (e.target.classList.contains('data-cadastro-cadastro') || 
            e.target.classList.contains('data-cadastro-input')) {
            validarDataInput(e.target);
        }
    }, true);
    
    console.log('‚úÖ Sistema de auto-formata√ß√£o de data configurado');
}

/**
 * üÜï FORMATA DATA EM TEMPO REAL
 */
function formatarDataEmTempoReal(input) {
    let value = input.value.replace(/\D/g, ''); // Remove n√£o n√∫meros
    
    // Aplica formata√ß√£o autom√°tica
    if (value.length > 2) {
        value = value.substring(0, 2) + '/' + value.substring(2);
    }
    if (value.length > 5) {
        value = value.substring(0, 5) + '/' + value.substring(5, 9);
    }
    
    input.value = value;
    
    // üÜï VALIDA√á√ÉO B√ÅSICA DA DATA
    validarDataInput(input);
}

/**
 * üÜï PERMITE APENAS N√öMEROS E TECLAS DE CONTROLE
 */
function permitirApenasNumerosEControles(event) {
    const teclasPermitidas = [
        'Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 
        'ArrowLeft', 'ArrowRight', 'Home', 'End'
    ];
    
    if (teclasPermitidas.includes(event.key)) {
        return; // Permite teclas de controle
    }
    
    // Permite apenas n√∫meros
    if (!/^\d$/.test(event.key)) {
        event.preventDefault();
        return;
    }
    
    // üÜï LIMITA O TAMANHO M√ÅXIMO (10 caracteres com formata√ß√£o)
    const input = event.target;
    if (input.value.replace(/\D/g, '').length >= 8 && !teclasPermitidas.includes(event.key)) {
        event.preventDefault();
        return;
    }
}

/**
 * üÜï VALIDA√á√ÉO B√ÅSICA DA DATA
 */
function validarDataInput(input) {
    const value = input.value;
    
    // Verifica se est√° vazio
    if (!value) {
        input.style.borderColor = '';
        return true;
    }
    
    // Verifica formato b√°sico
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
        input.style.borderColor = '#ff4444';
        return false;
    }
    
    // Extrai dia, m√™s e ano
    const [dia, mes, ano] = value.split('/').map(Number);
    
    // Valida√ß√µes b√°sicas
    if (dia < 1 || dia > 31) {
        input.style.borderColor = '#ff4444';
        return false;
    }
    
    if (mes < 1 || mes > 12) {
        input.style.borderColor = '#ff4444';
        return false;
    }
    
    if (ano < 1900 || ano > 2100) {
        input.style.borderColor = '#ff4444';
        return false;
    }
    
    // Valida meses com 30 dias
    const meses30Dias = [4, 6, 9, 11];
    if (meses30Dias.includes(mes) && dia > 30) {
        input.style.borderColor = '#ff4444';
        return false;
    }
    
    // Valida fevereiro e anos bissextos
    if (mes === 2) {
        const isBissexto = (ano % 4 === 0 && ano % 100 !== 0) || (ano % 400 === 0);
        if (dia > (isBissexto ? 29 : 28)) {
            input.style.borderColor = '#ff4444';
            return false;
        }
    }
    
    // Data v√°lida
    input.style.borderColor = '#4CAF50';
    return true;
}

/**
 * üÜï CONFIGURA AUTO-FORMATA√á√ÉO PARA UM CAMPO ESPEC√çFICO
 */
function configurarCampoDataEspecifico(inputElement) {
    if (!inputElement) return;
    
    inputElement.addEventListener('input', function() {
        formatarDataEmTempoReal(this);
    });
    
    inputElement.addEventListener('keydown', function(e) {
        permitirApenasNumerosEControles(e);
    });
    
    inputElement.addEventListener('blur', function() {
        validarDataInput(this);
    });
    
    // üÜï CONFIGURA PLACEHOLDER E ATRIBUTOS
    inputElement.placeholder = 'DD/MM/AAAA';
    inputElement.maxLength = 10;
    
    console.log('‚úÖ Campo de data configurado com auto-formata√ß√£o:', inputElement.id);
}

/**
 * üÜï OBT√âM DATA FORMATADA DO CAMPO
 * Retorna no formato DD/MM/AAAA para armazenamento (igual ao JSON)
 */
function obterDataFormatadaDoCampo(inputElement) {
    if (!inputElement || !inputElement.value) return null;
    
    const value = inputElement.value;
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(value)) return null;
    
    // üÜï RETORNA NO FORMATO DD/MM/AAAA (igual ao JSON)
    return value;
}

/**
 * üÜï DEFINE DATA NO CAMPO FORMATADO
 * Aceita formato YYYY-MM-DD ou DD/MM/AAAA
 */
function definirDataNoCampo(inputElement, data) {
    if (!inputElement || !data) return;
    
    let dataFormatada;
    
    if (data.includes('-')) {
        // Formato YYYY-MM-DD
        const [ano, mes, dia] = data.split('-');
        dataFormatada = `${dia}/${mes}/${ano}`;
    } else if (data.includes('/')) {
        // J√° est√° no formato DD/MM/AAAA
        dataFormatada = data;
    } else {
        console.warn('Formato de data n√£o reconhecido:', data);
        return;
    }
    
    inputElement.value = dataFormatada;
    validarDataInput(inputElement);
}

/**
 * üÜï VALIDA TODOS OS CAMPOS DE DATA DO FORMUL√ÅRIO
 */
function validarTodosCamposDataNoFormulario(formElement) {
    const camposData = formElement.querySelectorAll('.data-cadastro-cadastro, .data-cadastro-input');
    let todosValidos = true;
    
    camposData.forEach(campo => {
        if (!validarDataInput(campo)) {
            todosValidos = false;
        }
    });
    
    return todosValidos;
}

/**
 * üÜï LIMPA E RESETA CAMPO DE DATA
 */
function limparCampoData(inputElement) {
    if (!inputElement) return;
    
    inputElement.value = '';
    inputElement.style.borderColor = '';
    inputElement.placeholder = 'DD/MM/AAAA';
}

// üÜï EXPORTA AS FUN√á√ïES
export {
    atualizarInterfaceComEmpresa,
    atualizarCamposEmpresaForm,
    criarVisualizacaoEmpresa,
    criarFormularioVazioEmpresa,
    configurarAutoFormatacaoData,
    configurarCampoDataEspecifico,
    obterDataFormatadaDoCampo,
    definirDataNoCampo,
    validarTodosCamposDataNoFormulario,
    limparCampoData,
    alternarDatePicker,
    aplicarDataDoDatePicker,
    restaurarInputTexto,
    atualizarDisplayData
};

// üÜï TORNA AS FUN√á√ïES DISPON√çVEIS GLOBALMENTE PARA OS EVENTOS HTML
window.alternarDatePicker = alternarDatePicker;
window.aplicarDataDoDatePicker = aplicarDataDoDatePicker;
window.restaurarInputTexto = restaurarInputTexto;
/* ==== FIM: data/adapters/obra-adapter-folder/empresa-form-manager.js ==== */
