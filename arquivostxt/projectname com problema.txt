
/* ==== IN√çCIO: data/utils/data-utils.js ==== */
/**
 * data/utils/data-utils.js
 * Utilit√°rios de dados unificados - FUS√ÉO: data-utils-core.js + helpers.js
 * Sistema completo de IDs, numera√ß√£o, nomea√ß√£o e utilit√°rios
 */

import { 
    safeNumber} from './core-utils.js';


// =============================================================================
// FUN√á√ïES DE NUMERA√á√ÉO (De data-utils-core.js)
// =============================================================================

/**
 * Obt√©m o pr√≥ximo n√∫mero de projeto dispon√≠vel PARA UMA OBRA ESPEC√çFICA - 
 * @param {string} obraId - ID √∫nico da obra
 * @returns {number} Pr√≥ximo n√∫mero dispon√≠vel para projeto na obra espec√≠fica
 */
function getNextProjectNumber(obraId) {
    try {
        // ‚úÖ CORRE√á√ÉO: Buscar apenas projetos DESTA obra espec√≠fica
        const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraBlock) {
            console.warn(`‚ö†Ô∏è Obra ${obraId} n√£o encontrada, usando projeto 1`);
            return 1;
        }

        const projectBlocks = obraBlock.querySelectorAll('.project-block');
        let maxNumber = 0;

        projectBlocks.forEach(project => {
            const projectName = project.dataset.projectName || 
                             project.querySelector('.project-title')?.textContent || '';
            
            if (projectName) {
                // Suporta: "Projeto1", "Projeto 2", "Projeto-3", etc.
                const match = projectName.match(/Projeto\s*[-_]?\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxNumber) maxNumber = num;
                }
            }
        });

        console.log(`üî¢ Next project number for obra ${obraId}: ${maxNumber + 1} (max found: ${maxNumber})`);
        return maxNumber + 1;

    } catch (error) {
        console.error('‚ùå Erro em getNextProjectNumber:', error);
        return 1; // Fallback seguro
    }
}

/**
 * Obt√©m o pr√≥ximo n√∫mero de sala - 
 * @param {string} projectId - ID do projeto
 * @returns {number} Pr√≥ximo n√∫mero dispon√≠vel para sala
 */
function getNextRoomNumber(projectId) {
    try {
        const projectBlock = document.querySelector(`[data-project-id="${projectId}"]`);
        if (!projectBlock) {
            console.warn(`‚ö†Ô∏è Projeto ${projectId} n√£o encontrado, usando sala 1`);
            return 1;
        }

        const roomBlocks = projectBlock.querySelectorAll('.room-block');
        let maxNumber = 0;

        roomBlocks.forEach(room => {
            const roomName = room.dataset.roomName || 
                          room.querySelector('.room-title')?.textContent || '';

            if (roomName) {
                // Suporta: "Sala1", "Sala 2", "Sala-3", etc.
                const match = roomName.match(/Sala\s*[-_]?\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxNumber) maxNumber = num;
                }
            }
        });

        console.log(`üî¢ Next room number for project ${projectId}: ${maxNumber + 1}`);
        return maxNumber + 1;

    } catch (error) {
        console.error('‚ùå Erro em getNextRoomNumber:', error);
        return 1; // Fallback seguro
    }
}

/**
 * Obt√©m o pr√≥ximo n√∫mero de obra dispon√≠vel
 * @returns {number} Pr√≥ximo n√∫mero dispon√≠vel para obra
 */
function getNextObraNumber() {
    try {
        const obraBlocks = document.querySelectorAll('.obra-block');
        let maxNumber = 0;

        obraBlocks.forEach(obra => {
            const obraName = obra.dataset.obraName || 
                          obra.querySelector('.obra-title')?.textContent || '';
            
            if (obraName) {
                // Suporta: "Obra1", "Obra 2", "Obra-3", etc.
                const match = obraName.match(/Obra\s*[-_]?\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxNumber) maxNumber = num;
                }
            }
        });

        console.log(`üî¢ Next obra number: ${maxNumber + 1} (max found: ${maxNumber})`);
        return maxNumber + 1;

    } catch (error) {
        console.error('‚ùå Erro em getNextObraNumber:', error);
        return 1; // Fallback seguro
    }
}

// =============================================================================
// FUN√á√ïES DE NOMEA√á√ÉO (De data-utils-core.js)
// =============================================================================

/**
 * Obt√©m o ID completo da sala no formato correto
 * @param {HTMLElement} roomElement - Elemento da sala
 * @returns {string} ID completo da sala
 */
function getRoomFullId(roomElement) {
    const roomId = roomElement.dataset.roomId;
    
    if (!roomId || roomId === 'undefined' || roomId === 'null' || roomId.includes('undefined')) {
        console.error(`ERRO FALBACK (getRoomFullId) [Room ID inv√°lido: ${roomId}]`);
        return generateSecureId('sala');
    }
    
    console.log(`‚úÖ ID da sala obtido do data attribute: ${roomId}`);
    return roomId;
}

/**
 * Obt√©m o nome da obra a partir do elemento - 
 * @param {HTMLElement} obraElement - Elemento da obra
 * @returns {string} Nome da obra
 */
function getObraName(obraElement) {
    if (!obraElement) {
        console.error(`ERRO FALBACK (getObraName) [Elemento da obra n√£o fornecido]`);
        return 'Obra_Erro';
    }

    const titleElement = obraElement.querySelector('.obra-title');
    if (titleElement) {
        const name = titleElement.textContent || titleElement.innerText || '';
        const trimmedText = name.trim();
        if (trimmedText && trimmedText !== 'Obra') {
            return trimmedText;
        }
    }
    
    const obraNameFromData = obraElement.dataset.obraName;
    if (obraNameFromData && obraNameFromData !== 'undefined' && obraNameFromData !== 'null') {
        return obraNameFromData;
    }
    
    console.error(`ERRO FALBACK (getObraName) [Nome da obra n√£o encontrado]`);
    return 'Obra_Erro';
}

/**
 * Obt√©m o nome do projeto a partir do elemento - 
 * @param {HTMLElement} projectElement - Elemento do projeto
 * @returns {string} Nome do projeto
 */
function getProjectName(projectElement) {
    if (!projectElement) {
        console.error(`ERRO FALBACK (getProjectName) [Elemento do projeto n√£o fornecido]`);
        return 'Projeto_Erro';
    }

    const titleElement = projectElement.querySelector('.project-title');
    if (titleElement) {
        const titleText = titleElement.textContent || titleElement.innerText || '';
        const trimmedText = titleText.trim();
        if (trimmedText && trimmedText !== 'Projeto') {
            console.log(`üìù Nome do projeto obtido do t√≠tulo: "${trimmedText}"`);
            return trimmedText;
        }
    }
    
    const projectNameFromData = projectElement.dataset.projectName;
    if (projectNameFromData && projectNameFromData !== 'undefined' && projectNameFromData !== 'null' && projectNameFromData !== 'Projeto') {
        console.log(`üìù Nome do projeto obtido do data attribute: "${projectNameFromData}"`);
        return projectNameFromData;
    }
    
    console.error(`ERRO FALBACK (getProjectName) [Nome do projeto n√£o encontrado]`);
    return 'Projeto_Erro';
}

/**
 * Obt√©m o nome da sala a partir do elemento - 
 * @param {HTMLElement} roomElement - Elemento da sala
 * @returns {string} Nome da sala
 */
function getRoomName(roomElement) {
    if (!roomElement) {
        console.error(`ERRO FALBACK (getRoomName) [Elemento da sala n√£o fornecido]`);
        return 'Sala_Erro';
    }

    const titleElement = roomElement.querySelector('.room-title');
    if (titleElement) {
        const name = titleElement.textContent || titleElement.value || titleElement.getAttribute('value') || '';
        const trimmedName = name.trim();
        if (trimmedName) return trimmedName;
    }
    
    const roomNameFromData = roomElement.dataset.roomName;
    if (roomNameFromData && roomNameFromData !== 'undefined' && roomNameFromData !== 'null') {
        return roomNameFromData;
    }
    
    const roomId = roomElement.dataset.roomId;
    if (roomId && roomId !== 'undefined' && roomId !== 'null') {
        return `Sala ${roomId.split('_').pop()}`;
    }
    
    console.error(`ERRO FALBACK (getRoomName) [Nome da sala n√£o encontrado]`);
    return 'Sala_Erro';
}

// =============================================================================
// FUN√á√ïES UTILIT√ÅRIAS (De data-utils-core.js)
// =============================================================================

/**
 * Extrai n√∫mero de um texto, convertendo v√≠rgula para ponto decimal
 * @param {string} text - Texto contendo n√∫mero
 * @returns {number|null} N√∫mero extra√≠do ou null se n√£o encontrado
 */
function extractNumberFromText(text) {
    if (!text) return null;
    
    const numberMatch = text.match(/-?\d+(?:[.,]\d+)?/);
    if (numberMatch) {
        const numericString = numberMatch[0].replace(',', '.');
        const numericValue = parseFloat(numericString);
        return isNaN(numericValue) ? null : numericValue;
    }
    
    return null;
}

/**
 * Obt√©m o nome da m√°quina a partir do elemento
 * @param {HTMLElement} machineElement - Elemento da m√°quina
 * @param {string} machineId - ID da m√°quina
 * @returns {string} Nome da m√°quina
 */
function getMachineName(machineElement, machineId) {
    const titleElement = machineElement.querySelector('.machine-title-editable');
    if (!titleElement) return `M√°quina ${machineId}`;
    
    const name = titleElement.value || titleElement.textContent || titleElement.getAttribute('value') || `M√°quina ${machineId}`;
    return name.trim() || `M√°quina${machineId}`;
}

/**
 * Converte texto de pre√ßo em n√∫mero
 * @param {string} priceText - Texto do pre√ßo no formato "R$ X.XXX,XX"
 * @returns {number} Valor num√©rico do pre√ßo
 */
function parseMachinePrice(priceText) {
    if (!priceText || priceText === 'R$ 0,00') return 0;
    
    try {
        const cleaned = priceText.replace('R$', '')
                                .replace(/\./g, '')
                                .replace(',', '.')
                                .trim();
        return parseFloat(cleaned) || 0;
    } catch (error) {
        console.error('‚ùå Erro ao converter pre√ßo:', priceText, error);
        return 0;
    }
}

/**
 * Fun√ß√£o de debug para mostrar todos os elementos de ganhos t√©rmicos dispon√≠veis
 * @param {HTMLElement} roomElement - Elemento da sala para debug
 * @returns {void}
 */
function debugThermalGainsElements(roomElement) {
    const roomFullId = getRoomFullId(roomElement);
    console.log('üêõ DEBUG: Todos os elementos de ganhos t√©rmicos dispon√≠veis:');
    
    // ‚úÖ ATUALIZADO: Incluir os novos IDs de TR
    const selectors = [
        'total-ganhos-w', 'total-tr-aprox', 'total-tr-exato', 'total-externo', 'total-divisoes',
        'total-piso', 'total-iluminacao', 'total-dissi', 'total-pessoas',
        'total-ar-sensivel', 'total-ar-latente'
    ];
    
    selectors.forEach(selector => {
        const element = document.querySelector(`#${selector}-${roomFullId}`);
        console.log(`üîç ${selector}-${roomFullId}:`, element ? `ENCONTRADO - "${element.textContent}"` : 'N√ÉO ENCONTRADO');
    });
}

/**
 * Obt√©m o valor de TR para c√°lculos (prioriza o valor exato)
 * @param {string} roomId - ID da sala
 * @returns {number} Valor de TR para uso em c√°lculos
 */
function getThermalLoadTRForCalculations(roomId) {
    try {
        // ‚úÖ NOVA: Priorizar o valor exato se dispon√≠vel
        const totalTRExatoElement = document.getElementById(`total-tr-exato-${roomId}`);
        if (totalTRExatoElement?.textContent) {
            const value = Number.parseFloat(totalTRExatoElement.textContent) || 0;
            console.log(`üî¢ [TR CALC] Usando valor exato: ${value}`);
            return value;
        }

        // Fallback para valor aproximado
        const totalTRAproxElement = document.getElementById(`total-tr-aprox-${roomId}`);
        if (totalTRAproxElement?.textContent) {
            const value = Number.parseFloat(totalTRAproxElement.textContent) || 0;
            console.log(`üî¢ [TR CALC] Usando valor aproximado: ${value}`);
            return value;
        }

        // Fallback para c√°lculo manual
        const totalGanhosWElement = document.getElementById(`total-ganhos-w-${roomId}`);
        if (totalGanhosWElement?.textContent) {
            const totalW = Number.parseFloat(totalGanhosWElement.textContent) || 0;
            const value = totalW / 3517;
            console.log(`üî¢ [TR CALC] Calculado manualmente: ${value}`);
            return value;
        }

        console.warn(`‚ö†Ô∏è [TR CALC] Nenhum valor de TR encontrado para sala ${roomId}`);
        return 0;
    } catch (error) {
        console.error(`‚ùå [TR CALC] Erro ao obter carga t√©rmica para sala ${roomId}:`, error);
        return 0;
    }
}

/**
 * Verifica se os elementos de TR est√£o corretamente configurados
 * @param {string} roomId - ID da sala
 * @returns {boolean} True se ambos os elementos existem
 */
function validateTRElements(roomId) {
    const elementAprox = document.getElementById(`total-tr-aprox-${roomId}`);
    const elementExato = document.getElementById(`total-tr-exato-${roomId}`);
    
    const isValid = !!(elementAprox && elementExato);
    
    if (!isValid) {
        console.warn(`‚ö†Ô∏è [TR VALIDATE] Elementos de TR incompletos para sala ${roomId}:`, {
            aprox: !!elementAprox,
            exato: !!elementExato
        });
    } else {
        console.log(`‚úÖ [TR VALIDATE] Elementos de TR v√°lidos para sala ${roomId}`);
    }
    
    return isValid;
}

// =============================================================================
// FUN√á√ïES DE COLETA DE DADOS (De helpers.js)
// =============================================================================

/**
 * Coleta dados de entrada da interface para processamento de climatiza√ß√£o
 * @param {HTMLElement} climaSection - Elemento HTML da se√ß√£o de climatiza√ß√£o
 * @param {string} roomId - ID √∫nico da sala (formato: obra_w12_proj_t34_1_sala_r21_1)
 * @returns {Object} Dados coletados dos inputs
 */
function collectClimatizationInputs(climaSection, roomId) {
    console.log(`üìù [COLLECT] Coletando inputs para sala: ${roomId}`);
    
    const inputs = climaSection.querySelectorAll(".clima-input, input[data-field], select[data-field]");
    const data = {};

    inputs.forEach((input) => {
        const field = input.dataset.field;
        let value;
        
        // ‚úÖ CORRE√á√ÉO: Tratar diferentes tipos de input
        if (input.type === 'checkbox') {
            value = input.checked;
        } else if (input.type === 'number' || input.type === 'text') {
            value = input.value !== "" ? (input.type === 'number' ? Number.parseFloat(input.value) : input.value) : "";
        } else if (input.tagName === 'SELECT') {
            value = input.value !== "" ? input.value : "";
        }
        
        if (field) {
            data[field] = value;
        }
    });

    // ‚úÖ CORRE√á√ÉO: Coletar estado da pressuriza√ß√£o dos RADIO BUTTONS
    if (data.pressurizacao === undefined) {
        const radioSim = climaSection.querySelector('input[type="radio"][value="sim"]');
        const radioNao = climaSection.querySelector('input[type="radio"][value="nao"]');
        
        // Se o radio "sim" estiver marcado, pressuriza√ß√£o est√° ativa
        data.pressurizacao = radioSim ? radioSim.checked : false;
        
        console.log(`üéØ [COLLECT] Estado da pressuriza√ß√£o:`, {
            radioSimChecked: radioSim?.checked,
            radioNaoChecked: radioNao?.checked,
            pressurizacao: data.pressurizacao
        });
    }
    
    // ‚úÖ CORRE√á√ÉO: Garantir que setpointTemp esteja presente
    if (data.setpointTemp === undefined) {
        const setpointInput = climaSection.querySelector('input[data-field="setpointTemp"]');
        data.setpointTemp = setpointInput ? safeNumber(setpointInput.value) : 0;
    }

    // ‚úÖ CORRE√á√ÉO: Garantir que pressurizacaoSetpoint esteja presente
    if (data.pressurizacaoSetpoint === undefined) {
        const pressurizacaoInput = climaSection.querySelector('input[data-field="pressurizacaoSetpoint"]');
        data.pressurizacaoSetpoint = pressurizacaoInput ? safeNumber(pressurizacaoInput.value) : 0;
        
        console.log(`üéØ [COLLECT] Valor da pressuriza√ß√£o:`, {
            pressurizacaoSetpoint: data.pressurizacaoSetpoint,
            inputValue: pressurizacaoInput?.value
        });
    }

    console.log(`‚úÖ [COLLECT] ${Object.keys(data).length} dados coletados para ${roomId}:`, data);
    return data;
}

/**
 * Encontra a se√ß√£o de climatiza√ß√£o de uma sala pelo ID √∫nico
 * @param {string} roomId - ID √∫nico da sala
 * @returns {HTMLElement|null} Elemento da se√ß√£o de climatiza√ß√£o
 */
function findClimatizationSection(roomId) {
    // ‚úÖ CORRE√á√ÉO: Buscar APENAS por ID √∫nico
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomElement) {
        console.error(`‚ùå [FIND] Sala n√£o encontrada: ${roomId}`);
        return null;
    }
    
    const climaSection = roomElement.querySelector('#section-content-' + roomId + '-clima');
    if (!climaSection) {
        console.error(`‚ùå [FIND] Se√ß√£o de climatiza√ß√£o n√£o encontrada para: ${roomId}`);
        return null;
    }
    
    console.log(`‚úÖ [FIND] Se√ß√£o encontrada para: ${roomId}`);
    return climaSection;
}

// =============================================================================
// EXPORTA√á√ïES
// =============================================================================

export {
    // Sistema de Numera√ß√£o
    getNextProjectNumber,
    getNextRoomNumber,
    getNextObraNumber,
    
    // Fun√ß√µes de Nomea√ß√£o
    getRoomFullId,
    getObraName,
    getProjectName,
    getRoomName,
    
    // Utilit√°rios Gerais
    extractNumberFromText,
    getMachineName,
    parseMachinePrice,
    debugThermalGainsElements,
    getThermalLoadTRForCalculations, // ‚úÖ NOVA: Fun√ß√£o para obter TR
    validateTRElements, // ‚úÖ NOVA: Valida√ß√£o dos elementos
    
    // Coleta de Dados
    collectClimatizationInputs,
    findClimatizationSection,
};

// Disponibiliza√ß√£o global para compatibilidade
if (typeof window !== 'undefined') {
    // Sistema de numera√ß√£o
    window.getNextProjectNumber = getNextProjectNumber;
    window.getNextRoomNumber = getNextRoomNumber;
    window.getNextObraNumber = getNextObraNumber;
    
    // Utilit√°rios
    window.getRoomFullId = getRoomFullId;
    window.debugThermalGainsElements = debugThermalGainsElements;
    window.getThermalLoadTRForCalculations = getThermalLoadTRForCalculations; // ‚úÖ NOVA
    window.validateTRElements = validateTRElements; // ‚úÖ NOVA
}
/* ==== FIM: data/utils/data-utils.js ==== */

/* ==== IN√çCIO: data/builders/data-builders-folder/obra-data-builder.js ==== */
// data/builders/data-builders-folder/obra-data-builder.js
// Respons√°vel por montar o objeto completo da obra - VERS√ÉO ATUALIZADA COM VALOR TOTAL

import { generateObraId, generateProjectId, generateRoomId } from '../../utils/id-generator.js';
import { extractEmpresaData } from './empresa-data-extractor.js';

/**
 * Constr√≥i o objeto de dados completo de uma obra a partir do HTML
 */
function buildObraData(obraIdOrElement) {
    console.log('üö® buildObraData INICIADA - buscando elemento...');
    
    let obraElement;
    
    if (typeof obraIdOrElement === 'string') {
        obraElement = document.querySelector(`[data-obra-id="${obraIdOrElement}"]`);
        
        if (!obraElement) {
            console.error('‚ùå Obra n√£o encontrada pelo ID:', obraIdOrElement);
            return null;
        }
    } else if (obraIdOrElement instanceof HTMLElement) {
        if (obraIdOrElement.classList.contains('obra-block')) {
            obraElement = obraIdOrElement;
        } else {
            console.error('‚ùå Elemento n√£o √© uma obra:', obraIdOrElement);
            return null;
        }
    } else {
        console.error('‚ùå Tipo inv√°lido para obraIdOrElement:', typeof obraIdOrElement, obraIdOrElement);
        return null;
    }

    if (!document.body.contains(obraElement)) {
        console.error('‚ùå CR√çTICO: Elemento da obra N√ÉO EST√Å MAIS NO DOM!');
        return null;
    }

    const obraName = obraElement.dataset.obraName;
    const obraId = obraElement.dataset.obraId;

    console.log(`üì¶ Construindo dados da obra: "${obraName}" (ID: ${obraId})`);

    const finalObraId = obraId || generateObraId();
    const empresaData = extractEmpresaData(obraElement);
    
    // üî• NOVO: Extrai o valor total da obra do DOM
    const valorTotalObra = extractValorTotalObra(obraElement);

    const obraData = {
        id: finalObraId,
        nome: obraName,
        empresa_id: `empresa_${finalObraId}`,
        ...empresaData,
        projetos: [],
        valorTotalObra: valorTotalObra // üî• NOVO CAMPO
    };

    const projectElements = obraElement.querySelectorAll('.project-block');
    console.log(`üîç Encontrados ${projectElements.length} projetos na obra "${obraName}"`);
    
    let projetosProcessados = 0;
    let somaVerificacao = 0;
    
    projectElements.forEach((projectElement, index) => {
        console.log(`üìù Processando projeto ${index + 1}/${projectElements.length}`);
        
        if (!document.body.contains(projectElement)) {
            console.error(`‚ùå Projeto ${index} foi removido do DOM durante o processamento!`);
            return;
        }
        
        const projectData = buildProjectData(projectElement);
        if (projectData) {
            obraData.projetos.push(projectData);
            projetosProcessados++;
            
            // üî• NOVO: Soma para verifica√ß√£o
            if (projectData.valorTotalProjeto) {
                somaVerificacao += projectData.valorTotalProjeto;
            }
            
            console.log(`‚úÖ Projeto "${projectData.nome}" adicionado √† obra "${obraName}"`);
        } else {
            console.error(`‚ùå Falha ao construir projeto ${index} da obra "${obraName}"`);
        }
    });

    // üî• NOVO: Verifica√ß√£o de consist√™ncia
    if (Math.abs(valorTotalObra - somaVerificacao) > 0.01) {
        console.warn(`‚ö†Ô∏è Diferen√ßa encontrada no valor total da obra "${obraName}":`);
        console.warn(`   - Extra√≠do do DOM: R$ ${valorTotalObra.toLocaleString('pt-BR')}`);
        console.warn(`   - Soma dos projetos: R$ ${somaVerificacao.toLocaleString('pt-BR')}`);
        console.warn(`   - Diferen√ßa: R$ ${(valorTotalObra - somaVerificacao).toLocaleString('pt-BR')}`);
        
        // Usa a soma dos projetos como fallback
        obraData.valorTotalObra = somaVerificacao;
    }

    console.log('üì¶ Dados da obra constru√≠dos:', {
        obra: obraData.nome,
        id: obraData.id,
        valorTotalObra: `R$ ${obraData.valorTotalObra.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
        projetos: `${projetosProcessados}/${projectElements.length} processados`
    });
    
    return obraData;
}

/**
 * Extrai o valor total da obra do DOM
 */
function extractValorTotalObra(obraElement) {
    const obraId = obraElement.dataset.obraId;
    const totalElement = document.getElementById(`total-obra-valor-${obraId}`);
    
    if (totalElement) {
        const texto = totalElement.textContent || 'R$ 0,00';
        return parseValorMonetario(texto);
    }
    
    // Se n√£o encontrar, calcula manualmente
    console.log(`‚ö†Ô∏è Elemento de total n√£o encontrado para obra ${obraId}, calculando manualmente...`);
}



/**
 * Constr√≥i o objeto de dados completo de um projeto a partir do HTML
 */
function buildProjectData(projectIdOrElement) {
    let projectElement;
    
    if (typeof projectIdOrElement === 'string') {
        projectElement = document.querySelector(`[data-project-name="${projectIdOrElement}"]`);
    } else if (projectIdOrElement instanceof HTMLElement) {
        projectElement = projectIdOrElement;
    } else {
        console.error('‚ùå Tipo inv√°lido para projectIdOrElement:', projectIdOrElement);
        return null;
    }

    if (!projectElement) {
        console.error('‚ùå Elemento do projeto n√£o encontrado:', projectIdOrElement);
        return null;
    }

    if (!document.body.contains(projectElement)) {
        console.error('‚ùå CR√çTICO: Elemento do projeto N√ÉO EST√Å MAIS NO DOM!');
        return null;
    }

    const projectName = projectElement.dataset.projectName || projectElement.id;
    const projectId = projectElement.dataset.projectId;
    const obraElement = projectElement.closest('.obra-block');

    if (!obraElement) {
        console.error('‚ùå Elemento da obra pai n√£o encontrado para projeto:', projectName);
        return null;
    }

    const finalProjectId = projectId || generateProjectId(obraElement);

    const valorTotalProjeto = extractValorTotalProjeto(projectElement);

    const projectData = {
        id: finalProjectId,
        nome: projectName,
        salas: [],
        servicos: extractServicosData(projectElement),
        valorTotalProjeto: valorTotalProjeto 
    };

    const roomElements = projectElement.querySelectorAll('.room-block');
    console.log(`üîç Encontradas ${roomElements.length} salas no projeto "${projectName}"`);
    
    let salasProcessadas = 0;
    
    roomElements.forEach((roomElement, index) => {
        if (!document.body.contains(roomElement)) {
            console.error(`‚ùå Sala ${index} foi removida do DOM durante o processamento!`);
            return;
        }
        
        const roomData = extractRoomData(roomElement, projectElement);
        if (roomData) {
            projectData.salas.push(roomData);
            salasProcessadas++;
        }
    });

    console.log(`‚úÖ Projeto "${projectName}" processado: ${salasProcessadas}/${roomElements.length} salas`);
    console.log(`üí∞ Valor total do projeto: R$ ${valorTotalProjeto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
    console.log(`üìä Servi√ßos extra√≠dos:`, projectData.servicos);
    
    return projectData;
}

/**
 * Extrai o valor total do projeto do DOM
 */
function extractValorTotalProjeto(projectElement) {
    const projectId = projectElement.dataset.projectId;
    const totalElement = document.getElementById(`total-projeto-valor-${projectId}`);
    
    if (totalElement) {
        const texto = totalElement.textContent || 'R$ 0,00';
        return parseValorMonetario(texto);
    }
    
    // Se n√£o encontrar, calcula manualmente
    console.log(`‚ö†Ô∏è Elemento de total n√£o encontrado para projeto ${projectId}, calculando manualmente...`);
}



/**
 * Fun√ß√£o auxiliar: Converte texto monet√°rio para n√∫mero
 */
function parseValorMonetario(texto) {
    if (!texto || typeof texto !== 'string') return 0;
    
    // Remove "R$" e espa√ßos
    let limpo = texto.replace(/R\$/g, '').trim();
    
    // Se n√£o tem v√≠rgula, assume valor inteiro
    if (!limpo.includes(',')) {
        // Remove pontos (separadores de milhar)
        limpo = limpo.replace(/\./g, '');
        return parseFloat(limpo) || 0;
    }
    
    // Tem v√≠rgula (formato brasileiro)
    // Remove pontos (separadores de milhar) e troca v√≠rgula por ponto
    limpo = limpo.replace(/\./g, '').replace(',', '.');
    
    return parseFloat(limpo) || 0;
}

/**
 * Extrai dados dos servi√ßos de um projeto (SIMPLIFICADA)
 */
function extractServicosData(projectElement) {
    const sectionBlock = projectElement.querySelector('.section-block[data-project-id]');
    if (!sectionBlock) {
        console.log(`üì≠ Projeto n√£o possui se√ß√£o de servi√ßos`);
        return {
            engenharia: null,
            adicionais: []
        };
    }

    const servicosData = {
        engenharia: extractEngenhariaData(sectionBlock),
        adicionais: extractAdicionaisData(sectionBlock)
    };

    console.log(`üìä Dados de servi√ßos extra√≠dos:`, servicosData);
    return servicosData;
}

/**
 * Extrai dados da subse√ß√£o de Engenharia
 */
function extractEngenhariaData(sectionBlock) {
    const engenhariaBlock = sectionBlock.querySelector('.subsection-block:first-child');
    if (!engenhariaBlock) return null;

    const valorInput = engenhariaBlock.querySelector('.input-valor');
    const descricaoTextarea = engenhariaBlock.querySelector('.input-texto');

    return {
        valor: valorInput ? parseFloat(valorInput.value) || 0 : 0,
        descricao: descricaoTextarea ? descricaoTextarea.value : ''
    };
}

/**
 * Extrai dados dos adicionais (SIMPLIFICADA - sem tipo)
 */
function extractAdicionaisData(sectionBlock) {
    const adicionaisContainer = sectionBlock.querySelector('.adicionais-container');
    if (!adicionaisContainer) return [];

    const adicionais = [];
    const adicionaisItems = adicionaisContainer.querySelectorAll('.adicional-item');

    adicionaisItems.forEach((item, index) => {
        const valorInput = item.querySelector('.input-valor');
        const descricaoTextarea = item.querySelector('.input-texto');
        
        const adicionalData = {
            id: item.dataset.itemId || `adicional-${index}`,
            valor: valorInput ? parseFloat(valorInput.value) || 0 : 0,
            descricao: descricaoTextarea ? descricaoTextarea.value : ''
        };

        adicionais.push(adicionalData);
    });

    return adicionais;
}

// EXPORTS NO FINAL
export {
    buildObraData,
    buildProjectData,
    extractServicosData,
    extractValorTotalObra
};
/* ==== FIM: data/builders/data-builders-folder/obra-data-builder.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/obra-renderer.js ==== */
import { ensureStringId } from '../../utils/id-generator.js';
import { waitForElement } from '../../utils/core-utils.js';
import { 
    buildObraHTML, 
    createEmptyObra,
    createObraFromServer 
} from '../../../features/managers/obra-folder/obra-creator.js';

/**
 * Fun√ß√£o auxiliar para remover mensagem vazia de projetos
 */
function removeProjectEmptyMessage(obraId) {
    const projectsContainer = document.getElementById(`projects-${obraId}`);
    if (projectsContainer) {
        const emptyMessage = projectsContainer.querySelector('.empty-message');
        if (emptyMessage) {
            emptyMessage.remove();
        }
    }
}

/**
 * Renderiza uma obra completa a partir dos dados carregados do servidor
 */
function renderObraFromData(obraData) {
    const obraName = obraData.nome;
    const obraId = ensureStringId(obraData.id);

    // Usa createEmptyObra com isFromServer = true
    createEmptyObra(obraName, obraId, true);

    if (obraData.projetos && obraData.projetos.length > 0) {
        const obraContent = document.getElementById(`obra-content-${obraId}`);

        if (obraContent) {
            removeProjectEmptyMessage(obraId);

            setTimeout(() => {
                obraData.projetos.forEach((projectData) => {
                    renderProjectFromData(projectData, obraId, obraName);
                });
            }, 100);
        }
    }
}

/**
 * Atualizar texto do bot√£o de cadastro de empresa
 */
function atualizarTextoBotaoEmpresa(obraId, texto = "Visualizar campos de cadastro de empresas") {
    const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraElement) return false;

    const botao = obraElement.querySelector('.btn-empresa-cadastro');
    if (botao) {
        botao.textContent = texto;
        return true;
    }

    return false;
}

/**
 * FUN√á√ÉO PARA ATUALIZAR TODOS OS BOT√ïES DE EMPRESA (para obras existentes)
 */
function atualizarTodosBotoesEmpresa() {
    const botoes = document.querySelectorAll('.btn-empresa-cadastro');
    let atualizados = 0;

    botoes.forEach(botao => {
        const textoAtual = botao.textContent.trim();
        if (textoAtual === "Adicionar campos de cadastro de empresas") {
            botao.textContent = "Visualizar campos de cadastro de empresas";
            atualizados++;
        }
    });

    return atualizados;
}

/**
 * Preenche os dados de uma obra a partir do JSON
 */
async function populateObraData(obraData) {
    if (!obraData || typeof obraData !== 'object') return;

    const hasValidId = obraData.id && obraData.id !== "" && obraData.id !== "null" && obraData.id !== "undefined";
    const hasValidName = obraData.nome && obraData.nome !== "" && obraData.nome !== "null" && obraData.nome !== "undefined";

    if (!hasValidId && !hasValidName) return;

    const obraName = obraData.nome || `Obra-${obraData.id}`;
    const obraId = obraData.id;

    let obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);

    if (!obraElement) {
        const obraCriada = await createObraFromServer(obraData);
        
        if (!obraCriada) return;

        await new Promise(resolve => setTimeout(resolve, 150));

        obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
    } else {
        atualizarTextoBotaoEmpresa(obraId, "Visualizar campos de cadastro de empresas");
        
        if (typeof window.updateObraButtonAfterSave === 'function') {
            window.updateObraButtonAfterSave(obraName, obraId);
        }
    }

    if (!obraElement) return;

    if (obraData.empresaSigla || obraData.empresaNome || obraData.empresa_id) {
        if (typeof window.prepararDadosEmpresaNaObra === 'function') {
            try {
                await window.prepararDadosEmpresaNaObra(obraData, obraElement);
            } catch (error) {}
        } else {
            const camposEmpresa = ['empresaSigla', 'empresaNome', 'empresa_id'];
            camposEmpresa.forEach(campo => {
                if (obraData[campo]) {
                    obraElement.dataset[campo] = obraData[campo];
                }
            });
        }
    }

    if (typeof window.createEmptyProject !== 'function' || typeof window.createEmptyRoom !== 'function') {
        await new Promise(resolve => setTimeout(resolve, 500));

        if (typeof window.createEmptyProject !== 'function' || typeof window.createEmptyRoom !== 'function') {
            return;
        }
    }

    const projectsContainer = obraElement.querySelector('.projects-container');
    if (projectsContainer) {
        const existingProjects = projectsContainer.querySelectorAll('.project-block');
        if (existingProjects.length > 0) {
            existingProjects.forEach(project => project.remove());
        }
    }

    const projetos = obraData.projetos || [];

    const projetosPromises = [];

    for (let i = 0; i < projetos.length; i++) {
        const projectData = projetos[i];
        if (!projectData || !projectData.nome) continue;

        const projectName = projectData.nome;
        const projectId = projectData.id;

        projetosPromises.push(processProjectAsync(projectData, obraId, obraName, i));

        if (projetosPromises.length >= 3) {
            await Promise.allSettled(projetosPromises);
            projetosPromises.length = 0;
            await new Promise(resolve => setTimeout(resolve, 100));
        }
    }

    if (projetosPromises.length > 0) {
        await Promise.allSettled(projetosPromises);
    }

    // Remove mensagem vazia ap√≥s processar todos os projetos
    removeProjectEmptyMessage(obraId);
}

/**
 * Processa um projeto de forma ass√≠ncrona
 */
async function processProjectAsync(projectData, obraId, obraName, index) {
    const projectName = projectData.nome;
    const projectId = projectData.id;

    try {
        const projectCreated = await window.createEmptyProject(obraId, obraName, projectId, projectName);

        if (!projectCreated) return false;

        await new Promise(resolve => setTimeout(resolve, 200));

        const projectElement = await waitForElement(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`, 3000);

        if (!projectElement) {
            const allProjects = document.querySelectorAll('.project-block');
            const foundProject = Array.from(allProjects).find(proj =>
                proj.dataset.projectId === projectId && proj.dataset.obraId === obraId
            );

            if (foundProject) {
                await populateProjectData(foundProject, projectData, obraId, obraName);
                return true;
            }

            return false;
        }

        if (projectData.servicos && (projectData.servicos.engenharia || projectData.servicos.adicionais?.length > 0)) {
            setTimeout(() => populateServicosData(projectElement, projectData.servicos), 300);
        }

        await populateProjectData(projectElement, projectData, obraId, obraName);
        return true;

    } catch (error) {
        return false;
    }
}

/**
 * Preenche os dados de servi√ßos em um projeto
 */
async function populateServicosData(projectElement, servicosData) {
    try {
        let sectionBlock = projectElement.querySelector('.section-block[data-project-id]');
        if (!sectionBlock) {
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    sectionBlock = projectElement.querySelector('.section-block[data-project-id]');
                    if (sectionBlock) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }

        if (!sectionBlock) return;

        if (servicosData.engenharia) {
            const engenhariaBlock = sectionBlock.querySelector('.subsection-block:first-child');
            if (engenhariaBlock) {
                const valorInput = engenhariaBlock.querySelector('.input-valor');
                const descricaoTextarea = engenhariaBlock.querySelector('.input-texto');

                if (valorInput && servicosData.engenharia.valor) {
                    valorInput.value = servicosData.engenharia.valor;
                }

                if (descricaoTextarea && servicosData.engenharia.descricao) {
                    descricaoTextarea.value = servicosData.engenharia.descricao;
                }
            }
        }

        if (servicosData.adicionais && servicosData.adicionais.length > 0) {
            const container = sectionBlock.querySelector('.adicionais-container');

            if (container) {
                container.innerHTML = '';

                for (const adicional of servicosData.adicionais) {
                    const temValor = adicional.valor && adicional.valor > 0;
                    const temDescricao = adicional.descricao && adicional.descricao.trim() !== '';

                    if (temValor && temDescricao) {
                        if (typeof window.addAdicionalConjunto === 'function') {
                            const projectId = projectElement.dataset.projectId;
                            window.addAdicionalConjunto(projectId);

                            await new Promise(resolve => setTimeout(resolve, 50));

                            const ultimoItem = container.querySelector('.adicional-item:last-child');
                            if (ultimoItem) {
                                const valorInput = ultimoItem.querySelector('.input-valor');
                                const descricaoTextarea = ultimoItem.querySelector('.input-texto');

                                if (valorInput && adicional.valor) {
                                    valorInput.value = adicional.valor;
                                }
                                if (descricaoTextarea && adicional.descricao) {
                                    descricaoTextarea.value = adicional.descricao;
                                }
                            }
                        }
                    } else if (temValor) {
                        if (typeof window.addAdicionalValor === 'function') {
                            const projectId = projectElement.dataset.projectId;
                            window.addAdicionalValor(projectId);

                            await new Promise(resolve => setTimeout(resolve, 50));

                            const ultimoItem = container.querySelector('.adicional-item:last-child');
                            if (ultimoItem && adicional.valor) {
                                const valorInput = ultimoItem.querySelector('.input-valor');
                                if (valorInput) valorInput.value = adicional.valor;
                            }
                        }
                    } else if (temDescricao) {
                        if (typeof window.addAdicionalTexto === 'function') {
                            const projectId = projectElement.dataset.projectId;
                            window.addAdicionalTexto(projectId);

                            await new Promise(resolve => setTimeout(resolve, 50));

                            const ultimoItem = container.querySelector('.adicional-item:last-child');
                            if (ultimoItem && adicional.descricao) {
                                const descricaoTextarea = ultimoItem.querySelector('.input-texto');
                                if (descricaoTextarea) descricaoTextarea.value = adicional.descricao;
                            }
                        }
                    }

                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
        }

    } catch (error) {}
}

/**
 * Atualizar dados da empresa em todas as obras
 */
async function atualizarEmpresaEmTodasObras(empresaData) {
    const obras = document.querySelectorAll('.obra-block[data-obra-id]');

    for (const obraElement of obras) {
        try {
            const obraId = obraElement.dataset.obraId;

            if (typeof window.obterDadosEmpresaDaObra === 'function') {
                const dadosObra = window.obterDadosEmpresaDaObra(obraId);

                if (dadosObra && typeof window.prepararDadosEmpresaNaObra === 'function') {
                    await window.prepararDadosEmpresaNaObra(dadosObra, obraElement);
                }
            }
        } catch (error) {}
    }
}

// ADICIONAR FUN√á√ïES AUXILIARES AO OBJETO GLOBAL
if (typeof window !== 'undefined') {
    window.atualizarEmpresaEmTodasObras = atualizarEmpresaEmTodasObras;
    window.atualizarTextoBotaoEmpresa = atualizarTextoBotaoEmpresa;
    window.atualizarTodosBotoesEmpresa = atualizarTodosBotoesEmpresa;
    window.populateServicosData = populateServicosData;
    window.removeProjectEmptyMessage = removeProjectEmptyMessage;

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(atualizarTodosBotoesEmpresa, 1000);
        });
    } else {
        setTimeout(atualizarTodosBotoesEmpresa, 1000);
    }
}

// FUN√á√ÉO PARA ATUALIZAR BOT√ïES DINAMICAMENTE
function inicializarAtualizacaoBotoesEmpresa() {
    atualizarTodosBotoesEmpresa();

    let tentativas = 0;
    const maxTentativas = 5;

    const intervalId = setInterval(() => {
        tentativas++;
        const atualizados = atualizarTodosBotoesEmpresa();

        if (atualizados > 0 || tentativas >= maxTentativas) {
            clearInterval(intervalId);
        }
    }, 2000);

    return intervalId;
}

// EXPORTS NO FINAL
export {
    renderObraFromData,
    populateObraData,
    processProjectAsync,
    populateServicosData, 
    atualizarEmpresaEmTodasObras,
    atualizarTextoBotaoEmpresa,
    atualizarTodosBotoesEmpresa,
    inicializarAtualizacaoBotoesEmpresa
};
/* ==== FIM: data/builders/ui-folder/obra-renderer.js ==== */

/* ==== IN√çCIO: features/managers/obra-folder/obra-utils.js ==== */
import { showConfirmationModal } from '../../../ui/components/modal/modal.js';
import { calculateRoomCompletionStats } from '../../../ui/helpers.js';

/**
 * üóëÔ∏è FUN√á√ïES DE REMO√á√ÉO E VERIFICA√á√ÉO
 */

async function deleteObra(obraName, obraId) {
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraBlock) {
        console.error(`‚ùå Obra com ID ${obraId} n√£o encontrada`);
        return;
    }

    showConfirmationModal(obraName, obraId, obraBlock);
}

function verifyObraData(obraId) {
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraBlock) {
        console.error(`‚ùå Obra com ID "${obraId}" n√£o encontrada para verifica√ß√£o`);
        alert(`ERRO: Obra com ID "${obraId}" n√£o encontrada`);
        return;
    }

    const obraName = obraBlock.dataset.obraName;
    const projects = obraBlock.querySelectorAll(".project-block");
    let totalRooms = 0;
    
    let report = `Verifica√ß√£o da Obra "${obraName}" (ID: ${obraId}):\n\n`;
    report += `Total de projetos: ${projects.length}\n\n`;

    projects.forEach((project, index) => {
        const projectName = project.dataset.projectName;
        const rooms = project.querySelectorAll(".room-block");
        totalRooms += rooms.length;
        
        report += `Projeto ${index + 1}: ${projectName}\n`;
        report += `  - Salas: ${rooms.length}\n`;
        
        rooms.forEach((room, roomIndex) => {
            const roomName = room.querySelector(".room-title")?.textContent || `Sala ${roomIndex + 1}`;
            const stats = calculateRoomCompletionStats(room);
            report += `    - ${roomName}: ${stats.filled}/${stats.total} campos (${stats.percentage}%)\n`;
        });
        report += '\n';
    });

    report += `RESUMO: ${projects.length} projetos, ${totalRooms} salas`;

    console.log(`üîç Relat√≥rio gerado para obra: ${obraName} (ID: ${obraId})`);
    alert(report);
}

// EXPORTS NO FINAL
export {
    deleteObra,
    verifyObraData
};
/* ==== FIM: features/managers/obra-folder/obra-utils.js ==== */

/* ==== IN√çCIO: features/managers/project-manager.js ==== */
import { createEmptyRoom } from '../../data/modules/rooms.js';
import { generateProjectId } from '../../data/utils/id-generator.js';
import { getNextProjectNumber } from '../../data/utils/data-utils.js'
import { removeEmptyObraMessage } from '../../ui/helpers.js';
import { addNewRoomToProject } from '../../data/modules/rooms.js';
import { buildServicosInProject } from './servicos.js';

// Cache de totais por projeto
const projectTotals = new Map();

/**
 * Converte texto monet√°rio para n√∫mero
 */
function parseCurrency(text) {
    if (!text || typeof text !== 'string') return 0;
    
    // Remove "R$" e espa√ßos
    let cleaned = text.replace(/R\$/g, '').trim();
    
    // Se n√£o tem v√≠rgula, assume que √© valor inteiro
    if (!cleaned.includes(',')) {
        // Remove pontos (separadores de milhar)
        cleaned = cleaned.replace(/\./g, '');
        const result = parseFloat(cleaned);
        return isNaN(result) ? 0 : result;
    }
    
    // Tem v√≠rgula (formato brasileiro)
    // Remove todos os pontos (separadores de milhar)
    cleaned = cleaned.replace(/\./g, '');
    
    // Troca v√≠rgula por ponto para parseFloat
    cleaned = cleaned.replace(',', '.');
    
    const result = parseFloat(cleaned);
    return isNaN(result) ? 0 : result;
}

/**
 * Sistema de Eventos para total do projeto
 */
class ProjectTotalManager {
    constructor() {
        this.observers = new Map();
        this.updating = new Set();
        this.setupEventListeners();
    }

    setupEventListeners() {
        document.addEventListener('valorAtualizado', (event) => {
            const { projectId } = event.detail;
            if (projectId && !this.updating.has(projectId)) {
                this.scheduleUpdate(projectId);
            }
        });
    }

    scheduleUpdate(projectId) {
        clearTimeout(this[`timeout_${projectId}`]);
        this[`timeout_${projectId}`] = setTimeout(() => {
            this.updateProjectTotal(projectId);
        }, 300);
    }

    calculateProjectTotal(projectId) {
        const projectElement = document.querySelector(`[data-project-id="${projectId}"]`);
        if (!projectElement) return 0;

        let total = 0;

        // 1. Servi√ßos
        try {
            if (typeof calculateServicosTotal === 'function') {
                const servicosTotal = calculateServicosTotal(projectId);
                total += servicosTotal;
            }
        } catch (error) {}

        // 2. Salas
        const rooms = projectElement.querySelectorAll('.room-block');

        rooms.forEach(room => {
            const roomId = room.dataset.roomId;

            // M√°quinas
            const machinesElement = this.findMachinesTotalElement(roomId);
            if (machinesElement) {
                const machinesText = machinesElement.textContent.trim();
                const machinesValue = parseCurrency(machinesText);
                total += machinesValue;
            }

            // Acess√≥rios
            const acessoriosElement = document.getElementById(`acessorios-total-${roomId}`);
            if (acessoriosElement) {
                const acessoriosText = acessoriosElement.textContent.trim();
                const acessoriosValue = parseCurrency(acessoriosText);
                total += acessoriosValue;
            }

            // Dutos
            const dutosElement = document.getElementById(`dutos-total-${roomId}`);
            if (dutosElement) {
                const dutosText = dutosElement.textContent.trim();
                const dutosValue = parseCurrency(dutosText);
                total += dutosValue;
            }

            // Tubula√ß√£o
            const tubulacaoElement = document.getElementById(`total-geral-valor-${roomId}`);
            if (tubulacaoElement) {
                const tubulacaoText = tubulacaoElement.textContent.trim();
                const tubulacaoValue = parseCurrency(tubulacaoText);
                total += tubulacaoValue;
            }
        });

        return total;
    }

    /**
     * Encontra o elemento de total de m√°quinas
     */
    findMachinesTotalElement(roomId) {
        // Tenta primeiro pelo formato direto
        let element = document.getElementById(`total-all-machines-price-${roomId}`);

        if (element) return element;

        // Se n√£o encontrar, busca por elementos que contenham o padr√£o
        const allElements = document.querySelectorAll('[id*="total-all-machines-price-"]');

        for (const el of allElements) {
            // Verifica se o ID termina com o roomId ou cont√©m o roomId
            if (el.id.includes(roomId) ||
                el.id.endsWith(roomId) ||
                el.id.includes(`sala_${roomId.split('_').pop()}`)) {
                return el;
            }
        }

        return null;
    }

    updateProjectTotal(projectId) {
        if (this.updating.has(projectId)) return;

        this.updating.add(projectId);

        try {
            const total = this.calculateProjectTotal(projectId);
            this.updateDisplay(projectId, total);
            projectTotals.set(projectId, total);
        } catch (error) {
        } finally {
            this.updating.delete(projectId);
        }
    }

    updateDisplay(projectId, total) {
        const displayElement = document.getElementById(`total-projeto-valor-${projectId}`);
        if (!displayElement) return;

        const formattedValue = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(total);

        displayElement.textContent = formattedValue;

        // Removidas as classes has-value, high-value e zero
        displayElement.classList.add('updating');
        setTimeout(() => {
            displayElement.classList.remove('updating');
        }, 500);
    }

    registerObserver(projectId, callback) {
        if (!this.observers.has(projectId)) {
            this.observers.set(projectId, new Set());
        }
        this.observers.get(projectId).add(callback);
    }

    unregisterObserver(projectId, callback) {
        if (this.observers.has(projectId)) {
            this.observers.get(projectId).delete(callback);
        }
    }
}

// Inicializa o gerenciador global
const totalManager = new ProjectTotalManager();

/**
 * Constr√≥i o HTML de um projeto
 */
function buildProjectHTML(obraId, obraName, projectId, projectName) {
    if (!obraId || obraId === 'undefined' || obraId === 'null') {
        return ''
    }

    const finalProjectId = projectId || generateProjectId(document.querySelector(`[data-obra-id="${obraId}"]`))

    if (!finalProjectId || finalProjectId === 'undefined' || finalProjectId === 'null') {
        return ''
    }

    return `
        <div class="project-block" 
             data-project-id="${finalProjectId}" 
             data-project-name="${projectName}" 
             data-obra-id="${obraId}" 
             data-obra-name="${obraName}">
            <div class="project-header">
                <button class="minimizer" onclick="toggleProject('${finalProjectId}', event)">+</button>
                <h3 class="project-title editable-title" data-editable="true" onclick="makeEditable(this, 'project')">${projectName}</h3>
                <div class="project-actions">
                    <button class="btn btn-delete" onclick="deleteProject('${obraId}', '${finalProjectId}')">Remover Projeto</button>
                </div>
            </div>
            
            <div class="project-content collapsed" id="project-content-${finalProjectId}">
                ${buildServicosInProject(finalProjectId)}
                
                <div class="rooms-container">
                    <p class="empty-message">Adicione salas a este projeto...</p>
                </div>
                
                <div class="add-room-section">
                    <button class="btn btn-add-secondary" onclick="addNewRoom('${obraId}', '${finalProjectId}')">
                        + Adicionar Sala
                    </button>
                    
                    <span class="project-total-value" id="total-projeto-valor-${finalProjectId}" 
                          data-project-id="${finalProjectId}" 
                          title="Valor total do projeto">
                        R$ 0,00
                    </span>
                </div>
            </div>
        </div>
    `
}

/**
 * Cria um projeto vazio na obra
 */
async function createEmptyProject(obraId, obraName, projectId, projectName) {
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`)

    if (!obraBlock) {
        return false
    }

    const projectsContainer = document.getElementById(`projects-${obraId}`)
    if (!projectsContainer) {
        return false
    }

    removeEmptyObraMessage(obraName)

    const projectNumber = getNextProjectNumber(obraId)
    const finalProjectId = projectId || generateProjectId(obraBlock, projectNumber)

    if (!finalProjectId) {
        return false
    }

    const projectHTML = buildProjectHTML(obraId, obraName, finalProjectId, projectName)
    projectsContainer.insertAdjacentHTML('beforeend', projectHTML)

    // Remove mensagem de "nenhum projeto"
    const emptyMessage = projectsContainer.querySelector('.empty-message');
    if (emptyMessage) {
        emptyMessage.remove();
    }

    setTimeout(() => {
        totalManager.updateProjectTotal(finalProjectId);
    }, 1000);

    return true
}

/**
 * Adiciona um novo projeto √† obra especificada
 */
async function addNewProjectToObra(obraId) {
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);

    if (!obraBlock) {
        return;
    }

    const obraName = obraBlock.dataset.obraName;
    const projectNumber = getNextProjectNumber(obraId);
    const projectName = `Projeto${projectNumber}`;
    const projectId = generateProjectId(obraBlock);

    await createEmptyProject(obraId, obraName, projectId, projectName);

    if (typeof window.addNewRoomToProject === 'function') {
        await window.addNewRoomToProject(obraId, projectId);
    }
}

/**
 * Remove um projeto da obra
 */
function deleteProject(obraId, projectId) {
    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`)

    if (!projectElement) {
        return
    }

    projectTotals.delete(projectId);

    const projectName = projectElement.dataset.projectName
    projectElement.remove()
}

/**
 * Inicializa totais para projetos existentes
 */
function initializeExistingProjectTotals() {
    const projectBlocks = document.querySelectorAll('.project-block');

    projectBlocks.forEach(project => {
        const projectId = project.dataset.projectId;
        if (projectId) {
            let totalElement = document.getElementById(`total-projeto-valor-${projectId}`);

            if (!totalElement) {
                const addRoomSection = project.querySelector('.add-room-section');
                if (addRoomSection) {
                    addRoomSection.insertAdjacentHTML('beforeend',
                        `<span class="project-total-value" id="total-projeto-valor-${projectId}" 
                              data-project-id="${projectId}" 
                              title="Valor total do projeto">
                            R$ 0,00
                        </span>`
                    );
                }
            }

            setTimeout(() => {
                totalManager.updateProjectTotal(projectId);
            }, 1000);
        }
    });
}

// Fun√ß√µes globais
if (typeof window !== 'undefined') {
    window.addNewProjectToObra = addNewProjectToObra;
    window.getNextProjectNumber = getNextProjectNumber;
    window.deleteProject = deleteProject;
    window.createEmptyProject = createEmptyProject;
    window.buildProjectHTML = buildProjectHTML;
    window.addNewRoomToProject = addNewRoomToProject || window.addNewRoomToProject;
    window.initializeExistingProjectTotals = initializeExistingProjectTotals;
    window.parseCurrency  = parseCurrency ;
    window.updateProjectTotal = (projectId) => totalManager.updateProjectTotal(projectId);
}

// Inicializa quando carregado
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeExistingProjectTotals);
} else {
    setTimeout(initializeExistingProjectTotals, 1000);
}

export {
    createEmptyProject,
    buildProjectHTML,
    addNewProjectToObra,
    deleteProject,
    initializeExistingProjectTotals
}
/* ==== FIM: features/managers/project-manager.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/project-renderer.js ==== */
import { ensureStringId } from '../../utils/id-generator.js';
import { waitForElement } from '../../utils/core-utils.js';

/**
 * Renderiza um projeto completo a partir dos dados carregados - ATUALIZADO COM REFER√äNCIA A SERVI√áOS
 */
function renderProjectFromData(projectData, obraId = null, obraName = null) {
    const projectName = projectData.nome;
    const projectId = ensureStringId(projectData.id);

    console.log(`üéØ Renderizando projeto: ${projectName} (ID: ${projectId})`);

    if (!obraId) {
        const existingProject = document.querySelector(`[data-project-id="${projectId}"]`);
        obraId = existingProject?.dataset.obraId;
        obraName = existingProject?.dataset.obraName;
    }

    if (!obraId) {
        const obras = document.querySelectorAll('.obra-block');
        if (obras.length > 0) {
            const primeiraObra = obras[0];
            obraId = primeiraObra.dataset.obraId;
            obraName = primeiraObra.dataset.obraName;
        } else {
            obraName = 'Obra1';
            obraId = generateObraId();
            createEmptyObra(obraName, obraId);
        }
    }

    createEmptyProject(obraId, obraName, projectId, projectName);

    if (projectData.salas && projectData.salas.length > 0) {
        const projectContent = document.getElementById(`project-content-${projectId}`);

        if (projectContent) {
            const emptyMessage = projectContent.querySelector(".empty-message");
            if (emptyMessage) {
                emptyMessage.remove();
            }

            setTimeout(() => {
                projectData.salas.forEach((roomData) => {
                    renderRoomFromData(projectId, projectName, roomData, obraId, obraName);
                });
            }, 100);
        }
    }

    // ‚úÖ NOVO: Verificar se h√° servi√ßos para preencher
    if (projectData.servicos && (projectData.servicos.engenharia || projectData.servicos.adicionais?.length > 0)) {
        console.log(`üí∞ Projeto ${projectName} possui dados de servi√ßos, agendando preenchimento...`);
        
        // Aguardar um pouco mais para garantir que os servi√ßos foram criados
        setTimeout(async () => {
            const projectElement = await waitForElement(`[data-project-id="${projectId}"]`, 2000);
            if (projectElement && typeof window.populateServicosData === 'function') {
                console.log(`üí∞ Preenchendo servi√ßos no projeto ${projectName}`);
                await window.populateServicosData(projectElement, projectData.servicos);
            }
        }, 500);
    }

    if (projectId) {
        updateProjectButton(projectName, true);
    }

    console.log(`‚úÖ Projeto ${projectName} renderizado com sucesso`);
}

/**
 * Preenche os dados de um projeto a partir do JSON
 */
async function populateProjectData(projectElement, projectData, obraId, obraName) {
    const projectName = projectData.nome;
    const projectId = projectData.id;
    
    console.log(`üéØ Preenchendo projeto: ${projectName}`, { 
        salas: projectData.salas?.length,
        servicos: projectData.servicos ? 'Sim' : 'N√£o',
        obraId: obraId,
        projectId: projectId
    });

    console.log(`‚úÖ Projeto encontrado:`, projectElement.dataset);

    const roomsContainer = projectElement.querySelector('.rooms-container');
    if (roomsContainer) {
        const existingRooms = roomsContainer.querySelectorAll('.room-block');
        if (existingRooms.length > 0) {
            console.log(`üóëÔ∏è Removendo ${existingRooms.length} salas existentes antes do preenchimento`);
            existingRooms.forEach(room => room.remove());
        }
    }

    const salas = projectData.salas || [];
    console.log(`üö™ Processando ${salas.length} sala(s) para o projeto "${projectName}"`);
    
    for (let i = 0; i < salas.length; i++) {
        const roomData = salas[i];
        const roomName = roomData.nome;
        const roomId = roomData.id;
        
        if (!roomName || !roomId) {
            console.warn(`‚ö†Ô∏è Sala ${i} inv√°lida ou sem nome/ID:`, roomData);
            continue;
        }

        console.log(`üö™ [${i + 1}/${salas.length}] Criando sala: ${roomName} (ID: ${roomId})`);

        try {
            if (typeof window.createEmptyRoom !== 'function') {
                console.error('‚ùå createEmptyRoom n√£o dispon√≠vel');
                continue;
            }

            const roomCreated = await window.createEmptyRoom(obraId, projectId, roomName, roomId);
            
            if (!roomCreated) {
                console.error(`‚ùå Falha ao criar sala ${roomName}`);
                continue;
            }

            const roomElement = await waitForElement(`[data-room-id="${roomId}"]`, 3000);
            
            if (!roomElement) {
                console.error(`‚ùå Sala ${roomName} n√£o encontrada no DOM ap√≥s cria√ß√£o`);
                
                const allRooms = document.querySelectorAll('.room-block');
                console.log(`üîç Salas no DOM: ${allRooms.length}`);
                allRooms.forEach((room, idx) => {
                    console.log(`  ${idx + 1}. Sala: "${room.dataset.roomName}", ID: "${room.dataset.roomId}", Projeto: "${room.dataset.projectId}"`);
                });
                continue;
            }

            console.log(`‚úÖ Sala criada e encontrada: ${roomName}`, {
                element: roomElement,
                dataset: roomElement.dataset
            });

            await populateRoomData(roomElement, roomData);

        } catch (error) {
            console.error(`‚ùå Falha ao criar sala ${roomName}:`, error);
        }
        
        await new Promise(resolve => setTimeout(resolve, 300));
    }

    console.log(`‚úÖ Projeto "${projectName}" preenchido com sucesso - ${salas.length} sala(s) processada(s)`);
}

// EXPORTS NO FINAL
export {
    renderProjectFromData,
    populateProjectData
};
/* ==== FIM: data/builders/ui-folder/project-renderer.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/room-renderer.js ==== */
/*
* ARQUIVO DE RENDERIZA√á√ÉO DE salas
*/

import { ensureStringId } from '../../utils/id-generator.js';


/**
 * Renderiza uma sala individual a partir dos dados carregados
 */
function renderRoomFromData(projectId, projectName, roomData, obraId = null, obraName = null) {
    const roomName = roomData.nome;
    const roomId = ensureStringId(roomData.id);

    console.log(`üéØ Renderizando sala: ${roomName} no projeto ${projectName}`, {
        obra: obraName,
        projectId: projectId,
        roomId: roomId,
        inputs: Object.keys(roomData.inputs || {}).length,
        maquinas: roomData.maquinas?.length || 0,
        capacidade: Object.keys(roomData.capacidade || {}).length,
        ganhosTermicos: Object.keys(roomData.ganhosTermicos || {}).length,
        acessorios: roomData.acessorios?.length || 0,
        dutos: roomData.dutos?.length || 0, // ‚úÖ ADICIONADO: dutos
        conjuntosTubulacao: roomData.tubulacao?.conjuntos?.length || 0
    });

    setTimeout(() => {
        // Criar sala b√°sica
        createEmptyRoom(obraId, projectId, roomName, roomId);
        
        // Aguardar cria√ß√£o e garantir todas as se√ß√µes
        setTimeout(() => {
            const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
            if (roomElement) {
                // ‚úÖ GARANTIR que TODAS as se√ß√µes sejam criadas (incluindo dutos)
                ensureAllRoomSections(roomElement).then(sectionsReady => {
                    if (sectionsReady) {
                        console.log(`‚úÖ Todas as se√ß√µes criadas para ${roomName} - Iniciando preenchimento`);
                        populateRoomData(roomElement, roomData);
                    } else {
                        console.error(`‚ùå Falha ao criar se√ß√µes para ${roomName}`);
                    }
                }).catch(error => {
                    console.error(`‚ùå Erro ao garantir se√ß√µes para ${roomName}:`, error);
                    throw error;
                });
            } else {
                console.error(`‚ùå Elemento da sala ${roomId} n√£o encontrado ap√≥s cria√ß√£o`);
            }
        }, 300);
        
    }, 100);
}

/**
 * Preenche uma sala espec√≠fica dentro de um projeto
 */
async function populateRoomData(roomElement, roomData) {
    if (!roomElement || !roomData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return false;
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå Room ID inv√°lido no populateRoomData: "${roomId}"`);
        return false;
    }
    
    console.log(`üîÑ Preenchendo sala "${roomName}" (ID: ${roomId})`, {
        acessorios: roomData.acessorios?.length || 0,
        dutos: roomData.dutos?.length || 0, // ‚úÖ ADICIONADO: dutos
        tubulacaoConjuntos: roomData.tubulacao?.conjuntos?.length || 0,
        maquinas: roomData.maquinas?.length || 0
    });

    try {
        // ‚úÖ CORRE√á√ÉO: Garantir que todas as se√ß√µes existam antes de preencher
        console.log(`üèóÔ∏è Garantindo que todas as se√ß√µes existem para sala ${roomName}`);
        const sectionsReady = await ensureAllRoomSections(roomElement);
        if (!sectionsReady) {
            console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel garantir todas as se√ß√µes para ${roomName} - Continuando...`);
        }

        const roomTitle = roomElement.querySelector('.room-title');
        if (roomTitle && roomData.nome) {
            roomTitle.textContent = roomData.nome;
            console.log(`‚úÖ T√≠tulo da sala atualizado: ${roomData.nome}`);
        }

        if (roomData.inputs) {
            console.log(`üå°Ô∏è Preenchendo inputs de climatiza√ß√£o para sala ${roomName}`);
            fillClimatizationInputs(roomElement, roomData.inputs);
        }

        if (roomData.ganhosTermicos) {
            console.log(`üìä Preenchendo ganhos t√©rmicos para sala ${roomName}`);
            fillThermalGainsData(roomElement, roomData.ganhosTermicos);
        }

        if (roomData.capacidade) {
            console.log(`‚ö° Preenchendo dados de capacidade para sala ${roomName}`);
            fillCapacityData(roomElement, roomData.capacidade);
        }

        // ‚úÖ Preencher acessorios
        if (roomData.acessorios && Array.isArray(roomData.acessorios)) {
            console.log(`üîß Preenchendo ${roomData.acessorios.length} acessorio(s) para sala ${roomName}`);
            
            // Aguardar um pouco para garantir que a se√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillAcessoriosData === 'function') {
                    window.fillAcessoriosData(roomElement, roomData.acessorios);
                    console.log(`‚úÖ Acessorios preenchidos via fun√ß√£o global`);
                } else {
                    console.error(`‚ùå Fun√ß√£o fillAcessoriosData n√£o dispon√≠vel no window`);
                }
            }, 2000);
        }

        // ‚úÖ Preencher dutos
        if (roomData.dutos && Array.isArray(roomData.dutos)) {
            console.log(`üìè Preenchendo ${roomData.dutos.length} duto(s) para sala ${roomName}`);
            
            // Aguardar um pouco para garantir que a se√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillDutosData === 'function') {
                    window.fillDutosData(roomElement, roomData.dutos);
                    console.log(`‚úÖ Dutos preenchidos via fun√ß√£o global`);
                } else {
                    console.error(`‚ùå Fun√ß√£o fillDutosData n√£o dispon√≠vel no window`);
                }
            }, 2500);
        }

        // ‚úÖ CORRE√á√ÉO CR√çTICA: Preencher tubula√ß√£o - CUIDADO COM A ESTRUTURA
        if (roomData.tubulacao && roomData.tubulacao.conjuntos && Array.isArray(roomData.tubulacao.conjuntos)) {
            console.log(`üîß Preenchendo ${roomData.tubulacao.conjuntos.length} conjunto(s) de tubula√ß√£o para sala ${roomName}`);
            
            // Aguardar mais tempo para garantir que a se√ß√£o de tubula√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillTubulacaoData === 'function') {
                    // ‚úÖ CORRE√á√ÉO: Passar o objeto completo de tubula√ß√£o
                    window.fillTubulacaoData(roomElement, roomData.tubulacao);
                    console.log(`‚úÖ Tubula√ß√£o preenchida via fun√ß√£o global`, {
                        conjuntos: roomData.tubulacao.conjuntos.length,
                        estrutura: 'conjuntos array dentro de objeto tubulacao'
                    });
                } else {
                    console.error(`‚ùå Fun√ß√£o fillTubulacaoData n√£o dispon√≠vel no window - Verifique se tubos.js foi carregado`);
                }
            }, 3000);
        } else if (roomData.tubulacao) {
            console.warn(`‚ö†Ô∏è Estrutura de tubula√ß√£o inv√°lida ou vazia para sala ${roomName}:`, roomData.tubulacao);
        }

        // ‚úÖ Preencher m√°quinas
        if (roomData.maquinas && Array.isArray(roomData.maquinas)) {
            console.log(`ü§ñ Agendando preenchimento de ${roomData.maquinas.length} m√°quina(s) para sala ${roomName}`);
            
            // Aguardar mais tempo para garantir que todas as outras se√ß√µes foram preenchidas
            setTimeout(async () => {
                try {
                    console.log(`üöÄ Iniciando preenchimento de m√°quinas para sala ${roomName}`);
                    
                    const success = await fillMachinesData(roomElement, roomData.maquinas);
                    
                    if (success) {
                        console.log(`üéâ Todas as m√°quinas preenchidas com sucesso para sala ${roomName}`);
                    } else {
                        console.error(`‚ùå Falha ao preencher m√°quinas para sala ${roomName}`);
                    }
                } catch (error) {
                    console.error(`üí• Erro ao preencher m√°quinas para sala ${roomName}:`, error);
                }
            }, 4000);
        }

        console.log(`‚úÖ Sala "${roomName}" preenchida com sucesso`);
        return true;

    } catch (error) {
        console.error(`‚ùå Erro ao preencher sala "${roomName}":`, error);
        return false;
    }
}

/**
 * Preenche os inputs de uma sala espec√≠fica
 */
function populateRoomInputs(projectId, projectName, roomId, roomName, roomData, obraId, obraName) {
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (roomElement) {
        populateRoomData(roomElement, roomData);
    } else {
        console.error(`‚ùå Elemento da sala ${roomId} n√£o encontrado no DOM`);
    }
}

// EXPORTS NO FINAL
export {
    renderRoomFromData,
    populateRoomData,
    populateRoomInputs
};
/* ==== FIM: data/builders/ui-folder/room-renderer.js ==== */

/* ==== IN√çCIO: data/modules/rooms.js ==== */
/**
 * data/modules/rooms.js
 * ARQUIVO DE BUILDER DE SALA
 */

import { buildClimatizationSection } from './climatizacao.js';
import { buildMachinesSection } from './machines/machines-core.js';
import { buildAcessoriosSection } from './acessorios.js';
import { buildTubosSection } from './tubos.js';
import { buildDutosSection } from './dutos.js';
import { generateRoomId } from '../utils/id-generator.js';
import { removeEmptyProjectMessage } from '../../ui/helpers.js';
import { triggerCalculation, syncTitleToAmbienteDirect } from '../../core/shared-utils.js';

// Cache para m√≥dulo de m√°quinas
let machinesPreloadModule = null;

/**
 * üèóÔ∏è FUN√á√ïES DE CONSTRU√á√ÉO DE HTML (salas.js)
 */

/**
 * Constr√≥i o HTML completo de uma sala com todas as se√ß√µes
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML completo da sala
 */
function buildRoomHTML(obraId, projectId, roomName, roomId) {
    if (!obraId || obraId === 'undefined' || obraId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHTML) [Obra ID inv√°lido: ${obraId}]`);
        return '';
    }

    if (!projectId || projectId === 'undefined' || projectId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHTML) [Project ID inv√°lido: ${projectId}]`);
        return '';
    }

    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHTML) [Room ID inv√°lido: ${roomId}]`);
        return '';
    }

    console.log(`[BUILD ROOM] Par√¢metros:`, { obraId, projectId, roomName, roomId });
    console.log(`[BUILD ROOM] ID √öNICO: ${roomId}`);

    return `
      <div class="room-block" data-room-id="${roomId}" data-room-name="${roomName}" data-project-id="${projectId}" data-obra-id="${obraId}">
        <div class="room-header">
          <button class="minimizer" onclick="toggleRoom('${roomId}', event)">+</button>
          <h4 class="room-title editable-title" data-editable="true" onclick="makeEditable(this, 'room')">${roomName}</h4>
          <div class="room-actions">
            <button class="btn btn-delete" onclick="deleteRoom('${obraId}', '${projectId}', '${roomId}')">Remover</button>
          </div>
        </div>
        <div class="room-content collapsed" id="room-content-${roomId}">
          ${buildClimatizationSection(obraId, projectId, roomName, roomId)}
          ${buildMachinesSection(obraId, projectId, roomName, roomId)}
          ${buildAcessoriosSection(obraId, projectId, roomName, roomId)}
          ${buildTubosSection(obraId, projectId, roomName, roomId)}
          ${buildDutosSection(obraId, projectId, roomName, roomId)}
        
        </div>
      </div>
    `;
}

/**
 * Constr√≥i apenas o cabe√ßalho da sala com t√≠tulo e a√ß√µes
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML do cabe√ßalho da sala
 */
function buildRoomHeader(obraId, projectId, roomName, roomId) {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHeader) [Room ID inv√°lido: ${roomId}]`);
        return '';
    }

    return `
    <div class="room-header">
      <button class="minimizer" onclick="toggleRoom('${roomId}', event)">+</button>
      <h3 class="room-title editable-title" data-editable="true" onclick="makeEditable(this, 'room')">${roomName}</h3>
      <button class="btn btn-delete-small" onclick="deleteRoom('${obraId}', '${projectId}', '${roomId}')">Remover</button>
    </div>
  `;
}

/**
 * Constr√≥i a se√ß√£o de a√ß√µes da sala (reservado para futuras implementa√ß√µes)
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML vazio
 */
function buildRoomActions(roomId) {
    return "";
}

/**
 * üîß FUN√á√ïES DE OPERA√á√ïES (room-operations.js)
 */

/**
 * Carrega o m√≥dulo de m√°quinas para pr√©-carregamento ass√≠ncrono
 * @returns {Promise<Object|null>} M√≥dulo de m√°quinas carregado
 */
async function loadMachinesPreloadModule() {
    if (!machinesPreloadModule) {
        try {
            machinesPreloadModule = await import('./machines/machines-core.js');
            console.log("‚úÖ M√≥dulo de m√°quinas carregado para pr√©-carregamento");
        } catch (error) {
            console.error("‚ùå Erro ao carregar m√≥dulo de m√°quinas:", error);
        }
    }
    return machinesPreloadModule;
}

/**
 * Cria uma nova sala vazia no projeto especificado
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto  
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala (opcional)
 * @returns {Promise<boolean>} True se a sala foi criada com sucesso
 */
async function createEmptyRoom(obraId, projectId, roomName, roomId) {
    console.log(`üîÑ Criando sala: ${roomName} na obra "${obraId}", projeto "${projectId}"`);

    if (!obraId || obraId === 'undefined' || obraId === 'null') {
        console.error(`ERRO FALBACK (createEmptyRoom) [Obra ID inv√°lido: ${obraId}]`);
        return false;
    }

    if (!projectId || projectId === 'undefined' || projectId === 'null') {
        console.error(`ERRO FALBACK (createEmptyRoom) [Project ID inv√°lido: ${projectId}]`);
        return false;
    }

    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);

    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);

        console.log('üîç Projetos dispon√≠veis no DOM:');
        document.querySelectorAll('.project-block').forEach(proj => {
            console.log(`  - Projeto: ${proj.dataset.projectName}, 
                         ProjectID: ${proj.dataset.projectId}, 
                         ObraID: ${proj.dataset.obraId}, 
                         ObraName: ${proj.dataset.obraName}`);
        });
        return false;
    }

    console.log(`‚úÖ Projeto encontrado:`, projectElement.dataset);

    let finalRoomId;

    if (roomId && roomId !== 'undefined' && roomId !== 'null' && !roomId.includes('undefined')) {
        finalRoomId = roomId;
    } else {
        const roomCount = getRoomCountInProject(obraId, projectId);
        finalRoomId = generateRoomId(projectElement, roomCount + 1);
    }

    finalRoomId = finalRoomId.toString()
        .replace(/-undefined/g, '')
        .replace(/-null/g, '')
        .trim();

    console.log(`üìù ID SEGURO DEFINITIVO DA SALA: "${finalRoomId}"`);

    try {
        const machinesModule = await loadMachinesPreloadModule();
        if (machinesModule && machinesModule.preloadMachinesDataForRoom) {
            await machinesModule.preloadMachinesDataForRoom(finalRoomId);
        }
    } catch (error) {
        console.error("‚ö†Ô∏è Aviso: N√£o foi poss√≠vel pr√©-carregar dados das m√°quinas:", error);
    }

    const roomHTML = buildRoomHTML(obraId, projectId, roomName, finalRoomId);

    const projectContent = projectElement.querySelector('.project-content');

    if (!projectContent) {
        console.error(`‚ùå Conte√∫do do projeto n√£o encontrado em ${projectId}`);
        return false;
    }

    removeEmptyProjectMessage(projectContent);

    const addRoomSection = projectContent.querySelector('.add-room-section');
    if (addRoomSection) {
        addRoomSection.insertAdjacentHTML('beforebegin', roomHTML);
    } else {
        projectContent.insertAdjacentHTML('beforeend', roomHTML);
    }

    console.log(`‚úÖ Sala ${roomName} criada (ID: ${finalRoomId}) na obra "${obraId}", projeto "${projectId}"`);

    initializeRoomComponents(obraId, projectId, roomName, finalRoomId);

    return true;
}

/**
 * Conta quantas salas j√° existem no projeto espec√≠fico
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @returns {number} Quantidade de salas no projeto
 */
function getRoomCountInProject(obraId, projectId) {
    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);
    if (!projectElement) return 0;

    const rooms = projectElement.querySelectorAll('.room-block');
    return rooms.length;
}

/**
 * Inicializa todos os componentes da sala ap√≥s cria√ß√£o
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala
 * @returns {void}
 */

function initializeRoomComponents(obraId, projectId, roomName, roomId) {
    console.log(`üîß INICIALIZA√á√ÉO COMPLETA DA SALA: ${roomName} (ID: ${roomId})`);

    // ‚úÖ CONFIGURA√á√ÉO COM TIMING CORRETO
    setTimeout(() => {
        console.log(`üéØ CONFIGURANDO TODAS AS SINCRONIZA√á√ïES PARA: ${roomId}`);

        // 1. SINCRONIZA√á√ÉO T√çTULO ‚Üî AMBIENTE (BIDIRECIONAL)
        setupBidirectionalTitleAmbienteSync(roomId, roomName);

        // 2. SINCRONIZA√á√ÉO PAREDES (APENAS PRIMEIRA INTERA√á√ÉO)
        setupFirstInteractionWallSync(roomId);

        // 3. SINCRONIZA√á√ÉO INICIAL DOS VALORES
        initializeDefaultValues(roomId, roomName);

        // 4. INICIALIZAR SISTEMA DE EQUIPAMENTOS
        initializeAcessoriosSystem(roomId);

        console.log(`‚úÖ TODAS AS SINCRONIZA√á√ïES CONFIGURADAS PARA: ${roomId}`);

    }, 1000);

    // Outras inicializa√ß√µes...
    setTimeout(async () => {
        try {
            const machinesModule = await import('./machines/machines-core.js');
            if (machinesModule.preloadMachinesDataForRoom) {
                await machinesModule.preloadMachinesDataForRoom(roomId);
                console.log(`‚úÖ Dados das m√°quinas pr√©-carregados para ${roomId}`);
            }
        } catch (error) {
            console.log(`‚ÑπÔ∏è N√£o foi poss√≠vel pr√©-carregar dados das m√°quinas para ${roomId}`);
        }
    }, 800);

    // ‚úÖ INICIALIZA√á√ÉO DE FATOR DE SEGURAN√áA
    setTimeout(() => {
        safeInitializeFatorSeguranca(roomId);
    }, 1200);

    // ‚úÖ VERIFICA√á√ÉO FINAL
    setTimeout(() => {
        console.log(`üîç VERIFICA√á√ÉO FINAL DA SALA: ${roomName} (ID: ${roomId})`);
        verifyRoomSetupComplete(roomId);
    }, 2000);
}

// ‚úÖ FUN√á√ÉO PARA SINCRONIZA√á√ÉO BIDIRECIONAL T√çTULO ‚Üî AMBIENTE
function setupBidirectionalTitleAmbienteSync(roomId, roomName) {
    console.log(`üîß CONFIGURANDO SINCRONIZA√á√ÉO BIDIRECIONAL T√çTULO‚ÜîAMBIENTE: ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) {
        console.error(`‚ùå Room block n√£o encontrado: ${roomId}`);
        return;
    }

    const roomTitle = roomBlock.querySelector('.room-title');
    const ambienteInput = findAmbienteInput(roomId);

    if (roomTitle && ambienteInput) {
        console.log(`‚úÖ Elementos encontrados para sincroniza√ß√£o bidirecional`);

        // ‚úÖ SINCRONIZA√á√ÉO INICIAL: T√≠tulo ‚Üí Ambiente
        if (!ambienteInput.value || ambienteInput.value.trim() === '' || ambienteInput.value === 'Sala1') {
            ambienteInput.value = roomTitle.textContent || roomName;
            console.log(`‚úÖ Sincroniza√ß√£o inicial: T√≠tulo ‚Üí Ambiente: "${ambienteInput.value}"`);
        }

        // ‚úÖ SINCRONIZA√á√ÉO CONT√çNUA: Ambiente ‚Üí T√≠tulo
        ambienteInput.addEventListener('input', function () {
            if (this.value && this.value.trim() !== '' && this.value !== roomTitle.textContent) {
                roomTitle.textContent = this.value;
                roomBlock.dataset.roomName = this.value;
                console.log(`üîÑ Ambiente ‚Üí T√≠tulo: "${this.value}"`);
                triggerCalculation(roomId);
            }
        });

        // ‚úÖ SINCRONIZA√á√ÉO CONT√çNUA: T√≠tulo ‚Üí Ambiente (via Observer para edi√ß√£o inline)
        setupTitleChangeObserver(roomTitle, roomId);

        console.log(`‚úÖ Sincroniza√ß√£o bidirecional T√≠tulo‚ÜîAmbiente configurada`);

    } else {
        console.error(`‚ùå Elementos n√£o encontrados para sincroniza√ß√£o:`, {
            roomTitle: !!roomTitle,
            ambienteInput: !!ambienteInput
        });
    }
}

// ‚úÖ FUN√á√ÉO PARA OBSERVAR MUDAN√áAS NO T√çTULO (edi√ß√£o inline)
function setupTitleChangeObserver(roomTitle, roomId) {
    let isEditing = false;

    // Observar quando entra em modo de edi√ß√£o
    roomTitle.addEventListener('click', function () {
        isEditing = true;
        console.log(`‚úèÔ∏è T√≠tulo em modo de edi√ß√£o: ${roomId}`);
    });

    // Observar mudan√ßas no conte√∫do do t√≠tulo
    const observer = new MutationObserver((mutations) => {
        if (!isEditing) return;

        mutations.forEach((mutation) => {
            if (mutation.type === 'characterData' || mutation.type === 'childList') {
                const newTitle = roomTitle.textContent.trim();
                if (newTitle && newTitle !== mutation.oldValue) {
                    console.log(`üéØ T√≠tulo alterado via edi√ß√£o inline: "${mutation.oldValue}" ‚Üí "${newTitle}"`);
                    syncTitleToAmbienteDirect(roomId, newTitle);
                }
            }
        });
    });

    // Observar quando sai do modo de edi√ß√£o (blur)
    roomTitle.addEventListener('blur', function () {
        isEditing = false;
        const newTitle = roomTitle.textContent.trim();
        if (newTitle) {
            console.log(`üíæ Edi√ß√£o conclu√≠da: "${newTitle}"`);
            syncTitleToAmbienteDirect(roomId, newTitle);
        }
    });

    observer.observe(roomTitle, {
        characterData: true,
        childList: true,
        subtree: true,
        characterDataOldValue: true
    });

    console.log(`‚úÖ Observer configurado para t√≠tulo da sala ${roomId}`);
}

// ‚úÖ FUN√á√ÉO PARA SINCRONIZA√á√ÉO DE PAREDES (APENAS PRIMEIRA INTERA√á√ÉO)
function setupFirstInteractionWallSync(roomId) {
    console.log(`üß± CONFIGURANDO SINCRONIZA√á√ÉO PAREDES (PRIMEIRA INTERA√á√ÉO): ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) {
        console.error(`‚ùå Room block n√£o encontrado: ${roomId}`);
        return;
    }

    // Buscar inputs de parede
    const paredeOeste = roomBlock.querySelector('input[data-field="paredeOeste"]');
    const paredeLeste = roomBlock.querySelector('input[data-field="paredeLeste"]');
    const paredeNorte = roomBlock.querySelector('input[data-field="paredeNorte"]');
    const paredeSul = roomBlock.querySelector('input[data-field="paredeSul"]');

    console.log(`üìä Elementos de parede encontrados:`, {
        paredeOeste: !!paredeOeste,
        paredeLeste: !!paredeLeste,
        paredeNorte: !!paredeNorte,
        paredeSul: !!paredeSul
    });

    // ‚úÖ SINCRONIZA√á√ÉO LESTE/OESTE (apenas primeira intera√ß√£o)
    if (paredeOeste && paredeLeste) {
        setupFirstInteractionWallPair(paredeOeste, paredeLeste, roomId, 'Oeste', 'Leste');
    } else {
        console.warn(`‚ö†Ô∏è Par Leste/Oeste incompleto para ${roomId}`);
    }

    // ‚úÖ SINCRONIZA√á√ÉO NORTE/SUL (apenas primeira intera√ß√£o)
    if (paredeNorte && paredeSul) {
        setupFirstInteractionWallPair(paredeNorte, paredeSul, roomId, 'Norte', 'Sul');
    } else {
        console.warn(`‚ö†Ô∏è Par Norte/Sul incompleto para ${roomId}`);
    }
}

// ‚úÖ FUN√á√ÉO PARA SINCRONIZA√á√ÉO DE PAR DE PAREDES (APENAS PRIMEIRA INTERA√á√ÉO)
function setupFirstInteractionWallPair(input1, input2, roomId, name1, name2) {
    console.log(`üîß Configurando par ${name1}/${name2} (primeira intera√ß√£o) para ${roomId}`);

    let isFirstInteraction1 = true;
    let isFirstInteraction2 = true;
    let isEditing1 = false;
    let isEditing2 = false;
    
    const placeholderValues = ['Ex: 5.5', 'Ex: 8.0', ''];

    // Fun√ß√£o para sincronizar durante a primeira edi√ß√£o
    function syncDuringFirstEdit(editingInput, otherInput, value) {
        if (!value || placeholderValues.includes(value)) return;
        
        if (editingInput === input1 && isFirstInteraction1 && isEditing1) {
            // Primeira intera√ß√£o - sincronizar enquanto est√° editando
            otherInput.value = value;
            console.log(`üîÑ Primeira intera√ß√£o (editando): ${name1} ‚Üí ${name2}: ${value}`);
            triggerCalculation(roomId);
        } else if (editingInput === input2 && isFirstInteraction2 && isEditing2) {
            // Primeira intera√ß√£o - sincronizar enquanto est√° editando
            otherInput.value = value;
            console.log(`üîÑ Primeira intera√ß√£o (editando): ${name2} ‚Üí ${name1}: ${value}`);
            triggerCalculation(roomId);
        }
    }

    // Input 1
    input1.addEventListener('focus', function() {
        if (isFirstInteraction1) {
            isEditing1 = true;
            console.log(`üéØ Primeira intera√ß√£o iniciada para ${name1}`);
        }
    });

    input1.addEventListener('input', function() {
        if (isEditing1) {
            syncDuringFirstEdit(input1, input2, this.value);
        }
    });

    input1.addEventListener('blur', function() {
        if (isFirstInteraction1) {
            isFirstInteraction1 = false;
            isEditing1 = false;
            console.log(`‚úÖ Primeira intera√ß√£o conclu√≠da para ${name1} - campos agora independentes`);
        }
    });

    // Input 2
    input2.addEventListener('focus', function() {
        if (isFirstInteraction2) {
            isEditing2 = true;
            console.log(`üéØ Primeira intera√ß√£o iniciada para ${name2}`);
        }
    });

    input2.addEventListener('input', function() {
        if (isEditing2) {
            syncDuringFirstEdit(input2, input1, this.value);
        }
    });

    input2.addEventListener('blur', function() {
        if (isFirstInteraction2) {
            isFirstInteraction2 = false;
            isEditing2 = false;
            console.log(`‚úÖ Primeira intera√ß√£o conclu√≠da para ${name2} - campos agora independentes`);
        }
    });

    // Sincroniza√ß√£o inicial apenas se um campo tiver valor e o outro estiver vazio/placeholder
    if (input1.value && !placeholderValues.includes(input1.value)) {
        if (!input2.value || placeholderValues.includes(input2.value)) {
            input2.value = input1.value;
            console.log(`‚úÖ Sincroniza√ß√£o inicial: ${name1} ‚Üí ${name2}: ${input1.value}`);
        }
    } else if (input2.value && !placeholderValues.includes(input2.value)) {
        if (!input1.value || placeholderValues.includes(input1.value)) {
            input1.value = input2.value;
            console.log(`‚úÖ Sincroniza√ß√£o inicial: ${name2} ‚Üí ${name1}: ${input2.value}`);
        }
    }

    console.log(`‚úÖ Sincroniza√ß√£o ${name1}/${name2} (primeira intera√ß√£o) configurada`);
}

// ‚úÖ FUN√á√ÉO PARA INICIALIZA√á√ÉO DOS VALORES PADR√ÉO
function initializeDefaultValues(roomId, roomName) {
    console.log(`‚ö° INICIALIZANDO VALORES PADR√ÉO PARA: ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) return;

    // Verificar e sincronizar valores iniciais das paredes
    const walls = [
        { field: 'paredeOeste', selector: 'input[data-field="paredeOeste"]' },
        { field: 'paredeLeste', selector: 'input[data-field="paredeLeste"]' },
        { field: 'paredeNorte', selector: 'input[data-field="paredeNorte"]' },
        { field: 'paredeSul', selector: 'input[data-field="paredeSul"]' }
    ];

    walls.forEach(wall => {
        const input = roomBlock.querySelector(wall.selector);
        if (input && input.value && input.value !== 'Ex: 5.5' && input.value !== 'Ex: 8.0') {
            syncOppositeWallInitial(roomId, wall.field, input.value);
        }
    });
}



// ‚úÖ FUN√á√ÉO AUXILIAR PARA SINCRONIZA√á√ÉO INICIAL DAS PAREDES
function syncOppositeWallInitial(roomId, field, value) {
    const oppositeMap = {
        'paredeOeste': 'paredeLeste',
        'paredeLeste': 'paredeOeste',
        'paredeNorte': 'paredeSul',
        'paredeSul': 'paredeNorte'
    };

    const oppositeField = oppositeMap[field];
    if (oppositeField) {
        const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
        if (roomBlock) {
            const oppositeInput = roomBlock.querySelector(`input[data-field="${oppositeField}"]`);
            if (oppositeInput && (!oppositeInput.value || oppositeInput.value === 'Ex: 5.5' || oppositeInput.value === 'Ex: 8.0')) {
                oppositeInput.value = value;
                console.log(`‚úÖ Sincroniza√ß√£o inicial ${field} ‚Üí ${oppositeField}: ${value}`);
            }
        }
    }
}

// ‚úÖ FUN√á√ÉO AUXILIAR PARA BUSCAR INPUT AMBIENTE
function findAmbienteInput(roomId) {
    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) return null;

    // Estrat√©gias de busca em ordem de prioridade
    return roomBlock.querySelector('input[data-field="ambiente"]') ||
        roomBlock.querySelector('input[placeholder*="ambiente" i]') ||
        roomBlock.querySelector('input[placeholder*="sala" i]');
}

async function initializeAcessoriosSystem(roomId) {
    console.log(`üîß Inicializando sistema de acessorios para sala: ${roomId}`);

    try {
        // Verificar se a fun√ß√£o est√° dispon√≠vel
        if (typeof window.initAcessoriosSystem === 'function') {
            await window.initAcessoriosSystem(roomId);
            console.log(`‚úÖ Sistema de acessorios inicializado para sala: ${roomId}`);
        } else {
            console.warn(`‚ö†Ô∏è Fun√ß√£o initAcessoriosSystem n√£o dispon√≠vel. Tentando importar...`);

            // Tentar importar dinamicamente
            const acessoriosModule = await import('./acessorios.js');
            if (acessoriosModule && acessoriosModule.initAcessoriosSystem) {
                acessoriosModule.initAcessoriosSystem(roomId);
                console.log(`‚úÖ Sistema de acessorios inicializado via import din√¢mico`);
            } else {
                console.error(`‚ùå N√£o foi poss√≠vel inicializar sistema de acessorios`);
            }
        }
    } catch (error) {
        console.error(`‚ùå Erro ao inicializar sistema de acessorios:`, error);
    }
}



// ‚úÖ FUN√á√ÉO PARA VERIFICA√á√ÉO COMPLETA DO SETUP
function verifyRoomSetupComplete(roomId) {
    console.log(`üîç VERIFICA√á√ÉO COMPLETA DA SALA: ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) {
        console.error(`‚ùå Room block n√£o encontrado: ${roomId}`);
        return false;
    }

    const elements = {
        'T√≠tulo': roomBlock.querySelector('.room-title'),
        'Ambiente': findAmbienteInput(roomId),
        'Parede Oeste': roomBlock.querySelector('input[data-field="paredeOeste"]'),
        'Parede Leste': roomBlock.querySelector('input[data-field="paredeLeste"]'),
        'Parede Norte': roomBlock.querySelector('input[data-field="paredeNorte"]'),
        'Parede Sul': roomBlock.querySelector('input[data-field="paredeSul"]')
    };

    let allFound = true;
    let foundCount = 0;

    Object.entries(elements).forEach(([name, element]) => {
        const found = !!element;
        if (!found) allFound = false;
        if (found) foundCount++;
        console.log(`üìä ${name}: ${found ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado'}`);
    });

    if (allFound) {
        console.log(`üéâ TODOS OS ${foundCount} ELEMENTOS ENCONTRADOS PARA: ${roomId}`);
    } else {
        console.warn(`‚ö†Ô∏è ${foundCount}/6 ELEMENTOS ENCONTRADOS PARA: ${roomId}`);
    }

    return allFound;
}

// ‚úÖ ADICIONAR FUN√á√ÉO GLOBAL PARA DEBUG
if (typeof window !== 'undefined') {
    window.debugRoomSync = function (roomId) {
        console.log(`üêõ DEBUG COMPLETO DA SALA: ${roomId}`);
        const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
        if (roomBlock) {
            console.log('üìã Elementos encontrados:');
            console.log('- T√≠tulo:', roomBlock.querySelector('.room-title')?.textContent);
            console.log('- Ambiente:', findAmbienteInput(roomId)?.value);
            console.log('- Parede Oeste:', roomBlock.querySelector('input[data-field="paredeOeste"]')?.value);
            console.log('- Parede Leste:', roomBlock.querySelector('input[data-field="paredeLeste"]')?.value);
            console.log('- Parede Norte:', roomBlock.querySelector('input[data-field="paredeNorte"]')?.value);
            console.log('- Parede Sul:', roomBlock.querySelector('input[data-field="paredeSul"]')?.value);

            // Testar sincroniza√ß√£o manual
            const roomTitle = roomBlock.querySelector('.room-title');
            if (roomTitle) {
                console.log('üîÑ Testando sincroniza√ß√£o t√≠tulo ‚Üí ambiente...');
                syncTitleToAmbienteDirect(roomId, roomTitle.textContent);
            }
        }
    };
}



/**
 * Fun√ß√£o auxiliar para inicializar fator de seguran√ßa de forma segura
 * @param {string} roomId - ID √∫nico da sala
 * @returns {void}
 */
function safeInitializeFatorSeguranca(roomId) {
    if (typeof window.initializeFatorSeguranca === 'function') {
        try {
            window.initializeFatorSeguranca(roomId);
            console.log(`‚úÖ Fator de seguran√ßa inicializado para ${roomId}`);
        } catch (error) {
            console.log(`‚ÑπÔ∏è Erro ao inicializar fator de seguran√ßa para ${roomId}:`, error.message);
        }
    } else {
        console.log(`‚ÑπÔ∏è initializeFatorSeguranca n√£o dispon√≠vel - aguardando carregamento`);
    }
}

/**
 * Insere o HTML de uma sala no conte√∫do do projeto
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomHTML - HTML da sala a ser inserida
 * @param {string} roomId - ID √∫nico da sala
 * @returns {void}
 */
function insertRoomIntoProject(obraId, projectId, roomHTML, roomId) {
    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);
    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);
        return;
    }

    const projectContent = projectElement.querySelector('.project-content');
    if (!projectContent) {
        console.error(`‚ùå Conte√∫do do projeto ${projectId} n√£o encontrado`);
        return;
    }

    const addRoomSection = projectContent.querySelector(".add-room-section");
    if (addRoomSection) {
        addRoomSection.insertAdjacentHTML("beforebegin", roomHTML);
    } else {
        projectContent.insertAdjacentHTML("beforeend", roomHTML);
    }

    removeEmptyProjectMessage(projectContent);
    console.log(`‚úÖ Sala inserida no projeto ${projectId} (ID √∫nico: ${roomId})`);
}

/**
 * Adiciona uma nova sala ao projeto
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @returns {Promise<void>}
 */
async function addNewRoom(obraId, projectId) {
    console.log(`‚ûï Adicionando nova sala √† obra "${obraId}", projeto "${projectId}"`);

    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);

    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);
        return;
    }

    const roomCount = getRoomCountInProject(obraId, projectId);
    const roomName = `Sala${roomCount + 1}`;

    await createEmptyRoom(obraId, projectId, roomName, null);
    console.log(`‚úÖ ${roomName} adicionada √† obra "${obraId}", projeto "${projectId}"`);
}

/**
 * Adiciona uma nova sala ao projeto (alias para compatibilidade)
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @returns {Promise<void>}
 */
async function addNewRoomToProject(obraId, projectId) {
    console.log(`‚ûï Adicionando nova sala √† obra "${obraId}", projeto "${projectId}"`);

    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);

    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);
        return;
    }

    const roomCount = getRoomCountInProject(obraId, projectId);
    const roomName = `Sala${roomCount + 1}`;

    await createEmptyRoom(obraId, projectId, roomName, null);
    console.log(`‚úÖ ${roomName} adicionada √† obra "${obraId}", projeto "${projectId}"`);
}

/**
 * Fun√ß√£o de compatibilidade para c√≥digo existente que usa apenas projectName
 * @param {string} projectName - Nome do projeto
 * @returns {Promise<void>}
 */
async function addNewRoomLegacy(projectName) {
    const projectBlock = document.querySelector(`[data-project-name="${projectName}"]`);
    const obraId = projectBlock?.dataset.obraId;
    const projectId = projectBlock?.dataset.projectId;

    if (obraId && projectId) {
        return addNewRoomToProject(obraId, projectId);
    } else {
        console.error('‚ùå N√£o foi poss√≠vel determinar a obra do projeto:', projectName);
    }
}

/**
 * Remove uma sala do projeto ap√≥s confirma√ß√£o do usu√°rio
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomId - ID √∫nico da sala a ser removida
 * @returns {void}
 */
function deleteRoom(obraId, projectId, roomId) {
    const roomBlock = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"][data-room-id="${roomId}"]`);

    if (!roomBlock) {
        console.error(`‚ùå Sala com ID ${roomId} n√£o encontrada no projeto ${projectId}, obra ${obraId}`);
        return;
    }

    const roomName = roomBlock.dataset.roomName;
    const projectContent = roomBlock.closest(".project-content");

    roomBlock.remove();

    if (projectContent && typeof window.showEmptyProjectMessageIfNeeded === 'function') {
        window.showEmptyProjectMessageIfNeeded(projectContent);
    }

    console.log(`üóëÔ∏è Sala ${roomName} (ID: ${roomId}) removida da obra "${obraId}", projeto "${projectId}"`);
}

/**
 * Fun√ß√£o de compatibilidade para c√≥digo existente que usa apenas projectName e roomName
 * @param {string} projectName - Nome do projeto
 * @param {string} roomName - Nome da sala
 * @returns {void}
 */
function deleteRoomLegacy(projectName, roomName) {
    const projectBlock = document.querySelector(`[data-project-name="${projectName}"]`);
    const obraId = projectBlock?.dataset.obraId;
    const projectId = projectBlock?.dataset.projectId;

    if (obraId && projectId) {
        const roomBlock = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"][data-room-name="${roomName}"]`);
        const roomId = roomBlock?.dataset.roomId;

        if (roomId) {
            return deleteRoom(obraId, projectId, roomId);
        } else {
            console.error(`‚ùå ID da sala ${roomName} n√£o encontrado`);
        }
    } else {
        console.error('‚ùå N√£o foi poss√≠vel determinar a obra do projeto:', projectName);
    }
}

/**
 * Corrige inputs de fator de seguran√ßa que estejam vazios
 * Aplica valores padr√£o baseados nas constantes do sistema
 * @returns {void}
 */
function fixExistingCapacityInputs() {
    console.log('üîÑ Verificando inputs de capacidade existentes...');

    const roomBlocks = document.querySelectorAll('.room-block');

    roomBlocks.forEach(roomBlock => {
        const roomId = roomBlock.dataset.roomId;
        const roomName = roomBlock.dataset.roomName;
        const projectBlock = roomBlock.closest('.project-block');
        const projectId = projectBlock?.dataset.projectId;
        const obraId = projectBlock?.dataset.obraId;

        if (roomId) {
            const input = document.getElementById(`fator-seguranca-${roomId}`);

            if (input && input.value === '') {
                const valor = window.systemConstants?.FATOR_SEGURANCA_CAPACIDADE.value || 10;
                input.value = valor;
                console.log(`‚úÖ Input ${roomId} : ${valor}% (Obra: ${obraId}, Projeto: ${projectId})`);
            }
        }
    });
}

// Executar quando o projeto for carregado
document.addEventListener('DOMContentLoaded', function () {
    setTimeout(fixExistingCapacityInputs, 2000);
});

/**
 * üåê EXPORTA√á√ïES E COMPATIBILIDADE GLOBAL
 */

// Exporta√ß√µes para m√≥dulos ES6
export {
    // Constru√ß√£o
    buildRoomHTML,
    buildRoomHeader,
    buildRoomActions,

    // Opera√ß√µes
    createEmptyRoom,
    insertRoomIntoProject,
    addNewRoom,
    deleteRoom,
    deleteRoomLegacy,
    safeInitializeFatorSeguranca,
    addNewRoomToProject,

    // Utilit√°rios
    getRoomCountInProject,
    initializeRoomComponents,
    fixExistingCapacityInputs,
    loadMachinesPreloadModule,


    triggerCalculation,
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
    window.addNewRoom = addNewRoom;
    window.deleteRoom = deleteRoom;
    window.addNewRoomToProject = addNewRoomToProject;
    window.createEmptyRoom = createEmptyRoom;
    window.safeInitializeFatorSeguranca = safeInitializeFatorSeguranca;
    window.buildRoomHTML = buildRoomHTML;
}
/* ==== FIM: data/modules/rooms.js ==== */
