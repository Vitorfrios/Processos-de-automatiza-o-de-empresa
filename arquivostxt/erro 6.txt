
/* ==== IN√çCIO: ui/helpers.js ==== */
/**
 * ui/helpers.js
 * üéØ FUS√ÉO: ui-helpers.js ‚Üí ui/helpers.js
 * ‚ö° REFATORA√á√ÉO: Import atualizado + compatibilidade global
 */

import { UI_CONSTANTS } from '../core/constants.js';

/**
 * Utilit√°rios de interface do usu√°rio - SISTEMA UNIFICADO
 */

/**
 * Alterna a visibilidade de um elemento (expandir/recolher)
 * @param {string} contentId - ID do elemento a ser alternado
 * @param {HTMLElement} minimizerElement - Bot√£o minimizador
 */
function toggleElementVisibility(contentId, minimizerElement) {
  const content = document.getElementById(contentId);
  if (!content) {
    console.error(`‚ùå Elemento ${contentId} n√£o encontrado para toggle`);
    return;
  }

  const isCollapsed = content.classList.contains(UI_CONSTANTS.COLLAPSED_CLASS);

  if (isCollapsed) {
    expandElement(content, minimizerElement);
  } else {
    collapseElement(content, minimizerElement);
  }
}

/**
 * Expande um elemento na interface
 * @param {HTMLElement} element - Elemento a ser expandido
 * @param {HTMLElement} minimizerElement - Bot√£o minimizador
 */
function expandElement(element, minimizerElement) {
  element.classList.remove(UI_CONSTANTS.COLLAPSED_CLASS);
  minimizerElement.textContent = UI_CONSTANTS.EXPANDED_SYMBOL;
}

/**
 * Recolhe um elemento na interface
 * @param {HTMLElement} element - Elemento a ser recolhido
 * @param {HTMLElement} minimizerElement - Bot√£o minimizador
 */
function collapseElement(element, minimizerElement) {
  element.classList.add(UI_CONSTANTS.COLLAPSED_CLASS);
  minimizerElement.textContent = UI_CONSTANTS.MINIMIZED_SYMBOL;
}

/**
 * Calcula estat√≠sticas de preenchimento de uma sala
 * @param {HTMLElement} room - Elemento da sala
 * @returns {Object} Estat√≠sticas de preenchimento
 */
function calculateRoomCompletionStats(room) {
  const inputs = room.querySelectorAll(".form-input, .clima-input");
  const filledInputs = Array.from(inputs).filter((input) => {
    if (input.type === 'checkbox' || input.type === 'radio') {
      return input.checked;
    }
    return input.value && input.value.trim() !== "";
  }).length;

  const totalInputs = inputs.length;
  const percentage = totalInputs > 0 ? ((filledInputs / totalInputs) * 100).toFixed(1) : 0;

  return {
    filled: filledInputs,
    total: totalInputs,
    percentage: percentage,
  };
}

/**
 * Remove a mensagem de "obra vazia" quando projetos s√£o adicionados
 * @param {string} obraName - Nome da obra
 */
function removeEmptyObraMessage(obraName) {
  const projectsContainer = document.getElementById(`projects-${obraName}`);
  if (projectsContainer) {
    const emptyMessage = projectsContainer.querySelector(".empty-message");
    if (emptyMessage) {
      console.log(`üóëÔ∏è Removendo mensagem de obra vazia: ${obraName}`);
      emptyMessage.remove();
    }
  }
}

/**
 * Exibe mensagem de "obra vazia" se n√£o houver projetos
 * @param {string} obraName - Nome da obra
 */
function showEmptyObraMessageIfNeeded(obraName) {
  const projectsContainer = document.getElementById(`projects-${obraName}`);
  if (projectsContainer) {
    const projects = projectsContainer.querySelectorAll(".project-block");
    
    if (projects.length === 0) {
      const existingMessage = projectsContainer.querySelector(".empty-message");
      if (!existingMessage) {
        console.log(`üìù Exibindo mensagem de obra vazia: ${obraName}`);
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = 'Adicione projetos a esta obra...';
        projectsContainer.appendChild(emptyMessage);
      }
    } else {
      removeEmptyObraMessage(obraName);
    }
  }
}

/**
 * Remove a mensagem de "projeto vazio" quando salas s√£o adicionadas
 * @param {HTMLElement} projectContent - Elemento do conte√∫do do projeto
 */
function removeEmptyProjectMessage(projectContent) {
  const emptyMessage = projectContent.querySelector(".empty-message");
  if (emptyMessage) {
    console.log(`üóëÔ∏è Removendo mensagem de projeto vazio`);
    emptyMessage.remove();
  }
}

/**
 * Exibe mensagem de "projeto vazio" se n√£o houver salas
 * @param {HTMLElement} projectContent - Elemento do conte√∫do do projeto
 */
function showEmptyProjectMessageIfNeeded(projectContent) {
  const remainingRooms = projectContent.querySelectorAll(".room-block");

  if (remainingRooms.length === 0) {
    const existingMessage = projectContent.querySelector(".empty-message");
    if (!existingMessage) {
      console.log(`üìù Exibindo mensagem de projeto vazio`);
      const addRoomSection = projectContent.querySelector(".add-room-section");
      if (addRoomSection) {
        addRoomSection.insertAdjacentHTML("beforebegin", '<p class="empty-message">Adicione salas a este projeto...</p>');
      }
    }
  } else {
    removeEmptyProjectMessage(projectContent);
  }
}

/**
 * üÜï FUN√á√ÉO ADICIONAL: Verifica se elemento est√° vis√≠vel
 * @param {string} elementId - ID do elemento
 * @returns {boolean} True se vis√≠vel
 */
function isElementVisible(elementId) {
  const element = document.getElementById(elementId);
  return element && !element.classList.contains(UI_CONSTANTS.COLLAPSED_CLASS);
}

/**
 * üÜï FUN√á√ÉO ADICIONAL: Alterna todos os elementos de um container
 * @param {string} containerId - ID do container
 * @param {boolean} expand - True para expandir, false para recolher
 */
function toggleAllElements(containerId, expand = true) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const minimizers = container.querySelectorAll('.minimizer');
  const contents = container.querySelectorAll('.collapsible-content');

  contents.forEach((content, index) => {
    const minimizer = minimizers[index];
    if (minimizer && content) {
      if (expand) {
        expandElement(content, minimizer);
      } else {
        collapseElement(content, minimizer);
      }
    }
  });
}

// Exporta√ß√µes para m√≥dulos ES6
export {
  toggleElementVisibility,
  expandElement,
  collapseElement,
  calculateRoomCompletionStats,
  removeEmptyObraMessage,
  showEmptyObraMessageIfNeeded,
  removeEmptyProjectMessage,
  showEmptyProjectMessageIfNeeded,
  isElementVisible,
  toggleAllElements
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
  window.toggleElementVisibility = toggleElementVisibility;
  window.expandElement = expandElement;
  window.collapseElement = collapseElement;
  window.calculateRoomCompletionStats = calculateRoomCompletionStats;
  window.removeEmptyObraMessage = removeEmptyObraMessage;
  window.showEmptyObraMessageIfNeeded = showEmptyObraMessageIfNeeded;
  window.removeEmptyProjectMessage = removeEmptyProjectMessage;
  window.showEmptyProjectMessageIfNeeded = showEmptyProjectMessageIfNeeded;
  window.isElementVisible = isElementVisible;
  window.toggleAllElements = toggleAllElements;
}
/* ==== FIM: ui/helpers.js ==== */

/* ==== IN√çCIO: ui/interface.js ==== */
/**
 * interface.js - CORRE√á√ÉO DO SISTEMA DE TOGGLE
 * SISTEMA CORRIGIDO COM IDs √öNICOS
 */

// ‚úÖ IMPORTS CORRIGIDOS - CAMINHOS ATUALIZADOS
import { 
    showSystemStatus,
    removeExistingStatusBanner,
    createStatusBanner,
    insertStatusBanner,
    scheduleStatusBannerRemoval,
} from './components/status.js'  // ‚úÖ CAMINHO CORRETO

import { 
    toggleElementVisibility,
    expandElement,
    collapseElement,
    calculateRoomCompletionStats,
    removeEmptyObraMessage,
    showEmptyObraMessageIfNeeded,
    removeEmptyProjectMessage,
    showEmptyProjectMessageIfNeeded,
} from './helpers.js'  // ‚úÖ CAMINHO CORRETO

import { 
    createEmptyObra,
    buildObraHTML,
    buildObraActionsFooter,
    insertObraIntoDOM,
    updateObraButtonAfterSave,
    deleteObra,
    addNewObra,
} from '../features/managers/obra-manager.js'  // ‚úÖ CAMINHO CORRETO

import { 
    createEmptyProject,
    buildProjectHTML,
    addNewProjectToObra
} from '../features/managers/project-manager.js'  // ‚úÖ CAMINHO CORRETO

import { 
    getNextProjectNumber,
    getNextObraNumber 
} from '../data/utils/data-utils.js'  // ‚úÖ CAMINHO CORRETO

import { 
    createEmptyRoom 
} from '../data/modules/rooms.js'  // ‚úÖ CAMINHO CORRETO

// Re-exporta√ß√µes para manter compatibilidade
export {
    showSystemStatus,
    removeExistingStatusBanner,
    createStatusBanner,
    insertStatusBanner,
    scheduleStatusBannerRemoval,
    toggleElementVisibility,
    expandElement,
    collapseElement,
    calculateRoomCompletionStats,
    removeEmptyObraMessage,
    showEmptyObraMessageIfNeeded,
    removeEmptyProjectMessage,
    showEmptyProjectMessageIfNeeded,
    createEmptyObra,
    buildObraHTML,
    buildObraActionsFooter,
    insertObraIntoDOM,
    updateObraButtonAfterSave,
    deleteObra,
    getNextObraNumber,
    addNewObra,
    createEmptyProject,
    buildProjectHTML,
    addNewProjectToObra,
    getNextProjectNumber,
    createEmptyRoom,
}

/**
 * Adiciona um novo projeto √† obra mais recente
 * @returns {void}
 * 
 * @example
 * addNewProject() // Cria uma nova obra e adiciona um projeto nela
 */
function addNewProject() {
  addNewObra().then(() => {
    const obraNumber = getNextObraNumber() - 1
    const obraName = `Obra${obraNumber}`
    addNewProjectToObra(obraName)
  })
}

// =============================================================================
// SISTEMA DE TOGGLE CORRIGIDO - IDs √öNICOS
// =============================================================================

/**
 * Alterna a visibilidade do conte√∫do de uma obra (expandir/recolher) - CORRE√á√ÉO COMPLETA
 * @param {string} obraId - ID √∫nico da obra a ser alternada
 * @param {Event} event - Evento de clique do usu√°rio
 * @returns {void}
 * 
 * @example
 * toggleObra('obra_a42', event) // Expande ou recolhe a obra com ID 'obra_a42'
 */
function toggleObra(obraId, event) {
    console.log(`üîß Toggle Obra chamado: ${obraId}`);
    
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!obraId || obraId === 'undefined' || obraId === 'null') {
        console.error(`ERRO FALBACK (toggleObra) interface.js [ID de obra inv√°lido: ${obraId}]`);
        return;
    }
    
    // ‚úÖ CORRE√á√ÉO: Buscar APENAS por ID √∫nico
    const contentId = `obra-content-${obraId}`;
    const content = document.getElementById(contentId);
    
    if (!content) {
        console.error(`‚ùå Conte√∫do da obra ${obraId} n√£o encontrado`);
        console.log('üîç Conte√∫dos de obra dispon√≠veis:');
        document.querySelectorAll('[id^="obra-content-"]').forEach(content => {
            console.log(`  - ${content.id}`);
        });
        return;
    }

    const isCollapsed = content.classList.contains("collapsed");
    const minimizer = event.target;

    if (isCollapsed) {
        content.classList.remove("collapsed");
        minimizer.textContent = "‚àí";
        console.log(`üìÇ Obra ${obraId} expandida`);
    } else {
        content.classList.add("collapsed");
        minimizer.textContent = "+";
        console.log(`üìÅ Obra ${obraId} recolhida`);
    }
}

/**
 * Alterna a visibilidade do conte√∫do de um projeto (expandir/recolher) - CORRE√á√ÉO COMPLETA
 * @param {string} projectId - ID √∫nico do projeto a ser alternado
 * @param {Event} event - Evento de clique do usu√°rio
 * @returns {void}
 * 
 * @example
 * toggleProject('obra_a42_proj1', event) // Expande ou recolhe o projeto com ID 'obra_a42_proj1'
 */
function toggleProject(projectId, event) {
    console.log(`üîß Toggle Project chamado: ${projectId}`);
    
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!projectId || projectId === 'undefined' || projectId === 'null') {
        console.error(`ERRO FALBACK (toggleProject) interface.js [ID de projeto inv√°lido: ${projectId}]`);
        return;
    }
    
    // ‚úÖ CORRE√á√ÉO: Buscar APENAS por ID √∫nico
    const contentId = `project-content-${projectId}`;
    const content = document.getElementById(contentId);
    
    if (!content) {
        console.error(`‚ùå Conte√∫do do projeto ${projectId} n√£o encontrado`);
        console.log('üîç Conte√∫dos de projeto dispon√≠veis:');
        document.querySelectorAll('[id^="project-content-"]').forEach(content => {
            console.log(`  - ${content.id}`);
        });
        return;
    }

    const isCollapsed = content.classList.contains("collapsed");
    const minimizer = event.target;

    if (isCollapsed) {
        content.classList.remove("collapsed");
        minimizer.textContent = "‚àí";
        console.log(`üìÇ Projeto ${projectId} expandido`);
    } else {
        content.classList.add("collapsed");
        minimizer.textContent = "+";
        console.log(`üìÅ Projeto ${projectId} recolhido`);
    }
}

/**
 * Alterna a visibilidade do conte√∫do de uma sala (expandir/recolher) - CORRE√á√ÉO COMPLETA
 * @param {string} roomId - ID √∫nico da sala
 * @param {Event} event - Evento de clique do usu√°rio
 * @returns {void}
 * 
 * @example
 * toggleRoom('obra_a42_proj1_sala1', event) // Expande ou recolhe a sala com ID 'obra_a42_proj1_sala1'
 */
function toggleRoom(roomId, event) {
    console.log(`üîß Toggle Sala chamado: ID ${roomId}`, event);
    
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (toggleRoom) interface.js [ID de sala inv√°lido: ${roomId}]`);
        return;
    }
    
    // ‚úÖ CORRE√á√ÉO: Buscar APENAS por ID √∫nico
    const contentId = `room-content-${roomId}`;
    const content = document.getElementById(contentId);
    
    if (!content) {
        console.error(`‚ùå Conte√∫do da sala ${roomId} n√£o encontrado`);
        console.log(`üîç Procurando por: ${contentId}`);
        console.log('üîç Conte√∫dos de sala dispon√≠veis:');
        document.querySelectorAll('[id^="room-content-"]').forEach(content => {
            console.log(`  - ${content.id}`);
        });
        return;
    }

    const isCollapsed = content.classList.contains("collapsed");
    const minimizer = event.target;

    console.log(`üìÇ Estado da sala ${roomId}: ${isCollapsed ? 'recolhida' : 'expandida'}`);

    if (isCollapsed) {
        content.classList.remove("collapsed");
        minimizer.textContent = "‚àí";
        console.log(`üìÇ Sala ${roomId} EXPANDIDA`);
    } else {
        content.classList.add("collapsed");
        minimizer.textContent = "+";
        console.log(`üìÅ Sala ${roomId} RECOLHIDA`);
    }
}

/**
 * Alterna a visibilidade de uma se√ß√£o
 * @param {string} sectionId - ID da se√ß√£o
 * @returns {void}
 * 
 * @example
 * toggleSection('materiais') // Alterna visibilidade da se√ß√£o de materiais
 */
function toggleSection(sectionId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID
    if (!sectionId || sectionId === 'undefined' || sectionId === 'null') {
        console.error(`ERRO FALBACK (toggleSection) interface.js [ID de se√ß√£o inv√°lido: ${sectionId}]`);
        return;
    }
    toggleElementVisibility(`section-content-${sectionId}`, event.target);
}

/**
 * Alterna a visibilidade de uma subse√ß√£o
 * @param {string} subsectionId - ID da subse√ß√£o
 * @returns {void}
 * 
 * @example
 * toggleSubsection('pintura') // Alterna visibilidade da subse√ß√£o de pintura
 */
function toggleSubsection(subsectionId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID
    if (!subsectionId || subsectionId === 'undefined' || subsectionId === 'null') {
        console.error(`ERRO FALBACK (toggleSubsection) interface.js [ID de subse√ß√£o inv√°lido: ${subsectionId}]`);
        return;
    }
    toggleElementVisibility(`subsection-content-${subsectionId}`, event.target);
}

// =============================================================================
// FUN√á√ïES DE DOWNLOAD E SALVAMENTO
// =============================================================================

/**
 * Gera e inicia o download de um PDF para uma obra ou projeto espec√≠fico
 * @param {string} obraId - ID da obra
 * @param {string|null} projectName - Nome do projeto (opcional)
 * @returns {void}
 * 
 * @example
 * downloadPDF('obra_a64') // Gera PDF para a obra com ID obra_a64
 * downloadPDF('obra_a64', 'ProjetoA') // Gera PDF para o ProjetoA da obra
 */
function downloadPDF(obraId, projectName = null) {
    // ‚úÖ CORRE√á√ÉO: Buscar obra por ID em vez de nome
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraBlock) {
        console.error(`‚ùå Obra com ID "${obraId}" n√£o encontrada para PDF`);
        showSystemStatus(`ERRO: Obra n√£o encontrada`, "error");
        return;
    }

    const obraName = obraBlock.dataset.obraName;
    const target = projectName ? `projeto ${projectName} da obra ${obraName}` : `obra ${obraName}`;
    
    console.log(`üìÑ Gerando PDF para ${target} (ID: ${obraId})`);
    showSystemStatus(`Gerando PDF para ${target}...`, "info");
    
    // ‚úÖ Aqui voc√™ implementaria a gera√ß√£o real do PDF
    // generatePDF(obraId, projectName);
}

/**
 * Gera e inicia o download de um documento Word para uma obra ou projeto espec√≠fico
 * @param {string} obraId - ID da obra
 * @param {string|null} projectName - Nome do projeto (opcional)
 * @returns {void}
 * 
 * @example
 * downloadWord('obra_a64') // Gera Word para a obra com ID obra_a64
 * downloadWord('obra_a64', 'ProjetoA') // Gera Word para o ProjetoA da obra
 */
function downloadWord(obraId, projectName = null) {
    // ‚úÖ CORRE√á√ÉO: Buscar obra por ID em vez de nome
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraBlock) {
        console.error(`‚ùå Obra com ID "${obraId}" n√£o encontrada para Word`);
        showSystemStatus(`ERRO: Obra n√£o encontrada`, "error");
        return;
    }

    const obraName = obraBlock.dataset.obraName;
    const target = projectName ? `projeto ${projectName} da obra ${obraName}` : `obra ${obraName}`;
    
    console.log(`üìù Gerando Word para ${target} (ID: ${obraId})`);
    showSystemStatus(`Gerando documento Word para ${target}...`, "info");
    
    // ‚úÖ Aqui voc√™ implementaria a gera√ß√£o real do Word
    // generateWord(obraId, projectName);
}

/**
 * Salva ou atualiza os dados de uma obra no sistema
 * @param {string} obraName - Nome da obra a ser salva/atualizada
 * @param {Event} event - Evento que triggered a a√ß√£o
 * @returns {void}
 * 
 * @example
 * saveOrUpdateObra('Obra1', event) // Salva/atualiza a Obra1
 */
function saveOrUpdateObra(obraParam, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    console.log(`üíæ SALVANDO/ATUALIZANDO OBRA pelo par√¢metro: "${obraParam}"`);

    // ‚úÖ CORRE√á√ÉO: Converter automaticamente nome para ID
    let obraId = obraParam;
    
    // Se for nome (n√£o come√ßa com "obra_" e n√£o √© num√©rico)
    if (!obraParam.startsWith('obra_') && !/^\d+$/.test(obraParam)) {
        console.warn(`‚ö†Ô∏è  Par√¢metro "${obraParam}" parece ser um nome, convertendo para ID...`);
        
        // Busca ALL obras com este nome
        const obrasComEsteNome = Array.from(document.querySelectorAll('[data-obra-id]'))
            .filter(obra => obra.dataset.obraName === obraParam);
            
        if (obrasComEsteNome.length === 1) {
            obraId = obrasComEsteNome[0].dataset.obraId;
            console.log(`‚úÖ Convertido nome "${obraParam}" ‚Üí ID "${obraId}"`);
        } else if (obrasComEsteNome.length > 1) {
            console.error(`‚ùå M√∫ltiplas obras com nome "${obraParam}", usando a primeira`);
            obraId = obrasComEsteNome[0].dataset.obraId;
        } else {
            console.error(`‚ùå Nenhuma obra encontrada com nome "${obraParam}"`);
            showSystemStatus(`ERRO: Obra "${obraParam}" n√£o encontrada`, "error");
            return;
        }
    }

    // Agora busca pelo ID corrigido
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    
    if (!obraBlock) {
        console.error(`‚ùå ERRO: Obra com ID "${obraId}" n√£o encontrada no DOM`);
        
        // Debug detalhado
        const availableObras = document.querySelectorAll('[data-obra-id]');
        console.log(`üîç Obras dispon√≠veis: ${availableObras.length}`);
        availableObras.forEach((obra, idx) => {
            console.log(`   ${idx + 1}. ID: "${obra.dataset.obraId}", Nome: "${obra.dataset.obraName}"`);
        });
        
        showSystemStatus(`ERRO: Obra n√£o encontrada`, "error");
        return;
    }

    console.log(`‚úÖ Obra encontrada:`, obraBlock.dataset);

    if (typeof window.saveObra === 'function') {
        // ‚úÖ Agora passa o ID correto para a fun√ß√£o interna
        window.saveObra(obraId, event);
    } else {
        console.error('‚ùå Fun√ß√£o saveObra n√£o encontrada');
        showSystemStatus("ERRO: Funcionalidade de salvar n√£o dispon√≠vel", "error");
    }
}






// =============================================================================
// EXPORTA√á√ïES ADICIONAIS
// =============================================================================

export {
    addNewProject,
    toggleObra,
    toggleProject,
    toggleRoom,
    downloadPDF,
    downloadWord,
    saveOrUpdateObra,
    toggleSubsection,
    toggleSection,

}

// =============================================================================
// DISPONIBILIZA√á√ÉO GLOBAL DAS FUN√á√ïES
// =============================================================================

if (typeof window !== 'undefined') {
    window.addNewObra = addNewObra;
    window.addNewProjectToObra = addNewProjectToObra;
    window.toggleObra = toggleObra;
    window.toggleProject = toggleProject;
    window.toggleRoom = toggleRoom;
    window.toggleSubsection = toggleSubsection;
    window.toggleSection = toggleSection;
    window.getNextObraNumber = getNextObraNumber;
    window.deleteObra = deleteObra;
    window.saveOrUpdateObra = saveOrUpdateObra;
    window.downloadPDF = downloadPDF;
    window.downloadWord = downloadWord;
    window.addNewProject = addNewProject;
    window.createEmptyProject = createEmptyProject;
}
/* ==== FIM: ui/interface.js ==== */

/* ==== IN√çCIO: features/managers/obra-folder/obra-save-handler.js ==== */
import { ensureStringId } from '../../../data/utils/id-generator.js';
import { buildObraData } from '../../../data/builders/data-builders.js';
import { showSystemStatus } from '../../../ui/components/status.js';
import { isSessionActive, startSessionOnFirstSave } from '../../../data/adapters/session-adapter.js';
import { findObraBlockWithRetry } from './obra-dom-manager.js';
import { supportFrom_saveObra, atualizarObra } from './obra-persistence.js';

/**
 * üíæ FUN√á√ÉO PRINCIPAL DE SALVAMENTO
 */

async function saveObra(obraId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    console.log(`üíæ SALVANDO OBRA pelo ID: "${obraId}"`);

    let obraBlock = await findObraBlockWithRetry(obraId, 15);
    
    if (!obraBlock) {
        console.error('‚ùå Obra n√£o encontrada no DOM ap√≥s m√∫ltiplas tentativas:', obraId);
        
        const todasObras = document.querySelectorAll('[data-obra-id]');
        console.log('üìã Obras dispon√≠veis no DOM:', Array.from(todasObras).map(o => ({
            id: o.dataset.obraId,
            name: o.dataset.obraName
        })));
        
        showSystemStatus("ERRO: Obra n√£o encontrada na interface", "error");
        return;
    }

    const obraOriginalReference = obraBlock;
    const obraContainer = obraBlock.parentElement;
    
    console.log('üîí REFER√äNCIA SALVA:', {
        obra: obraOriginalReference,
        container: obraContainer,
        obraNoContainer: obraContainer.contains(obraOriginalReference)
    });

    if (!isSessionActive()) {
        console.log("üÜï Iniciando sess√£o para primeira obra...");
        await startSessionOnFirstSave();
    }

    if (!isSessionActive()) {
        console.warn("‚ö†Ô∏è Sess√£o n√£o est√° ativa - obra n√£o ser√° salva");
        showSystemStatus("ERRO: Sess√£o n√£o est√° ativa. Obra n√£o salva.", "error");
        return;
    }

    console.log('‚úÖ Obra confirmada no DOM:', {
        element: obraBlock,
        dataset: obraBlock.dataset,
        id: obraBlock.dataset.obraId,
        name: obraBlock.dataset.obraName
    });

    console.log('üî® Construindo dados da obra...');
    const obraData = buildObraData(obraBlock);

    if (!obraData) {
        console.error('‚ùå Falha ao construir dados da obra');
        showSystemStatus("ERRO: Falha ao construir dados da obra", "error");
        return;
    }

    const obraIdFromDOM = obraBlock.dataset.obraId;
    const obraIdFromData = obraData.id;
    const finalObraId = obraIdFromDOM || obraIdFromData;
    
    console.log('üîç VERIFICA√á√ÉO DE OBRA MELHORADA:');
    console.log('- ID no DOM:', obraIdFromDOM);
    console.log('- ID nos dados:', obraIdFromData);
    console.log('- ID final para uso:', finalObraId);
    console.log('- √â ID seguro?:', finalObraId?.startsWith('obra_'));
    
    let isNewObra = true;
    
    try {
        const todasObrasResponse = await fetch('/api/backup-completo');
        if (todasObrasResponse.ok) {
            const backupData = await todasObrasResponse.json();
            const todasObras = backupData.obras || [];
            const obraExistente = todasObras.find(obra => String(obra.id) === String(finalObraId));
            
            isNewObra = !obraExistente;
            console.log(`- J√° existe no servidor?: ${!isNewObra}`);
        }
    } catch (error) {
        console.log('- N√£o foi poss√≠vel verificar servidor, assumindo como nova obra');
    }

    console.log('- √â nova obra?:', isNewObra);

    let result = null;
    
    if (isNewObra) {
        console.log('üÜï SALVANDO COMO NOVA OBRA COM ID SEGURO:', finalObraId);
        
        obraData.id = finalObraId;
        
        if (!obraData.id || !obraData.id.startsWith('obra_')) {
            console.error('‚ùå Obra n√£o possui ID seguro v√°lido para salvar');
            showSystemStatus("ERRO: Obra n√£o possui ID v√°lido", "error");
            return;
        }
        
        result = await supportFrom_saveObra(obraData);
    } else {
        console.log('üìù ATUALIZANDO OBRA EXISTENTE, ID SEGURO:', finalObraId);
        
        if (!finalObraId.startsWith('obra_')) {
            console.error(`ERRO: ID n√£o seguro para atualiza√ß√£o: ${finalObraId}`);
            showSystemStatus("ERRO: ID da obra inv√°lido para atualiza√ß√£o", "error");
            return;
        }
        
        result = await atualizarObra(finalObraId, obraData);
    }

    if (result) {
        const finalId = ensureStringId(result.id);
        
        let obraBlockAtual = document.querySelector(`[data-obra-id="${finalId}"]`);
        
        if (!obraBlockAtual) {
            console.error('‚ùå CR√çTICO: Obra desapareceu do DOM durante salvamento!');
            console.log('üîç Tentando recuperar da refer√™ncia original...');
            
            if (obraContainer && document.body.contains(obraContainer)) {
                const obrasNoContainer = obraContainer.querySelectorAll('[data-obra-id]');
                console.log(`üì¶ Obras no container original: ${obrasNoContainer.length}`);
                
                if (obraContainer.contains(obraOriginalReference)) {
                    obraBlockAtual = obraOriginalReference;
                    console.log('‚úÖ Obra recuperada da refer√™ncia original');
                } else {
                    console.error('‚ùå Obra n√£o est√° mais no container original');
                    showSystemStatus("ERRO: Obra perdida durante salvamento", "error");
                    return;
                }
            } else {
                console.error('‚ùå Container original n√£o encontrado');
                showSystemStatus("ERRO: Obra perdida durante salvamento", "error");
                return;
            }
        }

        obraBlockAtual.dataset.obraId = finalId;
        obraBlockAtual.dataset.obraName = obraData.nome;
        
        const titleElement = obraBlockAtual.querySelector('.obra-title');
        if (titleElement && titleElement.textContent !== obraData.nome) {
            titleElement.textContent = obraData.nome;
        }

        if (typeof updateObraButtonAfterSave === 'function' && document.body.contains(obraBlockAtual)) {
            console.log("‚úÖ Obra confirmada no DOM, atualizando bot√£o...");
            updateObraButtonAfterSave(obraData.nome, finalId);
        } else {
            console.error('‚ùå Obra n√£o est√° no DOM para atualizar bot√£o');
        }

        // üÜï üÜï üÜï ATUALIZAR HEADER AP√ìS SALVAMENTO
        console.log('üîÑ [HEADER] Chamando atualiza√ß√£o do header ap√≥s salvamento...');
        await atualizarHeaderObraAposSalvamento(finalId);

        console.log(`‚úÖ OBRA SALVA/ATUALIZADA COM SUCESSO! ID SEGURO: ${finalId}`);
        showSystemStatus("Obra salva com sucesso!", "success");
    } else {
        console.error('‚ùå FALHA AO SALVAR OBRA NO SERVIDOR');
        showSystemStatus("ERRO: Falha ao salvar obra no servidor", "error");
    }
}

/**
 * üÜï ATUALIZA O HEADER DA OBRA AP√ìS SALVAMENTO
 */
async function atualizarHeaderObraAposSalvamento(obraId) {
    try {
        console.log(`üîÑ [HEADER] Iniciando atualiza√ß√£o do header para obra: ${obraId}`);
        
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [HEADER] Obra ${obraId} n√£o encontrada no DOM`);
            return;
        }

        // Importar as fun√ß√µes necess√°rias
        const { extractEmpresaData } = await import('../../../data/builders/data-builders-folder/empresa-data-extractor.js');
        const { atualizarInterfaceComEmpresa } = await import('../../../data/adapters/obra-adapter-folder/empresa-form-manager.js');
        
        // Extrair dados atualizados da empresa
        console.log('üîç [HEADER] Extraindo dados da empresa...');
        const empresaData = extractEmpresaData(obraElement);
        
        console.log('üìä [HEADER] Dados extra√≠dos:', empresaData);
        
        if (!empresaData.empresaSigla || !empresaData.empresaNome) {
            console.log('‚ö†Ô∏è [HEADER] Dados de empresa incompletos para atualizar header');
            return;
        }

        // Atualizar a interface
        console.log('üé® [HEADER] Chamando atualizarInterfaceComEmpresa...');
        await atualizarInterfaceComEmpresa(obraElement, empresaData);
        
        console.log('‚úÖ [HEADER] Header atualizado com sucesso!');

    } catch (error) {
        console.error('‚ùå [HEADER] Erro ao atualizar header:', error);
    }
}



// EXPORTS NO FINAL
export {
    saveObra,
    atualizarHeaderObraAposSalvamento,
};
/* ==== FIM: features/managers/obra-folder/obra-save-handler.js ==== */
