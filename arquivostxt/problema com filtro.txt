
/* ==== IN√çCIO: features/filters/button-delete-universal.js ==== */
/**
 * ButtonDeleteUniversal - Sistema universal de dele√ß√£o para qualquer item
 * Vers√£o em Classe ES6 para compatibilidade com import/export
 * Funciona para: Obras, Projetos, Salas, M√°quinas
 */


// Para adicionar um novo tipo de bot√£o, basta adicionar no BUTTON_CONFIGS e seguir o template abaixo:
/*
'deleteNovoTipo': {
    type: 'novotipo',
    extractIds: (onclick) => {
        // Sua regex para extrair IDs do onclick
        const match = onclick.match(/deleteNovoTipo\('([^']+)',\s*'([^']+)'\)/);
        return match ? { id1: match[1], id2: match[2] } : null;
    },
    buildPath: (ids) => {
        // Construir path array para API
        return ids ? ['obras', ids.id1, 'novosegmento', ids.id2] : null;
    },
    confirmMessage: 'Mensagem de confirma√ß√£o personalizada',
    successMessage: 'Item deletado com sucesso'
}*/

/**
 * ButtonDeleteUniversal - Sistema universal de dele√ß√£o para QUALQUER bot√£o com onclick delete*
 * Vers√£o SIMPLES e DIRETA para seus bot√µes espec√≠ficos
 */
class ButtonDeleteUniversal {
    constructor() {
        // üî• CONFIGURA√á√ÉO SIMPLES - baseada nos SEUS bot√µes
        this.BUTTON_CONFIGS = {
            // Configura√ß√µes por FUN√á√ÉO no onclick
            'deleteMachine': {
                type: 'maquina',
                extractIds: (onclick) => {
                    // onclick="deleteMachine('machine_id')"
                    const match = onclick.match(/deleteMachine\('([^']+)'\)/);
                    return match ? { machineId: match[1] } : null;
                },
                buildPath: (ids) => {
                    // Extrair obra, projeto, sala do machineId
                    const parts = ids.machineId.split('_');
                    if (parts.length >= 5) {
                        const obraId = `obra_${parts[1]}`;
                        const projectId = `${obraId}_proj_${parts[3]}_${parts[4]}`;
                        const roomId = `${projectId}_sala_${parts[6]}_${parts[7]}`;
                        // Para m√°quinas, precisamos do √≠ndice
                        return ['obras', obraId, 'projetos', projectId, 'salas', roomId, 'maquinas', 0];
                    }
                    return null;
                },
                confirmMessage: 'Tem certeza que deseja deletar esta M√ÅQUINA?',
                successMessage: 'M√°quina deletada com sucesso'
            },
            'deleteRoom': {
                type: 'sala',
                extractIds: (onclick) => {
                    // onclick="deleteRoom('obra_id', 'project_id', 'room_id')"
                    const match = onclick.match(/deleteRoom\('([^']+)',\s*'([^']+)',\s*'([^']+)'\)/);
                    return match ? { obraId: match[1], projectId: match[2], roomId: match[3] } : null;
                },
                buildPath: (ids) => ids ? ['obras', ids.obraId, 'projetos', ids.projectId, 'salas', ids.roomId] : null,
                confirmMessage: 'Tem certeza que deseja deletar esta SALA? Todas as m√°quinas ser√£o perdidas.',
                successMessage: 'Sala deletada com sucesso'
            },
            'deleteProject': {
                type: 'projeto',
                extractIds: (onclick) => {
                    // onclick="deleteProject('obra_id', 'project_id')"
                    const match = onclick.match(/deleteProject\('([^']+)',\s*'([^']+)'\)/);
                    return match ? { obraId: match[1], projectId: match[2] } : null;
                },
                buildPath: (ids) => ids ? ['obras', ids.obraId, 'projetos', ids.projectId] : null,
                confirmMessage: 'Tem certeza que deseja deletar este PROJETO? Todas as salas e m√°quinas ser√£o perdidas.',
                successMessage: 'Projeto deletado com sucesso'
            },
            'deleteObra': {
                type: 'obra',
                extractIds: (onclick) => {
                    // onclick="window.deleteObra('Obra1', 'obra_id')"
                    const match = onclick.match(/deleteObra\('([^']+)',\s*'([^']+)'\)/);
                    return match ? { obraName: match[1], obraId: match[2] } : null;
                },
                buildPath: (ids) => ids ? ['obras', ids.obraId] : null,
                confirmMessage: 'Tem certeza que deseja deletar esta OBRA? Todos os projetos, salas e m√°quinas ser√£o perdidos.',
                successMessage: 'Obra deletada com sucesso'
            }
        };
        



        console.log('‚úÖ ButtonDeleteUniversal configurado para SEUS bot√µes espec√≠ficos');
    }

    /**
     * Analisa um bot√£o e retorna sua configura√ß√£o
     */
    analyzeButton(button) {
        if (!button || !button.getAttribute) return null;
        
        const onclick = button.getAttribute('onclick') || '';
        const text = button.textContent?.trim() || '';
        
        // Verificar cada configura√ß√£o
        for (const [funcName, config] of Object.entries(this.BUTTON_CONFIGS)) {
            if (onclick.includes(funcName)) {
                const ids = config.extractIds(onclick);
                if (ids) {
                    const path = config.buildPath(ids);
                    return {
                        button,
                        funcName,
                        config,
                        ids,
                        path,
                        originalText: text,
                        originalOnclick: onclick
                    };
                }
            }
        }
        
        return null;
    }

    /**
     * Configura UM bot√£o espec√≠fico
     */
    setupButton(button) {
        const buttonInfo = this.analyzeButton(button);
        if (!buttonInfo) {
            console.log('‚ö†Ô∏è Bot√£o n√£o identificado:', button);
            return;
        }
        
        console.log(`üîß Configurando bot√£o ${buttonInfo.config.type}:`, buttonInfo.ids);
        
        // Clonar bot√£o para remover event listeners antigos
        const newButton = button.cloneNode(true);
        
        // üî• MANTER AS CLASSES ORIGINAIS (IMPORTANTE!)
        // N√£o alteramos as classes - mantemos btn btn-delete, btn btn-delete-small
        
        // üî• ALTERAR APENAS o onclick e texto quando filtro ativo
        newButton.setAttribute('data-original-onclick', buttonInfo.originalOnclick);
        newButton.setAttribute('data-original-text', buttonInfo.originalText);
        newButton.setAttribute('data-button-type', buttonInfo.config.type);
        
        // Adicionar novo evento
        newButton.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            await this.deleteEntityUniversal(buttonInfo.path, {
                confirmMessage: buttonInfo.config.confirmMessage,
                successMessage: buttonInfo.config.successMessage
            });
        });
        
        // Substituir o bot√£o antigo
        button.parentNode.replaceChild(newButton, button);
        
        console.log(`‚úÖ Bot√£o ${buttonInfo.config.type} configurado`);
        return newButton;
    }

    /**
     * Configura TODOS os bot√µes de dele√ß√£o na p√°gina
     */
    setupAllDeleteButtons() {
        console.log('üîß [DELETE-UNIVERSAL] Buscando bot√µes espec√≠ficos...');
        
        // üî• BUSCAR TODOS OS BOT√ïES COM onclick delete*
        const allButtons = document.querySelectorAll('button');
        let configuredButtons = 0;
        
        allButtons.forEach(button => {
            const onclick = button.getAttribute('onclick') || '';
            if (onclick.includes('delete')) {
                const setup = this.setupButton(button);
                if (setup) configuredButtons++;
            }
        });
        
        console.log(`üéØ [DELETE-UNIVERSAL] ${configuredButtons} bot√µes configurados`);
        return configuredButtons;
    }

    /**
     * Deleta uma entidade usando a API universal (MESMA FUN√á√ÉO)
     */
    async deleteEntityUniversal(pathArray, options = {}) {
        try {
            if (!pathArray) {
                console.error('‚ùå Path inv√°lido');
                return false;
            }

            console.log('üóëÔ∏è [DELETE-UNIVERSAL] Iniciando dele√ß√£o:', pathArray);

            const {
                confirmMessage = 'Tem certeza que deseja deletar este item?',
                successMessage = 'Item deletado com sucesso'
            } = options;

            if (!confirm(confirmMessage)) {
                console.log('‚ùå Dele√ß√£o cancelada pelo usu√°rio');
                return false;
            }

            const response = await fetch('/api/delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: pathArray })
            });

            const result = await response.json();

            if (result.success) {
                console.log(`‚úÖ [DELETE-UNIVERSAL] Sucesso: ${result.message}`);
                alert(successMessage);
                
                // Recarregar ap√≥s dele√ß√£o
                this.handlePostDeletion(pathArray);
                return true;
            } else {
                console.error('‚ùå [DELETE-UNIVERSAL] Erro:', result.error);
                alert(`Erro ao deletar: ${result.error}`);
                return false;
            }

        } catch (error) {
            console.error('‚ùå [DELETE-UNIVERSAL] Exce√ß√£o:', error);
            alert('Erro ao conectar com o servidor.');
            return false;
        }
    }

    /**
     * Lida com recarregamento ap√≥s dele√ß√£o
     */
    handlePostDeletion(pathArray) {
        console.log('üîÑ [DELETE-UNIVERSAL] Processando p√≥s-dele√ß√£o...');
        
        if (pathArray.length === 2 && pathArray[0] === 'obras') {
            this.reloadObrasAfterDeletion();
        } else {
            // Para projetos, salas, m√°quinas - recarregar a obra
            const obraId = pathArray[1];
            if (obraId) {
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        }
    }

    /**
     * Recarrega todas as obras ap√≥s dele√ß√£o
     */
    reloadObrasAfterDeletion() {
        console.log('üîÑ [DELETE-UNIVERSAL] Recarregando obras...');
        
        if (window.FilterSystem) {
            const state = window.FilterSystem.getState();
            if (state && state.active) {
                if (typeof window.FilterSystem.reloadObrasWithCurrentEndpoint === 'function') {
                    window.FilterSystem.reloadObrasWithCurrentEndpoint();
                    return;
                }
            }
        }
        
        // Fallback: recarregar p√°gina
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }
}



// üî• EXPORTAR COMO CLASSE
export { ButtonDeleteUniversal };

// üî• TAMB√âM EXPORTAR PARA WINDOW (para compatibilidade)
if (typeof window !== 'undefined') {
    window.ButtonDeleteUniversal = ButtonDeleteUniversal;
}
/* ==== FIM: features/filters/button-delete-universal.js ==== */

/* ==== IN√çCIO: features/filters/button-mode-manager.js ==== */
/**
 * ButtonModeManager - Gerencia o modo dos bot√µes (normal vs filtro)
 * Vers√£o em Classe ES6 para compatibilidade com import/export
 */
/**
 * ButtonModeManager - Gerencia APENAS a mudan√ßa de texto dos bot√µes
 * Vers√£o SIMPLES: muda "Remover" para "Deletar" quando filtro ativo
 */
class ButtonModeManager {
    constructor() {
        this.state = {
            filterMode: false,
            originalTexts: new Map() // Guarda textos originais
        };
        
        console.log('‚úÖ ButtonModeManager criado (vers√£o SIMPLES)');
    }

    /**
     * Ativa o modo filtro (muda textos)
     */
    enableFilterMode() {
        if (this.state.filterMode) return;
        
        console.log('üéõÔ∏è [BUTTON-MANAGER] Ativando modo filtro (mudando textos)...');
        this.state.filterMode = true;
        this.changeButtonTexts('Deletar');
    }

    /**
     * Desativa o modo filtro (restaura textos)
     */
    disableFilterMode() {
        if (!this.state.filterMode) return;
        
        console.log('üéõÔ∏è [BUTTON-MANAGER] Desativando modo filtro (restaurando textos)...');
        this.state.filterMode = false;
        this.restoreButtonTexts();
    }

    /**
     * Muda textos dos bot√µes
     */
    changeButtonTexts(newText) {
        console.log(`üîÑ Mudando textos dos bot√µes para: "${newText}"`);
        
        // üî• BUSCAR TODOS OS BOT√ïES COM "Remover"
        const allButtons = document.querySelectorAll('button');
        
        allButtons.forEach(button => {
            const text = button.textContent?.trim();
            const onclick = button.getAttribute('onclick') || '';
            
            // Apenas bot√µes que t√™m "Remover" e onclick com "delete"
            if (text && text.includes('Remover') && onclick.includes('delete')) {
                // Guardar texto original se n√£o guardado ainda
                if (!this.state.originalTexts.has(button)) {
                    this.state.originalTexts.set(button, text);
                }
                
                // üî• MUDAR APENAS O TEXTO, MANTENDO O RESTO
                if (text === 'Remover') {
                    button.textContent = newText;
                } else if (text === 'Remover Projeto') {
                    button.textContent = 'Deletar Projeto';
                } else if (text.includes('Remover')) {
                    button.textContent = text.replace('Remover', newText);
                }
                
                // üî• ADICIONAR CLASSE PARA ESTILO (OPCIONAL)
                button.classList.add('filter-mode-active');
                button.style.fontWeight = 'bold';
                
                console.log(`‚úÖ Texto alterado: "${this.state.originalTexts.get(button)}" ‚Üí "${button.textContent}"`);
            }
        });
        
        console.log(`üéØ Textos alterados para modo filtro`);
    }

    /**
     * Restaura textos originais
     */
    restoreButtonTexts() {
        console.log('üîÑ Restaurando textos originais...');
        
        this.state.originalTexts.forEach((originalText, button) => {
            button.textContent = originalText;
            button.classList.remove('filter-mode-active');
            button.style.fontWeight = '';
            
            console.log(`‚úÖ Texto restaurado: "${button.textContent}"`);
        });
        
        // Limpar cache
        this.state.originalTexts.clear();
        console.log('‚úÖ Textos restaurados para modo normal');
    }

    /**
     * Aplica modo atual
     */
    applyMode() {
        console.log('üéõÔ∏è [BUTTON-MANAGER] Aplicando modo atual...');
        
        if (window.FilterSystem) {
            try {
                const filterState = window.FilterSystem.getState();
                if (filterState && filterState.active) {
                    this.enableFilterMode();
                } else {
                    this.disableFilterMode();
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar FilterSystem:', error);
                this.disableFilterMode();
            }
        } else {
            this.disableFilterMode();
        }
    }

    /**
     * Configura observador para novos bot√µes
     */
    setupMutationObserver() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.addedNodes.length > 0 && this.state.filterMode) {
                    // Se novos bot√µes foram adicionados e estamos no modo filtro
                    setTimeout(() => {
                        this.changeButtonTexts('Deletar');
                    }, 100);
                }
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        console.log('üîç Observador configurado para novos bot√µes');
        return observer;
    }

    /**
     * Inicializa o gerenciador
     */
    initialize() {
        console.log('üîß [BUTTON-MANAGER] Inicializando (vers√£o SIMPLES)...');
        
        this.setupMutationObserver();
        setTimeout(() => {
            this.applyMode();
        }, 500);
        
        console.log('‚úÖ ButtonModeManager inicializado');
        return true;
    }
}

// üî• EXPORTAR
export { ButtonModeManager };

// üî• TAMB√âM EXPORTAR PARA WINDOW (para compatibilidade)
if (typeof window !== 'undefined') {
    window.ButtonModeManager = ButtonModeManager;
}
/* ==== FIM: features/filters/button-mode-manager.js ==== */

/* ==== IN√çCIO: features/filters/filter-autocomplete.js ==== */
/**
 * filter-autocomplete.js - Integra√ß√£o do autocomplete no filtro de empresa
 * REUTILIZA COMPLETAMENTE o sistema existente de autocomplete
 */

const FilterAutocomplete = (function () {
    let empresaInput = null;
    let dropdown = null;
    let optionsContainer = null;
    let isInitialized = false;
    let empresasCache = null;

    /**
     * Inicializa autocomplete no filtro de empresa
     */
    async function initialize() {
        if (isInitialized) {
            console.log('‚ö†Ô∏è [FILTER-AUTOCOMPLETE] J√° inicializado');
            return true;
        }

        console.log('üîß [FILTER-AUTOCOMPLETE] Inicializando...');

        // Buscar elementos
        empresaInput = document.getElementById('filter-empresa');
        if (!empresaInput) {
            console.error('‚ùå [FILTER-AUTOCOMPLETE] Input de empresa n√£o encontrado');
            return false;
        }

        // Criar dropdown (reutilizando estrutura do sistema existente)
        createDropdown();

        // Carregar empresas com cache (reutiliza fun√ß√£o existente)
        await loadEmpresas();

        // Configurar eventos
        setupEventListeners();

        isInitialized = true;
        console.log('‚úÖ [FILTER-AUTOCOMPLETE] Inicializado com sucesso');
        return true;
    }

    /**
     * Cria dropdown similar ao existente
     */
    function createDropdown() {
        // Criar container do dropdown
        dropdown = document.createElement('div');
        dropdown.id = 'filter-empresa-dropdown';
        dropdown.className = 'empresa-dropdown filter-dropdown';
        dropdown.style.cssText = `
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: ${empresaInput.offsetWidth}px;
        `;

        // Container para op√ß√µes
        optionsContainer = document.createElement('div');
        optionsContainer.id = 'filter-empresa-options';
        optionsContainer.className = 'dropdown-options';

        dropdown.appendChild(optionsContainer);
        document.body.appendChild(dropdown);

        // Posicionar abaixo do input
        updateDropdownPosition();

        // Atualizar posi√ß√£o quando redimensionar
        window.addEventListener('resize', updateDropdownPosition);
    }

    /**
     * Atualiza posi√ß√£o do dropdown
     */
    function updateDropdownPosition() {
        if (!dropdown || !empresaInput) return;

        const rect = empresaInput.getBoundingClientRect();
        dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
        dropdown.style.left = (rect.left + window.scrollX) + 'px';
        dropdown.style.width = rect.width + 'px';
    }

    /**
     * Carrega empresas (reutiliza cache do sistema existente)
     */
    async function loadEmpresas() {
        console.log('üì¶ [FILTER-AUTOCOMPLETE] Carregando empresas...');

        try {
            // Tentar usar fun√ß√£o existente primeiro
            if (typeof carregarEmpresasComCache === 'function') {
                empresasCache = await carregarEmpresasComCache();
                console.log(`‚úÖ [FILTER-AUTOCOMPLETE] ${empresasCache.length} empresas carregadas (via cache)`);
            } else {
                // Fallback: buscar diretamente
                const response = await fetch('/api/dados/empresas');
                if (response.ok) {
                    const data = await response.json();
                    empresasCache = data.empresas || [];
                    console.log(`‚úÖ [FILTER-AUTOCOMPLETE] ${empresasCache.length} empresas carregadas (direto)`);
                } else {
                    empresasCache = [];
                    console.warn('‚ö†Ô∏è [FILTER-AUTOCOMPLETE] Nenhuma empresa carregada');
                }
            }
        } catch (error) {
            console.error('‚ùå [FILTER-AUTOCOMPLETE] Erro ao carregar empresas:', error);
            empresasCache = [];
        }
    }

    /**
     * Configura event listeners (reutilizando l√≥gica existente)
     */
    function setupEventListeners() {
        if (!empresaInput || !dropdown) return;

        console.log('üéß [FILTER-AUTOCOMPLETE] Configurando listeners');

        // Input event (com debounce)
        let inputTimeout;
        empresaInput.addEventListener('input', function (e) {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(() => {
                handleInput(e.target.value);
            }, 150);
        });

        // Focus event
        empresaInput.addEventListener('focus', function () {
            if (this.value.trim() === '') {
                showAllEmpresas();
            } else {
                handleInput(this.value);
            }
        });

        // Keydown events (navega√ß√£o)
        empresaInput.addEventListener('keydown', function (e) {
            if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape'].includes(e.key)) {
                e.preventDefault();
                handleKeyDown(e.key);
            }
        });

        // Blur event (fechar dropdown com delay)
        empresaInput.addEventListener('blur', function () {
            setTimeout(() => {
                if (dropdown) dropdown.style.display = 'none';
            }, 200);
        });

        // Click outside to close
        document.addEventListener('click', function (e) {
            if (!empresaInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    }

    /**
     * Manipula input do usu√°rio
     */
    function handleInput(termo) {
        const termoTrim = termo.trim();

        if (termoTrim.length === 0) {
            showAllEmpresas();
            return;
        }

        const sugestoes = filtrarEmpresas(termoTrim, empresasCache);
        exibirSugestoes(sugestoes, termoTrim);
    }

    /**
     * Filtra empresas (reutilizando l√≥gica existente)
     */
    function filtrarEmpresas(termo, empresas) {
        if (!termo || termo.length < 1 || !empresas) return [];

        const termoNormalizado = termo.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

        return empresas.filter(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            return sigla === termoNormalizado ||
                sigla.includes(termoNormalizado) ||
                nomeNormalizado.includes(termoNormalizado);
        });
    }

    /**
     * Exibe todas as empresas
     */
    function showAllEmpresas() {
        if (!empresasCache || empresasCache.length === 0) {
            showNoResults('Digite para buscar empresas');
            return;
        }

        const empresasLimitadas = empresasCache.slice(0, 50);
        renderOptions(empresasLimitadas);
    }

    /**
     * Exibe sugest√µes
     */
    function exibirSugestoes(sugestoes, termo) {
        if (!sugestoes || sugestoes.length === 0) {
            showNoResults(`Nenhuma empresa encontrada para "${termo}"`);
            return;
        }

        const sugestoesLimitadas = sugestoes.slice(0, 50);
        renderOptions(sugestoesLimitadas);
    }

    /**
     * Renderiza op√ß√µes no dropdown
     */
    function renderOptions(empresas) {
        if (!optionsContainer) return;

        optionsContainer.innerHTML = empresas.map(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            return `
                <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}">
                    <strong>${sigla}</strong> 
                    <span class="nome-empresa">- ${nome}</span>
                </div>
            `;
        }).join('');

        // Adicionar event listeners √†s op√ß√µes
        optionsContainer.querySelectorAll('.dropdown-option').forEach(option => {
            option.addEventListener('click', function () {
                selectEmpresa(this.dataset.sigla, this.dataset.nome);
            });
        });

        // Mostrar dropdown
        dropdown.style.display = 'block';
        updateDropdownPosition();
    }

    /**
     * Mostra mensagem de "sem resultados"
     */
    function showNoResults(message) {
        if (!optionsContainer) return;

        optionsContainer.innerHTML = `
            <div class="dropdown-no-results">
                ${message}
            </div>
        `;

        dropdown.style.display = 'block';
        updateDropdownPosition();
    }

    /**
     * Manipula teclas de navega√ß√£o
     */
    function handleKeyDown(key) {
        const options = optionsContainer.querySelectorAll('.dropdown-option');
        if (options.length === 0) return;

        const activeOption = optionsContainer.querySelector('.dropdown-option.active');
        let nextIndex = 0;

        switch (key) {
            case 'ArrowDown':
                if (activeOption) {
                    const currentIndex = Array.from(options).indexOf(activeOption);
                    nextIndex = currentIndex < options.length - 1 ? currentIndex + 1 : 0;
                }
                break;

            case 'ArrowUp':
                if (activeOption) {
                    const currentIndex = Array.from(options).indexOf(activeOption);
                    nextIndex = currentIndex > 0 ? currentIndex - 1 : options.length - 1;
                } else {
                    nextIndex = options.length - 1;
                }
                break;

            case 'Enter':
                if (activeOption) {
                    selectEmpresa(activeOption.dataset.sigla, activeOption.dataset.nome);
                }
                return;

            case 'Escape':
                dropdown.style.display = 'none';
                return;
        }

        // Atualizar op√ß√£o ativa
        options.forEach(opt => opt.classList.remove('active'));
        if (options[nextIndex]) {
            options[nextIndex].classList.add('active');
            options[nextIndex].scrollIntoView({ block: 'nearest' });
        }
    }

    /**
     * Seleciona uma empresa
     */
    /**
     * Seleciona uma empresa
     */
    function selectEmpresa(sigla, nome) {
        console.log(`üéØ [FILTER-AUTOCOMPLETE] Empresa selecionada: ${sigla} - ${nome}`);

        // Preencher input com formato completo
        empresaInput.value = `${sigla} - ${nome}`;

        // ‚úÖ IMPORTANTE: Enviar apenas a SIGLA para o sistema de filtros
        if (window.FilterSystem) {
            window.FilterSystem.updateFilterValue('empresa', sigla); // Apenas sigla!
        }

        // Fechar dropdown
        dropdown.style.display = 'none';

        // Disparar evento change (com delay para evitar duplica√ß√£o)
        setTimeout(() => {
            empresaInput.dispatchEvent(new Event('change', { bubbles: true }));
        }, 10);
    }

    /**
     * Limpa o autocomplete
     */
    function clear() {
        if (empresaInput) {
            empresaInput.value = '';
            empresaInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }

    /**
     * Destr√≥i inst√¢ncia
     */
    function destroy() {
        if (dropdown && dropdown.parentNode) {
            dropdown.parentNode.removeChild(dropdown);
        }

        window.removeEventListener('resize', updateDropdownPosition);
        isInitialized = false;

        console.log('üóëÔ∏è [FILTER-AUTOCOMPLETE] Destru√≠do');
    }

    // API p√∫blica
    return {
        initialize,
        clear,
        destroy,
        isInitialized: () => isInitialized
    };
})();

// Exportar para uso global
window.FilterAutocomplete = FilterAutocomplete;
/* ==== FIM: features/filters/filter-autocomplete.js ==== */

/* ==== IN√çCIO: features/filters/filter-dom.js ==== */
/**
 * filter-dom.js - Interface gr√°fica dos filtros
 * Gerencia DOM, inputs e estados visuais
 */

const FilterDOM = (function () {
    // Elementos DOM
    let filterInputsArea = null;
    let empresaInput = null;
    let numeroClienteInput = null;
    let nomeObraInput = null;
    let inputsInitialized = false;

    /**
     * Inicializa o m√≥dulo DOM
     */
    /**
     * Inicializa o m√≥dulo DOM
     */
    function initialize() {
        console.log('üîß [FILTER-DOM] Inicializando...');

        // Buscar elementos
        filterInputsArea = document.getElementById('filtros-inputs');
        empresaInput = document.getElementById('filter-empresa');
        numeroClienteInput = document.getElementById('filter-numero-cliente');
        nomeObraInput = document.getElementById('filter-nome-obra');

        if (!validateElements()) {
            console.error('‚ùå [FILTER-DOM] Elementos dos filtros n√£o encontrados');
            return false;
        }

        // üî• INICIALIZAR OCULTO (n√£o desabilitado, mas invis√≠vel)
        setFiltersEnabled(false);

        console.log('‚úÖ [FILTER-DOM] Inicializado com sucesso (inputs ocultos)');
        return true;
    }
    /**
     * Valida se elementos existem
     */
    function validateElements() {
        const elements = [filterInputsArea, empresaInput, numeroClienteInput, nomeObraInput];
        const allExist = elements.every(el => el !== null);

        if (!allExist) {
            console.warn('‚ö†Ô∏è [FILTER-DOM] Alguns elementos n√£o encontrados:', {
                filterInputsArea: !!filterInputsArea,
                empresaInput: !!empresaInput,
                numeroClienteInput: !!numeroClienteInput,
                nomeObraInput: !!nomeObraInput
            });
        }

        return allExist;
    }

    /**
     * Habilita/desabilita os inputs de filtro
     */
    /**
     * Habilita/desabilita os inputs de filtro
     */
    function setFiltersEnabled(enabled) {
        console.log(`üéöÔ∏è [FILTER-DOM] ${enabled ? 'Habilitando' : 'Desabilitando'} inputs`);

        // üî• CORRE√á√ÉO: Controlar VISIBILIDADE al√©m de habilita√ß√£o
        [empresaInput, numeroClienteInput, nomeObraInput].forEach(input => {
            if (input) {
                // üî• IMPORTANTE: Controlar display/visibility
                if (enabled) {
                    // Mostrar e habilitar inputs
                    input.style.display = 'block';
                    input.style.visibility = 'visible';
                    input.style.opacity = '1';
                    input.disabled = false;
                    input.style.cursor = 'text';
                    input.style.height = 'auto';
                    input.style.marginTop = '4px';
                    input.style.pointerEvents = 'auto';
                } else {
                    // üî• OCULTAR COMPLETAMENTE quando desabilitado
                    input.style.display = 'none';
                    input.style.visibility = 'hidden';
                    input.style.opacity = '0';
                    input.disabled = true;
                    input.style.cursor = 'default';
                    input.style.height = '0';
                    input.style.marginTop = '0';
                    input.style.pointerEvents = 'none';
                    input.value = '';

                    // Disparar eventos de limpeza
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        });

        // üî• √Årea de inputs - controlar altura
        if (filterInputsArea) {
            if (enabled) {
                // Mostrar √°rea com transi√ß√£o suave
                filterInputsArea.style.display = 'flex'; // ou 'flex' dependendo do CSS
                filterInputsArea.style.visibility = 'visible';
                filterInputsArea.style.opacity = '1';
                filterInputsArea.style.height = 'auto';
                filterInputsArea.style.maxHeight = '200px';
                filterInputsArea.style.transition = 'all 0.3s ease';
                filterInputsArea.style.pointerEvents = 'auto';
                filterInputsArea.style.marginTop = '8px';
            } else {
                // Ocultar √°rea completamente
                filterInputsArea.style.display = 'none';
                filterInputsArea.style.visibility = 'hidden';
                filterInputsArea.style.opacity = '0';
                filterInputsArea.style.height = '0';
                filterInputsArea.style.maxHeight = '0';
                filterInputsArea.style.overflow = 'hidden';
                filterInputsArea.style.pointerEvents = 'none';
                filterInputsArea.style.marginTop = '0';
                filterInputsArea.style.padding = '0';
                filterInputsArea.style.border = 'none';
            }
        }

        // üî• Configurar listeners apenas quando habilitado pela primeira vez
        if (enabled && !inputsInitialized) {
            setupInputListeners();
            inputsInitialized = true;
        }

        // üî• Se desabilitando, notificar sistema para limpar filtros
        if (!enabled && window.FilterSystem) {
            window.FilterSystem.clearFilters();
        }
    }

    /**
     * Retorna placeholder original
     */
    function getOriginalPlaceholder(inputId) {
        const placeholders = {
            'filter-empresa': 'Empresa',
            'filter-numero-cliente': 'N¬∫ Cliente',
            'filter-nome-obra': 'Nome da Obra'
        };
        return placeholders[inputId] || '';
    }

    /**
     * Limpa todos os inputs
     */
    function clearFilterInputs() {
        console.log('üßπ [FILTER-DOM] Limpando inputs');

        [empresaInput, numeroClienteInput, nomeObraInput].forEach(input => {
            if (input) {
                input.value = '';

                // Disparar eventos
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    }

    /**
     * Configura listeners nos inputs
     */
    function setupInputListeners() {
        if (!empresaInput || !numeroClienteInput || !nomeObraInput) return;

        console.log('üéß [FILTER-DOM] Configurando listeners');

        // üî• CORRE√á√ÉO: Usar 'input' em vez de 'change' para empresa
        // Para capturar sele√ß√£o do autocomplete e digita√ß√£o manual
        empresaInput.addEventListener('input', debounce(function (e) {
            const value = e.target.value.trim();
            console.log(`üè¢ [FILTER-DOM] Empresa alterada: "${value}"`);

            if (window.FilterSystem) {
                // Enviar valor completo para filtro (o sistema extrair√° a sigla)
                window.FilterSystem.updateFilterValue('empresa', value || null);
            }
        }, 500));

        // Listener para n√∫mero do cliente (com debounce)
        numeroClienteInput.addEventListener('input', debounce(function (e) {
            const value = e.target.value.trim();
            const numValue = value ? parseInt(value) : null;

            console.log(`üî¢ [FILTER-DOM] N¬∫ Cliente alterado: ${value}`);

            if (window.FilterSystem) {
                window.FilterSystem.updateFilterValue('numeroCliente', numValue);
            }
        }, 500));

        // Listener para nome da obra (com debounce)
        nomeObraInput.addEventListener('input', debounce(function (e) {
            const value = e.target.value.trim();

            console.log(`üèóÔ∏è [FILTER-DOM] Nome obra alterado: "${value}"`);

            if (window.FilterSystem) {
                window.FilterSystem.updateFilterValue('nomeObra', value || null);
            }
        }, 500));

        // Clear on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && window.FilterSystem) {
                window.FilterSystem.clearFilters();
            }
        });
    }

    /**
     * Debounce helper
     */
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    /**
     * Retorna valores atuais dos inputs
     */
    function getFilterValues() {
        return {
            empresa: empresaInput ? empresaInput.value.trim() : '',
            numeroCliente: numeroClienteInput ? numeroClienteInput.value.trim() : '',
            nomeObra: nomeObraInput ? nomeObraInput.value.trim() : ''
        };
    }

    /**
     * Atualiza placeholder dinamicamente (para dicas)
     */
    function updatePlaceholders(count) {
        if (!empresaInput || !nomeObraInput) return;

        if (count > 0) {
            empresaInput.placeholder = `Empresa (${count} obras)`;
            nomeObraInput.placeholder = `Nome da Obra (${count} obras)`;
        } else {
            empresaInput.placeholder = getOriginalPlaceholder('filter-empresa');
            nomeObraInput.placeholder = getOriginalPlaceholder('filter-nome-obra');
        }
    }

    // API p√∫blica
    return {
        initialize,
        setFiltersEnabled,
        clearFilterInputs,
        getFilterValues,
        updatePlaceholders
    };
})();

// Exportar para uso global
window.FilterDOM = FilterDOM;
/* ==== FIM: features/filters/filter-dom.js ==== */

/* ==== IN√çCIO: features/filters/filter-system.js ==== */
/**
 * filter-system.js - C√©rebro do sistema de filtros
 * Gerencia estados, switch e endpoint
 * TOTALMENTE MODULAR - n√£o altera fun√ß√µes existentes
 */

const FilterSystem = (function () {
    // Estado interno do filtro
    const state = {
        active: false,
        endpointMode: 'session', // 'session' | 'general'
        filterValues: {
            empresa: null,
            numeroCliente: null,
            nomeObra: null
        },
        systemReady: false,
        isLoading: false,
        currentObras: [] // Cache das obras carregadas
    };

    // Refer√™ncias DOM
    let filterToggle = null;
    let filterSwitchArea = null;

    /**
     * Inicializa o sistema de filtros
     */
    function initialize() {
        console.log('üîß [FILTER-SYSTEM] Inicializando...');

        // Buscar elementos DOM
        filterToggle = document.getElementById('filter-toggle');
        filterSwitchArea = document.querySelector('.filtro-switch-area');

        if (!filterToggle) {
            console.error('‚ùå [FILTER-SYSTEM] Switch de filtro n√£o encontrado');
            return false;
        }

        // Inicializar outros m√≥dulos
        if (window.FilterDOM) {
            window.FilterDOM.initialize();
        }

        // Configurar listener do switch (mas switch ainda desabilitado)
        setupSwitchListener();

        // Aguardar sistema principal carregar (mesma l√≥gica do bot√£o Nova Obra)
        waitForSystemReady();

        console.log('‚úÖ [FILTER-SYSTEM] Inicializado com sucesso');
        return true;
    }

    /**
     * Aguarda sistema principal carregar para habilitar switch
     * MESMA L√ìGICA DO BOT√ÉO "NOVA OBRA"
     */
    function waitForSystemReady() {
        console.log('‚è≥ [FILTER-SYSTEM] Aguardando sistema principal carregar...');

        const checkInterval = setInterval(() => {
            if (window.systemLoaded) {
                clearInterval(checkInterval);
                state.systemReady = true;
                enableFilterSwitch();
                console.log('‚úÖ [FILTER-SYSTEM] Sistema carregado - switch habilitado');
            }
        }, 500);

        // Timeout de seguran√ßa (30 segundos)
        setTimeout(() => {
            clearInterval(checkInterval);
            if (!state.systemReady) {
                console.warn('‚ö†Ô∏è [FILTER-SYSTEM] Timeout ao aguardar sistema carregar');
                // Tenta habilitar mesmo assim (fallback)
                enableFilterSwitch();
            }
        }, 30000);
    }

    /**
     * Habilita o switch de filtro (MESMA L√ìGICA DO BOT√ÉO "NOVA OBRA")
     */
    function enableFilterSwitch() {
        if (!filterToggle) return;

        filterToggle.disabled = false;
        filterToggle.title = 'Ativar filtros avan√ßados';

        if (filterSwitchArea) {
            filterSwitchArea.style.opacity = '1';
            filterSwitchArea.style.cursor = 'pointer';
        }

        console.log('‚úÖ [FILTER-SYSTEM] Switch de filtro habilitado');
    }

    /**
     * Configura listener para mudan√ßa do switch
     */
    function setupSwitchListener() {
        filterToggle.addEventListener('change', function (e) {
            const isActive = e.target.checked;
            handleFilterToggleChange(isActive);
        });
    }

    /**
     * Manipula mudan√ßa no switch
     */
    function handleFilterToggleChange(isActive) {
        if (state.isLoading) {
            console.log('‚è≥ [FILTER-SYSTEM] Sistema ocupado, ignorando toggle');
            filterToggle.checked = !isActive; // Reverte visualmente
            return;
        }

        console.log(`üîÄ [FILTER-SYSTEM] Switch ${isActive ? 'ATIVADO' : 'DESATIVADO'}`);

        // Atualizar estado
        state.active = isActive;
        state.endpointMode = isActive ? 'general' : 'session';
        
        if (window.ButtonModeManager) {
            if (isActive) {
                window.ButtonModeManager.enableFilterMode();
            } else {
                window.ButtonModeManager.disableFilterMode();
            }
        }
        // Limpar cache quando desativar
        if (!isActive) {
            state.currentObras = [];
        }

        // Notificar outros m√≥dulos
        if (window.FilterDOM) {
            window.FilterDOM.setFiltersEnabled(isActive);
        }

        // Inicializar autocomplete se ativado
        if (window.FilterAutocomplete && isActive) {
            window.FilterAutocomplete.initialize();
        }

        // Atualizar UI do switch
        updateSwitchUI(isActive);

        // Recarregar obras com endpoint correto
        reloadObrasWithCurrentEndpoint();
    }


    /**
     * Atualiza UI do switch
     */
    function updateSwitchUI(isActive) {
        if (!filterSwitchArea) return;

        const label = filterSwitchArea.querySelector('.switch-label-text');
        if (label) {
            label.textContent = isActive
                ? 'Filtro Ativo (Modo Geral)'
                : 'Filtro de Obras';
            label.style.color = isActive ? '#4CAF50' : '#666';
            label.style.fontWeight = isActive ? 'bold' : 'normal';
            label.style.transition = 'color 0.3s ease';
        }

        // Visual feedback no switch
        if (filterSwitchArea) {
            filterSwitchArea.style.backgroundColor = isActive
                ? 'rgba(76, 175, 80, 0.1)'
                : 'transparent';
            filterSwitchArea.style.transition = 'background-color 0.3s ease';
            filterSwitchArea.style.borderRadius = '6px';
            filterSwitchArea.style.padding = isActive ? '8px' : '4px';
        }

        // üî• ATUALIZAR: Feedback visual no switch toggle
        const switchElement = document.querySelector('.filter-switch');
        if (switchElement) {
            switchElement.style.boxShadow = isActive
                ? '0 0 10px rgba(76, 175, 80, 0.5)'
                : 'none';
        }
    }

    /**
     * Retorna endpoint correto baseado no estado
     */
    function getCurrentEndpoint() {
        if (state.active) {
            console.log('üåê [FILTER-SYSTEM] Endpoint: /obras (TODAS as obras)');
            return '/obras';
        } else {
            console.log('üåê [FILTER-SYSTEM] Endpoint: /api/session-obras (apenas sess√£o)');
            return '/api/session-obras';
        }
    }

    /**
     * Recarrega obras com endpoint atual + filtros
     */
    async function reloadObrasWithCurrentEndpoint() {
        if (state.isLoading) {
            console.log('‚è≥ [FILTER-SYSTEM] J√° recarregando, ignorando...');
            return;
        }

        state.isLoading = true;
        console.log('üîÑ [FILTER-SYSTEM] Recarregando obras...');

        try {
            // Limpar obras atuais (reutiliza fun√ß√£o existente)
            clearCurrentObras();

            if (state.active) {
                // Modo filtro: carrega TODAS as obras e aplica filtros
                await loadAndFilterAllObras();
            } else {
                // Modo normal: carrega apenas obras da sess√£o
                await loadSessionObras();
            }

            console.log('‚úÖ [FILTER-SYSTEM] Obras recarregadas com sucesso');
            if (window.ButtonModeManager) {
                window.ButtonModeManager.applyMode();
            }

        } catch (error) {
            console.error('‚ùå [FILTER-SYSTEM] Erro ao recarregar obras:', error);
        } finally {
            state.isLoading = false;
        }
    }

    /**
     * Limpa obras atuais do DOM
     */
    function clearCurrentObras() {
        console.log('üßπ [FILTER-SYSTEM] Limpando obras atuais do DOM');

        // Tentar usar fun√ß√£o existente primeiro
        if (typeof removeBaseObraFromHTML === 'function') {
            removeBaseObraFromHTML();
        } else if (typeof window.removeBaseObraFromHTML === 'function') {
            window.removeBaseObraFromHTML();
        } else {
            // Fallback: limpar container manualmente
            const container = document.getElementById('projects-container');
            if (container) {
                container.innerHTML = '';
                console.log('üóëÔ∏è [FILTER-SYSTEM] Container de obras limpo manualmente');
            }
        }

        // Resetar contador se existir
        if (typeof window.resetGeralCount === 'function') {
            window.resetGeralCount();
        }
    }

    /**
     * Carrega TODAS as obras e aplica filtros
     */
    async function loadAndFilterAllObras() {
        console.log('üîç [FILTER-SYSTEM] Carregando TODAS as obras do endpoint /obras');

        try {
            // 1. Buscar todas as obras
            const response = await fetch('/obras');
            if (!response.ok) {
                throw new Error(`Erro ${response.status} ao buscar obras`);
            }

            const todasObras = await response.json();
            console.log(`üì¶ [FILTER-SYSTEM] ${todasObras.length} obras dispon√≠veis no servidor`);

            // Salvar cache para filtragem
            state.currentObras = todasObras;

            // 2. Aplicar filtros
            const obrasFiltradas = aplicarFiltros(todasObras);
            console.log(`üéØ [FILTER-SYSTEM] ${obrasFiltradas.length} obras ap√≥s filtros`);

            // 3. Carregar obras filtradas
            if (obrasFiltradas.length === 0) {
                console.log('üì≠ [FILTER-SYSTEM] Nenhuma obra corresponde aos filtros');
                return;
            }

            // 4. Carregar cada obra
            for (const obraData of obrasFiltradas) {
                await loadObraIntoDOM(obraData);
            }

        } catch (error) {
            console.error('‚ùå [FILTER-SYSTEM] Erro ao carregar todas as obras:', error);
            throw error;
        }
    }

    /**
     * Carrega uma obra no DOM (reutilizando sistema existente)
     */
    /**
     * Carrega uma obra no DOM (reutilizando sistema existente) - SEM FALLBACK
     */
    async function loadObraIntoDOM(obraData) {
        try {
            console.log(`üîÑ [FILTER-SYSTEM] Carregando obra: ${obraData.nome || obraData.id}`);

            // Verificar se j√° existe no DOM
            const obraExistente = document.querySelector(`[data-obra-id="${obraData.id}"]`);
            if (obraExistente) {
                console.log(`‚ö†Ô∏è [FILTER-SYSTEM] Obra ${obraData.id} j√° existe, ignorando`);
                return;
            }

            // üî• OP√á√ÉO 1: Usar loadSingleObra se dispon√≠vel
            if (window.systemFunctions && typeof window.systemFunctions.loadSingleObra === 'function') {
                console.log(`üî® [FILTER-SYSTEM] Carregando via loadSingleObra (systemFunctions)`);
                await window.systemFunctions.loadSingleObra(obraData);
            }
            else if (typeof window.loadSingleObra === 'function') {
                console.log(`üî® [FILTER-SYSTEM] Carregando via loadSingleObra (window)`);
                await window.loadSingleObra(obraData);
            }
            else if (typeof loadSingleObra === 'function') {
                console.log(`üî® [FILTER-SYSTEM] Carregando via loadSingleObra (global)`);
                await loadSingleObra(obraData);
            }
            // üî• OP√á√ÉO 2: Usar createEmptyObra + populateObraData
            else if (window.systemFunctions &&
                typeof window.systemFunctions.createEmptyObra === 'function' &&
                typeof window.systemFunctions.populateObraData === 'function') {
                console.log(`üî® [FILTER-SYSTEM] Criando via createEmptyObra + populateObraData`);

                // Criar obra vazia
                await window.systemFunctions.createEmptyObra(obraData.nome || `Obra ${obraData.id}`, obraData.id);

                // Aguardar cria√ß√£o no DOM
                await new Promise(resolve => setTimeout(resolve, 200));

                // Preencher dados
                const obraElement = document.querySelector(`[data-obra-id="${obraData.id}"]`);
                if (obraElement) {
                    await window.systemFunctions.populateObraData(obraData);
                    // Aplicar dados da empresa na obra carregada pelo filtro
                    try {
                        const obraElement = document.querySelector(`[data-obra-id="${obraData.id}"]`);
                        if (obraElement && window.prepararDadosEmpresaNaObra) {
                            await window.prepararDadosEmpresaNaObra(obraData, obraElement);
                            console.log(`üè¢ Empresa hidratada para obra ${obraData.id}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Obra ${obraData.id} encontrada?`, !!obraElement,
                                "Fun√ß√£o prepararDadosEmpresaNaObra existe?", !!window.prepararDadosEmpresaNaObra);
                        }
                    } catch (err) {
                        console.error("‚ùå Erro aplicando dados de empresa na obra filtrada:", err);
                    }
                }
            }
            else if (typeof window.createEmptyObra === 'function' && typeof window.populateObraData === 'function') {
                console.log(`üî® [FILTER-SYSTEM] Criando via createEmptyObra (window) + populateObraData`);

                await window.createEmptyObra(obraData.nome || `Obra ${obraData.id}`, obraData.id);
                await new Promise(resolve => setTimeout(resolve, 200));

                const obraElement = document.querySelector(`[data-obra-id="${obraData.id}"]`);
                if (obraElement) {
                    await window.populateObraData(obraData);
                }
            }
            else {
                // üî• CR√çTICO: Se n√£o encontrar fun√ß√µes de carregamento
                console.error(`‚ùå [FILTER-SYSTEM] NENHUMA fun√ß√£o de carregamento dispon√≠vel para obra ${obraData.id}`);
                console.error('üí° Verifique se estas fun√ß√µes est√£o dispon√≠veis:');
                console.error('   - loadSingleObra');
                console.error('   - createEmptyObra + populateObraData');

                // N√£o criar fallback manual - apenas logar erro
                return;
            }

            console.log(`‚úÖ [FILTER-SYSTEM] Obra "${obraData.nome}" carregada com sucesso`);

        } catch (error) {
            console.error(`‚ùå [FILTER-SYSTEM] Erro ao carregar obra ${obraData.id}:`, error);
        }
    }

    /**
     * Carrega obras da sess√£o (modo normal)
     */
    /**
     * Carrega obras da sess√£o (modo normal) - SEM FALLBACK
     */
    async function loadSessionObras() {
        console.log('üìÅ [FILTER-SYSTEM] Carregando obras da sess√£o');

        try {
            // üî• IMPORTANTE: Limpar DOM completamente primeiro
            clearCurrentObras();

            // üî• USAR SOMENTE FUN√á√ïES EXPORTADAS - SEM FALLBACK
            if (window.systemFunctions && typeof window.systemFunctions.loadObrasFromServer === 'function') {
                console.log('‚úÖ [FILTER-SYSTEM] Usando loadObrasFromServer do systemFunctions');
                await window.systemFunctions.loadObrasFromServer();
            }
            // üî• ALTERNATIVA: fun√ß√£o direta no window
            else if (typeof window.loadObrasFromServer === 'function') {
                console.log('‚úÖ [FILTER-SYSTEM] Usando loadObrasFromServer do window');
                await window.loadObrasFromServer();
            }
            // üî• ALTERNATIVA: fun√ß√£o global direta
            else if (typeof loadObrasFromServer === 'function') {
                console.log('‚úÖ [FILTER-SYSTEM] Usando loadObrasFromServer global');
                await loadObrasFromServer();
            }
            else {
                // üî• CR√çTICO: Se n√£o encontrar a fun√ß√£o, mostrar erro claro
                console.error('‚ùå [FILTER-SYSTEM] FUN√á√ÉO loadObrasFromServer N√ÉO ENCONTRADA');
                console.error('üí° SOLU√á√ÉO: Certifique-se que a fun√ß√£o est√° dispon√≠vel em:');
                console.error('   - window.loadObrasFromServer');
                console.error('   - window.systemFunctions.loadObrasFromServer');
                console.error('   - ou no escopo global (loadObrasFromServer)');

                // Lan√ßar erro para tratamento externo
                throw new Error('Fun√ß√£o loadObrasFromServer n√£o dispon√≠vel para filtros');
            }

            console.log('‚úÖ [FILTER-SYSTEM] Obras da sess√£o carregadas com sucesso');

        } catch (error) {
            console.error('‚ùå [FILTER-SYSTEM] ERRO ao carregar sess√£o:', error);

            // üî• IMPORTANTE: N√£o tentar fallback, apenas propagar o erro
            throw error;
        }
    }

    /**
     * Aplica filtros ao array de obras
     */
    function aplicarFiltros(obras) {
        if (!state.active || !obras || obras.length === 0) {
            return obras; // Se filtro n√£o ativo ou sem obras, retorna todas
        }

        const { empresa, numeroCliente, nomeObra } = state.filterValues;

        // üî• CORRE√á√ÉO: Se NENHUM filtro preenchido, retorna TODAS as obras
        const hasActiveFilter = empresa || (numeroCliente !== null && numeroCliente !== undefined) || nomeObra;

        if (!hasActiveFilter) {
            console.log('üîì [FILTER-SYSTEM] Nenhum filtro ativo - retornando TODAS as obras');
            return obras;
        }

        console.log(`üéØ [FILTER-SYSTEM] Aplicando filtros:`, { empresa, numeroCliente, nomeObra });

        return obras.filter(obra => {
            let passaEmpresa = true;
            let passaNumero = true;
            let passaNome = true;

            // üî• FILTRO POR EMPRESA - CORRE√á√ÉO CR√çTICA
            if (empresa) {
                const empresaFiltro = empresa.toUpperCase().trim();

                // Extrair apenas sigla do filtro (remover " - NOME" se existir)
                const filtroSigla = empresaFiltro.includes(' - ')
                    ? empresaFiltro.split(' - ')[0].trim()
                    : empresaFiltro;

                // Verificar em v√°rios campos da obra
                const obraSigla = (obra.empresaSigla || '').toUpperCase().trim();
                const obraNomeCompleto = (obra.empresa || '').toUpperCase().trim();
                const obraNomeEmpresa = (obra.nomeEmpresa || '').toUpperCase().trim();

                // Tentar extrair sigla do nome completo se existir
                let obraSiglaExtraida = '';
                if (obraNomeCompleto.includes(' - ')) {
                    obraSiglaExtraida = obraNomeCompleto.split(' - ')[0].trim();
                }

                passaEmpresa = obraSigla === filtroSigla ||
                    obraSigla.includes(filtroSigla) ||
                    obraNomeCompleto.includes(filtroSigla) ||
                    obraNomeEmpresa.includes(filtroSigla) ||
                    obraSiglaExtraida === filtroSigla ||
                    obraSiglaExtraida.includes(filtroSigla);

                if (!passaEmpresa) {
                    console.log(`‚ùå [FILTRO] Obra ${obra.id} falhou no filtro empresa:`, {
                        filtro: filtroSigla,
                        obraSigla,
                        obraNomeCompleto,
                        obraNomeEmpresa,
                        obraSiglaExtraida
                    });
                }
            }

            // üî• FILTRO POR N√öMERO DO CLIENTE
            if (numeroCliente !== null && numeroCliente !== undefined) {
                const filtroNumero = parseInt(numeroCliente);

                // Verificar em v√°rios campos poss√≠veis
                const obraNumero1 = obra.numeroClienteFinal ? parseInt(obra.numeroClienteFinal) : null;
                const obraNumero2 = obra.numeroCliente ? parseInt(obra.numeroCliente) : null;
                const obraNumero3 = obra.clienteNumero ? parseInt(obra.clienteNumero) : null;
                const obraNumero4 = obra.numero ? parseInt(obra.numero) : null;

                const obraNumeros = [obraNumero1, obraNumero2, obraNumero3, obraNumero4];
                const numerosValidos = obraNumeros.filter(n => n !== null && !isNaN(n));

                passaNumero = numerosValidos.some(n => n === filtroNumero);

                if (!passaNumero) {
                    console.log(`‚ùå [FILTRO] Obra ${obra.id} falhou no filtro n√∫mero:`, {
                        filtro: filtroNumero,
                        obraNumeros: numerosValidos
                    });
                }
            }

            // üî• FILTRO POR NOME DA OBRA
            if (nomeObra) {
                const filtroNome = nomeObra.toUpperCase().trim();
                const obraNome1 = (obra.nome || '').toUpperCase().trim();
                const obraNome2 = (obra.titulo || '').toUpperCase().trim();
                const obraNome3 = (obra.nomeObra || '').toUpperCase().trim();

                passaNome = obraNome1.includes(filtroNome) ||
                    obraNome2.includes(filtroNome) ||
                    obraNome3.includes(filtroNome);

                if (!passaNome) {
                    console.log(`‚ùå [FILTRO] Obra ${obra.id} falhou no filtro nome:`, {
                        filtro: filtroNome,
                        obraNome1,
                        obraNome2,
                        obraNome3
                    });
                }
            }

            const passaTodos = passaEmpresa && passaNumero && passaNome;

            if (passaTodos) {
                console.log(`‚úÖ [FILTRO] Obra ${obra.id} passou nos filtros:`, {
                    nome: obra.nome || obra.titulo,
                    empresa: obra.empresaSigla || obra.empresa
                });
            }

            return passaTodos;
        });
    }

    /**
     * Atualiza valor de um filtro espec√≠fico
     */
    function updateFilterValue(filterName, value) {
        if (state.filterValues.hasOwnProperty(filterName)) {
            const oldValue = state.filterValues[filterName];

            // üî• CORRE√á√ÉO: N√£o atualizar se valor for o mesmo (evita loop)
            if (oldValue === value) {
                return;
            }

            state.filterValues[filterName] = value;
            console.log(`üìù [FILTER-SYSTEM] Filtro "${filterName}" atualizado: ${oldValue} ‚Üí ${value}`);

            // üî• ATUALIZAR: Recarregar SEMPRE que filtro mudar (mesmo que seja null)
            if (state.active) {
                console.log('üîÑ [FILTER-SYSTEM] Filtro alterado - recarregando obras...');

                // Debounce para evitar m√∫ltiplas recargas r√°pidas
                clearTimeout(window._filterDebounce);
                window._filterDebounce = setTimeout(() => {
                    reloadObrasWithCurrentEndpoint();
                }, 300);
            }
        }
    }

    /**
     * Limpa todos os filtros
     */
    function clearFilters() {
        console.log('üßπ [FILTER-SYSTEM] Limpando todos os filtros');

        state.filterValues = {
            empresa: null,
            numeroCliente: null,
            nomeObra: null
        };

        // Notificar DOM para limpar inputs
        if (window.FilterDOM) {
            window.FilterDOM.clearFilterInputs();
        }

        // Se filtro ativo, recarregar (para mostrar todas as obras)
        if (state.active) {
            reloadObrasWithCurrentEndpoint();
        }
    }

    /**
     * Retorna estado atual
     */
    function getState() {
        return { ...state };
    }

    /**
     * Verifica se h√° filtros ativos
     */
    function hasActiveFilters() {
        return state.active && (
            state.filterValues.empresa !== null ||
            state.filterValues.numeroCliente !== null ||
            state.filterValues.nomeObra !== null
        );
    }

    // API p√∫blica
    return {
        initialize,
        updateFilterValue,
        clearFilters,
        getState,
        hasActiveFilters,
        getCurrentEndpoint
    };
})();

// Exportar para uso global
window.FilterSystem = FilterSystem;
/* ==== FIM: features/filters/filter-system.js ==== */

/* ==== IN√çCIO: main-folder/system-init.js ==== */
/**
 * system-init.js - INICIALIZA√á√ÉO DO SISTEMA
 * üéØ Carrega constantes, m√≥dulos e componentes principais
 * üî• AGORA COM: Sistemas de dele√ß√£o universal via import
 */

// ‚úÖ IMPORTAR M√ìDULOS COM CAMINHOS CORRETOS
import { loadObrasFromServer } from '../data/adapters/obra-adapter.js';
import { getGeralCount } from '../data/adapters/session-adapter.js';
import { shutdownManual } from '../data/adapters/shutdown-adapter.js';
import EmpresaCadastroInline from '../data/builders/empresa-cadastro-inline.js';

// üî• NOVOS IMPORTS: Sistemas de dele√ß√£o universal
import { ButtonDeleteUniversal } from '../features/filters/button-delete-universal.js';
import { ButtonModeManager } from '../features/filters/button-mode-manager.js';

/**
 * Sistema de Shutdown Manual
 */
class ShutdownManager {
  constructor() {
    this.init();
  }

  init() {
    console.log('üîí Sistema de shutdown manual ativado');
    this.disableAutoShutdown();
    this.createShutdownButton();
  }

  disableAutoShutdown() {
    window.removeEventListener('beforeunload', this.autoShutdown);
    window.removeEventListener('unload', this.autoShutdown);
    window.removeEventListener('pagehide', this.autoShutdown);
  }

  createShutdownButton() {
    if (document.querySelector('.shutdown-btn')) return;

    const headerRight = document.querySelector('.header-right');
    if (headerRight) {
      const shutdownBtn = document.createElement('button');
      shutdownBtn.className = 'shutdown-btn';
      shutdownBtn.innerHTML = '‚èª';
      shutdownBtn.title = 'Encerrar Servidor';
      shutdownBtn.onclick = () => this.shutdownManual();

      headerRight.appendChild(shutdownBtn);
      console.log('‚úÖ Bot√£o de shutdown adicionado ao header');
    }
  }

  async shutdownManual() {
    if (confirm('Deseja realmente ENCERRAR o servidor?')) {
      try {
        console.log('üîÑ Executando shutdown COMPLETO...');

        if (typeof shutdownManual === 'function') {
          await shutdownManual();
        } else {
          console.error('‚ùå Fun√ß√£o shutdownManual n√£o encontrada');
        }

      } catch (error) {
        console.log('üîå Servidor encerrado ou n√£o responde:', error);
      }
    }
  }
}

/**
 * Carrega as constantes do sistema do servidor
 */
async function loadSystemConstants() {
  try {
    console.log("üîç Carregando constantes do sistema...")
    const response = await fetch(`/constants`)

    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`)
    }

    const constantsData = await response.json();
    window.systemConstants = constantsData;
    console.log("‚úÖ Constantes carregadas do JSON:", window.systemConstants);

    if (!window.systemConstants.VARIAVEL_PD || !window.systemConstants.VARIAVEL_PS) {
      console.error("‚ùå ERRO: Constantes essenciais n√£o encontradas no JSON");
      throw new Error("Constantes essenciais n√£o encontradas no JSON");
    }

    return true;
  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao carregar constantes:", error)

    if (error.message.includes('Failed to fetch') ||
      error.message.includes('ERR_CONNECTION_REFUSED') ||
      error.message.includes('404') ||
      error.message.includes('Not Found')) {
      throw error;
    }

    return false;
  }
}

/**
 * Carrega todos os m√≥dulos do sistema dinamicamente
 */
async function loadAllModules() {
  if (window.modulesLoaded) return;

  try {
    console.log("üì¶ Iniciando carregamento de m√≥dulos...");

    // ‚úÖ CARREGAR M√ìDULOS COM CAMINHOS CORRETOS
    const modules = await Promise.all([
      // UI Components
      import('../ui/interface.js'),                    // interfaceModule
      import('../ui/components/edit.js'),              // editModule
      import('../ui/components/status.js'),            // statusModule
      import('../ui/components/modal/modal.js'),       // modalModule
      import('../ui/components/modal/exit-modal.js'),  // modalExitModule
      import('../ui/helpers.js'),                      // helpersModule

      // Features Managers
      import('../features/managers/obra-manager.js'),  // obraManagerModule
      import('../features/managers/project-manager.js'), // projectManagerModule

      // Data Modules
      import('../data/modules/rooms.js'),              // roomsModule
      import('../data/modules/climatizacao.js'),       // climatizationModule
      import('../data/modules/acessorios.js'),       // acessoriosModule
      import('../data/modules/machines/machines-core.js'), // machinesCoreModule
      import('../data/modules/machines/capacity-calculator.js'), // capacityCalculatorModule

      // Calculations
      import('../features/calculations/air-flow.js'),  // airFlowModule
      import('../features/calculations/calculations-core.js'), // calculationsCoreModule

      // Data Utils
      import('../data/utils/id-generator.js'),         // idGeneratorModule
      import('../data/utils/data-utils.js'),           // dataUtilsModule

      // Data Builders
      import('../data/builders/ui-builders.js'),       // uiBuildersModule
      import('../data/builders/data-builders.js')      // dataBuildersModule
    ]);

    const [
      interfaceModule,
      editModule,
      statusModule,
      modalModule,
      modalExitModule,
      helpersModule,
      obraManagerModule,
      projectManagerModule,
      roomsModule,
      climatizationModule,
      configuracaoModule,
      machinesCoreModule,
      capacityCalculatorModule,
      airFlowModule,
      calculationsCoreModule,
      idGeneratorModule,
      dataUtilsModule,
      uiBuildersModule,
      dataBuildersModule
    ] = modules;

    // ‚úÖ ATRIBUIR FUN√á√ïES DOS M√ìDULOS AO WINDOW
    const allFunctions = {
      // ========== UI INTERFACE ==========
      toggleSection: interfaceModule.toggleSection,
      toggleSubsection: interfaceModule.toggleSubsection,
      toggleObra: interfaceModule.toggleObra,
      toggleProject: interfaceModule.toggleProject,
      toggleRoom: interfaceModule.toggleRoom,
      collapseElement: helpersModule.collapseElement,
      expandElement: helpersModule.expandElement,
      showSystemStatus: statusModule.showSystemStatus,

      // ========== OBRA MANAGEMENT ==========
      addNewObra: obraManagerModule.addNewObra,
      saveOrUpdateObra: obraManagerModule.saveObra,
      verifyObraData: obraManagerModule.verifyObraData,
      deleteObra: obraManagerModule.deleteObra,
      saveObra: obraManagerModule.saveObra,
      fetchObras: obraManagerModule.fetchObras,
      supportFrom_saveObra: obraManagerModule.supportFrom_saveObra,
      atualizarObra: obraManagerModule.atualizarObra,

      // ========== PROJECT MANAGEMENT ==========
      addNewProjectToObra: projectManagerModule.addNewProjectToObra,
      deleteProject: projectManagerModule.deleteProject,

      // ========== ROOM MANAGEMENT ==========
      addNewRoom: roomsModule.addNewRoom,
      deleteRoom: roomsModule.deleteRoom,
      createEmptyRoom: roomsModule.createEmptyRoom,

      // ========== CONSTRUCTION SECTIONS ==========
      buildClimatizationSection: climatizationModule.buildClimatizationSection,
      buildMachinesSection: machinesCoreModule.buildMachinesSection,
      buildAccessoriesSection: configuracaoModule.buildAccessoriesSection,

      // ========== CALCULATIONS ==========
      calculateVazaoArAndThermalGains: airFlowModule.calculateVazaoArAndThermalGains,
      calculateVazaoArAndThermalGainsDebounced: calculationsCoreModule.calculateVazaoArAndThermalGainsDebounced,

      // ========== CAPACITY & MACHINES ==========
      calculateCapacitySolution: capacityCalculatorModule.calculateCapacitySolution,
      updateBackupConfiguration: capacityCalculatorModule.updateBackupConfiguration,
      toggleOption: machinesCoreModule.toggleOption,
      addMachine: machinesCoreModule.addMachine,
      deleteMachine: machinesCoreModule.deleteMachine,

      // ========== EDIT FUNCTIONS ==========
      makeEditable: editModule.makeEditable,

      // ========== UTILS ==========
      ensureStringId: idGeneratorModule.ensureStringId,
      getNextObraNumber: dataUtilsModule.getNextObraNumber,
      getNextProjectNumber: dataUtilsModule.getNextProjectNumber,
      getNextRoomNumber: dataUtilsModule.getNextRoomNumber,

      // ========== MODAL FUNCTIONS ==========
      showConfirmationModal: modalModule.showConfirmationModal,
      closeConfirmationModal: modalModule.closeConfirmationModal,
      undoDeletion: modalModule.undoDeletion,

      // ========== HELPER FUNCTIONS ==========
      removeEmptyObraMessage: helpersModule.removeEmptyObraMessage,
      showEmptyObraMessageIfNeeded: helpersModule.showEmptyObraMessageIfNeeded,
      removeEmptyProjectMessage: helpersModule.removeEmptyProjectMessage,
      showEmptyProjectMessageIfNeeded: helpersModule.showEmptyProjectMessageIfNeeded,

      // ========== UI BUILDERS ==========
      populateObraData: uiBuildersModule.populateObraData,
      renderObraFromData: uiBuildersModule.renderObraFromData,
      renderProjectFromData: uiBuildersModule.renderProjectFromData,
      renderRoomFromData: uiBuildersModule.renderRoomFromData,
      fillMachinesData: uiBuildersModule.fillMachinesData,
      fillClimatizationInputs: uiBuildersModule.fillClimatizationInputs,
      fillThermalGainsData: uiBuildersModule.fillThermalGainsData,
      fillCapacityData: uiBuildersModule.fillCapacityData,
      fillAccessoriesData: uiBuildersModule.fillAccessoriesData,
      ensureAllRoomSections: uiBuildersModule.ensureAllRoomSections,
      ensureMachinesSection: uiBuildersModule.ensureMachinesSection,
      populateMachineData: uiBuildersModule.populateMachineData,

      // ========== DATA BUILDERS ==========
      buildObraData: dataBuildersModule.buildObraData,
      buildProjectData: dataBuildersModule.buildProjectData,
      extractRoomData: dataBuildersModule.extractRoomData,
      extractMachinesData: dataBuildersModule.extractMachinesData,
      extractThermalGainsData: dataBuildersModule.extractThermalGainsData,
      extractClimatizationInputs: dataBuildersModule.extractClimatizationInputs,
      extractCapacityData: dataBuildersModule.extractCapacityData,
      extractAccessoriesData: dataBuildersModule.extractAccessoriesData
    };

    // ‚úÖ ATRIBUIR FUN√á√ïES AO WINDOW
    Object.keys(allFunctions).forEach(funcName => {
      if (typeof allFunctions[funcName] === 'function') {
        window[funcName] = allFunctions[funcName];
        console.log(`‚úÖ ${funcName} atribu√≠da ao window`);
      } else if (allFunctions[funcName] !== undefined) {
        console.warn(`‚ö†Ô∏è ${funcName} n√£o √© uma fun√ß√£o:`, typeof allFunctions[funcName]);
      } else {
        console.error(`‚ùå ${funcName} n√£o encontrado nos m√≥dulos`);
      }
    });

    window.modulesLoaded = true;
    console.log("‚úÖ Todos os m√≥dulos foram carregados com sucesso");
    return true;

  } catch (error) {
    console.error("‚ùå Erro ao carregar m√≥dulos:", error);
    return false;
  }
}

/**
 * Inicializa o sistema de cadastro de empresas
 */
async function initializeEmpresaCadastro() {
  try {
    console.log("üè¢ Inicializando sistema de cadastro de empresas...");

    await new Promise(resolve => setTimeout(resolve, 500));

    window.empresaCadastro = new EmpresaCadastroInline();

    console.log("‚úÖ Sistema de cadastro de empresas inicializado");

    const spansCadastro = document.querySelectorAll('.projetc-header-record.very-dark span');
    console.log(`üîç Encontrados ${spansCadastro.length} elementos de cadastro de empresas`);

    return true;
  } catch (error) {
    console.error("‚ùå Erro ao inicializar sistema de cadastro de empresas:", error);
    return false;
  }
}

/**
 * üî• Configura integra√ß√£o com FilterSystem
 */
function setupFilterSystemIntegration() {
  console.log("üîß [SYSTEM-INIT] Configurando integra√ß√£o com FilterSystem...");

  if (!window.FilterSystem) {
    console.warn("‚ö†Ô∏è [SYSTEM-INIT] FilterSystem n√£o dispon√≠vel para integra√ß√£o");
    return false;
  }

  if (!window.ButtonModeManager) {
    console.error("‚ùå [SYSTEM-INIT] ButtonModeManager n√£o dispon√≠vel para integra√ß√£o");
    return false;
  }

  try {
    // Sobrescrever a fun√ß√£o handleFilterToggleChange para incluir ButtonModeManager
    const originalHandleToggleChange = window.FilterSystem.handleFilterToggleChange;

    if (typeof originalHandleToggleChange === 'function') {
      window.FilterSystem.handleFilterToggleChange = function (isActive) {
        console.log(`üéõÔ∏è [INTEGRA√á√ÉO] Filtro ${isActive ? 'ATIVADO' : 'DESATIVADO'}`);

        // Executar fun√ß√£o original
        originalHandleToggleChange.call(this, isActive);

        // Atualizar ButtonModeManager
        if (isActive) {
          window.ButtonModeManager.enableFilterMode();
        } else {
          window.ButtonModeManager.disableFilterMode();
        }

        // Tamb√©m reaplicar modo dos bot√µes
        if (window.ButtonModeManager && typeof window.ButtonModeManager.applyMode === 'function') {
          window.ButtonModeManager.applyMode();
        }
      };

      console.log("‚úÖ [SYSTEM-INIT] Integra√ß√£o FilterSystem-ButtonModeManager configurada");
      return true;
    }
  } catch (error) {
    console.error("‚ùå [SYSTEM-INIT] Erro na integra√ß√£o:", error);
  }

  return false;
}

/**
 * üî• Aplica configura√ß√£o inicial dos bot√µes ap√≥s carregar obras
 */
function setupInitialButtonConfiguration() {
  console.log("üîß [SYSTEM-INIT] Configurando bot√µes inicialmente...");

  // Configurar bot√µes de dele√ß√£o universal
  if (window.ButtonDeleteUniversal && typeof window.ButtonDeleteUniversal.setupAllDeleteButtons === 'function') {
    setTimeout(() => {
      window.ButtonDeleteUniversal.setupAllDeleteButtons();
      console.log("‚úÖ [SYSTEM-INIT] Bot√µes de dele√ß√£o configurados inicialmente");
    }, 500); // Pequeno delay para garantir DOM carregado
  }

  // Aplicar modo inicial dos bot√µes
  if (window.ButtonModeManager && typeof window.ButtonModeManager.applyMode === 'function') {
    setTimeout(() => {
      window.ButtonModeManager.applyMode();
      console.log("‚úÖ [SYSTEM-INIT] Modo inicial aplicado aos bot√µes");
    }, 600);
  }
}

/**
 * Inicializa o sistema completo
 */
export async function initializeSystem() {
  try {
    console.log("üöÄ [SYSTEM-INIT] Iniciando sistema completo...");


    console.log("üîß [SYSTEM-INIT] Criando sistemas de dele√ß√£o...");

    try {
      // Criar inst√¢ncias das classes importadas
      window.ButtonDeleteUniversal = new ButtonDeleteUniversal();
      window.ButtonModeManager = new ButtonModeManager();

      console.log("‚úÖ [SYSTEM-INIT] Sistemas de dele√ß√£o criados:", {
        ButtonDeleteUniversal: !!window.ButtonDeleteUniversal,
        ButtonModeManager: !!window.ButtonModeManager
      });

    } catch (error) {
      console.error("‚ùå [SYSTEM-INIT] Erro ao criar sistemas de dele√ß√£o:", error);
      // Criar objetos vazios para evitar erros
      if (!window.ButtonDeleteUniversal) {
        window.ButtonDeleteUniversal = {
          setupAllDeleteButtons: () => console.warn('ButtonDeleteUniversal n√£o dispon√≠vel')
        };
      }
      if (!window.ButtonModeManager) {
        window.ButtonModeManager = {
          initialize: () => console.warn('ButtonModeManager n√£o dispon√≠vel'),
          applyMode: () => { },
          isFilterMode: () => false
        };
      }
    }

    // üî• PASSO 2: Inicializar sistema de shutdown
    console.log("üîí [SYSTEM-INIT] Inicializando shutdown manager...");
    window.shutdownManager = new ShutdownManager();

    // üî• PASSO 3: Carregar constantes do sistema
    console.log("üìä [SYSTEM-INIT] Carregando constantes do sistema...");
    const constantsLoaded = await loadSystemConstants();
    if (!constantsLoaded) {
      throw new Error("N√£o foi poss√≠vel carregar constantes do sistema");
    }
    console.log("‚úÖ [SYSTEM-INIT] Constantes carregadas");

    // üî• PASSO 4: Carregar todos os m√≥dulos do sistema
    console.log("üì¶ [SYSTEM-INIT] Carregando m√≥dulos do sistema...");
    const modulesLoadedSuccess = await loadAllModules();
    if (!modulesLoadedSuccess) {
      console.warn("‚ö†Ô∏è [SYSTEM-INIT] Alguns m√≥dulos n√£o carregaram completamente");
    }
    console.log("‚úÖ [SYSTEM-INIT] M√≥dulos carregados");

    // üî• PASSO 5: Inicializar sistema de cadastro de empresas
    console.log("üè¢ [SYSTEM-INIT] Inicializando sistema de empresas...");
    const empresaSystemLoaded = await initializeEmpresaCadastro();
    if (!empresaSystemLoaded) {
      console.warn("‚ö†Ô∏è [SYSTEM-INIT] Sistema de cadastro de empresas n√£o carregou completamente");
    }
    console.log("‚úÖ [SYSTEM-INIT] Sistema de empresas inicializado");

    // üî• PASSO 6: Inicializar ButtonModeManager se dispon√≠vel
    console.log("üîß [SYSTEM-INIT] Inicializando ButtonModeManager...");
    if (window.ButtonModeManager && typeof window.ButtonModeManager.initialize === 'function') {
      try {
        await window.ButtonModeManager.initialize();
        console.log("‚úÖ [SYSTEM-INIT] ButtonModeManager inicializado");
      } catch (initError) {
        console.error("‚ùå [SYSTEM-INIT] Erro ao inicializar ButtonModeManager:", initError);
      }
    } else {
      console.warn("‚ö†Ô∏è [SYSTEM-INIT] ButtonModeManager n√£o dispon√≠vel para inicializa√ß√£o");
    }

    // üî• PASSO 7: Configurar integra√ß√£o com FilterSystem
    console.log("üîó [SYSTEM-INIT] Configurando integra√ß√µes...");
    setupFilterSystemIntegration();

    // üî• PASSO 8: Configura√ß√£o inicial dos bot√µes (com delay para DOM)
    console.log("üîß [SYSTEM-INIT] Agendando configura√ß√£o inicial dos bot√µes...");
    setupInitialButtonConfiguration();

    // üî• PASSO 9: Configurar listener para quando obras forem carregadas
    console.log("üîó [SYSTEM-INIT] Configurando listeners de carregamento...");

    // Observer para detectar quando obras s√£o carregadas/renderizadas
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(mutation => {
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
          // Verificar se foram adicionadas obras
          const hasObras = Array.from(mutation.addedNodes).some(node =>
            node.nodeType === 1 &&
            (node.classList?.contains('obra-wrapper') ||
              node.querySelector?.('.obra-wrapper'))
          );

          if (hasObras && window.ButtonModeManager) {
            console.log("üëÄ [SYSTEM-INIT] Novas obras detectadas, reaplicando modo...");
            setTimeout(() => {
              if (window.ButtonModeManager && window.ButtonModeManager.applyMode) {
                window.ButtonModeManager.applyMode();
              }
              if (window.ButtonDeleteUniversal && window.ButtonDeleteUniversal.setupAllDeleteButtons) {
                window.ButtonDeleteUniversal.setupAllDeleteButtons();
              }
            }, 300);
          }
        }
      });
    });

    // Observar container de projetos (onde obras s√£o renderizadas)
    const projectsContainer = document.getElementById('projects-container');
    if (projectsContainer) {
      observer.observe(projectsContainer, { childList: true, subtree: true });
      console.log("üîç [SYSTEM-INIT] Observer configurado para projetos-container");
    }

    console.log("üéâ [SYSTEM-INIT] Sistema completamente inicializado!");
    return true;

  } catch (error) {
    console.error("‚ùå [SYSTEM-INIT] ERRO CR√çTICO na inicializa√ß√£o do sistema:", error);
    throw error;
  }
}
/* ==== FIM: main-folder/system-init.js ==== */
