
/* ==== IN√çCIO: data/adapters/obra-adapter-folder/empresa-autocomplete.js ==== */
 // empresa-autocomplete.js

import {
    inicializarDetectorBackspace,
    corrigirPosicaoDropdown,
    calcularNumeroClienteFinal,
    mostrarAvisoAutocompletado,
    limparDadosSelecao     } from './ui-helpers-obra-adapter.js'

/**
 * üÜï SISTEMA DE DETEC√á√ÉO DE BACKSPACE/DELETE
 */
window.usuarioEstaApagando = false;
window.ultimoValorInput = '';

/**
 * INICIALIZAR INPUT H√çBRIDO - COM CONTROLE DE BACKSPACE (CORRIGIDO)
 */
async function inicializarInputEmpresaHibrido(obraId) {
    console.log(`üîß [INPUT H√çBRIDO] Inicializando para obra: ${obraId}`);
    
    const input = document.getElementById(`empresa-input-${obraId}`);
    const dropdown = document.getElementById(`empresa-dropdown-${obraId}`);
    const optionsContainer = document.getElementById(`empresa-options-${obraId}`);
    
    if (!input) {
        console.error(`‚ùå [INPUT H√çBRIDO] Input n√£o encontrado para obra ${obraId}`);
        return;
    }
    
    // üî• CORRE√á√ÉO: CARREGAR EMPRESAS ANTES DE TUDO
    let empresas = [];
    try {
        console.log(`üì¶ [INPUT H√çBRIDO] Carregando empresas para obra ${obraId}...`);
        const response = await fetch('/api/dados/empresas');
        if (response.ok) {
            const data = await response.json();
            empresas = data.empresas || [];
            console.log(`‚úÖ [INPUT H√çBRIDO] ${empresas.length} empresas carregadas`);
        } else {
            console.error(`‚ùå [INPUT H√çBRIDO] Erro ao carregar empresas: ${response.status}`);
        }
    } catch (error) {
        console.error(`‚ùå [INPUT H√çBRIDO] Erro no carregamento de empresas:`, error);
    }

    // üî• INICIALIZAR DETECTOR DE BACKSPACE PRIMEIRO
    inicializarDetectorBackspace(input, obraId);
    
    // üî• EVENTO DE INPUT ATUALIZADO - RESPEITAR BACKSPACE
    input.addEventListener('input', function(e) {
        const termo = e.target.value.trim();
        console.log(`üîç [INPUT] Digitando: "${termo}" | Apagando: ${window.usuarioEstaApagando}`);
        
        // üî• SE USU√ÅRIO EST√Å APAGANDO, N√ÉO FAZER AUTOCOMPLETE
        if (window.usuarioEstaApagando) {
            console.log('üö´ Autocomplete bloqueado - usu√°rio apagando');
            
            // Apenas busca normal, sem autocomplete autom√°tico
            if (termo.length === 0) {
                limparDadosSelecao(input, obraId);
                exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
            } else {
                const sugestoes = filtrarEmpresas(termo, empresas);
                exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
            }
            
            // Resetar flag ap√≥s processar o input
            setTimeout(() => {
                window.usuarioEstaApagando = false;
            }, 100);
            return;
        }
        
        // üî• COMPORTAMENTO NORMAL (n√£o est√° apagando)
        if (termo.length === 0) {
            console.log('üîÑ Campo apagado - mostrando todas empresas');
            limparDadosSelecao(input, obraId);
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
            return;
        }
        
        const sugestoes = filtrarEmpresas(termo, empresas);
        console.log(`üéØ [INPUT] ${sugestoes.length} sugest√µes para "${termo}"`);
        
        // üî• AUTOCOMPLETE S√ì SE N√ÉO ESTIVER APAGANDO
        if (sugestoes.length === 1 && termo.length > 0 && !window.usuarioEstaApagando) {
            const [sigla, nome] = Object.entries(sugestoes[0])[0];
            
            // Verificar se √© um match forte (usu√°rio digitou sigla completa ou nome significativo)
            const matchForte = termo === sigla || termo.length >= 3;
            
            if (matchForte) {
                console.log(`‚úÖ [AUTOCOMPLETE] √önica sugest√£o: ${sigla} - ${nome}`);
                selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'autocomplete');
                return;
            }
        }
        
        exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
    });
    
    // üî• EVENTO DE FOCO - RESETAR FLAGS E MOSTRAR EMPRESAS
    input.addEventListener('focus', function() {
        window.usuarioEstaApagando = false;
        window.ultimoValorInput = this.value;
        
        const valorAtual = this.value.trim();
        const empresaJaSelecionada = this.dataset.siglaSelecionada;
        
        if (valorAtual.length === 0) {
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        } else if (empresaJaSelecionada && valorAtual === `${this.dataset.siglaSelecionada} - ${this.dataset.nomeSelecionado}`) {
            // Empresa j√° selecionada, n√£o mostrar dropdown
            dropdown.style.display = 'none';
        } else {
            const sugestoes = filtrarEmpresas(valorAtual, empresas);
            exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
        }
    });
    
    // üî• EVENTO DE BLUR - RESETAR FLAGS
    input.addEventListener('blur', function() {
        setTimeout(() => {
            window.usuarioEstaApagando = false;
        }, 200);
    });
    
    // Evento de teclado para navega√ß√£o
    input.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            navegarDropdown('down', optionsContainer, input, dropdown, obraId);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navegarDropdown('up', optionsContainer, input, dropdown, obraId);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            
            // üî• COMPORTAMENTO EXCEL: Se o dropdown est√° aberto, seleciona a op√ß√£o ativa
            if (dropdown.style.display === 'block') {
                selecionarOpcaoAtiva(optionsContainer, input, dropdown, obraId);
            } else {
                // Se o dropdown est√° fechado mas h√° uma empresa j√° preenchida, apenas fecha
                dropdown.style.display = 'none';
                input.blur();
            }
        } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
            input.blur();
        } else if (e.key === 'Tab') {
            // üî• COMPORTAMENTO EXCEL: Tab tamb√©m seleciona a op√ß√£o ativa
            if (dropdown.style.display === 'block') {
                e.preventDefault();
                selecionarOpcaoAtiva(optionsContainer, input, dropdown, obraId);
            }
        }
    });
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (input && dropdown && !input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    console.log(`‚úÖ [INPUT H√çBRIDO] Inicializado com sucesso para obra ${obraId}`);
}

/**
 * FILTRAR EMPRESAS POR TERMO
 */
function filtrarEmpresas(termo, empresas) {
    if (!termo || termo.length < 1) return [];
    
    const termoNormalizado = termo.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    
    return empresas.filter(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        
        return sigla === termoNormalizado || 
               sigla.includes(termoNormalizado) ||
               nomeNormalizado.includes(termoNormalizado);
    });
}

/**
 * EXIBIR SUGEST√ïES NO DROPDOWN - COM COMPORTAMENTO EXCEL CORRIGIDO
 */
function exibirSugestoes(sugestoes, container, input, dropdown, obraId) {
    const valorAtual = input.value.trim();
    const empresaJaSelecionada = input.dataset.siglaSelecionada;
    
    // üî• N√ÉO FAZER AUTOCOMPLETE SE USU√ÅRIO EST√Å APAGANDO
    if (window.usuarioEstaApagando) {
        console.log('üö´ Autocomplete ignorado - modo apagando ativo');
        // Mostrar sugest√µes normais, mas n√£o auto-selecionar
    }
    
    if (empresaJaSelecionada && valorAtual === `${input.dataset.siglaSelecionada} - ${input.dataset.nomeSelecionado}`) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }
    
    if (!sugestoes || sugestoes.length === 0) {
        if (valorAtual.length > 0) {
            container.innerHTML = `
                <div class="dropdown-no-results">
                    üìù Nenhuma empresa encontrada<br>
                    <small>Criando nova empresa: "${valorAtual}"</small>
                </div>
            `;
        } else {
            container.innerHTML = '<div class="dropdown-no-results">Digite para buscar empresas</div>';
        }
        dropdown.style.display = 'block';
        return;
    }
    
    const sugestoesLimitadas = sugestoes.slice(0, 50);
    
    // üî• BLOQUEAR SELE√á√ÉO AUTOM√ÅTICA SE EST√Å APAGANDO
    if (sugestoesLimitadas.length === 1 && valorAtual.length > 0 && !window.usuarioEstaApagando) {
        const [sigla, nome] = Object.entries(sugestoesLimitadas[0])[0];
        console.log(`‚úÖ [AUTOCOMPLETE] √önica sugest√£o: ${sigla} - ${nome}`);
        selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'autocomplete');
        return;
    }
    
    const html = sugestoesLimitadas.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        
        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}" title="${nome}">
                <strong>${sigla}</strong> 
                <div class="nome-empresa">- ${nome}</div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
    dropdown.style.display = 'block';
    setTimeout(corrigirPosicaoDropdown, 10);

    // COMPORTAMENTO EXCEL: Se h√° poucas sugest√µes, seleciona a primeira automaticamente para navega√ß√£o com setas
    if (sugestoesLimitadas.length > 0) {
        const primeiraOpcao = container.querySelector('.dropdown-option');
        if (primeiraOpcao) {
            primeiraOpcao.classList.add('active');
        }
    }
    
    setTimeout(() => {
        if (dropdown.scrollHeight > 200) {
            dropdown.style.overflowY = 'auto';
            dropdown.style.maxHeight = '200px';
        }
    }, 10);
    
    // Vincular eventos de clique
    container.querySelectorAll('.dropdown-option').forEach(option => {
        // 2. NO CLIQUE MANUAL (dropdown)
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            console.log('üñ±Ô∏è Clique manual na op√ß√£o');
            
            // üî• TIPO: manual (usu√°rio clicou)
            selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
        });
    });
    
    console.log(`üîç [EMPRESA] Exibindo ${sugestoesLimitadas.length} sugest√µes`);
}

/**
 * EXIBIR TODAS AS EMPRESAS
 */
function exibirTodasEmpresas(empresas, container, input, dropdown, obraId) {
    const empresaJaSelecionada = input.dataset.siglaSelecionada;
    
    if (empresaJaSelecionada) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }
    
    if (!empresas || empresas.length === 0) {
        container.innerHTML = `
            <div class="dropdown-no-results">
                üìù Nenhuma empresa cadastrada<br>
                <small>Digite o nome para criar uma nova</small>
            </div>
        `;
        dropdown.style.display = 'block';
        return;
    }
    
    const empresasLimitadas = empresas.slice(0, 50);
    
    const html = empresasLimitadas.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        
        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}" title="${nome}">
                <strong>${sigla}</strong> 
                <div class="nome-empresa">- ${nome}</div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
    dropdown.style.display = 'block';
    setTimeout(corrigirPosicaoDropdown, 10);

    setTimeout(() => {
        if (dropdown.scrollHeight > 200) {
            dropdown.style.overflowY = 'auto';
            dropdown.style.maxHeight = '200px';
        }
    }, 10);
    
    container.querySelectorAll('.dropdown-option').forEach(option => {
        option.addEventListener('click', function() {
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            selecionarEmpresa(sigla, nome, input, dropdown, obraId);
        });
    });
    
    console.log(`üìä [EMPRESA] Exibindo ${empresasLimitadas.length} de ${empresas.length} empresas`);
}

/**
 * NAVEGAR NO DROPDOWN COM TECLADO - COM LOOP (FINAL ‚Üí IN√çCIO)
 */
function navegarDropdown(direcao, container, input, dropdown, obraId) {
    const options = container.querySelectorAll('.dropdown-option');
    if (options.length === 0) return;
    
    const activeOption = container.querySelector('.dropdown-option.active');
    let nextIndex = 0;
    
    if (activeOption) {
        const currentIndex = Array.from(options).indexOf(activeOption);
        
        // üî• COMPORTAMENTO EXCEL COM LOOP
        if (direcao === 'down') {
            // Para baixo: se est√° no √∫ltimo, volta para o primeiro
            nextIndex = currentIndex === options.length - 1 ? 0 : currentIndex + 1;
        } else {
            // Para cima: se est√° no primeiro, vai para o √∫ltimo
            nextIndex = currentIndex === 0 ? options.length - 1 : currentIndex - 1;
        }
        
        console.log(`üîÑ Navega√ß√£o: ${currentIndex} ‚Üí ${nextIndex} (total: ${options.length})`);
    } else {
        // Se n√£o h√° op√ß√£o ativa, come√ßa na primeira (down) ou √∫ltima (up)
        nextIndex = direcao === 'down' ? 0 : options.length - 1;
    }
    
    // Remove active de todas e aplica na nova
    options.forEach(opt => opt.classList.remove('active'));
    options[nextIndex].classList.add('active');
    
    // üî• COMPORTAMENTO EXCEL: Atualiza o input em tempo real durante navega√ß√£o
    const sigla = options[nextIndex].dataset.sigla;
    const nome = options[nextIndex].dataset.nome;
    input.value = `${sigla} - ${nome}`;
    
    // Scroll para a op√ß√£o ativa
    options[nextIndex].scrollIntoView({ 
        block: 'nearest',
        behavior: 'smooth' 
    });
    
    console.log(`üéØ Navegando para: ${sigla} - ${nome} (${nextIndex + 1}/${options.length})`);
}

/**
 * SELECIONAR EMPRESA - COM CONTROLE DE TIPO DE SELE√á√ÉO
 */



function selecionarEmpresa(sigla, nome, input, dropdown, obraId, tipoSelecao = 'manual') {
    console.log('üéØ Selecionando empresa:', sigla, nome, 'Tipo:', tipoSelecao);
    
    // Preenche o input
    input.value = `${sigla} - ${nome}`;
    input.dataset.siglaSelecionada = sigla;
    input.dataset.nomeSelecionado = nome;
    
    // ‚úÖ CORRE√á√ÉO: SALVAR TODOS OS DADOS NOS DATA ATTRIBUTES DA OBRA
    const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (obraElement) {
        // Dados b√°sicos da empresa
        obraElement.dataset.empresaSigla = sigla;
        obraElement.dataset.empresaNome = nome;
        obraElement.dataset.dataCadastro = new Date().toLocaleDateString('pt-BR');
        
        // ‚úÖ BUSCAR E SALVAR OS DEMAIS CAMPOS DO FORMUL√ÅRIO
        const formEmpresa = obraElement.querySelector('.empresa-formulario-ativo');
        if (formEmpresa) {
            // Buscar n√∫mero do cliente
            const numeroClienteInput = formEmpresa.querySelector('.numero-cliente-final-cadastro');
            if (numeroClienteInput?.value) {
                obraElement.dataset.numeroClienteFinal = numeroClienteInput.value;
            }
            
            // Buscar cliente final
            const clienteFinalInput = formEmpresa.querySelector('.cliente-final-cadastro');
            if (clienteFinalInput?.value) {
                obraElement.dataset.clienteFinal = clienteFinalInput.value;
            }
            
            // Buscar c√≥digo do cliente
            const codigoClienteInput = formEmpresa.querySelector('.codigo-cliente-cadastro');
            if (codigoClienteInput?.value) {
                obraElement.dataset.codigoCliente = codigoClienteInput.value;
            }
            
            // Buscar or√ßamentista
            const orcamentistaInput = formEmpresa.querySelector('.orcamentista-responsavel-cadastro');
            if (orcamentistaInput?.value) {
                obraElement.dataset.orcamentistaResponsavel = orcamentistaInput.value;
            }
        }
        
        console.log(`üíæ TODOS os dados salvos na obra ${obraId}:`, {
            empresaSigla: sigla,
            empresaNome: nome,
            numeroClienteFinal: obraElement.dataset.numeroClienteFinal,
            clienteFinal: obraElement.dataset.clienteFinal,
            codigoCliente: obraElement.dataset.codigoCliente,
            orcamentistaResponsavel: obraElement.dataset.orcamentistaResponsavel
        });
    }
    
    // Fecha dropdown
    if (dropdown) {
        dropdown.style.display = 'none';
    }
    
    // Remove foco do input
    setTimeout(() => {
        input.blur();
        
        // üî• MOSTRAR AVISO APENAS SE FOR AUTOCOMPLETE
        mostrarAvisoAutocompletado(input, tipoSelecao);
    }, 10);
    
    // Calcula o n√∫mero do cliente
    calcularNumeroClienteFinal(sigla, obraId);
    
    console.log(`‚úÖ Empresa selecionada e TODOS os dados salvos: ${sigla} - ${nome}`);
}

/**
 * ATUALIZAR EVENTO DE ENTER - CORRIGIDO
 */
// 3. NO ENTER/TAB (navega√ß√£o)
function selecionarOpcaoAtiva(container, input, dropdown, obraId) {
    const activeOption = container.querySelector('.dropdown-option.active');
    if (activeOption) {
        const sigla = activeOption.dataset.sigla;
        const nome = activeOption.dataset.nome;
        console.log('‚å®Ô∏è Sele√ß√£o por teclado');
        
        // üî• TIPO: manual (usu√°rio usou teclado)
        selecionarEmpresa(sigla, nome, input, dropdown, obraId, 'manual');
    }
}

// EXPORTS NO FINAL
export {
    inicializarInputEmpresaHibrido,
    filtrarEmpresas,
    exibirSugestoes,
    exibirTodasEmpresas,
    navegarDropdown,
    selecionarEmpresa,
    selecionarOpcaoAtiva
};
/* ==== FIM: data/adapters/obra-adapter-folder/empresa-autocomplete.js ==== */

/* ==== IN√çCIO: data/builders/empresa-cadastro-inline.js ==== */
/**
 * features/empresa-cadastro-inline.js
 * Sistema de cadastro inline de empresas para P√°gina 1
 * Integra√ß√£o com dados.json (empresas) e backup.json (obras)
 */

import { showSystemStatus } from '../../ui/components/status.js';
import { extractNumberFromText } from '../../data/utils/data-utils.js';

class EmpresaCadastroInline {
    constructor() {
        this.empresas = [];
        this.obrasExistentes = [];
        this.container = null;
        this.isActive = false;
        
        this.init();
    }

    async init() {
        await this.carregarDados();
        this.vincularEventos();
    }

    async carregarDados() {
        try {
            // Carregar empresas do dados.json
            const responseEmpresas = await fetch('/api/dados/empresas');
            if (responseEmpresas.ok) {
                const dados = await responseEmpresas.json();
                this.empresas = dados.empresas || [];
            }

            // Carregar obras existentes do backup.json
            const responseBackup = await fetch('/api/backup-completo');
            if (responseBackup.ok) {
                const backup = await responseBackup.json();
                this.obrasExistentes = backup.obras || [];
            }

            console.log(`üìä Dados carregados: ${this.empresas.length} empresas, ${this.obrasExistentes.length} obras`);
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados:', error);
        }
    }

    vincularEventos() {
        // Encontrar todos os spans de cadastro de empresas e transformar em bot√µes
        const spansCadastro = document.querySelectorAll('.projetc-header-record.very-dark span');
        
        spansCadastro.forEach(span => {
            // Transformar span em bot√£o
            const button = document.createElement('button');
            button.className = 'btn-empresa-cadastro';
            button.textContent = span.textContent;
            button.setAttribute('type', 'button');
            
            // Substituir span por bot√£o
            span.parentNode.replaceChild(button, span);
            
            // Vincular eventos
            button.addEventListener('click', (e) => this.ativarCadastro(e));
            button.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.ativarCadastro(e);
                }
            });
        });
    }

    ativarCadastro(event) {
        if (this.isActive) return;

        const span = event.target;
        this.container = span.closest('.projetc-header-record');
        
        if (!this.container) {
            console.error('‚ùå Container n√£o encontrado');
            return;
        }

        // Ocultar span e mostrar formul√°rio inline
        span.style.display = 'none';
        this.renderizarFormulario();
        this.isActive = true;

        console.log('‚úÖ Cadastro inline ativado');
    }

    renderizarFormulario() {
        const formHTML = this.criarHTMLFormulario();
        this.container.insertAdjacentHTML('beforeend', formHTML);
        
        // Vincular eventos do formul√°rio
        this.vincularEventosFormulario();
        
        // Focar no primeiro campo
        setTimeout(() => {
            const empresaInput = this.container.querySelector('#empresa-input');
            if (empresaInput) empresaInput.focus();
        }, 100);
    }

    criarHTMLFormulario() {
        return `
        <div class="empresa-cadastro-inline" id="empresa-cadastro-inline">
            <div class="empresa-form-grid">
                <!-- Empresa -->
                <div class="form-group">
                    <label for="empresa-input">Empresa *</label>
                    <input type="text" 
                           id="empresa-input" 
                           class="empresa-input" 
                           placeholder="Digite sigla ou nome..."
                           autocomplete="off">
                    <div class="autocomplete-suggestions" id="empresa-suggestions"></div>
                </div>

                <!-- N√∫mero Cliente Final -->
                <div class="form-group">
                    <label for="numero-cliente-final">N√∫mero Cliente Final</label>
                    <input type="text" 
                           id="numero-cliente-final" 
                           class="numero-cliente-final" 
                           readonly
                           placeholder="Ser√° calculado automaticamente">
                </div>

                <!-- Cliente Final -->
                <div class="form-group">
                    <label for="cliente-final">Cliente Final</label>
                    <input type="text" 
                           id="cliente-final" 
                           class="cliente-final" 
                           placeholder="Nome do cliente final">
                </div>

                <!-- C√≥digo Cliente -->
                <div class="form-group">
                    <label for="codigo-cliente">C√≥digo Cliente</label>
                    <input type="text" 
                           id="codigo-cliente" 
                           class="codigo-cliente" 
                           placeholder="C√≥digo interno do cliente">
                </div>

                <!-- Data do Cadastro -->
                <div class="form-group">
                    <label for="data-cadastro">Data do Cadastro</label>
                    <input type="text" 
                           id="data-cadastro" 
                           class="data-cadastro" 
                           readonly
                           value="${new Date().toLocaleString('pt-BR')}">
                </div>

                <!-- Or√ßamentista Respons√°vel -->
                <div class="form-group">
                    <label for="orcamentista-responsavel">Or√ßamentista Respons√°vel</label>
                    <input type="text" 
                           id="orcamentista-responsavel" 
                           class="orcamentista-responsavel" 
                           placeholder="Nome do or√ßamentista">
                </div>
            </div>

            <div class="empresa-form-actions">
                <button type="button" class="btn btn-cancel" onclick="window.empresaCadastro.cancelarCadastro()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-confirm" onclick="window.empresaCadastro.prepararDados()">
                    Confirmar Dados
                </button>
            </div>

            
        </div>
        `;
    }

    vincularEventosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.addEventListener('input', (e) => this.buscarEmpresas(e.target.value));
            empresaInput.addEventListener('blur', () => {
                setTimeout(() => this.ocultarSugestoes(), 200);
            });
            empresaInput.addEventListener('keydown', (e) => this.tratarTecladoAutocomplete(e));
        }
    }

    async buscarEmpresas(termo) {
        if (!termo || termo.length < 2) {
            this.ocultarSugestoes();
            return;
        }

        const termoNormalizado = this.normalizarTermo(termo);
        const sugestoes = this.filtrarEmpresas(termoNormalizado);
        
        this.exibirSugestoes(sugestoes);
    }

    normalizarTermo(termo) {
        return termo.trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    filtrarEmpresas(termo) {
        return this.empresas.filter(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const primeiroNome = nome.split(' ')[0].toUpperCase();
            
            return sigla === termo || 
                   nomeNormalizado.includes(termo) ||
                   primeiroNome.includes(termo);
        });
    }

    exibirSugestoes(sugestoes) {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (!containerSugestoes) return;

        if (sugestoes.length === 0) {
            this.ocultarSugestoes();
            return;
        }

        const html = sugestoes.map(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const primeiroNome = nome.split(' ')[0];

            return `
                <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}">
                    <strong>${sigla}</strong> - ${primeiroNome}
                </div>
            `;
        }).join('');

        containerSugestoes.innerHTML = html;
        containerSugestoes.style.display = 'block';

        // Vincular eventos de clique nas sugest√µes
        containerSugestoes.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                const sigla = item.dataset.sigla;
                const nome = item.dataset.nome;
                this.selecionarEmpresa(sigla, nome);
            });
        });
    }

    ocultarSugestoes() {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (containerSugestoes) {
            containerSugestoes.style.display = 'none';
        }
    }

    tratarTecladoAutocomplete(event) {
        const sugestoes = this.container.querySelectorAll('.suggestion-item');
        if (sugestoes.length === 0) return;

        const sugestaoAtiva = this.container.querySelector('.suggestion-item.active');
        
        switch (event.key) {
            case 'ArrowDown':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, 1);
                break;
            case 'ArrowUp':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, -1);
                break;
            case 'Enter':
                event.preventDefault();
                if (sugestaoAtiva) {
                    const sigla = sugestaoAtiva.dataset.sigla;
                    const nome = sugestaoAtiva.dataset.nome;
                    this.selecionarEmpresa(sigla, nome);
                }
                break;
            case 'Escape':
                this.ocultarSugestoes();
                break;
        }
    }

    navegarSugestoes(sugestoes, atual, direcao) {
        let index = Array.from(sugestoes).indexOf(atual);
        
        if (index === -1) index = direcao > 0 ? -1 : sugestoes.length;
        
        index = (index + direcao + sugestoes.length) % sugestoes.length;
        
        sugestoes.forEach(s => s.classList.remove('active'));
        sugestoes[index].classList.add('active');
    }

    selecionarEmpresa(sigla, nome) {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.value = `${sigla} - ${nome}`;
            empresaInput.dataset.siglaSelecionada = sigla;
            empresaInput.dataset.nomeSelecionado = nome;
        }

        this.ocultarSugestoes();
        this.calcularNumeroClienteFinal(sigla);
    }

    calcularNumeroClienteFinal(sigla) {
        // Filtrar obras existentes pela sigla
        const obrasDaEmpresa = this.obrasExistentes.filter(obra => {
            return obra.empresaSigla === sigla || 
                   (obra.idGerado && obra.idGerado.startsWith(`obra_${sigla}_`));
        });

        // Encontrar maior n√∫mero existente
        let maiorNumero = 0;
        obrasDaEmpresa.forEach(obra => {
            if (obra.numeroClienteFinal && obra.numeroClienteFinal > maiorNumero) {
                maiorNumero = obra.numeroClienteFinal;
            }
            
            // Tamb√©m tentar extrair do ID gerado
            if (obra.idGerado) {
                const match = obra.idGerado.match(new RegExp(`obra_${sigla}_(\\d+)`));
                if (match) {
                    const numero = parseInt(match[1]);
                    if (numero > maiorNumero) maiorNumero = numero;
                }
            }
        });

        const novoNumero = maiorNumero + 1;
        
        const numeroInput = this.container.querySelector('#numero-cliente-final');
        if (numeroInput) {
            numeroInput.value = novoNumero;
        }

        // Atualizar preview do ID da obra
        this.atualizarPreviewIdObra(sigla, novoNumero);
    }

    atualizarPreviewIdObra(sigla, numero) {
        const idObraValue = this.container.querySelector('#obra-id-value');
        
        if (idObraContainer && idObraValue) {
            const idObra = `obra_${sigla}_${numero}`;
            idObraValue.textContent = idObra;
            idObraContainer.style.display = 'block';
        }
    }

    async prepararDados() {
        const dados = this.coletarDadosFormulario();
        
        if (!this.validarDados(dados)) {
            return;
        }

        // Verificar se precisa cadastrar nova empresa
        if (!dados.empresaExistente) {
            const sucesso = await this.cadastrarNovaEmpresa(dados.sigla, dados.nomeEmpresa);
            if (!sucesso) return;
        }

        // Preparar dados para a obra
        this.prepararDadosObra(dados);
        
        showSystemStatus('Dados da empresa preparados! Agora salve a obra.', 'success');
        
        // Ocultar formul√°rio mas manter dados preparados
        this.ocultarFormulario();
    }

    coletarDadosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        const siglaSelecionada = empresaInput?.dataset.siglaSelecionada;
        const nomeSelecionado = empresaInput?.dataset.nomeSelecionado;
        
        return {
            empresaInput: empresaInput?.value || '',
            sigla: siglaSelecionada,
            nomeEmpresa: nomeSelecionado,
            empresaExistente: !!siglaSelecionada,
            numeroClienteFinal: this.container.querySelector('#numero-cliente-final')?.value || '',
            clienteFinal: this.container.querySelector('#cliente-final')?.value || '',
            codigoCliente: this.container.querySelector('#codigo-cliente')?.value || '',
            dataCadastro: this.container.querySelector('#data-cadastro')?.value || '',
            orcamentistaResponsavel: this.container.querySelector('#orcamentista-responsavel')?.value || ''
        };
    }

    validarDados(dados) {
        if (!dados.empresaInput.trim()) {
            showSystemStatus('Por favor, informe a empresa', 'error');
            return false;
        }

        if (!dados.empresaExistente) {
            // Validar formato da sigla para nova empresa
            const siglaMatch = dados.empresaInput.match(/^[A-Za-z]{3}$/);
            if (siglaMatch) {
                // Usu√°rio digitou apenas sigla - solicitar nome completo
                const nomeCompleto = prompt(`Voc√™ digitou apenas a sigla "${dados.empresaInput}". Por favor, informe o nome completo da empresa:`);
                if (!nomeCompleto || !nomeCompleto.trim()) {
                    showSystemStatus('Nome completo da empresa √© obrigat√≥rio', 'error');
                    return false;
                }
                dados.nomeEmpresa = nomeCompleto.trim();
                dados.sigla = dados.empresaInput.toUpperCase();
            } else {
                // Usu√°rio digitou nome - sugerir sigla
                const primeiraPalavra = dados.empresaInput.split(' ')[0];
                const siglaSugerida = primeiraPalavra.substring(0, 3).toUpperCase();
                
                const siglaConfirmada = prompt(`Empresa n√£o encontrada. Sugerimos a sigla "${siglaSugerida}". Confirme ou digite outra sigla de 3 letras:`, siglaSugerida);
                
                if (!siglaConfirmada || siglaConfirmada.length !== 3) {
                    showSystemStatus('Sigla deve ter exatamente 3 letras', 'error');
                    return false;
                }
                
                dados.sigla = siglaConfirmada.toUpperCase();
                dados.nomeEmpresa = dados.empresaInput;
            }
        }

        return true;
    }

    async cadastrarNovaEmpresa(sigla, nome) {
        try {
            // Verificar se sigla j√° existe
            const siglaExistente = this.empresas.find(empresaObj => {
                const [siglaExistente] = Object.keys(empresaObj);
                return siglaExistente === sigla;
            });

            if (siglaExistente) {
                showSystemStatus(`Sigla ${sigla} j√° est√° em uso. Escolha outra sigla.`, 'error');
                return false;
            }

            // Adicionar nova empresa
            const novaEmpresa = { [sigla]: nome };
            this.empresas.push(novaEmpresa);

            // Salvar no dados.json
            const response = await fetch('/api/dados/empresas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(novaEmpresa)
            });

            if (!response.ok) {
                throw new Error('Erro ao salvar empresa');
            }

            showSystemStatus(`Empresa ${sigla} - ${nome} cadastrada com sucesso!`, 'success');
            return true;

        } catch (error) {
            console.error('‚ùå Erro ao cadastrar nova empresa:', error);
            showSystemStatus('Erro ao cadastrar empresa', 'error');
            return false;
        }
    }

    /**
     * Atualiza o header da obra com a sigla e numera√ß√£o
     * @param {HTMLElement} obraElement - Elemento da obra
     * @param {Object} dadosEmpresa - Dados da empresa
     */

    atualizarHeaderObra(obraElement, dadosEmpresa) {
        try {
            const headerSpacer = obraElement.querySelector('.obra-header-spacer');
            if (!headerSpacer) {
                console.error('‚ùå Elemento .obra-header-spacer n√£o encontrado');
                return;
            }

            // Limpar conte√∫do atual
            headerSpacer.innerHTML = '';

            if (dadosEmpresa.empresaSigla && dadosEmpresa.numeroClienteFinal) {
                // üÜï CRIAR SPAN COM IDENTIFICADOR DA EMPRESA (n√£o bot√£o)
                const span = document.createElement('span');
                span.className = 'empresa-identifier-display';
                const textoHeader = `${dadosEmpresa.empresaSigla}-${dadosEmpresa.numeroClienteFinal}`;
                span.textContent = textoHeader;
                span.setAttribute('data-tooltip', this.criarTooltipEmpresa(dadosEmpresa));
                
                // üÜï ADICIONAR SISTEMA DE TOOLTIP VIA JAVASCRIPT
                this.inicializarTooltipJavaScript(span);
                
                headerSpacer.appendChild(span);
                console.log(`‚úÖ Header da obra atualizado para SPAN: ${textoHeader}`);
            } else {
                // Bot√£o padr√£o para cadastro
                this.resetHeaderObra(headerSpacer);
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar header da obra:', error);
        }
    }

    /**
     * üÜï INICIALIZAR TOOLTIP - VERS√ÉO COM AUTO-CLOSE NO MOBILE
     */
    inicializarTooltipJavaScript(element) {
        console.log('üîß Inicializando tooltip RESPONSIVO com auto-close');
        
        // üÜï DETECTAR SE √â MOBILE
        const isMobile = window.innerWidth <= 768;
        
        // üÜï VARI√ÅVEL PARA CONTROLAR O TIMER
        let autoCloseTimer = null;
        
        // FOR√áAR ESTILOS PARA GARANTIR VISIBILIDADE
        element.style.position = 'relative';
        element.style.overflow = 'visible';
        element.style.zIndex = '100';
        
        // Criar tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'empresa-tooltip';
        
        // üÜï ADICIONAR CLASSE PARA MOBILE
        if (isMobile) {
            tooltip.classList.add('empresa-tooltip-mobile');
            
            // üÜï ADICIONAR BOT√ÉO DE FECHAR NO MOBILE
            const closeButton = document.createElement('button');
            closeButton.className = 'empresa-tooltip-close';
            closeButton.innerHTML = '√ó';
            closeButton.setAttribute('aria-label', 'Fechar tooltip');
            tooltip.appendChild(closeButton);
            
            // üÜï EVENTO PARA FECHAR COM BOT√ÉO
            closeButton.addEventListener('click', (e) => {
                e.stopPropagation();
                esconderTooltip();
            });
        }
        
        // üÜï POSICIONAR O TOOLTIP FORA DA HIERARQUIA DO ELEMENTO
        document.body.appendChild(tooltip);
        
        // üÜï FUN√á√ÉO PARA INICIAR TIMER DE AUTO-CLOSE
        const iniciarAutoCloseTimer = () => {
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
            }
            // üÜï FECHAR AUTOMATICAMENTE AP√ìS 5 SEGUNDOS NO MOBILE
            autoCloseTimer = setTimeout(() => {
                console.log('‚è∞ Auto-close do tooltip no mobile');
                esconderTooltip();
            }, 5000); // 5 segundos
        };
        
        // üÜï FUN√á√ÉO PARA CANCELAR TIMER
        const cancelarAutoCloseTimer = () => {
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
                autoCloseTimer = null;
            }
        };
        
        // üÜï FUN√á√ÉO PARA ATUALIZAR POSI√á√ÉO DO TOOLTIP - VERS√ÉO RESPONSIVA
        const atualizarPosicaoTooltip = () => {
            const rect = element.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const isMobileNow = window.innerWidth <= 768;
            
            if (isMobileNow) {
                // üÜï POSICIONAMENTO PARA MOBILE
                tooltip.style.position = 'fixed';
                tooltip.style.left = '50%';
                tooltip.style.top = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                tooltip.style.bottom = 'auto';
                tooltip.style.right = 'auto';
                tooltip.style.width = '90vw';
                tooltip.style.maxWidth = '320px';
                tooltip.style.maxHeight = '70vh';
                tooltip.style.overflowY = 'auto';
                tooltip.style.zIndex = '100000';
            } else {
                // üÜï POSICIONAMENTO PARA DESKTOP
                tooltip.style.position = 'fixed';
                tooltip.style.left = (rect.left + scrollX + (rect.width / 2)) + 'px';
                tooltip.style.bottom = (window.innerHeight - rect.top - scrollY + 8) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.width = 'auto';
                tooltip.style.maxWidth = '380px';
                tooltip.style.maxHeight = 'none';
            }
        };
        
        // üÜï FUN√á√ÉO PARA MOSTRAR TOOLTIP
        const mostrarTooltip = () => {
            console.log('üê≠ Mouse ENTER/TAP no span');
            const tooltipText = element.getAttribute('data-tooltip');
            if (tooltipText) {
                // üÜï ATUALIZAR CONTE√öDO (exceto bot√£o de fechar se existir)
                const closeBtn = tooltip.querySelector('.empresa-tooltip-close');
                tooltip.innerHTML = tooltipText;
                if (closeBtn && isMobile) {
                    tooltip.appendChild(closeBtn);
                }
                
                tooltip.classList.add('show');
                atualizarPosicaoTooltip();
                
                // üÜï INICIAR TIMER DE AUTO-CLOSE NO MOBILE
                if (isMobile) {
                    iniciarAutoCloseTimer();
                }
                
                console.log('üî¶ Tooltip mostrado:', tooltipText);
            }
        };
        
        // üÜï FUN√á√ÉO PARA ESCONDER TOOLTIP
        const esconderTooltip = () => {
            console.log('üê≠ Escondendo tooltip');
            tooltip.classList.remove('show');
            cancelarAutoCloseTimer(); // üÜï CANCELAR TIMER AO ESCONDER
        };
        
        // üÜï EVENT LISTENERS DIFERENCIADOS PARA MOBILE/DESKTOP
        if (isMobile) {
            // üÜï PARA MOBILE: USAR CLICK/TOUCH
            element.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (tooltip.classList.contains('show')) {
                    esconderTooltip();
                } else {
                    mostrarTooltip();
                }
            });
            
            // üÜï FECHAR TOOLTIP AO CLICAR FORA (MOBILE)
            document.addEventListener('click', (e) => {
                if (!element.contains(e.target) && !tooltip.contains(e.target)) {
                    esconderTooltip();
                }
            });
            
            // üÜï FECHAR TOOLTIP AO ROLAR (MOBILE)
            window.addEventListener('scroll', esconderTooltip);
            
            // üÜï FECHAR TOOLTIP AO MUDAR ORIENTA√á√ÉO (MOBILE)
            window.addEventListener('orientationchange', esconderTooltip);
            
        } else {
            // üÜï PARA DESKTOP: USAR HOVER
            element.addEventListener('mouseenter', mostrarTooltip);
            element.addEventListener('mouseleave', esconderTooltip);
        }
        
        // üÜï REINICIAR TIMER SE O USU√ÅRIO INTERAGIR COM O TOOLTIP (MOBILE)
        if (isMobile) {
            tooltip.addEventListener('touchstart', () => {
                cancelarAutoCloseTimer(); // Cancelar timer atual
                iniciarAutoCloseTimer();  // Reiniciar timer
            });
            
            tooltip.addEventListener('click', () => {
                cancelarAutoCloseTimer(); // Cancelar timer atual  
                iniciarAutoCloseTimer();  // Reiniciar timer
            });
        }
        
        // üÜï ATUALIZAR POSI√á√ÉO AO ROLAR/REDIMENSIONAR
        window.addEventListener('scroll', () => {
            if (tooltip.classList.contains('show')) {
                atualizarPosicaoTooltip();
            }
        });
        
        window.addEventListener('resize', () => {
            if (tooltip.classList.contains('show')) {
                atualizarPosicaoTooltip();
            }
            
            // üÜï RECARREGAR COMPORTAMENTO AO REDIMENSIONAR ENTRE MOBILE/DESKTOP
            const novaCondicaoMobile = window.innerWidth <= 768;
            if (isMobile !== novaCondicaoMobile) {
                console.log('üîÑ Mudan√ßa entre mobile/desktop detectada');
                esconderTooltip();
                // Recriar tooltip com novo comportamento
                tooltip.remove();
                this.inicializarTooltipJavaScript(element);
            }
        });
        
        // üÜï LIMPAR EVENT LISTENERS QUANDO ELEMENTO FOR REMOVIDO
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.removedNodes.length > 0) {
                    const removed = Array.from(mutation.removedNodes);
                    if (removed.includes(element) || element.parentNode === null) {
                        tooltip.remove();
                        cancelarAutoCloseTimer();
                        window.removeEventListener('scroll', atualizarPosicaoTooltip);
                        window.removeEventListener('resize', atualizarPosicaoTooltip);
                        document.removeEventListener('click', esconderTooltip);
                        window.removeEventListener('orientationchange', esconderTooltip);
                        observer.disconnect();
                    }
                }
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        
        console.log('‚úÖ Tooltip inicializado (com auto-close) - Mobile:', isMobile);
    }



    /**
     * Cria texto de tooltip com informa√ß√µes completas da empresa
     * @param {Object} dadosEmpresa - Dados da empresa
     * @returns {string} Texto do tooltip
     */
    criarTooltipEmpresa(dadosEmpresa) {
        const partes = [];
        
        if (dadosEmpresa.empresaNome) {
            partes.push(`Empresa: ${dadosEmpresa.empresaNome}`);
        }
        if (dadosEmpresa.clienteFinal) {
            partes.push(`Cliente: ${dadosEmpresa.clienteFinal}`);
        }
        if (dadosEmpresa.codigoCliente) {
            partes.push(`C√≥digo: ${dadosEmpresa.codigoCliente}`);
        }
        if (dadosEmpresa.dataCadastro) {
            // üÜï FORMATAR DATA PARA dd/mm/aaaa
            const dataFormatada = this.formatarDataParaTooltip(dadosEmpresa.dataCadastro);
            partes.push(`Data: ${dataFormatada}`);
        }
        if (dadosEmpresa.orcamentistaResponsavel) {
            partes.push(`Or√ßamentista: ${dadosEmpresa.orcamentistaResponsavel}`);
        }
        
        return partes.join('\n');
    }

    /**
     * Formata data para o formato dd/mm/aaaa no tooltip
     * @param {string} dataString - Data em qualquer formato
     * @returns {string} Data formatada como dd/mm/aaaa
     */
    formatarDataParaTooltip(dataString) {
        if (!dataString) return '';
        
        try {
            // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }
            
            // Tentar converter para Date
            const data = new Date(dataString);
            
            if (isNaN(data.getTime())) {
                console.warn(`‚ö†Ô∏è Data inv√°lida no tooltip: ${dataString}`);
                return dataString;
            }
            
            // Formatar para dd/mm/aaaa
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            
            return `${dia}/${mes}/${ano}`;
            
        } catch (error) {
            console.error(`‚ùå Erro ao formatar data para tooltip ${dataString}:`, error);
            return dataString;
        }
    }

    /**
     * Reseta o header para o estado original
     * @param {HTMLElement} headerSpacer - Elemento do header
     */
    resetHeaderObra(headerSpacer) {
        const button = document.createElement('button');
        button.className = 'btn-empresa-cadastro';
        button.textContent = 'Adicionar campos de cadastro de empresas';
        button.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const obraBlock = headerSpacer.closest('.obra-block');
            if (obraBlock && obraBlock.dataset.obraId) {
                window.ativarCadastroEmpresa(obraBlock.dataset.obraId);
            }
        };
        
        headerSpacer.innerHTML = '';
        headerSpacer.appendChild(button);
    }

    /**
     * Prepara dados da obra e atualiza o header
     * @param {Object} dados - Dados coletados do formul√°rio
     */
    prepararDadosObra(dados) {
        // Armazenar dados no container da obra para uso posterior
        const obraBlock = this.container.closest('.obra-block');
        if (obraBlock) {
            obraBlock.dataset.empresaSigla = dados.sigla;
            obraBlock.dataset.empresaNome = dados.nomeEmpresa;
            obraBlock.dataset.numeroClienteFinal = dados.numeroClienteFinal;
            obraBlock.dataset.clienteFinal = dados.clienteFinal;
            obraBlock.dataset.codigoCliente = dados.codigoCliente;
            
            // üÜï USAR DATA FORMATADA
            const dataFormatada = this.formatarData(dados.dataCadastro);
            obraBlock.dataset.dataCadastro = dataFormatada;
            
            obraBlock.dataset.orcamentistaResponsavel = dados.orcamentistaResponsavel;
            obraBlock.dataset.idGerado = `obra_${dados.sigla}_${dados.numeroClienteFinal}`;
            
            // üÜï ATUALIZAR HEADER DA OBRA
            this.atualizarHeaderObra(obraBlock, {
                empresaSigla: dados.sigla,
                empresaNome: dados.nomeEmpresa,
                numeroClienteFinal: dados.numeroClienteFinal,
                clienteFinal: dados.clienteFinal,
                codigoCliente: dados.codigoCliente,
                dataCadastro: dataFormatada, // üÜï DATA FORMATADA
                orcamentistaResponsavel: dados.orcamentistaResponsavel
            });
            
            console.log('üì¶ Dados da obra preparados:', obraBlock.dataset);
        }
    }

    cancelarCadastro() {
        this.ocultarFormulario();
        this.mostrarSpanOriginal();
        
        // üÜï RESETAR HEADER SE N√ÉO HOUVER DADOS DE EMPRESA
        const obraBlock = this.container.closest('.obra-block');
        if (obraBlock) {
            const headerSpacer = obraBlock.querySelector('.obra-header-spacer span');
            if (headerSpacer && !obraBlock.dataset.empresaSigla) {
                this.resetHeaderObra(headerSpacer);
            }
        }
    }

    ocultarFormulario() {
        const form = this.container.querySelector('#empresa-cadastro-inline');
        if (form) {
            form.remove();
        }
        this.isActive = false;
    }

    mostrarSpanOriginal() {
        const span = this.container.querySelector('span');
        if (span) {
            span.style.display = 'inline';
        }
    }

    // M√©todo para obter dados preparados (usado pelo sistema de salvamento)
    obterDadosPreparados(obraId) {
        const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraBlock) return null;

        return {
            empresaSigla: obraBlock.dataset.empresaSigla,
            empresaNome: obraBlock.dataset.empresaNome,
            numeroClienteFinal: obraBlock.dataset.numeroClienteFinal ? parseInt(obraBlock.dataset.numeroClienteFinal) : null,
            clienteFinal: obraBlock.dataset.clienteFinal,
            codigoCliente: obraBlock.dataset.codigoCliente,
            dataCadastro: obraBlock.dataset.dataCadastro,
            orcamentistaResponsavel: obraBlock.dataset.orcamentistaResponsavel,
            idGerado: obraBlock.dataset.idGerado
        };
    }
    /**
     * Formata data para dd/mm/aaaa
     */
    formatarData(dataString) {
        if (!dataString) return '';
        
        try {
            // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }
            
            const data = new Date(dataString);
            
            if (isNaN(data.getTime())) {
                console.warn(`‚ö†Ô∏è Data inv√°lida: ${dataString}`);
                return dataString;
            }
            
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            
            return `${dia}/${mes}/${ano}`;
            
        } catch (error) {
            console.error(`‚ùå Erro ao formatar data ${dataString}:`, error);
            return dataString;
        }
    }
}

// Exporta√ß√£o e inicializa√ß√£o
export default EmpresaCadastroInline;

if (typeof window !== 'undefined') {
    window.EmpresaCadastroInline = EmpresaCadastroInline;
    
    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        window.empresaCadastro = new EmpresaCadastroInline();
    });
}


/* ==== FIM: data/builders/empresa-cadastro-inline.js ==== */

/* ==== IN√çCIO: data/adapters/obra-adapter-folder/empresa-form-manager.js ==== */
// empresa-form-manager.js
import {formatarData } from './ui-helpers-obra-adapter.js'
import {inicializarInputEmpresaHibrido } from './empresa-autocomplete.js'

/**
 * üÜï ATUALIZA A INTERFACE COM OS DADOS DA EMPRESA
 */
async function atualizarInterfaceComEmpresa(obraElement, obraData) {
    try {
        // Encontrar o container de cadastro de empresas
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (!empresaContainer) {
            console.log(`‚ùå [EMPRESA] Container de empresa n√£o encontrado na obra "${obraData.nome}"`);
            return;
        }
        
        // üÜï ATUALIZAR HEADER DA OBRA COM SPAN (n√£o bot√£o)
        if (window.empresaCadastro && typeof window.empresaCadastro.atualizarHeaderObra === 'function') {
            window.empresaCadastro.atualizarHeaderObra(obraElement, obraData);
        }
        
        console.log(`‚úÖ [EMPRESA] Interface atualizada com SPAN no header`);
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao atualizar interface:`, error);
    }
}

/**
 * üÜï ATUALIZA CAMPOS DO FORMUL√ÅRIO DE EMPRESA EXISTENTE - COM DATA FORMATADA
 */
function atualizarCamposEmpresaForm(obraData, formElement) {
    const camposMapping = {
        'empresaSigla': 'empresa-input',
        'numeroClienteFinal': 'numero-cliente-final',
        'clienteFinal': 'cliente-final',
        'codigoCliente': 'codigo-cliente',
        'dataCadastro': 'data-cadastro',
        'orcamentistaResponsavel': 'orcamentista-responsavel'
    };
    
    Object.entries(camposMapping).forEach(([dataField, inputId]) => {
        const input = formElement.querySelector(`#${inputId}`);
        if (input && obraData[dataField]) {
            // üÜï FORMATAR DATA SE FOR O CAMPO dataCadastro
            if (dataField === 'dataCadastro') {
                input.value = formatarData(obraData[dataField]);
            } else {
                input.value = obraData[dataField];
            }
            
            // Configurar dados adicionais para empresa
            if (dataField === 'empresaSigla' && obraData.empresaNome) {
                input.dataset.siglaSelecionada = obraData.empresaSigla;
                input.dataset.nomeSelecionado = obraData.empresaNome;
            }
        }
    });
    
    // Atualizar preview do ID da obra
    const idObraValue = formElement.querySelector('#obra-id-value');
    if (idObraContainer && idObraValue && obraData.idGerado) {
        idObraValue.textContent = obraData.idGerado;
        idObraContainer.style.display = 'block';
    }
}

/**
 * üÜï CRIA FORMUL√ÅRIO DE EMPRESA COM DADOS EXISTENTES - COM DATA FORMATADA
 */
function criarVisualizacaoEmpresa(obraData, container) {
    // Ocultar bot√£o se existir
    const botao = container.querySelector('.btn-empresa-cadastro');
    if (botao) {
        botao.style.display = 'none';
    }
    
    // üÜï FORMATAR DATA
    const dataFormatada = formatarData(obraData.dataCadastro);
    
    // Criar formul√°rio
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Dados da Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <div class="form-group-horizontal">
                <label>Empresa</label>
                <input type="text" class="empresa-input-readonly" 
                    value="${obraData.empresaSigla || ''} - ${obraData.empresaNome || ''}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" class="numero-cliente-final-readonly" 
                    value="${obraData.numeroClienteFinal || ''}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" class="cliente-final-input" 
                    value="${obraData.clienteFinal || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'clienteFinal', '${obraData.id}')">
            </div>

            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" class="codigo-cliente-input" 
                    value="${obraData.codigoCliente || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'codigoCliente', '${obraData.id}')">
            </div>

            <div class="form-group-horizontal">
                <label>Data</label>
                <input type="text" class="data-cadastro-readonly" 
                    value="${dataFormatada}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" class="orcamentista-responsavel-input" 
                    value="${obraData.orcamentistaResponsavel || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'orcamentistaResponsavel', '${obraData.id}')">
            </div>
        </div>

        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraData.id}')">
                Ocultar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    console.log(`‚úÖ [EMPRESA] Formul√°rio criado para obra ${obraData.id} com data: ${dataFormatada}`);
}

/**
 * üÜï CRIA FORMUL√ÅRIO VAZIO PARA NOVO CADASTRO COM INPUT H√çBRIDO
 */
function criarFormularioVazioEmpresa(obraId, container) {
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Cadastro de Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <div class="form-group-horizontal">
                <label>Empresa *</label>
                <div class="empresa-input-container">
                    <input type="text" 
                           class="empresa-input-cadastro" 
                           id="empresa-input-${obraId}"
                           placeholder="Digite sigla ou nome ou selecione..."
                           autocomplete="off">
                    <div class="empresa-dropdown" id="empresa-dropdown-${obraId}">
                        <div class="dropdown-options" id="empresa-options-${obraId}"></div>
                    </div>
                </div>
            </div>

            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" class="numero-cliente-final-cadastro" readonly
                    placeholder="Ser√° gerado automaticamente">
            </div>

            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" class="cliente-final-cadastro" 
                    placeholder="Nome do cliente final">
            </div>

            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" class="codigo-cliente-cadastro" 
                    placeholder="C√≥digo do cliente">
            </div>

            <div class="form-group-horizontal">
                <label>Data</label>
                <input type="text" class="data-cadastro-cadastro" 
                    value="${new Date().toLocaleDateString('pt-BR')}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" class="orcamentista-responsavel-cadastro" 
                    placeholder="Nome do or√ßamentista">
            </div>
        </div>

        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraId}')">
                Cancelar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    
    // üî• CORRE√á√ÉO: Inicializar com timeout maior para garantir que o DOM est√° pronto
    setTimeout(() => {
        inicializarInputEmpresaHibrido(obraId);
    }, 300);
}

// EXPORTS NO FINAL
export {
    atualizarInterfaceComEmpresa,
    atualizarCamposEmpresaForm,
    criarVisualizacaoEmpresa,
    criarFormularioVazioEmpresa
};
/* ==== FIM: data/adapters/obra-adapter-folder/empresa-form-manager.js ==== */

/* ==== IN√çCIO: data/adapters/obra-adapter-folder/ui-helpers-obra-adapter.js ==== */
// ui-helpers-obra-adapters.js

/**
 * üÜï LIMPAR DADOS DE SELE√á√ÉO
 */
function limparDadosSelecao(input, obraId) {
    delete input.dataset.siglaSelecionada;
    delete input.dataset.nomeSelecionado;
    limparNumeroCliente(obraId);
    console.log('üîÑ Dados de sele√ß√£o limpos');
}

/**
 * üÜï DETECTAR BACKSPACE/DELETE DE FORMA MAIS PRECISA
 */
function criarSistemaBackspaceDetector(input) {
    let pressionandoBackspace = false;
    let timeoutBackspace;
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            pressionandoBackspace = true;
            window.usuarioEstaApagando = true;
            
            // Limpar timeout anterior
            if (timeoutBackspace) clearTimeout(timeoutBackspace);
            
            // Timeout para resetar se parou de apertar
            timeoutBackspace = setTimeout(() => {
                pressionandoBackspace = false;
                window.usuarioEstaApagando = false;
            }, 500);
            
            console.log('‚å´ Tecla de apagar pressionada');
        }
    });
    
    input.addEventListener('keyup', function(e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            // Pequeno delay para garantir que o input foi processado
            setTimeout(() => {
                if (!pressionandoBackspace) {
                    window.usuarioEstaApagando = false;
                }
            }, 50);
        }
    });
    
    // Detectar sele√ß√£o total (Ctrl+A) + Backspace
    input.addEventListener('input', function(e) {
        if (pressionandoBackspace && this.value.length === 0) {
            console.log('üéØ Usu√°rio apagou tudo - reset completo');
            limparDadosSelecao(input, input.closest('[data-obra-id]')?.dataset.obraId);
        }
    });
}

/**
 * üÜï INICIALIZAR DETECTOR DE BACKSPACE SEPARADAMENTE (CORRIGIDO)
 */
function inicializarDetectorBackspace(input, obraId) {
    console.log(`‚å´ [BACKSPACE] Inicializando detector para obra ${obraId}`);
    
    let pressionandoBackspace = false;
    let timeoutBackspace;
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            window.usuarioEstaApagando = true;
            pressionandoBackspace = true;
            
            console.log('‚å´ Tecla de apagar pressionada - bloqueando autocomplete');
            
            // Limpar timeout anterior
            if (timeoutBackspace) clearTimeout(timeoutBackspace);
            
            // Timeout para resetar se parou de apertar
            timeoutBackspace = setTimeout(() => {
                pressionandoBackspace = false;
                window.usuarioEstaApagando = false;
                console.log('üîÑ Resetando flag de apagamento');
            }, 500);
        }
        
        // Salvar valor atual para compara√ß√£o
        window.ultimoValorInput = this.value;
    });
    
    input.addEventListener('keyup', function(e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            // Pequeno delay para garantir que o input foi processado
            setTimeout(() => {
                if (!pressionandoBackspace) {
                    window.usuarioEstaApagando = false;
                    console.log('üîÑ Tecla de apagar liberada');
                }
            }, 50);
        }
    });
    
    // Detectar sele√ß√£o total (Ctrl+A) + Backspace
    input.addEventListener('input', function(e) {
        if (pressionandoBackspace && this.value.length === 0) {
            console.log('üéØ Usu√°rio apagou tudo - reset completo');
            limparDadosSelecao(input, obraId);
        }
    });
}

/**
 * üÜï CORRIGIR POSI√á√ÉO DO DROPDOWN EM DISPOSITIVOS M√ìVEIS
 */
function corrigirPosicaoDropdown() {
    const dropdowns = document.querySelectorAll('.empresa-dropdown');
    
    dropdowns.forEach(dropdown => {
        const input = dropdown.previousElementSibling;
        if (input && input.classList.contains('empresa-input-cadastro')) {
            // üî• GARANTIR QUE O DROPDOWN FIQUE EXATAMENTE ABAIXO DO INPUT
            const rect = input.getBoundingClientRect();
            dropdown.style.width = rect.width + 'px';
            dropdown.style.left = '0';
            dropdown.style.right = 'auto';
        }
    });
}

/**
 * üÜï LIMPAR N√öMERO DO CLIENTE QUANDO EMPRESA FOR REMOVIDA
 */
function limparNumeroCliente(obraId) {
    const numeroInput = document.querySelector(`[data-obra-id="${obraId}"] .numero-cliente-final-cadastro`);
    if (numeroInput) {
        numeroInput.value = '';
        console.log(`üîÑ [EMPRESA] N√∫mero do cliente limpo para obra ${obraId}`);
    }
}

/**
 * üÜï MOSTRAR AVISO DE AUTOCOMPLETE - CSS EXTERNO
 */
function mostrarAvisoAutocompletado(input, tipoSelecao = 'manual') {
    if (tipoSelecao !== 'autocomplete') return;
    
    // Remove avisos anteriores
    document.querySelectorAll('.aviso-autocomplete-relativo').forEach(aviso => aviso.remove());
    
    // Encontrar container
    const container = input.closest('.form-group-horizontal') || 
                     input.closest('.empresa-input-container') || 
                     input.parentNode;
    
    if (!container) return;
    
    // Criar aviso
    const aviso = document.createElement('div');
    aviso.className = 'aviso-autocomplete-relativo';
    aviso.textContent = 'Empresa autocompletada ‚úì';
    
    // Adicionar ao container
    container.appendChild(aviso);
    
    // Anima√ß√£o
    setTimeout(() => aviso.classList.add('show'), 50);
    
    // Remover
    setTimeout(() => {
        aviso.classList.remove('show');
        setTimeout(() => aviso.remove(), 300);
    }, 1200);
}

/**
 * üÜï CALCULAR N√öMERO DO CLIENTE FINAL - CORRIGIDO E MAIS ROBUSTO
 */
async function calcularNumeroClienteFinal(sigla, obraId) {
    try {
        console.log(`üî¢ [EMPRESA] Calculando n√∫mero para: ${sigla}`);
        
        // Tentar a API primeiro
        const response = await fetch(`/api/dados/empresas/numero/${encodeURIComponent(sigla)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const dados = await response.json();
        
        if (dados.success) {
            const novoNumero = dados.numero;
            atualizarNumeroClienteInput(novoNumero, obraId);
            console.log(`‚úÖ [EMPRESA] N√∫mero da API: ${novoNumero} para ${sigla}`);
        } else {
            console.warn('‚ö†Ô∏è [EMPRESA] API retornou erro, usando c√°lculo local:', dados.error);
            calcularNumeroLocal(sigla, obraId);
        }
        
    } catch (error) {
        console.warn('‚ö†Ô∏è [EMPRESA] Erro na API, usando c√°lculo local:', error.message);
        calcularNumeroLocal(sigla, obraId);
    }
}

/**
 * üÜï CALCULAR N√öMERO LOCALMENTE COMO FALLBACK
 */
async function calcularNumeroLocal(sigla, obraId) {
    try {
        // Buscar todas as obras para calcular localmente
        const response = await fetch('/api/backup-completo');
        if (!response.ok) {
            throw new Error('N√£o foi poss√≠vel carregar obras');
        }
        
        const backup = await response.json();
        const obrasExistentes = backup.obras || [];
        
        // Filtrar obras da mesma empresa
        const obrasDaEmpresa = obrasExistentes.filter(obra => 
            obra.empresaSigla === sigla || 
            (obra.idGerado && obra.idGerado.startsWith(`obra_${sigla}_`))
        );
        
        // Encontrar maior n√∫mero
        let maiorNumero = 0;
        obrasDaEmpresa.forEach(obra => {
            if (obra.numeroClienteFinal && obra.numeroClienteFinal > maiorNumero) {
                maiorNumero = obra.numeroClienteFinal;
            }
            
            if (obra.idGerado) {
                const match = obra.idGerado.match(new RegExp(`obra_${sigla}_(\\d+)`));
                if (match) {
                    const numero = parseInt(match[1]);
                    if (numero > maiorNumero) maiorNumero = numero;
                }
            }
        });
        
        const novoNumero = maiorNumero + 1;
        atualizarNumeroClienteInput(novoNumero, obraId);
        console.log(`üî¢ [EMPRESA] N√∫mero local: ${novoNumero} para ${sigla}`);
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro no c√°lculo local:', error);
        // Fallback final: n√∫mero aleat√≥rio
        const numeroFallback = Math.floor(Math.random() * 100) + 1;
        atualizarNumeroClienteInput(numeroFallback, obraId);
        console.log(`üîÑ [EMPRESA] N√∫mero fallback: ${numeroFallback} para ${sigla}`);
    }
}

/**
 * üÜï ATUALIZAR INPUT DO N√öMERO DO CLIENTE
 */
function atualizarNumeroClienteInput(numero, obraId) {
    const numeroInput = document.querySelector(`[data-obra-id="${obraId}"] .numero-cliente-final-cadastro`);
    if (numeroInput) {
        numeroInput.value = numero;
    }
}

/**
 * üÜï FORMATA DATA PARA dd/mm/aaaa
 */
function formatarData(dataString) {
    if (!dataString) return '';
    
    try {
        // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
        if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return dataString;
        }
        
        // Tentar parse como Date
        const data = new Date(dataString);
        
        // Verificar se √© uma data v√°lida
        if (isNaN(data.getTime())) {
            console.warn(`‚ö†Ô∏è [EMPRESA] Data inv√°lida: ${dataString}`);
            return dataString; // Retorna original se n√£o conseguir formatar
        }
        
        // Formatar para dd/mm/aaaa
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        
        return `${dia}/${mes}/${ano}`;
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao formatar data ${dataString}:`, error);
        return dataString; // Retorna original em caso de erro
    }
}

// Event listeners globais
window.addEventListener('resize', corrigirPosicaoDropdown);

// üî• CORRIGIR NO SCROLL (para casos de virtual keyboard)
window.addEventListener('scroll', corrigirPosicaoDropdown);

// üî• INICIALIZAR DETECTOR EM TODOS OS INPUTS EXISTENTES
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const inputs = document.querySelectorAll('.empresa-input-cadastro');
        inputs.forEach(input => {
            criarSistemaBackspaceDetector(input);
        });
    }, 1000);
});

// EXPORTS NO FINAL
export {
    limparDadosSelecao,
    criarSistemaBackspaceDetector,
    inicializarDetectorBackspace,
    corrigirPosicaoDropdown,
    limparNumeroCliente,
    mostrarAvisoAutocompletado,
    calcularNumeroClienteFinal,
    calcularNumeroLocal,
    atualizarNumeroClienteInput,
    formatarData
};
/* ==== FIM: data/adapters/obra-adapter-folder/ui-helpers-obra-adapter.js ==== */
