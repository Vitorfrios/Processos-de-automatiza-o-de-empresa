
/* ==== IN√çCIO: features/calculations/air-flow.js ==== */
/**
 * features/calculations/air-flow.js
 * Sistema unificado de c√°lculos de vaz√£o de ar - FUS√ÉO: airFlowCalculations.js + airFlowDisplay.js
 * C√°lculos de fluxo de ar baseados em pressuriza√ß√£o e portas
 */

import { CALCULATION_CONSTANTS } from '../../core/constants.js';
import {  
    waitForSystemConstants, 
    validateSystemConstants, 
    collectClimatizationInputs,
    findClimatizationSection,
    safeNumber 
} from './calculations-core.js';

// =============================================================================
// C√ÅLCULOS DE FLUXO DE AR
// =============================================================================

/**
 * Calcula fluxo de ar individual por porta
 * @param {number} doorCount - N√∫mero de portas
 * @param {number} doorVariable - Vari√°vel espec√≠fica da porta
 * @param {number} pressure - Pressuriza√ß√£o em Pa
 * @returns {number} Fluxo de ar em m¬≥/h
 */
function calculateDoorFlow(doorCount, doorVariable, pressure) {
    const count = safeNumber(doorCount);
    const variable = safeNumber(doorVariable);
    const press = safeNumber(pressure);

    const pressureExponent = press > 0 ? Math.pow(press, CALCULATION_CONSTANTS.PRESSURE_EXPONENT) : 0;

    return CALCULATION_CONSTANTS.FLOW_COEFFICIENT *
           count *
           variable *
           pressureExponent *
           CALCULATION_CONSTANTS.SECONDS_PER_HOUR;
}

/**
 * Calcula vaz√£o total de ar baseada em portas e pressuriza√ß√£o
 * @param {Object} inputData - Dados de entrada
 * @returns {number} Vaz√£o total em l/s
 */
function computeAirFlowRate(inputData) {
    const numPortasDuplas = safeNumber(inputData.numPortasDuplas);
    const numPortasSimples = safeNumber(inputData.numPortasSimples);
    
    // ‚úÖ CORRE√á√ÉO: Usar pressurizacaoSetpoint em vez de setpointTemp
    const pressure = inputData.pressurizacao ? safeNumber(inputData.pressurizacaoSetpoint) : 0;

    // Valida√ß√£o de constantes
    if (!window.systemConstants?.VARIAVEL_PD.value || !window.systemConstants?.VARIAVEL_PS.value) {
        console.error("Constantes do sistema n√£o dispon√≠veis");
        return 0;
    }

    const doubleDoorFlow = calculateDoorFlow(numPortasDuplas, window.systemConstants.VARIAVEL_PD.value
, pressure);
    const singleDoorFlow = calculateDoorFlow(numPortasSimples, window.systemConstants.VARIAVEL_PS.value
, pressure);

    const totalFlow = doubleDoorFlow + singleDoorFlow;
    const adjustedFlow = totalFlow / CALCULATION_CONSTANTS.FLOW_DIVISOR;
    const finalFlow = adjustedFlow * CALCULATION_CONSTANTS.SAFETY_FACTOR;

    return Math.ceil(finalFlow);
}

// =============================================================================
// ORQUESTRA√á√ÉO DE C√ÅLCULOS
// =============================================================================

/**
 * Executa c√°lculo completo de vaz√£o de ar
 * @param {string} roomId - ID √∫nico da sala
 * @param {boolean} calculateThermal - Calcular ganhos t√©rmicos ap√≥s
 * @returns {Promise<number>} Vaz√£o calculada em l/s
 */
async function calculateVazaoAr(roomId, calculateThermal = true) {
    try {
        if (!roomId) {
            console.error("ID de sala inv√°lido");
            return 0;
        }

        await waitForSystemConstants();

        if (!validateSystemConstants()) {
            console.error("Constantes do sistema inv√°lidas");
            return 0;
        }

        const climaSection = findClimatizationSection(roomId);
        if (!climaSection) {
            console.error(`Se√ß√£o de climatiza√ß√£o n√£o encontrada: ${roomId}`);
            return 0;
        }

        const inputData = collectClimatizationInputs(climaSection, roomId);
        const flowRate = computeAirFlowRate(inputData);

        updateFlowRateDisplay(roomId, flowRate);

        // C√°lculo de ganhos t√©rmicos se solicitado
        if (calculateThermal) {
            const { calculateThermalGains } = await import('./thermal-gains.js');
            await calculateThermalGains(roomId, flowRate);
        }

        return flowRate;

    } catch (error) {
        console.error(`Erro no c√°lculo de vaz√£o para ${roomId}:`, error);
        return 0;
    }
}

/**
 * Coordena c√°lculo sequencial de vaz√£o e ganhos t√©rmicos
 * @param {string} roomId - ID √∫nico da sala
 * @returns {Promise<void>}
 */
async function calculateVazaoArAndThermalGains(roomId) {
    try {
        if (!roomId) {
            console.error("ID de sala inv√°lido");
            return;
        }
        
        const flowRate = await calculateVazaoAr(roomId, false);
        
        const { calculateThermalGains } = await import('./thermal-gains.js');
        await calculateThermalGains(roomId, flowRate);
        
    } catch (error) {
        console.error(`Erro no c√°lculo coordenado para ${roomId}:`, error);
    }
}

// =============================================================================
// ATUALIZA√á√ÉO DE DISPLAY
// =============================================================================

/**
 * Atualiza exibi√ß√£o do resultado de vaz√£o na interface
 * @param {string} roomId - ID da sala
 * @param {number} flowRate - Vaz√£o calculada
 */
function updateFlowRateDisplay(roomId, flowRate) {
    const resultElement = document.getElementById(`vazao-ar-${roomId}`);
    if (resultElement) {
        resultElement.textContent = flowRate;
        console.log(`‚úÖ Vaz√£o atualizada para ${roomId}: ${flowRate} l/s`);
    } else {
        console.error(`Elemento de vaz√£o n√£o encontrado: vazao-ar-${roomId}`);
    }
}

// =============================================================================
// VALIDA√á√ïES E UTILIT√ÅRIOS
// =============================================================================

/**
 * Valida dados de entrada para c√°lculo de vaz√£o
 * @param {Object} inputData - Dados de entrada
 * @returns {boolean} True se dados s√£o v√°lidos
 */
function validateAirFlowInputs(inputData) {
    const required = ['numPortasDuplas', 'numPortasSimples'];
    const missing = required.filter(field => 
        inputData[field] === undefined || inputData[field] === null || inputData[field] === ''
    );
    
    if (missing.length > 0) {
        console.warn(`Campos obrigat√≥rios faltando: ${missing.join(', ')}`);
        return false;
    }
    
    // Valida√ß√µes num√©ricas
    if (safeNumber(inputData.numPortasDuplas) < 0 || safeNumber(inputData.numPortasSimples) < 0) {
        console.warn("Quantidade de portas n√£o pode ser negativa");
        return false;
    }
    
    if (inputData.pressurizacao && safeNumber(inputData.pressurizacaoSetpoint) < 0) {
        console.warn("Pressuriza√ß√£o n√£o pode ser negativa");
        return false;
    }
    
    return true;
}

/**
 * Prepara dados para c√°lculo de vaz√£o
 * @param {Object} rawData - Dados brutos
 * @returns {Object} Dados preparados
 */
function prepareAirFlowData(rawData) {
    const prepared = { ...rawData };
    
    // Converter campos num√©ricos
    const numericFields = ['numPortasDuplas', 'numPortasSimples', 'pressurizacaoSetpoint'];
    numericFields.forEach(field => {
        if (prepared[field] !== undefined) {
            prepared[field] = safeNumber(prepared[field]);
        }
    });
    
    // Garantir valores padr√£o
    if (prepared.numPortasDuplas === undefined) prepared.numPortasDuplas = 0;
    if (prepared.numPortasSimples === undefined) prepared.numPortasSimples = 0;
    if (prepared.pressurizacao === undefined) prepared.pressurizacao = false;
    if (prepared.pressurizacaoSetpoint === undefined) prepared.pressurizacaoSetpoint = 0;
    
    return prepared;
}

/**
 * Obt√©m estat√≠sticas do c√°lculo de vaz√£o
 * @param {Object} inputData - Dados de entrada
 * @param {number} result - Resultado do c√°lculo
 * @returns {Object} Estat√≠sticas
 */
function getAirFlowStats(inputData, result) {
    const numPortasDuplas = safeNumber(inputData.numPortasDuplas);
    const numPortasSimples = safeNumber(inputData.numPortasSimples);
    const pressure = inputData.pressurizacao ? safeNumber(inputData.pressurizacaoSetpoint) : 0;
    
    return {
        totalPortas: numPortasDuplas + numPortasSimples,
        portasDuplas: numPortasDuplas,
        portasSimples: numPortasSimples,
        pressurizacaoAtiva: inputData.pressurizacao,
        pressurizacaoValue: pressure,
        vazaoResultante: result,
    };
}

// =============================================================================
// EXPORTA√á√ïES
// =============================================================================

export {
    // C√°lculos principais
    calculateDoorFlow,
    computeAirFlowRate,
    calculateVazaoAr,
    calculateVazaoArAndThermalGains,
    
    // Display
    updateFlowRateDisplay,
    
    // Valida√ß√µes e utilit√°rios
    validateAirFlowInputs,
    prepareAirFlowData,
    getAirFlowStats
};

// =============================================================================
// DISPONIBILIZA√á√ÉO GLOBAL
// =============================================================================

if (typeof window !== 'undefined') {
    window.airFlowCalculations = {
        calculateVazaoAr,
        calculateVazaoArAndThermalGains,
        updateFlowRateDisplay,
        computeAirFlowRate
    };
}
/* ==== FIM: features/calculations/air-flow.js ==== */

/* ==== IN√çCIO: features/calculations/calculations-core.js ==== */
/**
 * features/calculations/calculations-core.js
 * N√∫cleo de c√°lculos unificado - FUS√ÉO OTIMIZADA: calculos-manager.js + helpers.js
 * Sistema centralizado para c√°lculos de climatiza√ß√£o
 */


import { 
    safeNumber as coreSafeNumber, 
    updateElementText as coreUpdateElementText,
    waitForElement as coreWaitForElement,
    debounce as coreDebounce
} from '../../data/utils/core-utils.js';

import {
    collectClimatizationInputs as dataCollectClimatizationInputs,
    findClimatizationSection as dataFindClimatizationSection
} from '../../data/utils/data-utils.js';

// ‚úÖ RE-EXPORTAR fun√ß√µes de data-utils para compatibilidade
export const collectClimatizationInputs = dataCollectClimatizationInputs;
export const findClimatizationSection = dataFindClimatizationSection;

// ‚úÖ RE-EXPORTAR fun√ß√µes de core-utils para compatibilidade  
export const safeNumber = coreSafeNumber;
export const updateElementText = coreUpdateElementText;


// =============================================================================
// SISTEMA DE DEBOUNCE E PERFORMANCE
// =============================================================================

const calculationTimeouts = new Map();

/**
 * Sistema de debounce para otimizar c√°lculos
 * @param {string} roomId - ID da sala
 * @param {Function} calculationFunction - Fun√ß√£o a executar
 * @param {number} delay - Delay em ms (padr√£o: 300ms)
 */
function debouncedCalculation(roomId, calculationFunction, delay = 300) {
    if (calculationTimeouts.has(roomId)) {
        clearTimeout(calculationTimeouts.get(roomId));
    }
    
    const timeoutId = setTimeout(() => {
        calculationFunction(roomId);
        calculationTimeouts.delete(roomId);
    }, delay);
    
    calculationTimeouts.set(roomId, timeoutId);
}

/**
 * Limpa todos os timeouts de c√°lculo
 */
function clearAllCalculationTimeouts() {
    calculationTimeouts.forEach((timeoutId, roomId) => {
        clearTimeout(timeoutId);
        calculationTimeouts.delete(roomId);
    });
}

// =============================================================================
// SISTEMA DE CONSTANTES
// =============================================================================

/**
 * Aguarda carregamento das constantes do sistema
 */
async function waitForSystemConstants() {
    let attempts = 0;
    const maxAttempts = 100;
    
    while ((!window.systemConstants || !window.systemConstants.VARIAVEL_PD.value
) && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 200));
        attempts++;
    }
    
    if (attempts >= maxAttempts) {
        throw new Error("Constantes do sistema n√£o carregadas");
    }
    
    return true;
}

/**
 * Valida integridade das constantes necess√°rias
 */
function validateSystemConstants() {
    if (!window.systemConstants) {
        console.error("systemConstants n√£o dispon√≠vel");
        return false;
    }
    
    const required = [
        'VARIAVEL_PD', 'VARIAVEL_PS', 'AUX_U_Value_Piso', 'AUX_Fator_Iluminacao',
        'AUX_Fs_Iluminacao', 'AUX_Fator_Conver_Painel', 'AUX_Fs_Paineis',
        'AUX_OCp_Csp', 'AUX_OCp_Clp', 'Densi_ar', 'AUX_c_ArExterno',
        'AUX_deltaT_ArExterno', 'AUX_f_ArExterno', 'AUX_deltaUa_ArExterno',
        'deltaT_piso', 'deltaT_teto', 'deltaT_parede_Oes', 'deltaT_parede_Les',
        'deltaT_parede_Nor', 'deltaT_parede_Sul', 'deltaT_divi_N_clim1',
        'deltaT_divi_N_clim2', 'deltaT_divi_clim1', 'deltaT_divi_clim2'
    ];
    
    const missing = required.filter(constant => 
        window.systemConstants[constant] === undefined || window.systemConstants[constant] === null
    );
    
    if (missing.length > 0) {
        console.error("Constantes faltando:", missing);
        return false;
    }
    
    return true;
}

// =============================================================================
// COLETA E PROCESSAMENTO DE DADOS
// =============================================================================






// =============================================================================
// SISTEMA DE C√ÅLCULOS COORDENADOS
// =============================================================================

/**
 * Executa c√°lculo coordenado de vaz√£o e ganhos t√©rmicos com debounce
 */
async function calculateVazaoArAndThermalGainsDebounced(roomId) {
    debouncedCalculation(roomId, async (id) => {
        try {
            // Importa√ß√£o din√¢mica para evitar depend√™ncia circular
            const { calculateVazaoAr } = await import('./air-flow.js');
            const { calculateThermalGains } = await import('./thermal-gains.js');
            
            const flowRate = await calculateVazaoAr(id, false);
            await calculateThermalGains(id, flowRate);
            
        } catch (error) {
            console.error(`Erro em c√°lculo para ${id}:`, error);
        }
    }, 300);
}

/**
 * Executa c√°lculo imediato (sem debounce)
 */
async function calculateVazaoArAndThermalGainsImmediate(roomId) {
    try {
        const { calculateVazaoAr } = await import('./air-flow.js');
        const { calculateThermalGains } = await import('./thermal-gains.js');
        
        const flowRate = await calculateVazaoAr(roomId, false);
        await calculateThermalGains(roomId, flowRate);
        
    } catch (error) {
        console.error(`Erro em c√°lculo imediato para ${roomId}:`, error);
    }
}

// =============================================================================
// FUN√á√ïES DE COMPATIBILIDADE
// =============================================================================




// =============================================================================
// UTILIT√ÅRIOS DE VALIDA√á√ÉO
// =============================================================================

/**
 * Valida se os dados coletados s√£o suficientes para c√°lculos
 */
function validateCalculationData(inputData) {
    const requiredFields = ['area', 'altura', 'qtdPessoas', 'qtdEquipamentos'];
    const missingFields = requiredFields.filter(field => 
        !inputData[field] || inputData[field] === ''
    );
    
    if (missingFields.length > 0) {
        console.warn(`Campos obrigat√≥rios faltando: ${missingFields.join(', ')}`);
        return false;
    }
    
    return true;
}

/**
 * Prepara dados para c√°lculo (convers√µes e formata√ß√µes)
 */
function prepareCalculationData(rawData) {
    const prepared = { ...rawData };
    
    // Converter n√∫meros
    const numericFields = ['area', 'altura', 'qtdPessoas', 'qtdEquipamentos', 'potenciaIluminacao'];
    numericFields.forEach(field => {
        if (prepared[field]) {
            prepared[field] = coreSafeNumber(prepared[field]);
        }
    });
    
    // Aplicar fatores de seguran√ßa
    if (prepared.fatorSeguranca) {
        const factor = coreSafeNumber(prepared.fatorSeguranca);
        if (factor > 1) {
            prepared.area = prepared.area * factor;
        }
    }
    
    return prepared;
}

// =============================================================================
// EXPORTA√á√ïES
// =============================================================================

export {
    // Sistema de Performance
    debouncedCalculation,
    clearAllCalculationTimeouts,
    
    // Sistema de Constantes
    waitForSystemConstants,
    validateSystemConstants,

    
    // Sistema de C√°lculos
    calculateVazaoArAndThermalGainsDebounced,
    calculateVazaoArAndThermalGainsImmediate,
    
    // Valida√ß√£o e Prepara√ß√£o
    validateCalculationData,
    prepareCalculationData,
    


};

// =============================================================================
// INICIALIZA√á√ÉO E CONFIGURA√á√ÉO
// =============================================================================

// Configura√ß√£o padr√£o do sistema de c√°lculos
const CALCULATION_CONFIG = {
    debounceDelay: 300,
    maxRetryAttempts: 3,
    validationStrict: false,
    enableLogging: window.location.hostname === 'localhost'
};


// Disponibiliza√ß√£o global para compatibilidade
if (typeof window !== 'undefined') {
    window.calculationCore = {
        debouncedCalculation,
        waitForSystemConstants,
        collectClimatizationInputs,

        calculateVazaoArAndThermalGainsDebounced
    };
}

// Limpeza de timeouts ao descarregar a p√°gina
if (typeof window !== 'undefined') {
    window.addEventListener('beforeunload', clearAllCalculationTimeouts);
}
/* ==== FIM: features/calculations/calculations-core.js ==== */

/* ==== IN√çCIO: data/modules/machines/capacity-calculator.js ==== */
// capacityCalculator.js

import { updateElementText } from '../../utils/core-utils.js';

/**
 * Encontra o ID da sala a partir de um elemento dentro dela
 * @param {HTMLElement} element - Elemento dentro da sala
 * @returns {string|null} ID da sala ou null se n√£o encontrado
 */
function findRoomId(element) {
    if (!element) return null;
    
    // Buscar o elemento room-block mais pr√≥ximo
    const roomBlock = element.closest('.room-block');
    if (roomBlock) {
        return roomBlock.dataset.roomId || null;
    }
    
    // Tentar extrair do ID do elemento de conte√∫do
    const roomContent = element.closest('[id^="room-content-"]');
    if (roomContent) {
        const match = roomContent.id.match(/room-content-(.+)/);
        if (match) return match[1];
    }
    
    // Tentar extrair de elementos com data-room-id
    const roomElement = element.closest('[data-room-id]');
    if (roomElement) {
        return roomElement.dataset.roomId;
    }
    
    console.warn('‚ùå N√£o foi poss√≠vel encontrar o ID da sala para o elemento:', element);
    return null;
}

// Configura√ß√µes para inicializa√ß√£o do sistema de capacidade
const capacityConfig = {
  maxInitAttempts: 5, // Aumentado para mais tentativas
  initDelay: 800,
  domCheckDelay: 300
}

// Estado global para controle de inicializa√ß√£o por sala
const capacityState = new Map()

/**
 * Constr√≥i a tabela de c√°lculo de capacidade de refrigera√ß√£o para uma sala
 * @param {string} roomId - ID da sala
 * @returns {string} HTML da tabela de capacidade
 */
function buildCapacityCalculationTable(roomId) {
  console.log(`[CAPACITY] Construindo tabela para: ${roomId}`);
  scheduleCapacityInit(roomId);
  const backupValue = getBackupFromClimaInputs(roomId);

  return `
    <div class="capacity-calculation-table">
      <h5 class="table-title">C√°lculo de Capacidade de Refrigera√ß√£o</h5>
      <div class="table-container">
        <table class="thermal-capacity-table">
          <thead>
            <tr>
              <th>Carga Estimada (TR)</th>
              <th>Fator de Seg.</th>
              <th>Cap. Unit. (TR)</th>
              <th>Solu√ß√£o</th>
              <th>Com back-up</th>
              <th>TOTAL (TR)</th>
              <th>FOLGA (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="carga-estimada-${roomId}">
                <input
                  type="number"
                  class="capacity-input"
                  min="0"
                  step="1"
                  placeholder="Aguardando c√°lculo..."
                  onchange="calculateCapacitySolution('${roomId}')"
                  oninput="calculateCapacitySolution('${roomId}')"
                >
              </td>
              <td>
                <input type="number" id="fator-seguranca-${roomId}" value="10" step="1" 
                      class="capacity-input" 
                      onchange="calculateCapacitySolution('${roomId}')"
                      oninput="calculateCapacitySolution('${roomId}')">
              </td>
              <td>
                <select id="capacidade-unitaria-${roomId}" class="capacity-select" 
                        onchange="calculateCapacitySolution('${roomId}')">
                  ${[1, 2, 3, 4, 5, 7.5, 10, 12.5, 15, 20, 25, 30]
                    .map((tr) => `<option value="${tr}">${tr} TR</option>`)
                    .join("")}
                </select>
              </td>
              <td id="solucao-${roomId}">-</td>
              <td class="backup-cell">
                <div class="backup-selection">
                  <select class="backup-select" onchange="updateBackupConfiguration(this)">
                    ${["n", "n+1", "n+2"]
                      .map((opt) => `<option value="${opt}" ${backupValue === opt ? "selected" : ""}>${opt}</option>`)
                      .join("")}
                  </select>
                </div>
                <div class="backup-solution">
                  <span id="solucao-backup-${roomId}">-</span>
                </div>
              </td>
              <td id="total-capacidade-${roomId}">-</td>
              <td id="folga-${roomId}">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    `;
}

/**
 * Inicializa a tabela de capacidade est√°tica (para casos espec√≠ficos)
 * @returns {void}
 */
function initializeStaticCapacityTable() {
  const staticTable = document.querySelector(".capacity-calculation-table");
  if (staticTable) {
    scheduleCapacityInit("Projeto1-Sala1");
  }
}

/**
 * Agenda a inicializa√ß√£o do sistema de capacidade para uma sala
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function scheduleCapacityInit(roomId) {
  if (capacityState.has(roomId)) return;

  capacityState.set(roomId, { initialized: false, attempts: 0 });
  console.log(`[CAPACITY] Agendando inicializa√ß√£o para: ${roomId}`);
  setTimeout(() => initializeCapacitySystem(roomId), capacityConfig.initDelay);
}

/**
 * Inicializa o sistema de capacidade com tentativas controladas
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function initializeCapacitySystem(roomId) {
  const state = capacityState.get(roomId);
  if (!state || state.initialized) return;

  state.attempts++;

  const systemConstantsReady = window.systemConstants?.FATOR_SEGURANCA_CAPACIDADE.value !== undefined;

  if (systemConstantsReady || state.attempts >= capacityConfig.maxInitAttempts) {
    const fatorSeguranca = systemConstantsReady
      ? window.systemConstants.FATOR_SEGURANCA_CAPACIDADE.value
      : 10;

    applyFatorSeguranca(roomId, fatorSeguranca);

    // CORRE√á√ÉO: Aguarda o DOM estar pronto antes de tentar buscar a carga t√©rmica
    setTimeout(() => {
      const cargaInicial = getThermalLoadTR(roomId);
      const cargaInput = document.querySelector(`#carga-estimada-${roomId} input`);

      if (cargaInicial > 0 && cargaInput) {
        console.log(`[CAPACITY] Definindo carga inicial para ${roomId}: ${cargaInicial} TR`);
        cargaInput.value = Math.round(cargaInicial);
        calculateCapacitySolution(roomId);
      } else {
        console.log(`[CAPACITY] Aguardando c√°lculo t√©rmico para ${roomId}`);
        // Agenda nova tentativa se n√£o houver carga t√©rmica ainda
        if (state.attempts < capacityConfig.maxInitAttempts * 2) {
          setTimeout(() => initializeCapacitySystem(roomId), capacityConfig.domCheckDelay);
        }
      }
    }, 500);

    state.initialized = true;
    console.log(`[CAPACITY] Sistema inicializado para: ${roomId}`);
  } else {
    setTimeout(() => initializeCapacitySystem(roomId), capacityConfig.initDelay);
  }
}

/**
 * Aplica o fator de seguran√ßa ao input correspondente
 * @param {string} roomId - ID da sala
 * @param {number} fatorSeguranca - Valor do fator de seguran√ßa
 * @returns {void}
 */
function applyFatorSeguranca(roomId, fatorSeguranca) {
  const inputFator = document.getElementById(`fator-seguranca-${roomId}`);
  if (!inputFator) return;

  inputFator.value = fatorSeguranca;
}

/**
 * Obt√©m a carga t√©rmica em TR (Tons de Refrigera√ß√£o) para uma sala
 * @param {string} roomId - ID da sala
 * @returns {number} Carga t√©rmica em TR
 */
function getThermalLoadTR(roomId) {
  try {
    console.log(`[CAPACITY] Buscando carga t√©rmica para: ${roomId}`);
    
    // PRIORIDADE 1: Buscar pelo campo TR-aproximado (refer√™ncia principal)
    const totalTRaproxElement = document.getElementById(`total-tr-aprox-${roomId}`);
    if (totalTRaproxElement?.textContent) {
      const trAprox = Number.parseFloat(totalTRaproxElement.textContent);
      if (!isNaN(trAprox) && trAprox > 0) {
        console.log(`[CAPACITY] Usando TR-aproximado: ${trAprox} TR`);
        return trAprox;
      }
    }

    // PRIORIDADE 2: Buscar pelo campo TR-exato
    const totalTRExatoElement = document.getElementById(`total-tr-exato-${roomId}`);
    if (totalTRExatoElement?.textContent) {
      const trExato = Number.parseFloat(totalTRExatoElement.textContent);
      if (!isNaN(trExato) && trExato > 0) {
        console.log(`[CAPACITY] Usando TR-exato: ${trExato} TR`);
        return trExato;
      }
    }

    // PRIORIDADE 3: Calcular a partir dos ganhos em Watts
    const totalGanhosWElement = document.getElementById(`total-ganhos-w-${roomId}`);
    if (totalGanhosWElement?.textContent) {
      const totalW = Number.parseFloat(totalGanhosWElement.textContent) || 0;
      if (totalW > 0) {
        const trCalculado = totalW / 3517;
        console.log(`[CAPACITY] Calculado de Watts: ${totalW}W = ${trCalculado} TR`);
        return trCalculado;
      }
    }

    console.log(`[CAPACITY] Nenhuma carga t√©rmica encontrada para ${roomId}`);
    return 0;
  } catch (error) {
    console.error(`Erro ao obter carga t√©rmica para sala ${roomId}:`, error);
    return 0;
  }
}

/**
 * Calcula a solu√ß√£o de capacidade de refrigera√ß√£o baseada nos par√¢metros
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function calculateCapacitySolution(roomId) {
  try {
    console.log(`[CAPACITY] Calculando solu√ß√£o para: ${roomId}`);
    
    const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`);
    const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`);
    const cargaEstimadaInput = document.querySelector(`#carga-estimada-${roomId} input`);

    if (!fatorSegurancaInput || !capacidadeUnitariaSelect || !cargaEstimadaInput) {
      console.warn(`[CAPACITY] Elementos n√£o encontrados para: ${roomId}`);
      return;
    }

    const rawCarga = cargaEstimadaInput.value.trim();

    // Se usu√°rio n√£o digitou nada ‚Üí s√≥ limpa os resultados
    if (rawCarga === "" || rawCarga === "0") {
      updateElementText(`solucao-${roomId}`, "N/A");
      updateElementText(`solucao-backup-${roomId}`, "N/A");
      updateElementText(`total-capacidade-${roomId}`, "N/A");
      updateElementText(`folga-${roomId}`, "N/A");
      return;
    }

    const cargaEstimada = Number.parseFloat(rawCarga);
    if (isNaN(cargaEstimada) || cargaEstimada <= 0) {
      console.warn(`[CAPACITY] Carga estimada inv√°lida: ${rawCarga}`);
      return;
    }

    const fatorSegurancaRaw = Number.parseFloat(fatorSegurancaInput.value);
    const capacidadeUnitariaRaw = Number.parseFloat(capacidadeUnitariaSelect.value);

    const fatorSeguranca = isNaN(fatorSegurancaRaw) ? 0 : (fatorSegurancaRaw / 100);
    const capacidadeUnitaria = isNaN(capacidadeUnitariaRaw) ? 1 : capacidadeUnitariaRaw;

    const backupType = getBackupFromClimatization(roomId);

    const capacidadeNecessaria = cargaEstimada * (1 + fatorSeguranca);
    const unidadesOperacionais = Math.ceil(capacidadeNecessaria / capacidadeUnitaria);
    const unidadesTotais = applyBackupConfiguration(unidadesOperacionais, backupType);

    const total = unidadesOperacionais * capacidadeUnitaria;
    const folga = cargaEstimada > 0 ? ((total / cargaEstimada) - 1) * 100 : 0;

    updateCapacityDisplay(roomId, cargaEstimada, unidadesOperacionais, unidadesTotais, total, folga, backupType);
    
    console.log(`[CAPACITY] Solu√ß√£o calculada para ${roomId}:`, {
      cargaEstimada,
      fatorSeguranca: `${fatorSeguranca * 100}%`,
      capacidadeUnitaria,
      unidadesOperacionais,
      backupType,
      unidadesTotais,
      total: `${total.toFixed(1)} TR`,
      folga: `${folga.toFixed(1)}%`
    });
  } catch (error) {
    console.error(`Erro ao calcular capacidade para sala ${roomId}:`, error);
  }
}

/**
 * Obt√©m os dados atuais de capacidade de uma sala
 * @param {string} roomId - ID da sala
 * @returns {Object|null} Dados de capacidade ou null se n√£o encontrado
 */
function getCapacityData(roomId) {
  const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`);
  const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`);
  const backupSelect = document.querySelector(`#room-content-${roomId} .backup-select`);

  if (!fatorSegurancaInput || !capacidadeUnitariaSelect || !backupSelect) return null;

  return {
    fatorSeguranca: Number.parseFloat(fatorSegurancaInput.value) || 10,
    capacidadeUnitaria: Number.parseFloat(capacidadeUnitariaSelect.value) || 1,
    backup: backupSelect.value || "n",
    cargaEstimada: getThermalLoadTR(roomId),
    solucao: document.getElementById(`solucao-${roomId}`)?.textContent || "0",
    solucaoBackup: document.getElementById(`solucao-backup-${roomId}`)?.textContent || "0",
    totalCapacidade: document.getElementById(`total-capacidade-${roomId}`)?.textContent || "0",
    folga: document.getElementById(`folga-${roomId}`)?.textContent || "0%"
  };
}

/**
 * Aplica a configura√ß√£o de backup ao n√∫mero de unidades
 * @param {number} unidadesOperacionais - N√∫mero de unidades operacionais
 * @param {string} backupType - Tipo de backup ("n", "n+1", "n+2")
 * @returns {number} N√∫mero total de unidades considerando backup
 */
function applyBackupConfiguration(unidadesOperacionais, backupType) {
  switch (backupType) {
    case "n+1":
      return unidadesOperacionais + 1;
    case "n+2":
      return unidadesOperacionais + 2;
    default:
      return unidadesOperacionais;
  }
}

/**
 * Obt√©m o tipo de backup configurado para climatiza√ß√£o da sala
 * @param {string} roomId - ID da sala
 * @returns {string} Tipo de backup ("n", "n+1", "n+2")
 */
function getBackupFromClimatization(roomId) {
  const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);
  if (capacityTable) {
    const backupSelect = capacityTable.querySelector(".backup-select");
    if (backupSelect) return backupSelect.value;
  }

  return getBackupFromClimaInputs(roomId);
}

/**
 * Obt√©m o backup dos inputs de clima da sala
 * @param {string} roomId - ID da sala
 * @returns {string} Tipo de backup ("n", "n+1", "n+2")
 */
function getBackupFromClimaInputs(roomId) {
  const roomContent = document.getElementById(`room-content-${roomId}`);
  if (roomContent) {
    const backupInput = roomContent.querySelector(`.clima-input[data-field="backup"]`);
    if (backupInput?.value) return backupInput.value;
  }
  return "n";
}

/**
 * Atualiza a exibi√ß√£o dos resultados de capacidade na tabela
 * @param {string} roomId - ID da sala
 * @param {number} cargaEstimada - Carga t√©rmica estimada em TR
 * @param {number} solucao - N√∫mero de unidades da solu√ß√£o
 * @param {number} solucaoComBackup - N√∫mero de unidades com backup
 * @param {number} total - Capacidade total em TR
 * @param {number} folga - Percentual de folga
 * @param {string} backupType - Tipo de backup
 * @returns {void}
 */
function updateCapacityDisplay(roomId, cargaEstimada, solucao, solucaoComBackup, total, folga, backupType) {
  updateElementText(`solucao-${roomId}`, String(solucao));
  updateElementText(`solucao-backup-${roomId}`, String(solucaoComBackup));

  if (typeof total === "number" && !Number.isNaN(total)) {
    updateElementText(`total-capacidade-${roomId}`, total.toFixed(1));
  }

  if (typeof folga === "number" && !Number.isNaN(folga)) {
    updateElementText(`folga-${roomId}`, folga.toFixed(1) + "%");
  }

  const backupSelect = document.querySelector(`#room-content-${roomId} .backup-select`);
  if (backupSelect && backupSelect.value !== backupType) {
    backupSelect.value = backupType;
  }
}

/**
 * Atualiza ou cria o input para carga estimada (apenas inteiros)
 * @param {string} roomId - ID da sala
 * @param {number} value - Valor a ser definido (inteiro)
 * @returns {void}
 */
function updateCargaEstimadaInput(roomId, value) {
  const cargaEstimadaElement = document.getElementById(`carga-estimada-${roomId}`);
  if (!cargaEstimadaElement) return;

  let input = cargaEstimadaElement.querySelector("input");
  if (!input) {
    input = document.createElement("input");
    input.type = "number";
    input.className = "capacity-input";
    input.min = "0";
    input.step = "1";
    input.onchange = () => calculateCapacitySolution(roomId);
    input.oninput = () => calculateCapacitySolution(roomId);
    input.value = Math.round(value);

    cargaEstimadaElement.innerHTML = "";
    cargaEstimadaElement.appendChild(input);
  } else {
    input.value = Math.round(value);
  }
}

/**
 * Atualiza a configura√ß√£o de backup quando alterada pelo usu√°rio
 * @param {HTMLSelectElement} selectElement - Elemento select do backup
 * @returns {void}
 */
function updateBackupConfiguration(selectElement) {
  const roomId = findRoomId(selectElement.closest(".capacity-calculation-table"));
  if (roomId) {
    const newBackupValue = selectElement.value;
    syncBackupWithClimaInputs(roomId, newBackupValue);
    calculateCapacitySolution(roomId);
  }
}

/**
 * Manipula mudan√ßas no backup provenientes dos inputs de clima
 * @param {string} roomId - ID da sala
 * @param {string} newBackupValue - Novo valor de backup
 * @returns {void}
 */
function handleClimaInputBackupChange(roomId, newBackupValue) {
  const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);

  if (capacityTable) {
    const backupSelect = capacityTable.querySelector(".backup-select");
    if (backupSelect && backupSelect.value !== newBackupValue) {
      backupSelect.value = newBackupValue;
      calculateCapacitySolution(roomId);
    }
  }
}

/**
 * Sincroniza o backup com os inputs de clima da sala
 * @param {string} roomId - ID da sala
 * @param {string} backupValue - Valor de backup a ser sincronizado
 * @returns {void}
 */
function syncBackupWithClimaInputs(roomId, backupValue) {
    const roomContent = document.getElementById(`room-content-${roomId}`);
    if (roomContent) {
        const backupInputs = roomContent.querySelectorAll(`.clima-input[data-field="backup"]`);

        backupInputs.forEach((input) => {
            if (input.value !== backupValue) {
                // Remove temporariamente o onchange para evitar loop
                const originalOnChange = input.onchange;
                input.onchange = null;
                
                input.value = backupValue;
                
                // Restaura o onchange ap√≥s um breve delay
                setTimeout(() => {
                    input.onchange = originalOnChange;
                }, 100);
            }
        });
    }
}

/**
 * Sincroniza o backup da tabela de capacidade com os valores atuais
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function syncCapacityTableBackup(roomId) {
  setTimeout(() => {
    const backupFromInputs = getBackupFromClimaInputs(roomId);
    const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);

    if (capacityTable) {
      const backupSelect = capacityTable.querySelector(".backup-select");
      if (backupSelect && backupSelect.value !== backupFromInputs) {
        backupSelect.value = backupFromInputs;
        calculateCapacitySolution(roomId);
      }
    }
  }, 500);
}

/**
 * üîÑ Fun√ß√£o global para ser chamada diretamente do HTML - EVITA LOOP
 * @param {string} roomId - ID da sala
 * @param {string} newValue - Novo valor do backup
 * @returns {void}
 */
function handleClimaBackupChange(roomId, newValue) {
    console.log(`üîÑ Backup alterado no form: ${newValue} (sala: ${roomId})`);
    
    // Atualiza o backup-select SEM disparar eventos de volta
    const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);
    if (capacityTable) {
        const backupSelect = capacityTable.querySelector(".backup-select");
        if (backupSelect && backupSelect.value !== newValue) {
            backupSelect.value = newValue;
            calculateCapacitySolution(roomId);
        }
    }
    
    // Mant√©m o c√°lculo t√©rmico original
    if (typeof window.calculateVazaoArAndThermalGains === 'function') {
        window.calculateVazaoArAndThermalGains(roomId);
    }
}

/**
 * üîÑ WRAPPER: Para ser chamada diretamente do onchange do HTML
 * @param {HTMLSelectElement} selectElement - Elemento select do form
 * @returns {void}
 */
function handleClimaInputBackupChangeFromEvent(selectElement) {
    const roomId = findRoomId(selectElement);
    if (!roomId) {
        console.warn('‚ùå N√£o foi poss√≠vel encontrar roomId para handleClimaInputBackupChangeFromEvent');
        return;
    }
    
    const newBackupValue = selectElement.value;
    console.log(`üîÑ Backup alterado no form: ${newBackupValue} (sala: ${roomId})`);
    
    // Usa a fun√ß√£o existente que j√° faz todo o trabalho
    handleClimaInputBackupChange(roomId, newBackupValue);
    
    // Tamb√©m dispara o c√°lculo t√©rmico (mant√©m funcionalidade original)
    if (typeof window.calculateVazaoArAndThermalGains === 'function') {
        window.calculateVazaoArAndThermalGains(roomId);
    }
}

/**
 * NOVA FUN√á√ÉO: Atualiza capacidade a partir dos ganhos t√©rmicos
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function updateCapacityFromThermalGains(roomId) {
  console.log(`[CAPACITY] Atualizando capacidade a partir de ganhos t√©rmicos para ${roomId}`);
  
  const cargaEstimada = getThermalLoadTR(roomId);
  if (cargaEstimada > 0) {
    updateCargaEstimadaInput(roomId, cargaEstimada);
    calculateCapacitySolution(roomId);
    return true;
  }
  return false;
}

// üîÑ Torna as fun√ß√µes globais para serem acess√≠veis do HTML
if (typeof window !== 'undefined') {
  window.handleClimaBackupChange = handleClimaBackupChange;
  window.handleClimaInputBackupChangeFromEvent = handleClimaInputBackupChangeFromEvent;
  window.updateBackupConfiguration = updateBackupConfiguration;
  window.calculateCapacitySolution = calculateCapacitySolution;
  window.updateCapacityFromThermalGains = updateCapacityFromThermalGains;
}

// Exporta√ß√£o das fun√ß√µes do m√≥dulo
export {
  buildCapacityCalculationTable,
  calculateCapacitySolution,
  getCapacityData,
  updateBackupConfiguration,
  handleClimaInputBackupChange,
  syncCapacityTableBackup,
  initializeStaticCapacityTable,
  handleClimaInputBackupChangeFromEvent,
  updateCapacityFromThermalGains,
  getThermalLoadTR
};
/* ==== FIM: data/modules/machines/capacity-calculator.js ==== */

/* ==== IN√çCIO: data/modules/climatizate/climatizacao-sync.js ==== */
// data/modules/climatizacao/climatizacao-sync.js
// VERS√ÉO COMPLETA COM TODAS AS EXPORTA√á√ïES

import { calculateVazaoArAndThermalGains } from '../../../features/calculations/air-flow.js';
import { triggerCalculation } from '../../../core/shared-utils.js';

// ‚ùå REMOVER a fun√ß√£o local
// function triggerCalculation(roomId) { ... }
// =============================================================================
// SINCRONIZA√á√ÉO GLOBAL - FUN√á√ïES COMPLETAS
// =============================================================================

// ‚úÖ CORRE√á√ÉO: Exporta√ß√µes corretas
let handleWallInputSync;
let syncTitleToAmbiente;
let syncAmbienteToTitle;
let setupCompleteRoomSync;

if (typeof window !== 'undefined') {
    // ============================================
    // üîÑ SINCRONIZA√á√ÉO APENAS NA PRIMEIRA INTERA√á√ÉO PAREDES
    // ============================================
    // ‚úÖ CORRE√á√ÉO DA FUN√á√ÉO DE SINCRONIZA√á√ÉO DE PAREDES (ATUALIZADA)
    window.handleWallInputSyncFirstInteraction = function (roomId, field, value) {
        console.log(`üîÑ [PRIMEIRA-INTERA√á√ÉO] Sincroniza√ß√£o de parede: ${field} = ${value}`);

        const numValue = parseFloat(value);
        if (isNaN(numValue)) return;

        // Buscar refer√™ncias dos inputs
        const paredeOeste = document.querySelector(`input[data-field="paredeOeste"][data-room-id="${roomId}"]`);
        const paredeLeste = document.querySelector(`input[data-field="paredeLeste"][data-room-id="${roomId}"]`);
        const paredeNorte = document.querySelector(`input[data-field="paredeNorte"][data-room-id="${roomId}"]`);
        const paredeSul = document.querySelector(`input[data-field="paredeSul"][data-room-id="${roomId}"]`);

        // Verificar se estamos em primeira intera√ß√£o (com base nos atributos data)
        const isFirstInteraction = () => {
            const input = document.querySelector(`input[data-field="${field}"][data-room-id="${roomId}"]`);
            return input && input.getAttribute('data-first-interaction') === 'true';
        };

        // Sincronizar paredes leste/oeste apenas na primeira intera√ß√£o
        if (field === 'paredeOeste' || field === 'paredeLeste') {
            const otherField = field === 'paredeOeste' ? 'paredeLeste' : 'paredeOeste';
            const otherInput = field === 'paredeOeste' ? paredeLeste : paredeOeste;

            if (otherInput && isFirstInteraction()) {
                const isPlaceholder = otherInput.value === '' || otherInput.value === 'Ex: 5.5' || otherInput.value === 'Ex: 8.0';
                const isCurrentlyEditing = document.activeElement === document.querySelector(`input[data-field="${field}"][data-room-id="${roomId}"]`);

                if (isPlaceholder || isCurrentlyEditing) {
                    otherInput.value = numValue;
                    console.log(`‚úÖ [PRIMEIRA-INTERA√á√ÉO] ${field} ‚Üí ${otherField}: ${numValue} (durante edi√ß√£o)`);
                    triggerCalculation(roomId);
                }
            }
        }

        // Sincronizar paredes norte/sul apenas na primeira intera√ß√£o
        if (field === 'paredeNorte' || field === 'paredeSul') {
            const otherField = field === 'paredeNorte' ? 'paredeSul' : 'paredeNorte';
            const otherInput = field === 'paredeNorte' ? paredeSul : paredeNorte;

            if (otherInput && isFirstInteraction()) {
                const isPlaceholder = otherInput.value === '' || otherInput.value === 'Ex: 8.0' || otherInput.value === 'Ex: 5.5';
                const isCurrentlyEditing = document.activeElement === document.querySelector(`input[data-field="${field}"][data-room-id="${roomId}"]`);

                if (isPlaceholder || isCurrentlyEditing) {
                    otherInput.value = numValue;
                    console.log(`‚úÖ [PRIMEIRA-INTERA√á√ÉO] ${field} ‚Üí ${otherField}: ${numValue} (durante edi√ß√£o)`);
                    triggerCalculation(roomId);
                }
            }
        }
    };


    // Usar sincroniza√ß√£o apenas na primeira intera√ß√£o
    window.handleWallInputSync = window.handleWallInputSyncFirstInteraction;
    console.log('üéØ L√ìGICA ATIVA: Sincroniza√ß√£o APENAS NA PRIMEIRA INTERA√á√ÉO');

    // ============================================
    // SINCRONIZA√á√ÉO T√çTULO ‚Üî AMBIENTE
    // ============================================

    // Fun√ß√£o de sincroniza√ß√£o t√≠tulo‚Üíambiente
    window.syncTitleToAmbiente = function (roomId, newTitle) {
        console.log(`üîÑ T√≠tulo ‚Üí Ambiente: "${newTitle}" para sala ${roomId}`);
        const ambienteInput = document.querySelector(`input[data-field="ambiente"][data-room-id="${roomId}"]`);
        if (ambienteInput && ambienteInput.value !== newTitle) {
            ambienteInput.value = newTitle;
            console.log(`‚úÖ T√≠tulo ‚Üí Ambiente: "${newTitle}"`);
            triggerCalculation(roomId);
        }
    };

    // Fun√ß√£o de sincroniza√ß√£o ambiente‚Üít√≠tulo
    window.syncAmbienteToTitle = function (roomId, newAmbiente) {
        const roomTitle = document.querySelector(`[data-room-id="${roomId}"] .room-title`);
        if (roomTitle && roomTitle.textContent !== newAmbiente) {
            roomTitle.textContent = newAmbiente;
            const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
            if (roomBlock) {
                roomBlock.dataset.roomName = newAmbiente;
            }
            console.log(`‚úÖ Ambiente ‚Üí T√≠tulo: "${newAmbiente}"`);
        }
    };

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o setupCompleteRoomSync adicionada de volta
    window.setupCompleteRoomSync = function (roomId) {
        console.log(`üéØ CONFIGURANDO SINCRONIZA√á√ÉO COMPLETA PARA SALA: ${roomId}`);

        // Configurar paredes
        setupWallEventListenersDirect(roomId);

        // Configurar t√≠tulo‚Üîambiente
        setupTitleAmbienteSyncDirect(roomId);

        console.log(`‚úÖ SINCRONIZA√á√ÉO COMPLETA CONFIGURADA PARA: ${roomId}`);
    };

    // ‚úÖ FUN√á√ÉO AUXILIAR PARA CONFIGURAR PAREDES
    function setupWallEventListenersDirect(roomId) {
        console.log(`üß± CONFIGURANDO EVENT LISTENERS PARA PAREDES COM PRIMEIRA INTERA√á√ÉO: ${roomId}`);

        const setupWallInput = (field, placeholder) => {
            const input = document.querySelector(`input[data-field="${field}"][data-room-id="${roomId}"]`);
            if (input) {
                // Marcar como primeira intera√ß√£o n√£o conclu√≠da
                input.setAttribute('data-first-interaction', 'true');

                input.addEventListener('focus', function () {
                    this.setAttribute('data-editing', 'true');
                    console.log(`üéØ Foco em ${field} - primeira intera√ß√£o ativa`);
                });

                input.addEventListener('input', function () {
                    const isEditing = this.getAttribute('data-editing') === 'true';
                    const isFirstInteraction = this.getAttribute('data-first-interaction') === 'true';

                    if (this.value && this.value !== placeholder && isEditing && isFirstInteraction) {
                        window.handleWallInputSync(roomId, field, this.value);
                    }
                });

                input.addEventListener('blur', function () {
                    this.removeAttribute('data-editing');
                    this.setAttribute('data-first-interaction', 'false');
                    console.log(`‚úÖ ${field} - primeira intera√ß√£o conclu√≠da, agora independente`);
                });

                return true;
            }
            return false;
        };

        const walls = [
            { field: 'paredeOeste', placeholder: 'Ex: 5.5' },
            { field: 'paredeLeste', placeholder: 'Ex: 5.5' },
            { field: 'paredeNorte', placeholder: 'Ex: 8.0' },
            { field: 'paredeSul', placeholder: 'Ex: 8.0' }
        ];

        walls.forEach(wall => {
            if (setupWallInput(wall.field, wall.placeholder)) {
                console.log(`‚úÖ Listener configurado para ${wall.field} (primeira intera√ß√£o)`);
            }
        });
    }

    // ‚úÖ FUN√á√ÉO AUXILIAR PARA CONFIGURAR T√çTULO‚ÜîAMBIENTE
    function setupTitleAmbienteSyncDirect(roomId) {
        const roomTitle = document.querySelector(`[data-room-id="${roomId}"] .room-title`);
        const ambienteInput = document.querySelector(`input[data-field="ambiente"][data-room-id="${roomId}"]`);

        if (roomTitle && ambienteInput) {
            // Sincroniza√ß√£o Ambiente ‚Üí T√≠tulo
            ambienteInput.addEventListener('input', function () {
                if (this.value && this.value.trim() !== '' && this.value !== roomTitle.textContent) {
                    roomTitle.textContent = this.value;
                    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
                    if (roomBlock) {
                        roomBlock.dataset.roomName = this.value;
                    }
                    console.log(`üîÑ Ambiente ‚Üí T√≠tulo: "${this.value}"`);
                    triggerCalculation(roomId);
                }
            });

            // Sincroniza√ß√£o inicial
            if (!ambienteInput.value || ambienteInput.value.trim() === '') {
                ambienteInput.value = roomTitle.textContent;
                console.log(`‚úÖ Sincroniza√ß√£o inicial: T√≠tulo ‚Üí Ambiente: "${roomTitle.textContent}"`);
            }
        }
    }



    // Atribuir √†s vari√°veis de exporta√ß√£o
    handleWallInputSync = window.handleWallInputSync;
    syncTitleToAmbiente = window.syncTitleToAmbiente;
    syncAmbienteToTitle = window.syncAmbienteToTitle;
    setupCompleteRoomSync = window.setupCompleteRoomSync;
}

// =============================================================================
// EXPORTA√á√ïES COMPLETAS
// =============================================================================

export {
    handleWallInputSync,
    syncTitleToAmbiente,
    syncAmbienteToTitle,
    setupCompleteRoomSync
};
/* ==== FIM: data/modules/climatizate/climatizacao-sync.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/data-fillers.js ==== */
/**
 * data/modules/climatizacao/data-fill.js
 * ARQUIVO DE PREENCHER AS SALAS - VERS√ÉO CORRIGIDA
 */

import { calculateVazaoArAndThermalGains } from '../../../features/calculations/air-flow.js';
import { triggerCalculation } from '../../../core/shared-utils.js';

/**
 * Preenche os campos de climatiza√ß√£o
 */
/**
 * Preenche os campos de climatiza√ß√£o
 */
function fillClimatizationInputs(roomElement, inputsData) {
    if (!roomElement || !inputsData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    // Preencher ambiente com nome da sala se estiver vazio
    const ambienteInput = roomElement.querySelector(`input[data-field="ambiente"]`);
    if (ambienteInput && (!inputsData.ambiente || inputsData.ambiente === '') && roomName) {
        inputsData.ambiente = roomName;
    }
    
    // Processar pressuriza√ß√£o
    if (inputsData.pressurizacao !== undefined) {
        const isPressurizacaoAtiva = typeof inputsData.pressurizacao === 'boolean' 
            ? inputsData.pressurizacao 
            : inputsData.pressurizacao === 'true' || inputsData.pressurizacao === true || inputsData.pressurizacao === 1;
        
        const pressurizacaoValue = isPressurizacaoAtiva ? 'sim' : 'nao';
        
        const pressurizacaoRadios = roomElement.querySelectorAll(`input[type="radio"][name*="pressurizacao"]`);
        
        let radioToCheck = null;
        pressurizacaoRadios.forEach(radio => {
            if (radio.value === pressurizacaoValue) {
                radioToCheck = radio;
            }
        });

        if (radioToCheck) {
            pressurizacaoRadios.forEach(radio => {
                radio.checked = false;
            });
            
            radioToCheck.checked = true;
            
            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                radioToCheck.dispatchEvent(event);
            }, 100);
        }
    }

    // Preencher outros inputs ap√≥s delay
    setTimeout(() => {
        const textInputs = roomElement.querySelectorAll('.clima-input[type="text"], .clima-input[type="number"], .clima-input[data-field]');
        
        textInputs.forEach(input => {
            const field = input.getAttribute('data-field');
            if (!field || inputsData[field] === undefined) return;

            // Apenas pula pressurizacaoSetpoint se a pressuriza√ß√£o n√£o estiver ativa
            if (field === 'pressurizacaoSetpoint') {
                // Verificar se a pressuriza√ß√£o est√° ativa
                const pressurizacaoValue = inputsData.pressurizacao;
                const isPressurizacaoAtiva = typeof pressurizacaoValue === 'boolean' 
                    ? pressurizacaoValue 
                    : pressurizacaoValue === 'true' || pressurizacaoValue === true || pressurizacaoValue === 1;
                
                if (!isPressurizacaoAtiva) {
                    return; // N√£o preencher setpoint se pressuriza√ß√£o n√£o estiver ativa
                }
            }
            
            let value = inputsData[field];
            
            if (input.type === 'number') {
                if (value === false || value === 'false' || value === null || value === '') {
                    value = 0;
                }
                if (value === true || value === 'true') {
                    value = 1;
                }
                
                const numericValue = parseFloat(value);
                value = isNaN(numericValue) ? 0 : numericValue;
            }
            
            input.value = value;

            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }, 50);
        });

        // Preencher selects
        const selectInputs = roomElement.querySelectorAll('select.clima-input[data-field]');
        selectInputs.forEach(select => {
            const field = select.getAttribute('data-field');
            if (!field || inputsData[field] === undefined) return;

            const value = inputsData[field];
            select.value = value;

            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
            }, 50);
        });

        // Configurar sincroniza√ß√µes
        setTimeout(() => {
            setupRoomTitleChangeListener(roomId);
            
            if (typeof window.setupCompleteRoomSync === 'function') {
                window.setupCompleteRoomSync(roomId);
            }
        }, 500);

        // Disparar c√°lculo final
        if (roomId && typeof calculateVazaoArAndThermalGains === 'function') {
            setTimeout(() => {
                calculateVazaoArAndThermalGains(roomId);
            }, 300);
        }

    }, 400);
}

/**
 * Configura listener de t√≠tulo
 */
function setupRoomTitleChangeListener(roomId) {
    const roomTitle = document.querySelector(`[data-room-id="${roomId}"] .room-title`);
    const ambienteInput = document.querySelector(`input[data-field="ambiente"][data-room-id="${roomId}"]`);
    
    if (roomTitle && ambienteInput) {
        ambienteInput.addEventListener('input', function() {
            if (this.value && this.value.trim() !== '' && this.value !== roomTitle.textContent) {
                if (typeof window.syncAmbienteToTitle === 'function') {
                    window.syncAmbienteToTitle(roomId, this.value);
                } else {
                    roomTitle.textContent = this.value;
                    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
                    if (roomBlock) {
                        roomBlock.dataset.roomName = this.value;
                    }
                }
                triggerCalculation(roomId);
            }
        });
    }
}

/**
 * Preenche ganhos t√©rmicos
 */
function fillThermalGainsData(roomElement, thermalGainsData) {
    if (!roomElement || !thermalGainsData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;

    const gainSelectors = {
        'total-ganhos-w': `#total-ganhos-w-${roomId}`,
        'total-tr-aprox': `#total-tr-aprox-${roomId}`,
        'total-tr-exato': `#total-tr-exato-${roomId}`,
        'total-externo': `#total-externo-${roomId}`,
        'total-divisoes': `#total-divisoes-${roomId}`,
        'total-piso': `#total-piso-${roomId}`,
        'total-iluminacao': `#total-iluminacao-${roomId}`,
        'total-dissi': `#total-dissi-${roomId}`,
        'total-pessoas': `#total-pessoas-${roomId}`,
        'total-ar-sensivel': `#total-ar-sensivel-${roomId}`,
        'total-ar-latente': `#total-ar-latente-${roomId}`
    };

    Object.entries(gainSelectors).forEach(([key, selector]) => {
        const element = document.querySelector(selector);
        if (element && thermalGainsData[key] !== undefined) {
            if (key === 'total-tr-exato' && typeof thermalGainsData[key] === 'number') {
                element.textContent = thermalGainsData[key].toFixed(3);
            } else {
                element.textContent = thermalGainsData[key];
            }
        }
    });
}

/**
 * Preenche dados de capacidade
 */
function fillCapacityData(roomElement, capacityData) {
    if (!roomElement || !capacityData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;

    const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`);
    if (fatorSegurancaInput && capacityData.fatorSeguranca !== undefined) {
        fatorSegurancaInput.value = capacityData.fatorSeguranca;
    }

    const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`);
    if (capacidadeUnitariaSelect && capacityData.capacidadeUnitaria !== undefined) {
        capacidadeUnitariaSelect.value = capacityData.capacidadeUnitaria;
    }

    const backupSelect = roomElement.querySelector('.backup-select');
    if (backupSelect && capacityData.backup !== undefined) {
        backupSelect.value = capacityData.backup;
    }
}

/**
 * Garante todas as se√ß√µes da sala - VERS√ÉO SIMPLIFICADA E CORRETA
 */
async function ensureAllRoomSections(roomElement) {
    if (!roomElement) {
        console.error('‚ùå Elemento da sala inv√°lido');
        return false;
    }

    const obraId = roomElement.dataset.obraId;
    const projectId = roomElement.dataset.projectId; 
    const roomName = roomElement.dataset.roomName;
    const roomId = roomElement.dataset.roomId;

    if (!roomId) {
        console.error(`‚ùå Room ID inv√°lido`);
        return false;
    }

    console.log(`üî® Verificando se√ß√µes da sala ${roomName}`);

    // Fun√ß√£o simples para verificar se√ß√£o
    const checkSection = (title) => {
        const sections = roomElement.querySelectorAll('.section-title');
        for (let sectionTitle of sections) {
            if (sectionTitle.textContent.includes(title)) {
                return true;
            }
        }
        return false;
    };

    // Verificar se√ß√µes
    const climatizationExists = checkSection('Climatiza√ß√£o');
    const machinesExists = checkSection('M√°quinas');
    const acessoriosExists = checkSection('Acessorios');
    const dutosExists = checkSection('Dutos');
    const tubosExists = checkSection('Tubula√ß√£o');

    console.log(`üìã Se√ß√µes existentes:`, {
        climatization: climatizationExists,
        machines: machinesExists,
        acessorios: acessoriosExists,
        dutos: dutosExists,
        tubos: tubosExists
    });

    // Verificar se h√° duplica√ß√£o de tubos
    const tubosSections = roomElement.querySelectorAll('.section-title');
    let tubosCount = 0;
    tubosSections.forEach(title => {
        if (title.textContent.includes('Tubula√ß√£o de Cobre')) {
            tubosCount++;
        }
    });

    if (tubosCount > 1) {
        console.warn(`‚ö†Ô∏è DUPLICA√á√ÉO DETECTADA: ${tubosCount} se√ß√µes de Tubula√ß√£o`);
        fixDuplicatedSections(roomElement, 'Tubula√ß√£o de Cobre');
        return true; // J√° corrigiu, n√£o precisa criar
    }

    // Se todas existem, retornar true
    if (climatizationExists && machinesExists && acessoriosExists && dutosExists && tubosExists) {
        console.log(`‚úÖ Todas as se√ß√µes j√° existem`);
        return true;
    }

    console.log(`üîÑ Criando se√ß√µes faltantes`);

    try {
        const roomContent = roomElement.querySelector('.room-content');
        if (!roomContent) {
            console.error(`‚ùå Container de conte√∫do da sala n√£o encontrado`);
            return false;
        }

        // Obter √∫ltima se√ß√£o
        let lastSection = roomContent.querySelector('.section-block:last-child');
        
        // Criar apenas o que falta, na ORDEM CORRETA
        const sectionsToCreate = [];
        
        if (!climatizationExists) sectionsToCreate.push({type: 'climatization', func: window.buildClimatizationSection});
        if (!machinesExists) sectionsToCreate.push({type: 'machines', func: window.buildMachinesSection});
        if (!acessoriosExists) sectionsToCreate.push({type: 'acessorios', func: window.buildAcessoriosSection});
        if (!dutosExists) sectionsToCreate.push({type: 'dutos', func: window.buildDutosSection});
        if (!tubosExists) sectionsToCreate.push({type: 'tubos', func: window.buildTubosSection});

        console.log(`üèóÔ∏è Criando ${sectionsToCreate.length} se√ß√µes`);

        // Criar se√ß√µes na ordem correta
        for (let i = 0; i < sectionsToCreate.length; i++) {
            const section = sectionsToCreate[i];
            if (typeof section.func === 'function') {
                console.log(`üì¶ Criando se√ß√£o: ${section.type}`);
                
                const html = await section.func(obraId, projectId, roomName, roomId);
                if (html) {
                    if (lastSection) {
                        lastSection.insertAdjacentHTML('afterend', html);
                    } else {
                        roomContent.insertAdjacentHTML('beforeend', html);
                    }
                    
                    lastSection = roomContent.querySelector('.section-block:last-child');
                    await new Promise(resolve => setTimeout(resolve, 150));
                }
            }
        }

        console.log(`‚úÖ Se√ß√µes criadas para ${roomName}`);
        return true;

    } catch (error) {
        console.error(`‚ùå Erro ao criar se√ß√µes:`, error);
        return false;
    }
}

/**
 * Corrige se√ß√µes duplicadas
 */
function fixDuplicatedSections(roomElement, sectionTitle) {
    const roomContent = roomElement.querySelector('.room-content');
    if (!roomContent) return;
    
    const allSections = roomContent.querySelectorAll('.section-block');
    const targetSections = [];
    
    // Encontrar todas as se√ß√µes com o t√≠tulo especificado
    allSections.forEach(section => {
        const titleElement = section.querySelector('.section-title');
        if (titleElement && titleElement.textContent.includes(sectionTitle)) {
            targetSections.push(section);
        }
    });
    
    // Se tem mais de uma, remover as extras
    if (targetSections.length > 1) {
        console.log(`üóëÔ∏è Removendo ${targetSections.length - 1} se√ß√µes duplicadas de "${sectionTitle}"`);
        
        // Manter a primeira, remover as outras
        for (let i = 1; i < targetSections.length; i++) {
            targetSections[i].remove();
        }
        
        console.log(`‚úÖ Duplica√ß√£o corrigida`);
    }
}

/**
 * Fun√ß√£o auxiliar para encontrar se√ß√£o
 */
function findSectionByTitle(roomElement, title) {
    const sections = roomElement.querySelectorAll('.section-block');
    for (let section of sections) {
        const sectionTitle = section.querySelector('.section-title');
        if (sectionTitle && sectionTitle.textContent.includes(title)) {
            return section;
        }
    }
    return null;
}

/**
 * Fun√ß√£o auxiliar para encontrar se√ß√£o de m√°quinas
 */
function findMachinesSection(roomElement) {
    return roomElement.querySelector('.machines-section') || 
           roomElement.querySelector('[id*="machines"]');
}

// Exporta√ß√µes
export {
    fillClimatizationInputs,
    fillThermalGainsData,
    fillCapacityData,
    ensureAllRoomSections,
    setupRoomTitleChangeListener,
    fixDuplicatedSections,
    findSectionByTitle,
    findMachinesSection
};

// Compatibilidade global
if (typeof window !== 'undefined') {
    window.setupRoomTitleChangeListener = setupRoomTitleChangeListener;
    window.fixDuplicatedSections = fixDuplicatedSections;
}
/* ==== FIM: data/builders/ui-folder/data-fillers.js ==== */

/* ==== IN√çCIO: data/utils/data-utils.js ==== */
/**
 * data/utils/data-utils.js
 * Utilit√°rios de dados unificados - FUS√ÉO: data-utils-core.js + helpers.js
 * Sistema completo de IDs, numera√ß√£o, nomea√ß√£o e utilit√°rios
 */

import { 
    safeNumber} from './core-utils.js';


// =============================================================================
// FUN√á√ïES DE NUMERA√á√ÉO (De data-utils-core.js)
// =============================================================================

/**
 * Obt√©m o pr√≥ximo n√∫mero de projeto dispon√≠vel PARA UMA OBRA ESPEC√çFICA - 
 * @param {string} obraId - ID √∫nico da obra
 * @returns {number} Pr√≥ximo n√∫mero dispon√≠vel para projeto na obra espec√≠fica
 */
function getNextProjectNumber(obraId) {
    try {
        // ‚úÖ CORRE√á√ÉO: Buscar apenas projetos DESTA obra espec√≠fica
        const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraBlock) {
            console.warn(`‚ö†Ô∏è Obra ${obraId} n√£o encontrada, usando projeto 1`);
            return 1;
        }

        const projectBlocks = obraBlock.querySelectorAll('.project-block');
        let maxNumber = 0;

        projectBlocks.forEach(project => {
            const projectName = project.dataset.projectName || 
                             project.querySelector('.project-title')?.textContent || '';
            
            if (projectName) {
                // Suporta: "Projeto1", "Projeto 2", "Projeto-3", etc.
                const match = projectName.match(/Projeto\s*[-_]?\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxNumber) maxNumber = num;
                }
            }
        });

        console.log(`üî¢ Next project number for obra ${obraId}: ${maxNumber + 1} (max found: ${maxNumber})`);
        return maxNumber + 1;

    } catch (error) {
        console.error('‚ùå Erro em getNextProjectNumber:', error);
        return 1; // Fallback seguro
    }
}

/**
 * Obt√©m o pr√≥ximo n√∫mero de sala - 
 * @param {string} projectId - ID do projeto
 * @returns {number} Pr√≥ximo n√∫mero dispon√≠vel para sala
 */
function getNextRoomNumber(projectId) {
    try {
        const projectBlock = document.querySelector(`[data-project-id="${projectId}"]`);
        if (!projectBlock) {
            console.warn(`‚ö†Ô∏è Projeto ${projectId} n√£o encontrado, usando sala 1`);
            return 1;
        }

        const roomBlocks = projectBlock.querySelectorAll('.room-block');
        let maxNumber = 0;

        roomBlocks.forEach(room => {
            const roomName = room.dataset.roomName || 
                          room.querySelector('.room-title')?.textContent || '';

            if (roomName) {
                // Suporta: "Sala1", "Sala 2", "Sala-3", etc.
                const match = roomName.match(/Sala\s*[-_]?\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxNumber) maxNumber = num;
                }
            }
        });

        console.log(`üî¢ Next room number for project ${projectId}: ${maxNumber + 1}`);
        return maxNumber + 1;

    } catch (error) {
        console.error('‚ùå Erro em getNextRoomNumber:', error);
        return 1; // Fallback seguro
    }
}

/**
 * Obt√©m o pr√≥ximo n√∫mero de obra dispon√≠vel
 * @returns {number} Pr√≥ximo n√∫mero dispon√≠vel para obra
 */
function getNextObraNumber() {
    try {
        const obraBlocks = document.querySelectorAll('.obra-block');
        let maxNumber = 0;

        obraBlocks.forEach(obra => {
            const obraName = obra.dataset.obraName || 
                          obra.querySelector('.obra-title')?.textContent || '';
            
            if (obraName) {
                // Suporta: "Obra1", "Obra 2", "Obra-3", etc.
                const match = obraName.match(/Obra\s*[-_]?\s*(\d+)/i);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxNumber) maxNumber = num;
                }
            }
        });

        console.log(`üî¢ Next obra number: ${maxNumber + 1} (max found: ${maxNumber})`);
        return maxNumber + 1;

    } catch (error) {
        console.error('‚ùå Erro em getNextObraNumber:', error);
        return 1; // Fallback seguro
    }
}

// =============================================================================
// FUN√á√ïES DE NOMEA√á√ÉO (De data-utils-core.js)
// =============================================================================

/**
 * Obt√©m o ID completo da sala no formato correto
 * @param {HTMLElement} roomElement - Elemento da sala
 * @returns {string} ID completo da sala
 */
function getRoomFullId(roomElement) {
    const roomId = roomElement.dataset.roomId;
    
    if (!roomId || roomId === 'undefined' || roomId === 'null' || roomId.includes('undefined')) {
        console.error(`ERRO FALBACK (getRoomFullId) [Room ID inv√°lido: ${roomId}]`);
        return generateSecureId('sala');
    }
    
    console.log(`‚úÖ ID da sala obtido do data attribute: ${roomId}`);
    return roomId;
}

/**
 * Obt√©m o nome da obra a partir do elemento - 
 * @param {HTMLElement} obraElement - Elemento da obra
 * @returns {string} Nome da obra
 */
function getObraName(obraElement) {
    if (!obraElement) {
        console.error(`ERRO FALBACK (getObraName) [Elemento da obra n√£o fornecido]`);
        return 'Obra_Erro';
    }

    const titleElement = obraElement.querySelector('.obra-title');
    if (titleElement) {
        const name = titleElement.textContent || titleElement.innerText || '';
        const trimmedText = name.trim();
        if (trimmedText && trimmedText !== 'Obra') {
            return trimmedText;
        }
    }
    
    const obraNameFromData = obraElement.dataset.obraName;
    if (obraNameFromData && obraNameFromData !== 'undefined' && obraNameFromData !== 'null') {
        return obraNameFromData;
    }
    
    console.error(`ERRO FALBACK (getObraName) [Nome da obra n√£o encontrado]`);
    return 'Obra_Erro';
}

/**
 * Obt√©m o nome do projeto a partir do elemento - 
 * @param {HTMLElement} projectElement - Elemento do projeto
 * @returns {string} Nome do projeto
 */
function getProjectName(projectElement) {
    if (!projectElement) {
        console.error(`ERRO FALBACK (getProjectName) [Elemento do projeto n√£o fornecido]`);
        return 'Projeto_Erro';
    }

    const titleElement = projectElement.querySelector('.project-title');
    if (titleElement) {
        const titleText = titleElement.textContent || titleElement.innerText || '';
        const trimmedText = titleText.trim();
        if (trimmedText && trimmedText !== 'Projeto') {
            console.log(`üìù Nome do projeto obtido do t√≠tulo: "${trimmedText}"`);
            return trimmedText;
        }
    }
    
    const projectNameFromData = projectElement.dataset.projectName;
    if (projectNameFromData && projectNameFromData !== 'undefined' && projectNameFromData !== 'null' && projectNameFromData !== 'Projeto') {
        console.log(`üìù Nome do projeto obtido do data attribute: "${projectNameFromData}"`);
        return projectNameFromData;
    }
    
    console.error(`ERRO FALBACK (getProjectName) [Nome do projeto n√£o encontrado]`);
    return 'Projeto_Erro';
}

/**
 * Obt√©m o nome da sala a partir do elemento - 
 * @param {HTMLElement} roomElement - Elemento da sala
 * @returns {string} Nome da sala
 */
function getRoomName(roomElement) {
    if (!roomElement) {
        console.error(`ERRO FALBACK (getRoomName) [Elemento da sala n√£o fornecido]`);
        return 'Sala_Erro';
    }

    const titleElement = roomElement.querySelector('.room-title');
    if (titleElement) {
        const name = titleElement.textContent || titleElement.value || titleElement.getAttribute('value') || '';
        const trimmedName = name.trim();
        if (trimmedName) return trimmedName;
    }
    
    const roomNameFromData = roomElement.dataset.roomName;
    if (roomNameFromData && roomNameFromData !== 'undefined' && roomNameFromData !== 'null') {
        return roomNameFromData;
    }
    
    const roomId = roomElement.dataset.roomId;
    if (roomId && roomId !== 'undefined' && roomId !== 'null') {
        return `Sala ${roomId.split('_').pop()}`;
    }
    
    console.error(`ERRO FALBACK (getRoomName) [Nome da sala n√£o encontrado]`);
    return 'Sala_Erro';
}

// =============================================================================
// FUN√á√ïES UTILIT√ÅRIAS (De data-utils-core.js)
// =============================================================================

/**
 * Extrai n√∫mero de um texto, convertendo v√≠rgula para ponto decimal
 * @param {string} text - Texto contendo n√∫mero
 * @returns {number|null} N√∫mero extra√≠do ou null se n√£o encontrado
 */
function extractNumberFromText(text) {
    if (!text) return null;
    
    const numberMatch = text.match(/-?\d+(?:[.,]\d+)?/);
    if (numberMatch) {
        const numericString = numberMatch[0].replace(',', '.');
        const numericValue = parseFloat(numericString);
        return isNaN(numericValue) ? null : numericValue;
    }
    
    return null;
}

/**
 * Obt√©m o nome da m√°quina a partir do elemento
 * @param {HTMLElement} machineElement - Elemento da m√°quina
 * @param {string} machineId - ID da m√°quina
 * @returns {string} Nome da m√°quina
 */
function getMachineName(machineElement, machineId) {
    const titleElement = machineElement.querySelector('.machine-title-editable');
    if (!titleElement) return `M√°quina ${machineId}`;
    
    const name = titleElement.value || titleElement.textContent || titleElement.getAttribute('value') || `M√°quina ${machineId}`;
    return name.trim() || `M√°quina${machineId}`;
}

/**
 * Converte texto de pre√ßo em n√∫mero
 * @param {string} priceText - Texto do pre√ßo no formato "R$ X.XXX,XX"
 * @returns {number} Valor num√©rico do pre√ßo
 */
function parseMachinePrice(priceText) {
    if (!priceText || priceText === 'R$ 0,00') return 0;
    
    try {
        const cleaned = priceText.replace('R$', '')
                                .replace(/\./g, '')
                                .replace(',', '.')
                                .trim();
        return parseFloat(cleaned) || 0;
    } catch (error) {
        console.error('‚ùå Erro ao converter pre√ßo:', priceText, error);
        return 0;
    }
}

/**
 * Fun√ß√£o de debug para mostrar todos os elementos de ganhos t√©rmicos dispon√≠veis
 * @param {HTMLElement} roomElement - Elemento da sala para debug
 * @returns {void}
 */
function debugThermalGainsElements(roomElement) {
    const roomFullId = getRoomFullId(roomElement);
    console.log('üêõ DEBUG: Todos os elementos de ganhos t√©rmicos dispon√≠veis:');
    
    // ‚úÖ ATUALIZADO: Incluir os novos IDs de TR
    const selectors = [
        'total-ganhos-w', 'total-tr-aprox', 'total-tr-exato', 'total-externo', 'total-divisoes',
        'total-piso', 'total-iluminacao', 'total-dissi', 'total-pessoas',
        'total-ar-sensivel', 'total-ar-latente'
    ];
    
    selectors.forEach(selector => {
        const element = document.querySelector(`#${selector}-${roomFullId}`);
        console.log(`üîç ${selector}-${roomFullId}:`, element ? `ENCONTRADO - "${element.textContent}"` : 'N√ÉO ENCONTRADO');
    });
}

/**
 * Obt√©m o valor de TR para c√°lculos (prioriza o valor exato)
 * @param {string} roomId - ID da sala
 * @returns {number} Valor de TR para uso em c√°lculos
 */
function getThermalLoadTRForCalculations(roomId) {
    try {
        // ‚úÖ NOVA: Priorizar o valor exato se dispon√≠vel
        const totalTRExatoElement = document.getElementById(`total-tr-exato-${roomId}`);
        if (totalTRExatoElement?.textContent) {
            const value = Number.parseFloat(totalTRExatoElement.textContent) || 0;
            console.log(`üî¢ [TR CALC] Usando valor exato: ${value}`);
            return value;
        }

        // Fallback para valor aproximado
        const totalTRAproxElement = document.getElementById(`total-tr-aprox-${roomId}`);
        if (totalTRAproxElement?.textContent) {
            const value = Number.parseFloat(totalTRAproxElement.textContent) || 0;
            console.log(`üî¢ [TR CALC] Usando valor aproximado: ${value}`);
            return value;
        }

        // Fallback para c√°lculo manual
        const totalGanhosWElement = document.getElementById(`total-ganhos-w-${roomId}`);
        if (totalGanhosWElement?.textContent) {
            const totalW = Number.parseFloat(totalGanhosWElement.textContent) || 0;
            const value = totalW / 3517;
            console.log(`üî¢ [TR CALC] Calculado manualmente: ${value}`);
            return value;
        }

        console.warn(`‚ö†Ô∏è [TR CALC] Nenhum valor de TR encontrado para sala ${roomId}`);
        return 0;
    } catch (error) {
        console.error(`‚ùå [TR CALC] Erro ao obter carga t√©rmica para sala ${roomId}:`, error);
        return 0;
    }
}

/**
 * Verifica se os elementos de TR est√£o corretamente configurados
 * @param {string} roomId - ID da sala
 * @returns {boolean} True se ambos os elementos existem
 */
function validateTRElements(roomId) {
    const elementAprox = document.getElementById(`total-tr-aprox-${roomId}`);
    const elementExato = document.getElementById(`total-tr-exato-${roomId}`);
    
    const isValid = !!(elementAprox && elementExato);
    
    if (!isValid) {
        console.warn(`‚ö†Ô∏è [TR VALIDATE] Elementos de TR incompletos para sala ${roomId}:`, {
            aprox: !!elementAprox,
            exato: !!elementExato
        });
    } else {
        console.log(`‚úÖ [TR VALIDATE] Elementos de TR v√°lidos para sala ${roomId}`);
    }
    
    return isValid;
}

// =============================================================================
// FUN√á√ïES DE COLETA DE DADOS (De helpers.js)
// =============================================================================

/**
 * Coleta dados de entrada da interface para processamento de climatiza√ß√£o
 * @param {HTMLElement} climaSection - Elemento HTML da se√ß√£o de climatiza√ß√£o
 * @param {string} roomId - ID √∫nico da sala (formato: obra_w12_proj_t34_1_sala_r21_1)
 * @returns {Object} Dados coletados dos inputs
 */
function collectClimatizationInputs(climaSection, roomId) {
    console.log(`üìù [COLLECT] Coletando inputs para sala: ${roomId}`);
    
    const inputs = climaSection.querySelectorAll(".clima-input, input[data-field], select[data-field]");
    const data = {};

    inputs.forEach((input) => {
        const field = input.dataset.field;
        let value;
        
        // ‚úÖ CORRE√á√ÉO: Tratar diferentes tipos de input
        if (input.type === 'checkbox') {
            value = input.checked;
        } else if (input.type === 'number' || input.type === 'text') {
            value = input.value !== "" ? (input.type === 'number' ? Number.parseFloat(input.value) : input.value) : "";
        } else if (input.tagName === 'SELECT') {
            value = input.value !== "" ? input.value : "";
        }
        
        if (field) {
            data[field] = value;
        }
    });

    // ‚úÖ CORRE√á√ÉO: Coletar estado da pressuriza√ß√£o dos RADIO BUTTONS
    if (data.pressurizacao === undefined) {
        const radioSim = climaSection.querySelector('input[type="radio"][value="sim"]');
        const radioNao = climaSection.querySelector('input[type="radio"][value="nao"]');
        
        // Se o radio "sim" estiver marcado, pressuriza√ß√£o est√° ativa
        data.pressurizacao = radioSim ? radioSim.checked : false;
        
        console.log(`üéØ [COLLECT] Estado da pressuriza√ß√£o:`, {
            radioSimChecked: radioSim?.checked,
            radioNaoChecked: radioNao?.checked,
            pressurizacao: data.pressurizacao
        });
    }
    
    // ‚úÖ CORRE√á√ÉO: Garantir que setpointTemp esteja presente
    if (data.setpointTemp === undefined) {
        const setpointInput = climaSection.querySelector('input[data-field="setpointTemp"]');
        data.setpointTemp = setpointInput ? safeNumber(setpointInput.value) : 0;
    }

    // ‚úÖ CORRE√á√ÉO: Garantir que pressurizacaoSetpoint esteja presente
    if (data.pressurizacaoSetpoint === undefined) {
        const pressurizacaoInput = climaSection.querySelector('input[data-field="pressurizacaoSetpoint"]');
        data.pressurizacaoSetpoint = pressurizacaoInput ? safeNumber(pressurizacaoInput.value) : 0;
        
        console.log(`üéØ [COLLECT] Valor da pressuriza√ß√£o:`, {
            pressurizacaoSetpoint: data.pressurizacaoSetpoint,
            inputValue: pressurizacaoInput?.value
        });
    }

    console.log(`‚úÖ [COLLECT] ${Object.keys(data).length} dados coletados para ${roomId}:`, data);
    return data;
}

/**
 * Encontra a se√ß√£o de climatiza√ß√£o de uma sala pelo ID √∫nico
 * @param {string} roomId - ID √∫nico da sala
 * @returns {HTMLElement|null} Elemento da se√ß√£o de climatiza√ß√£o
 */
function findClimatizationSection(roomId) {
    // ‚úÖ CORRE√á√ÉO: Buscar APENAS por ID √∫nico
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomElement) {
        console.error(`‚ùå [FIND] Sala n√£o encontrada: ${roomId}`);
        return null;
    }
    
    const climaSection = roomElement.querySelector('#section-content-' + roomId + '-clima');
    if (!climaSection) {
        console.error(`‚ùå [FIND] Se√ß√£o de climatiza√ß√£o n√£o encontrada para: ${roomId}`);
        return null;
    }
    
    console.log(`‚úÖ [FIND] Se√ß√£o encontrada para: ${roomId}`);
    return climaSection;
}

// =============================================================================
// EXPORTA√á√ïES
// =============================================================================

export {
    // Sistema de Numera√ß√£o
    getNextProjectNumber,
    getNextRoomNumber,
    getNextObraNumber,
    
    // Fun√ß√µes de Nomea√ß√£o
    getRoomFullId,
    getObraName,
    getProjectName,
    getRoomName,
    
    // Utilit√°rios Gerais
    extractNumberFromText,
    getMachineName,
    parseMachinePrice,
    debugThermalGainsElements,
    getThermalLoadTRForCalculations, // ‚úÖ NOVA: Fun√ß√£o para obter TR
    validateTRElements, // ‚úÖ NOVA: Valida√ß√£o dos elementos
    
    // Coleta de Dados
    collectClimatizationInputs,
    findClimatizationSection,
};

// Disponibiliza√ß√£o global para compatibilidade
if (typeof window !== 'undefined') {
    // Sistema de numera√ß√£o
    window.getNextProjectNumber = getNextProjectNumber;
    window.getNextRoomNumber = getNextRoomNumber;
    window.getNextObraNumber = getNextObraNumber;
    
    // Utilit√°rios
    window.getRoomFullId = getRoomFullId;
    window.debugThermalGainsElements = debugThermalGainsElements;
    window.getThermalLoadTRForCalculations = getThermalLoadTRForCalculations; // ‚úÖ NOVA
    window.validateTRElements = validateTRElements; // ‚úÖ NOVA
}
/* ==== FIM: data/utils/data-utils.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/room-renderer.js ==== */
/*
* ARQUIVO DE RENDERIZA√á√ÉO DE salas
*/

import { ensureStringId } from '../../utils/id-generator.js';


/**
 * Renderiza uma sala individual a partir dos dados carregados
 */
function renderRoomFromData(projectId, projectName, roomData, obraId = null, obraName = null) {
    const roomName = roomData.nome;
    const roomId = ensureStringId(roomData.id);

    console.log(`üéØ Renderizando sala: ${roomName} no projeto ${projectName}`, {
        obra: obraName,
        projectId: projectId,
        roomId: roomId,
        inputs: Object.keys(roomData.inputs || {}).length,
        maquinas: roomData.maquinas?.length || 0,
        capacidade: Object.keys(roomData.capacidade || {}).length,
        ganhosTermicos: Object.keys(roomData.ganhosTermicos || {}).length,
        acessorios: roomData.acessorios?.length || 0,
        dutos: roomData.dutos?.length || 0, // ‚úÖ ADICIONADO: dutos
        conjuntosTubulacao: roomData.tubulacao?.conjuntos?.length || 0
    });

    setTimeout(() => {
        // Criar sala b√°sica
        createEmptyRoom(obraId, projectId, roomName, roomId);
        
        // Aguardar cria√ß√£o e garantir todas as se√ß√µes
        setTimeout(() => {
            const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
            if (roomElement) {
                // ‚úÖ GARANTIR que TODAS as se√ß√µes sejam criadas (incluindo dutos)
                ensureAllRoomSections(roomElement).then(sectionsReady => {
                    if (sectionsReady) {
                        console.log(`‚úÖ Todas as se√ß√µes criadas para ${roomName} - Iniciando preenchimento`);
                        populateRoomData(roomElement, roomData);
                    } else {
                        console.error(`‚ùå Falha ao criar se√ß√µes para ${roomName}`);
                    }
                }).catch(error => {
                    console.error(`‚ùå Erro ao garantir se√ß√µes para ${roomName}:`, error);
                    throw error;
                });
            } else {
                console.error(`‚ùå Elemento da sala ${roomId} n√£o encontrado ap√≥s cria√ß√£o`);
            }
        }, 300);
        
    }, 100);
}

/**
 * Preenche uma sala espec√≠fica dentro de um projeto
 */
async function populateRoomData(roomElement, roomData) {
    if (!roomElement || !roomData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return false;
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå Room ID inv√°lido no populateRoomData: "${roomId}"`);
        return false;
    }
    
    console.log(`üîÑ Preenchendo sala "${roomName}" (ID: ${roomId})`, {
        acessorios: roomData.acessorios?.length || 0,
        dutos: roomData.dutos?.length || 0, // ‚úÖ ADICIONADO: dutos
        tubulacaoConjuntos: roomData.tubulacao?.conjuntos?.length || 0,
        maquinas: roomData.maquinas?.length || 0
    });

    try {
        // ‚úÖ CORRE√á√ÉO: Garantir que todas as se√ß√µes existam antes de preencher
        console.log(`üèóÔ∏è Garantindo que todas as se√ß√µes existem para sala ${roomName}`);
        const sectionsReady = await ensureAllRoomSections(roomElement);
        if (!sectionsReady) {
            console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel garantir todas as se√ß√µes para ${roomName} - Continuando...`);
        }

        const roomTitle = roomElement.querySelector('.room-title');
        if (roomTitle && roomData.nome) {
            roomTitle.textContent = roomData.nome;
            console.log(`‚úÖ T√≠tulo da sala atualizado: ${roomData.nome}`);
        }

        if (roomData.inputs) {
            console.log(`üå°Ô∏è Preenchendo inputs de climatiza√ß√£o para sala ${roomName}`);
            fillClimatizationInputs(roomElement, roomData.inputs);
        }

        if (roomData.ganhosTermicos) {
            console.log(`üìä Preenchendo ganhos t√©rmicos para sala ${roomName}`);
            fillThermalGainsData(roomElement, roomData.ganhosTermicos);
        }

        if (roomData.capacidade) {
            console.log(`‚ö° Preenchendo dados de capacidade para sala ${roomName}`);
            fillCapacityData(roomElement, roomData.capacidade);
        }

        // ‚úÖ Preencher acessorios
        if (roomData.acessorios && Array.isArray(roomData.acessorios)) {
            console.log(`üîß Preenchendo ${roomData.acessorios.length} acessorio(s) para sala ${roomName}`);
            
            // Aguardar um pouco para garantir que a se√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillAcessoriosData === 'function') {
                    window.fillAcessoriosData(roomElement, roomData.acessorios);
                    console.log(`‚úÖ Acessorios preenchidos via fun√ß√£o global`);
                } else {
                    console.error(`‚ùå Fun√ß√£o fillAcessoriosData n√£o dispon√≠vel no window`);
                }
            }, 2000);
        }

        // ‚úÖ Preencher dutos
        if (roomData.dutos && Array.isArray(roomData.dutos)) {
            console.log(`üìè Preenchendo ${roomData.dutos.length} duto(s) para sala ${roomName}`);
            
            // Aguardar um pouco para garantir que a se√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillDutosData === 'function') {
                    window.fillDutosData(roomElement, roomData.dutos);
                    console.log(`‚úÖ Dutos preenchidos via fun√ß√£o global`);
                } else {
                    console.error(`‚ùå Fun√ß√£o fillDutosData n√£o dispon√≠vel no window`);
                }
            }, 2500);
        }

        // ‚úÖ CORRE√á√ÉO CR√çTICA: Preencher tubula√ß√£o - CUIDADO COM A ESTRUTURA
        if (roomData.tubulacao && roomData.tubulacao.conjuntos && Array.isArray(roomData.tubulacao.conjuntos)) {
            console.log(`üîß Preenchendo ${roomData.tubulacao.conjuntos.length} conjunto(s) de tubula√ß√£o para sala ${roomName}`);
            
            // Aguardar mais tempo para garantir que a se√ß√£o de tubula√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillTubulacaoData === 'function') {
                    // ‚úÖ CORRE√á√ÉO: Passar o objeto completo de tubula√ß√£o
                    window.fillTubulacaoData(roomElement, roomData.tubulacao);
                    console.log(`‚úÖ Tubula√ß√£o preenchida via fun√ß√£o global`, {
                        conjuntos: roomData.tubulacao.conjuntos.length,
                        estrutura: 'conjuntos array dentro de objeto tubulacao'
                    });
                } else {
                    console.error(`‚ùå Fun√ß√£o fillTubulacaoData n√£o dispon√≠vel no window - Verifique se tubos.js foi carregado`);
                }
            }, 3000);
        } else if (roomData.tubulacao) {
            console.warn(`‚ö†Ô∏è Estrutura de tubula√ß√£o inv√°lida ou vazia para sala ${roomName}:`, roomData.tubulacao);
        }

        // ‚úÖ Preencher m√°quinas
        if (roomData.maquinas && Array.isArray(roomData.maquinas)) {
            console.log(`ü§ñ Agendando preenchimento de ${roomData.maquinas.length} m√°quina(s) para sala ${roomName}`);
            
            // Aguardar mais tempo para garantir que todas as outras se√ß√µes foram preenchidas
            setTimeout(async () => {
                try {
                    console.log(`üöÄ Iniciando preenchimento de m√°quinas para sala ${roomName}`);
                    
                    const success = await fillMachinesData(roomElement, roomData.maquinas);
                    
                    if (success) {
                        console.log(`üéâ Todas as m√°quinas preenchidas com sucesso para sala ${roomName}`);
                    } else {
                        console.error(`‚ùå Falha ao preencher m√°quinas para sala ${roomName}`);
                    }
                } catch (error) {
                    console.error(`üí• Erro ao preencher m√°quinas para sala ${roomName}:`, error);
                }
            }, 4000);
        }

        console.log(`‚úÖ Sala "${roomName}" preenchida com sucesso`);
        return true;

    } catch (error) {
        console.error(`‚ùå Erro ao preencher sala "${roomName}":`, error);
        return false;
    }
}

/**
 * Preenche os inputs de uma sala espec√≠fica
 */
function populateRoomInputs(projectId, projectName, roomId, roomName, roomData, obraId, obraName) {
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (roomElement) {
        populateRoomData(roomElement, roomData);
    } else {
        console.error(`‚ùå Elemento da sala ${roomId} n√£o encontrado no DOM`);
    }
}

// EXPORTS NO FINAL
export {
    renderRoomFromData,
    populateRoomData,
    populateRoomInputs
};
/* ==== FIM: data/builders/ui-folder/room-renderer.js ==== */

/* ==== IN√çCIO: main-folder/system-init.js ==== */
/* ==== IN√çCIO: main-folder/system-init.js ==== */
/**
 * system-init.js - INICIALIZA√á√ÉO DO SISTEMA PRINCIPAL
 * üéØ Carrega constantes, m√≥dulos e componentes principais
 */

// ‚úÖ IMPORTAR M√ìDULOS COM CAMINHOS CORRETOS
import { loadObrasFromServer } from '../data/adapters/obra-adapter-folder/obra-data-loader.js';

import { getGeralCount } from '../data/adapters/session-adapter.js';
import { shutdownManual } from '../data/adapters/shutdown-adapter.js';
import {EmpresaCadastroInline} from '../data/empresa-system/empresa-core.js';

// üî• Importar m√≥dulo de filtros separado
import { initializeFilterSystem } from './filter-init.js';

/**
 * Sistema de Shutdown Manual
 */
class ShutdownManager {
  constructor() {
    this.init();
  }

  init() {
    console.log('üîí Sistema de shutdown manual ativado');
    this.disableAutoShutdown();
    this.createShutdownButton();
  }

  disableAutoShutdown() {
    window.removeEventListener('beforeunload', this.autoShutdown);
    window.removeEventListener('unload', this.autoShutdown);
    window.removeEventListener('pagehide', this.autoShutdown);
  }

  createShutdownButton() {
    if (document.querySelector('.shutdown-btn')) return;

    const headerRight = document.querySelector('.header-right');
    if (headerRight) {
      const shutdownBtn = document.createElement('button');
      shutdownBtn.className = 'shutdown-btn';
      shutdownBtn.innerHTML = '‚èª';
      shutdownBtn.title = 'Encerrar Servidor';
      shutdownBtn.onclick = () => this.shutdownManual();

      headerRight.appendChild(shutdownBtn);
      console.log('‚úÖ Bot√£o de shutdown adicionado ao header');
    }
  }

  async shutdownManual() {
    if (confirm('Deseja realmente ENCERRAR o servidor?')) {
      try {
        console.log('üîÑ Executando shutdown COMPLETO...');
        await shutdownManual();
      } catch (error) {
        console.log('üîå Servidor encerrado ou n√£o responde:', error);
      }
    }
  }
}

/**
 * Carrega as constantes do sistema do servidor
 */
async function loadSystemConstants() {
  try {
    console.log("üîç Carregando constantes do sistema...");
    const response = await fetch(`/constants`);

    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }

    const constantsData = await response.json();
    window.systemConstants = constantsData;
    console.log("‚úÖ Constantes carregadas do JSON:", window.systemConstants);

    if (!window.systemConstants.VARIAVEL_PD.value
      || !window.systemConstants.VARIAVEL_PS.value
    ) {
      throw new Error("Constantes essenciais n√£o encontradas no JSON");
    }

    return true;
  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao carregar constantes:", error);
    throw error;
  }
}

/**
 * Carrega todos os m√≥dulos do sistema dinamicamente
 */
async function loadAllModules() {
  if (window.modulesLoaded) return;

  try {
    console.log("üì¶ Iniciando carregamento de m√≥dulos...");

    // ‚úÖ CORRE√á√ÉO: Todos os m√≥dulos importados dentro do Promise.all
    const modules = await Promise.all([
      import('../ui/interface.js'),
      import('../ui/components/edit.js'),
      import('../ui/components/status.js'),
      import('../ui/components/modal/modal.js'),
      import('../ui/components/modal/exit-modal.js'),
      import('../ui/helpers.js'),
      import('../features/managers/obra-manager.js'),
      import('../features/managers/project-manager.js'),
      import('../data/modules/rooms.js'),
      import('../data/modules/climatizacao.js'),
      import('../data/modules/acessorios.js'), // ‚úÖ MANTER aqui
      import('../data/modules/machines/machines-core.js'),
      import('../data/modules/machines/capacity-calculator.js'),
      import('../features/calculations/air-flow.js'),
      import('../features/calculations/calculations-core.js'),
      import('../data/utils/id-generator.js'),
      import('../data/utils/data-utils.js'),
      import('../data/builders/ui-builders.js'),
      import('../data/builders/data-builders.js'),
      import('../data/builders/ui-folder/data-fillers.js'), // ‚úÖ ADICIONAR para fun√ß√µes auxiliares
      import('../data/builders/ui-folder/room-renderer.js') // ‚úÖ ADICIONAR para renderiza√ß√£o
    ]);

    const [
      interfaceModule,
      editModule,
      statusModule,
      modalModule,
      modalExitModule,
      helpersModule,
      obraManagerModule,
      projectManagerModule,
      roomsModule,
      climatizationModule,
      acessoriosModule, // ‚úÖ RECUPERADO
      machinesCoreModule,
      capacityCalculatorModule,
      airFlowModule,
      calculationsCoreModule,
      idGeneratorModule,
      dataUtilsModule,
      uiBuildersModule,
      dataBuildersModule,
      dataFillersModule, // ‚úÖ NOVO
      roomRendererModule // ‚úÖ NOVO
    ] = modules;

    // ‚úÖ CORRE√á√ÉO: Juntar TODAS as fun√ß√µes em um objeto
    const allFunctions = {
      // Interface
      toggleSection: interfaceModule.toggleSection,
      toggleSubsection: interfaceModule.toggleSubsection,
      toggleObra: interfaceModule.toggleObra,
      toggleProject: interfaceModule.toggleProject,
      toggleRoom: interfaceModule.toggleRoom,
      collapseElement: helpersModule.collapseElement,
      expandElement: helpersModule.expandElement,
      showSystemStatus: statusModule.showSystemStatus,

      // Obras
      addNewObra: obraManagerModule.addNewObra,
      saveOrUpdateObra: obraManagerModule.saveObra,
      verifyObraData: obraManagerModule.verifyObraData,
      deleteObra: obraManagerModule.deleteObra,
      saveObra: obraManagerModule.saveObra,
      fetchObras: obraManagerModule.fetchObras,
      supportFrom_saveObra: obraManagerModule.supportFrom_saveObra,
      atualizarObra: obraManagerModule.atualizarObra,

      // Projetos
      addNewProjectToObra: projectManagerModule.addNewProjectToObra,
      deleteProject: projectManagerModule.deleteProject,

      // Salas
      addNewRoom: roomsModule.addNewRoom,
      deleteRoom: roomsModule.deleteRoom,
      createEmptyRoom: roomsModule.createEmptyRoom,

      // Climatiza√ß√£o
      buildClimatizationSection: climatizationModule.buildClimatizationSection,

      // M√°quinas
      buildMachinesSection: machinesCoreModule.buildMachinesSection,
      calculateCapacitySolution: capacityCalculatorModule.calculateCapacitySolution,
      updateBackupConfiguration: capacityCalculatorModule.updateBackupConfiguration,
      toggleOption: machinesCoreModule.toggleOption,
      addMachine: machinesCoreModule.addMachine,
      deleteMachine: machinesCoreModule.deleteMachine,

      // ‚úÖ CORRE√á√ÉO: EQUIPAMENTOS COMPLETO
      buildAcessoriosSection: acessoriosModule.buildAcessoriosSection,
      initAcessoriosSystem: acessoriosModule.initAcessoriosSystem,
      fillAcessoriosData: acessoriosModule.fillAcessoriosData, // ‚Üê AGORA EXISTE!
      adicionarAcessorioNaTabela: acessoriosModule.adicionarAcessorioNaTabela,
      atualizarTotalAcessorios: acessoriosModule.atualizarTotalAcessorios,
      formatarMoeda: acessoriosModule.formatarMoeda,
      carregarTiposAcessorios: acessoriosModule.carregarTiposAcessorios,
      loadAcessorioDimensoes: acessoriosModule.loadAcessorioDimensoes,
      adicionarAcessorio: acessoriosModule.adicionarAcessorio,
      limparAcessorios: acessoriosModule.limparAcessorios,

      // C√°lculos
      calculateVazaoArAndThermalGains: airFlowModule.calculateVazaoArAndThermalGains,
      calculateVazaoArAndThermalGainsDebounced: calculationsCoreModule.calculateVazaoArAndThermalGainsDebounced,

      // Edi√ß√£o
      makeEditable: editModule.makeEditable,

      // Utilit√°rios
      ensureStringId: idGeneratorModule.ensureStringId,
      getNextObraNumber: dataUtilsModule.getNextObraNumber,
      getNextProjectNumber: dataUtilsModule.getNextProjectNumber,
      getNextRoomNumber: dataUtilsModule.getNextRoomNumber,

      // Modal
      showConfirmationModal: modalModule.showConfirmationModal,
      closeConfirmationModal: modalModule.closeConfirmationModal,
      undoDeletion: modalModule.undoDeletion,

      // Helpers
      removeEmptyObraMessage: helpersModule.removeEmptyObraMessage,
      showEmptyObraMessageIfNeeded: helpersModule.showEmptyObraMessageIfNeeded,
      removeEmptyProjectMessage: helpersModule.removeEmptyProjectMessage,
      showEmptyProjectMessageIfNeeded: helpersModule.showEmptyProjectMessageIfNeeded,

      // ‚úÖ NOVO: Fun√ß√µes de preenchimento de dados
      fillClimatizationInputs: dataFillersModule.fillClimatizationInputs,
      fillThermalGainsData: dataFillersModule.fillThermalGainsData,
      fillCapacityData: dataFillersModule.fillCapacityData,
      // REMOVER: fillAcessoriosData: dataFillersModule.fillAcessoriosData, ‚Üê DUPLICADA
      ensureAllRoomSections: dataFillersModule.ensureAllRoomSections,
      setupRoomTitleChangeListener: dataFillersModule.setupRoomTitleChangeListener,

      // ‚úÖ NOVO: Fun√ß√µes de renderiza√ß√£o
      renderRoomFromData: roomRendererModule.renderRoomFromData,
      populateRoomData: roomRendererModule.populateRoomData,
      populateRoomInputs: roomRendererModule.populateRoomInputs,

      // UI Builders
      populateObraData: uiBuildersModule.populateObraData,
      renderObraFromData: uiBuildersModule.renderObraFromData,
      renderProjectFromData: uiBuildersModule.renderProjectFromData,
      fillMachinesData: uiBuildersModule.fillMachinesData,
      ensureMachinesSection: uiBuildersModule.ensureMachinesSection,
      populateMachineData: uiBuildersModule.populateMachineData,

      // Data Builders
      buildObraData: dataBuildersModule.buildObraData,
      buildProjectData: dataBuildersModule.buildProjectData,
      extractRoomData: dataBuildersModule.extractRoomData,
      extractMachinesData: dataBuildersModule.extractMachinesData,
      extractThermalGainsData: dataBuildersModule.extractThermalGainsData,
      extractClimatizationInputs: dataBuildersModule.extractClimatizationInputs,
      extractCapacityData: dataBuildersModule.extractCapacityData,
      extractAcessoriosData: dataBuildersModule.extractAcessoriosData,
      extractTubulacaoData: dataBuildersModule.extractTubulacaoData,
      extractDutosData: dataBuildersModule.extractDutosData,

      // Adapters
      loadObrasFromServer: loadObrasFromServer
    };

    window.systemFunctions = {};

    // ‚úÖ CORRE√á√ÉO: Filtrar fun√ß√µes v√°lidas antes de atribuir
    Object.keys(allFunctions).forEach(funcName => {
      const func = allFunctions[funcName];
      
      if (typeof func === 'function') {
        window[funcName] = func;
        window.systemFunctions[funcName] = func;
        console.log(`‚úÖ ${funcName} atribu√≠da ao window`);
      } else if (func !== undefined) {
        console.warn(`‚ö†Ô∏è ${funcName} n√£o √© uma fun√ß√£o:`, typeof func);
      } else {
        console.error(`‚ùå ${funcName} √© undefined no m√≥dulo`);
      }
    });

    // ‚úÖ CORRE√á√ÉO: Verificar fun√ß√µes cr√≠ticas
    const criticalFunctions = [
      'fillAcessoriosData',
      'buildAcessoriosSection',
      'initAcessoriosSystem'
    ];
    
    criticalFunctions.forEach(funcName => {
      if (typeof window[funcName] !== 'function') {
        console.error(`üö® CR√çTICO: ${funcName} n√£o est√° dispon√≠vel!`);
      } else {
        console.log(`üëç ${funcName} OK`);
      }
    });

    window.modulesLoaded = true;
    console.log("‚úÖ Todos os m√≥dulos foram carregados com sucesso");
    
    // ‚úÖ CORRE√á√ÉO: Verificar fun√ß√£o espec√≠fica ap√≥s carregamento
    setTimeout(() => {
      console.log('üîç Verifica√ß√£o p√≥s-carregamento:');
      console.log('- fillAcessoriosData:', typeof window.fillAcessoriosData);
      console.log('- initAcessoriosSystem:', typeof window.initAcessoriosSystem);
      console.log('- buildAcessoriosSection:', typeof window.buildAcessoriosSection);
    }, 500);

    return true;

  } catch (error) {
    console.error("‚ùå Erro ao carregar m√≥dulos:", error);
    throw error;
  }
}

/**
 * Inicializa o sistema de cadastro de empresas
 */
async function initializeEmpresaCadastro() {
  try {
    console.log("üè¢ Inicializando sistema de cadastro de empresas...");

    await new Promise(resolve => setTimeout(resolve, 500));

    window.empresaCadastro = new EmpresaCadastroInline();

    console.log("‚úÖ Sistema de cadastro de empresas inicializado");

    const spansCadastro = document.querySelectorAll('.projetc-header-record.very-dark span');
    console.log(`üîç Encontrados ${spansCadastro.length} elementos de cadastro de empresas`);

    return true;
  } catch (error) {
    console.error("‚ùå Erro ao inicializar sistema de cadastro de empresas:", error);
    throw error;
  }
}

/**
 * Inicializa o sistema completo
 */
export async function initializeSystem() {
  try {
    console.log("üöÄ [SYSTEM-INIT] Iniciando sistema completo...");

    window.systemLoadingStart = Date.now();

    console.log("üîí [SYSTEM-INIT] Inicializando shutdown manager...");
    window.shutdownManager = new ShutdownManager();

    console.log("üìä [SYSTEM-INIT] Carregando constantes do sistema...");
    await loadSystemConstants();
    console.log("‚úÖ [SYSTEM-INIT] Constantes carregadas");

    console.log("üì¶ [SYSTEM-INIT] Carregando m√≥dulos do sistema...");
    await loadAllModules();
    console.log("‚úÖ [SYSTEM-INIT] M√≥dulos carregados");

    console.log("üè¢ [SYSTEM-INIT] Inicializando sistema de empresas...");
    await initializeEmpresaCadastro();
    console.log("‚úÖ [SYSTEM-INIT] Sistema de empresas inicializado");

    console.log("üîß [SYSTEM-INIT] Inicializando sistema de filtros...");
    await initializeFilterSystem();
    console.log("‚úÖ [SYSTEM-INIT] Sistema de filtros inicializado");

    const loadingTime = Date.now() - window.systemLoadingStart;
    window.systemLoaded = true;
    window.systemLoadTime = loadingTime;

    console.log(`üéâ [SYSTEM-INIT] Sistema completamente inicializado em ${loadingTime}ms!`);

    // ‚úÖ CORRE√á√ÉO: Verifica√ß√£o final
    console.log('üîç Verifica√ß√£o final de fun√ß√µes:');
    console.log('- fillAcessoriosData:', typeof window.fillAcessoriosData);
    console.log('- buildAcessoriosSection:', typeof window.buildAcessoriosSection);
    
    // ‚úÖ CORRE√á√ÉO: Inicializar fallback manual se necess√°rio
    if (typeof window.fillAcessoriosData !== 'function') {
      console.warn('‚ö†Ô∏è fillAcessoriosData n√£o dispon√≠vel, tentando fallback...');
      try {
        const acessoriosModule = await import('../data/modules/acessorios.js');
        if (acessoriosModule.fillAcessoriosData) {
          window.fillAcessoriosData = acessoriosModule.fillAcessoriosData;
          console.log('‚úÖ fillAcessoriosData atribu√≠da via fallback manual');
        }
      } catch (error) {
        console.error('‚ùå Fallback manual falhou:', error);
      }
    }

    const event = new CustomEvent('systemInitialized', {
      detail: {
        time: loadingTime,
        timestamp: new Date().toISOString(),
        modules: window.modulesLoaded,
        constants: !!window.systemConstants,
        acessoriosReady: typeof window.fillAcessoriosData === 'function'
      }
    });
    document.dispatchEvent(event);

    return true;

  } catch (error) {
    console.error("‚ùå [SYSTEM-INIT] ERRO CR√çTICO na inicializa√ß√£o do sistema:", error);
    throw error;
  }
}
/* ==== FIM: main-folder/system-init.js ==== */
/* ==== FIM: main-folder/system-init.js ==== */

/* ==== IN√çCIO: features/calculations/thermal-gains.js ==== */
/**
 * thermal-gains.js
 * üéØ FUS√ÉO COMPLETA: thermalCalculations + thermalComponents + thermalDisplay
 * ‚ö° REDU√á√ÉO: 3 arquivos ‚Üí 1 arquivo (~600 ‚Üí ~350 linhas)
 */


import { 
    waitForSystemConstants, 
    validateSystemConstants,
    collectClimatizationInputs,
} from './calculations-core.js'  

import { safeNumber, updateElementText } from '../../data/utils/core-utils.js';

/**
 * üî• C√ÅLCULOS DE COMPONENTES T√âRMICOS (thermalComponents.js)
 */

function calculateCeilingGain(area, uValue, deltaT) {
  const areaNum = safeNumber(area);
  const uValueNum = safeNumber(uValue);
  const deltaTNum = safeNumber(deltaT);
  const result = areaNum * uValueNum * deltaTNum;
  console.log(`[DEBUG DETAIL] calculateCeilingGain: ${areaNum} * ${uValueNum} * ${deltaTNum} = ${result}`);
  return result;
}

function calculateWallGain(comprimento, peDireito, uValue, deltaT) {
  const compNum = safeNumber(comprimento);
  const peDireitoNum = safeNumber(peDireito);
  const uValueNum = safeNumber(uValue);
  const deltaTNum = safeNumber(deltaT);
  const area = compNum * peDireitoNum;
  const result = area * uValueNum * deltaTNum;
  console.log(`[DEBUG DETAIL] calculateWallGain: (${compNum} * ${peDireitoNum}) = ${area}m¬≤ * ${uValueNum} * ${deltaTNum} = ${result}`);
  return result;
}

function calculatePartitionGain(inputArea, peDireito, uValue, deltaT) {
  const area = safeNumber(inputArea) * safeNumber(peDireito);
  const result = area * uValue * deltaT;
  return result;
}

function calculateFloorGain(area, constants) {
  const uValue = window.systemConstants?.AUX_U_Value_Piso.value || 2.7;
  const deltaT = window.systemConstants?.deltaT_piso.value || 7.5;
  const result = safeNumber(area) * uValue * deltaT;
  return result;
}

function calculateLightingGain(area, constants) {
  const fatorIluminacao = window.systemConstants?.AUX_Fator_Iluminacao.value || 7;
  const fsIluminacao = window.systemConstants?.AUX_Fs_Iluminacao.value || 1;
  const result = safeNumber(area) * fatorIluminacao * fsIluminacao;
  return result;
}

function calculateDissipationGain(dissipacao, constants) {
  const fatorConversao = window.systemConstants?.AUX_Fator_Conver_Painel.value || 1;
  const fsPaineis = window.systemConstants?.AUX_Fs_Paineis.value || 100;
  const result = (fatorConversao * safeNumber(dissipacao) * fsPaineis) / 100;
  return result;
}

function calculatePeopleGain(numPessoas, constants) {
  const csp = window.systemConstants?.AUX_OCp_Csp.value || 86.5;
  const clp = window.systemConstants?.AUX_OCp_Clp.value || 133.3;
  const fsPessoas = 100;
  const pessoas = safeNumber(numPessoas);
  const ganhoSensivel = (csp * pessoas * fsPessoas) / 100;
  const ganhoLatente = (clp * pessoas * fsPessoas) / 100;
  const result = ganhoSensivel + ganhoLatente;
  return result;
}

function calculateExternalAirSensibleGain(vazaoArExterno, auxVars, constants) {
  const c_ArExterno = window.systemConstants?.AUX_c_ArExterno.value || 0.24;
  const deltaT_ArExterno = window.systemConstants?.AUX_deltaT_ArExterno.value || 10;
  
  const calc_Gsens_ArE = auxVars.m_ArExterno * c_ArExterno * deltaT_ArExterno;
  const resultado = (calc_Gsens_ArE / 1000) * 1.16;
  
  return resultado;
}

function calculateExternalAirLatentGain(vazaoArExterno, constants) {
  const f_ArExterno = window.systemConstants?.AUX_f_ArExterno.value || 3.01;
  const deltaUa_ArExterno = window.systemConstants?.AUX_deltaUa_ArExterno.value || 8.47;
  
  const vazao = safeNumber(vazaoArExterno);
  const ganho = vazao * f_ArExterno * deltaUa_ArExterno;
  
  return ganho;
}

/**
 * üìä C√ÅLCULOS DE TOTAIS E DISPLAY (thermalDisplay.js)
 */

function calculateTotals(gains) {
  const totalExterno = gains.teto + gains.paredeOeste + gains.paredeLeste + gains.paredeNorte + gains.paredeSul;
  const totalDivisoes = gains.divisoriaNaoClima1 + gains.divisoriaNaoClima2 + gains.divisoriaClima1 + gains.divisoriaClima2;
  const totalPiso = gains.piso;
  const totalIluminacao = gains.iluminacao;
  const totalEquipamentos = gains.dissipacao;
  const totalPessoas = gains.pessoas;
  const totalArSensivel = gains.arSensivel;
  const totalArLatente = gains.arLatente;
  const totalArExterno = totalArSensivel + totalArLatente;

  const totalGeralW = totalExterno + totalDivisoes + totalPiso + totalIluminacao + totalEquipamentos + totalPessoas + totalArExterno;
  const totalGeralTR = totalGeralW / 3517;

  const totals = {
    externo: Math.ceil(totalExterno),
    divisoes: Math.ceil(totalDivisoes),
    piso: Math.ceil(totalPiso),
    iluminacao: Math.ceil(totalIluminacao),
    equipamentos: Math.ceil(totalEquipamentos),
    pessoas: Math.ceil(totalPessoas),
    arSensivel: Math.ceil(totalArSensivel),
    arLatente: Math.ceil(totalArLatente),
    arExterno: Math.ceil(totalArExterno),
    geralW: Math.ceil(totalGeralW),
    geralTR: Math.ceil(totalGeralTR),
    geralTRExato: totalGeralTR //  valor exato sem arredondamento
  };

  return totals;
}

function updateWallDisplay(roomId, direction, gain, uValue, inputWidth, peDireito, deltaT) {
  const area = safeNumber(inputWidth) * safeNumber(peDireito);
  updateElementText(`area-parede-${direction}-${roomId}`, Math.ceil(area));
  updateElementText(`uvalue-parede-${direction}-${roomId}`, uValue.toFixed(3));
  updateElementText(`deltat-parede-${direction}-${roomId}`, deltaT || 0);
  updateElementText(`ganho-parede-${direction}-${roomId}`, Math.ceil(gain));
}

function updatePartitionDisplay(roomId, type, gain, uValue, inputArea, peDireito, deltaT) {
  const areaCalculada = safeNumber(inputArea) * safeNumber(peDireito);
  updateElementText(`area-divi-${type}-${roomId}`, Math.ceil(areaCalculada));
  updateElementText(`uvalue-divi-${type}-${roomId}`, uValue.toFixed(3));
  updateElementText(`deltat-divi-${type}-${roomId}`, deltaT || 0);
  updateElementText(`ganho-divi-${type}-${roomId}`, Math.ceil(gain));
}

function updateThermalGainsDisplay(roomId, gains, totals, uValues, inputData) {
  console.log(`üî• Atualizando display t√©rmico para sala: ${roomId}`);
  
  updateElementText(`total-ganhos-w-${roomId}`, totals.geralW);

  updateElementText(`total-tr-aprox-${roomId}`, totals.geralTR); 
  updateElementText(`total-tr-exato-${roomId}`, (totals.geralW / 3517).toFixed(3)); // Valor exato com 3 casas decimais

  updateElementText(`area-teto-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`uvalue-teto-${roomId}`, uValues.teto.toFixed(3));
  updateElementText(`deltat-teto-${roomId}`, window.systemConstants?.deltaT_teto.value || 20);
  updateElementText(`ganho-teto-${roomId}`, Math.ceil(gains.teto));

  updateWallDisplay(roomId, "oeste", gains.paredeOeste, uValues.parede, inputData.paredeOeste, inputData.peDireito, window.systemConstants?.deltaT_parede_Oes.value || 0);
  updateWallDisplay(roomId, "leste", gains.paredeLeste, uValues.parede, inputData.paredeLeste, inputData.peDireito, window.systemConstants?.deltaT_parede_Les.value || 0);
  updateWallDisplay(roomId, "norte", gains.paredeNorte, uValues.parede, inputData.paredeNorte, inputData.peDireito, window.systemConstants?.deltaT_parede_Nor.value || 0);
  updateWallDisplay(roomId, "sul", gains.paredeSul, uValues.parede, inputData.paredeSul, inputData.peDireito, window.systemConstants?.deltaT_parede_Sul.value || 0);

  updatePartitionDisplay(roomId, "nc1", gains.divisoriaNaoClima1, uValues.parede, inputData.divisoriaNaoClima1, inputData.peDireito, window.systemConstants?.deltaT_divi_N_clim1.value || 0);
  updatePartitionDisplay(roomId, "nc2", gains.divisoriaNaoClima2, uValues.parede, inputData.divisoriaNaoClima2, inputData.peDireito, window.systemConstants?.deltaT_divi_N_clim2.value || 0);
  updatePartitionDisplay(roomId, "c1", gains.divisoriaClima1, uValues.parede, inputData.divisoriaClima1, inputData.peDireito, window.systemConstants?.deltaT_divi_clim1.value || 0);
  updatePartitionDisplay(roomId, "c2", gains.divisoriaClima2, uValues.parede, inputData.divisoriaClima2, inputData.peDireito, window.systemConstants?.deltaT_divi_clim2.value || 0);

  updateElementText(`area-piso-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`uvalue-piso-${roomId}`, uValues.piso.toFixed(3));
  updateElementText(`deltat-piso-${roomId}`, window.systemConstants?.deltaT_piso.value || 5);
  updateElementText(`ganho-piso-${roomId}`, Math.ceil(gains.piso));
  updateElementText(`total-piso-${roomId}`, totals.piso);

  updateElementText(`area-iluminacao-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`fator-iluminacao-${roomId}`, window.systemConstants?.AUX_Fator_Iluminacao.value || 7);
  updateElementText(`fs-iluminacao-${roomId}`, window.systemConstants?.AUX_Fs_Iluminacao.value || 1);
  updateElementText(`ganho-iluminacao-${roomId}`, Math.ceil(gains.iluminacao));
  updateElementText(`total-iluminacao-${roomId}`, totals.iluminacao);

  updateElementText(`fator-conversao-dissi-${roomId}`, window.systemConstants?.AUX_Fator_Conver_Painel.value || 1);
  updateElementText(`pe-dissi-${roomId}`, inputData.dissipacao || 0);
  updateElementText(`fs-dissi-${roomId}`, window.systemConstants?.AUX_Fs_Paineis.value || 100);
  updateElementText(`ganho-dissi-${roomId}`, Math.ceil(gains.dissipacao));
  updateElementText(`total-dissi-${roomId}`, totals.equipamentos);

  updateElementText(`csp-pessoas-${roomId}`, window.systemConstants?.AUX_OCp_Csp.value || 86.5);
  updateElementText(`clp-pessoas-${roomId}`, window.systemConstants?.AUX_OCp_Clp.value || 133.3);
  updateElementText(`o-pessoas-${roomId}`, inputData.numPessoas || 0);
  updateElementText(`fs-pessoas-${roomId}`, 100);
  updateElementText(`ganho-pessoas-${roomId}`, Math.ceil(gains.pessoas));
  updateElementText(`total-pessoas-${roomId}`, totals.pessoas);

  const densiAr = window.systemConstants?.Densi_ar || 1.17;
  const m_ArExterno = (inputData.vazaoArExterno || 0) * 3.6 * densiAr * 1000;

  updateElementText(`m-ar-sensivel-${roomId}`, Math.ceil(m_ArExterno));
  updateElementText(`c-ar-sensivel-${roomId}`, window.systemConstants?.AUX_c_ArExterno.value || 0.24);
  updateElementText(`deltat-ar-sensivel-${roomId}`, window.systemConstants?.AUX_deltaT_ArExterno.value || 10);
  updateElementText(`ganho-ar-sensivel-${roomId}`, Math.ceil(gains.arSensivel));
  updateElementText(`total-ar-sensivel-${roomId}`, totals.arSensivel);

  updateElementText(`var-ar-latente-${roomId}`, inputData.vazaoArExterno || 0);
  updateElementText(`f-ar-latente-${roomId}`, window.systemConstants?.AUX_f_ArExterno.value || 3.01);
  updateElementText(`deltaua-ar-latente-${roomId}`, window.systemConstants?.AUX_deltaUa_ArExterno.value || 8.47);
  updateElementText(`ganho-ar-latente-${roomId}`, Math.ceil(gains.arLatente));
  updateElementText(`total-ar-latente-${roomId}`, totals.arLatente);

  updateElementText(`total-externo-${roomId}`, totals.externo);
  updateElementText(`total-divisoes-${roomId}`, totals.divisoes);
  
  console.log(`‚úÖ Display t√©rmico atualizado para sala: ${roomId}`);
}

/**
 * üîç FUN√á√ïES AUXILIARES DE BUSCA (thermalCalculations.js)
 */

function findRoomContentThermal(roomId) {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (findRoomContentThermal) thermalCalculations.js [ID de sala inv√°lido: ${roomId}]`);
        return null;
    }
    
    console.log(`üîç [THERMAL] Procurando sala: "${roomId}"`);
    
    let roomContent = document.getElementById(`room-content-${roomId}`);
    
    if (roomContent) {
        console.log(`‚úÖ [THERMAL] Sala encontrada pelo ID: room-content-${roomId}`);
        return roomContent;
    }
    
    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    
    if (roomBlock) {
        const foundId = roomBlock.dataset.roomId;
        console.log(`‚úÖ [THERMAL] Sala encontrada pelo data-room-id: ${foundId}`);
        
        const finalRoomContent = document.getElementById(`room-content-${foundId}`);
        if (finalRoomContent) {
            return finalRoomContent;
        }
    }
  
    console.error(`‚ùå [THERMAL] Sala n√£o encontrada: ${roomId}`);
    const allRooms = document.querySelectorAll('.room-block');
    console.log('üîç [THERMAL] Todas as salas dispon√≠veis no DOM:');
    allRooms.forEach(room => {
        console.log(`  - ID: "${room.dataset.roomId}", Nome: "${room.dataset.roomName}", Projeto: "${room.dataset.projectId}", Obra: "${room.dataset.obraId}"`);
    });
    
    return null;
}

function calculateUValues(tipoConstrucao) {
  const U_VALUE_ALVENARIA_TETO = 3.961;
  const U_VALUE_ALVENARIA_PAREDE = 2.546;
  const U_VALUE_LA_ROCHA_TETO = 1.145;
  const U_VALUE_LA_ROCHA_PAREDE = 1.12;

  console.log(`[THERMAL UVALUES] tipoConstrucao recebido: "${tipoConstrucao}"`);

  let uValueParede, uValueTeto;

  const tipoLower = tipoConstrucao ? tipoConstrucao.toLowerCase() : "";
  
  if (tipoLower === "eletrocentro") {
    uValueParede = U_VALUE_LA_ROCHA_PAREDE;
    uValueTeto = U_VALUE_LA_ROCHA_TETO;
  } else if (tipoLower === "alvenaria") {
    uValueParede = U_VALUE_ALVENARIA_PAREDE;
    uValueTeto = U_VALUE_ALVENARIA_TETO;
  } else {
    uValueParede = 0;
    uValueTeto = 0;
  }

  const result = {
    parede: uValueParede,
    teto: uValueTeto,
    piso: window.systemConstants?.AUX_U_Value_Piso.value || 2.7,
  };

  console.log("[THERMAL UVALUES] UValues calculados:", result);
  return result;
}

function calculateAuxiliaryVariables(inputData) {
  const vazaoArExterno = safeNumber(inputData.vazaoArExterno);
  const densiAr = window.systemConstants?.Densi_ar.value || 1.17;

  const m_ArExterno = vazaoArExterno * 3.6 * densiAr * 1000;

  return {
    m_ArExterno: m_ArExterno,
    vazaoArExterno: vazaoArExterno
  };
}

/**
 * üéØ FUN√á√ÉO PRINCIPAL DE C√ÅLCULO (thermalCalculations.js)
 */

async function calculateThermalGains(roomId, vazaoArExterno = 0) {
  try {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (calculateThermalGains) thermalCalculations.js [ID de sala inv√°lido: ${roomId}]`);
        return;
    }
    
    console.log(`üî• [THERMAL] Iniciando c√°lculos para sala: ${roomId}`);
    
    await waitForSystemConstants();

    if (!validateSystemConstants()) {
      console.error(`[THERMAL] validateSystemConstants FALHOU para ${roomId}`);
      return;
    }

    const roomContent = findRoomContentThermal(roomId);
    if (!roomContent) {
      console.error(`[THERMAL] room-content-${roomId} N√ÉO ENCONTRADO`);
      return;
    }

    const climaSection = roomContent.querySelector('[id*="-clima"]');
    if (!climaSection) {
      console.error(`[THERMAL] Se√ß√£o clima N√ÉO ENCONTRADA para ${roomId}`);
      return;
    }

    const inputData = collectClimatizationInputs(climaSection, roomId);

    const calcData = {
      ...inputData,
      area: safeNumber(inputData.area),
      paredeOeste: safeNumber(inputData.paredeOeste),
      paredeLeste: safeNumber(inputData.paredeLeste),
      paredeNorte: safeNumber(inputData.paredeNorte),
      paredeSul: safeNumber(inputData.paredeSul),
      peDireito: safeNumber(inputData.peDireito),
      divisoriaNaoClima1: safeNumber(inputData.divisoriaNaoClima1),
      divisoriaNaoClima2: safeNumber(inputData.divisoriaNaoClima2),
      divisoriaClima1: safeNumber(inputData.divisoriaClima1),
      divisoriaClima2: safeNumber(inputData.divisoriaClima2),
      dissipacao: safeNumber(inputData.dissipacao),
      numPessoas: safeNumber(inputData.numPessoas),
      vazaoArExterno: vazaoArExterno
    };

    const uValues = calculateUValues(calcData.tipoConstrucao);
    const auxVars = calculateAuxiliaryVariables({...calcData, vazaoArExterno});

    const gains = {
      teto: calculateCeilingGain(calcData.area, uValues.teto, window.systemConstants.deltaT_teto.value),
      paredeOeste: calculateWallGain(calcData.paredeOeste, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Oes.value),
      paredeLeste: calculateWallGain(calcData.paredeLeste, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Les.value),
      paredeNorte: calculateWallGain(calcData.paredeNorte, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Nor.value),
      paredeSul: calculateWallGain(calcData.paredeSul, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Sul.value),
      divisoriaNaoClima1: calculatePartitionGain(calcData.divisoriaNaoClima1, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_N_clim1.value),
      divisoriaNaoClima2: calculatePartitionGain(calcData.divisoriaNaoClima2, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_N_clim2.value),
      divisoriaClima1: calculatePartitionGain(calcData.divisoriaClima1, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_clim1.value),
      divisoriaClima2: calculatePartitionGain(calcData.divisoriaClima2, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_clim2.value),
      piso: calculateFloorGain(calcData.area, window.systemConstants),
      iluminacao: calculateLightingGain(calcData.area, window.systemConstants),
      dissipacao: calculateDissipationGain(calcData.dissipacao, window.systemConstants),
      pessoas: calculatePeopleGain(calcData.numPessoas, window.systemConstants),
      arSensivel: calculateExternalAirSensibleGain(vazaoArExterno, auxVars, window.systemConstants),
      arLatente: calculateExternalAirLatentGain(vazaoArExterno, window.systemConstants),
    };

    const totals = calculateTotals(gains);

    console.log(`üî• [THERMAL] Ganhos calculados para ${roomId}:`, gains);
    console.log(`üî• [THERMAL] Totais para ${roomId}:`, totals);
    console.log("üî• [THERMAL] ===== FIM DO C√ÅLCULO DE GANHOS T√âRMICOS =====");

    updateThermalGainsDisplay(roomId, gains, totals, uValues, {...inputData, vazaoArExterno});

  console.log(`üî• [THERMAL] Atualizando capacidade para ${roomId}`);
  setTimeout(() => {
    if (typeof window.updateCapacityFromThermalGains === 'function') {
      const success = window.updateCapacityFromThermalGains(roomId);
      if (success) {
        console.log(`‚úÖ [THERMAL] Capacidade atualizada com sucesso para ${roomId}`);
      } else {
        console.log(`‚ö†Ô∏è [THERMAL] Aguardando carga t√©rmica para ${roomId}`);
      }
    } else {
      console.log(`‚ÑπÔ∏è [THERMAL] Fun√ß√£o de capacidade ainda n√£o dispon√≠vel para ${roomId}`);
      // Tenta novamente em 1 segundo
      setTimeout(() => {
        if (typeof window.updateCapacityFromThermalGains === 'function') {
          window.updateCapacityFromThermalGains(roomId);
        }
      }, 1000);
    }
  }, 500);
    
  } catch (error) {
    console.error(`[THERMAL] Erro em calculateThermalGains para ${roomId}:`, error);
  }
}

/**
 * üåê EXPORTA√á√ïES E COMPATIBILIDADE GLOBAL
 */

// Exporta√ß√µes para m√≥dulos ES6
export {
  calculateThermalGains,
  calculateUValues,
  calculateAuxiliaryVariables,
  findRoomContentThermal,
  calculateCeilingGain,
  calculateWallGain,
  calculatePartitionGain,
  calculateFloorGain,
  calculateLightingGain,
  calculateDissipationGain,
  calculatePeopleGain,
  calculateExternalAirSensibleGain,
  calculateExternalAirLatentGain,
  calculateTotals,
  updateThermalGainsDisplay,
  updateWallDisplay,
  updatePartitionDisplay
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
  window.calculateThermalGains = calculateThermalGains;
  window.calculateUValues = calculateUValues;
  window.calculateAuxiliaryVariables = calculateAuxiliaryVariables;
  window.findRoomContentThermal = findRoomContentThermal;
  window.calculateCeilingGain = calculateCeilingGain;
  window.calculateWallGain = calculateWallGain;
  window.calculatePartitionGain = calculatePartitionGain;
  window.calculateFloorGain = calculateFloorGain;
  window.calculateLightingGain = calculateLightingGain;
  window.calculateDissipationGain = calculateDissipationGain;
  window.calculatePeopleGain = calculatePeopleGain;
  window.calculateExternalAirSensibleGain = calculateExternalAirSensibleGain;
  window.calculateExternalAirLatentGain = calculateExternalAirLatentGain;
  window.calculateTotals = calculateTotals;
  window.updateThermalGainsDisplay = updateThermalGainsDisplay;
  window.updateWallDisplay = updateWallDisplay;
  window.updatePartitionDisplay = updatePartitionDisplay;
}
/* ==== FIM: features/calculations/thermal-gains.js ==== */
