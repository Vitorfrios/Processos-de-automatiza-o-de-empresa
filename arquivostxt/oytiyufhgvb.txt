
/* ==== IN√çCIO: json-editor.js ==== */
/* ==== IN√çCIO: json-editor.js ==== */
/* ==== json-editor.js ==== */
// json-editor.js - VERS√ÉO CORRIGIDA COM DUTOS COMO ARRAY

// ==================== ESTADO GLOBAL ====================
window.stagingData = null;
window.hasPendingChanges = false;
let isInitialized = false;

// ==================== OTIMIZA√á√ïES ====================
let updateTimeout = null;
let layoutTimeout = null;
let lastLineCount = 0;

// Cache de elementos DOM
let domCache = {
    editor: null,
    lineNumbers: null,
    jsonContainer: null,
    applyButton: null,
    status: null
};

// ==================== FUN√á√ïES AUXILIARES ====================

/**
 * Inicializa o cache de elementos DOM
 */
function initDomCache() {
    domCache.editor = document.getElementById('jsonEditor');
    domCache.lineNumbers = document.getElementById('lineNumbers');
    domCache.jsonContainer = document.querySelector('.json-container');
    domCache.applyButton = document.getElementById('applyJsonBtn');
    domCache.status = document.getElementById('jsonStatus');
}

/**
 * Valida e garante estrutura m√≠nima do systemData (CORRIGIDA - DUTOS COMO ARRAY)
 */
function validateAndEnsureStructure(data) {
    if (!data || typeof data !== 'object') {
        data = {};
    }
    
    // Garante que todos os campos obrigat√≥rios existam
    const requiredFields = {
        constants: {},
        machines: [],
        materials: {},
        empresas: [],
        banco_equipamentos: {},
        dutos: []  // CORRIGIDO: campo para dutos como array
    };
    
    Object.keys(requiredFields).forEach(field => {
        if (data[field] === undefined) {
            console.log(`üîç ${field} n√£o encontrado, criando...`);
            data[field] = Array.isArray(requiredFields[field]) ? [] : {};
        }
    });
    
    return data;
}

// ==================== FUN√á√ïES PRINCIPAIS ====================

/**
 * Atualiza os n√∫meros das linhas com debouncing
 */
export function updateLineNumbers() {
    if (updateTimeout) clearTimeout(updateTimeout);
    
    updateTimeout = setTimeout(() => {
        if (!domCache.editor || !domCache.lineNumbers) {
            initDomCache();
            if (!domCache.editor || !domCache.lineNumbers) return;
        }

        try {
            const text = domCache.editor.value;
            const lines = text.split('\n');
            const totalLines = Math.max(lines.length, 1);

            if (totalLines === lastLineCount && lastLineCount > 0) {
                return;
            }

            lastLineCount = totalLines;

            let numbersHTML = '';
            for (let i = 1; i <= totalLines; i++) {
                numbersHTML += `<div data-line="${i}">${i}</div>`;
            }

            domCache.lineNumbers.innerHTML = numbersHTML;

            const lineHeight = 20;
            const padding = 32;
            const contentHeight = (totalLines * lineHeight) + padding;
            const finalHeight = Math.max(contentHeight, 200);

            domCache.editor.style.height = finalHeight + 'px';
            domCache.lineNumbers.style.height = finalHeight + 'px';

        } catch (error) {
            console.error('Erro ao atualizar n√∫meros das linhas:', error);
        }
    }, 50);
}

/**
 * Ajusta o layout do editor com debouncing
 */
export function adjustEditorLayout() {
    if (layoutTimeout) clearTimeout(layoutTimeout);
    
    layoutTimeout = setTimeout(() => {
        updateLineNumbers();
        
        if (!domCache.editor || !domCache.jsonContainer) return;

        const lines = domCache.editor.value.split('\n');
        if (lines.length > 100) return;

        const tempSpan = document.createElement('span');
        tempSpan.style.cssText = `
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
            visibility: hidden;
            position: absolute;
            white-space: pre;
            pointer-events: none;
        `;
        document.body.appendChild(tempSpan);

        let maxLineWidth = 0;
        const linesToCheck = Math.min(lines.length, 1000);
        for (let i = 0; i < linesToCheck; i++) {
            tempSpan.textContent = lines[i];
            maxLineWidth = Math.max(maxLineWidth, tempSpan.offsetWidth);
        }

        document.body.removeChild(tempSpan);

        const totalWidth = maxLineWidth + 32;
        if (totalWidth > domCache.editor.clientWidth && 
            domCache.jsonContainer.scrollWidth <= domCache.jsonContainer.clientWidth) {
            setTimeout(() => {
                if (domCache.jsonContainer) {
                    domCache.jsonContainer.style.overflowX = 'auto';
                }
            }, 50);
        }
    }, 100);
}

/**
 * Destaca uma linha espec√≠fica
 */
export function highlightLine(lineNumber, type = 'error') {
    if (!domCache.lineNumbers) {
        initDomCache();
        if (!domCache.lineNumbers) return;
    }

    const lines = domCache.lineNumbers.querySelectorAll('div');
    lines.forEach(line => line.className = '');

    if (lineNumber > 0 && lineNumber <= lines.length) {
        const lineElement = lines[lineNumber - 1];
        lineElement.classList.add(`${type}-line`);
        scrollToLine(lineNumber);
    }
}

/**
 * Faz scroll para uma linha espec√≠fica
 */
function scrollToLine(lineNumber) {
    if (!domCache.jsonContainer) {
        initDomCache();
        if (!domCache.jsonContainer) return;
    }

    const lineHeight = 20;
    const scrollPosition = (lineNumber - 1) * lineHeight;
    
    domCache.jsonContainer.scrollTo({
        top: Math.max(0, scrollPosition - 100),
        behavior: 'smooth'
    });
}

// ==================== INICIALIZA√á√ÉO DO EDITOR ====================

/**
 * Inicializa o editor JSON
 */
export function initJSONEditor() {
    console.log('üöÄ Inicializando editor JSON...');

    if (isInitialized) {
        console.log('‚ö†Ô∏è Editor j√° inicializado');
        return;
    }

    initDomCache();

    if (!domCache.editor) {
        console.error('‚ùå Elemento #jsonEditor n√£o encontrado!');
        return;
    }

    // Configura√ß√µes iniciais
    domCache.editor.spellcheck = false;
    domCache.editor.autocomplete = 'off';
    domCache.editor.autocorrect = 'off';
    domCache.editor.autocapitalize = 'off';

    // Carrega dados iniciais
    let initialContent = '';
    
    console.log('üîç Verificando window.systemData...');
    console.log('üîç systemData:', window.systemData);
    
    if (window.systemData && typeof window.systemData === 'object') {
        try {
            // Valida e garante estrutura
            const validatedData = validateAndEnsureStructure(window.systemData);
            console.log('‚úÖ Dados validados:', {
                constants: Object.keys(validatedData.constants).length,
                machines: validatedData.machines.length,
                materials: Object.keys(validatedData.materials).length,
                empresas: validatedData.empresas.length,
                banco_equipamentos: Object.keys(validatedData.banco_equipamentos).length,
                dutos: validatedData.dutos.length  // CORRIGIDO
            });
            
            initialContent = JSON.stringify(validatedData, null, 2);
            console.log('‚úÖ Conte√∫do inicial gerado');
            
        } catch (error) {
            console.error('‚ùå Erro ao processar systemData:', error);
            initialContent = JSON.stringify(validateAndEnsureStructure({}), null, 2);
        }
    } else {
        console.warn('‚ö†Ô∏è window.systemData n√£o encontrado');
        initialContent = JSON.stringify(validateAndEnsureStructure({}), null, 2);
    }
    
    domCache.editor.value = initialContent;

    // Event listeners
    domCache.editor.addEventListener('input', () => {
        window.hasPendingChanges = true;
        updateApplyButtonState();
        updateLineNumbers();
        adjustEditorLayout();
    });

    // Observa redimensionamento
    window.addEventListener('resize', () => {
        updateLineNumbers();
        adjustEditorLayout();
    });

    // Inicializa√ß√£o inicial
    setTimeout(() => {
        updateLineNumbers();
        adjustEditorLayout();
        updateJSONStatus('‚úÖ Editor JSON pronto. Digite ou cole seu JSON.', 'success');
        isInitialized = true;
        console.log('‚úÖ Editor JSON inicializado com sucesso');
    }, 100);
}

/**
 * Fun√ß√£o para for√ßar atualiza√ß√£o de layout
 */
export function forceLayoutUpdate() {
    console.log('üîß For√ßando atualiza√ß√£o de layout...');
    updateLineNumbers();
    adjustEditorLayout();
}

/**
 * Atualiza o estado do bot√£o "Aplicar JSON"
 */
export function updateApplyButtonState() {
    if (!domCache.applyButton) {
        initDomCache();
        if (!domCache.applyButton) return;
    }

    if (window.hasPendingChanges) {
        domCache.applyButton.disabled = false;
        domCache.applyButton.classList.remove('disabled');
        domCache.applyButton.innerHTML = '<i class="icon-check"></i> Aplicar JSON';
        domCache.applyButton.title = 'Aplicar altera√ß√µes do JSON';
    } else {
        domCache.applyButton.disabled = true;
        domCache.applyButton.classList.add('disabled');
        domCache.applyButton.innerHTML = '<i class="icon-check"></i> Nada para aplicar';
        domCache.applyButton.title = 'Nenhuma altera√ß√£o pendente';
    }
}

/**
 * Atualiza a mensagem de status
 */
export function updateJSONStatus(message, type = 'info') {
    if (!domCache.status) {
        initDomCache();
        if (!domCache.status) return;
    }

    domCache.status.textContent = message;
    domCache.status.className = 'json-status';
    domCache.status.classList.add(type);
}

// ==================== FUN√á√ïES DE FORMATAR/VALIDAR ====================

/**
 * Formata o JSON no editor
 */
export function formatJSON() {
    if (!domCache.editor) return;

    try {
        const parsed = JSON.parse(domCache.editor.value);
        domCache.editor.value = JSON.stringify(parsed, null, 2);

        forceLayoutUpdate();
        highlightLine(-1);
        updateJSONStatus('‚úÖ JSON formatado com sucesso!', 'success');

        window.hasPendingChanges = true;
        updateApplyButtonState();

    } catch (error) {
        const errorLine = findErrorLine(domCache.editor.value, error);
        if (errorLine > 0) highlightLine(errorLine, 'error');
        updateJSONStatus(`‚ùå Erro de formata√ß√£o: ${error.message}`, 'error');
    }
}

/**
 * Valida o JSON no editor (CORRIGIDA - DUTOS COMO ARRAY)
 */
export function validateJSON() {
    if (!domCache.editor) return false;

    try {
        const parsed = JSON.parse(domCache.editor.value);
        const validation = validateJSONStructure(parsed);

        if (!validation.valid) {
            throw new Error(validation.errors.join('; '));
        }

        highlightLine(-1);
        updateJSONStatus('‚úÖ JSON v√°lido e com estrutura correta', 'success');
        return true;

    } catch (error) {
        const errorLine = findErrorLine(domCache.editor.value, error);
        if (errorLine > 0) highlightLine(errorLine, 'error');
        updateJSONStatus(`‚ùå JSON inv√°lido: ${error.message}`, 'error');
        return false;
    }
}

/**
 * Encontra a linha de um erro no JSON
 */
export function findErrorLine(jsonString, error) {
    if (!error || !error.message || !jsonString) return -1;

    try {
        const patterns = [
            /position (\d+)/,
            /at line (\d+)/,
            /line (\d+)/,
            /linha (\d+)/
        ];

        for (const pattern of patterns) {
            const match = error.message.match(pattern);
            if (match && match[1]) {
                return parseInt(match[1]);
            }
        }

        if (error.message.includes('position')) {
            const positionMatch = error.message.match(/position (\d+)/);
            if (positionMatch) {
                const position = parseInt(positionMatch[1]);
                const lines = jsonString.substring(0, position).split('\n');
                return lines.length;
            }
        }
    } catch (e) {
        console.error('Erro ao encontrar linha:', e);
    }

    return -1;
}

/**
 * Valida a estrutura do JSON (CORRIGIDA - DUTOS COMO ARRAY)
 */
export function validateJSONStructure(data) {
    const errors = [];

    if (!data.constants || typeof data.constants !== 'object') {
        errors.push('"constants" deve ser um objeto');
    }

    if (!data.machines || !Array.isArray(data.machines)) {
        errors.push('"machines" deve ser um array');
    }

    if (!data.materials || typeof data.materials !== 'object') {
        errors.push('"materials" deve ser um objeto');
    }

    if (!data.empresas || !Array.isArray(data.empresas)) {
        errors.push('"empresas" deve ser um array');
    }

    if (!data.banco_equipamentos || typeof data.banco_equipamentos !== 'object') {
        errors.push('"banco_equipamentos" deve ser um objeto');
    }

    // CORRIGIDO: dutos deve ser um array
    if (!data.dutos || !Array.isArray(data.dutos)) {
        errors.push('"dutos" deve ser um array');
    }

    return {
        valid: errors.length === 0,
        errors
    };
}

/**
 * Converte arquivo para base64
 */
export function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
        };
        reader.onerror = reject;
    });
}

/**
 * Limpa e reinicializa o editor
 */
export function resetJSONEditor() {
    console.log('üîÑ Reinicializando editor JSON...');
    
    isInitialized = false;

    if (domCache.editor) {
        if (window.systemData && typeof window.systemData === 'object') {
            const validatedData = validateAndEnsureStructure(window.systemData);
            domCache.editor.value = JSON.stringify(validatedData, null, 2);
            console.log('‚úÖ Editor resetado com dados validados');
        }
    }

    if (domCache.lineNumbers) {
        domCache.lineNumbers.innerHTML = '';
    }

    setTimeout(initJSONEditor, 50);
}

// ==================== DEBUG FUNCTIONS ====================

window.debugSystemData = function() {
    console.log('=== DEBUG SYSTEMDATA ===');
    console.log('systemData:', window.systemData);
    console.log('Tem dutos?', 'dutos' in (window.systemData || {}));
    console.log('dutos √© array?', Array.isArray(window.systemData?.dutos));
    console.log('N√∫mero de dutos:', (window.systemData?.dutos || []).length);
    console.log('Dutos detalhados:', window.systemData?.dutos);
    
    const editor = document.getElementById('jsonEditor');
    if (editor && editor.value) {
        try {
            const parsed = JSON.parse(editor.value);
            console.log('Editor tem dutos?', 'dutos' in parsed);
            console.log('Editor dutos √© array?', Array.isArray(parsed?.dutos));
            console.log('Dutos no editor:', (parsed?.dutos || []).length);
            console.log('Detalhes dutos editor:', parsed?.dutos);
        } catch(e) {
            console.error('Erro ao parsear editor:', e);
        }
    }
};

// ==================== EXPORTA√á√ÉO GLOBAL ====================

window.updateLineNumbers = updateLineNumbers;
window.highlightLine = highlightLine;
window.formatJSON = formatJSON;
window.validateJSON = validateJSON;
window.updateJSONStatus = updateJSONStatus;
window.resetJSONEditor = resetJSONEditor;
window.forceLayoutUpdate = forceLayoutUpdate;
window.initJSONEditor = initJSONEditor;
window.fileToBase64 = fileToBase64;
window.validateJSONStructure = validateJSONStructure;

// ==================== INICIALIZA√á√ÉO AUTOM√ÅTICA ====================

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initJSONEditor, 300);
    });
} else {
    setTimeout(initJSONEditor, 300);
}

// Event listeners para recarregar dados
window.addEventListener('dataLoaded', () => {
    setTimeout(() => {
        resetJSONEditor();
        updateApplyButtonState();
    }, 200);
});

window.addEventListener('dataImported', () => {
    setTimeout(() => {
        resetJSONEditor();
        updateApplyButtonState();
    }, 200);
});

window.addEventListener('dataApplied', () => {
    setTimeout(() => {
        resetJSONEditor();
        updateApplyButtonState();
    }, 200);
});

/* ==== FIM: json-editor.js ==== */
/* ==== FIM: json-editor.js ==== */

/* ==== IN√çCIO: json-import-export.js ==== */
// json-import-export.js - Vers√£o simplificada

export function exportToJSON() {
    console.log('üì§ Exportando JSON...');
    try {
        const systemData = window.systemData || {};
        console.log('üìä Dados para exporta√ß√£o:', {
            constants: Object.keys(systemData.constants || {}).length,
            machines: systemData.machines?.length || 0,
            materials: Object.keys(systemData.materials || {}).length,
            empresas: systemData.empresas?.length || 0,
            banco_equipamentos: Object.keys(systemData.banco_equipamentos || {}).length,
            dutos: systemData.dutos?.length || 0
        });
        
        const dataStr = JSON.stringify(systemData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `sistema_dados_${new Date().toISOString().slice(0,10)}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.style.display = 'none';
        document.body.appendChild(linkElement);
        linkElement.click();
        document.body.removeChild(linkElement);
        
        if (window.showSuccess) {
            window.showSuccess('JSON exportado com sucesso!');
        } else {
            alert('JSON exportado com sucesso!');
        }
        
        console.log('‚úÖ JSON exportado com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao exportar JSON:', error);
        
        if (window.showError) {
            window.showError('Erro ao exportar JSON.');
        } else {
            alert('Erro ao exportar JSON.');
        }
    }
}

export function importFromJSON() {
    console.log('üì• Importando JSON...');
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.style.display = 'none';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                console.log('üìÅ Arquivo selecionado:', file.name);
                
                const importedData = JSON.parse(e.target.result);
                
                // Validar estrutura
                const requiredKeys = ['constants', 'machines', 'materials', 'empresas', 'banco_equipamentos', 'dutos'];
                const missingKeys = requiredKeys.filter(key => !(key in importedData));
                
                if (missingKeys.length > 0) {
                    throw new Error(`Campos ausentes: ${missingKeys.join(', ')}`);
                }
                
                console.log('‚úÖ JSON v√°lido:', {
                    constants: Object.keys(importedData.constants || {}).length,
                    machines: importedData.machines?.length || 0,
                    materials: Object.keys(importedData.materials || {}).length,
                    empresas: importedData.empresas?.length || 0,
                    banco_equipamentos: Object.keys(importedData.banco_equipamentos || {}).length,
                    dutos: importedData.dutos?.length || 0
                });
                
                // Armazenar em staging
                window.stagingData = importedData;
                window.hasPendingChanges = true;
                
                // Exibir no editor
                const editor = document.getElementById('jsonEditor');
                if (editor) {
                    editor.value = JSON.stringify(importedData, null, 2);
                    
                    if (window.updateLineNumbers) {
                        window.updateLineNumbers();
                    }
                    
                    if (window.switchTab) {
                        window.switchTab('raw');
                    }
                }
                
                if (window.showWarning) {
                    window.showWarning('JSON carregado na √°rea de staging.');
                }
                
                if (window.updateJSONStatus) {
                    window.updateJSONStatus('JSON carregado em staging.', 'warning');
                }
                
                if (window.updateApplyButtonState) {
                    window.updateApplyButtonState();
                }
                
                console.log('‚úÖ JSON importado para staging');
                
            } catch (error) {
                console.error('‚ùå Erro ao importar JSON:', error);
                
                if (window.showError) {
                    window.showError(`Erro ao importar JSON: ${error.message}`);
                } else {
                    alert(`Erro ao importar JSON: ${error.message}`);
                }
                
                if (window.updateJSONStatus) {
                    window.updateJSONStatus(`‚ùå JSON inv√°lido: ${error.message}`, 'error');
                }
            }
        };
        
        reader.onerror = function() {
            console.error('‚ùå Erro ao ler o arquivo');
            if (window.showError) {
                window.showError('Erro ao ler o arquivo.');
            } else {
                alert('Erro ao ler o arquivo.');
            }
        };
        
        reader.readAsText(file);
    };
    
    document.body.appendChild(input);
    input.click();
    
    setTimeout(() => {
        if (document.body.contains(input)) {
            document.body.removeChild(input);
        }
    }, 100);
}

export function exportToExcel() {
    console.log('üì§ Exportando Excel...');
    
    try {
        const systemData = window.systemData || {};
        
        // Validar dados
        const requiredKeys = ['constants', 'machines', 'materials', 'empresas', 'banco_equipamentos', 'dutos'];
        const missingKeys = requiredKeys.filter(key => !(key in systemData));
        
        if (missingKeys.length > 0) {
            throw new Error(`Dados incompletos: ${missingKeys.join(', ')}`);
        }
        
        console.log('üìä Dados para exporta√ß√£o Excel:', {
            dutos: systemData.dutos?.length || 0
        });
        
        // Chamar API para gerar Excel
        fetch('/api/excel/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(systemData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Decodificar base64
                const binaryString = atob(result.data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                const blob = new Blob([bytes], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                const url = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = result.filename || 'sistema_export.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                console.log('‚úÖ Excel exportado com sucesso!');
                
                if (window.showSuccess) {
                    window.showSuccess('Excel exportado com sucesso!');
                } else {
                    alert('Excel exportado com sucesso!');
                }
                
            } else {
                throw new Error(result.error || 'Erro na gera√ß√£o');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao exportar Excel:', error);
            
            if (window.showError) {
                window.showError(`Erro ao exportar Excel: ${error.message}`);
            } else {
                alert(`Erro ao exportar Excel: ${error.message}`);
            }
        });
        
    } catch (error) {
        console.error('‚ùå Erro ao exportar Excel:', error);
        
        if (window.showError) {
            window.showError(`Erro ao exportar Excel: ${error.message}`);
        } else {
            alert(`Erro ao exportar Excel: ${error.message}`);
        }
    }
}

export function importFromExcel() {
    console.log('üì• Importando Excel...');
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx,.xls';
    input.style.display = 'none';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            const errorMsg = 'Selecione um arquivo Excel (.xlsx ou .xls)';
            console.error('‚ùå', errorMsg);
            
            if (window.showError) {
                window.showError(errorMsg);
            } else {
                alert(errorMsg);
            }
            return;
        }
        
        console.log('üìÅ Arquivo Excel selecionado:', file.name);
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
            const base64 = e.target.result.split(',')[1];
            
            fetch('/api/excel/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: file.name,
                    file: base64
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                if (!result.success) {
                    throw new Error(result.error || 'Erro na convers√£o');
                }
                
                console.log('‚úÖ Excel convertido:', {
                    dutos: result.data.dutos?.length || 0
                });
                
                // Armazenar em staging
                window.stagingData = result.data;
                window.hasPendingChanges = true;
                
                // Exibir no editor
                const editor = document.getElementById('jsonEditor');
                if (editor) {
                    editor.value = JSON.stringify(result.data, null, 2);
                    
                    if (window.updateLineNumbers) {
                        window.updateLineNumbers();
                    }
                    
                    if (window.switchTab) {
                        window.switchTab('raw');
                    }
                }
                
                console.log('‚úÖ Excel convertido e carregado em staging');
                
                if (window.showSuccess) {
                    window.showSuccess('Excel convertido para JSON!');
                } else {
                    alert('Excel convertido para JSON!');
                }
                
                if (window.updateJSONStatus) {
                    window.updateJSONStatus('‚úÖ Excel convertido.', 'success');
                }
                
                if (window.updateApplyButtonState) {
                    window.updateApplyButtonState();
                }
                
            })
            .catch(error => {
                console.error('‚ùå Erro ao importar Excel:', error);
                
                if (window.showError) {
                    window.showError(`Erro ao importar Excel: ${error.message}`);
                } else {
                    alert(`Erro ao importar Excel: ${error.message}`);
                }
                
                if (window.updateJSONStatus) {
                    window.updateJSONStatus(`‚ùå Erro: ${error.message}`, 'error');
                }
            });
        };
        
        reader.onerror = function() {
            console.error('‚ùå Erro ao ler arquivo Excel');
            
            if (window.showError) {
                window.showError('Erro ao ler o arquivo Excel.');
            } else {
                alert('Erro ao ler o arquivo Excel.');
            }
        };
    };
    
    document.body.appendChild(input);
    input.click();
    
    setTimeout(() => {
        if (document.body.contains(input)) {
            document.body.removeChild(input);
        }
    }, 100);
}

// Exportar fun√ß√µes para o escopo global
if (typeof window !== 'undefined') {
    window.exportToJSON = exportToJSON;
    window.importFromJSON = importFromJSON;
    window.exportToExcel = exportToExcel;
    window.importFromExcel = importFromExcel;
    
    console.log('‚úÖ Fun√ß√µes de import/export expostas globalmente');
}
/* ==== FIM: json-import-export.js ==== */

/* ==== IN√çCIO: json-utils.js ==== */
/* ==== IN√çCIO: json-utils.js ==== */
// json-utils.js - Arquivo principal que coordena tudo (CORRIGIDO COM DUTOS COMO ARRAY)

// ==================== FUN√á√ïES AUXILIARES ====================

/**
 * Garante estrutura completa dos dados (CORRIGIDA - DUTOS COMO ARRAY)
 */
function ensureCompleteData(data) {
    if (!data || typeof data !== 'object') {
        return createDefaultData();
    }
    
    return {
        constants: data.constants || {},
        machines: data.machines || [],
        materials: data.materials || {},
        empresas: data.empresas || [],
        banco_equipamentos: data.banco_equipamentos || {},
        dutos: data.dutos || []  // CORRIGIDO: array vazio
    };
}

/**
 * Cria dados padr√£o com estrutura completa (CORRIGIDA - DUTOS COMO ARRAY)
 */
function createDefaultData() {
    return {
        constants: {},
        machines: [],
        materials: {},
        empresas: [],
        banco_equipamentos: {},
        dutos: []  // CORRIGIDO: array vazio
    };
}

/**
 * Valida e garante que os dados tenham estrutura completa
 */
function validateAndEnsureCompleteData(data) {
    const result = ensureCompleteData(data);
    
    // Log para debug
    console.log('üîç Validando dados:', {
        constants: Object.keys(result.constants).length,
        machines: result.machines.length,
        materials: Object.keys(result.materials).length,
        empresas: result.empresas.length,
        banco_equipamentos: Object.keys(result.banco_equipamentos).length,
        dutos: result.dutos.length  // CORRIGIDO
    });
    
    return result;
}

// ==================== FUN√á√ÉO APLICAR JSON ====================

export async function applyJSON() {
    const editor = document.getElementById('jsonEditor');
    if (!editor) {
        if (window.showError) window.showError('Editor JSON n√£o encontrado');
        return;
    }

    try {
        const proposedData = JSON.parse(editor.value);
        
        // Usar a fun√ß√£o de valida√ß√£o do json-editor.js
        let validation;
        if (window.validateJSONStructure) {
            validation = window.validateJSONStructure(proposedData);
        } else {
            // Fallback b√°sico
            validation = {
                valid: true,
                errors: []
            };
        }

        if (!validation.valid) {
            if (window.showError) window.showError('JSON inv√°lido. Corrija os erros antes de aplicar.');
            if (window.updateJSONStatus) window.updateJSONStatus(`‚ùå JSON inv√°lido: ${validation.errors.join(', ')}`, 'error');
            return;
        }

        const currentData = window.systemData || {};
        const hasCurrentData = Object.keys(currentData).length > 0;

        if (hasCurrentData) {
            const comparison = await compareJSONData(currentData, proposedData);

            if (!comparison.summary.has_changes) {
                if (window.showWarning) window.showWarning('Nenhuma altera√ß√£o detectada.');
                return;
            }

            const confirmed = await showJsonConfirmationModal(comparison);

            if (!confirmed) {
                if (window.showWarning) window.showWarning('Aplica√ß√£o cancelada.');
                return;
            }

            const applied = applyChangesIncremental(currentData, proposedData, comparison.differences);

            if (applied) {
                // ‚úÖ GARANTIR ESTRUTURA COMPLETA
                const completeData = validateAndEnsureCompleteData(currentData);
                
                window.systemData = completeData;
                window.stagingData = null;
                window.hasPendingChanges = false;

                await saveSystemData(completeData);

                window.dispatchEvent(new CustomEvent('dataApplied', {
                    detail: { data: completeData, changes: comparison.differences }
                }));

                updateAllTabsUI();
                editor.value = JSON.stringify(completeData, null, 2);
                if (window.updateLineNumbers) window.updateLineNumbers();

                if (window.showSuccess) window.showSuccess('JSON aplicado com sucesso!');
                if (window.updateJSONStatus) window.updateJSONStatus('‚úÖ JSON aplicado ao sistema.', 'success');
                if (window.updateApplyButtonState) window.updateApplyButtonState();
            }
        } else {
            // ‚úÖ GARANTIR ESTRUTURA COMPLETA
            const completeProposedData = validateAndEnsureCompleteData(proposedData);
            
            window.systemData = completeProposedData;
            window.stagingData = null;
            window.hasPendingChanges = false;

            await saveSystemData(completeProposedData);

            window.dispatchEvent(new CustomEvent('dataImported', {
                detail: completeProposedData
            }));

            updateAllTabsUI();

            if (window.showSuccess) window.showSuccess('JSON aplicado com sucesso!');
            if (window.updateJSONStatus) window.updateJSONStatus('‚úÖ JSON aplicado ao sistema.', 'success');
            if (window.updateApplyButtonState) window.updateApplyButtonState();
        }

    } catch (error) {
        console.error('Erro ao aplicar JSON:', error);
        if (window.showError) window.showError(`Erro ao aplicar JSON: ${error.message}`);
        if (window.updateJSONStatus) window.updateJSONStatus(`‚ùå Erro na aplica√ß√£o: ${error.message}`, 'error');
    }
}

// ==================== FUN√á√ïES RESTANTES ====================

async function saveSystemData(data) {
    try {
        const response = await fetch('/api/system-data/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            throw new Error('Erro ao salvar dados no servidor');
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Erro ao salvar dados');
        }

        console.log('‚úÖ Dados salvos no servidor');
        return true;

    } catch (error) {
        console.error('Erro ao salvar dados:', error);
        if (window.showError) window.showError('Erro ao salvar dados no servidor. Altera√ß√µes aplicadas apenas localmente.');
        return false;
    }
}

function updateAllTabsUI() {
    if (window.loadConstants) window.loadConstants();
    if (window.loadMachines) window.loadMachines();
    if (window.loadMaterials) window.loadMaterials();
    if (window.loadEmpresas) window.loadEmpresas();
    if (window.populateMachineFilter) window.populateMachineFilter();
    if (window.loadJSONEditor) window.loadJSONEditor();
    if (window.loadEquipamentos) window.loadEquipamentos();
    if (window.loadDutos) window.loadDutos();
}

async function compareJSONData(current, proposed) {
    try {
        const response = await fetch('/api/system/apply-json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current: current,
                proposed: proposed
            })
        });

        if (!response.ok) {
            throw new Error('Erro na compara√ß√£o');
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Erro na compara√ß√£o');
        }

        return result;

    } catch (error) {
        console.error('Erro na compara√ß√£o:', error);
        return performLocalComparison(current, proposed);
    }
}

function performLocalComparison(current, proposed) {
    const differences = {
        constants: { added: [], modified: [], removed: [] },
        machines: { added: [], modified: [], removed: [] },
        materials: { added: [], modified: [], removed: [] },
        empresas: { added: [], modified: [], removed: [] },
        banco_equipamentos: { added: [], modified: [], removed: [] },
        dutos: { added: [], modified: [], removed: [] }  // CORRIGIDO: array
    };

    // Comparar constants
    const currentConstKeys = Object.keys(current.constants || {});
    const proposedConstKeys = Object.keys(proposed.constants || {});

    for (const key of proposedConstKeys) {
        if (!currentConstKeys.includes(key)) {
            differences.constants.added.push(key);
        } else if (
            JSON.stringify(proposed.constants[key]) !==
            JSON.stringify(current.constants[key])
        ) {
            differences.constants.modified.push(key);
        }
    }

    for (const key of currentConstKeys) {
        if (!proposedConstKeys.includes(key)) {
            differences.constants.removed.push(key);
        }
    }

    // Comparar banco_equipamentos
    const currentEquipKeys = Object.keys(current.banco_equipamentos || {});
    const proposedEquipKeys = Object.keys(proposed.banco_equipamentos || {});

    for (const key of proposedEquipKeys) {
        if (!currentEquipKeys.includes(key)) {
            differences.banco_equipamentos.added.push(key);
        } else if (
            JSON.stringify(proposed.banco_equipamentos[key]) !==
            JSON.stringify(current.banco_equipamentos[key])
        ) {
            differences.banco_equipamentos.modified.push(key);
        }
    }

    for (const key of currentEquipKeys) {
        if (!proposedEquipKeys.includes(key)) {
            differences.banco_equipamentos.removed.push(key);
        }
    }

    // ‚úÖ CORRIGIDO: Comparar dutos como array
    const currentDutos = current.dutos || [];
    const proposedDutos = proposed.dutos || [];
    
    for (const duto of proposedDutos) {
        const currentDuto = currentDutos.find(d => d.type === duto.type);
        if (!currentDuto) {
            differences.dutos.added.push(duto.type);
        } else if (JSON.stringify(currentDuto) !== JSON.stringify(duto)) {
            differences.dutos.modified.push(duto.type);
        }
    }
    
    for (const duto of currentDutos) {
        if (!proposedDutos.some(d => d.type === duto.type)) {
            differences.dutos.removed.push(duto.type);
        }
    }

    // Calcular totais
    const totalAdded =
        differences.constants.added.length +
        differences.machines.added.length +
        differences.materials.added.length +
        differences.empresas.added.length +
        differences.banco_equipamentos.added.length +
        differences.dutos.added.length;

    const totalModified =
        differences.constants.modified.length +
        differences.machines.modified.length +
        differences.materials.modified.length +
        differences.empresas.modified.length +
        differences.banco_equipamentos.modified.length +
        differences.dutos.modified.length;

    const totalRemoved =
        differences.constants.removed.length +
        differences.machines.removed.length +
        differences.materials.removed.length +
        differences.empresas.removed.length +
        differences.banco_equipamentos.removed.length +
        differences.dutos.removed.length;

    return {
        success: true,
        differences,
        summary: {
            total_changes: totalAdded + totalModified + totalRemoved,
            total_added: totalAdded,
            total_modified: totalModified,
            total_removed: totalRemoved,
            has_changes: (totalAdded + totalModified + totalRemoved) > 0
        }
    };
}

function applyChangesIncremental(current, proposed, differences) {
    try {
        if (!current.constants) current.constants = {};
        if (!current.machines) current.machines = [];
        if (!current.materials) current.materials = {};
        if (!current.empresas) current.empresas = [];
        if (!current.banco_equipamentos) current.banco_equipamentos = {};
        if (!current.dutos) current.dutos = [];  // CORRIGIDO: array vazio

        // Aplicar constants
        for (const added of differences.constants.added) {
            current.constants[added] = proposed.constants[added];
        }
        for (const modified of differences.constants.modified) {
            current.constants[modified] = proposed.constants[modified];
        }

        // Aplicar banco_equipamentos
        for (const added of differences.banco_equipamentos.added) {
            current.banco_equipamentos[added] = proposed.banco_equipamentos[added];
        }

        for (const modified of differences.banco_equipamentos.modified) {
            current.banco_equipamentos[modified] = proposed.banco_equipamentos[modified];
        }

        // ‚úÖ CORRIGIDO: Aplicar dutos como array
        for (const added of differences.dutos.added) {
            const newDuto = proposed.dutos.find(d => d.type === added);
            if (newDuto) {
                current.dutos.push(newDuto);
            }
        }
        
        for (const modified of differences.dutos.modified) {
            const updatedDuto = proposed.dutos.find(d => d.type === modified);
            const index = current.dutos.findIndex(d => d.type === modified);
            if (index !== -1 && updatedDuto) {
                current.dutos[index] = updatedDuto;
            }
        }

        // Remover dutos que foram removidos
        for (const removed of differences.dutos.removed) {
            const index = current.dutos.findIndex(d => d.type === removed);
            if (index !== -1) {
                current.dutos.splice(index, 1);
            }
        }

        return true;

    } catch (error) {
        console.error('Erro ao aplicar mudan√ßas:', error);
        return false;
    }
}

async function showJsonConfirmationModal(comparison) {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        if (!modal || !modalTitle || !modalMessage) {
            const confirmed = confirm(
                `Confirmar aplica√ß√£o de JSON?\n\n` +
                `Adicionados: ${comparison.summary.total_added}\n` +
                `Modificados: ${comparison.summary.total_modified}\n` +
                `Removidos: ${comparison.summary.total_removed}\n\n` +
                `Total: ${comparison.summary.total_changes} altera√ß√µes`
            );
            resolve(confirmed);
            return;
        }

        modalTitle.textContent = 'Confirmar Aplica√ß√£o de JSON';

        let messageHtml = `
            <div class="comparison-summary">
                <h4>Resumo das Altera√ß√µes:</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>Adicionados:</strong> ${comparison.summary.total_added}</li>
                    <li><strong>Modificados:</strong> ${comparison.summary.total_modified}</li>
                    <li><strong>Removidos:</strong> ${comparison.summary.total_removed}</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Total de altera√ß√µes:</strong> ${comparison.summary.total_changes}</p>
                <div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <h5 style="margin: 0 0 5px 0;">Detalhes por categoria:</h5>
                    ${comparison.differences.dutos.added.length > 0 ? 
                        `<p><strong>Dutos adicionados:</strong> ${comparison.differences.dutos.added.length}</p>` : ''}
                    ${comparison.differences.dutos.modified.length > 0 ? 
                        `<p><strong>Dutos modificados:</strong> ${comparison.differences.dutos.modified.length}</p>` : ''}
                    ${comparison.differences.dutos.removed.length > 0 ? 
                        `<p><strong>Dutos removidos:</strong> ${comparison.differences.dutos.removed.length}</p>` : ''}
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    <i class="icon-info"></i> Os itens removidos ser√£o exclu√≠dos do sistema.
                </p>
            </div>
        `;

        modalMessage.innerHTML = messageHtml;
        modal.style.display = 'flex';

        const originalCallback = window.confirmCallback;

        window.confirmCallback = function () {
            window.confirmCallback = originalCallback;
            modal.style.display = 'none';
            resolve(true);
        };

        const cancelButton = modal.querySelector('.btn-secondary');
        if (cancelButton) {
            const originalOnClick = cancelButton.onclick;
            cancelButton.onclick = function () {
                modal.style.display = 'none';
                resolve(false);
                return false;
            };
        }
    });
}

// ==================== FUN√á√ïES DE SISTEMA ====================

export async function saveData() {
    try {
        if (!window.systemData) {
            if (window.showError) window.showError('Nenhum dado para salvar');
            return;
        }

        const response = await fetch('/api/system-data/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(window.systemData)
        });

        if (response.ok) {
            if (window.showSuccess) window.showSuccess('Dados salvos com sucesso!');
        } else {
            throw new Error('Erro ao salvar dados');
        }

    } catch (error) {
        console.error('Erro ao salvar:', error);
        if (window.showError) window.showError('Erro ao salvar dados');
    }
}

// ==================== LOAD DATA CORRIGIDO ====================

export async function loadData() {
    try {
        console.log('üì• Carregando dados do servidor...');
        
        const response = await fetch('/api/system-data');

        if (response.ok) {
            const data = await response.json();
            
            console.log('‚úÖ Dados brutos da API:', {
                constants: Object.keys(data.constants || {}).length,
                machines: data.machines?.length || 0,
                materials: Object.keys(data.materials || {}).length,
                empresas: data.empresas?.length || 0,
                banco_equipamentos: Object.keys(data.banco_equipamentos || {}).length,
                dutos: data.dutos?.length || 0  // CORRIGIDO
            });
            
            // ‚úÖ GARANTIR ESTRUTURA COMPLETA
            const completeData = validateAndEnsureCompleteData(data);
            
            window.systemData = completeData;

            window.dispatchEvent(new CustomEvent('dataLoaded', {
                detail: completeData
            }));

            window.stagingData = null;
            window.hasPendingChanges = false;
            if (window.updateApplyButtonState) window.updateApplyButtonState();

            if (window.showSuccess) window.showSuccess('Dados carregados com sucesso!');
            
            console.log('‚úÖ Dados completos no window.systemData:', {
                dutos: completeData.dutos
            });
            return completeData;

        } else {
            throw new Error('Erro ao carregar dados');
        }

    } catch (error) {
        console.error('‚ùå Erro ao carregar:', error);
        if (window.showError) window.showError('Erro ao carregar dados do servidor');
        throw error;
    }
}

// ==================== EXPORTA√á√ÉO GLOBAL ====================

window.applyJSON = applyJSON;
window.saveData = saveData;
window.loadData = loadData;

// ==================== INICIALIZA√á√ÉO ====================

document.addEventListener('DOMContentLoaded', function () {
    console.log('üîÑ DOM carregado, inicializando...');
    
    // Adicionar listener para debug
    window.addEventListener('dataLoaded', function (event) {
        console.log('üéØ EVENTO dataLoaded recebido no json-utils.js');
        console.log('üéØ Dutos:', event.detail.dutos);
        console.log('üéØ Dutos √© array?', Array.isArray(event.detail.dutos));
        console.log('üéØ N√∫mero de dutos:', event.detail.dutos?.length || 0);
    });

    // Inicializar editor ap√≥s um delay
    setTimeout(() => {
        console.log('‚è∞ Inicializando editor JSON...');
        if (window.initJSONEditor) {
            window.initJSONEditor();
        }
    }, 300);
});

// ==================== FUN√á√ïES DE UTILIDADE ====================

/**
 * Fun√ß√£o para converter dutos de formato antigo para novo
 * √ötil para migra√ß√£o de dados existentes
 */
export function convertDutosToArrayFormat(data) {
    if (!data || typeof data !== 'object') {
        return data;
    }
    
    // Se dutos j√° √© array, retorna como est√°
    if (Array.isArray(data.dutos)) {
        return data;
    }
    
    // Se dutos √© objeto com 'tipos' e 'opcionais', converter para array
    if (data.dutos && typeof data.dutos === 'object') {
        const oldFormat = data.dutos;
        const newDutosArray = [];
        
        // Converter tipos
        if (oldFormat.tipos && Array.isArray(oldFormat.tipos)) {
            newDutosArray.push(...oldFormat.tipos);
        }
        
        // Se n√£o houver tipos, mas houver opcionais, criar array vazio
        if (!oldFormat.tipos && oldFormat.opcionais) {
            // Aqui voc√™ pode implementar l√≥gica espec√≠fica para sua migra√ß√£o
            console.log('‚ö†Ô∏è  Convertendo formato antigo de dutos para array');
        }
        
        data.dutos = newDutosArray;
    }
    
    return data;
}

// Exportar a fun√ß√£o de convers√£o globalmente
window.convertDutosToArrayFormat = convertDutosToArrayFormat;

/* ==== FIM: json-utils.js ==== */
/* ==== FIM: json-utils.js ==== */
