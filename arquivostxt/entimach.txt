
/* ==== IN√çCIO: data/modules/machines/capacity-calculator.js ==== */
// capacityCalculator.js

import { updateElementText } from '../../utils/core-utils.js';

/**
 * Encontra o ID da sala a partir de um elemento dentro dela
 * @param {HTMLElement} element - Elemento dentro da sala
 * @returns {string|null} ID da sala ou null se n√£o encontrado
 */
function findRoomId(element) {
    if (!element) return null;
    
    // Buscar o elemento room-block mais pr√≥ximo
    const roomBlock = element.closest('.room-block');
    if (roomBlock) {
        return roomBlock.dataset.roomId || null;
    }
    
    // Tentar extrair do ID do elemento de conte√∫do
    const roomContent = element.closest('[id^="room-content-"]');
    if (roomContent) {
        const match = roomContent.id.match(/room-content-(.+)/);
        if (match) return match[1];
    }
    
    // Tentar extrair de elementos com data-room-id
    const roomElement = element.closest('[data-room-id]');
    if (roomElement) {
        return roomElement.dataset.roomId;
    }
    
    console.warn('‚ùå N√£o foi poss√≠vel encontrar o ID da sala para o elemento:', element);
    return null;
}

// Configura√ß√µes para inicializa√ß√£o do sistema de capacidade
const capacityConfig = {
  maxInitAttempts: 5, // Aumentado para mais tentativas
  initDelay: 800,
  domCheckDelay: 300
}

// Estado global para controle de inicializa√ß√£o por sala
const capacityState = new Map()

/**
 * Constr√≥i a tabela de c√°lculo de capacidade de refrigera√ß√£o para uma sala
 * @param {string} roomId - ID da sala
 * @returns {string} HTML da tabela de capacidade
 */
function buildCapacityCalculationTable(roomId) {
  console.log(`[CAPACITY] Construindo tabela para: ${roomId}`);
  scheduleCapacityInit(roomId);
  const backupValue = getBackupFromClimaInputs(roomId);

  return `
    <div class="capacity-calculation-table">
      <h5 class="table-title">C√°lculo de Capacidade de Refrigera√ß√£o</h5>
      <div class="table-container">
        <table class="thermal-capacity-table">
          <thead>
            <tr>
              <th>Carga Estimada (TR)</th>
              <th>Fator de Seg.</th>
              <th>Cap. Unit. (TR)</th>
              <th>Solu√ß√£o</th>
              <th>Com back-up</th>
              <th>TOTAL (TR)</th>
              <th>FOLGA (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="carga-estimada-${roomId}">
                <input
                  type="number"
                  class="capacity-input"
                  min="0"
                  step="any"
                  placeholder="Aguardando c√°lculo..."
                  onchange="calculateCapacitySolution('${roomId}')"
                  oninput="calculateCapacitySolution('${roomId}')"
                >
              </td>
              <td>
                <input type="number" id="fator-seguranca-${roomId}" value="10" step="1" 
                      class="capacity-input" 
                      onchange="calculateCapacitySolution('${roomId}')"
                      oninput="calculateCapacitySolution('${roomId}')">
              </td>
              <td>
                <select id="capacidade-unitaria-${roomId}" class="capacity-select" 
                        onchange="calculateCapacitySolution('${roomId}')">
                  ${[1, 2, 3, 4, 5, 7.5, 10, 12.5, 15, 20, 25, 30]
                    .map((tr) => `<option value="${tr}">${tr} TR</option>`)
                    .join("")}
                </select>
              </td>
              <td id="solucao-${roomId}">-</td>
              <td class="backup-cell">
                <div class="backup-selection">
                  <select class="backup-select" onchange="updateBackupConfiguration(this)">
                    ${["n", "n+1", "n+2"]
                      .map((opt) => `<option value="${opt}" ${backupValue === opt ? "selected" : ""}>${opt}</option>`)
                      .join("")}
                  </select>
                </div>
                <div class="backup-solution">
                  <span id="solucao-backup-${roomId}">-</span>
                </div>
              </td>
              <td id="total-capacidade-${roomId}">-</td>
              <td id="folga-${roomId}">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    `;
}

/**
 * Inicializa a tabela de capacidade est√°tica (para casos espec√≠ficos)
 * @returns {void}
 */
function initializeStaticCapacityTable() {
  const staticTable = document.querySelector(".capacity-calculation-table");
  if (staticTable) {
    scheduleCapacityInit("Projeto1-Sala1");
  }
}

/**
 * Agenda a inicializa√ß√£o do sistema de capacidade para uma sala
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function scheduleCapacityInit(roomId) {
  if (capacityState.has(roomId)) return;

  capacityState.set(roomId, { initialized: false, attempts: 0 });
  console.log(`[CAPACITY] Agendando inicializa√ß√£o para: ${roomId}`);
  setTimeout(() => initializeCapacitySystem(roomId), capacityConfig.initDelay);
}

/**
 * Inicializa o sistema de capacidade com tentativas controladas
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function initializeCapacitySystem(roomId) {
  const state = capacityState.get(roomId);
  if (!state || state.initialized) return;

  state.attempts++;

  const systemConstantsReady = window.systemConstants?.FATOR_SEGURANCA_CAPACIDADE.value !== undefined;

  if (systemConstantsReady || state.attempts >= capacityConfig.maxInitAttempts) {
    const fatorSeguranca = systemConstantsReady
      ? window.systemConstants.FATOR_SEGURANCA_CAPACIDADE.value
      : 10;

    applyFatorSeguranca(roomId, fatorSeguranca);

    // CORRE√á√ÉO: Aguarda o DOM estar pronto antes de tentar buscar a carga t√©rmica
    setTimeout(() => {
      const cargaInicial = getThermalLoadTR(roomId);
      const cargaInput = document.querySelector(`#carga-estimada-${roomId} input`);

      if (cargaInicial > 0 && cargaInput) {
        console.log(`[CAPACITY] Definindo carga inicial para ${roomId}: ${cargaInicial} TR`);
        cargaInput.value = Math.round(cargaInicial);
        calculateCapacitySolution(roomId);
      } else {
        console.log(`[CAPACITY] Aguardando c√°lculo t√©rmico para ${roomId}`);
        // Agenda nova tentativa se n√£o houver carga t√©rmica ainda
        if (state.attempts < capacityConfig.maxInitAttempts * 2) {
          setTimeout(() => initializeCapacitySystem(roomId), capacityConfig.domCheckDelay);
        }
      }
    }, 500);

    state.initialized = true;
    console.log(`[CAPACITY] Sistema inicializado para: ${roomId}`);
  } else {
    setTimeout(() => initializeCapacitySystem(roomId), capacityConfig.initDelay);
  }
}

/**
 * Aplica o fator de seguran√ßa ao input correspondente
 * @param {string} roomId - ID da sala
 * @param {number} fatorSeguranca - Valor do fator de seguran√ßa
 * @returns {void}
 */
function applyFatorSeguranca(roomId, fatorSeguranca) {
  const inputFator = document.getElementById(`fator-seguranca-${roomId}`);
  if (!inputFator) return;

  inputFator.value = fatorSeguranca;
}

/**
 * Obt√©m a carga t√©rmica em TR (Tons de Refrigera√ß√£o) para uma sala
 * @param {string} roomId - ID da sala
 * @returns {number} Carga t√©rmica em TR
 */
function getThermalLoadTR(roomId) {
  try {
    console.log(`[CAPACITY] Buscando carga t√©rmica para: ${roomId}`);
    
    // PRIORIDADE 1: Buscar pelo campo TR-exato
    const totalTRExatoElement = document.getElementById(`total-tr-exato-${roomId}`);

    if (totalTRExatoElement && totalTRExatoElement.textContent !== '') {
      const trExato = Number(totalTRExatoElement.textContent);
      if (Number.isFinite(trExato) && trExato > 0) {
        console.log(`[CAPACITY] Usando TR-exato (sem aproxima√ß√£o): ${trExato} TR`);
        return trExato;
      }
    }
    
    // // PRIORIDADE 2: Buscar pelo campo TR-aproximado (refer√™ncia principal)
    // const totalTRaproxElement = document.getElementById(`total-tr-aprox-${roomId}`);
    // if (totalTRaproxElement?.textContent) {
    //   const trAprox = Number.parseFloat(totalTRaproxElement.textContent);
    //   if (!isNaN(trAprox) && trAprox > 0) {
    //     console.log(`[CAPACITY] Usando TR-aproximado: ${trAprox} TR`);
    //     return trAprox;
    //   }
    // }

    // // PRIORIDADE 3: Calcular a partir dos ganhos em Watts
    // const totalGanhosWElement = document.getElementById(`total-ganhos-w-${roomId}`);
    // if (totalGanhosWElement?.textContent) {
    //   const totalW = Number.parseFloat(totalGanhosWElement.textContent) || 0;
    //   if (totalW > 0) {
    //     const trCalculado = totalW / 3517;
    //     console.log(`[CAPACITY] Calculado de Watts: ${totalW}W = ${trCalculado} TR`);
    //     return trCalculado;
    //   }
    // }

    console.log(`[CAPACITY] Nenhuma carga t√©rmica encontrada para ${roomId}`);
    return 0;
  } catch (error) {
    console.error(`Erro ao obter carga t√©rmica para sala ${roomId}:`, error);
    return 0;
  }
}

/**
 * Calcula a solu√ß√£o de capacidade de refrigera√ß√£o baseada nos par√¢metros
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function calculateCapacitySolution(roomId) {
  try {
    console.log(`[CAPACITY] Calculando solu√ß√£o para: ${roomId}`);
    
    const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`);
    const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`);
    const cargaEstimadaInput = document.querySelector(`#carga-estimada-${roomId} input`);

    if (!fatorSegurancaInput || !capacidadeUnitariaSelect || !cargaEstimadaInput) {
      console.warn(`[CAPACITY] Elementos n√£o encontrados para: ${roomId}`);
      return;
    }

    const rawCarga = cargaEstimadaInput.value.trim();

    // Se usu√°rio n√£o digitou nada ‚Üí s√≥ limpa os resultados
    if (rawCarga === "" || rawCarga === "0") {
      updateElementText(`solucao-${roomId}`, "N/A");
      updateElementText(`solucao-backup-${roomId}`, "N/A");
      updateElementText(`total-capacidade-${roomId}`, "N/A");
      updateElementText(`folga-${roomId}`, "N/A");
      return;
    }

    const cargaEstimada = Number.parseFloat(rawCarga);
    if (isNaN(cargaEstimada) || cargaEstimada <= 0) {
      console.warn(`[CAPACITY] Carga estimada inv√°lida: ${rawCarga}`);
      return;
    }

    const fatorSegurancaRaw = Number.parseFloat(fatorSegurancaInput.value);
    const capacidadeUnitariaRaw = Number.parseFloat(capacidadeUnitariaSelect.value);

    const fatorSeguranca = isNaN(fatorSegurancaRaw) ? 0 : (fatorSegurancaRaw / 100);
    const capacidadeUnitaria = isNaN(capacidadeUnitariaRaw) ? 1 : capacidadeUnitariaRaw;

    const backupType = getBackupFromClimatization(roomId);

    const capacidadeNecessaria = cargaEstimada * (1 + fatorSeguranca);
    const unidadesOperacionais = Math.ceil(capacidadeNecessaria / capacidadeUnitaria);
    const unidadesTotais = applyBackupConfiguration(unidadesOperacionais, backupType);

    const total = unidadesOperacionais * capacidadeUnitaria;
    const folga = cargaEstimada > 0 ? ((total / cargaEstimada) - 1) * 100 : 0;

    updateCapacityDisplay(roomId, cargaEstimada, unidadesOperacionais, unidadesTotais, total, folga, backupType);
    
    console.log(`[CAPACITY] Solu√ß√£o calculada para ${roomId}:`, {
      cargaEstimada,
      fatorSeguranca: `${fatorSeguranca * 100}%`,
      capacidadeUnitaria,
      unidadesOperacionais,
      backupType,
      unidadesTotais,
      total: `${total.toFixed(1)} TR`,
      folga: `${folga.toFixed(1)}%`
    });
  } catch (error) {
    console.error(`Erro ao calcular capacidade para sala ${roomId}:`, error);
  }
}

/**
 * Obt√©m os dados atuais de capacidade de uma sala
 * @param {string} roomId - ID da sala
 * @returns {Object|null} Dados de capacidade ou null se n√£o encontrado
 */
function getCapacityData(roomId) {
  const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`);
  const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`);
  const backupSelect = document.querySelector(`#room-content-${roomId} .backup-select`);

  if (!fatorSegurancaInput || !capacidadeUnitariaSelect || !backupSelect) return null;

  return {
    fatorSeguranca: Number.parseFloat(fatorSegurancaInput.value) || 10,
    capacidadeUnitaria: Number.parseFloat(capacidadeUnitariaSelect.value) || 1,
    backup: backupSelect.value || "n",
    cargaEstimada:  document.getElementById(`total-tr-exato-${roomId}`),
    solucao: document.getElementById(`solucao-${roomId}`)?.textContent || "0",
    solucaoBackup: document.getElementById(`solucao-backup-${roomId}`)?.textContent || "0",
    totalCapacidade: document.getElementById(`total-capacidade-${roomId}`)?.textContent || "0",
    folga: document.getElementById(`folga-${roomId}`)?.textContent || "0%"
  };
}

/**
 * Aplica a configura√ß√£o de backup ao n√∫mero de unidades
 * @param {number} unidadesOperacionais - N√∫mero de unidades operacionais
 * @param {string} backupType - Tipo de backup ("n", "n+1", "n+2")
 * @returns {number} N√∫mero total de unidades considerando backup
 */
function applyBackupConfiguration(unidadesOperacionais, backupType) {
  switch (backupType) {
    case "n+1":
      return unidadesOperacionais + 1;
    case "n+2":
      return unidadesOperacionais + 2;
    default:
      return unidadesOperacionais;
  }
}

/**
 * Obt√©m o tipo de backup configurado para climatiza√ß√£o da sala
 * @param {string} roomId - ID da sala
 * @returns {string} Tipo de backup ("n", "n+1", "n+2")
 */
function getBackupFromClimatization(roomId) {
  const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);
  if (capacityTable) {
    const backupSelect = capacityTable.querySelector(".backup-select");
    if (backupSelect) return backupSelect.value;
  }

  return getBackupFromClimaInputs(roomId);
}

/**
 * Obt√©m o backup dos inputs de clima da sala
 * @param {string} roomId - ID da sala
 * @returns {string} Tipo de backup ("n", "n+1", "n+2")
 */
function getBackupFromClimaInputs(roomId) {
  const roomContent = document.getElementById(`room-content-${roomId}`);
  if (roomContent) {
    const backupInput = roomContent.querySelector(`.clima-input[data-field="backup"]`);
    if (backupInput?.value) return backupInput.value;
  }
  return "n";
}

/**
 * Atualiza a exibi√ß√£o dos resultados de capacidade na tabela
 * @param {string} roomId - ID da sala
 * @param {number} cargaEstimada - Carga t√©rmica estimada em TR
 * @param {number} solucao - N√∫mero de unidades da solu√ß√£o
 * @param {number} solucaoComBackup - N√∫mero de unidades com backup
 * @param {number} total - Capacidade total em TR
 * @param {number} folga - Percentual de folga
 * @param {string} backupType - Tipo de backup
 * @returns {void}
 */
function updateCapacityDisplay(roomId, cargaEstimada, solucao, solucaoComBackup, total, folga, backupType) {
  updateElementText(`solucao-${roomId}`, String(solucao));
  updateElementText(`solucao-backup-${roomId}`, String(solucaoComBackup));

  if (typeof total === "number" && !Number.isNaN(total)) {
    updateElementText(`total-capacidade-${roomId}`, total.toFixed(1));
  }

  if (typeof folga === "number" && !Number.isNaN(folga)) {
    updateElementText(`folga-${roomId}`, folga.toFixed(1) + "%");
  }

  const backupSelect = document.querySelector(`#room-content-${roomId} .backup-select`);
  if (backupSelect && backupSelect.value !== backupType) {
    backupSelect.value = backupType;
  }
}

/**
 * Atualiza ou cria o input para carga estimada 
 * @param {string} roomId - ID da sala
 * @param {number} value - Valor a ser definido 
 * @returns {void}
 */
function updateCargaEstimadaInput(roomId, value) {
  const cargaEstimadaElement = document.getElementById(`carga-estimada-${roomId}`);
  if (!cargaEstimadaElement) return;

  let input = cargaEstimadaElement.querySelector("input");
  if (!input) {
    input = document.createElement("input");
    input.type = "number";
    input.className = "capacity-input";
    input.min = "0";
    input.step = "any";
    input.onchange = () => calculateCapacitySolution(roomId);
    input.oninput = () => calculateCapacitySolution(roomId);
    input.value = value;

    cargaEstimadaElement.innerHTML = "";
    cargaEstimadaElement.appendChild(input);
  } else {
    input.value = value;

  }
}

/**
 * Atualiza a configura√ß√£o de backup quando alterada pelo usu√°rio
 * @param {HTMLSelectElement} selectElement - Elemento select do backup
 * @returns {void}
 */
function updateBackupConfiguration(selectElement) {
  const roomId = findRoomId(selectElement.closest(".capacity-calculation-table"));
  if (roomId) {
    const newBackupValue = selectElement.value;
    syncBackupWithClimaInputs(roomId, newBackupValue);
    calculateCapacitySolution(roomId);
  }
}

/**
 * Manipula mudan√ßas no backup provenientes dos inputs de clima
 * @param {string} roomId - ID da sala
 * @param {string} newBackupValue - Novo valor de backup
 * @returns {void}
 */
function handleClimaInputBackupChange(roomId, newBackupValue) {
  const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);

  if (capacityTable) {
    const backupSelect = capacityTable.querySelector(".backup-select");
    if (backupSelect && backupSelect.value !== newBackupValue) {
      backupSelect.value = newBackupValue;
      calculateCapacitySolution(roomId);
    }
  }
}

/**
 * Sincroniza o backup com os inputs de clima da sala
 * @param {string} roomId - ID da sala
 * @param {string} backupValue - Valor de backup a ser sincronizado
 * @returns {void}
 */
function syncBackupWithClimaInputs(roomId, backupValue) {
    const roomContent = document.getElementById(`room-content-${roomId}`);
    if (roomContent) {
        const backupInputs = roomContent.querySelectorAll(`.clima-input[data-field="backup"]`);

        backupInputs.forEach((input) => {
            if (input.value !== backupValue) {
                // Remove temporariamente o onchange para evitar loop
                const originalOnChange = input.onchange;
                input.onchange = null;
                
                input.value = backupValue;
                
                // Restaura o onchange ap√≥s um breve delay
                setTimeout(() => {
                    input.onchange = originalOnChange;
                }, 100);
            }
        });
    }
}

/**
 * Sincroniza o backup da tabela de capacidade com os valores atuais
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function syncCapacityTableBackup(roomId) {
  setTimeout(() => {
    const backupFromInputs = getBackupFromClimaInputs(roomId);
    const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);

    if (capacityTable) {
      const backupSelect = capacityTable.querySelector(".backup-select");
      if (backupSelect && backupSelect.value !== backupFromInputs) {
        backupSelect.value = backupFromInputs;
        calculateCapacitySolution(roomId);
      }
    }
  }, 500);
}

/**
 * üîÑ Fun√ß√£o global para ser chamada diretamente do HTML - EVITA LOOP
 * @param {string} roomId - ID da sala
 * @param {string} newValue - Novo valor do backup
 * @returns {void}
 */
function handleClimaBackupChange(roomId, newValue) {
    console.log(`üîÑ Backup alterado no form: ${newValue} (sala: ${roomId})`);
    
    // Atualiza o backup-select SEM disparar eventos de volta
    const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);
    if (capacityTable) {
        const backupSelect = capacityTable.querySelector(".backup-select");
        if (backupSelect && backupSelect.value !== newValue) {
            backupSelect.value = newValue;
            calculateCapacitySolution(roomId);
        }
    }
    
    // Mant√©m o c√°lculo t√©rmico original
    if (typeof window.calculateVazaoArAndThermalGains === 'function') {
        window.calculateVazaoArAndThermalGains(roomId);
    }
}

/**
 * üîÑ WRAPPER: Para ser chamada diretamente do onchange do HTML
 * @param {HTMLSelectElement} selectElement - Elemento select do form
 * @returns {void}
 */
function handleClimaInputBackupChangeFromEvent(selectElement) {
    const roomId = findRoomId(selectElement);
    if (!roomId) {
        console.warn('‚ùå N√£o foi poss√≠vel encontrar roomId para handleClimaInputBackupChangeFromEvent');
        return;
    }
    
    const newBackupValue = selectElement.value;
    console.log(`üîÑ Backup alterado no form: ${newBackupValue} (sala: ${roomId})`);
    
    // Usa a fun√ß√£o existente que j√° faz todo o trabalho
    handleClimaInputBackupChange(roomId, newBackupValue);
    
    // Tamb√©m dispara o c√°lculo t√©rmico (mant√©m funcionalidade original)
    if (typeof window.calculateVazaoArAndThermalGains === 'function') {
        window.calculateVazaoArAndThermalGains(roomId);
    }
}

/**
 * NOVA FUN√á√ÉO: Atualiza capacidade a partir dos ganhos t√©rmicos
 * @param {string} roomId - ID da sala
 * @returns {void}
 */
function updateCapacityFromThermalGains(roomId) {
  console.log(`[CAPACITY] Atualizando capacidade a partir de ganhos t√©rmicos para ${roomId}`);
  
  const cargaEstimada = getThermalLoadTR(roomId);
  if (cargaEstimada > 0) {
    updateCargaEstimadaInput(roomId, cargaEstimada);
    calculateCapacitySolution(roomId);
    return true;
  }
  return false;
}

// üîÑ Torna as fun√ß√µes globais para serem acess√≠veis do HTML
if (typeof window !== 'undefined') {
  window.handleClimaBackupChange = handleClimaBackupChange;
  window.handleClimaInputBackupChangeFromEvent = handleClimaInputBackupChangeFromEvent;
  window.updateBackupConfiguration = updateBackupConfiguration;
  window.calculateCapacitySolution = calculateCapacitySolution;
  window.updateCapacityFromThermalGains = updateCapacityFromThermalGains;
}

// Exporta√ß√£o das fun√ß√µes do m√≥dulo
export {
  buildCapacityCalculationTable,
  calculateCapacitySolution,
  getCapacityData,
  updateBackupConfiguration,
  handleClimaInputBackupChange,
  syncCapacityTableBackup,
  initializeStaticCapacityTable,
  handleClimaInputBackupChangeFromEvent,
  updateCapacityFromThermalGains,
  getThermalLoadTR
};
/* ==== FIM: data/modules/machines/capacity-calculator.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/machine-renderer.js ==== */
import { buildMachinesSection, addMachine } from '../../modules/machines/machines-core.js';

/**
 * Encontra se√ß√£o de m√°quinas pelo t√≠tulo
 */
function findMachinesSection(roomElement) {
    if (!roomElement) return null;
    
    // Buscar todas as se√ß√µes .section-block
    const allSections = roomElement.querySelectorAll('.section-block');
    
    // Encontrar a que tem "M√°quinas" no t√≠tulo
    for (let section of allSections) {
        const title = section.querySelector('.section-title');
        if (title && title.textContent.includes('M√°quinas')) {
            return section;
        }
    }
    
    return null;
}

/**
 * ‚úÖ FUN√á√ÉO AUXILIAR: Encontrar se√ß√£o por t√≠tulo
 */
function findSectionByTitle(roomElement, titleText) {
    if (!roomElement) return null;
    
    const allSections = roomElement.querySelectorAll('.section-block');
    
    for (let section of allSections) {
        const title = section.querySelector('.section-title');
        if (title && title.textContent.includes(titleText)) {
            return section;
        }
    }
    
    return null;
}

/**
 * Garante que a se√ß√£o de m√°quinas existe e est√° inicializada - VERS√ÉO CORRIGIDA
 */
async function ensureMachinesSection(roomElement) {
    if (!roomElement) {
        console.error('‚ùå Elemento da sala inv√°lido');
        return null;
    }

    const obraId = roomElement.dataset.obraId;
    const projectId = roomElement.dataset.projectId;
    const roomName = roomElement.dataset.roomName;
    const roomId = roomElement.dataset.roomId;

    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå Room ID inv√°lido: "${roomId}" para sala ${roomName}`);
        return null;
    }

    console.log(`üî® Garantindo se√ß√£o de m√°quinas para sala ${roomName} (ID: ${roomId})`);

    // Primeiro garantir que todas as se√ß√µes existem
    const sectionsReady = await ensureAllRoomSections(roomElement);
    if (!sectionsReady) {
        console.error(`‚ùå N√£o foi poss√≠vel garantir todas as se√ß√µes para sala ${roomName}`);
        return null;
    }

    // ‚úÖ CORRE√á√ÉO: Buscar por .section-block que contenha "M√°quinas" no t√≠tulo
    let machinesSection = findMachinesSection(roomElement);
    
    if (machinesSection) {
        console.log(`‚úÖ Se√ß√£o de m√°quinas encontrada para sala ${roomName}`);
        return machinesSection;
    }

    // Se ainda n√£o existe, tentar criar apenas a se√ß√£o de m√°quinas
    console.log(`üîÑ Tentando criar apenas se√ß√£o de m√°quinas para sala ${roomName}`);

    // Encontrar a √∫ltima se√ß√£o para inserir ap√≥s ela
    const lastSection = roomElement.querySelector('.section-block:last-child') || 
                       roomElement.querySelector('.room-content > :last-child');

    if (!lastSection) {
        console.error(`‚ùå Nenhuma se√ß√£o encontrada para inserir m√°quinas`);
        return null;
    }

    if (typeof buildMachinesSection !== 'function') {
        console.error('‚ùå Fun√ß√£o buildMachinesSection n√£o dispon√≠vel');
        return null;
    }

    try {
        const machinesHTML = await buildMachinesSection(obraId, projectId, roomName, roomId);
        if (!machinesHTML) {
            console.error('‚ùå HTML da se√ß√£o de m√°quinas n√£o gerado');
            return null;
        }

        lastSection.insertAdjacentHTML('afterend', machinesHTML);
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // ‚úÖ CORRE√á√ÉO: Usar a nova fun√ß√£o para encontrar a se√ß√£o
        machinesSection = findMachinesSection(roomElement);
        if (machinesSection) {
            console.log(`‚úÖ Se√ß√£o de m√°quinas criada com sucesso para sala ${roomName}`);
            return machinesSection;
        } else {
            console.error(`‚ùå Se√ß√£o de m√°quinas n√£o encontrada ap√≥s cria√ß√£o`);
            return null;
        }

    } catch (error) {
        console.error(`‚ùå Erro ao criar se√ß√£o de m√°quinas:`, error);
        return null;
    }
}

/**
 * Preenche os dados das m√°quinas de uma sala - VERS√ÉO CORRIGIDA
 */
async function fillMachinesData(roomElement, machinesData) {
    if (!roomElement || !machinesData || !Array.isArray(machinesData)) {
        console.error('‚ùå Elemento da sala ou dados de m√°quinas inv√°lidos');
        return false;
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    console.log(`üîÑ Preenchendo ${machinesData.length} m√°quina(s) para sala ${roomName} (ID: ${roomId})`);

    // ‚úÖ CORRE√á√ÉO: Verificar se h√° m√°quinas para preencher
    if (machinesData.length === 0) {
        console.log(`‚ÑπÔ∏è Nenhuma m√°quina para preencher na sala ${roomName}`);
        return true; // Retorna true porque n√£o h√° erro, s√≥ n√£o h√° m√°quinas
    }

    try {
        const machinesSection = await ensureMachinesSection(roomElement);
        if (!machinesSection) {
            console.error(`‚ùå N√£o foi poss√≠vel criar/obter se√ß√£o de m√°quinas para sala ${roomName}`);
            return false;
        }

        const machinesContainer = machinesSection.querySelector('.machines-container');
        if (!machinesContainer) {
            console.error(`‚ùå Container de m√°quinas n√£o encontrado para sala ${roomName}`);
            return false;
        }

        console.log(`‚úÖ Container de m√°quinas encontrado`);

        // Limpar m√°quinas existentes
        const existingMachines = machinesContainer.querySelectorAll('.climatization-machine, .machine-block');
        if (existingMachines.length > 0) {
            console.log(`üóëÔ∏è Removendo ${existingMachines.length} m√°quina(s) existente(s)`);
            existingMachines.forEach(machine => machine.remove());
        }

        let successCount = 0;

        // Adicionar cada m√°quina
        for (let i = 0; i < machinesData.length; i++) {
            const machineData = machinesData[i];
            
            if (!machineData || !machineData.tipo) {
                console.warn(`‚ö†Ô∏è Dados da m√°quina ${i} inv√°lidos:`, machineData);
                continue;
            }

            console.log(`ü§ñ [${i + 1}/${machinesData.length}] Adicionando m√°quina: ${machineData.tipo}`);

            try {
                // ‚úÖ CORRE√á√ÉO: Usar addMachine com retry
                let machineAdded = false;
                let retryCount = 0;
                
                while (!machineAdded && retryCount < 3) {
                    machineAdded = await addMachine(roomId, machineData.tipo);
                    
                    if (!machineAdded) {
                        retryCount++;
                        console.log(`üîÑ Tentativa ${retryCount}/3 para adicionar m√°quina ${machineData.tipo}`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                if (!machineAdded) {
                    console.error(`‚ùå Falha ao adicionar m√°quina ${machineData.tipo} ap√≥s ${retryCount} tentativas`);
                    continue;
                }

                console.log(`‚úÖ M√°quina ${machineData.tipo} adicionada, aguardando renderiza√ß√£o...`);

                // Aguardar renderiza√ß√£o completa
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Encontrar a m√°quina mais recente
                const machineElements = machinesContainer.querySelectorAll('.climatization-machine');
                const lastMachine = machineElements[machineElements.length - 1];
                
                if (!lastMachine) {
                    console.error(`‚ùå Elemento da m√°quina n√£o encontrado ap√≥s adi√ß√£o`);
                    continue;
                }

                console.log(`‚úÖ Elemento da m√°quina encontrado, preenchendo dados...`);

                // Preencher dados da m√°quina
                const populated = await populateMachineData(lastMachine, machineData);
                if (populated) {
                    successCount++;
                    console.log(`üéâ M√°quina ${machineData.tipo} preenchida com sucesso`);
                } else {
                    console.error(`‚ùå Falha ao preencher dados da m√°quina ${machineData.tipo}`);
                }

            } catch (error) {
                console.error(`‚ùå Erro ao processar m√°quina ${machineData.tipo}:`, error);
            }

            // Pequena pausa entre m√°quinas
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        console.log(`‚úÖ ${successCount}/${machinesData.length} m√°quina(s) preenchida(s) com sucesso para sala ${roomName}`);
        
        // ‚úÖ CORRE√á√ÉO: Retorna true se pelo menos uma m√°quina foi preenchida, ou se n√£o havia m√°quinas
        return successCount > 0 || machinesData.length === 0;

    } catch (error) {
        console.error(`‚ùå Erro cr√≠tico ao preencher m√°quinas para sala ${roomName}:`, error);
        return false;
    }
}

/**
 * Preenche os dados individuais de uma m√°quina - COM APLICA√á√ÉO
 */
async function populateMachineData(machineElement, machineData) {
    if (!machineElement || !machineData) {
        console.error('‚ùå Elemento da m√°quina ou dados inv√°lidos');
        return false;
    }

    console.log(`üîß Preenchendo dados da m√°quina:`, machineData);

    try {
        const machineId = machineElement.dataset.machineId;

        // 1. DEFINIR QUANTIDADE (se dispon√≠vel)
        const qntInput = machineElement.querySelector('.machine-qnt-input');
        if (qntInput && machineData.quantidade !== undefined) {
            qntInput.value = Math.max(1, parseInt(machineData.quantidade) || 1);
            console.log(`‚úÖ Quantidade definida: ${qntInput.value}`);
        }

        // 2. DEFINIR TIPO (se dispon√≠vel)
        const typeSelect = machineElement.querySelector('.machine-type-select');
        if (typeSelect && machineData.tipo) {
            typeSelect.value = machineData.tipo;
            const typeEvent = new Event('change', { bubbles: true });
            typeSelect.dispatchEvent(typeEvent);
            console.log(`‚úÖ Tipo definido: ${machineData.tipo}`);
            
            // Aguardar processamento do tipo
            await new Promise(resolve => setTimeout(resolve, 800));
        }

        // 3. DEFINIR APLICA√á√ÉO (se dispon√≠vel)
        const aplicacaoSelect = machineElement.querySelector('.machine-aplicacao-select');
        if (aplicacaoSelect && machineData.aplicacao_machines !== undefined) {
            aplicacaoSelect.value = machineData.aplicacao_machines || '';
            console.log(`‚úÖ Aplica√ß√£o definida: ${machineData.aplicacao_machines}`);
        }

        // 4. DEFINIR CAPACIDADE (se dispon√≠vel e habilitado)
        const powerSelect = machineElement.querySelector('.machine-power-select');
        if (powerSelect && machineData.potencia) {
            // Aguardar at√© que o select esteja habilitado (m√°x 3 segundos)
            let attempts = 0;
            while (powerSelect.disabled && attempts < 6) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
                console.log(`‚è≥ Aguardando habilita√ß√£o da capacidade... (${attempts}/6)`);
            }
            
            if (!powerSelect.disabled) {
                const powerOption = Array.from(powerSelect.options).find(opt => 
                    opt.text.includes(machineData.potencia) || 
                    opt.value.includes(machineData.potencia) ||
                    opt.text.toLowerCase().includes(machineData.potencia.toLowerCase())
                );
                
                if (powerOption) {
                    powerSelect.value = powerOption.value;
                    const powerEvent = new Event('change', { bubbles: true });
                    powerSelect.dispatchEvent(powerEvent);
                    console.log(`‚úÖ Capacidade definida: ${powerOption.value}`);
                    
                    // Aguardar processamento da capacidade
                    await new Promise(resolve => setTimeout(resolve, 800));
                } else {
                    console.log(`‚ö†Ô∏è Capacidade "${machineData.potencia}" n√£o encontrada`);
                }
            } else {
                console.log(`‚ö†Ô∏è Select de capacidade permanece desabilitado`);
            }
        }

        // 5. DEFINIR TENS√ÉO (se dispon√≠vel e habilitado)
        const voltageSelect = machineElement.querySelector('.machine-voltage-select');
        if (voltageSelect && machineData.tensao) {
            // Aguardar at√© que o select esteja habilitado (m√°x 3 segundos)
            let attempts = 0;
            while (voltageSelect.disabled && attempts < 6) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
                console.log(`‚è≥ Aguardando habilita√ß√£o da tens√£o... (${attempts}/6)`);
            }
            
            if (!voltageSelect.disabled) {
                const voltageOption = Array.from(voltageSelect.options).find(opt => 
                    opt.text.includes(machineData.tensao) || 
                    opt.value.includes(machineData.tensao) ||
                    opt.text.toLowerCase().includes(machineData.tensao.toLowerCase())
                );
                
                if (voltageOption) {
                    voltageSelect.value = voltageOption.value;
                    const voltageEvent = new Event('change', { bubbles: true });
                    voltageSelect.dispatchEvent(voltageEvent);
                    console.log(`‚úÖ Tens√£o definida: ${voltageOption.value}`);
                } else {
                    console.log(`‚ö†Ô∏è Tens√£o "${machineData.tensao}" n√£o encontrada`);
                }
            } else {
                console.log(`‚ö†Ô∏è Select de tens√£o permanece desabilitado`);
            }
        }

        // 6. DEFINIR OP√á√ïES SELECIONADAS (se dispon√≠veis)
        if (machineData.opcoesSelecionadas && Array.isArray(machineData.opcoesSelecionadas)) {
            // Aguardar carregamento das op√ß√µes
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const optionsContainer = machineElement.querySelector('.options-grid');
            
            if (optionsContainer) {
                const allCheckboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
                console.log(`üîç Encontrados ${allCheckboxes.length} checkboxes de op√ß√µes`);

                let optionsMarked = 0;
                machineData.opcoesSelecionadas.forEach(optionObj => {
                    let optionName;
                    if (typeof optionObj === 'string') {
                        optionName = optionObj;
                    } else if (typeof optionObj === 'object') {
                        optionName = optionObj.name || optionObj.originalName;
                    }
                    
                    if (!optionName) {
                        console.log(`‚ö†Ô∏è Op√ß√£o inv√°lida:`, optionObj);
                        return;
                    }

                    console.log(`Procurando op√ß√£o: "${optionName}"`);
                    
                    // Buscar pelo data-option-name (mais confi√°vel)
                    const checkbox = Array.from(allCheckboxes).find(cb => {
                        const dataName = cb.getAttribute('data-option-name');
                        return dataName === optionName;
                    });
                    
                    if (checkbox) {
                        checkbox.checked = true;
                        const checkboxEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(checkboxEvent);
                        optionsMarked++;
                        console.log(`‚úÖ Op√ß√£o marcada: ${optionName}`);
                    } else {
                        console.log(`‚ùå Op√ß√£o n√£o encontrada: "${optionName}"`);
                        
                        // Debug: tentar encontrar por texto do label
                        const allOptions = optionsContainer.querySelectorAll('.option-item');
                        const foundByText = Array.from(allOptions).find(optionItem => {
                            const nameElement = optionItem.querySelector('.option-name');
                            return nameElement && nameElement.textContent.includes(optionName);
                        });
                        
                        if (foundByText) {
                            const checkboxInItem = foundByText.querySelector('input[type="checkbox"]');
                            if (checkboxInItem) {
                                checkboxInItem.checked = true;
                                const checkboxEvent = new Event('change', { bubbles: true });
                                checkboxInItem.dispatchEvent(checkboxEvent);
                                optionsMarked++;
                                console.log(`‚úÖ Op√ß√£o marcada (por texto): ${optionName}`);
                            }
                        }
                    }
                });
                
                console.log(`üìä Op√ß√µes marcadas: ${optionsMarked}/${machineData.opcoesSelecionadas.length}`);
            } else {
                console.log(`‚ö†Ô∏è Container de op√ß√µes n√£o encontrado`);
            }
        }

        // 7. DEFINIR CONFIGURA√á√ïES SELECIONADAS (se dispon√≠veis)
        if (machineData.configuracoesSelecionadas && Array.isArray(machineData.configuracoesSelecionadas)) {
            console.log(`üéØ Aplicando ${machineData.configuracoesSelecionadas.length} configura√ß√µes salvas`);
            
            // Aguardar carregamento das configura√ß√µes
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            const configContainer = machineElement.querySelector('.config-grid');
            
            if (configContainer) {
                const allConfigCheckboxes = configContainer.querySelectorAll('input[type="checkbox"]');
                console.log(`üîç Encontrados ${allConfigCheckboxes.length} checkboxes de configura√ß√µes`);

                let configsMarked = 0;
                machineData.configuracoesSelecionadas.forEach(configObj => {
                    let configId, configName;
                    
                    if (typeof configObj === 'string') {
                        // Se for string, tentar extrair ID do formato "config-{id}"
                        const match = configObj.match(/config-(\d+)/);
                        configId = match ? match[1] : configObj;
                        configName = configObj;
                    } else if (typeof configObj === 'object') {
                        configId = configObj.id || configObj;
                        configName = configObj.nome || configObj;
                    }
                    
                    if (!configId) {
                        console.log(`‚ö†Ô∏è Configura√ß√£o inv√°lida:`, configObj);
                        return;
                    }

                    console.log(`Procurando configura√ß√£o: ID=${configId}, Nome="${configName}"`);
                    
                    // Buscar pelo data-config-id
                    const checkbox = Array.from(allConfigCheckboxes).find(cb => {
                        const cbConfigId = cb.getAttribute('data-config-id');
                        return cbConfigId === configId.toString();
                    });
                    
                    if (checkbox) {
                        checkbox.checked = true;
                        const checkboxEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(checkboxEvent);
                        configsMarked++;
                        console.log(`‚úÖ Configura√ß√£o marcada: ID=${configId}`);
                    } else {
                        console.log(`‚ùå Configura√ß√£o n√£o encontrada: ID=${configId}`);
                        
                        // Tentar encontrar por nome
                        const foundByName = Array.from(allConfigCheckboxes).find(cb => {
                            const cbConfigName = cb.getAttribute('data-config-name');
                            return cbConfigName && cbConfigName.includes(configName);
                        });
                        
                        if (foundByName) {
                            foundByName.checked = true;
                            const checkboxEvent = new Event('change', { bubbles: true });
                            foundByName.dispatchEvent(checkboxEvent);
                            configsMarked++;
                            console.log(`‚úÖ Configura√ß√£o marcada (por nome): ${configName}`);
                        }
                    }
                });
                
                console.log(`üìä Configura√ß√µes marcadas: ${configsMarked}/${machineData.configuracoesSelecionadas.length}`);
            } else {
                console.log(`‚ö†Ô∏è Container de configura√ß√µes n√£o encontrado`);
            }
        }

        // 8. DEFINIR PRE√áOS (se dispon√≠veis)
        if (machineData.precoBase !== undefined) {
            const basePriceElement = document.getElementById(`base-price-${machineId}`);
            if (basePriceElement) {
                basePriceElement.textContent = `R$ ${machineData.precoBase.toLocaleString('pt-BR')}`;
                console.log(`‚úÖ Pre√ßo base definido: R$ ${machineData.precoBase}`);
            }
        }

        if (machineData.precoTotal !== undefined) {
            const totalPriceElement = document.getElementById(`total-price-${machineId}`);
            if (totalPriceElement) {
                totalPriceElement.textContent = `R$ ${machineData.precoTotal.toLocaleString('pt-BR')}`;
                console.log(`‚úÖ Pre√ßo total definido: R$ ${machineData.precoTotal}`);
            }
        }

        // 9. DEFINIR NOME (se dispon√≠vel)
        if (machineData.nome) {
            const nameInput = machineElement.querySelector('.machine-title-editable');
            if (nameInput) {
                nameInput.value = machineData.nome;
                console.log(`‚úÖ Nome definido: ${machineData.nome}`);
            }
        }

        // 10. DISPARAR C√ÅLCULO FINAL
        setTimeout(() => {
            if (typeof calculateMachinePrice === 'function') {
                calculateMachinePrice(machineId);
                console.log('‚úÖ C√°lculo de pre√ßo finalizado (com aplica√ß√£o)');
            }
        }, 500);

        console.log(`‚úÖ Dados da m√°quina preenchidos com sucesso (incluindo aplica√ß√£o)`);
        return true;

    } catch (error) {
        console.error(`‚ùå Erro ao preencher dados da m√°quina:`, error);
        return false;
    }
}

// EXPORTS NO FINAL
export {
    findMachinesSection,
    findSectionByTitle,
    ensureMachinesSection,
    fillMachinesData,
    populateMachineData
};
/* ==== FIM: data/builders/ui-folder/machine-renderer.js ==== */

/* ==== IN√çCIO: data/modules/machines/machines-core.js ==== */
/**
 * data/modules/machines/machines-core.js
 * Sistema unificado de m√°quinas - COM NOMENCLATURA AUTOM√ÅTICA
 * Vers√£o SIMPLIFICADA com preenchimento autom√°tico de quantidade
 */

import { updateElementText, safeNumber } from '../../utils/core-utils.js';
import { generateMachineId } from '../../utils/id-generator.js';

// =============================================================================
// CACHE E ESTADO GLOBAL
// =============================================================================

if (typeof window !== 'undefined' && !window.machinesDataCache) {
    window.machinesDataCache = null;
}

// =============================================================================
// FUN√á√ïES CORE UNIFICADAS
// =============================================================================

/**
 * Carrega dados das m√°quinas com cache
 */
async function loadMachinesData() {
    if (window.machinesDataCache?.machines?.length) {
        return window.machinesDataCache;
    }

    try {
        const response = await fetch('/machines');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        const machinesData = { machines: Array.isArray(data) ? data : data.machines };

        window.machinesDataCache = machinesData;
        window.machinesData = machinesData.machines;
        return machinesData;

    } catch (error) {
        console.error("‚ùå Erro ao carregar m√°quinas:", error);
        return window.machinesDataCache || { machines: [] };
    }
}

    // =============================================================================
// HANDLERS DE EVENTOS PARA VENTILA√á√ÉO
// =============================================================================

/**
 * DISPARA EVENTO QUANDO UM CAMPO DE M√ÅQUINA √â ALTERADO
 */
function notifyMachineFieldChange(machineId, fieldType) {
    // Chama diretamente o handler se dispon√≠vel
    if (window.handleMachineFieldChange) {
        window.handleMachineFieldChange(machineId, fieldType);
    }
    
    // Tamb√©m dispara evento customizado
    const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
    const roomId = machineElement?.dataset.roomId;
    
    if (roomId) {
        const event = new CustomEvent('machineFieldChanged', { 
            detail: { 
                machineId: machineId, 
                roomId: roomId,
                fieldType: fieldType
            } 
        });
        window.dispatchEvent(event);
    }
}




// =============================================================================
// SISTEMA DE NOMENCLATURA AUTOM√ÅTICA
// =============================================================================

/**
 * üÜï GERA NOME AUTOM√ÅTICO APENAS QUANDO TIPO E CAPACIDADE EST√ÉO SELECIONADOS
 */
function generateMachineName(machineType, roomId, currentMachineId = null) {
    console.log(`üî§ Gerando nome autom√°tico para ${machineType} na sala ${roomId}`);

    const container = document.getElementById(`machines-${roomId}`);
    if (!container) return machineType;

    const existingMachines = Array.from(container.querySelectorAll('.climatization-machine'));
    const allMachinesData = [];

    existingMachines.forEach(machine => {
        const machineId = machine.dataset.machineId;
        const typeSelect = machine.querySelector('.machine-type-select');
        const powerSelect = machine.querySelector('.machine-power-select');

        if (typeSelect && typeSelect.value === machineType && powerSelect && powerSelect.value) {
            allMachinesData.push({
                machineId: machineId,
                type: typeSelect.value,
                power: powerSelect.value,
                capacityValue: getGenericCapacityValue(powerSelect.value)
            });
        }
    });

    if (currentMachineId && machineType) {
        const currentMachineElement = document.querySelector(`[data-machine-id="${currentMachineId}"]`);
        const powerSelect = currentMachineElement?.querySelector('.machine-power-select');
        const currentPower = powerSelect ? powerSelect.value : '';

        if (currentPower) {
            allMachinesData.push({
                machineId: currentMachineId,
                type: machineType,
                power: currentPower,
                capacityValue: getGenericCapacityValue(currentPower),
                isNew: true
            });
        } else {
            return machineType;
        }
    }

    if (allMachinesData.length === 0) {
        return machineType;
    }

    allMachinesData.sort((a, b) => b.capacityValue - a.capacityValue);

    const capacityGroups = {};
    allMachinesData.forEach(machine => {
        const capacityKey = machine.power;
        if (!capacityGroups[capacityKey]) {
            capacityGroups[capacityKey] = [];
        }
        capacityGroups[capacityKey].push(machine);
    });

    const sortedGroups = Object.entries(capacityGroups)
        .sort(([, groupA], [, groupB]) => {
            const capacityA = groupA[0].capacityValue;
            const capacityB = groupB[0].capacityValue;
            return capacityB - capacityA;
        });

    let groupNumber = 1;
    const newNames = {};

    sortedGroups.forEach(([capacityKey, machines]) => {
        machines.sort((a, b) => a.machineId.localeCompare(b.machineId));

        machines.forEach((machine, index) => {
            const letter = String.fromCharCode(65 + index);
            const newName = `${machineType}-${groupNumber.toString().padStart(2, '0')}${letter} (${machine.power})`;
            newNames[machine.machineId] = newName;
        });

        groupNumber++;
    });

    if (currentMachineId) {
        return newNames[currentMachineId] || machineType;
    } else {
        Object.entries(newNames).forEach(([machineId, newName]) => {
            const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
            if (machineElement) {
                const titleInput = machineElement.querySelector('.machine-title-editable');
                if (titleInput && titleInput.value !== newName) {
                    titleInput.value = newName;
                }
            }
        });
    }
}

/**
 * üÜï OBT√âM VALOR NUM√âRICO DA CAPACIDADE PARA ORDENA√á√ÉO
 */
function getGenericCapacityValue(powerText) {
    if (!powerText) return 0;

    try {
        const numericMatch = powerText.match(/(\d+[.,]?\d*)/);
        if (numericMatch) {
            return parseFloat(numericMatch[0].replace(',', '.'));
        }
        return 0;
    } catch (error) {
        console.error('Erro ao obter capacidade:', error);
        return 0;
    }
}

// =============================================================================
// FUN√á√ÉO PRINCIPAL PARA CONTROLE DE QUANTIDADE
// =============================================================================

/**
 * üÜï ATUALIZA QUANTIDADE COM BASE NA APLICA√á√ÉO
 * Se aplica√ß√£o for "climatizacao" ‚Üí preenche com valor do backup
 * Se n√£o ‚Üí MANT√âM a quantidade atual (n√£o altera)
 */
function handleAplicacaoChange(machineId) {
    console.log(`üîÑ Aplica√ß√£o alterada na m√°quina ${machineId}`);
    
    const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
    if (!machineElement) return;
    
    const aplicacaoSelect = machineElement.querySelector('.machine-aplicacao-select');
    const qntInput = machineElement.querySelector('.machine-qnt-input');
    const roomId = machineElement.dataset.roomId;
    
    if (!aplicacaoSelect || !qntInput || !roomId) return;
    
    const aplicacao = aplicacaoSelect.value;
    const quantidadeAtual = qntInput.value;
    
    console.log(`   - Aplica√ß√£o selecionada: ${aplicacao}`);
    console.log(`   - Quantidade atual: ${quantidadeAtual}`);
    
    if (aplicacao === "climatizacao") {
        // Para climatiza√ß√£o, tenta pegar do backup
        const backupElement = document.getElementById(`solucao-backup-${roomId}`);
        if (backupElement) {
            const backupText = backupElement.textContent.trim();
            const match = backupText.match(/(\d+)/);
            if (match) {
                const backupValue = parseInt(match[1]);
                if (backupValue > 0) {
                    qntInput.value = backupValue;
                    console.log(`‚úÖ Quantidade atualizada para ${backupValue} (backup: ${backupText})`);
                }
            }
        }
    } else {
        // üî• IMPORTANTE: Para ventila√ß√£o, N√ÉO ALTERA a quantidade
        // A quantidade ser√° controlada pelo m√≥dulo de ventila√ß√£o
        console.log(`üîß √â ventila√ß√£o (${aplicacao}) - MANTENDO quantidade: ${quantidadeAtual}`);
        // N√£o faz nada, mant√©m o valor atual
    }
    
    calculateMachinePrice(machineId);
    
    // NOTIFICAR MUDAN√áA
    notifyMachineFieldChange(machineId, 'aplicacao');
    
    // DISPARA EVENTO PARA O M√ìDULO DE VENTILA√á√ÉO
    const event = new CustomEvent('machineChanged', { 
        detail: { 
            machineId: machineId, 
            roomId: roomId,
            changeType: 'aplicacao',
            aplicacao: aplicacao
        } 
    });
    window.dispatchEvent(event);
}

// =============================================================================
// CONSTRU√á√ÉO DE UI UNIFICADA
// =============================================================================

/**
 * Constr√≥i se√ß√£o completa de m√°quinas
 */
function buildMachinesSection(obraId, projectId, roomName, finalRoomId) {
    if (!finalRoomId) return '';

    return `
    <div class="section-block">
      <div class="section-header-machine">
        <button class="minimizer" onclick="toggleSection('${finalRoomId}-maquinas')">+</button>
        <h4 class="section-title">M√°quinas</h4>
      </div>
      <div class="section-content collapsed" id="section-content-${finalRoomId}-maquinas">
        <div class="machines-container" id="machines-${finalRoomId}">
          <p class="empty-message">Nenhuma m√°quina adicionada ainda.</p>
        </div>
        <div class="add-machine">
            <button class="btn btn-add-secondary" onclick="addMachine('${finalRoomId}')">+ Adicionar M√°quina</button> 
        </div>
        <div class="all-machines-total-price">
          <strong>Total de Maquinas: <span id="total-all-machines-price-${finalRoomId}">R$ 0,00</span></strong>
        </div>
      </div>
    </div>`;
}


/**
 * Constr√≥i HTML de m√°quina individual (modificado para incluir notifica√ß√µes)
 */
function buildMachineHTML(machineId, displayName, machines, roomId) {
    const machineTypes = machines.map(m => m.type);

    return `
    <div class="climatization-machine" data-machine-id="${machineId}" data-room-id="${roomId}">
      <div class="machine-header">
        <button class="minimizer" onclick="toggleMachineSection(this)">‚àí</button>
        <input type="text" class="machine-title-editable" id="title-${machineId}" value="${displayName}" 
               onchange="updateMachineTitle(this, '${machineId}')" onclick="this.select()">
        <button class="btn btn-delete-small" onclick="deleteMachine('${machineId}')">Remover</button>
      </div>
      <div class="machine-content" id="machine-content-${machineId}">
        <div class="climatization-form-grid">
          
          ${buildFormGroup("Tipo:", `<select id="tipo-${machineId}" class="form-input machine-type-select" data-machine-id="${machineId}" onchange="updateMachineOptions(this)"><option value="">Selecionar</option>${machineTypes.map(opt => `<option value="${opt}">${opt}</option>`).join('')}</select>`)}
          ${buildFormGroup("Aplica√ß√£o:", `<select id="aplicacao-${machineId}" class="form-input machine-aplicacao-select" data-machine-id="${machineId}" onchange="handleAplicacaoChange('${machineId}')"><option value="">Selecionar</option><option value="climatizacao">Climatiza√ß√£o</option><option value="pressurizacao">Pressuriza√ß√£o</option><option value="exaustao_bateria">Exaust√£o da sala de bateria</option><option value="exaustao_baia_trafo">Exaust√£o da sala baia de trafo</option></select>`)}
          ${buildFormGroup("Capacidade:", `<select id="capacidade-${machineId}" class="form-input machine-power-select" data-machine-id="${machineId}" onchange="handlePowerChange('${machineId}')" disabled><option value="">Selecionar</option></select>`)}
          ${buildFormGroup("Tens√£o:", buildSelect([], machineId, "machine-voltage-select", `calculateMachinePrice('${machineId}')`, true))}
          ${buildFormGroup("Qnt:", `<input id="solution-${machineId}" type="number" class="form-input machine-qnt-input" data-machine-id="${machineId}" min="1" value="1" onchange="updateQuantity('${machineId}')">`)}
          ${buildFormGroup("Pre√ßo Base:", `<div class="price-display" id="base-price-${machineId}">R$ 0,00</div>`)}
          ${buildFormGroup("Pre√ßo Total:", `<div class="price-display" id="total-price-${machineId}">R$ 0,00</div>`)}
        </div>
        <div class="machine-options-section">
          <h6>Op√ß√µes Adicionais:</h6>
          <div class="options-grid" id="options-container-${machineId}">
            <p class="empty-options-message">Selecione tipo e capacidade</p>
          </div>
        </div>
        <div class="machine-config-section">
            <h6>Configura√ß√µes de Instala√ß√£o:</h6>
            <div class="config-grid" id="config-container-${machineId}">
                <p class="empty-config-message">Selecione tipo e capacidade</p>
            </div>
        </div>
      </div>
    </div>`;
}

// =============================================================================
// COMPONENTES UI REUTILIZ√ÅVEIS
// =============================================================================

/**
 * Constr√≥i grupo de formul√°rio
 */
function buildFormGroup(label, content) {
    return `<div class="form-group"><label>${label}</label>${content}</div>`;
}

/**
 * Constr√≥i elemento select
 */
function buildSelect(options, machineId, className, onchangeHandler, disabled = false, selectedValue = '') {
    const disabledAttr = disabled ? 'disabled' : '';
    
    const getOptionText = (value) => {
        const mapping = {
            "climatizacao": "Climatiza√ß√£o",
            "pressurizacao": "Pressuriza√ß√£o",
            "exaustao_bateria": "Exaust√£o da sala de bateria",
            "exaustao_baia_trafo": "Exaust√£o da sala baia de trafo"
        };
        return mapping[value] || value;
    };

    const optionsHTML = options.map(opt => {
        const optionText = getOptionText(opt);
        return `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${optionText}</option>`;
    }).join('');

    return `
    <select class="form-input ${className}" data-machine-id="${machineId}" 
            onchange="${onchangeHandler}" ${disabledAttr}>
      <option value="">Selecionar</option>${optionsHTML}
    </select>`;
}

/**
 * Constr√≥i op√ß√µes da m√°quina
 */
function buildOptionsHTML(options, machineId, selectedOptions = [], selectedPower = null) {
    if (!options?.length) return '<p class="empty-options-message">Nenhuma op√ß√£o dispon√≠vel</p>';

    return options.map(option => {
        const isChecked = selectedOptions.some(selected => selected.id === option.id);
        const optionValue = selectedPower && option.values?.[selectedPower] || 0;
        const displayValue = `+R$ ${optionValue.toLocaleString("pt-BR")}`;

        return `
        <div class="option-item ${isChecked ? 'option-selected' : ''}" onclick="toggleOption('${machineId}', ${option.id})">
          <div class="option-checkbox">
            <input type="checkbox" value="${optionValue}" data-option-id="${option.id}" 
                   data-option-name="${option.name}" id="option-${machineId}-${option.id}"
                   onchange="updateOptionSelection('${machineId}', ${option.id}); calculateMachinePrice('${machineId}')"
                   ${isChecked ? 'checked' : ''}>
            <div class="option-content">
              <div class="option-name">${option.name}</div>
              <div class="option-price">${displayValue}</div>
            </div>
          </div>
        </div>`;
    }).join('');
}

/**
 * CONSTR√ìI HTML DAS CONFIGURA√á√ïES DE INSTALA√á√ÉO
 */
function buildConfigHTML(configuracoes, machineId, configuracoesSelecionadas = [], potencia = '') {
    if (!configuracoes || !Array.isArray(configuracoes) || configuracoes.length === 0) {
        return '<p class="empty-config-message">Nenhuma configura√ß√£o dispon√≠vel</p>';
    }

    return configuracoes.map(config => {
        const isSaved = configuracoesSelecionadas.some(savedConfig => {
            if (typeof savedConfig === 'object') {
                return savedConfig.id === config.id || savedConfig.nome === config.nome;
            }
            return savedConfig === config.id || savedConfig === config.nome;
        });

        const isChecked = isSaved;
        const configName = config.nome;
        const isBocalInsuflamento = configName === "Bocal de insuflamento protegido por grelha diretamente no ambiente";
        const isBocalAcoplado = configName === "Bocal acoplado √† rede de dutos por lona flex√≠vel. Distribui√ß√£o por grelhas";
        const isExclusiveGroup = isBocalInsuflamento || isBocalAcoplado;

        return `
        <div class="config-option ${isChecked ? 'config-selected' : ''} ${isExclusiveGroup ? 'exclusive-group' : ''}" 
             onclick="toggleConfig('${machineId}', ${config.id})">
            <div class="config-checkbox">
                <input type="checkbox" data-config-id="${config.id}" 
                       data-config-name="${configName}" 
                       data-exclusive-group="${isExclusiveGroup ? 'bocal-distribuicao' : ''}"
                       id="config-${machineId}-${config.id}"
                       onchange="handleConfigChange('${machineId}', ${config.id})"
                       ${isChecked ? 'checked' : ''}>
                <div class="config-content">
                    <div class="config-name">${configName}</div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// =============================================================================
// GERENCIAMENTO DE M√ÅQUINAS
// =============================================================================

/**
 * Adiciona nova m√°quina COM NOME SIMPLES INICIAL
 */
async function addMachine(roomId) {
    const container = document.getElementById(`machines-${roomId}`);
    if (!container) return;

    const machineId = generateMachineId(roomId);
    const machineCount = container.querySelectorAll(".climatization-machine").length;

    try {
        const machinesData = await loadMachinesData();
        if (!machinesData.machines.length) throw new Error("Nenhum dado dispon√≠vel");

        const autoName = `Maquina ${machineCount + 1}`;
        const machineHTML = buildMachineHTML(machineId, autoName, machinesData.machines, roomId);
        container.insertAdjacentHTML("beforeend", machineHTML);

        const emptyMsg = container.querySelector('.empty-message');
        if (emptyMsg) emptyMsg.remove();

        updateAllMachinesTotal(roomId);
        
        console.log(`‚úÖ M√°quina ${autoName} adicionada √† sala ${roomId}`);
        
        // üÜï DISPARA EVENTO PARA O M√ìDULO DE VENTILA√á√ÉO
        const event = new CustomEvent('machineAdded', { 
            detail: { 
                machineId: machineId, 
                roomId: roomId,
                machineName: autoName 
            } 
        });
        window.dispatchEvent(event);
        
        return true;
    } catch (error) {
        console.error("‚ùå Erro ao adicionar m√°quina:", error);
        showEmptyMessage(container, "Erro ao carregar dados");
    }
}


// =============================================================================
// ATUALIZA√á√ÉO DE UI
// =============================================================================

/**
 * Atualiza op√ß√µes da m√°quina
 */
async function updateMachineOptions(selectElement) {
    const machineId = selectElement.dataset.machineId;
    const selectedType = selectElement.value;

    if (!selectedType) {
        resetMachineFields(machineId);
        
        const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
        if (machineElement) {
            const titleInput = machineElement.querySelector('.machine-title-editable');
            const container = document.getElementById(`machines-${machineElement.dataset.roomId}`);
            const machineCount = container ? container.querySelectorAll(".climatization-machine").length : 1;
            
            if (titleInput && !titleInput.value.includes('Maquina')) {
                titleInput.value = `Maquina ${machineCount}`;
            }
        }
        
        // NOTIFICAR MUDAN√áA
        notifyMachineFieldChange(machineId, 'tipo');
        return;
    }

    try {
        const machinesData = window.machinesData || [];
        const machine = machinesData.find(m => m.type === selectedType);

        if (machine) {
            updateMachineUI(machineId, machine);
            
            const aplicacaoSelect = document.querySelector(`.machine-aplicacao-select[data-machine-id="${machineId}"]`);
            if (aplicacaoSelect) {
                if (machine.type === "Tubo Axial") {
                    aplicacaoSelect.value = "";
                } else {
                    const aplicacaoValue = machine.aplicacao;
                    let mappedValue = aplicacaoValue;
                    
                    if (aplicacaoValue === "pressurizacao_ventilacao") {
                        mappedValue = "pressurizacao";
                    } else if (aplicacaoValue === "climatizacao") {
                        mappedValue = "climatizacao";
                    } else if (aplicacaoValue === "exaustao") {
                        mappedValue = "";
                    }
                    
                    const option = Array.from(aplicacaoSelect.options).find(opt => opt.value === mappedValue);
                    if (option) {
                        aplicacaoSelect.value = mappedValue;
                        // SE FOR CLIMATIZA√á√ÉO, ATUALIZAR QUANTIDADE
                        if (mappedValue === "climatizacao") {
                            handleAplicacaoChange(machineId);
                        }
                    }
                }
            }
            
            const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
            if (machineElement) {
                const powerSelect = machineElement.querySelector('.machine-power-select');
                if (powerSelect && powerSelect.value) {
                    const roomId = machineElement.dataset.roomId;
                    const newName = generateMachineName(selectedType, roomId, machineId);
                    
                    const titleInput = machineElement.querySelector('.machine-title-editable');
                    if (titleInput) {
                        titleInput.value = newName;
                    }
                } else {
                    const titleInput = machineElement.querySelector('.machine-title-editable');
                    if (titleInput) {
                        titleInput.value = selectedType;
                    }
                }
            }
            
        } else {
            resetMachineFields(machineId);
        }
    } catch (error) {
        console.error("‚ùå Erro em updateMachineOptions:", error);
        resetMachineFields(machineId);
    }
    
    // NOTIFICAR MUDAN√áA
    notifyMachineFieldChange(machineId, 'tipo');
}

/**
 * ATUALIZA UI COMPLETA DA M√ÅQUINA
 */
function updateMachineUI(machineId, machine) {
    const potencies = Object.keys(machine.baseValues || {});
    const voltages = (machine.voltages || []).map(v => v.name);

    updateSelectUI(`.machine-power-select[data-machine-id="${machineId}"]`, potencies, false);
    updateSelectUI(`.machine-voltage-select[data-machine-id="${machineId}"]`, voltages, false);

    const optionsContainer = document.getElementById(`options-container-${machineId}`);
    if (optionsContainer) {
        optionsContainer.innerHTML = machine.options?.length
            ? buildOptionsHTML(machine.options, machineId)
            : '<p class="empty-options-message">Nenhuma op√ß√£o dispon√≠vel</p>';
    }

    const configContainer = document.getElementById(`config-container-${machineId}`);
    if (configContainer) {
        if (machine.configuracoes_instalacao?.length) {
            const configHTML = buildConfigHTML(machine.configuracoes_instalacao, machineId);
            configContainer.innerHTML = '';
            configContainer.insertAdjacentHTML('beforeend', configHTML);
        } else {
            configContainer.innerHTML = '<p class="empty-config-message">Nenhuma configura√ß√£o dispon√≠vel</p>';
        }
    }

    updateElementText(`base-price-${machineId}`, 'R$ 0,00');
    updateElementText(`total-price-${machineId}`, 'R$ 0,00');
}

/**
 * Atualiza select na UI
 */
function updateSelectUI(selector, options, disabled = false) {
    const select = document.querySelector(selector);
    if (select) {
        const getOptionText = (value) => {
            const mapping = {
                "climatizacao": "Climatiza√ß√£o",
                "pressurizacao": "Pressuriza√ß√£o",
                "exaustao_bateria": "Exaust√£o da sala de bateria",
                "exaustao_baia_trafo": "Exaust√£o da sala baia de trafo"
            };
            return mapping[value] || value;
        };

        const optionsHTML = options.map(opt => {
            const optionText = getOptionText(opt);
            return `<option value="${opt}">${optionText}</option>`;
        }).join('');
        
        select.innerHTML = `<option value="">Selecionar</option>${optionsHTML}`;
        select.disabled = disabled;
    }
}

/**
 * RESETA CAMPOS DA M√ÅQUINA
 */
function resetMachineFields(machineId) {
    updateSelectUI(`.machine-power-select[data-machine-id="${machineId}"]`, [], true);
    updateSelectUI(`.machine-voltage-select[data-machine-id="${machineId}"]`, [], true);
    
    const aplicacaoSelect = document.querySelector(`.machine-aplicacao-select[data-machine-id="${machineId}"]`);
    if (aplicacaoSelect) {
        aplicacaoSelect.value = "";
    }

    const optionsContainer = document.getElementById(`options-container-${machineId}`);
    if (optionsContainer) {
        optionsContainer.innerHTML = '<p class="empty-options-message">Selecione um tipo de m√°quina</p>';
    }

    const configContainer = document.getElementById(`config-container-${machineId}`);
    if (configContainer) {
        configContainer.innerHTML = '<p class="empty-config-message">Selecione um tipo de m√°quina</p>';
    }

    updateElementText(`base-price-${machineId}`, 'R$ 0,00');
    updateElementText(`total-price-${machineId}`, 'R$ 0,00');
}

// =============================================================================
// C√ÅLCULOS DE PRE√áO
// =============================================================================

/**
 * Atualiza a quantidade e recalcula o pre√ßo
 */
function updateQuantity(machineId) {
    const qntInput = document.querySelector(`.machine-qnt-input[data-machine-id="${machineId}"]`);
    if (!qntInput) return;

    const quantidade = Math.max(1, parseInt(qntInput.value) || 1);
    qntInput.value = quantidade;

    calculateMachinePrice(machineId);
}

/**
 * Calcula pre√ßo da m√°quina
 */
function calculateMachinePrice(machineId) {
    const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
    if (!machineElement) return;

    const typeSelect = machineElement.querySelector('.machine-type-select');
    const powerSelect = machineElement.querySelector('.machine-power-select');
    const voltageSelect = machineElement.querySelector('.machine-voltage-select');
    const qntInput = machineElement.querySelector('.machine-qnt-input');

    const selectedType = typeSelect?.value;
    const selectedPower = powerSelect?.value;
    const selectedVoltage = voltageSelect?.value;
    const quantidade = qntInput ? parseInt(qntInput.value) || 1 : 1;

    let basePrice = 0, voltageValue = 0;

    if (selectedType && selectedPower && window.machinesData) {
        const machine = window.machinesData.find(m => m.type === selectedType);
        basePrice = machine?.baseValues?.[selectedPower] || 0;
    }

    if (selectedType && selectedVoltage && window.machinesData) {
        const machine = window.machinesData.find(m => m.type === selectedType);
        const voltageObj = machine?.voltages?.find(v => v.name === selectedVoltage);
        voltageValue = voltageObj?.value || 0;
    }

    let optionsTotal = 0;
    const optionsContainer = document.getElementById(`options-container-${machineId}`);
    if (optionsContainer) {
        optionsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(option => {
            optionsTotal += safeNumber(option.value);
        });
    }

    const basePriceUnitario = basePrice + voltageValue;
    const totalPriceUnitario = basePriceUnitario + optionsTotal;
    const totalPriceFinal = totalPriceUnitario * quantidade;

    updateElementText(`base-price-${machineId}`, `R$ ${basePriceUnitario.toLocaleString("pt-BR")}`);
    updateElementText(`total-price-${machineId}`, `R$ ${totalPriceFinal.toLocaleString("pt-BR")}`);

    const roomId = machineElement.dataset.roomId;
    if (roomId) updateAllMachinesTotal(roomId);
}

/**
 * Atualiza valores das op√ß√µes
 */
function updateOptionValues(machineId) {
    const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
    if (!machineElement) return;

    const typeSelect = machineElement.querySelector('.machine-type-select');
    const powerSelect = machineElement.querySelector('.machine-power-select');

    const selectedType = typeSelect?.value;
    const selectedPower = powerSelect?.value;

    if (!selectedType || !selectedPower || !window.machinesData) return;

    const machine = window.machinesData.find(m => m.type === selectedType);
    if (!machine?.options) return;

    machine.options.forEach(option => {
        const checkbox = document.getElementById(`option-${machineId}-${option.id}`);
        if (checkbox) {
            const optionValue = selectedPower && option.values?.[selectedPower] || 0;
            checkbox.value = optionValue;

            const priceDisplay = checkbox.closest('.option-item')?.querySelector('.option-price');
            if (priceDisplay) {
                priceDisplay.textContent = `+R$ ${optionValue.toLocaleString("pt-BR")}`;
            }
        }
    });

    calculateMachinePrice(machineId);
}

// =============================================================================
// FUN√á√ïES DE INTERA√á√ÉO DO USU√ÅRIO
// =============================================================================

function toggleMachineSection(button) {
    const content = button.closest(".climatization-machine").querySelector(".machine-content");
    const isCollapsed = content.classList.toggle("collapsed");
    button.textContent = isCollapsed ? "+" : "‚àí";
}

function updateMachineTitle(input, machineId) {
    if (!input.value.trim()) {
        const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
        const container = document.getElementById(`machines-${machineElement.dataset.roomId}`);
        const machineCount = container ? container.querySelectorAll(".climatization-machine").length : 1;
        
        if (input && !input.value.includes('Maquina')) {
            input.value = `Maquina ${machineCount}`;
        }
        
        // NOTIFICAR MUDAN√áA
        notifyMachineFieldChange(machineId, 'title');
    }
}

function toggleOption(machineId, optionId) {
    const checkbox = document.getElementById(`option-${machineId}-${optionId}`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
    }
}

function updateOptionSelection(machineId, optionId) {
    const checkbox = document.getElementById(`option-${machineId}-${optionId}`);
    const item = checkbox?.closest('.option-item');
    if (item) {
        item.classList.toggle('option-selected', checkbox.checked);
    }
}

function handlePowerChange(machineId) {
    calculateMachinePrice(machineId);
    updateOptionValues(machineId);

    const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
    if (machineElement) {
        const typeSelect = machineElement.querySelector('.machine-type-select');
        const powerSelect = machineElement.querySelector('.machine-power-select');
        const roomId = machineElement.dataset.roomId;

        if (typeSelect && typeSelect.value && powerSelect && powerSelect.value) {
            generateMachineName(typeSelect.value, roomId);
        } else if (typeSelect && typeSelect.value && (!powerSelect || !powerSelect.value)) {
            const titleInput = machineElement.querySelector('.machine-title-editable');
            if (titleInput) {
                titleInput.value = typeSelect.value;
            }
        }
    }
    
    // NOTIFICAR MUDAN√áA
    notifyMachineFieldChange(machineId, 'capacidade');
    
    // DISPARA EVENTO PARA O M√ìDULO DE VENTILA√á√ÉO
    if (machineElement) {
        const roomId = machineElement.dataset.roomId;
        const event = new CustomEvent('machineChanged', { 
            detail: { 
                machineId: machineId, 
                roomId: roomId,
                changeType: 'power'
            } 
        });
        window.dispatchEvent(event);
    }
}

function deleteMachine(machineId) {
    const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
    if (!machineElement) return;

    const roomId = machineElement.dataset.roomId;
    const container = machineElement.closest(".machines-container");
    const machineName = machineElement.querySelector('.machine-title-editable')?.value || 'M√°quina';

    machineElement.remove();

    if (roomId) {
        updateAllMachineNamesInRoom(roomId);
        updateAllMachinesTotal(roomId);
        
        // NOTIFICAR MUDAN√áA PARA ATUALIZAR VENTILA√á√ÉO
        if (window.refreshVentilationForRoom) {
            window.refreshVentilationForRoom(roomId);
        }
        
        // DISPARA EVENTO PARA O M√ìDULO DE VENTILA√á√ÉO
        const event = new CustomEvent('machineRemoved', { 
            detail: { 
                machineId: machineId, 
                roomId: roomId,
                machineName: machineName 
            } 
        });
        window.dispatchEvent(event);
    }

    if (container && container.querySelectorAll('.climatization-machine').length === 0) {
        showEmptyMessage(container, "Nenhuma m√°quina adicionada ainda.");
    }
}


function toggleConfig(machineId, configId) {
    const checkbox = document.getElementById(`config-${machineId}-${configId}`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        handleConfigChange(machineId, configId);
    }
}

function updateConfigSelection(machineId, configId) {
    const checkbox = document.getElementById(`config-${machineId}-${configId}`);
    const item = checkbox?.closest('.config-option');
    if (item) {
        item.classList.toggle('config-selected', checkbox.checked);
    }
}

function handleConfigChange(machineId, configId) {
    const checkbox = document.getElementById(`config-${machineId}-${configId}`);
    if (!checkbox) return;

    updateConfigSelection(machineId, configId);

    const isExclusiveGroup = checkbox.getAttribute('data-exclusive-group') === 'bocal-distribuicao';
    if (isExclusiveGroup && checkbox.checked) {
        deselectOtherBocalOptions(machineId, configId);
    }

    calculateMachinePrice(machineId);
}

function deselectOtherBocalOptions(machineId, selectedConfigId) {
    const machineElement = document.querySelector(`[data-machine-id="${machineId}"]`);
    if (!machineElement) return;

    const bocalCheckboxes = machineElement.querySelectorAll('input[data-exclusive-group="bocal-distribuicao"]');

    bocalCheckboxes.forEach(checkbox => {
        const configId = parseInt(checkbox.getAttribute('data-config-id'));
        if (configId !== selectedConfigId && checkbox.checked) {
            checkbox.checked = false;
            updateConfigSelection(machineId, configId);
        }
    });
}

// =============================================================================
// FUN√á√ïES AUXILIARES
// =============================================================================

function showEmptyMessage(container, message) {
    const existing = container.querySelector('.empty-message');
    if (existing) existing.remove();
    container.insertAdjacentHTML('beforeend', `<p class="empty-message">${message}</p>`);
}

function removeEmptyMessage(container) {
    const emptyMsg = container.querySelector('.empty-message');
    if (emptyMsg) emptyMsg.remove();
}

function calculateAllMachinesTotal(roomId) {
    const container = document.getElementById(`machines-${roomId}`);
    if (!container) return 0;

    let total = 0;
    container.querySelectorAll('.climatization-machine').forEach(machineElement => {
        const machineId = machineElement.dataset.machineId;
        const priceElement = document.getElementById(`total-price-${machineId}`);
        if (priceElement) {
            const priceText = priceElement.textContent;
            const cleanText = priceText.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
            total += safeNumber(cleanText);
        }
    });

    return total;
}

function updateAllMachinesTotal(roomId) {
    const total = calculateAllMachinesTotal(roomId);
    const display = document.getElementById(`total-all-machines-price-${roomId}`);
    if (display) {
        display.textContent = `R$ ${total.toLocaleString('pt-BR')}`;
    }
}

function updateAllMachineNamesInRoom(roomId) {
    const container = document.getElementById(`machines-${roomId}`);
    if (!container) return;

    const machines = Array.from(container.querySelectorAll('.climatization-machine'));
    const machineTypes = new Set();

    machines.forEach(machine => {
        const typeSelect = machine.querySelector('.machine-type-select');
        if (typeSelect && typeSelect.value) {
            machineTypes.add(typeSelect.value);
        }
    });

    machineTypes.forEach(type => {
        generateMachineName(type, roomId);
    });
}

// =============================================================================
// EXPORTA√á√ïES E GLOBAIS
// =============================================================================

export {
    buildMachinesSection,
    loadMachinesData,
    addMachine,
    buildMachineHTML,
    toggleMachineSection,
    updateMachineTitle,
    updateMachineOptions,
    updateMachineUI,
    resetMachineFields,
    calculateMachinePrice,
    deleteMachine,
    toggleOption,
    updateOptionSelection,
    updateOptionValues,
    handlePowerChange,
    calculateAllMachinesTotal,
    updateAllMachinesTotal,
    generateMachineId,
    buildConfigHTML,
    toggleConfig,
    updateConfigSelection,
    handleConfigChange,
    deselectOtherBocalOptions,
    buildOptionsHTML,
    updateSelectUI,
    showEmptyMessage,
    removeEmptyMessage,
    updateQuantity,
    generateMachineName,
    getGenericCapacityValue,
    updateAllMachineNamesInRoom,
    handleAplicacaoChange,
    notifyMachineFieldChange
};

// üÜï DISPONIBILIZA√á√ÉO GLOBAL SIMPLIFICADA
if (typeof window !== 'undefined') {
    window.handleAplicacaoChange = handleAplicacaoChange;
    window.updateMachineOptions = updateMachineOptions;
    window.calculateMachinePrice = calculateMachinePrice;
    window.updateQuantity = updateQuantity;
    window.deleteMachine = deleteMachine;
    window.addMachine = addMachine;
    window.toggleMachineSection = toggleMachineSection;
    window.handlePowerChange = handlePowerChange;
    window.generateMachineName = generateMachineName;
    window.notifyMachineFieldChange = notifyMachineFieldChange;
    window.updateMachineTitle = updateMachineTitle;

    console.log('‚úÖ Fun√ß√µes principais carregadas no escopo global');
    
}
/* ==== FIM: data/modules/machines/machines-core.js ==== */

/* ==== IN√çCIO: data/modules/ventilacao.js ==== */
/**
 * M√ìDULO DE VENTILA√á√ÉO - INTEGRA√á√ÉO COM SISTEMA DE M√ÅQUINAS EXISTENTE
 * @module data/modules/ventilacao.js
 * 
 * CORRIGIDO: Agora recalcula a solu√ß√£o sempre que os par√¢metros mudam,
 * mas respeita as edi√ß√µes manuais do usu√°rio
 */

// =============================================================================
// CONSTANTES E CONFIGURA√á√ïES
// =============================================================================

// Mapeamento aplica√ß√£o ‚Üí texto leg√≠vel
const APPLICATION_TEXT_MAP = {
    'pressurizacao': 'Pressuriza√ß√£o',
    'exaustao_bateria': 'Exaust√£o da Sala de Bateria',
    'exaustao_baia_trafo': 'Exaust√£o da Baia de Trafo'
};

// Aplica√ß√µes v√°lidas que disparam c√°lculos
const VALID_APPLICATIONS = ['pressurizacao', 'exaustao_bateria', 'exaustao_baia_trafo'];

// Fatores de convers√£o
const FATOR_CONVERSAO_W_CAL = 859.85;
const FATOR_PRESSURIZACAO = 3.6;

// Store para controle por sala
const ventilationState = new Map();

// =============================================================================
// FUN√á√ïES UTILIT√ÅRIAS
// =============================================================================

/**
 * OBT√âM CONSTANTES DO SISTEMA
 */
function getSystemConstants() {
    if (!window.systemConstants) {
        throw new Error('window.systemConstants n√£o dispon√≠vel');
    }

    const Densi_ar = window.systemConstants.Densi_ar?.value;
    const fatorEspecifico = window.systemConstants.fatorEspecifico?.value;

    if (!Densi_ar || typeof Densi_ar !== 'number') {
        throw new Error('Constante Densi_ar n√£o encontrada');
    }
    if (!fatorEspecifico || typeof fatorEspecifico !== 'number') {
        throw new Error('Constante fatorEspecifico n√£o encontrada');
    }

    return { Densi_ar, fatorEspecifico };
}

/**
 * EXTRAI VALOR NUM√âRICO DO SELECT DE CAPACIDADE
 */
function extractCapacidadeValue(capacidadeValue) {
    if (!capacidadeValue) return null;
    const match = capacidadeValue.match(/^(\d+(?:\.\d+)?)/);
    return match ? parseFloat(match[1]) : null;
}

/**
 * FORMATA N√öMERO PARA EXIBI√á√ÉO
 */
function formatNumber(value, decimals = 2) {
    if (value === null || value === undefined || isNaN(value)) return '-';
    const formatted = value.toFixed(decimals).replace('.', ',');
    const parts = formatted.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return parts.join(',');
}

/**
 * COLETA INPUTS T√âCNICOS DA SALA
 */
function collectRoomInputs(roomId) {
    console.log(`üìä [collectRoomInputs] Coletando inputs para sala ${roomId}`);
    
    const inputs = {};
    
    // Busca pelos elementos espec√≠ficos
    const vazaoArElement = document.getElementById(`vazao-ar-${roomId}`);
    const volumeElement = document.getElementById(`volume-${roomId}`);
    const potenciaElement = document.getElementById(`potencia-${roomId}`);
    const tempInternaElement = document.getElementById(`temp-interna-${roomId}`);
    const tempExternaElement = document.getElementById(`temp-externa-${roomId}`);
    
    // Para vazaoAr, pode ser um div com textContent ou um input
    if (vazaoArElement) {
        if (vazaoArElement.tagName === 'DIV' || vazaoArElement.classList.contains('result-value-inline')) {
            inputs.vazaoAr = parseFloat(vazaoArElement.textContent);
        } else if (vazaoArElement.tagName === 'INPUT') {
            inputs.vazaoAr = parseFloat(vazaoArElement.value);
        }
    } else {
        inputs.vazaoAr = null;
    }
    
    inputs.volume = volumeElement ? parseFloat(volumeElement.value) : null;
    inputs.potencia = potenciaElement ? parseFloat(potenciaElement.value) : null;
    inputs.tempInterna = tempInternaElement ? parseFloat(tempInternaElement.value) : 45;
    inputs.tempExterna = tempExternaElement ? parseFloat(tempExternaElement.value) : 35;
    
    return inputs;
}

// =============================================================================
// FUN√á√ïES DE C√ÅLCULO
// =============================================================================

/**
 * CALCULA VAZ√ÉO POR APLICA√á√ÉO
 */
function calculateVazaoByAplicacao(aplicacao, roomId, inputs) {
    switch (aplicacao) {
        case 'pressurizacao': {
            if (!inputs.vazaoAr || isNaN(inputs.vazaoAr)) {
                return null;
            }
            return inputs.vazaoAr * FATOR_PRESSURIZACAO;
        }
        
        case 'exaustao_bateria': {
            if (!inputs.volume || isNaN(inputs.volume)) {
                return null;
            }
            return inputs.volume * 12;
        }
        
        case 'exaustao_baia_trafo': {
            if (!inputs.potencia || isNaN(inputs.potencia)) {
                return null;
            }
            
            const deltaT = inputs.tempInterna - inputs.tempExterna;
            const deltaTAbs = Math.abs(deltaT);
            
            if (deltaTAbs === 0) {
                return null;
            }
            
            const constants = getSystemConstants();
            const Q = inputs.potencia * FATOR_CONVERSAO_W_CAL;
            const massaGR = Q / (constants.fatorEspecifico * deltaTAbs);
            const massaAr = massaGR / 1000;
            const vazao = massaAr / constants.Densi_ar;
            
            return deltaT < 0 ? -vazao : vazao;
        }
        
        default:
            return null;
    }
}

// =============================================================================
// ATUALIZA√á√ÉO DAS TABELAS
// =============================================================================

/**
 * ATUALIZA TABELA 1 - C√°lculo T√©cnico
 */
function updateTechnicalTable(roomId, inputs) {
    const elements = {
        q: document.getElementById(`q-cal-${roomId}`),
        deltaT: document.getElementById(`delta-t-${roomId}`),
        massaGrama: document.getElementById(`massa-gramas-${roomId}`),
        massa: document.getElementById(`massa-ar-${roomId}`),
        vazao: document.getElementById(`vazao-${roomId}`)
    };
    
    // Se n√£o tem pot√™ncia, limpa resultados
    if (!inputs.potencia || isNaN(inputs.potencia)) {
        Object.values(elements).forEach(el => {
            if (el) {
                el.textContent = '-';
                el.classList.remove('negative');
            }
        });
        return;
    }
    
    const deltaT = inputs.tempInterna - inputs.tempExterna;
    const isDeltaTNegative = deltaT < 0;
    const deltaTAbs = Math.abs(deltaT);
    
    try {
        const constants = getSystemConstants();
        const Q = inputs.potencia * FATOR_CONVERSAO_W_CAL;
        
        let massaGR, massaAr, vazao;
        
        if (deltaTAbs > 0) {
            massaGR = Q / (constants.fatorEspecifico * deltaTAbs);
            massaAr = massaGR / 1000;
            vazao = massaAr / constants.Densi_ar;
            
            if (isDeltaTNegative) {
                massaGR = -massaGR;
                massaAr = -massaAr;
                vazao = -vazao;
            }
        } else {
            massaGR = 0;
            massaAr = 0;
            vazao = 0;
        }
        
        if (elements.q) {
            elements.q.textContent = formatNumber(Q);
            elements.q.classList.remove('negative');
        }
        
        if (elements.deltaT) {
            elements.deltaT.textContent = formatNumber(deltaT, 1);
            if (deltaT < 0) {
                elements.deltaT.classList.add('negative');
            } else {
                elements.deltaT.classList.remove('negative');
            }
        }
        
        if (elements.massaGrama) {
            elements.massaGrama.textContent = formatNumber(massaGR);
            if (massaGR < 0) {
                elements.massaGrama.classList.add('negative');
            } else {
                elements.massaGrama.classList.remove('negative');
            }
        }
        
        if (elements.massa) {
            elements.massa.textContent = formatNumber(massaAr);
            if (massaAr < 0) {
                elements.massa.classList.add('negative');
            } else {
                elements.massa.classList.remove('negative');
            }
        }
        
        if (elements.vazao) {
            elements.vazao.textContent = formatNumber(vazao);
            if (vazao < 0) {
                elements.vazao.classList.add('negative');
            } else {
                elements.vazao.classList.remove('negative');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao atualizar tabela t√©cnica:', error);
    }
}

/**
 * ATUALIZA TABELA 2 - Solu√ß√£o das M√°quinas
 */
function updateSolutionTable(roomId, inputs) {
    const machinesContainer = document.getElementById(`machines-${roomId}`);
    if (!machinesContainer) {
        setTimeout(() => updateSolutionTable(roomId, inputs), 500);
        return;
    }
    
    const tableBody = document.getElementById(`solucao-body-${roomId}`);
    if (!tableBody) return;
    
    const machines = machinesContainer.querySelectorAll('.climatization-machine');
    
    // Limpa tabela
    tableBody.innerHTML = '';
    
    let hasVentilationMachines = false;
    
    // Calcula a vaz√£o necess√°ria para a sala
    let vazaoNecessaria = null;
    let vazaoNecessariaAbs = null;
    
    // Pega a primeira m√°quina de ventila√ß√£o para determinar a aplica√ß√£o da sala
    for (const machine of machines) {
        const machineId = machine.dataset.machineId;
        const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
        if (!aplicacaoSelect) continue;
        
        const aplicacao = aplicacaoSelect.value;
        if (VALID_APPLICATIONS.includes(aplicacao)) {
            vazaoNecessaria = calculateVazaoByAplicacao(aplicacao, roomId, inputs);
            if (vazaoNecessaria !== null && !isNaN(vazaoNecessaria)) {
                vazaoNecessariaAbs = Math.abs(vazaoNecessaria);
            }
            break;
        }
    }
    
    // Itera sobre todas as m√°quinas
    machines.forEach(machine => {
        const machineId = machine.dataset.machineId;
        
        const titleInput = document.getElementById(`title-${machineId}`);
        const tipoSelect = document.getElementById(`tipo-${machineId}`);
        const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
        const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
        const qntInput = document.getElementById(`solution-${machineId}`);
        
        if (!titleInput || !tipoSelect || !aplicacaoSelect || !capacidadeSelect || !qntInput) return;
        
        const aplicacao = aplicacaoSelect.value;
        
        // Pula se for climatiza√ß√£o ou aplica√ß√£o vazia
        if (aplicacao === 'climatizacao' || !aplicacao) {
            return;
        }
        
        const aplicacaoTexto = APPLICATION_TEXT_MAP[aplicacao] || aplicacao;
        const titulo = titleInput.value || 'M√°quina sem nome';
        const tipo = tipoSelect.options[tipoSelect.selectedIndex]?.text || 'N√£o definido';
        
        // Extrai capacidade
        const capacidadeValue = extractCapacidadeValue(capacidadeSelect.value);
        const capacidadeDisplay = capacidadeValue ? formatNumber(capacidadeValue) : '-';
        
        // Calcula vaz√£o da m√°quina
        let vazaoMaquinaDisplay = '-';
        if (VALID_APPLICATIONS.includes(aplicacao)) {
            const vazaoMaquina = calculateVazaoByAplicacao(aplicacao, roomId, inputs);
            if (vazaoMaquina !== null && !isNaN(vazaoMaquina)) {
                vazaoMaquinaDisplay = formatNumber(Math.abs(vazaoMaquina));
            }
        }
        
        // üî• SISTEMA DE CONTROLE DE EDI√á√ÉO DO USU√ÅRIO - CORRIGIDO
        // Inicializa o atributo se n√£o existir
        if (!qntInput.hasAttribute('data-user-edited')) {
            qntInput.setAttribute('data-user-edited', 'false');
        }
        
        // üî• CALCULA A SOLU√á√ÉO (valor te√≥rico)
        let solucaoNumerica = 1;
        if (capacidadeValue && vazaoNecessariaAbs) {
            solucaoNumerica = Math.ceil(vazaoNecessariaAbs / capacidadeValue);
        }
        
        // üî• REGRA DE NEG√ìCIO CORRIGIDA PARA QUANTIDADE:
        // - Se NUNCA foi editado OU se os par√¢metros mudaram: QUANTIDADE = SOLU√á√ÉO
        // - Se J√Å foi editado E os par√¢metros N√ÉO mudaram: MANT√âM valor manual
        
        // Verifica se os par√¢metros cr√≠ticos mudaram
        const lastParams = qntInput.getAttribute('data-last-params') || '';
        const currentParams = `${aplicacao}_${capacidadeValue}_${vazaoNecessariaAbs}`;
        
        const userEdited = qntInput.getAttribute('data-user-edited') === 'true';
        const paramsChanged = lastParams !== currentParams;
        
        // Se os par√¢metros mudaram, o usu√°rio precisa re-editar para manter o valor manual
        if (paramsChanged) {
            // üî• RESETA O FLAG DE EDI√á√ÉO QUANDO OS PAR√ÇMETROS MUDAM
            qntInput.setAttribute('data-user-edited', 'false');
            
            // Atualiza a quantidade para a nova solu√ß√£o
            qntInput.value = solucaoNumerica;
            
            // Salva os novos par√¢metros
            qntInput.setAttribute('data-last-params', currentParams);
            
            console.log(`üìä [Ventila√ß√£o] Par√¢metros mudaram. Quantidade da m√°quina ${machineId} resetada para ${solucaoNumerica}`);
            
            // Recalcula pre√ßo
            if (window.calculateMachinePrice) {
                window.calculateMachinePrice(machineId);
            }
        } else if (!userEdited) {
            // Se nunca foi editado e par√¢metros n√£o mudaram, usa a solu√ß√£o
            const currentValue = parseInt(qntInput.value) || 1;
            if (currentValue !== solucaoNumerica) {
                qntInput.value = solucaoNumerica;
                
                if (window.calculateMachinePrice) {
                    window.calculateMachinePrice(machineId);
                }
                
                console.log(`üìä [Ventila√ß√£o] Quantidade da m√°quina ${machineId} inicializada para ${solucaoNumerica}`);
            }
        }
        
        // Salva os par√¢metros atuais se ainda n√£o existirem
        if (!qntInput.hasAttribute('data-last-params')) {
            qntInput.setAttribute('data-last-params', currentParams);
        }
        
        // Obt√©m a quantidade ATUAL (pode ser autom√°tica ou manual)
        const quantidadeAtual = parseInt(qntInput.value) || 1;
        
        // üî• CALCULA PERDA E DISSIPA√á√ÉO com a quantidade ATUAL
        let perdaDisplay = '-';
        let dissipacaoDisplay = '-';
        let dissipacaoClass = '';
        
        if (capacidadeValue && vazaoNecessariaAbs) {
            // Perda = Capacidade * Quantidade ATUAL
            const perdaValue = capacidadeValue * quantidadeAtual;
            perdaDisplay = formatNumber(perdaValue);
            
            // Dissipa√ß√£o = Perda - Vaz√£o Necess√°ria
            const dissipacaoValue = perdaValue - vazaoNecessariaAbs;
            dissipacaoDisplay = formatNumber(dissipacaoValue);
            
            // üî• CORRE√á√ÉO: Aplica classe CSS baseada no valor (negativo ou positivo)
            if (dissipacaoValue < 0) {
                dissipacaoClass = 'negative';
            } else if (dissipacaoValue > 0) {
                dissipacaoClass = 'positive';
            } else {
                dissipacaoClass = '';
            }
        }
        
        // Cria a linha da tabela - AGORA COM COLUNA "Qtd. Atual"
        const row = document.createElement('tr');
        row.dataset.machineId = machine.machineId;
        
        row.innerHTML = `
            <td><span id="solucao-title-${machine.machineId}" class="solution-title">${titulo}</span></td>
            <td><span id="solucao-tipo-${machine.machineId}" class="solution-type">${tipo}</span></td>
            <td><span id="solucao-aplicacao-${machine.machineId}" class="solution-application">${aplicacaoTexto}</span></td>
            <td><span id="solucao-capacidade-${machine.machineId}" class="solution-capacity">${capacidadeDisplay}</span></td>
            <td><span id="solucao-qtd-${machine.machineId}" class="solution-quantity">${solucaoNumerica}</span></td>
            <td><span id="solucao-vazao-${machine.machineId}" class="solution-flow">${vazaoMaquinaDisplay}</span></td>
            <td><span id="solucao-qtd-atual-${machine.machineId}" class="solution-current-quantity" style="font-weight: bold; color: #2563eb;">${quantidadeAtual}</span></td>
            <td><span id="solucao-perda-${machine.machineId}" class="solution-loss">${perdaDisplay}</span></td>
            <td><span id="solucao-dissipacao-${machine.machineId}" class="solution-balance ${dissipacaoClass}">${dissipacaoDisplay}</span></td>
        `;
        
        tableBody.appendChild(row);
        hasVentilationMachines = true;
    });
    
    // Mensagem se n√£o h√° m√°quinas de ventila√ß√£o
    if (!hasVentilationMachines) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="9" style="text-align: center; padding: 20px; color: var(--color-gray-500);">
                Nenhuma m√°quina com aplica√ß√£o v√°lida para ventila√ß√£o
            </td>
        `;
        tableBody.appendChild(row);
    }
    
    if (window.updateAllMachinesTotal) {
        window.updateAllMachinesTotal(roomId);
    }
}

// =============================================================================
// HANDLER DE EDI√á√ÉO MANUAL
// =============================================================================

/**
 * Handler para quando o usu√°rio edita manualmente a quantidade
 */
window.handleManualQuantityEdit = function(machineId) {
    const qntInput = document.getElementById(`solution-${machineId}`);
    if (qntInput) {
        // Marca que o usu√°rio editou manualmente
        qntInput.setAttribute('data-user-edited', 'true');
        
        // üî• SALVA OS PAR√ÇMETROS ATUAIS PARA REFER√äNCIA FUTURA
        const machine = document.getElementById(`tipo-${machineId}`)?.closest('.climatization-machine');
        const roomId = machine?.dataset.roomId;
        
        if (roomId) {
            const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
            const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
            
            const aplicacao = aplicacaoSelect?.value || '';
            const capacidadeValue = extractCapacidadeValue(capacidadeSelect?.value);
            
            // Calcula vaz√£o necess√°ria
            const inputs = collectRoomInputs(roomId);
            let vazaoNecessariaAbs = null;
            
            if (VALID_APPLICATIONS.includes(aplicacao)) {
                const vazaoNecessaria = calculateVazaoByAplicacao(aplicacao, roomId, inputs);
                if (vazaoNecessaria !== null && !isNaN(vazaoNecessaria)) {
                    vazaoNecessariaAbs = Math.abs(vazaoNecessaria);
                }
            }
            
            const currentParams = `${aplicacao}_${capacidadeValue}_${vazaoNecessariaAbs}`;
            qntInput.setAttribute('data-last-params', currentParams);
        }
        
        console.log(`üìù [Ventila√ß√£o] Usu√°rio editou manualmente quantidade da m√°quina ${machineId}`);
        
        // Dispara o recalculo da ventila√ß√£o para atualizar perda/dissipa√ß√£o
        if (roomId) {
            setTimeout(() => {
                refreshVentilationForRoom(roomId);
            }, 50);
        }
        
        if (window.calculateMachinePrice) {
            window.calculateMachinePrice(machineId);
        }
    }
};

// =============================================================================
// CONFIGURA√á√ÉO DE LISTENERS
// =============================================================================

/**
 * Configura listener para input de quantidade
 */
function setupQuantityInputListener(machineId) {
    const qntInput = document.getElementById(`solution-${machineId}`);
    if (qntInput) {
        // Remove listener antigo
        if (qntInput._manualEditHandler) {
            qntInput.removeEventListener('change', qntInput._manualEditHandler);
            qntInput.removeEventListener('input', qntInput._manualEditHandler);
        }
        
        // Adiciona novo handler
        qntInput._manualEditHandler = function() {
            window.handleManualQuantityEdit(machineId);
        };
        
        qntInput.addEventListener('change', qntInput._manualEditHandler);
        qntInput.addEventListener('input', qntInput._manualEditHandler);
        
        // Inicializa os atributos
        if (!qntInput.hasAttribute('data-user-edited')) {
            qntInput.setAttribute('data-user-edited', 'false');
        }
        if (!qntInput.hasAttribute('data-last-params')) {
            qntInput.setAttribute('data-last-params', '');
        }
    }
}

/**
 * Configura listeners para inputs t√©cnicos
 */
function setupTechnicalListeners(roomId) {
    const inputIds = [
        `potencia-${roomId}`,
        `temp-interna-${roomId}`,
        `temp-externa-${roomId}`,
        `vazao-ar-${roomId}`,
        `volume-${roomId}`
    ];
    
    inputIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (element._ventListener) {
                element.removeEventListener('input', element._ventListener);
                element.removeEventListener('change', element._ventListener);
            }
            
            element._ventListener = () => refreshVentilationForRoom(roomId);
            element.addEventListener('input', element._ventListener);
            element.addEventListener('change', element._ventListener);
        }
    });
    
    // Configura listeners para inputs de quantidade
    const machines = document.querySelectorAll(`[data-room-id="${roomId}"]`);
    machines.forEach(container => {
        const machineId = container.dataset.machineId;
        if (machineId) {
            setupQuantityInputListener(machineId);
        }
    });
}

/**
 * Configura observer para novas m√°quinas
 */
function setupMachinesObserver(roomId) {
    if (ventilationState.get(roomId)?.observer) return;
    
    const observer = new MutationObserver((mutations) => {
        let shouldRefresh = false;
        
        mutations.forEach(mutation => {
            if (mutation.type === 'childList') {
                if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
                    shouldRefresh = true;
                    
                    // Configura listeners para novas m√°quinas
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) {
                                const newMachines = node.querySelectorAll('[data-machine-id]');
                                newMachines.forEach(machine => {
                                    const machineId = machine.dataset.machineId;
                                    if (machineId) {
                                        setupQuantityInputListener(machineId);
                                    }
                                });
                            }
                        });
                    }
                }
            }
            
            if (mutation.type === 'attributes') {
                const target = mutation.target;
                if (target.id?.startsWith('aplicacao-') || 
                    target.id?.startsWith('capacidade-') ||
                    target.id?.startsWith('tipo-')) {
                    shouldRefresh = true;
                }
            }
        });
        
        if (shouldRefresh) {
            refreshVentilationForRoom(roomId);
        }
    });
    
    const machinesContainer = document.getElementById(`machines-${roomId}`);
    if (machinesContainer) {
        observer.observe(machinesContainer, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['value']
        });
        
        ventilationState.set(roomId, { observer });
    }
}

// =============================================================================
// FUN√á√ÉO PRINCIPAL DE REFRESH
// =============================================================================

window.refreshVentilationForRoom = function(roomId) {
    if (!roomId || !roomId.includes('_proj_') || !roomId.includes('_sala_')) {
        return;
    }
    
    if (!window.systemConstants) {
        setTimeout(() => refreshVentilationForRoom(roomId), 500);
        return;
    }
    
    if (window[`_vent_frame_${roomId}`]) {
        cancelAnimationFrame(window[`_vent_frame_${roomId}`]);
    }
    
    window[`_vent_frame_${roomId}`] = requestAnimationFrame(() => {
        const inputs = collectRoomInputs(roomId);
        updateTechnicalTable(roomId, inputs);
        updateSolutionTable(roomId, inputs);
        delete window[`_vent_frame_${roomId}`];
    });
};

// =============================================================================
// HANDLERS DE EVENTOS (GLOBAIS)
// =============================================================================

window.handleVentilacaoAplicacaoChange = function(machineId) {
    const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
    const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
    const machine = document.getElementById(`tipo-${machineId}`)?.closest('.climatization-machine');
    const roomId = machine?.dataset.roomId;
    
    if (!roomId) return;
    
    const aplicacao = aplicacaoSelect?.value;
    
    if (capacidadeSelect) {
        capacidadeSelect.disabled = !VALID_APPLICATIONS.includes(aplicacao);
        if (capacidadeSelect.disabled) {
            capacidadeSelect.value = '';
        }
    }
    
    refreshVentilationForRoom(roomId);
};

window.handleVentilacaoPowerChange = function(machineId) {
    const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
    const machine = capacidadeSelect?.closest('.climatization-machine');
    const roomId = machine?.dataset.roomId;
    
    if (roomId) {
        refreshVentilationForRoom(roomId);
    }
};

window.handleVentilacaoTipoChange = function(machineId) {
    const tipoSelect = document.getElementById(`tipo-${machineId}`);
    const machine = tipoSelect?.closest('.climatization-machine');
    const roomId = machine?.dataset.roomId;
    
    if (roomId) {
        refreshVentilationForRoom(roomId);
    }
};

// =============================================================================
// CONFIGURA√á√ÉO INICIAL
// =============================================================================

function setupVentilationForRoom(roomId) {
    if (!roomId || !roomId.includes('_proj_') || !roomId.includes('_sala_')) {
        return;
    }
    
    if (ventilationState.get(roomId)?.configured) return;
    
    setupTechnicalListeners(roomId);
    
    const checkContainer = setInterval(() => {
        const container = document.getElementById(`machines-${roomId}`);
        if (container) {
            clearInterval(checkContainer);
            setupMachinesObserver(roomId);
            
            ventilationState.set(roomId, { 
                ...ventilationState.get(roomId),
                configured: true 
            });
            
            refreshVentilationForRoom(roomId);
        }
    }, 500);
    
    ventilationState.set(roomId, { 
        ...ventilationState.get(roomId),
        checkInterval: checkContainer 
    });
}

// =============================================================================
// FUN√á√ÉO PRINCIPAL EXPORTADA
// =============================================================================

export function buildVentilacaoSection(roomId) {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå buildVentilacaoSection: Room ID inv√°lido`);
        return '';
    }
    
    if (!roomId.includes('_proj_') || !roomId.includes('_sala_')) {
        console.warn(`‚ö†Ô∏è ID n√£o parece ser de sala: ${roomId}`);
        return '';
    }
    
    setTimeout(() => {
        setupVentilationForRoom(roomId);
    }, 100);
    
    return `
    <div class="section-block ventilation-section" id="ventilacao-section-${roomId}" data-room-id="${roomId}">
      <div class="section-header">
        <button class="minimizer" onclick="toggleSection('${roomId}ventilacao')">+</button>
        <h4 class="section-title">Ventila√ß√£o</h4>
      </div>
      <div class="section-content collapsed" id="section-content-${roomId}ventilacao">
        
        <!-- TABELA 1 - C√ÅLCULO T√âCNICO -->
        <div class="technical-table">
          <h5>C√°lculo T√©cnico</h5>
          <div class="vertical-table-container">
            <table class="vertical-table">
              <tr>
                <td>Pot√™ncia (kW)</td>
                <td>
                  <input type="number" 
                         id="potencia-${roomId}" 
                         class="vertical-input" 
                         step="any" 
                         placeholder="Ex: 100">
                </td>
              </tr>
              <tr>
                <td>Temp. Int. (¬∞C)</td>
                <td>
                  <input type="number" 
                         id="temp-interna-${roomId}" 
                         class="vertical-input" 
                         step="any" 
                         value="45"
                         placeholder="¬∞C">
                </td>
              </tr>
              <tr>
                <td>Temp. Ext. (¬∞C)</td>
                <td>
                  <input type="number" 
                         id="temp-externa-${roomId}" 
                         class="vertical-input" 
                         step="any" 
                         value="35"
                         placeholder="¬∞C">
                </td>
              </tr>
              <tr>
                <td>Q (cal/h)</td>
                <td><span id="q-cal-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>Massa (gramas)</td>
                <td><span id="massa-gramas-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>ŒîT (¬∞C)</td>
                <td><span id="delta-t-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>Massa de Ar (kg/h)</td>
                <td><span id="massa-ar-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>Vaz. Vol. (m¬≥/h)</td>
                <td><span id="vazao-${roomId}" class="result-venti-value">-</span></td>
              </tr>
            </table>
          </div>
        </div>

        <!-- TABELA 2 - SOLU√á√ÉO DAS M√ÅQUINAS -->
        <div class="solution-table">
          <h5>Solu√ß√£o das M√°quinas</h5>
          <div class="horizontal-table-container">
            <table class="machines-solution-table">
              <thead>
                <tr>
                  <th>Nome da M√°quina</th>
                  <th>Tipo de Ventilador / Filtro</th>
                  <th>Aplica√ß√£o</th>
                  <th>Cap. Unit. (m¬≥/h)</th>
                  <th>Solu√ß√£o</th>
                  <th>Vaz√£o (m¬≥/h)</th>
                  <th>Qtd. Inst.</th>
                  <th>Cap. Total (m¬≥/h)</th>
                  <th>Saldo (m¬≥/h)</th>
                </tr>
              </thead>
              <tbody id="solucao-body-${roomId}">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 20px; color: var(--color-gray-500);">
                    Aguardando m√°quinas...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
}
/* ==== FIM: data/modules/ventilacao.js ==== */
