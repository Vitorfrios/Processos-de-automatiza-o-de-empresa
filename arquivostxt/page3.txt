// ===== SISTEMA DE EDIÇÃO DE DADOS - CRUD COMPLETO =====

let systemData = {
    constants: {},
    machines: [],
    materials: {},
    empresas: []
};
let originalData = {};
let pendingChanges = new Set();
let currentEditItem = null;
let currentEditType = null;
let currentMachineIndex = null;

// ===== FUNÇÕES DE INICIALIZAÇÃO =====

async function loadData() {
    try {
        showLoading('Carregando dados do sistema...');
        
        // Carregar dados do backend
        const response = await fetch('/api/system-data');
        if (!response.ok) {
            throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Verificar se os dados têm a estrutura correta
        if (!data || typeof data !== 'object') {
            throw new Error('Dados recebidos são inválidos');
        }
        
        // Garantir que todas as chaves existam
        systemData = {
            constants: data.constants || {},
            machines: Array.isArray(data.machines) ? data.machines : [],
            materials: data.materials || {},
            empresas: Array.isArray(data.empresas) ? data.empresas : []
        };
        
        originalData = JSON.parse(JSON.stringify(systemData));
        
        // Carregar dados nas tabelas
        loadConstants();
        loadMachines();
        loadMaterials();
        loadEmpresas();
        loadJSONEditor();
        populateMachineFilter();
        
        clearPendingChanges();
        showSuccess('Dados carregados com sucesso!');
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showError(`Erro ao carregar dados: ${error.message}`);
        
        // Fallback para dados estáticos
        await loadFallbackData();
    } finally {
        hideLoading();
    }
}

async function loadFallbackData() {
    try {
        // Tentar carregar dados localmente
        systemData = {
            constants: {},
            machines: [],
            materials: {},
            empresas: []
        };
        
        loadConstants();
        loadMachines();
        loadMaterials();
        loadEmpresas();
        loadJSONEditor();
        populateMachineFilter();
        
        showWarning('Usando dados locais. Algumas funcionalidades podem não estar disponíveis.');
    } catch (error) {
        console.error('Erro no fallback:', error);
        showError('Não foi possível carregar os dados. Verifique sua conexão.');
    }
}

async function saveData() {
    try {
        if (pendingChanges.size === 0) {
            showInfo('Nenhuma alteração para salvar.');
            return;
        }
        
        showLoading('Salvando dados...');
        
        // Validar dados antes de salvar
        if (!validateData()) {
            throw new Error('Dados inválidos encontrados');
        }
        
        // Salvar via API
        const response = await fetch('/api/system-data/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(systemData)
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Erro HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            originalData = JSON.parse(JSON.stringify(systemData));
            clearPendingChanges();
            showSuccess(result.message || 'Dados salvos com sucesso!');
            
            // Recarregar para garantir sincronização
            setTimeout(() => loadData(), 500);
        } else {
            throw new Error(result.error || 'Erro ao salvar dados');
        }
        
    } catch (error) {
        console.error('Erro ao salvar dados:', error);
        showError(`Erro ao salvar: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// ===== FUNÇÕES DE TAB =====

function switchTab(tabName) {
    // Remover classe active de todas as tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    // Adicionar classe active à tab selecionada
    const tab = document.querySelector(`.tab[onclick*="${tabName}"]`);
    if (tab) tab.classList.add('active');
    
    const pane = document.getElementById(`${tabName}Tab`);
    if (pane) pane.classList.add('active');
    
    // Se for a tab de máquinas, fechar detalhe se aberto
    if (tabName !== 'machines') {
        closeMachineDetail();
    }
}

// ===== GERENCIAMENTO DE CONSTANTES =====

function loadConstants() {
    const tbody = document.getElementById('constantsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!systemData.constants) {
        systemData.constants = {};
    }
    
    Object.entries(systemData.constants).forEach(([key, value], index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="text" value="${escapeHtml(key)}" 
                       onchange="updateConstantKey(${index}, this.value)"
                       placeholder="Nome da constante"
                       class="form-input">
            </td>
            <td>
                <input type="text" value="${getConstantDescription(key)}"
                       onchange="updateConstantDescription('${key}', this.value)"
                       placeholder="Descrição"
                       class="form-input">
            </td>
            <td>
                <input type="number" value="${value}" step="0.0001"
                       onchange="updateConstantValue('${key}', this.value)"
                       class="form-input">
            </td>
            <td class="actions-cell">
                <button class="btn btn-small btn-danger" 
                        onclick="deleteConstant('${key}')"
                        title="Excluir constante">
                    <i class="icon-delete"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Adicionar linha vazia para novo item
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `
        <td colspan="4" style="text-align: center; padding: 20px;">
            <button class="btn btn-success" onclick="addConstant()">
                <i class="icon-add"></i> Adicionar Nova Constante
            </button>
        </td>
    `;
    tbody.appendChild(emptyRow);
}

function getConstantDescription(key) {
    const descriptions = {
        'VARIAVEL_PD': 'Variável PD - Fator de projeto',
        'VARIAVEL_PS': 'Variável PS - Fator de segurança',
        'AUX_U_Value_Piso': 'Valor U para piso',
        'AUX_Fator_Iluminacao': 'Fator de iluminação',
        'FATOR_SEGURANCA_CAPACIDADE': 'Fator de segurança para capacidade'
    };
    return descriptions[key] || '';
}

function addConstant() {
    const newKey = `NOVA_CONSTANTE_${Date.now().toString().slice(-6)}`;
    systemData.constants[newKey] = 0;
    loadConstants();
    addPendingChange('constants');
    showInfo('Nova constante adicionada. Edite o nome e valor.');
    
    // Rolar para o novo item
    setTimeout(() => {
        const lastRow = document.querySelector('#constantsTableBody tr:nth-last-child(2)');
        if (lastRow) {
            lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const input = lastRow.querySelector('input[type="text"]');
            if (input) input.focus();
        }
    }, 100);
}

function updateConstantKey(index, newKey) {
    const oldKey = Object.keys(systemData.constants)[index];
    if (oldKey && newKey && newKey.trim() !== '' && newKey !== oldKey) {
        // Verificar se a nova chave já existe
        if (systemData.constants[newKey] !== undefined) {
            showError(`A constante "${newKey}" já existe!`);
            return;
        }
        
        systemData.constants[newKey] = systemData.constants[oldKey];
        delete systemData.constants[oldKey];
        loadConstants();
        addPendingChange('constants');
        showInfo(`Constante renomeada: "${oldKey}" → "${newKey}"`);
    }
}

function updateConstantDescription(key, description) {
    // Aqui você pode armazenar descrições em um objeto separado
    // Por enquanto, apenas adicionamos ao pending changes
    addPendingChange('constants');
}

function updateConstantValue(key, value) {
    const numValue = parseFloat(value);
    if (isNaN(numValue)) {
        showError(`Valor inválido para "${key}": ${value}`);
        return;
    }
    
    if (systemData.constants[key] !== numValue) {
        systemData.constants[key] = numValue;
        addPendingChange('constants');
    }
}

async function deleteConstant(key) {
    showConfirmation(`Deseja excluir a constante "${key}"?`, async () => {
        try {
            // Usar método universal delete
            const response = await fetch('/api/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: ['constants', key] 
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                delete systemData.constants[key];
                loadConstants();
                addPendingChange('constants');
                showWarning(`Constante "${key}" excluída.`);
            } else {
                throw new Error(result.error || 'Erro ao excluir');
            }
        } catch (error) {
            console.error('Erro ao excluir constante:', error);
            showError(`Erro ao excluir constante: ${error.message}`);
        }
    });
}

// ===== GERENCIAMENTO DE MÁQUINAS =====

function loadMachines() {
    const container = document.getElementById('machinesList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!systemData.machines || !Array.isArray(systemData.machines)) {
        systemData.machines = [];
        return;
    }
    
    if (systemData.machines.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="icon-machine" style="font-size: 48px; opacity: 0.5;"></i>
                <h3>Nenhuma máquina cadastrada</h3>
                <p>Clique no botão abaixo para adicionar sua primeira máquina.</p>
                <button class="btn btn-success" onclick="addMachine()">
                    <i class="icon-add"></i> Adicionar Primeira Máquina
                </button>
            </div>
        `;
        return;
    }
    
    systemData.machines.forEach((machine, index) => {
        const card = document.createElement('div');
        card.className = 'machine-card';
        card.innerHTML = `
            <div class="machine-card-header">
                <h3>${escapeHtml(machine.type || 'Sem nome')}</h3>
                <div class="machine-card-actions">
                    <button class="btn btn-small btn-primary" 
                            onclick="editMachine(${index})"
                            title="Editar máquina">
                        <i class="icon-edit"></i> Editar
                    </button>
                    <button class="btn btn-small btn-danger"
                            onclick="deleteMachine(${index})"
                            title="Excluir máquina">
                        <i class="icon-delete"></i>
                    </button>
                </div>
            </div>
            <div class="machine-card-body">
                <p><strong>Configurações:</strong> ${machine.configuracoes_instalacao?.length || 0}</p>
                <p><strong>Opções:</strong> ${machine.options?.length || 0}</p>
                <p><strong>Tensões:</strong> ${machine.voltages?.length || 0}</p>
                <p><strong>Valores base:</strong> ${Object.keys(machine.baseValues || {}).length}</p>
            </div>
            <div class="machine-card-footer">
                <span>ID: ${index}</span>
                <span>Tipo: ${machine.type || 'Não definido'}</span>
            </div>
        `;
        container.appendChild(card);
    });
}

function populateMachineFilter() {
    const filter = document.getElementById('machineTypeFilter');
    if (!filter) return;
    
    filter.innerHTML = '<option value="">Todas as máquinas</option>';
    
    systemData.machines.forEach((machine, index) => {
        const option = document.createElement('option');
        option.value = machine.type;
        option.textContent = machine.type || `Máquina ${index + 1}`;
        filter.appendChild(option);
    });
}

function filterMachines() {
    const filterValue = document.getElementById('machineTypeFilter').value.toLowerCase();
    const cards = document.querySelectorAll('.machine-card');
    
    cards.forEach(card => {
        const machineType = card.querySelector('h3').textContent.toLowerCase();
        if (!filterValue || machineType.includes(filterValue)) {
            card.style.display = 'block';
            card.classList.add('fade-in');
        } else {
            card.style.display = 'none';
        }
    });
}

function addMachine() {
    const newMachine = {
        type: `NOVO_TIPO_${Date.now().toString().slice(-4)}`,
        impostos: {
            "PIS_COFINS": "INCL",
            "IPI": "ISENTO",
            "ICMS": "12%",
            "PRAZO": "45 a 60 dias",
            "FRETE": "FOB/Cabreúva/SP"
        },
        configuracoes_instalacao: [],
        baseValues: {},
        options: [],
        voltages: []
    };
    
    systemData.machines.push(newMachine);
    loadMachines();
    populateMachineFilter();
    editMachine(systemData.machines.length - 1);
    addPendingChange('machines');
    showInfo('Nova máquina adicionada. Configure os detalhes.');
}

function editMachine(index) {
    if (index < 0 || index >= systemData.machines.length) return;
    
    const machine = systemData.machines[index];
    currentMachineIndex = index;
    
    // Atualizar título
    document.getElementById('machineDetailTitle').textContent = machine.type || 'Nova Máquina';
    
    // Construir conteúdo de edição
    let content = `
        <div class="machine-edit-form">
            <div class="form-group">
                <label>Tipo de Máquina:</label>
                <input type="text" id="editMachineType" value="${escapeHtml(machine.type || '')}" 
                       class="form-control" onchange="updateMachineField('type', this.value)">
            </div>
            
            <div class="form-section">
                <h4>Impostos</h4>
                <div class="impostos-grid">
                    ${Object.entries(machine.impostos || {}).map(([key, value]) => `
                        <div class="form-group">
                            <label>${key}:</label>
                            <input type="text" value="${escapeHtml(value)}"
                                   onchange="updateImposto('${key}', this.value)"
                                   class="form-input-small">
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-small btn-info" onclick="addImposto()">
                    <i class="icon-add"></i> Adicionar Imposto
                </button>
            </div>
            
            <div class="form-section">
                <div class="section-header">
                    <h4>Configurações de Instalação</h4>
                    <button class="btn btn-small btn-success" onclick="addConfiguracao()">
                        <i class="icon-add"></i> Adicionar
                    </button>
                </div>
                <div id="configuracoesList" class="configuracoes-list">
                    ${loadConfiguracoesHTML(machine)}
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-header">
                    <h4>Valores Base</h4>
                    <button class="btn btn-small btn-success" onclick="addBaseValue()">
                        <i class="icon-add"></i> Adicionar
                    </button>
                </div>
                <div id="baseValuesList" class="base-values-list">
                    ${loadBaseValuesHTML(machine)}
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-header">
                    <h4>Opções</h4>
                    <button class="btn btn-small btn-success" onclick="addOption()">
                        <i class="icon-add"></i> Adicionar
                    </button>
                </div>
                <div id="optionsList" class="options-list">
                    ${loadOptionsHTML(machine)}
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-header">
                    <h4>Tensões</h4>
                    <button class="btn btn-small btn-success" onclick="addVoltage()">
                        <i class="icon-add"></i> Adicionar
                    </button>
                </div>
                <div id="voltagesList" class="voltages-list">
                    ${loadVoltagesHTML(machine)}
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-success" onclick="saveMachineChanges()">
                    <i class="icon-save"></i> Salvar Alterações
                </button>
                <button class="btn btn-secondary" onclick="closeMachineDetail()">
                    <i class="icon-close"></i> Fechar
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('machineDetailContent').innerHTML = content;
    document.getElementById('machineDetailView').style.display = 'block';
    
    // Scroll para o topo
    document.getElementById('machineDetailView').scrollIntoView({ behavior: 'smooth' });
}

function loadConfiguracoesHTML(machine) {
    const configuracoes = machine.configuracoes_instalacao || [];
    
    if (configuracoes.length === 0) {
        return '<p class="empty-message">Nenhuma configuração cadastrada.</p>';
    }
    
    return configuracoes.map((config, index) => `
        <div class="config-item" data-index="${index}">
            <div class="config-header">
                <span>Configuração ${index + 1}</span>
                <button class="btn btn-xs btn-danger" onclick="removeConfiguracao(${index})" title="Remover">
                    <i class="icon-delete"></i>
                </button>
            </div>
            <div class="config-content">
                <input type="text" value="${escapeHtml(config.nome || '')}" 
                       placeholder="Descrição da configuração"
                       onchange="updateConfiguracao(${index}, 'nome', this.value)"
                       class="form-input">
                ${config.valor !== undefined ? `
                    <input type="number" value="${config.valor}" step="0.01"
                           placeholder="Valor"
                           onchange="updateConfiguracao(${index}, 'valor', this.value)"
                           class="form-input">
                ` : ''}
            </div>
        </div>
    `).join('');
}

function loadBaseValuesHTML(machine) {
    const baseValues = machine.baseValues || {};
    const entries = Object.entries(baseValues);
    
    if (entries.length === 0) {
        return '<p class="empty-message">Nenhum valor base cadastrado.</p>';
    }
    
    return entries.map(([key, value], index) => `
        <div class="base-value-item" data-key="${key}">
            <div class="base-value-header">
                <input type="text" value="${escapeHtml(key)}" 
                       placeholder="Chave (ex: 1TR)"
                       onchange="updateBaseValueKey('${key}', this.value)"
                       class="form-input-small">
                <button class="btn btn-xs btn-danger" onclick="removeBaseValue('${key}')" title="Remover">
                    <i class="icon-delete"></i>
                </button>
            </div>
            <input type="number" value="${value}" step="0.01"
                   placeholder="Valor"
                   onchange="updateBaseValue('${key}', this.value)"
                   class="form-input">
        </div>
    `).join('');
}

function loadOptionsHTML(machine) {
    const options = machine.options || [];
    
    if (options.length === 0) {
        return '<p class="empty-message">Nenhuma opção cadastrada.</p>';
    }
    
    return options.map((option, index) => `
        <div class="option-item" data-index="${index}">
            <div class="option-header">
                <span>Opção ${index + 1}: ${escapeHtml(option.name || 'Sem nome')}</span>
                <button class="btn btn-xs btn-danger" onclick="removeOption(${index})" title="Remover">
                    <i class="icon-delete"></i>
                </button>
            </div>
            <div class="option-content">
                <input type="text" value="${escapeHtml(option.name || '')}" 
                       placeholder="Nome da opção"
                       onchange="updateOption(${index}, 'name', this.value)"
                       class="form-input">
                <div class="option-values">
                    <h5>Valores por Capacidade:</h5>
                    ${option.values ? Object.entries(option.values).map(([key, val]) => `
                        <div class="option-value-row">
                            <span>${key}:</span>
                            <input type="number" value="${val}" step="0.01"
                                   onchange="updateOptionValue(${index}, '${key}', this.value)"
                                   class="form-input-small">
                        </div>
                    `).join('') : '<p>Sem valores definidos</p>'}
                </div>
            </div>
        </div>
    `).join('');
}

function loadVoltagesHTML(machine) {
    const voltages = machine.voltages || [];
    
    if (voltages.length === 0) {
        return '<p class="empty-message">Nenhuma tensão cadastrada.</p>';
    }
    
    return voltages.map((voltage, index) => `
        <div class="voltage-item" data-index="${index}">
            <div class="voltage-header">
                <span>Tensão ${index + 1}</span>
                <button class="btn btn-xs btn-danger" onclick="removeVoltage(${index})" title="Remover">
                    <i class="icon-delete"></i>
                </button>
            </div>
            <div class="voltage-content">
                <input type="text" value="${escapeHtml(voltage.name || '')}" 
                       placeholder="Nome (ex: 220V/1F)"
                       onchange="updateVoltage(${index}, 'name', this.value)"
                       class="form-input">
                <input type="number" value="${voltage.value || 0}" step="0.01"
                       placeholder="Valor"
                       onchange="updateVoltage(${index}, 'value', this.value)"
                       class="form-input">
            </div>
        </div>
    `).join('');
}

function closeMachineDetail() {
    document.getElementById('machineDetailView').style.display = 'none';
    currentMachineIndex = null;
}

function updateMachineField(field, value) {
    if (currentMachineIndex !== null) {
        systemData.machines[currentMachineIndex][field] = value;
        document.getElementById('machineDetailTitle').textContent = value;
        addPendingChange('machines');
    }
}

function updateImposto(key, value) {
    if (currentMachineIndex !== null) {
        if (!systemData.machines[currentMachineIndex].impostos) {
            systemData.machines[currentMachineIndex].impostos = {};
        }
        systemData.machines[currentMachineIndex].impostos[key] = value;
        addPendingChange('machines');
    }
}

function addImposto() {
    if (currentMachineIndex !== null) {
        const newKey = `NOVO_IMPOSTO_${Date.now().toString().slice(-4)}`;
        if (!systemData.machines[currentMachineIndex].impostos) {
            systemData.machines[currentMachineIndex].impostos = {};
        }
        systemData.machines[currentMachineIndex].impostos[newKey] = '';
        editMachine(currentMachineIndex); // Recarregar view
        addPendingChange('machines');
    }
}

// Funções para Configurações
function addConfiguracao() {
    if (currentMachineIndex !== null) {
        if (!systemData.machines[currentMachineIndex].configuracoes_instalacao) {
            systemData.machines[currentMachineIndex].configuracoes_instalacao = [];
        }
        
        const newId = systemData.machines[currentMachineIndex].configuracoes_instalacao.length + 1;
        systemData.machines[currentMachineIndex].configuracoes_instalacao.push({
            id: newId,
            nome: 'Nova Configuração',
            valor: 0
        });
        
        editMachine(currentMachineIndex);
        addPendingChange('machines');
    }
}

function updateConfiguracao(index, field, value) {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (machine.configuracoes_instalacao && machine.configuracoes_instalacao[index]) {
            if (field === 'valor') {
                machine.configuracoes_instalacao[index][field] = parseFloat(value) || 0;
            } else {
                machine.configuracoes_instalacao[index][field] = value;
            }
            addPendingChange('machines');
        }
    }
}

function removeConfiguracao(index) {
    showConfirmation('Deseja remover esta configuração?', () => {
        if (currentMachineIndex !== null) {
            const machine = systemData.machines[currentMachineIndex];
            if (machine.configuracoes_instalacao) {
                machine.configuracoes_instalacao.splice(index, 1);
                editMachine(currentMachineIndex);
                addPendingChange('machines');
                showWarning('Configuração removida.');
            }
        }
    });
}

// Funções para Valores Base
function addBaseValue() {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (!machine.baseValues) {
            machine.baseValues = {};
        }
        
        const newKey = `NOVA_CAPACIDADE_${Object.keys(machine.baseValues).length + 1}`;
        machine.baseValues[newKey] = 0;
        
        editMachine(currentMachineIndex);
        addPendingChange('machines');
    }
}

function updateBaseValueKey(oldKey, newKey) {
    if (currentMachineIndex !== null && newKey && newKey.trim() !== '') {
        const machine = systemData.machines[currentMachineIndex];
        if (machine.baseValues && machine.baseValues[oldKey] !== undefined) {
            const value = machine.baseValues[oldKey];
            delete machine.baseValues[oldKey];
            machine.baseValues[newKey] = value;
            editMachine(currentMachineIndex);
            addPendingChange('machines');
        }
    }
}

function updateBaseValue(key, value) {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (machine.baseValues && machine.baseValues[key] !== undefined) {
            machine.baseValues[key] = parseFloat(value) || 0;
            addPendingChange('machines');
        }
    }
}

function removeBaseValue(key) {
    showConfirmation(`Deseja remover o valor base "${key}"?`, () => {
        if (currentMachineIndex !== null) {
            const machine = systemData.machines[currentMachineIndex];
            if (machine.baseValues && machine.baseValues[key] !== undefined) {
                delete machine.baseValues[key];
                editMachine(currentMachineIndex);
                addPendingChange('machines');
                showWarning(`Valor base "${key}" removido.`);
            }
        }
    });
}

// Funções para Opções
function addOption() {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (!machine.options) {
            machine.options = [];
        }
        
        const newId = machine.options.length + 1;
        machine.options.push({
            id: newId,
            name: 'Nova Opção',
            values: {}
        });
        
        editMachine(currentMachineIndex);
        addPendingChange('machines');
    }
}

function updateOption(index, field, value) {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (machine.options && machine.options[index]) {
            machine.options[index][field] = value;
            addPendingChange('machines');
        }
    }
}

function updateOptionValue(optionIndex, key, value) {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (machine.options && machine.options[optionIndex]) {
            if (!machine.options[optionIndex].values) {
                machine.options[optionIndex].values = {};
            }
            machine.options[optionIndex].values[key] = parseFloat(value) || 0;
            addPendingChange('machines');
        }
    }
}

function removeOption(index) {
    showConfirmation('Deseja remover esta opção?', () => {
        if (currentMachineIndex !== null) {
            const machine = systemData.machines[currentMachineIndex];
            if (machine.options) {
                machine.options.splice(index, 1);
                editMachine(currentMachineIndex);
                addPendingChange('machines');
                showWarning('Opção removida.');
            }
        }
    });
}

// Funções para Tensões
function addVoltage() {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (!machine.voltages) {
            machine.voltages = [];
        }
        
        machine.voltages.push({
            id: machine.voltages.length + 1,
            name: 'Nova Tensão',
            value: 0
        });
        
        editMachine(currentMachineIndex);
        addPendingChange('machines');
    }
}

function updateVoltage(index, field, value) {
    if (currentMachineIndex !== null) {
        const machine = systemData.machines[currentMachineIndex];
        if (machine.voltages && machine.voltages[index]) {
            if (field === 'value') {
                machine.voltages[index][field] = parseFloat(value) || 0;
            } else {
                machine.voltages[index][field] = value;
            }
            addPendingChange('machines');
        }
    }
}

function removeVoltage(index) {
    showConfirmation('Deseja remover esta tensão?', () => {
        if (currentMachineIndex !== null) {
            const machine = systemData.machines[currentMachineIndex];
            if (machine.voltages) {
                machine.voltages.splice(index, 1);
                editMachine(currentMachineIndex);
                addPendingChange('machines');
                showWarning('Tensão removida.');
            }
        }
    });
}

function saveMachineChanges() {
    if (currentMachineIndex !== null) {
        addPendingChange('machines');
        showSuccess('Alterações na máquina salvas. Lembre-se de salvar todos os dados.');
        closeMachineDetail();
    }
}

async function deleteMachine(index) {
    const machine = systemData.machines[index];
    const machineType = machine.type || `Máquina ${index + 1}`;
    
    showConfirmation(`Deseja excluir a máquina "${machineType}"?`, async () => {
        try {
            // Usar método universal delete
            const response = await fetch('/api/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: ['machines', index.toString()] 
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                systemData.machines.splice(index, 1);
                loadMachines();
                populateMachineFilter();
                closeMachineDetail();
                addPendingChange('machines');
                showWarning(`Máquina "${machineType}" excluída.`);
            } else {
                throw new Error(result.error || 'Erro ao excluir');
            }
        } catch (error) {
            console.error('Erro ao excluir máquina:', error);
            showError(`Erro ao excluir máquina: ${error.message}`);
        }
    });
}

// ===== GERENCIAMENTO DE MATERIAIS =====

function loadMaterials() {
    const tbody = document.getElementById('materialsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!systemData.materials) {
        systemData.materials = {};
    }
    
    Object.entries(systemData.materials).forEach(([material, preco], index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="text" value="${escapeHtml(material)}"
                       onchange="updateMaterialKey('${material}', this.value)"
                       placeholder="Nome do material"
                       class="form-input">
            </td>
            <td>
                <input type="text" value="${getMaterialUnit(material)}"
                       onchange="updateMaterialUnit('${material}', this.value)"
                       placeholder="Unidade (kg, m, etc)"
                       class="form-input">
            </td>
            <td>
                <input type="number" value="${preco}" step="0.01"
                       onchange="updateMaterialPrice('${material}', this.value)"
                       class="form-input">
            </td>
            <td class="actions-cell">
                <button class="btn btn-small btn-danger"
                        onclick="deleteMaterial('${material}')"
                        title="Excluir material">
                    <i class="icon-delete"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Adicionar linha vazia para novo item
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `
        <td colspan="4" style="text-align: center; padding: 20px;">
            <button class="btn btn-success" onclick="addMaterial()">
                <i class="icon-add"></i> Adicionar Novo Material
            </button>
        </td>
    `;
    tbody.appendChild(emptyRow);
}

function getMaterialUnit(material) {
    const units = {
        'Kg cobre': 'kg',
        'Metro isolante 1.1/8': 'm',
        'Metro isolante 5/8': 'm',
        'Kg Gás R-410A': 'kg',
        'Metro tubo PVC 3/4"': 'm',
        'Metro tubo PVC 1"': 'm',
        'Metro Barra Roscada 3/8"': 'm',
        'Chumbador 3/8" por 2.1/2"': 'un'
    };
    return units[material] || '';
}

function addMaterial() {
    const newMaterial = `NOVO_MATERIAL_${Date.now().toString().slice(-6)}`;
    systemData.materials[newMaterial] = 0;
    loadMaterials();
    addPendingChange('materials');
    showInfo('Novo material adicionado. Edite os detalhes.');
    
    // Rolar para o novo item
    setTimeout(() => {
        const lastRow = document.querySelector('#materialsTableBody tr:nth-last-child(2)');
        if (lastRow) {
            lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const input = lastRow.querySelector('input[type="text"]');
            if (input) input.focus();
        }
    }, 100);
}

function updateMaterialKey(oldKey, newKey) {
    if (oldKey && newKey && newKey.trim() !== '' && newKey !== oldKey) {
        // Verificar se a nova chave já existe
        if (systemData.materials[newKey] !== undefined) {
            showError(`O material "${newKey}" já existe!`);
            return;
        }
        
        systemData.materials[newKey] = systemData.materials[oldKey];
        delete systemData.materials[oldKey];
        loadMaterials();
        addPendingChange('materials');
        showInfo(`Material renomeado: "${oldKey}" → "${newKey}"`);
    }
}

function updateMaterialUnit(key, unit) {
    // Aqui você pode armazenar unidades em um objeto separado
    // Por enquanto, apenas adicionamos ao pending changes
    addPendingChange('materials');
}

function updateMaterialPrice(key, value) {
    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue < 0) {
        showError(`Preço inválido para "${key}": ${value}`);
        return;
    }
    
    if (systemData.materials[key] !== numValue) {
        systemData.materials[key] = numValue;
        addPendingChange('materials');
    }
}

async function deleteMaterial(key) {
    showConfirmation(`Deseja excluir o material "${key}"?`, async () => {
        try {
            // Usar método universal delete
            const response = await fetch('/api/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: ['materials', key] 
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                delete systemData.materials[key];
                loadMaterials();
                addPendingChange('materials');
                showWarning(`Material "${key}" excluído.`);
            } else {
                throw new Error(result.error || 'Erro ao excluir');
            }
        } catch (error) {
            console.error('Erro ao excluir material:', error);
            showError(`Erro ao excluir material: ${error.message}`);
        }
    });
}

// ===== GERENCIAMENTO DE EMPRESAS =====

function loadEmpresas() {
    const tbody = document.getElementById('empresasTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!systemData.empresas || !Array.isArray(systemData.empresas)) {
        systemData.empresas = [];
        return;
    }
    
    if (systemData.empresas.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" style="text-align: center; padding: 30px;">
                    <div class="empty-state">
                        <i class="icon-company" style="font-size: 48px; opacity: 0.5;"></i>
                        <h3>Nenhuma empresa cadastrada</h3>
                        <p>Clique no botão abaixo para adicionar sua primeira empresa.</p>
                        <button class="btn btn-success" onclick="addEmpresa()">
                            <i class="icon-add"></i> Adicionar Primeira Empresa
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    systemData.empresas.forEach((empresa, index) => {
        const sigla = Object.keys(empresa)[0] || '';
        const nome = empresa[sigla] || '';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="text" value="${escapeHtml(sigla)}"
                       onchange="updateEmpresaSigla(${index}, this.value)"
                       placeholder="Sigla (3 letras)"
                       class="form-input" maxlength="10">
            </td>
            <td>
                <input type="text" value="${escapeHtml(nome)}"
                       onchange="updateEmpresaNome(${index}, this.value)"
                       placeholder="Nome completo da empresa"
                       class="form-input">
            </td>
            <td class="actions-cell">
                <button class="btn btn-small btn-danger"
                        onclick="deleteEmpresa(${index})"
                        title="Excluir empresa">
                    <i class="icon-delete"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Adicionar linha vazia para novo item
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `
        <td colspan="3" style="text-align: center; padding: 20px;">
            <button class="btn btn-success" onclick="addEmpresa()">
                <i class="icon-add"></i> Adicionar Nova Empresa
            </button>
        </td>
    `;
    tbody.appendChild(emptyRow);
}

function addEmpresa() {
    const newSigla = `NOV${Date.now().toString().slice(-3)}`;
    systemData.empresas.push({ [newSigla]: `Nova Empresa ${newSigla}` });
    loadEmpresas();
    addPendingChange('empresas');
    showInfo('Nova empresa adicionada. Edite os detalhes.');
    
    // Rolar para o novo item
    setTimeout(() => {
        const lastRow = document.querySelector('#empresasTableBody tr:nth-last-child(2)');
        if (lastRow) {
            lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const input = lastRow.querySelector('input[type="text"]');
            if (input) input.focus();
        }
    }, 100);
}

function updateEmpresaSigla(index, newSigla) {
    const empresa = systemData.empresas[index];
    const oldSigla = Object.keys(empresa)[0];
    const nome = empresa[oldSigla];
    
    if (newSigla && newSigla.trim() !== '' && newSigla !== oldSigla) {
        // Verificar se a sigla já existe
        const siglaExists = systemData.empresas.some((emp, idx) => {
            if (idx === index) return false;
            const empSigla = Object.keys(emp)[0];
            return empSigla === newSigla;
        });
        
        if (siglaExists) {
            showError(`A sigla "${newSigla}" já existe!`);
            return;
        }
        
        systemData.empresas[index] = { [newSigla]: nome };
        loadEmpresas();
        addPendingChange('empresas');
        showInfo(`Sigla alterada: "${oldSigla}" → "${newSigla}"`);
    }
}

function updateEmpresaNome(index, newNome) {
    const empresa = systemData.empresas[index];
    const sigla = Object.keys(empresa)[0];
    
    if (newNome && newNome.trim() !== '' && newNome !== empresa[sigla]) {
        systemData.empresas[index][sigla] = newNome;
        addPendingChange('empresas');
    }
}

async function deleteEmpresa(index) {
    const empresa = systemData.empresas[index];
    const sigla = Object.keys(empresa)[0] || '';
    const nome = empresa[sigla] || '';
    
    showConfirmation(`Deseja excluir a empresa "${sigla} - ${nome}"?`, async () => {
        try {
            // Usar método universal delete
            const response = await fetch('/api/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: ['empresas', index.toString()] 
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                systemData.empresas.splice(index, 1);
                loadEmpresas();
                addPendingChange('empresas');
                showWarning(`Empresa "${sigla}" excluída.`);
            } else {
                throw new Error(result.error || 'Erro ao excluir');
            }
        } catch (error) {
            console.error('Erro ao excluir empresa:', error);
            showError(`Erro ao excluir empresa: ${error.message}`);
        }
    });
}

// ===== EDITOR JSON =====

function loadJSONEditor() {
    const editor = document.getElementById('jsonEditor');
    if (!editor) return;
    
    editor.value = JSON.stringify(systemData, null, 2);
    updateJSONStatus('JSON carregado', 'info');
}

function formatJSON() {
    const editor = document.getElementById('jsonEditor');
    try {
        const parsed = JSON.parse(editor.value);
        editor.value = JSON.stringify(parsed, null, 2);
        updateJSONStatus('JSON formatado com sucesso', 'success');
    } catch (error) {
        updateJSONStatus(`Erro de formatação: ${error.message}`, 'error');
    }
}

function validateJSON() {
    const editor = document.getElementById('jsonEditor');
    try {
        const parsed = JSON.parse(editor.value);
        
        // Validar estrutura básica
        const requiredKeys = ['constants', 'machines', 'materials', 'empresas'];
        const missingKeys = requiredKeys.filter(key => !(key in parsed));
        
        if (missingKeys.length > 0) {
            throw new Error(`Campos ausentes: ${missingKeys.join(', ')}`);
        }
        
        // Validar tipos
        if (typeof parsed.constants !== 'object') {
            throw new Error('constants deve ser um objeto');
        }
        if (!Array.isArray(parsed.machines)) {
            throw new Error('machines deve ser um array');
        }
        if (typeof parsed.materials !== 'object') {
            throw new Error('materials deve ser um objeto');
        }
        if (!Array.isArray(parsed.empresas)) {
            throw new Error('empresas deve ser um array');
        }
        
        updateJSONStatus('✅ JSON válido e com estrutura correta', 'success');
        return true;
        
    } catch (error) {
        updateJSONStatus(`❌ JSON inválido: ${error.message}`, 'error');
        return false;
    }
}

function updateJSONStatus(message, type) {
    const status = document.getElementById('jsonStatus');
    if (!status) return;
    
    status.textContent = message;
    status.className = 'json-status-message';
    
    switch (type) {
        case 'success':
            status.classList.add('success');
            break;
        case 'error':
            status.classList.add('error');
            break;
        case 'info':
            status.classList.add('info');
            break;
        default:
            status.classList.add('info');
    }
}

// ===== FUNÇÕES DE EXPORTAÇÃO/IMPORTAÇÃO =====

function exportToJSON() {
    try {
        const dataStr = JSON.stringify(systemData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `sistema_dados_${new Date().toISOString().slice(0,10)}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.style.display = 'none';
        document.body.appendChild(linkElement);
        linkElement.click();
        document.body.removeChild(linkElement);
        
        showSuccess('JSON exportado com sucesso!');
        
    } catch (error) {
        console.error('Erro ao exportar JSON:', error);
        showError('Erro ao exportar JSON.');
    }
}

function importFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validar estrutura básica
            if (!importedData.constants || !importedData.machines || 
                !importedData.materials || !importedData.empresas) {
                throw new Error('Estrutura de dados inválida. Arquivo deve conter: constants, machines, materials, empresas');
            }
            
            // Validar tipos
            if (typeof importedData.constants !== 'object') {
                throw new Error('constants deve ser um objeto');
            }
            if (!Array.isArray(importedData.machines)) {
                throw new Error('machines deve ser um array');
            }
            if (typeof importedData.materials !== 'object') {
                throw new Error('materials deve ser um objeto');
            }
            if (!Array.isArray(importedData.empresas)) {
                throw new Error('empresas deve ser um array');
            }
            
            systemData = importedData;
            loadData();
            showSuccess('Dados importados com sucesso!');
            
        } catch (error) {
            console.error('Erro ao importar JSON:', error);
            showError(`Erro ao importar JSON: ${error.message}`);
        }
    };
    
    reader.onerror = function() {
        showError('Erro ao ler o arquivo.');
    };
    
    reader.readAsText(file);
    
    // Resetar input
    event.target.value = '';
}

// ===== FUNÇÕES DE BUSCA =====

function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    const filter = document.getElementById('searchFilter').value;
    
    if (!searchTerm) {
        showWarning('Digite um termo para buscar');
        return;
    }
    
    // Limpar highlights anteriores
    document.querySelectorAll('.highlight').forEach(el => {
        el.classList.remove('highlight');
    });
    
    switch (filter) {
        case 'constants':
            searchInConstants(searchTerm);
            break;
        case 'machines':
            searchInMachines(searchTerm);
            break;
        case 'materials':
            searchInMaterials(searchTerm);
            break;
        case 'empresas':
            searchInEmpresas(searchTerm);
            break;
        case 'all':
            searchAll(searchTerm);
            break;
    }
}

function searchInConstants(searchTerm) {
    const rows = document.querySelectorAll('#constantsTableBody tr');
    let foundCount = 0;
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        let rowText = '';
        inputs.forEach(input => {
            rowText += input.value.toLowerCase() + ' ';
        });
        
        if (rowText.includes(searchTerm)) {
            row.classList.add('highlight');
            foundCount++;
        }
    });
    
    if (foundCount > 0) {
        showInfo(`Encontrado ${foundCount} resultado(s) nas constantes`);
    } else {
        showWarning('Nenhum resultado encontrado nas constantes');
    }
}

function searchInMachines(searchTerm) {
    const cards = document.querySelectorAll('.machine-card');
    let foundCount = 0;
    
    cards.forEach(card => {
        const cardText = card.textContent.toLowerCase();
        if (cardText.includes(searchTerm)) {
            card.classList.add('highlight');
            foundCount++;
        }
    });
    
    if (foundCount > 0) {
        showInfo(`Encontrado ${foundCount} resultado(s) nas máquinas`);
        // Filtrar para mostrar apenas resultados
        filterMachinesForSearch(searchTerm);
    } else {
        showWarning('Nenhum resultado encontrado nas máquinas');
    }
}

function filterMachinesForSearch(searchTerm) {
    const cards = document.querySelectorAll('.machine-card');
    cards.forEach(card => {
        const cardText = card.textContent.toLowerCase();
        if (cardText.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function searchInMaterials(searchTerm) {
    const rows = document.querySelectorAll('#materialsTableBody tr');
    let foundCount = 0;
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        let rowText = '';
        inputs.forEach(input => {
            rowText += input.value.toLowerCase() + ' ';
        });
        
        if (rowText.includes(searchTerm)) {
            row.classList.add('highlight');
            foundCount++;
        }
    });
    
    if (foundCount > 0) {
        showInfo(`Encontrado ${foundCount} resultado(s) nos materiais`);
    } else {
        showWarning('Nenhum resultado encontrado nos materiais');
    }
}

function searchInEmpresas(searchTerm) {
    const rows = document.querySelectorAll('#empresasTableBody tr');
    let foundCount = 0;
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        let rowText = '';
        inputs.forEach(input => {
            rowText += input.value.toLowerCase() + ' ';
        });
        
        if (rowText.includes(searchTerm)) {
            row.classList.add('highlight');
            foundCount++;
        }
    });
    
    if (foundCount > 0) {
        showInfo(`Encontrado ${foundCount} resultado(s) nas empresas`);
    } else {
        showWarning('Nenhum resultado encontrado nas empresas');
    }
}

function searchAll(searchTerm) {
    let totalFound = 0;
    
    // Buscar em todas as seções
    const searchFunctions = [
        searchInConstants,
        searchInMachines,
        searchInMaterials,
        searchInEmpresas
    ];
    
    searchFunctions.forEach(func => {
        // Contar resultados de forma simplificada
        if (func.name === 'searchInConstants') {
            const rows = document.querySelectorAll('#constantsTableBody tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                let rowText = '';
                inputs.forEach(input => rowText += input.value.toLowerCase() + ' ');
                if (rowText.includes(searchTerm)) totalFound++;
            });
        }
        // Implementar contagem para outras seções...
    });
    
    if (totalFound > 0) {
        showInfo(`Encontrado ${totalFound} resultado(s) no total`);
    } else {
        showWarning('Nenhum resultado encontrado');
    }
}

// ===== GERENCIAMENTO DE MUDANÇAS =====

function addPendingChange(type) {
    pendingChanges.add(type);
    updateSaveButton();
}

function clearPendingChanges() {
    pendingChanges.clear();
    updateSaveButton();
}

function updateSaveButton() {
    const saveBtn = document.querySelector('.btn-success[onclick*="saveData"]');
    if (!saveBtn) return;
    
    if (pendingChanges.size > 0) {
        saveBtn.innerHTML = '<i class="icon-save"></i> Salvar (' + pendingChanges.size + ')';
        saveBtn.classList.add('has-changes');
    } else {
        saveBtn.innerHTML = '<i class="icon-save"></i> Salvar Tudo';
        saveBtn.classList.remove('has-changes');
    }
}

function validateData() {
    try {
        // Validar constantes
        for (const [key, value] of Object.entries(systemData.constants)) {
            if (typeof value !== 'number' || isNaN(value)) {
                showError(`Valor inválido para constante "${key}": ${value}`);
                return false;
            }
        }
        
        // Validar máquinas
        for (const machine of systemData.machines) {
            if (!machine.type || typeof machine.type !== 'string') {
                showError('Tipo de máquina inválido ou não especificado');
                return false;
            }
            
            // Validar valores base
            if (machine.baseValues) {
                for (const [key, value] of Object.entries(machine.baseValues)) {
                    if (typeof value !== 'number' || isNaN(value)) {
                        showError(`Valor base inválido para "${key}" na máquina "${machine.type}": ${value}`);
                        return false;
                    }
                }
            }
        }
        
        // Validar materiais
        for (const [key, value] of Object.entries(systemData.materials)) {
            if (typeof value !== 'number' || isNaN(value) || value < 0) {
                showError(`Preço inválido para material "${key}": ${value}`);
                return false;
            }
        }
        
        // Validar empresas
        for (const empresa of systemData.empresas) {
            if (typeof empresa !== 'object' || empresa === null) {
                showError('Estrutura de empresa inválida');
                return false;
            }
            
            const sigla = Object.keys(empresa)[0];
            if (!sigla || typeof sigla !== 'string' || sigla.trim() === '') {
                showError('Sigla de empresa inválida');
                return false;
            }
        }
        
        return true;
        
    } catch (error) {
        console.error('Erro na validação:', error);
        showError(`Erro na validação: ${error.message}`);
        return false;
    }
}

// ===== FUNÇÕES DE UI =====

function showConfirmation(message, callback) {
    const modal = document.getElementById('confirmationModal');
    const messageEl = document.getElementById('modalMessage');
    const titleEl = document.getElementById('modalTitle');
    
    if (!modal || !messageEl || !titleEl) return;
    
    titleEl.textContent = 'Confirmação';
    messageEl.textContent = message;
    modal.style.display = 'flex';
    
    window.confirmAction = function(confirmed) {
        modal.style.display = 'none';
        if (confirmed && callback) callback();
    };
}

function showLoading(message) {
    // Criar overlay de loading
    let loadingEl = document.getElementById('loadingOverlay');
    if (!loadingEl) {
        loadingEl = document.createElement('div');
        loadingEl.id = 'loadingOverlay';
        loadingEl.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        `;
        document.body.appendChild(loadingEl);
    }
    
    loadingEl.innerHTML = `
        <div style="text-align: center;">
            <div class="spinner" style="
                width: 50px;
                height: 50px;
                border: 5px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            "></div>
            <p>${message || 'Carregando...'}</p>
        </div>
    `;
    loadingEl.style.display = 'flex';
}

function hideLoading() {
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
}

function showSuccess(message) {
    createMessage(message, 'success');
}

function showError(message) {
    createMessage(message, 'error');
}

function showWarning(message) {
    createMessage(message, 'warning');
}

function showInfo(message) {
    createMessage(message, 'info');
}

function createMessage(text, type) {
    // Remover mensagens antigas do mesmo tipo
    document.querySelectorAll(`.message-${type}`).forEach(el => {
        el.remove();
    });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = text;
    
    // Estilos
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9998;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
        animation-fill-mode: forwards;
        max-width: 400px;
        word-wrap: break-word;
    `;
    
    // Cores por tipo
    switch (type) {
        case 'success':
            messageDiv.style.background = 'linear-gradient(135deg, #2D774E 0%, #298650 100%)';
            break;
        case 'error':
            messageDiv.style.background = 'linear-gradient(135deg, #C53030 0%, #FC8181 100%)';
            break;
        case 'warning':
            messageDiv.style.background = 'linear-gradient(135deg, #D69E2E 0%, #F6AD55 100%)';
            break;
        case 'info':
            messageDiv.style.background = 'linear-gradient(135deg, #3182CE 0%, #63B3ED 100%)';
            break;
    }
    
    document.body.appendChild(messageDiv);
    
    // Remover após 3 segundos
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
    
    // Animações CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
}

function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===== INICIALIZAÇÃO =====

document.addEventListener('DOMContentLoaded', function() {
    console.log('Sistema de Edição de Dados iniciado');
    
    // Configurar eventos
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });
    }
    
    // Configurar botão de busca
    const searchBtn = document.querySelector('.btn-info[onclick*="performSearch"]');
    if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
    }
    
    // Carregar dados iniciais
    setTimeout(() => {
        loadData();
    }, 500);
    
    // Adicionar estilo CSS dinâmico
    addDynamicStyles();
});

function addDynamicStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Estilos para o sistema de edição */
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
        }
        
        .form-input-small {
            padding: 6px 10px;
            font-size: 13px;
        }
        
        .actions-cell {
            text-align: center;
            vertical-align: middle;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-gray-500);
        }
        
        .empty-state h3 {
            margin: 15px 0 10px;
            color: var(--color-gray-700);
        }
        
        .empty-state p {
            margin-bottom: 20px;
            color: var(--color-gray-600);
        }
        
        .empty-message {
            color: var(--color-gray-500);
            font-style: italic;
            padding: 10px;
            text-align: center;
        }
        
        .form-section {
            margin-bottom: 25px;
            padding: 15px;
            background: var(--color-gray-50);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-gray-200);
        }
        
        .form-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--color-gray-800);
            border-bottom: 2px solid var(--color-gray-300);
            padding-bottom: 8px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .impostos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .config-item, .base-value-item, .option-item, .voltage-item {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .config-header, .base-value-header, .option-header, .voltage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .config-content, .base-value-content, .option-content, .voltage-content {
            display: grid;
            gap: 10px;
        }
        
        .option-values {
            margin-top: 10px;
            padding: 10px;
            background: var(--color-gray-100);
            border-radius: var(--border-radius);
        }
        
        .option-values h5 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--color-gray-700);
        }
        
        .option-value-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid var(--color-gray-200);
        }
        
        .btn-xs {
            padding: 3px 8px;
            font-size: 12px;
        }
        
        .highlight {
            background-color: rgba(255, 255, 0, 0.15) !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 0, 0.3) !important;
            animation: pulseHighlight 1.5s infinite;
        }
        
        @keyframes pulseHighlight {
            0% { box-shadow: 0 0 0 2px rgba(255, 255, 0, 0.3); }
            50% { box-shadow: 0 0 0 4px rgba(255, 255, 0, 0.5); }
            100% { box-shadow: 0 0 0 2px rgba(255, 255, 0, 0.3); }
        }
        
        .has-changes {
            animation: pulseSave 2s infinite;
        }
        
        @keyframes pulseSave {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .json-status-message {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            font-weight: 500;
        }
        
        .json-status-message.success {
            background: linear-gradient(135deg, #2D774E 0%, #298650 100%);
            color: white;
        }
        
        .json-status-message.error {
            background: linear-gradient(135deg, #C53030 0%, #FC8181 100%);
            color: white;
        }
        
        .json-status-message.info {
            background: linear-gradient(135deg, #3182CE 0%, #63B3ED 100%);
            color: white;
        }
    `;
    document.head.appendChild(style);
}

// ===== FUNÇÕES GLOBAIS PARA OS MODAIS =====

function confirmAction(confirmed) {
    const modal = document.getElementById('confirmationModal');
    if (modal) modal.style.display = 'none';
    
    if (confirmed && window.confirmCallback) {
        window.confirmCallback();
        window.confirmCallback = null;
    }
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) modal.style.display = 'none';
}

function saveEdit() {
    // Implementar lógica de salvamento do modal
    closeEditModal();
}

// ===== FUNÇÃO SHUTDOWN MANUAL (se necessário) =====

function shutdownManual() {
    showConfirmation('Deseja realmente encerrar o servidor?', async () => {
        try {
            const response = await fetch('/api/shutdown', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.action === 'close_window') {
                showSuccess('Servidor encerrado. Esta janela será fechada.');
                setTimeout(() => {
                    window.close();
                }, data.close_delay || 3000);
            }
        } catch (error) {
            console.error('Erro ao encerrar servidor:', error);
            showError('Erro ao encerrar servidor. Tente novamente.');
        }
    });
}

// Exportar funções para uso global
window.loadData = loadData;
window.saveData = saveData;
window.switchTab = switchTab;
window.addConstant = addConstant;
window.deleteConstant = deleteConstant;
window.addMachine = addMachine;
window.editMachine = editMachine;
window.deleteMachine = deleteMachine;
window.addMaterial = addMaterial;
window.deleteMaterial = deleteMaterial;
window.addEmpresa = addEmpresa;
window.deleteEmpresa = deleteEmpresa;
window.exportToJSON = exportToJSON;
window.performSearch = performSearch;
window.formatJSON = formatJSON;
window.validateJSON = validateJSON;
window.confirmAction = confirmAction;
window.closeEditModal = closeEditModal;
window.saveEdit = saveEdit;
window.shutdownManual = shutdownManual;
# servidor_modules/handlers/http_handler.py

import http.server
import json
import time
from urllib.parse import urlparse
from pathlib import Path
import os
import gzip
import threading
import re

# IMPORTS
from servidor_modules.utils.file_utils import FileUtils

class UniversalHTTPRequestHandler(http.server.SimpleHTTPRequestHandler):
    """Handler ULTRA-RÁPIDO com CACHE BUSTER AUTOMÁTICO PARA TODOS OS ARQUIVOS"""
    
    # Arquivos que NUNCA devem ser logados (acelera MUITO)
    SILENT_PATHS = {
        '/static/', '.css', '.js', '.png', '.jpg', '.jpeg',
        '/public/static/', '/public/scripts/', '.woff', '.woff2', '.ico',
        '.svg', '.gif', '.map', '.ttf', '.eot'
    }
    
    # Roteamento direto para máxima velocidade
    API_ROUTES = {
        '/constants': 'handle_get_constants',
        '/system-constants': 'handle_get_constants', 
        '/dados': 'handle_get_dados',
        '/backup': 'handle_get_backup',
        '/machines': 'handle_get_machines',
        '/health-check': 'handle_health_check',
        '/session-obras': 'handle_get_session_obras',
        '/api/session-obras': 'handle_get_session_obras',
        '/api/sessions/current': 'handle_get_sessions_current',
        '/api/backup-completo': 'handle_get_backup_completo',
        '/api/dados/empresas': 'handle_get_empresas',
        '/obras': 'handle_get_obras',
        '/api/server/uptime': 'handle_get_server_uptime',
        
        
        '/api/system-data': 'handle_get_system_data',
        '/api/constants': 'handle_get_constants_json',
        '/api/materials': 'handle_get_materials',
        '/api/empresas/all': 'handle_get_all_empresas',
        
        # Novas rotas para o sistema de edição
        '/api/system-data': 'handle_get_system_data',
        '/api/system-data/save': 'handle_post_save_system_data',
        '/api/constants/save': 'handle_post_save_constants',
        '/api/machines/save': 'handle_post_save_machines',
        '/api/materials/save': 'handle_post_save_materials',
        '/api/empresas/save': 'handle_post_save_empresas',

    }

    def __init__(self, *args, **kwargs):
        # INICIALIZAÇÃO RÁPIDA
        self.file_utils = FileUtils()
        self.project_root = self.file_utils.find_project_root()
        
        # Timestamp único para TODOS os arquivos (muda a cada execução do servidor)
        self.CACHE_BUSTER = f"v{int(time.time())}"
        print(f"🔄 CACHE BUSTER INICIADO: {self.CACHE_BUSTER}")
        
        # Inicialização Preguiçosa - só quando necessário
        self._routes_core = None
        self._route_handler = None
        
        serve_directory = self.project_root
        super().__init__(*args, directory=str(serve_directory), **kwargs)
    
    @property
    def routes_core(self):
        """Inicialização preguiçosa do RoutesCore"""
        if self._routes_core is None:
            from servidor_modules.core.routes_core import RoutesCore
            from servidor_modules.core.sessions_core import sessions_manager
            from servidor_modules.utils.cache_cleaner import CacheCleaner
            
            self._routes_core = RoutesCore(
                self.project_root,
                sessions_manager,
                self.file_utils,
                CacheCleaner()
            )
        return self._routes_core
    
    @property
    def route_handler(self):
        """Inicialização preguiçosa do RouteHandler"""
        if self._route_handler is None:
            from servidor_modules.core.sessions_core import sessions_manager
            from servidor_modules.utils.cache_cleaner import CacheCleaner
            from servidor_modules.handlers.route_handler import RouteHandler
            
            self._route_handler = RouteHandler(
                self.project_root, 
                sessions_manager, 
                self.file_utils, 
                CacheCleaner()
            )
            self._route_handler.set_routes_core(self.routes_core)
        return self._route_handler

    def do_GET(self):
        """GET com CACHE BUSTER AUTOMÁTICO para CSS/JS/HTML"""
        parsed_path = urlparse(self.path)
        original_path = self.path
        path = parsed_path.path
        
        # Normalização rápida de path
        if path.startswith('/codigo/'):
            path = path[7:]
        
        # Log apenas para rotas importantes (acelera MUITO)
        if not any(silent in path for silent in self.SILENT_PATHS):
            print(f"📥 GET: {path}")
        
        # CACHE BUSTER AUTOMÁTICO: Adiciona versionamento a CSS, JS e HTML
        if any(path.endswith(ext) for ext in ['.css', '.js', '.html', '.htm']):
            new_path = self._add_cache_buster(original_path)
            if new_path != original_path:
                print(f"🔄 AUTO CACHE BUSTER: {original_path} -> {new_path}")
                self.path = new_path
        
        # Roteamento RÁPIDO para APIs
        if path in self.API_ROUTES:
            handler_name = self.API_ROUTES[path]
            getattr(self.route_handler, handler_name)(self)
        elif path.startswith('/api/dados/empresas/'):
            self.handle_empresa_routes(path)
        elif path.startswith('/obras/'):
            self.handle_obra_routes(path)
        
        # NOVAS ROTAS DE EDIÇÃO
        elif path == '/api/system-data':
            self.route_handler.handle_get_system_data(self)
        elif path == '/api/constants':
            self.route_handler.handle_get_constants_json(self)
        elif path == '/api/materials':
            self.route_handler.handle_get_materials(self)
        elif path == '/api/empresas/all':
            self.route_handler.handle_get_all_empresas(self)
        elif path.startswith('/api/machines/'):
            self.handle_machine_routes(path)
        else:
            # Serve arquivo estático COM HEADERS ANTI-CACHE
            self.serve_static_file_no_cache(path)
        
        
    def do_POST(self):
        """POST com todas as rotas necessárias"""
        parsed_path = urlparse(self.path)
        path = parsed_path.path
        
        if path.startswith('/codigo/'):
            path = path[7:]
        
        print(f"📨 POST: {path}")
        
        # ROTAS PRINCIPAIS - SHUTDOWN CORRIGIDAS
        if path == '/obras':
            self.route_handler.handle_post_obras(self)
        elif path == '/api/sessions/shutdown':
            self.route_handler.handle_post_sessions_shutdown(self)
        elif path == '/api/shutdown':
            self.route_handler.handle_shutdown(self)
        elif path == '/dados':
            self.route_handler.handle_post_dados(self)
        elif path == '/backup':
            self.route_handler.handle_post_backup(self)
        elif path == '/api/sessions/ensure-single':
            self.route_handler.handle_post_sessions_ensure_single(self)
        elif path == '/api/sessions/add-obra':
            self.route_handler.handle_post_sessions_add_obra(self)
        elif path == '/api/reload-page':
            self.route_handler.handle_post_reload_page(self)
        # ROTAS DE EMPRESAS
        elif path == '/api/dados/empresas':
            self.route_handler.handle_post_empresas(self)
        # ROTAS LEGACY (COMPATIBILIDADE)
        elif path in ['/projetos', '/projects']:
            self.route_handler.handle_post_projetos(self)
        
        # NOVAS ROTAS PARA EDIÇÃO
        elif path == '/api/system-data/save':
            self.route_handler.handle_post_save_system_data(self)
        elif path == '/api/constants/save':
            self.route_handler.handle_post_save_constants(self)
        elif path == '/api/materials/save':
            self.route_handler.handle_post_save_materials(self)
        elif path == '/api/empresas/save':
            self.route_handler.handle_post_save_empresas(self)
        elif path == '/api/machines/save':
            self.route_handler.handle_post_save_machines(self)
        elif path == '/api/machines/add':
            self.route_handler.handle_post_add_machine(self)
        elif path == '/api/machines/update':
            self.route_handler.handle_post_update_machine(self)
        else:
            print(f"❌ POST não implementado: {path}")
            self.send_error(501, f"Método não suportado: POST {path}")
        
    def do_PUT(self):
        """PUT para atualizações"""
        parsed_path = urlparse(self.path)
        path = parsed_path.path
        
        if path.startswith('/codigo/'):
            path = path[7:]
        
        print(f"📨 PUT: {path}")
        
        # ROTAS PRINCIPAIS - OBRAS
        if path.startswith('/obras/'):
            print(f"🎯 Roteando PUT para obra: {path}")
            self.route_handler.handle_put_obra(self)
        else:
            print(f"❌ PUT não implementado: {path}")
            self.send_error(501, f"Método não suportado: PUT {path}")

    def do_DELETE(self):
        """DELETE para remoção de recursos"""
        parsed_path = urlparse(self.path)
        path = parsed_path.path
        
        if path.startswith('/codigo/'):
            path = path[7:]
        
        print(f"🗑️  DELETE: {path}")
        
        # ========== NOVA ROTA UNIVERSAL ==========
        if path == '/api/delete':
            self.handle_delete_universal()
        # =========================================
        # ROTAS PRINCIPAIS - OBRAS
        elif path.startswith('/obras/'):
            obra_id = path.split('/')[-1]
            print(f"🎯 Roteando DELETE para obra: {obra_id}")
            self.route_handler.handle_delete_obra(self, obra_id)
        # ROTAS PRINCIPAIS - SESSÕES OBRAS
        elif path.startswith('/api/sessions/remove-obra/'):
            obra_id = path.split('/')[-1]
            self.route_handler.handle_delete_sessions_remove_obra(self, obra_id)

        else:
            print(f"❌ DELETE não implementado: {path}")
            self.send_error(501, f"Método não suportado: DELETE {path}")

    def handle_delete_universal(self):
        """API universal para deletar qualquer item do backup.json usando path"""
        try:
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(post_data)
            
            # Obrigatório: path como array (ex: ["obras", "obra_id", "projetos", "projeto_id"])
            path = data.get('path')
            
            if not path or not isinstance(path, list):
                self.send_json_response({
                    "success": False,
                    "error": "Path inválido. Deve ser um array (ex: ['obras', 'id_da_obra'])"
                }, status=400)
                return
            
            print(f"🗑️  DELETE UNIVERSAL - Path: {path}")
            
            # Chama o método no RoutesCore
            result = self.routes_core.handle_delete_universal(path)
            
            if result["success"]:
                self.send_json_response(result)
            else:
                self.send_json_response(result, status=500)
                
        except json.JSONDecodeError:
            self.send_json_response({
                "success": False,
                "error": "JSON inválido"
            }, status=400)
        except Exception as e:
            print(f"❌ Erro em handle_delete_universal: {e}")
            self.send_json_response({
                "success": False,
                "error": f"Erro interno: {str(e)}"
            }, status=500)

    def handle_health_check(self):
        """Health check rápido"""
        self.send_json_response({"status": "online", "timestamp": time.time()})
    
    def handle_empresa_routes(self, path):
        """Rotas de empresa otimizadas"""
        if path.startswith('/api/dados/empresas/buscar/'):
            termo = path.split('/')[-1]
            self.route_handler.handle_buscar_empresas(self, termo)
        elif path.startswith('/api/dados/empresas/numero/'):
            sigla = path.split('/')[-1]
            self.route_handler.handle_get_proximo_numero(self, sigla)
    
    def handle_obra_routes(self, path):
        """Rotas de obra otimizadas"""
        if self.command == 'GET':
            obra_id = path.split('/')[-1]
            self.route_handler.handle_get_obra_by_id(self, obra_id)

    def _add_cache_buster(self, path):
        """Adiciona cache buster à URL se não tiver"""
        if '?' in path:
            # Já tem parâmetros, adiciona ou atualiza o v=
            if 'v=' in path:
                # Substitui versão existente
                path = re.sub(r'[?&]v=[^&]+', f'&v={self.CACHE_BUSTER}', path)
                # Corrige se ficou ?& substituindo por ?
                path = path.replace('?&', '?')
            else:
                # Adiciona novo parâmetro
                path += f'&v={self.CACHE_BUSTER}'
        else:
            # Primeiro parâmetro
            path += f'?v={self.CACHE_BUSTER}'
        
        return path
    
    def serve_static_file_no_cache(self, path):
        """Serve arquivos estáticos - sempre do disco com headers anti-cache"""
        try:
            # Remove parâmetros para encontrar arquivo real
            clean_path = path.split('?')[0]
            file_path = self.translate_path(clean_path)
            
            if os.path.isfile(file_path):
                self.send_response(200)
                
                # Determina content-type
                if clean_path.endswith('.css'):
                    content_type = 'text/css'
                elif clean_path.endswith('.js'):
                    content_type = 'application/javascript'
                elif clean_path.endswith(('.html', '.htm')):
                    content_type = 'text/html'
                elif clean_path.endswith('.json'):
                    content_type = 'application/json'
                elif clean_path.endswith('.png'):
                    content_type = 'image/png'
                elif clean_path.endswith('.jpg') or clean_path.endswith('.jpeg'):
                    content_type = 'image/jpeg'
                elif clean_path.endswith('.svg'):
                    content_type = 'image/svg+xml'
                else:
                    content_type = self.guess_type(clean_path)
                
                self.send_header('Content-type', content_type)
                
                # HEADERS ANTI-CACHE DEFINITIVOS
                self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate, max-age=0')
                self.send_header('Pragma', 'no-cache')
                self.send_header('Expires', '0')
                self.send_header('Last-Modified', self.date_time_string(time.time()))
                
                self.end_headers()
                
                with open(file_path, 'rb') as f:
                    self.wfile.write(f.read())
            else:
                self.send_error(404, f"File not found: {clean_path}")
                
        except Exception as e:
            print(f"❌ Erro em {path}: {e}")
            self.send_error(404, f"Recurso não encontrado: {path}")
    
    def send_json_response(self, data, status=200):
        """Resposta JSON RÁPIDA SEM compressão para simplicidade"""
        try:
            response = json.dumps(data, ensure_ascii=False).encode('utf-8')
            
            # Resposta direta SEM compressão
            self.send_response(status)
            self.send_header('Content-type', 'application/json; charset=utf-8')
            self.send_header('Content-Length', str(len(response)))
            self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate')
            self.send_header('Pragma', 'no-cache')
            self.send_header('Expires', '0')
            self.end_headers()
            self.wfile.write(response)
                
        except Exception as e:
            print(f"❌ Erro em send_json_response: {e}")
            self.send_error(500, "Erro interno")
    
    def end_headers(self):
        """Headers CORS otimizados """
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        # Headers anti-cache
        self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate')
        self.send_header('Pragma', 'no-cache')
        self.send_header('Expires', '0')
        super().end_headers()
    
    def do_OPTIONS(self):
        """CORS rápido"""
        self.send_response(200)
        self.end_headers()

    def log_message(self, format, *args):
        """Log SILENCIOSO - apenas erros e APIs importantes"""
        message = format % args
        # Apenas logs importantes
        if any(keyword in message for keyword in [' 404', ' 500', ' 403', '/api/', '/obras', '/empresas']):
            print(f"🌐 {self.address_string()} - {message}")
            
            
            
    def handle_machine_routes(self, path):
        """Rotas específicas para máquinas"""
        if self.command == 'GET':
            if path == '/api/machines/types':
                self.route_handler.handle_get_machine_types(self)
            elif path.startswith('/api/machines/type/'):
                machine_type = path.split('/')[-1]
                self.route_handler.handle_get_machine_by_type(self, machine_type)
"""
route_handler.py
Handler principal de rotas - Interface entre HTTP e Core
"""

import json
from http.server import BaseHTTPRequestHandler
from urllib.parse import urlparse, parse_qs
import os

class RouteHandler:
    """Manipula o roteamento de requisições HTTP"""
    
    def __init__(self, project_root, sessions_manager, file_utils, cache_cleaner):
        self.project_root = project_root
        self.sessions_manager = sessions_manager
        self.file_utils = file_utils
        self.cache_cleaner = cache_cleaner
        
        # RoutesCore será injetado depois para evitar import circular
        self.routes_core = None
    
    def set_routes_core(self, routes_core):
        """Define o RoutesCore após a inicialização para evitar import circular"""
        self.routes_core = routes_core

    # ========== ROTAS DE OBRAS ==========

    def handle_get_obras(self, handler):
        """GET /obras"""
        obras = self.routes_core.handle_get_obras()
        handler.send_json_response(obras)

    def handle_get_obra_by_id(self, handler, obra_id):
        """GET /obras/{id}"""
        obra = self.routes_core.handle_get_obra_by_id(obra_id)
        if obra:
            handler.send_json_response(obra)
        else:
            handler.send_error(404, f"Obra {obra_id} não encontrada")

    def handle_post_obras(self, handler):
        """POST /obras"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        obra = self.routes_core.handle_post_obras(post_data)
        if obra:
            handler.send_json_response(obra)
        else:
            handler.send_error(500, "Erro ao salvar obra")

    def handle_put_obra(self, handler):
        """PUT /obras/{id}"""
        obra_id = handler.path.split('/')[-1]
        content_length = int(handler.headers['Content-Length'])
        put_data = handler.rfile.read(content_length).decode('utf-8')
        
        obra = self.routes_core.handle_put_obra(obra_id, put_data)
        if obra:
            handler.send_json_response(obra)
        else:
            handler.send_error(404, f"Obra {obra_id} não encontrada")

    def handle_delete_obra(self, handler, obra_id):
        """DELETE /obras/{id}"""
        success = self.routes_core.handle_delete_obra(obra_id)
        if success:
            handler.send_json_response({
                "success": True,
                "message": f"Obra {obra_id} deletada com sucesso"
            })
        else:
            handler.send_error(500, "Erro ao deletar obra")

    # ========== ROTAS DE EMPRESAS ==========

    def handle_get_empresas(self, handler):
        """GET /api/dados/empresas"""
        empresas = self.routes_core.handle_get_empresas()
        handler.send_json_response(empresas)
        
    def handle_get_proximo_numero(self, handler, sigla):
        """GET /api/dados/empresas/numero/{sigla}"""
        numero = self.routes_core.handle_get_proximo_numero(sigla)
        handler.send_json_response(numero)

    def handle_post_empresas(self, handler):
        """POST /api/dados/empresas"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_empresas(post_data)
        handler.send_json_response(result)

    def handle_buscar_empresas(self, handler, termo):
        """GET /api/dados/empresas/buscar/{termo}"""
        result = self.routes_core.handle_buscar_empresas(termo)
        handler.send_json_response(result)

    # ========== ROTAS DE SESSÃO ==========

    def handle_get_sessions_current(self, handler):
        """GET /api/sessions/current"""
        session_data = self.routes_core.handle_get_sessions_current()
        handler.send_json_response(session_data)

    def handle_post_sessions_add_obra(self, handler):
        """POST /api/sessions/add-obra"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_sessions_add_obra(post_data)
        if result["success"]:
            handler.send_json_response(result)
        else:
            handler.send_error(500, result["error"])

    def handle_delete_sessions_remove_obra(self, handler, obra_id):
        """DELETE /api/sessions/remove-obra/{id}"""
        result = self.routes_core.handle_delete_sessions_remove_obra(obra_id)
        if result["success"]:
            handler.send_json_response(result)
        else:
            handler.send_error(500, result["error"])

    def handle_get_session_obras(self, handler):
        """GET /api/session-obras"""
        result = self.routes_core.handle_get_session_obras()
        handler.send_json_response(result)

    def handle_post_sessions_shutdown(self, handler):
        """POST /api/sessions/shutdown"""
        result = self.routes_core.handle_post_sessions_shutdown()
        handler.send_json_response(result)

    def handle_shutdown(self, handler):
        """POST /api/shutdown"""
        response = self.routes_core.handle_shutdown()
        handler.send_json_response(response)

    def handle_post_sessions_ensure_single(self, handler):
        """POST /api/sessions/ensure-single"""
        result = self.routes_core.handle_post_sessions_ensure_single()
        if result["success"]:
            handler.send_json_response(result)
        else:
            handler.send_error(500, result["error"])

    # ========== ROTAS DE SISTEMA ==========

    def handle_get_server_uptime(self, handler):
        """GET /api/server/uptime"""
        result = self.routes_core.handle_get_server_uptime()
        handler.send_json_response(result)

    def handle_get_constants(self, handler):
        """GET /constants"""
        constants = self.routes_core.handle_get_constants()
        handler.send_json_response(constants)

    def handle_get_machines(self, handler):
        """GET /machines"""
        machines = self.routes_core.handle_get_machines()
        handler.send_json_response(machines)

    def handle_get_dados(self, handler):
        """GET /dados"""
        dados = self.routes_core.handle_get_dados()
        handler.send_json_response(dados)

    def handle_get_backup(self, handler):
        """GET /backup"""
        backup = self.routes_core.handle_get_backup()
        handler.send_json_response(backup)

    def handle_get_backup_completo(self, handler):
        """GET /api/backup-completo"""
        backup = self.routes_core.handle_get_backup_completo()
        handler.send_json_response(backup)

    def handle_post_dados(self, handler):
        """POST /dados"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_dados(post_data)
        handler.send_json_response(result)

    def handle_post_backup(self, handler):
        """POST /backup"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_backup(post_data)
        handler.send_json_response(result)

    def handle_post_reload_page(self, handler):
        """POST /api/reload-page"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_reload_page(post_data)
        handler.send_json_response(result)

    # ========== ROTAS DE COMPATIBILIDADE ==========

    def handle_get_projetos(self, handler):
        """GET /projetos (legacy)"""
        projetos = self.routes_core.handle_get_projetos()
        handler.send_json_response(projetos)

    def handle_post_projetos(self, handler):
        """POST /projetos (legacy)"""
        handler.send_error(501, "Use o endpoint /obras em vez de /projetos")

    def handle_get_session_projects(self, handler):
        """GET /api/session-projects (legacy)"""
        handler.send_json_response([])

    def handle_delete_sessions_remove_project(self, handler, project_id):
        """DELETE /api/sessions/remove-project/{id} (legacy)"""
        result = self.routes_core.handle_delete_sessions_remove_project(project_id)
        if result["success"]:
            handler.send_json_response(result)
        else:
            handler.send_error(500, result["error"])
        
    def handle_post_empresas_auto(self, handler):
        """POST /api/dados/empresas/auto"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_empresas_auto(post_data)
        handler.send_json_response(result)
        
            # ========== ROTA UNIVERSAL DELETE ==========
    
    def handle_delete_universal(self, handler):
        """DELETE /api/delete - Rota universal para deletar qualquer item"""
        result = self.routes_core.handle_delete_universal_from_handler(handler)
        handler.send_json_response(result)
        
        
        
    # ========== ROTAS PARA SISTEMA DE EDIÇÃO ==========

    def handle_get_system_data(self, handler):
        """GET /api/system-data - Retorna TODOS os dados do sistema"""
        system_data = self.routes_core.handle_get_system_data()
        handler.send_json_response(system_data)

    def handle_get_constants_json(self, handler):
        """GET /api/constants - Retorna apenas as constantes"""
        constants = self.routes_core.handle_get_constants_json()
        handler.send_json_response(constants)

    def handle_get_materials(self, handler):
        """GET /api/materials - Retorna materiais"""
        materials = self.routes_core.handle_get_materials()
        handler.send_json_response(materials)

    def handle_get_all_empresas(self, handler):
        """GET /api/empresas/all - Retorna todas empresas formatadas"""
        empresas = self.routes_core.handle_get_all_empresas()
        handler.send_json_response(empresas)

    def handle_get_machine_types(self, handler):
        """GET /api/machines/types - Retorna tipos de máquinas"""
        machine_types = self.routes_core.handle_get_machine_types()
        handler.send_json_response(machine_types)

    def handle_get_machine_by_type(self, handler, machine_type):
        """GET /api/machines/type/{type} - Retorna máquina específica"""
        machine = self.routes_core.handle_get_machine_by_type(machine_type)
        if machine:
            handler.send_json_response(machine)
        else:
            handler.send_error(404, f"Máquina tipo {machine_type} não encontrada")

    def handle_post_save_system_data(self, handler):
        """POST /api/system-data/save - Salva todos os dados"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_save_system_data(post_data)
        handler.send_json_response(result)

    def handle_post_save_constants(self, handler):
        """POST /api/constants/save - Salva constantes"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_save_constants(post_data)
        handler.send_json_response(result)

    def handle_post_save_materials(self, handler):
        """POST /api/materials/save - Salva materiais"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_save_materials(post_data)
        handler.send_json_response(result)

    def handle_post_save_empresas(self, handler):
        """POST /api/empresas/save - Salva empresas"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_save_empresas(post_data)
        handler.send_json_response(result)

    def handle_post_save_machines(self, handler):
        """POST /api/machines/save - Salva máquinas"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_save_machines(post_data)
        handler.send_json_response(result)

    def handle_post_add_machine(self, handler):
        """POST /api/machines/add - Adiciona nova máquina"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_add_machine(post_data)
        handler.send_json_response(result)

    def handle_post_update_machine(self, handler):
        """POST /api/machines/update - Atualiza máquina existente"""
        content_length = int(handler.headers['Content-Length'])
        post_data = handler.rfile.read(content_length).decode('utf-8')
        
        result = self.routes_core.handle_post_update_machine(post_data)
        handler.send_json_response(result)
# servidor_modules/core/routes_core.py

"""
routes_core.py
Núcleo das rotas - Divisão lógica das funcionalidades
"""

import json
import time
import threading
from pathlib import Path

# from servidor_modules.handlers.empresa_handler import EmpresaHandler  # REMOVA esta linha


class RoutesCore:
    """Núcleo das funcionalidades de rotas organizadas por categoria"""

    def __init__(self, project_root, sessions_manager, file_utils, cache_cleaner):
        self.project_root = project_root
        self.sessions_manager = sessions_manager
        self.file_utils = file_utils
        self.cache_cleaner = cache_cleaner

        # Inicializa EmpresaHandler com file_utils injetado
        from servidor_modules.handlers.empresa_handler import EmpresaHandler

        self.empresa_handler = EmpresaHandler(file_utils=self.file_utils)

    # ========== ROTAS DE OBRAS ==========

    def handle_get_obras(self):
        """Obtém todas as obras da sessão atual"""
        try:
            print("🎯 [OBRAS] Obtendo obras da sessão")

            current_session_id = self.sessions_manager.get_current_session_id()
            session_data = self.sessions_manager._load_sessions_data()
            session_obra_ids = (
                session_data["sessions"].get(current_session_id, {}).get("obras", [])
            )

            backup_path = self.project_root / "json" / "backup.json"

            if not backup_path.exists():
                return []

            with open(backup_path, "r", encoding="utf-8") as f:
                backup_data = json.loads(f.read())

            obras = backup_data.get("obras", [])
            if not isinstance(obras, list):
                obras = []

            obras_da_sessao = []
            for obra in obras:
                if not isinstance(obra, dict):
                    continue

                obra_id = str(obra.get("id", ""))
                if obra_id in session_obra_ids:
                    obras_da_sessao.append(obra)

            print(f"🎯 ENVIANDO: {len(obras_da_sessao)} obras da sessão")
            return obras_da_sessao

        except Exception as e:
            print(f"❌ ERRO em handle_get_obras: {str(e)}")
            return []

    def handle_get_obra_by_id(self, obra_id):
        """Obtém uma obra específica por ID"""
        try:
            print(f"🎯 [OBRA POR ID] Buscando obra {obra_id}")

            backup_path = self.project_root / "json" / "backup.json"

            if not backup_path.exists():
                return None

            with open(backup_path, "r", encoding="utf-8") as f:
                backup_data = json.loads(f.read())

            obras = backup_data.get("obras", [])

            for obra in obras:
                if str(obra.get("id")) == obra_id:
                    print(f"✅ Obra {obra_id} encontrada")
                    return obra

            print(f"❌ Obra {obra_id} não encontrada")
            return None

        except Exception as e:
            print(f"❌ ERRO em handle_get_obra_by_id: {str(e)}")
            return None

    def handle_post_obras(self, post_data):
        """Salva nova obra e adiciona à sessão - COM VERIFICAÇÃO DE EMPRESA"""
        try:
            nova_obra = json.loads(post_data)

            # 🆕 VERIFICAR E CRIAR EMPRESA AUTOMATICAMENTE ANTES DE SALVAR OBRA
            print("🔍 [OBRA] Verificando se precisa criar empresa automaticamente...")
            nova_obra = self.empresa_handler.verificar_e_criar_empresa_automatica(
                nova_obra
            )

            backup_file = self.file_utils.find_json_file(
                "backup.json", self.project_root
            )
            backup_data = self.file_utils.load_json_file(
                backup_file, {"obras": [], "projetos": []}
            )

            obra_id = nova_obra.get("id")

            if not obra_id or obra_id.isdigit():
                import random
                import string

                letters = "abcdefghjkmnpqrstwxyz"
                random_letter1 = random.choice(letters)
                random_letter2 = random.choice(letters)
                random_num = random.randint(10, 99)
                obra_id = f"obra_{random_letter1}{random_num}"

                print(f"🆕 Backend gerou ID seguro: {obra_id}")

            nova_obra["id"] = obra_id

            print(f"📝 Tentando adicionar obra {obra_id} à sessão...")
            success = self.sessions_manager.add_obra_to_session(obra_id)

            if not success:
                print(f"❌ FALHA ao adicionar obra {obra_id} à sessão")
                return None

            obras = backup_data.get("obras", [])
            obras.append(nova_obra)
            backup_data["obras"] = obras

            print(f"➕ ADICIONANDO nova obra ID: {obra_id}")

            if self.file_utils.save_json_file(backup_file, backup_data):
                print(f"✅ Obra {obra_id} salva com sucesso")
                return nova_obra
            else:
                return None

        except Exception as e:
            print(f"❌ Erro ao adicionar obra: {str(e)}")
            return None

    # NO routes_core.py, MODIFIQUE também o método handle_put_obra:

    def handle_put_obra(self, obra_id, put_data):
        """Atualiza obra existente - COM VERIFICAÇÃO DE EMPRESA"""
        try:
            obra_atualizada = json.loads(put_data)

            # 🆕 VERIFICAR E CRIAR EMPRESA AUTOMATICAMENTE ANTES DE ATUALIZAR OBRA
            print(
                "🔍 [OBRA UPDATE] Verificando se precisa criar empresa automaticamente..."
            )
            obra_atualizada = self.empresa_handler.verificar_e_criar_empresa_automatica(
                obra_atualizada
            )

            backup_file = self.file_utils.find_json_file(
                "backup.json", self.project_root
            )
            backup_data = self.file_utils.load_json_file(backup_file)

            if not backup_data:
                return None

            obras = backup_data.get("obras", [])
            obra_encontrada = False

            for i, obra in enumerate(obras):
                if str(obra.get("id")) == obra_id:
                    obras[i] = obra_atualizada
                    obra_encontrada = True
                    print(f"✏️  ATUALIZANDO obra {obra_id}")
                    break

            if not obra_encontrada:
                return None

            backup_data["obras"] = obras

            if self.file_utils.save_json_file(backup_file, backup_data):
                return obra_atualizada
            else:
                return None

        except Exception as e:
            print(f"❌ Erro ao atualizar obra: {str(e)}")
            return None

    def handle_delete_obra(self, obra_id):
        """Deleta uma obra do servidor"""
        try:
            print(f"🗑️  Deletando obra {obra_id} do servidor")

            backup_file = self.file_utils.find_json_file(
                "backup.json", self.project_root
            )
            backup_data = self.file_utils.load_json_file(backup_file, {"obras": []})

            obras = backup_data.get("obras", [])
            obra_encontrada = False

            obras_atualizadas = []
            for obra in obras:
                if str(obra.get("id")) != obra_id:
                    obras_atualizadas.append(obra)
                else:
                    obra_encontrada = True
                    print(f"✅ Obra {obra_id} encontrada para remoção")

            if not obra_encontrada:
                return False

            backup_data["obras"] = obras_atualizadas

            if self.file_utils.save_json_file(backup_file, backup_data):
                self.sessions_manager.remove_obra(obra_id)
                return True
            else:
                return False

        except Exception as e:
            print(f"❌ Erro ao deletar obra: {str(e)}")
            return False

    # ========= Metodos para empresas ========
    def handle_get_empresas(self):
        """Obtém todas as empresas"""
        try:
            empresas = self.empresa_handler.obter_empresas()
            return {"success": True, "empresas": empresas}
        except Exception as e:
            print(f"❌ Erro ao obter empresas: {e}")
            return {"success": False, "error": str(e)}

    def handle_post_empresas(self, post_data):
        """Adiciona nova empresa"""
        try:
            empresa_data = json.loads(post_data)
            sucesso, mensagem = self.empresa_handler.adicionar_empresa(empresa_data)

            return {"success": sucesso, "message": mensagem}
        except Exception as e:
            print(f"❌ Erro ao adicionar empresa: {e}")
            return {"success": False, "error": str(e)}

    def handle_buscar_empresas(self, termo):
        """Busca empresas por termo"""
        try:
            from urllib.parse import unquote

            termo_decodificado = unquote(termo)
            resultados = self.empresa_handler.buscar_empresa_por_termo(
                termo_decodificado
            )

            return {"success": True, "resultados": resultados}
        except Exception as e:
            print(f"❌ Erro ao buscar empresas: {e}")
            return {"success": False, "error": str(e), "resultados": []}

    def handle_get_proximo_numero(self, sigla):
        """Obtém próximo número para sigla"""
        try:
            from urllib.parse import unquote

            sigla_decodificada = unquote(sigla)
            numero = self.empresa_handler.obter_proximo_numero_cliente(
                sigla_decodificada
            )

            return {"success": True, "numero": numero}
        except Exception as e:
            print(f"❌ Erro ao obter próximo número: {e}")
            return {"success": False, "error": str(e), "numero": 1}

    # ========== ROTAS DE SESSÃO ==========

    def handle_get_sessions_current(self):
        """Retorna a sessão atual"""
        try:
            data = self.sessions_manager._load_sessions_data()
            current_session_id = self.sessions_manager.get_current_session_id()

            if current_session_id not in data["sessions"]:
                return {"sessions": {}}

            current_session = {current_session_id: data["sessions"][current_session_id]}

            print(f"📊 Retornando sessão {current_session_id}")
            return {"sessions": current_session}

        except Exception as e:
            print(f"❌ Erro ao obter sessão atual: {str(e)}")
            return {"sessions": {}}

    def handle_post_sessions_add_obra(self, post_data):
        """Adiciona uma obra à sessão atual"""
        try:
            data = json.loads(post_data)
            obra_id = data.get("obra_id")

            if not obra_id:
                return {"success": False, "error": "ID da obra não fornecido"}

            print(f"➕ Adicionando obra {obra_id} à sessão")
            success = self.sessions_manager.add_obra_to_session(obra_id)

            if success:
                return {
                    "success": True,
                    "message": f"Obra {obra_id} adicionada à sessão",
                }
            else:
                return {"success": False, "error": "Erro ao adicionar obra à sessão"}

        except Exception as e:
            print(f"❌ Erro ao adicionar obra à sessão: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_delete_sessions_remove_obra(self, obra_id):
        """Remove uma obra da sessão atual"""
        try:
            print(f"🗑️  Removendo obra {obra_id} da sessão")

            success = self.sessions_manager.remove_obra(obra_id)

            if success:
                return {
                    "success": True,
                    "message": f"Obra {obra_id} removida da sessão",
                }
            else:
                return {"success": False, "error": "Erro ao remover obra da sessão"}

        except Exception as e:
            print(f"❌ Erro ao remover obra da sessão: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_get_session_obras(self):
        """Retorna apenas os IDs das obras da sessão atual"""
        try:
            session_obras = self.sessions_manager.get_session_obras()
            current_session_id = self.sessions_manager.get_current_session_id()

            print(
                f"📋 [SESSION-OBRAS] Sessão {current_session_id} - Obras: {session_obras}"
            )

            return {"session_id": current_session_id, "obras": session_obras}

        except Exception as e:
            print(f"❌ Erro em handle_get_session_obras: {str(e)}")
            return {"session_id": "error", "obras": []}

    def handle_post_sessions_shutdown(self):
        """Limpa COMPLETAMENTE TODAS as sessões"""
        try:
            print(f"🔴 SHUTDOWN COMPLETO: Deletando TODAS as sessões")

            data_before = self.sessions_manager._load_sessions_data()
            print(f"📄 Estado ANTES do shutdown: {data_before}")

            success = self.sessions_manager.clear_session()

            data_after = self.sessions_manager._load_sessions_data()
            print(f"📄 Estado DEPOIS do shutdown: {data_after}")

            is_empty = (
                not data_after.get("sessions")
                or data_after["sessions"] == {}
                or (
                    data_after.get("sessions", {})
                    .get("session_active", {})
                    .get("obras", [])
                    == []
                )
            )

            if success and is_empty:
                return {
                    "success": True,
                    "message": "Sessões DELETADAS completamente",
                    "final_state": data_after,
                }
            else:
                print("🔄 Método normal falhou - forçando limpeza...")
                success = self.sessions_manager.force_clear_all_sessions()
                data_final = self.sessions_manager._load_sessions_data()

                final_is_empty = (
                    not data_final.get("sessions")
                    or data_final["sessions"] == {}
                    or (
                        data_final.get("sessions", {})
                        .get("session_active", {})
                        .get("obras", [])
                        == []
                    )
                )

                if success and final_is_empty:
                    return {
                        "success": True,
                        "message": "Sessões DELETADAS (forçado)",
                        "final_state": data_final,
                    }
                else:
                    print(
                        f"⚠️  Sessão final não está completamente vazia, mas considerando sucesso: {data_final}"
                    )
                    return {
                        "success": True,
                        "message": "Sessões limpas com aviso",
                        "final_state": data_final,
                        "warning": "Sessão pode conter dados residuais",
                    }

        except Exception as e:
            print(f"❌ Erro no shutdown: {str(e)}")
            return {
                "success": True,
                "message": "Sessões limpas (com erro ignorado)",
                "error_ignored": str(e),
            }

    def handle_post_sessions_ensure_single(self):
        """Garante que apenas uma sessão esteja ativa por vez"""
        try:
            print(f"🔒 Garantindo sessão única")

            success = self.sessions_manager.ensure_single_session()
            current_session_id = self.sessions_manager.get_current_session_id()
            obra_ids = self.sessions_manager.get_session_obras()

            if success:
                return {
                    "success": True,
                    "message": "Sessão única configurada",
                    "session_id": current_session_id,
                    "obras_count": len(obra_ids),
                    "obras": obra_ids,
                }
            else:
                return {"success": False, "error": "Erro ao configurar sessão única"}

        except Exception as e:
            print(f"❌ Erro ao configurar sessão única: {str(e)}")
            return {"success": False, "error": str(e)}

    # ========== ROTAS DE SISTEMA ==========

    def handle_shutdown(self):
        """Encerra o servidor com limpeza de cache"""
        try:
            print("🔴 SHUTDOWN SOLICITADO VIA BOTÃO - ENCERRANDO SERVIDOR")

            response = {
                "status": "shutting_down",
                "message": "Servidor encerrado com sucesso via botão",
                "action": "close_window",
                "close_delay": 3000,
            }

            print("✅ Resposta enviada ao cliente - servidor será encerrado")

            def shutdown_sequence():
                print("🔄 Iniciando sequência de encerramento...")

                try:
                    print("🧹 Executando limpeza de cache...")
                    self.cache_cleaner.clean_pycache_async()
                except Exception as cache_error:
                    print(f"⚠️  Erro na limpeza de cache: {cache_error}")

                time.sleep(2)
                print("💥 Forçando encerramento do processo Python...")

                import os

                os._exit(0)

            shutdown_thread = threading.Thread(target=shutdown_sequence)
            shutdown_thread.daemon = True
            shutdown_thread.start()

            return response

        except Exception as e:
            print(f"❌ Erro no shutdown: {str(e)}")

            try:
                self.cache_cleaner.clean_pycache_async()
            except:
                pass

            import os

            os._exit(0)

    def handle_get_constants(self):
        """Constants do DADOS.json"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})

            constants = dados_data.get("constants", {})
            print(f"⚙️  Retornando constants")
            return constants

        except Exception as e:
            print(f"❌ Erro ao carregar constants: {str(e)}")
            return {}

    def handle_get_machines(self):
        """Machines do DADOS.json"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})

            machines = dados_data.get("machines", [])
            print(f"🖥️  Retornando {len(machines)} máquinas")
            return machines

        except Exception as e:
            print(f"❌ Erro ao carregar machines: {str(e)}")
            return []

    def handle_get_dados(self):
        """DADOS.json completo"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(
                dados_file, {"constants": {}, "machines": []}
            )

            print("📁 Retornando DADOS.json")
            return dados_data

        except Exception as e:
            print(f"❌ Erro ao carregar dados: {str(e)}")
            return {"constants": {}, "machines": []}

    def handle_get_backup(self):
        """BACKUP.json completo"""
        try:
            backup_file = self.file_utils.find_json_file(
                "backup.json", self.project_root
            )
            backup_data = self.file_utils.load_json_file(
                backup_file, {"obras": [], "projetos": []}
            )

            print("💾 Retornando BACKUP.json")
            return backup_data

        except Exception as e:
            print(f"❌ Erro ao carregar backup: {str(e)}")
            return {"obras": [], "projetos": []}

    def handle_get_backup_completo(self):
        """Obtém TODAS as obras do backup (sem filtro de sessão)"""
        try:
            print("🎯 [BACKUP COMPLETO] Obtendo TODAS as obras")

            backup_path = self.project_root / "json" / "backup.json"

            if not backup_path.exists():
                return {"obras": []}

            with open(backup_path, "r", encoding="utf-8") as f:
                backup_content = f.read()

            backup_data = json.loads(backup_content)
            obras = backup_data.get("obras", [])

            print(f"📁 Total de obras no backup: {len(obras)}")
            return {"obras": obras}

        except Exception as e:
            print(f"❌ ERRO em handle_get_backup_completo: {str(e)}")
            return {"obras": []}

    def handle_post_dados(self, post_data):
        """Salva DADOS.json"""
        try:
            new_data = json.loads(post_data)

            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)

            if self.file_utils.save_json_file(dados_file, new_data):
                print("💾 DADOS.json salvo")
                return {"status": "success", "message": "Dados salvos"}
            else:
                return {"status": "error", "message": "Erro ao salvar dados"}

        except Exception as e:
            print(f"❌ Erro ao salvar dados: {str(e)}")
            return {"status": "error", "message": str(e)}

    def handle_post_backup(self, post_data):
        """Salva BACKUP.json"""
        try:
            new_data = json.loads(post_data)

            backup_file = self.file_utils.find_json_file(
                "backup.json", self.project_root
            )

            if self.file_utils.save_json_file(backup_file, new_data):
                print("💾 BACKUP.json salvo")
                return {"status": "success", "message": "Backup salvo"}
            else:
                return {"status": "error", "message": "Erro ao salvar backup"}

        except Exception as e:
            print(f"❌ Erro ao salvar backup: {str(e)}")
            return {"status": "error", "message": str(e)}

    def handle_post_reload_page(self, post_data):
        """Força recarregamento da página via Python"""
        try:
            data = json.loads(post_data)

            action = data.get("action", "unknown")
            obra_id = data.get("obraId")
            obra_name = data.get("obraName")

            print(
                f"🔄 [RECARREGAMENTO] Ação: {action}, Obra: {obra_name} (ID: {obra_id})"
            )

            if action == "undo":
                print(
                    f"↩️ Usuário desfez exclusão da obra {obra_name} - mantendo na sessão"
                )
            elif action == "undo_no_data":
                print(
                    f"↩️ Usuário desfez exclusão (dados insuficientes) - recarregando página"
                )
            elif action.startswith("timeout"):
                print(f"⏰ Timeout completo - obra {obra_name} removida da sessão")

            return {
                "reload_required": True,
                "action": action,
                "obra_id": obra_id,
                "obra_name": obra_name,
                "message": "Página será recarregada",
                "reload_delay": 500,
            }

            print(f"✅ Comando de recarregamento enviado para o frontend")

        except Exception as e:
            print(f"❌ Erro no recarregamento: {str(e)}")
            return {
                "reload_required": True,
                "error": str(e),
                "message": "Recarregamento forçado devido a erro",
            }

            # ========== ROTA UNIVERSAL DELETE ==========


    def handle_delete_universal(self, path_array):
        """Deleta qualquer item no backup.json seguindo um caminho específico"""
        try:
            print(f"🔍 [DELETE UNIVERSAL] Path recebido: {path_array}")
            print(f"🔍 [DELETE UNIVERSAL] Tipos dos elementos: {[type(item) for item in path_array]}")
            
            # Carrega backup.json
            backup_file = self.file_utils.find_json_file('backup.json', self.project_root)
            backup_data = self.file_utils.load_json_file(backup_file, {})
            
            current = backup_data
            parent = None
            parent_key = None
            
            # Navega até o penúltimo nível
            for i, key in enumerate(path_array[:-1]):
                print(f"🔍 Navegando: key='{key}' (tipo: {type(key)}), nível={i}, tipo_atual={type(current)}")
                
                if isinstance(current, list):
                    # Buscar por ID em array (obras, projetos, salas)
                    item_found = False
                    for idx, item in enumerate(current):
                        if isinstance(item, dict) and str(item.get('id', '')) == str(key):
                            parent = current
                            parent_key = idx
                            current = item
                            item_found = True
                            print(f"✅ Encontrado '{key}' no índice {idx}")
                            break
                    
                    if not item_found:
                        return {
                            "success": False,
                            "error": f"Caminho inválido: '{key}' não encontrado",
                            "path": path_array
                        }
                        
                elif isinstance(current, dict):
                    # Acesso direto por chave de dicionário
                    if key not in current:
                        return {
                            "success": False,
                            "error": f"Caminho inválido: '{key}' não encontrado",
                            "path": path_array
                        }
                    parent = current
                    parent_key = key
                    current = current[key]
                else:
                    return {
                        "success": False,
                        "error": f"Tipo inválido no caminho: {type(current)}",
                        "path": path_array
                    }
            
            # 🔥 CORREÇÃO CRÍTICA: ÚLTIMO ELEMENTO - SEMPRE tenta como índice primeiro
            last_item = path_array[-1]
            print(f"🔍 Último item a deletar: '{last_item}' (tipo: {type(last_item)})")
            print(f"🔍 Nível final type: {type(current)}")
            
            if isinstance(current, list):
                print(f"🔍 Array final com {len(current)} itens")
                
                # 🔥 SEMPRE TENTA COMO ÍNDICE PRIMEIRO (para máquinas)
                try:
                    # Converter para inteiro
                    item_index = int(last_item)
                    print(f"🔍 Interpretando '{last_item}' como índice numérico: {item_index}")
                    
                    if 0 <= item_index < len(current):
                        print(f"✅ Removendo pelo índice {item_index}")
                        deleted_item = current.pop(item_index)
                        print(f"✅ Item removido do índice {item_index}. Array agora tem {len(current)} itens")
                    else:
                        return {
                            "success": False,
                            "error": f"Índice {item_index} fora do range (0-{len(current)-1})",
                            "path": path_array
                        }
                        
                except (ValueError, TypeError) as e:
                    # Se não for número, buscar por ID (para obras/projetos/salas)
                    print(f"🔍 '{last_item}' não é número válido, buscando por ID...")
                    item_index = -1
                    for i, item in enumerate(current):
                        if isinstance(item, dict):
                            item_id = str(item.get('id', ''))
                            if item_id == str(last_item):
                                item_index = i
                                break
                    
                    if item_index == -1:
                        return {
                            "success": False,
                            "error": f"Item '{last_item}' não encontrado",
                            "path": path_array
                        }
                    
                    deleted_item = current.pop(item_index)
                    print(f"✅ Removido item com ID '{last_item}' no índice {item_index}")
                    
            elif isinstance(current, dict):
                # Para dicionários, remover pela chave
                if str(last_item) not in current:
                    return {
                        "success": False,
                        "error": f"Item '{last_item}' não encontrado no dicionário",
                        "path": path_array
                    }
                
                deleted_item = current.pop(str(last_item))
                print(f"✅ Removido chave '{last_item}' do dicionário")
            else:
                return {
                    "success": False,
                    "error": f"Tipo inválido: {type(current)}",
                    "path": path_array
                }
            
            # Salvar backup atualizado
            print(f"💾 Salvando backup atualizado...")
            if self.file_utils.save_json_file(backup_file, backup_data):
                # Se for uma obra, também remove da sessão atual
                if len(path_array) == 2 and path_array[0] == 'obras':
                    obra_id = path_array[1]
                    self.sessions_manager.remove_obra(obra_id)
                    print(f"🗑️ Obra {obra_id} também removida da sessão")
                
                return {
                    "success": True,
                    "message": "Item deletado com sucesso",
                    "path": path_array,
                    "deleted_item": str(last_item)
                }
            else:
                return {
                    "success": False,
                    "error": "Erro ao salvar backup.json",
                    "path": path_array
                }
            
        except Exception as e:
            print(f"❌ Erro em handle_delete_universal: {e}")
            import traceback
            traceback.print_exc()
            
            return {
                "success": False,
                "error": f"Erro interno: {str(e)}",
                "path": path_array
            }

    def handle_delete_universal_from_handler(self, handler):
        """Wrapper para receber dados do handler HTTP"""
        try:
            content_length = int(handler.headers["Content-Length"])
            post_data = handler.rfile.read(content_length).decode("utf-8")
            data = json.loads(post_data)

            path = data.get("path")

            if not path or not isinstance(path, list):
                return {
                    "success": False,
                    "error": "Path inválido. Deve ser um array (ex: ['obras', 'id_da_obra'])",
                }

            return self.handle_delete_universal(path)

        except json.JSONDecodeError:
            return {"success": False, "error": "JSON inválido"}
        except Exception as e:
            print(f"❌ Erro em handle_delete_universal_from_handler: {e}")
            return {"success": False, "error": f"Erro no handler: {str(e)}"}



    # ==========  FUNÇÕES PARA SISTEMA DE EDIÇÃO ==========

    def handle_get_system_data(self):
        """Retorna TODOS os dados do sistema para a interface de edição"""
        try:
            # Carrega dados.json
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(
                dados_file, 
                {"constants": {}, "machines": [], "materials": {}, "empresas": []}
            )
            
            # Garante que tem a estrutura completa
            if "empresas" not in dados_data:
                # Carrega empresas do formato existente
                if isinstance(dados_data.get("empresas"), list):
                    empresas_data = dados_data.get("empresas", [])
                else:
                    empresas_data = []
                dados_data["empresas"] = empresas_data
            
            print("📊 Retornando todos os dados do sistema")
            return dados_data
            
        except Exception as e:
            print(f"❌ Erro ao carregar system data: {str(e)}")
            return {"constants": {}, "machines": [], "materials": {}, "empresas": []}

    def handle_get_constants_json(self):
        """Retorna apenas as constantes formatadas"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            constants = dados_data.get("constants", {})
            return {"constants": constants}
            
        except Exception as e:
            print(f"❌ Erro ao carregar constants: {str(e)}")
            return {"constants": {}}

    def handle_get_materials(self):
        """Retorna materiais"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            materials = dados_data.get("materials", {})
            return {"materials": materials}
            
        except Exception as e:
            print(f"❌ Erro ao carregar materials: {str(e)}")
            return {"materials": {}}

    def handle_get_all_empresas(self):
        """Retorna todas empresas no formato correto"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            empresas = dados_data.get("empresas", [])
            # Garante que é uma lista de objetos
            if isinstance(empresas, list):
                return {"empresas": empresas}
            else:
                # Converte de dict para lista se necessário
                empresas_list = []
                if isinstance(empresas, dict):
                    for sigla, nome in empresas.items():
                        empresas_list.append({sigla: nome})
                return {"empresas": empresas_list}
            
        except Exception as e:
            print(f"❌ Erro ao carregar empresas: {str(e)}")
            return {"empresas": []}

    def handle_get_machine_types(self):
        """Retorna lista de tipos de máquinas"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            machines = dados_data.get("machines", [])
            machine_types = [machine.get("type", "") for machine in machines if machine.get("type")]
            
            return {"machine_types": machine_types}
            
        except Exception as e:
            print(f"❌ Erro ao carregar machine types: {str(e)}")
            return {"machine_types": []}

    def handle_get_machine_by_type(self, machine_type):
        """Retorna máquina específica pelo tipo"""
        try:
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            machines = dados_data.get("machines", [])
            
            for machine in machines:
                if machine.get("type") == machine_type:
                    return {"machine": machine}
            
            return {"machine": None}
            
        except Exception as e:
            print(f"❌ Erro ao carregar machine: {str(e)}")
            return {"machine": None}

    def handle_post_save_system_data(self, post_data):
        """Salva TODOS os dados do sistema"""
        try:
            new_data = json.loads(post_data)
            
            # Valida estrutura básica
            if not all(key in new_data for key in ["constants", "machines", "materials", "empresas"]):
                return {"success": False, "error": "Estrutura de dados inválida"}
            
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            
            if self.file_utils.save_json_file(dados_file, new_data):
                print("💾 TODOS os dados do sistema salvos")
                return {"success": True, "message": "Dados salvos com sucesso"}
            else:
                return {"success": False, "error": "Erro ao salvar dados"}
                
        except Exception as e:
            print(f"❌ Erro ao salvar system data: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_post_save_constants(self, post_data):
        """Salva apenas as constantes"""
        try:
            new_constants = json.loads(post_data)
            
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            dados_data["constants"] = new_constants.get("constants", {})
            
            if self.file_utils.save_json_file(dados_file, dados_data):
                print("💾 Constantes salvas")
                return {"success": True, "message": "Constantes salvas"}
            else:
                return {"success": False, "error": "Erro ao salvar constantes"}
                
        except Exception as e:
            print(f"❌ Erro ao salvar constants: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_post_save_materials(self, post_data):
        """Salva materiais"""
        try:
            new_materials = json.loads(post_data)
            
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            dados_data["materials"] = new_materials.get("materials", {})
            
            if self.file_utils.save_json_file(dados_file, dados_data):
                print("💾 Materiais salvos")
                return {"success": True, "message": "Materiais salvos"}
            else:
                return {"success": False, "error": "Erro ao salvar materiais"}
                
        except Exception as e:
            print(f"❌ Erro ao salvar materials: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_post_save_empresas(self, post_data):
        """Salva empresas"""
        try:
            new_empresas = json.loads(post_data)
            
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            dados_data["empresas"] = new_empresas.get("empresas", [])
            
            if self.file_utils.save_json_file(dados_file, dados_data):
                print("💾 Empresas salvas")
                return {"success": True, "message": "Empresas salvas"}
            else:
                return {"success": False, "error": "Erro ao salvar empresas"}
                
        except Exception as e:
            print(f"❌ Erro ao salvar empresas: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_post_save_machines(self, post_data):
        """Salva todas as máquinas"""
        try:
            new_machines = json.loads(post_data)
            
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            dados_data["machines"] = new_machines.get("machines", [])
            
            if self.file_utils.save_json_file(dados_file, dados_data):
                print("💾 Máquinas salvas")
                return {"success": True, "message": "Máquinas salvas"}
            else:
                return {"success": False, "error": "Erro ao salvar máquinas"}
                
        except Exception as e:
            print(f"❌ Erro ao salvar machines: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_post_add_machine(self, post_data):
        """Adiciona nova máquina"""
        try:
            new_machine = json.loads(post_data)
            
            if not new_machine.get("type"):
                return {"success": False, "error": "Tipo de máquina não especificado"}
            
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            machines = dados_data.get("machines", [])
            machines.append(new_machine)
            dados_data["machines"] = machines
            
            if self.file_utils.save_json_file(dados_file, dados_data):
                print(f"💾 Nova máquina '{new_machine.get('type')}' adicionada")
                return {"success": True, "message": "Máquina adicionada", "machine": new_machine}
            else:
                return {"success": False, "error": "Erro ao adicionar máquina"}
                
        except Exception as e:
            print(f"❌ Erro ao adicionar machine: {str(e)}")
            return {"success": False, "error": str(e)}

    def handle_post_update_machine(self, post_data):
        """Atualiza máquina existente"""
        try:
            update_data = json.loads(post_data)
            
            machine_type = update_data.get("type")
            if not machine_type:
                return {"success": False, "error": "Tipo de máquina não especificado"}
            
            dados_file = self.file_utils.find_json_file("dados.json", self.project_root)
            dados_data = self.file_utils.load_json_file(dados_file, {})
            
            machines = dados_data.get("machines", [])
            updated = False
            
            for i, machine in enumerate(machines):
                if machine.get("type") == machine_type:
                    machines[i] = update_data
                    updated = True
                    break
            
            if not updated:
                return {"success": False, "error": f"Máquina '{machine_type}' não encontrada"}
            
            dados_data["machines"] = machines
            
            if self.file_utils.save_json_file(dados_file, dados_data):
                print(f"💾 Máquina '{machine_type}' atualizada")
                return {"success": True, "message": "Máquina atualizada", "machine": update_data}
            else:
                return {"success": False, "error": "Erro ao atualizar máquina"}
                
        except Exception as e:
            print(f"❌ Erro ao atualizar machine: {str(e)}")
            return {"success": False, "error": str(e)}
