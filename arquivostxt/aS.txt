
/* ==== IN√çCIO: data/builders/ui-folder/data-fillers.js ==== */
/**
 * data/modules/climatizacao/data-fill.js
 * ARQUIVO DE PREENCHER AS SALAS - VERS√ÉO CORRIGIDA
 */

import { calculateVazaoArAndThermalGains } from '../../../features/calculations/air-flow.js';
import { triggerCalculation } from '../../../core/shared-utils.js';

/**
 * Preenche os campos de climatiza√ß√£o
 */
/**
 * Preenche os campos de climatiza√ß√£o
 */
function fillClimatizationInputs(roomElement, inputsData) {
    if (!roomElement || !inputsData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    // Preencher ambiente com nome da sala se estiver vazio
    const ambienteInput = roomElement.querySelector(`input[data-field="ambiente"]`);
    if (ambienteInput && (!inputsData.ambiente || inputsData.ambiente === '') && roomName) {
        inputsData.ambiente = roomName;
    }
    
    // ‚úÖ CORRE√á√ÉO: Encontrar a SE√á√ÉO DA TABELA, n√£o a se√ß√£o de climatiza√ß√£o
    const tableSection = roomElement.querySelector(`#section-content-${roomId}-input-table`);
    const inputsContainer = tableSection || roomElement; // Fallback para o elemento da sala
    
    console.log(`üìù Preenchendo inputs para sala ${roomName} (ID: ${roomId})`, {
        possuiTabela: !!tableSection,
        container: tableSection ? 'tabela' : 'sala'
    });
    
    // Processar pressuriza√ß√£o
    if (inputsData.pressurizacao !== undefined) {
        const isPressurizacaoAtiva = typeof inputsData.pressurizacao === 'boolean' 
            ? inputsData.pressurizacao 
            : inputsData.pressurizacao === 'true' || inputsData.pressurizacao === true || inputsData.pressurizacao === 1;
        
        const pressurizacaoValue = isPressurizacaoAtiva ? 'sim' : 'nao';
        
        // ‚úÖ CORRE√á√ÉO: Buscar radios dentro do container correto
        const pressurizacaoRadios = inputsContainer.querySelectorAll(`input[type="radio"][name*="pressurizacao"]`);
        
        let radioToCheck = null;
        pressurizacaoRadios.forEach(radio => {
            if (radio.value === pressurizacaoValue) {
                radioToCheck = radio;
            }
        });

        if (radioToCheck) {
            pressurizacaoRadios.forEach(radio => {
                radio.checked = false;
            });
            
            radioToCheck.checked = true;
            
            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                radioToCheck.dispatchEvent(event);
            }, 100);
        }
    }

    // Preencher outros inputs ap√≥s delay
    setTimeout(() => {
        // ‚úÖ CORRE√á√ÉO: Buscar inputs dentro do container correto
        const textInputs = inputsContainer.querySelectorAll('.clima-input[type="text"], .clima-input[type="number"], .clima-input[data-field]');
        
        textInputs.forEach(input => {
            const field = input.getAttribute('data-field');
            if (!field || inputsData[field] === undefined) return;

            // Apenas pula pressurizacaoSetpoint se a pressuriza√ß√£o n√£o estiver ativa
            if (field === 'pressurizacaoSetpoint') {
                // Verificar se a pressuriza√ß√£o est√° ativa
                const pressurizacaoValue = inputsData.pressurizacao;
                const isPressurizacaoAtiva = typeof pressurizacaoValue === 'boolean' 
                    ? pressurizacaoValue 
                    : pressurizacaoValue === 'true' || pressurizacaoValue === true || pressurizacaoValue === 1;
                
                if (!isPressurizacaoAtiva) {
                    return; // N√£o preencher setpoint se pressuriza√ß√£o n√£o estiver ativa
                }
            }
            
            let value = inputsData[field];
            
            if (input.type === 'number') {
                if (value === false || value === 'false' || value === null || value === '') {
                    value = 0;
                }
                if (value === true || value === 'true') {
                    value = 1;
                }
                
                const numericValue = parseFloat(value);
                value = isNaN(numericValue) ? 0 : numericValue;
            }
            
            input.value = value;

            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }, 50);
        });

        // Preencher selects
        const selectInputs = inputsContainer.querySelectorAll('select.clima-input[data-field]');
        selectInputs.forEach(select => {
            const field = select.getAttribute('data-field');
            if (!field || inputsData[field] === undefined) return;

            const value = inputsData[field];
            select.value = value;

            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
            }, 50);
        });

        // Configurar sincroniza√ß√µes
        setTimeout(() => {
            setupRoomTitleChangeListener(roomId);
            
            if (typeof window.setupCompleteRoomSync === 'function') {
                window.setupCompleteRoomSync(roomId);
            }
        }, 62);

        // Disparar c√°lculo final
        if (roomId && typeof calculateVazaoArAndThermalGains === 'function') {
            setTimeout(() => {
                calculateVazaoArAndThermalGains(roomId);
            }, 37);
        }

    }, 200);
}
function ensureTableSectionExists(roomElement) {
    const roomId = roomElement.dataset.roomId;
    if (!roomId) return false;
    
    // Verificar se a tabela j√° existe
    const existingTable = roomElement.querySelector(`#subsection-content-${roomId}-clima-table`);
    if (existingTable) return true;
    
    // Se n√£o existir, criar
    console.log(`üìã Criando tabela de inputs para sala ${roomElement.dataset.roomName}`);
    
    // Encontrar onde inserir (logo ap√≥s o t√≠tulo da sala ou no in√≠cio do conte√∫do)
    const roomContent = roomElement.querySelector('.room-content');
    if (!roomContent) return false;
    
    const roomName = roomElement.dataset.roomName;
    
    // Verificar se buildTableSection est√° dispon√≠vel
    if (typeof window.buildTableSection === 'function') {
        const tableHTML = window.buildTableSection(roomId, roomName);
        
        // Inserir no in√≠cio do conte√∫do da sala
        const firstSection = roomContent.querySelector('.section-block');
        if (firstSection) {
            firstSection.insertAdjacentHTML('beforebegin', tableHTML);
        } else {
            roomContent.insertAdjacentHTML('afterbegin', tableHTML);
        }
        
        return true;
    }
    
    return false;
}
/**
 * Configura listener de t√≠tulo
 */
function setupRoomTitleChangeListener(roomId) {
    const roomTitle = document.querySelector(`[data-room-id="${roomId}"] .room-title`);
    const ambienteInput = document.querySelector(`input[data-field="ambiente"][data-room-id="${roomId}"]`);
    
    if (roomTitle && ambienteInput) {
        ambienteInput.addEventListener('input', function() {
            if (this.value && this.value.trim() !== '' && this.value !== roomTitle.textContent) {
                if (typeof window.syncAmbienteToTitle === 'function') {
                    window.syncAmbienteToTitle(roomId, this.value);
                } else {
                    roomTitle.textContent = this.value;
                    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
                    if (roomBlock) {
                        roomBlock.dataset.roomName = this.value;
                    }
                }
                triggerCalculation(roomId);
            }
        });
    }
}

/**
 * Preenche ganhos t√©rmicos
 */
function fillThermalGainsData(roomElement, thermalGainsData) {
    if (!roomElement || !thermalGainsData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;

    const gainSelectors = {
        'total-ganhos-w': `#total-ganhos-w-${roomId}`,
        'total-tr-aprox': `#total-tr-aprox-${roomId}`,
        'total-tr-exato': `#total-tr-exato-${roomId}`,
        'total-externo': `#total-externo-${roomId}`,
        'total-divisoes': `#total-divisoes-${roomId}`,
        'total-piso': `#total-piso-${roomId}`,
        'total-iluminacao': `#total-iluminacao-${roomId}`,
        'total-dissi': `#total-dissi-${roomId}`,
        'total-pessoas': `#total-pessoas-${roomId}`,
        'total-ar-sensivel': `#total-ar-sensivel-${roomId}`,
        'total-ar-latente': `#total-ar-latente-${roomId}`
    };

    Object.entries(gainSelectors).forEach(([key, selector]) => {
        const element = document.querySelector(selector);
        if (element && thermalGainsData[key] !== undefined) {
            if (key === 'total-tr-exato' && typeof thermalGainsData[key] === 'number') {
                element.textContent = thermalGainsData[key].toFixed(3);
            } else {
                element.textContent = thermalGainsData[key];
            }
        }
    });
}

//adicionar fill de ventila√ß√£o

/**
 * Preenche dados de capacidade
 */
function fillCapacityData(roomElement, capacityData) {
    if (!roomElement || !capacityData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;

    const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`);
    if (fatorSegurancaInput && capacityData.fatorSeguranca !== undefined) {
        fatorSegurancaInput.value = capacityData.fatorSeguranca;
    }

    const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`);
    if (capacidadeUnitariaSelect && capacityData.capacidadeUnitaria !== undefined) {
        capacidadeUnitariaSelect.value = capacityData.capacidadeUnitaria;
    }

    const backupSelect = roomElement.querySelector('.backup-select');
    if (backupSelect && capacityData.backup !== undefined) {
        backupSelect.value = capacityData.backup;
    }
}

/**
 * Garante todas as se√ß√µes da sala - VERS√ÉO SIMPLIFICADA E CORRETA
 */
async function ensureAllRoomSections(roomElement) {
    if (!roomElement) {
        console.error('‚ùå Elemento da sala inv√°lido');
        return false;
    }

    const obraId = roomElement.dataset.obraId;
    const projectId = roomElement.dataset.projectId; 
    const roomName = roomElement.dataset.roomName;
    const roomId = roomElement.dataset.roomId;

    if (!roomId) {
        console.error(`‚ùå Room ID inv√°lido`);
        return false;
    }

    console.log(`üî® Verificando se√ß√µes da sala ${roomName}`);

    // Fun√ß√£o simples para verificar se√ß√£o
    const checkSection = (title) => {
        const sections = roomElement.querySelectorAll('.section-title');
        for (let sectionTitle of sections) {
            if (sectionTitle.textContent.includes(title)) {
                return true;
            }
        }
        return false;
    };

    // Verificar se√ß√µes
    const climatizationExists = checkSection('Climatiza√ß√£o');
    const machinesExists = checkSection('M√°quinas');
    const acessoriosExists = checkSection('Acessorios');
    const dutosExists = checkSection('Dutos');
    const tubosExists = checkSection('Tubula√ß√£o');

    console.log(`üìã Se√ß√µes existentes:`, {
        climatization: climatizationExists,
        machines: machinesExists,
        acessorios: acessoriosExists,
        dutos: dutosExists,
        tubos: tubosExists
    });

    // Verificar se h√° duplica√ß√£o de tubos
    const tubosSections = roomElement.querySelectorAll('.section-title');
    let tubosCount = 0;
    tubosSections.forEach(title => {
        if (title.textContent.includes('Tubula√ß√£o de Cobre')) {
            tubosCount++;
        }
    });

    if (tubosCount > 1) {
        console.warn(`‚ö†Ô∏è DUPLICA√á√ÉO DETECTADA: ${tubosCount} se√ß√µes de Tubula√ß√£o`);
        fixDuplicatedSections(roomElement, 'Tubula√ß√£o de Cobre');
        return true; // J√° corrigiu, n√£o precisa criar
    }

    // Se todas existem, retornar true
    if (climatizationExists && machinesExists && acessoriosExists && dutosExists && tubosExists) {
        console.log(`‚úÖ Todas as se√ß√µes j√° existem`);
        return true;
    }

    console.log(`üîÑ Criando se√ß√µes faltantes`);

    try {
        const roomContent = roomElement.querySelector('.room-content');
        if (!roomContent) {
            console.error(`‚ùå Container de conte√∫do da sala n√£o encontrado`);
            return false;
        }

        // Obter √∫ltima se√ß√£o
        let lastSection = roomContent.querySelector('.section-block:last-child');
        
        // Criar apenas o que falta, na ORDEM CORRETA
        const sectionsToCreate = [];
        
        if (!climatizationExists) sectionsToCreate.push({type: 'climatization', func: window.buildClimatizationSection});
        if (!machinesExists) sectionsToCreate.push({type: 'machines', func: window.buildMachinesSection});
        if (!acessoriosExists) sectionsToCreate.push({type: 'acessorios', func: window.buildAcessoriosSection});
        if (!dutosExists) sectionsToCreate.push({type: 'dutos', func: window.buildDutosSection});
        if (!tubosExists) sectionsToCreate.push({type: 'tubos', func: window.buildTubosSection});

        console.log(`üèóÔ∏è Criando ${sectionsToCreate.length} se√ß√µes`);

        // Criar se√ß√µes na ordem correta
        for (let i = 0; i < sectionsToCreate.length; i++) {
            const section = sectionsToCreate[i];
            if (typeof section.func === 'function') {
                console.log(`üì¶ Criando se√ß√£o: ${section.type}`);
                
                const html = await section.func(obraId, projectId, roomName, roomId);
                if (html) {
                    if (lastSection) {
                        lastSection.insertAdjacentHTML('afterend', html);
                    } else {
                        roomContent.insertAdjacentHTML('beforeend', html);
                    }
                    
                    lastSection = roomContent.querySelector('.section-block:last-child');
                    await new Promise(resolve => setTimeout(resolve, 18));
                }
            }
        }

        console.log(`‚úÖ Se√ß√µes criadas para ${roomName}`);
        return true;

    } catch (error) {
        console.error(`‚ùå Erro ao criar se√ß√µes:`, error);
        return false;
    }
}

/**
 * Corrige se√ß√µes duplicadas
 */
function fixDuplicatedSections(roomElement, sectionTitle) {
    const roomContent = roomElement.querySelector('.room-content');
    if (!roomContent) return;
    
    const allSections = roomContent.querySelectorAll('.section-block');
    const targetSections = [];
    
    // Encontrar todas as se√ß√µes com o t√≠tulo especificado
    allSections.forEach(section => {
        const titleElement = section.querySelector('.section-title');
        if (titleElement && titleElement.textContent.includes(sectionTitle)) {
            targetSections.push(section);
        }
    });
    
    // Se tem mais de uma, remover as extras
    if (targetSections.length > 1) {
        console.log(`üóëÔ∏è Removendo ${targetSections.length - 1} se√ß√µes duplicadas de "${sectionTitle}"`);
        
        // Manter a primeira, remover as outras
        for (let i = 1; i < targetSections.length; i++) {
            targetSections[i].remove();
        }
        
        console.log(`‚úÖ Duplica√ß√£o corrigida`);
    }
}

/**
 * Fun√ß√£o auxiliar para encontrar se√ß√£o
 */
function findSectionByTitle(roomElement, title) {
    const sections = roomElement.querySelectorAll('.section-block');
    for (let section of sections) {
        const sectionTitle = section.querySelector('.section-title');
        if (sectionTitle && sectionTitle.textContent.includes(title)) {
            return section;
        }
    }
    return null;
}

/**
 * Fun√ß√£o auxiliar para encontrar se√ß√£o de m√°quinas
 */
function findMachinesSection(roomElement) {
    return roomElement.querySelector('.machines-section') || 
           roomElement.querySelector('[id*="machines"]');
}

// Exporta√ß√µes
export {
    fillClimatizationInputs,
    fillThermalGainsData,
    fillCapacityData,
    ensureAllRoomSections,
    setupRoomTitleChangeListener,
    fixDuplicatedSections,
    findSectionByTitle,
    findMachinesSection,
    ensureTableSectionExists 
};

// Compatibilidade global
if (typeof window !== 'undefined') {
    window.setupRoomTitleChangeListener = setupRoomTitleChangeListener;
    window.fixDuplicatedSections = fixDuplicatedSections;
    window.ensureTableSectionExists  = ensureTableSectionExists ;
}
/* ==== FIM: data/builders/ui-folder/data-fillers.js ==== */

/* ==== IN√çCIO: data/builders/data-builders-folder/room-data-extractors.js ==== */
/*
* ARQUIVO DE EXTRA√á√ÉO DE DADOS DE salas
*/

import { generateRoomId } from '../../utils/id-generator.js';
import { extractNumberFromText } from '../../utils/data-utils.js';
import { extractMachinesData } from './machines-data-extractors.js';

/**
 * Extrai todos os dados de uma sala a partir do elemento HTML
 */
function extractRoomData(roomElement, projectElement) {
    if (!roomElement || !document.body.contains(roomElement)) {
        console.error('‚ùå Elemento da sala inv√°lido ou removido do DOM');
        return null;
    }

    // ‚úÖ CORRE√á√ÉO: Sincronizar t√≠tulo da sala
    const roomTitleElement = roomElement.querySelector('.room-title');
    if (roomTitleElement) {
        const currentTitle = roomTitleElement.textContent?.trim();
        const dataName = roomElement.dataset.roomName;
        
        if (currentTitle && currentTitle !== dataName) {
            console.log(`üîÑ Sincronizando sala: data-room-name "${dataName}" ‚Üí "${currentTitle}"`);
            roomElement.dataset.roomName = currentTitle;
        }
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName; // ‚úÖ AGORA sincronizado

    if (!roomId || !roomName) {
        console.error('‚ùå Sala sem ID ou nome v√°lido:', { roomId, roomName });
        return null;
    }

    console.log(`üîç Extraindo dados da sala: "${roomName}" (ID: ${roomId})`);

    const roomData = {
        id: roomId,
        nome: roomName,
        inputs: extractClimatizationInputs(roomElement),
        maquinas: extractMachinesData(roomElement),
        capacidade: extractCapacityData(roomElement),
        //adicionar a ventilacao
        ganhosTermicos: extractThermalGainsData(roomElement),
        acessorios: extractAcessoriosData(roomElement),
        dutos: extractDutosData(roomElement), // ‚úÖ ADICIONADO: Extra√ß√£o de dutos
        tubulacao: extractTubulacaoData(roomElement)
    };

    console.log(`üìä Dados extra√≠dos da sala ${roomId}:`, {
        inputs: Object.keys(roomData.inputs).length,
        maquinas: roomData.maquinas.length,
        capacidade: Object.keys(roomData.capacidade).length,
        ganhosTermicos: Object.keys(roomData.ganhosTermicos).length,
        acessorios: roomData.acessorios.length,
        dutos: roomData.dutos.length, // ‚úÖ ADICIONADO: Contagem de dutos
        conjuntosTubulacao: roomData.tubulacao.conjuntos?.length || 0
    });
    
    return roomData;
}

/**
 * Extrai inputs de climatiza√ß√£o de uma sala
 */
function extractClimatizationInputs(roomElement) {
    const inputs = {};
    
    if (!roomElement?.dataset.roomId) {
        console.error('‚ùå Elemento da sala inv√°lido para extra√ß√£o de inputs');
        return inputs;
    }
    
    // Extrair inputs de texto/number
    const textInputs = roomElement.querySelectorAll('.clima-input[type="text"], .clima-input[type="number"], .clima-input[data-field]');
    textInputs.forEach(input => {
        const field = input.getAttribute('data-field');
        if (!field) return;
        
        let value = input.value;
        if (input.type === 'number' && value !== '') {
            value = parseFloat(value) || 0;
        }
        
        if (value !== undefined && value !== '' && value !== null) {
            inputs[field] = value;
        }
    });

    // Extrair pressuriza√ß√£o (radio buttons)
    const pressurizacaoRadios = roomElement.querySelectorAll('input[name*="pressurizacao"][type="radio"]');
    let pressurizacaoValue = false;
    
    pressurizacaoRadios.forEach(radio => {
        if (radio.checked) pressurizacaoValue = radio.value === 'sim';
    });
    
    inputs.pressurizacao = pressurizacaoValue;
    
    // Campos espec√≠ficos da pressuriza√ß√£o
    if (pressurizacaoValue) {
        const pressurizacaoInput = roomElement.querySelector('.clima-input[data-field="pressurizacaoSetpoint"]');
        const portasDuplasInput = roomElement.querySelector('.clima-input[data-field="numPortasDuplas"]');
        const portasSimplesInput = roomElement.querySelector('.clima-input[data-field="numPortasSimples"]');
        
        if (pressurizacaoInput) inputs.pressurizacaoSetpoint = parseFloat(pressurizacaoInput.value) || 25;
        if (portasDuplasInput) inputs.numPortasDuplas = parseFloat(portasDuplasInput.value) || 0;
        if (portasSimplesInput) inputs.numPortasSimples = parseFloat(portasSimplesInput.value) || 0;
    } else {
        inputs.pressurizacaoSetpoint = 0;
        inputs.numPortasDuplas = 0;
        inputs.numPortasSimples = 0;
    }

    // Extrair selects
    const selectInputs = roomElement.querySelectorAll('select.clima-input[data-field]');
    selectInputs.forEach(select => {
        const field = select.getAttribute('data-field');
        if (!field || inputs[field] !== undefined) return;
        
        const value = select.value;
        if (value !== undefined && value !== '' && value !== null) {
            inputs[field] = value;
        }
    });

    console.log(`üìù Inputs de climatiza√ß√£o coletados: ${Object.keys(inputs).length}`);
    return inputs;
}

/**
 * Extrai dados de ganhos t√©rmicos de uma sala
 */
function extractThermalGainsData(roomElement) {
    const gains = {};
    const roomId = roomElement.dataset.roomId;
    
    if (!roomId) {
        console.error('‚ùå ID da sala inv√°lido para extra√ß√£o de ganhos t√©rmicos');
        return gains;
    }
    
    const totalSelectors = {
        'total-ganhos-w': `#total-ganhos-w-${roomId}`,
        'total-tr-aprox': `#total-tr-aprox-${roomId}`,
        'total-tr-exato': `#total-tr-exato-${roomId}`,
        'total-externo': `#total-externo-${roomId}`,
        'total-divisoes': `#total-divisoes-${roomId}`,
        'total-piso': `#total-piso-${roomId}`,
        'total-iluminacao': `#total-iluminacao-${roomId}`,
        'total-dissi': `#total-dissi-${roomId}`,
        'total-pessoas': `#total-pessoas-${roomId}`,
        'total-ar-sensivel': `#total-ar-sensivel-${roomId}`,
        'total-ar-latente': `#total-ar-latente-${roomId}`
    };
    
    Object.entries(totalSelectors).forEach(([key, selector]) => {
        try {
            const element = document.querySelector(selector);
            if (element) {
                let value = element.textContent || '';
                if (value && value.trim() !== '') {
                    value = value.replace(/<[^>]*>/g, '').trim();
                    const numericMatch = value.match(/-?\d+(?:[.,]\d+)?/);
                    
                    if (numericMatch) {
                        const numericValue = parseFloat(numericMatch[0].replace(',', '.'));
                        gains[key] = isNaN(numericValue) ? 0 : numericValue;
                    } else {
                        gains[key] = 0;
                    }
                } else {
                    gains[key] = 0;
                }
            } else {
                gains[key] = 0;
            }
        } catch (error) {
            console.error(`üí• Erro ao processar ${selector}:`, error);
            gains[key] = 0;
        }
    });
    
    console.log(`üî• ${Object.keys(gains).length} ganhos t√©rmicos coletados`);
    return gains;
}

/**
 * Extrai dados de capacidade de refrigera√ß√£o de uma sala
 */
function extractCapacityData(roomElement) {
    const capacityData = {};
    const roomId = roomElement.dataset.roomId;

    if (!roomId) {
        console.error('‚ùå ID da sala inv√°lido para extra√ß√£o de capacidade');
        return capacityData;
    }

    try {
        const specificSelectors = {
            fatorSeguranca: `#fator-seguranca-${roomId}`,
            capacidadeUnitaria: `#capacidade-unitaria-${roomId}`,
            solucao: `#solucao-${roomId}`,
            solucaoBackup: `#solucao-backup-${roomId}`,
            totalCapacidade: `#total-capacidade-${roomId}`,
            folga: `#folga-${roomId}`
        };

        Object.entries(specificSelectors).forEach(([key, selector]) => {
            const element = roomElement.querySelector(selector);
            if (element) {
                let value = element.textContent || element.value;
                if (key === 'folga' && typeof value === 'string') {
                    value = value.replace('%', '');
                }
                
                if (value && !isNaN(value.replace(',', '.'))) {
                    value = parseFloat(value.replace(',', '.'));
                }
                
                capacityData[key] = value;
            }
        });

        const backupSelect = roomElement.querySelector('.backup-select');
        if (backupSelect) {
            capacityData.backup = backupSelect.value;
        }

        console.log(`‚ùÑÔ∏è Dados de capacidade coletados: ${Object.keys(capacityData).length}`);
        return capacityData;

    } catch (error) {
        console.error(`‚ùå Erro ao extrair dados de capacidade da sala ${roomId}:`, error);
        return capacityData;
    }
}

/**
 * Extrai dados dos acessorios de uma sala
 */
function extractAcessoriosData(roomElement) {
    const acessorios = [];
    
    if (!roomElement?.dataset.roomId) {
        console.error('‚ùå Elemento da sala inv√°lido para extra√ß√£o de acessorios');
        return acessorios;
    }
    
    const roomId = roomElement.dataset.roomId;
    
    // Buscar todos os acessorios na tabela
    const tbody = document.getElementById(`acessorios-list-${roomId}`);
    if (!tbody) {
        console.log(`‚ÑπÔ∏è Nenhum acessorio encontrado para sala ${roomId}`);
        return acessorios;
    }
    
    // Buscar todas as linhas de acessorios (exceto linha vazia)
    const acessorioRows = tbody.querySelectorAll('.acessorio-row');
    
    acessorioRows.forEach(row => {
        try {
            const acessorioData = JSON.parse(row.getAttribute('data-acessorio'));
            acessorios.push(acessorioData);
        } catch (error) {
            console.error('‚ùå Erro ao extrair dados do acessorio:', error);
        }
    });
    
    console.log(`üîß ${acessorios.length} acessorio(s) extra√≠do(s) da sala ${roomId}`);
    return acessorios;
}

/**
 * Extrai dados dos dutos de uma sala
 */
function extractDutosData(roomElement) {
    const dutos = [];
    
    if (!roomElement?.dataset.roomId) {
        console.error('‚ùå Elemento da sala inv√°lido para extra√ß√£o de dutos');
        return dutos;
    }
    
    const roomId = roomElement.dataset.roomId;
    
    // Buscar todos os dutos na tabela
    const tbody = document.getElementById(`dutos-list-${roomId}`);
    if (!tbody) {
        console.log(`‚ÑπÔ∏è Nenhum duto encontrado para sala ${roomId}`);
        return dutos;
    }
    
    // Buscar todas as linhas de dutos (exceto linha vazia)
    const dutoRows = tbody.querySelectorAll('.duto-row');
    
    dutoRows.forEach(row => {
        try {
            const dutoData = JSON.parse(row.getAttribute('data-duto'));
            dutos.push(dutoData);
        } catch (error) {
            console.error('‚ùå Erro ao extrair dados do duto:', error);
        }
    });
    
    console.log(`üìè ${dutos.length} duto(s) extra√≠do(s) da sala ${roomId}`);
    return dutos;
}

function extractTubulacaoData(roomElement) {
    const resultado = {
        conjuntos: [],
        valorTotalGeralTubos: 0
    };
    
    if (!roomElement?.dataset.roomId) {
        console.error('‚ùå Elemento da sala inv√°lido para extra√ß√£o de tubula√ß√£o');
        return resultado;
    }
    
    const roomId = roomElement.dataset.roomId;
    console.log(`üîç Extraindo dados de tubula√ß√£o para sala ${roomId}`);
    
    // Buscar todos os conjuntos de tubula√ß√£o na sala
    const conjuntos = roomElement.querySelectorAll(`[data-conjunto-id^="${roomId}-"]`);
    
    if (conjuntos.length === 0) {
        console.log(`‚ÑπÔ∏è Nenhum conjunto de tubula√ß√£o encontrado para sala ${roomId}`);
        return resultado;
    }
    
    console.log(`üìã Encontrados ${conjuntos.length} conjunto(s) de tubula√ß√£o na sala ${roomId}`);
    
    conjuntos.forEach((conjuntoElement, index) => {
        const conjuntoId = conjuntoElement.getAttribute('data-conjunto-id');
        const conjuntoNum = conjuntoElement.getAttribute('data-conjunto-num') || (index + 1).toString();
        
        // Obter quantidade do conjunto
        const quantidadeInput = document.getElementById(`tubulacao-quantidade-${conjuntoId}`);
        const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) || 1 : 1;
        
        // Buscar totais do conjunto
        const totalLSmetros = document.getElementById(`total-ls-metros-${conjuntoId}`);
        const totalLSkg = document.getElementById(`total-ls-kg-${conjuntoId}`);
        const totalLLmetros = document.getElementById(`total-ll-metros-${conjuntoId}`);
        const totalLLkg = document.getElementById(`total-ll-kg-${conjuntoId}`);
        const totalCabos = document.getElementById(`total-cabos-${conjuntoId}`);
        const totalLuvas = document.getElementById(`total-luvas-${conjuntoId}`);
        const totalReducoes = document.getElementById(`total-reducoes-${conjuntoId}`);
        const totalGeralKg = document.getElementById(`total-geral-kg-${conjuntoId}`);
        const totalValor = document.getElementById(`total-valor-${conjuntoId}`);
        
        // Extrair valores num√©ricos dos totais
        const extrairNumero = (element) => {
            if (!element) return 0;
            const text = element.textContent || '0';
            return parseFloat(text.replace(',', '.')) || 0;
        };
        
        // Extrair valor monet√°rio
        const extrairValor = (element) => {
            if (!element) return 0;
            const text = element.textContent || 'R$ 0,00';
            const valor = parseFloat(text.replace('R$', '').replace(',', '.').trim());
            return isNaN(valor) ? 0 : valor;
        };
        
        const conjuntoData = {
            id: conjuntoId,
            numero: parseInt(conjuntoNum),
            quantidade: quantidade,
            cabos: Math.round(extrairNumero(totalCabos)),
            luvas: extrairNumero(totalLuvas),
            reducoes: Math.round(extrairNumero(totalReducoes)),
            totalLSmetros: extrairNumero(totalLSmetros),
            totalLSkg: extrairNumero(totalLSkg),
            totalLLmetros: extrairNumero(totalLLmetros),
            totalLLkg: extrairNumero(totalLLkg),
            totalKG: extrairNumero(totalGeralKg),
            valorTotal: extrairValor(totalValor),
            linhas: []
        };
        
        // Adicionar ao valor total geral
        resultado.valorTotal += conjuntoData.valorTotal;
        
        // Buscar todas as linhas deste conjunto
        const tbody = document.getElementById(`tubos-list-${conjuntoId}`);
        if (tbody) {
            const linhas = tbody.querySelectorAll('.linha-tubulacao');
            
            linhas.forEach(row => {
                try {
                    const linhaData = JSON.parse(row.getAttribute('data-linha'));
                    
                    // Mapear para o formato desejado
                    const linhaFormatada = {
                        id: linhaData.id,
                        tipo: linhaData.tipo,
                        pol: linhaData.polegadas || '',
                        expe: linhaData.espessura || '',
                        compr: parseFloat(linhaData.comprimentoInterligacao || 0),
                        numC: parseInt(linhaData.numCircuitos || 0),
                        numCu: parseInt(linhaData.numCurvas || 0),
                        Cee: parseFloat(linhaData.comprimentoEquivalenteCurva || 0),
                        Lsm: parseFloat(linhaData.LSmetros || linhaData.LLmetros || 0),
                        LSkg: parseFloat(linhaData.LSkg || linhaData.LLkg || 0),
                        valorTotal: parseFloat(linhaData.valorTotal || 0)
                    };
                    
                    conjuntoData.linhas.push(linhaFormatada);
                } catch (error) {
                    console.error('‚ùå Erro ao extrair dados da linha:', error);
                }
            });
        }
        
        resultado.conjuntos.push(conjuntoData);
    });
    
    console.log(`‚úÖ ${resultado.conjuntos.length} conjunto(s) de tubula√ß√£o extra√≠do(s) da sala ${roomId}`);
    console.log(`üí∞ Valor total da tubula√ß√£o: R$ ${resultado.valorTotal.toFixed(2)}`);
    return resultado;
}

// Exporte todas as fun√ß√µes
export {
    extractRoomData,
    extractClimatizationInputs,
    extractThermalGainsData,
    extractCapacityData,
    extractAcessoriosData,
    extractDutosData, 
    extractTubulacaoData
};
/* ==== FIM: data/builders/data-builders-folder/room-data-extractors.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/room-renderer.js ==== */
/*
* ARQUIVO DE RENDERIZA√á√ÉO DE salas
*/

import { ensureStringId } from '../../utils/id-generator.js';
import { ensureTableSectionExists } from './data-fillers.js';

/**
 * Renderiza uma sala individual a partir dos dados carregados
 */
function renderRoomFromData(projectId, projectName, roomData, obraId = null, obraName = null) {
    const roomName = roomData.nome;
    const roomId = ensureStringId(roomData.id);

    console.log(`üéØ Renderizando sala: ${roomName} no projeto ${projectName}`, {
        obra: obraName,
        projectId: projectId,
        roomId: roomId,
        inputs: Object.keys(roomData.inputs || {}).length,
        maquinas: roomData.maquinas?.length || 0,
        capacidade: Object.keys(roomData.capacidade || {}).length,
        ganhosTermicos: Object.keys(roomData.ganhosTermicos || {}).length,
        acessorios: roomData.acessorios?.length || 0,
        dutos: roomData.dutos?.length || 0, // ‚úÖ ADICIONADO: dutos
        conjuntosTubulacao: roomData.tubulacao?.conjuntos?.length || 0
    });

    setTimeout(() => {
        // Criar sala b√°sica
        createEmptyRoom(obraId, projectId, roomName, roomId);
        
        // Aguardar cria√ß√£o e garantir todas as se√ß√µes
        setTimeout(() => {
            const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
            if (roomElement) {
                // ‚úÖ GARANTIR que TODAS as se√ß√µes sejam criadas (incluindo dutos)
                ensureAllRoomSections(roomElement).then(sectionsReady => {
                    if (sectionsReady) {
                        console.log(`‚úÖ Todas as se√ß√µes criadas para ${roomName} - Iniciando preenchimento`);
                        populateRoomData(roomElement, roomData);
                    } else {
                        console.error(`‚ùå Falha ao criar se√ß√µes para ${roomName}`);
                    }
                }).catch(error => {
                    console.error(`‚ùå Erro ao garantir se√ß√µes para ${roomName}:`, error);
                    throw error;
                });
            } else {
                console.error(`‚ùå Elemento da sala ${roomId} n√£o encontrado ap√≥s cria√ß√£o`);
            }
        }, 150);
        
    }, 100);
}

/**
 * Preenche uma sala espec√≠fica dentro de um projeto
 */
async function populateRoomData(roomElement, roomData) {
    if (!roomElement || !roomData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return false;
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå Room ID inv√°lido no populateRoomData: "${roomId}"`);
        return false;
    }
    
    console.log(`üîÑ Preenchendo sala "${roomName}" (ID: ${roomId})`);

    try {
        const tableExists = ensureTableSectionExists(roomElement);
        if (!tableExists) {
            setTimeout(() => {
                console.warn(`‚ö†Ô∏è Tabela de inputs n√£o encontrada para ${roomName}, criando...`);
            }, 200);
        }

        const roomTitle = roomElement.querySelector('.room-title');
        if (roomTitle && roomData.nome) {
            roomTitle.textContent = roomData.nome;
            console.log(`‚úÖ T√≠tulo da sala atualizado: ${roomData.nome}`);
        }

        if (roomData.inputs) {
            console.log(`üå°Ô∏è Preenchendo inputs de climatiza√ß√£o para sala ${roomName}`);
            fillClimatizationInputs(roomElement, roomData.inputs);
        }

        if (roomData.ganhosTermicos) {
            console.log(`üìä Preenchendo ganhos t√©rmicos para sala ${roomName}`);
            fillThermalGainsData(roomElement, roomData.ganhosTermicos);
        }

        if (roomData.capacidade) {
            console.log(`‚ö° Preenchendo dados de capacidade para sala ${roomName}`);
            fillCapacityData(roomElement, roomData.capacidade);
        }
        //adicionar ventila√ß√£o
        // ‚úÖ Preencher acessorios
        if (roomData.acessorios && Array.isArray(roomData.acessorios)) {
            console.log(`üîß Preenchendo ${roomData.acessorios.length} acessorio(s) para sala ${roomName}`);
            
            // Aguardar um pouco para garantir que a se√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillAcessoriosData === 'function') {
                    window.fillAcessoriosData(roomElement, roomData.acessorios);
                    console.log(`‚úÖ Acessorios preenchidos via fun√ß√£o global`);
                } else {
                    console.error(`‚ùå Fun√ß√£o fillAcessoriosData n√£o dispon√≠vel no window`);
                }
            }, 400);
        }

        // ‚úÖ Preencher dutos
        if (roomData.dutos && Array.isArray(roomData.dutos)) {
            console.log(`üìè Preenchendo ${roomData.dutos.length} duto(s) para sala ${roomName}`);
            
            // Aguardar um pouco para garantir que a se√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillDutosData === 'function') {
                    window.fillDutosData(roomElement, roomData.dutos);
                    console.log(`‚úÖ Dutos preenchidos via fun√ß√£o global`);
                } else {
                    console.error(`‚ùå Fun√ß√£o fillDutosData n√£o dispon√≠vel no window`);
                }
            }, 500);
        }

        // ‚úÖ CORRE√á√ÉO CR√çTICA: Preencher tubula√ß√£o - CUIDADO COM A ESTRUTURA
        if (roomData.tubulacao && roomData.tubulacao.conjuntos && Array.isArray(roomData.tubulacao.conjuntos)) {
            console.log(`üîß Preenchendo ${roomData.tubulacao.conjuntos.length} conjunto(s) de tubula√ß√£o para sala ${roomName}`);
            
            // Aguardar mais tempo para garantir que a se√ß√£o de tubula√ß√£o foi criada
            setTimeout(() => {
                if (typeof window.fillTubulacaoData === 'function') {
                    // ‚úÖ CORRE√á√ÉO: Passar o objeto completo de tubula√ß√£o
                    window.fillTubulacaoData(roomElement, roomData.tubulacao);
                    console.log(`‚úÖ Tubula√ß√£o preenchida via fun√ß√£o global`, {
                        conjuntos: roomData.tubulacao.conjuntos.length,
                        estrutura: 'conjuntos array dentro de objeto tubulacao'
                    });
                } else {
                    console.error(`‚ùå Fun√ß√£o fillTubulacaoData n√£o dispon√≠vel no window - Verifique se tubos.js foi carregado`);
                }
            }, 750);
        } else if (roomData.tubulacao) {
            console.warn(`‚ö†Ô∏è Estrutura de tubula√ß√£o inv√°lida ou vazia para sala ${roomName}:`, roomData.tubulacao);
        }

        // ‚úÖ Preencher m√°quinas
        if (roomData.maquinas && Array.isArray(roomData.maquinas)) {
            console.log(`ü§ñ Agendando preenchimento de ${roomData.maquinas.length} m√°quina(s) para sala ${roomName}`);
            
            // Aguardar mais tempo para garantir que todas as outras se√ß√µes foram preenchidas
            setTimeout(async () => {
                try {
                    console.log(`üöÄ Iniciando preenchimento de m√°quinas para sala ${roomName}`);
                    
                    const success = await fillMachinesData(roomElement, roomData.maquinas);
                    
                    if (success) {
                        console.log(`üéâ Todas as m√°quinas preenchidas com sucesso para sala ${roomName}`);
                    } else {
                        console.error(`‚ùå Falha ao preencher m√°quinas para sala ${roomName}`);
                    }
                } catch (error) {
                    console.error(`üí• Erro ao preencher m√°quinas para sala ${roomName}:`, error);
                }
            }, 800);
        }

        console.log(`‚úÖ Sala "${roomName}" preenchida com sucesso`);
        return true;

    } catch (error) {
        console.error(`‚ùå Erro ao preencher sala "${roomName}":`, error);
        return false;
    }
}

/**
 * Preenche os inputs de uma sala espec√≠fica
 */
function populateRoomInputs(projectId, projectName, roomId, roomName, roomData, obraId, obraName) {
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (roomElement) {
        populateRoomData(roomElement, roomData);
    } else {
        console.error(`‚ùå Elemento da sala ${roomId} n√£o encontrado no DOM`);
    }
}

// EXPORTS NO FINAL
export {
    renderRoomFromData,
    populateRoomData,
    populateRoomInputs
};
/* ==== FIM: data/builders/ui-folder/room-renderer.js ==== */

/* ==== IN√çCIO: data/modules/ventilacao.js ==== */
/**
 * M√ìDULO DE VENTILA√á√ÉO - INTEGRA√á√ÉO COM SISTEMA DE M√ÅQUINAS EXISTENTE
 * @module data/modules/ventilacao.js
 * 
 * CORRIGIDO: Agora recalcula a solu√ß√£o sempre que os par√¢metros mudam,
 * mas respeita as edi√ß√µes manuais do usu√°rio
 */

// =============================================================================
// CONSTANTES E CONFIGURA√á√ïES
// =============================================================================

// Mapeamento aplica√ß√£o ‚Üí texto leg√≠vel
const APPLICATION_TEXT_MAP = {
    'pressurizacao': 'Pressuriza√ß√£o',
    'exaustao_bateria': 'Exaust√£o da Sala de Bateria',
    'exaustao_baia_trafo': 'Exaust√£o da Baia de Trafo'
};

// Aplica√ß√µes v√°lidas que disparam c√°lculos
const VALID_APPLICATIONS = ['pressurizacao', 'exaustao_bateria', 'exaustao_baia_trafo'];

// Fatores de convers√£o
const FATOR_CONVERSAO_W_CAL = 859.85;
const FATOR_PRESSURIZACAO = 3.6;

// Store para controle por sala
const ventilationState = new Map();


// =============================================================================
// CONTROLE DE CARREGAMENTO - EVITA REC√ÅLCULOS DURANTE PREENCHIMENTO
// =============================================================================

// Flag global para indicar que est√° em processo de carregamento
window._isLoadingData = false;

// Contador para rastrear quantas salas est√£o sendo carregadas
window._loadingRooms = new Set();

/**
 * Inicia o modo de carregamento para uma sala espec√≠fica
 * @param {string} roomId - ID da sala
 */
export function startRoomLoading(roomId) {
    if (!window._loadingRooms) window._loadingRooms = new Set();
    window._loadingRooms.add(roomId);
    window._isLoadingData = true;
    console.log(`üîÑ [MODO CARREGAMENTO] Ativado para sala ${roomId}`);
}

/**
 * Finaliza o modo de carregamento para uma sala espec√≠fica
 * @param {string} roomId - ID da sala
 * @param {boolean} triggerRefresh - Se deve disparar refresh ap√≥s finalizar
 */
export function finishRoomLoading(roomId, triggerRefresh = true) {
    if (!window._loadingRooms) return;
    
    window._loadingRooms.delete(roomId);
    
    // Se n√£o h√° mais salas carregando, desativa o flag global
    if (window._loadingRooms.size === 0) {
        window._isLoadingData = false;
        console.log('üîÑ [MODO CARREGAMENTO] Finalizado - todas as salas carregadas');
    }
    
    // Dispara refresh se solicitado
    if (triggerRefresh && window.refreshVentilationForRoom) {
        setTimeout(() => {
            window.refreshVentilationForRoom(roomId);
        }, 12);
    }
}

/**
 * Verifica se est√° em modo de carregamento para uma sala
 * @param {string} roomId - ID da sala
 * @returns {boolean}
 */
export function isLoadingForRoom(roomId) {
    return window._isLoadingData === true || 
           (window._loadingRooms && window._loadingRooms.has(roomId));
}

// =============================================================================
// FUN√á√ïES UTILIT√ÅRIAS
// =============================================================================

/**
 * OBT√âM CONSTANTES DO SISTEMA
 */
function getSystemConstants() {
    if (!window.systemConstants) {
        throw new Error('window.systemConstants n√£o dispon√≠vel');
    }

    const Densi_ar = window.systemConstants.Densi_ar?.value;
    const fatorEspecifico = window.systemConstants.fatorEspecifico?.value;

    if (!Densi_ar || typeof Densi_ar !== 'number') {
        throw new Error('Constante Densi_ar n√£o encontrada');
    }
    if (!fatorEspecifico || typeof fatorEspecifico !== 'number') {
        throw new Error('Constante fatorEspecifico n√£o encontrada');
    }

    return { Densi_ar, fatorEspecifico };
}

/**
 * EXTRAI VALOR NUM√âRICO DO SELECT DE CAPACIDADE
 */
export function extractCapacidadeValue(capacidadeValue) {
    if (!capacidadeValue) return null;
    const match = capacidadeValue.match(/^(\d+(?:\.\d+)?)/);
    return match ? parseFloat(match[1]) : null;
}

/**
 * FORMATA N√öMERO PARA EXIBI√á√ÉO
 */
function formatNumber(value, decimals = 2) {
    if (value === null || value === undefined || isNaN(value)) return '-';
    const formatted = value.toFixed(decimals).replace('.', ',');
    const parts = formatted.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return parts.join(',');
}

/**
 * COLETA INPUTS T√âCNICOS DA SALA
 */
function collectRoomInputs(roomId) {
    console.log(`üìä [collectRoomInputs] Coletando inputs para sala ${roomId}`);
    
    const inputs = {};
    
    // Busca pelos elementos espec√≠ficos
    const vazaoArElement = document.getElementById(`vazao-ar-${roomId}`);
    const volumeElement = document.getElementById(`volume-${roomId}`);
    const potenciaElement = document.getElementById(`potencia-${roomId}`);
    const tempInternaElement = document.getElementById(`temp-interna-${roomId}`);
    const tempExternaElement = document.getElementById(`temp-externa-${roomId}`);
    
    // Para vazaoAr, pode ser um div com textContent ou um input
    if (vazaoArElement) {
        if (vazaoArElement.tagName === 'DIV' || vazaoArElement.classList.contains('result-value-inline')) {
            inputs.vazaoAr = parseFloat(vazaoArElement.textContent);
        } else if (vazaoArElement.tagName === 'INPUT') {
            inputs.vazaoAr = parseFloat(vazaoArElement.value);
        }
    } else {
        inputs.vazaoAr = null;
    }
    
    inputs.volume = volumeElement ? parseFloat(volumeElement.value) : null;
    inputs.potencia = potenciaElement ? parseFloat(potenciaElement.value) : null;
    inputs.tempInterna = tempInternaElement ? parseFloat(tempInternaElement.value) : 45;
    inputs.tempExterna = tempExternaElement ? parseFloat(tempExternaElement.value) : 35;
    
    return inputs;
}

// =============================================================================
// FUN√á√ïES DE C√ÅLCULO
// =============================================================================

/**
 * CALCULA VAZ√ÉO POR APLICA√á√ÉO
 */
function calculateVazaoByAplicacao(aplicacao, roomId, inputs) {
    switch (aplicacao) {
        case 'pressurizacao': {
            if (!inputs.vazaoAr || isNaN(inputs.vazaoAr)) {
                return null;
            }
            return inputs.vazaoAr * FATOR_PRESSURIZACAO;
        }
        
        case 'exaustao_bateria': {
            if (!inputs.volume || isNaN(inputs.volume)) {
                return null;
            }
            return inputs.volume * 12;
        }
        
        case 'exaustao_baia_trafo': {
            if (!inputs.potencia || isNaN(inputs.potencia)) {
                return null;
            }
            
            const deltaT = inputs.tempInterna - inputs.tempExterna;
            const deltaTAbs = Math.abs(deltaT);
            
            if (deltaTAbs === 0) {
                return null;
            }
            
            const constants = getSystemConstants();
            const Q = inputs.potencia * FATOR_CONVERSAO_W_CAL;
            const massaGR = Q / (constants.fatorEspecifico * deltaTAbs);
            const massaAr = massaGR / 1000;
            const vazao = massaAr / constants.Densi_ar;
            
            return deltaT < 0 ? -vazao : vazao;
        }
        
        default:
            return null;
    }
}

// =============================================================================
// ATUALIZA√á√ÉO DAS TABELAS
// =============================================================================

/**
 * ATUALIZA TABELA 1 - C√°lculo T√©cnico
 */
function updateTechnicalTable(roomId, inputs) {
    const elements = {
        q: document.getElementById(`q-cal-${roomId}`),
        deltaT: document.getElementById(`delta-t-${roomId}`),
        massaGrama: document.getElementById(`massa-gramas-${roomId}`),
        massa: document.getElementById(`massa-ar-${roomId}`),
        vazao: document.getElementById(`vazao-${roomId}`)
    };
    
    // Se n√£o tem pot√™ncia, limpa resultados
    if (!inputs.potencia || isNaN(inputs.potencia)) {
        Object.values(elements).forEach(el => {
            if (el) {
                el.textContent = '-';
                el.classList.remove('negative');
            }
        });
        return;
    }
    
    const deltaT = inputs.tempInterna - inputs.tempExterna;
    const isDeltaTNegative = deltaT < 0;
    const deltaTAbs = Math.abs(deltaT);
    
    try {
        const constants = getSystemConstants();
        const Q = inputs.potencia * FATOR_CONVERSAO_W_CAL;
        
        let massaGR, massaAr, vazao;
        
        if (deltaTAbs > 0) {
            massaGR = Q / (constants.fatorEspecifico * deltaTAbs);
            massaAr = massaGR / 1000;
            vazao = massaAr / constants.Densi_ar;
            
            if (isDeltaTNegative) {
                massaGR = -massaGR;
                massaAr = -massaAr;
                vazao = -vazao;
            }
        } else {
            massaGR = 0;
            massaAr = 0;
            vazao = 0;
        }
        
        if (elements.q) {
            elements.q.textContent = formatNumber(Q);
            elements.q.classList.remove('negative');
        }
        
        if (elements.deltaT) {
            elements.deltaT.textContent = formatNumber(deltaT, 1);
            if (deltaT < 0) {
                elements.deltaT.classList.add('negative');
            } else {
                elements.deltaT.classList.remove('negative');
            }
        }
        
        if (elements.massaGrama) {
            elements.massaGrama.textContent = formatNumber(massaGR);
            if (massaGR < 0) {
                elements.massaGrama.classList.add('negative');
            } else {
                elements.massaGrama.classList.remove('negative');
            }
        }
        
        if (elements.massa) {
            elements.massa.textContent = formatNumber(massaAr);
            if (massaAr < 0) {
                elements.massa.classList.add('negative');
            } else {
                elements.massa.classList.remove('negative');
            }
        }
        
        if (elements.vazao) {
            elements.vazao.textContent = formatNumber(vazao);
            if (vazao < 0) {
                elements.vazao.classList.add('negative');
            } else {
                elements.vazao.classList.remove('negative');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao atualizar tabela t√©cnica:', error);
    }
}

/**
 * ATUALIZA TABELA 2 - Solu√ß√£o das M√°quinas
 */
function updateSolutionTable(roomId, inputs) {
    // üö´ BLOQUEIA SE ESTIVER CARREGANDO
    if (window.isLoadingForRoom && window.isLoadingForRoom(roomId)) {
        console.log(`‚è∏Ô∏è [updateSolutionTable] Bloqueado - sala ${roomId} em carregamento`);
        return;
    }
    
    const machinesContainer = document.getElementById(`machines-${roomId}`);
    if (!machinesContainer) {
        setTimeout(() => updateSolutionTable(roomId, inputs), 500);
        return;
    }
    
    
    const tableBody = document.getElementById(`solucao-body-${roomId}`);
    if (!tableBody) return;
    
    const machines = machinesContainer.querySelectorAll('.climatization-machine');
    
    // Limpa tabela
    tableBody.innerHTML = '';
    
    let hasVentilationMachines = false;
    
    // Calcula a vaz√£o necess√°ria para a sala
    let vazaoNecessaria = null;
    let vazaoNecessariaAbs = null;
    
    // Pega a primeira m√°quina de ventila√ß√£o para determinar a aplica√ß√£o da sala
    for (const machine of machines) {
        const machineId = machine.dataset.machineId;
        const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
        if (!aplicacaoSelect) continue;
        
        const aplicacao = aplicacaoSelect.value;
        if (VALID_APPLICATIONS.includes(aplicacao)) {
            vazaoNecessaria = calculateVazaoByAplicacao(aplicacao, roomId, inputs);
            if (vazaoNecessaria !== null && !isNaN(vazaoNecessaria)) {
                vazaoNecessariaAbs = Math.abs(vazaoNecessaria);
            }
            break;
        }
    }
    
    // Itera sobre todas as m√°quinas
    machines.forEach(machine => {
        const machineId = machine.dataset.machineId;
        
        const titleInput = document.getElementById(`title-${machineId}`);
        const tipoSelect = document.getElementById(`tipo-${machineId}`);
        const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
        const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
        const qntInput = document.getElementById(`solution-${machineId}`);
        
        if (!titleInput || !tipoSelect || !aplicacaoSelect || !capacidadeSelect || !qntInput) return;
        
        const aplicacao = aplicacaoSelect.value;
        
        // Pula se for climatiza√ß√£o ou aplica√ß√£o vazia
        if (aplicacao === 'climatizacao' || !aplicacao) {
            return;
        }
        
        const aplicacaoTexto = APPLICATION_TEXT_MAP[aplicacao] || aplicacao;
        const titulo = titleInput.value || 'M√°quina sem nome';
        const tipo = tipoSelect.options[tipoSelect.selectedIndex]?.text || 'N√£o definido';
        
        // Extrai capacidade
        const capacidadeValue = extractCapacidadeValue(capacidadeSelect.value);
        const capacidadeDisplay = capacidadeValue ? formatNumber(capacidadeValue) : '-';
        
        // Calcula vaz√£o da m√°quina
        let vazaoMaquinaDisplay = '-';
        if (VALID_APPLICATIONS.includes(aplicacao)) {
            const vazaoMaquina = calculateVazaoByAplicacao(aplicacao, roomId, inputs);
            if (vazaoMaquina !== null && !isNaN(vazaoMaquina)) {
                vazaoMaquinaDisplay = formatNumber(Math.abs(vazaoMaquina));
            }
        }
        
        // üî• SISTEMA DE CONTROLE DE EDI√á√ÉO DO USU√ÅRIO - CORRIGIDO
        // Inicializa o atributo se n√£o existir
        if (!qntInput.hasAttribute('data-user-edited')) {
            qntInput.setAttribute('data-user-edited', 'false');
        }
        
        // üî• CALCULA A SOLU√á√ÉO (valor te√≥rico)
        let solucaoNumerica = 1;
        if (capacidadeValue && vazaoNecessariaAbs) {
            solucaoNumerica = Math.ceil(vazaoNecessariaAbs / capacidadeValue);
        }
        
        // üî• REGRA DE NEG√ìCIO CORRIGIDA PARA QUANTIDADE:
        // - Se NUNCA foi editado OU se os par√¢metros mudaram: QUANTIDADE = SOLU√á√ÉO
        // - Se J√Å foi editado E os par√¢metros N√ÉO mudaram: MANT√âM valor manual
        
        // Verifica se os par√¢metros cr√≠ticos mudaram
        const lastParams = qntInput.getAttribute('data-last-params') || '';
        const currentParams = `${aplicacao}_${capacidadeValue}_${vazaoNecessariaAbs}`;
        
        const userEdited = qntInput.getAttribute('data-user-edited') === 'true';
        const paramsChanged = lastParams !== currentParams;
        
        // Se os par√¢metros mudaram, o usu√°rio precisa re-editar para manter o valor manual
        if (paramsChanged) {
            // üî• RESETA O FLAG DE EDI√á√ÉO QUANDO OS PAR√ÇMETROS MUDAM
            qntInput.setAttribute('data-user-edited', 'false');
            
            // Atualiza a quantidade para a nova solu√ß√£o
            qntInput.value = solucaoNumerica;
            
            // Salva os novos par√¢metros
            qntInput.setAttribute('data-last-params', currentParams);
            
            console.log(`üìä [Ventila√ß√£o] Par√¢metros mudaram. Quantidade da m√°quina ${machineId} resetada para ${solucaoNumerica}`);
            
            // Recalcula pre√ßo
            if (window.calculateMachinePrice) {
                window.calculateMachinePrice(machineId);
            }
        } else if (!userEdited) {
            // Se nunca foi editado e par√¢metros n√£o mudaram, usa a solu√ß√£o
            const currentValue = parseInt(qntInput.value) || 1;
            if (currentValue !== solucaoNumerica) {
                qntInput.value = solucaoNumerica;
                
                if (window.calculateMachinePrice) {
                    window.calculateMachinePrice(machineId);
                }
                
                console.log(`üìä [Ventila√ß√£o] Quantidade da m√°quina ${machineId} inicializada para ${solucaoNumerica}`);
            }
        }
        
        // Salva os par√¢metros atuais se ainda n√£o existirem
        if (!qntInput.hasAttribute('data-last-params')) {
            qntInput.setAttribute('data-last-params', currentParams);
        }
        
        // Obt√©m a quantidade ATUAL (pode ser autom√°tica ou manual)
        const quantidadeAtual = parseInt(qntInput.value) || 1;
        
        // üî• CALCULA PERDA E DISSIPA√á√ÉO com a quantidade ATUAL
        let perdaDisplay = '-';
        let dissipacaoDisplay = '-';
        let dissipacaoClass = '';
        
        if (capacidadeValue && vazaoNecessariaAbs) {
            // Perda = Capacidade * Quantidade ATUAL
            const perdaValue = capacidadeValue * quantidadeAtual;
            perdaDisplay = formatNumber(perdaValue);
            
            // Dissipa√ß√£o = Perda - Vaz√£o Necess√°ria
            const dissipacaoValue = perdaValue - vazaoNecessariaAbs;
            dissipacaoDisplay = formatNumber(dissipacaoValue);
            
            // üî• CORRE√á√ÉO: Aplica classe CSS baseada no valor (negativo ou positivo)
            if (dissipacaoValue < 0) {
                dissipacaoClass = 'negative';
            } else if (dissipacaoValue > 0) {
                dissipacaoClass = 'positive';
            } else {
                dissipacaoClass = '';
            }
        }
        
        // Cria a linha da tabela - AGORA COM COLUNA "Qtd. Atual"
        const row = document.createElement('tr');
        row.dataset.machineId = machine.machineId;
        
        row.innerHTML = `
            <td><span id="solucao-title-${machine.machineId}" class="solution-title">${titulo}</span></td>
            <td><span id="solucao-tipo-${machine.machineId}" class="solution-type">${tipo}</span></td>
            <td><span id="solucao-aplicacao-${machine.machineId}" class="solution-application">${aplicacaoTexto}</span></td>
            <td><span id="solucao-capacidade-${machine.machineId}" class="solution-capacity">${capacidadeDisplay}</span></td>
            <td><span id="solucao-qtd-${machine.machineId}" class="solution-quantity">${solucaoNumerica}</span></td>
            <td><span id="solucao-vazao-${machine.machineId}" class="solution-flow">${vazaoMaquinaDisplay}</span></td>
            <td><span id="solucao-qtd-atual-${machine.machineId}" class="solution-current-quantity" style="font-weight: bold; color: #2563eb;">${quantidadeAtual}</span></td>
            <td><span id="solucao-perda-${machine.machineId}" class="solution-loss">${perdaDisplay}</span></td>
            <td><span id="solucao-dissipacao-${machine.machineId}" class="solution-balance ${dissipacaoClass}">${dissipacaoDisplay}</span></td>
        `;
        
        tableBody.appendChild(row);
        hasVentilationMachines = true;
    });
    
    // Mensagem se n√£o h√° m√°quinas de ventila√ß√£o
    if (!hasVentilationMachines) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="9" style="text-align: center; padding: 20px; color: var(--color-gray-500);">
                Nenhuma m√°quina com aplica√ß√£o v√°lida para ventila√ß√£o
            </td>
        `;
        tableBody.appendChild(row);
    }
    
    if (window.updateAllMachinesTotal) {
        window.updateAllMachinesTotal(roomId);
    }
}

// =============================================================================
// HANDLER DE EDI√á√ÉO MANUAL
// =============================================================================

/**
 * Handler para quando o usu√°rio edita manualmente a quantidade
 */
window.handleManualQuantityEdit = function(machineId) {
    const qntInput = document.getElementById(`solution-${machineId}`);
    const machine = document.getElementById(`tipo-${machineId}`)?.closest('.climatization-machine');
    const roomId = machine?.dataset.roomId;
    
    if (!qntInput) return;
    
    // üö´ SE ESTIVER CARREGANDO, N√ÉO MARCA COMO EDI√á√ÉO MANUAL
    if (roomId && isLoadingForRoom(roomId)) {
        console.log(`‚è∏Ô∏è [VENTILA√á√ÉO] Edi√ß√£o manual ignorada - sala ${roomId} em carregamento`);
        return;
    }
    
    // Marca que o usu√°rio editou manualmente
    qntInput.setAttribute('data-user-edited', 'true');
    
    // üî• SALVA OS PAR√ÇMETROS ATUAIS PARA REFER√äNCIA FUTURA
    if (roomId) {
        const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
        const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
        
        const aplicacao = aplicacaoSelect?.value || '';
        const capacidadeValue = extractCapacidadeValue(capacidadeSelect?.value);
        
        // Calcula vaz√£o necess√°ria
        const inputs = collectRoomInputs(roomId);
        let vazaoNecessariaAbs = null;
        
        if (VALID_APPLICATIONS.includes(aplicacao)) {
            const vazaoNecessaria = calculateVazaoByAplicacao(aplicacao, roomId, inputs);
            if (vazaoNecessaria !== null && !isNaN(vazaoNecessaria)) {
                vazaoNecessariaAbs = Math.abs(vazaoNecessaria);
            }
        }
        
        const currentParams = `${aplicacao}_${capacidadeValue}_${vazaoNecessariaAbs}`;
        qntInput.setAttribute('data-last-params', currentParams);
    }
    
    console.log(`üìù [Ventila√ß√£o] Usu√°rio editou manualmente quantidade da m√°quina ${machineId}`);
    
    // Dispara o recalculo da ventila√ß√£o para atualizar perda/dissipa√ß√£o
    if (roomId) {
        setTimeout(() => {
            refreshVentilationForRoom(roomId);
        }, 6);
    }
    
    if (window.calculateMachinePrice) {
        window.calculateMachinePrice(machineId);
    }
};

// =============================================================================
// CONFIGURA√á√ÉO DE LISTENERS
// =============================================================================

/**
 * Configura listener para input de quantidade
 */
function setupQuantityInputListener(machineId) {
    const qntInput = document.getElementById(`solution-${machineId}`);
    if (qntInput) {
        // Remove listener antigo
        if (qntInput._manualEditHandler) {
            qntInput.removeEventListener('change', qntInput._manualEditHandler);
            qntInput.removeEventListener('input', qntInput._manualEditHandler);
        }
        
        // Adiciona novo handler
        qntInput._manualEditHandler = function() {
            window.handleManualQuantityEdit(machineId);
        };
        
        qntInput.addEventListener('change', qntInput._manualEditHandler);
        qntInput.addEventListener('input', qntInput._manualEditHandler);
        
        // Inicializa os atributos
        if (!qntInput.hasAttribute('data-user-edited')) {
            qntInput.setAttribute('data-user-edited', 'false');
        }
        if (!qntInput.hasAttribute('data-last-params')) {
            qntInput.setAttribute('data-last-params', '');
        }
    }
}

/**
 * Configura listeners para inputs t√©cnicos
 */
function setupTechnicalListeners(roomId) {
    const inputIds = [
        `potencia-${roomId}`,
        `temp-interna-${roomId}`,
        `temp-externa-${roomId}`,
        `vazao-ar-${roomId}`,
        `volume-${roomId}`
    ];
    
    inputIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (element._ventListener) {
                element.removeEventListener('input', element._ventListener);
                element.removeEventListener('change', element._ventListener);
            }
            
            element._ventListener = () => refreshVentilationForRoom(roomId);
            element.addEventListener('input', element._ventListener);
            element.addEventListener('change', element._ventListener);
        }
    });
    
    // Configura listeners para inputs de quantidade
    const machines = document.querySelectorAll(`[data-room-id="${roomId}"]`);
    machines.forEach(container => {
        const machineId = container.dataset.machineId;
        if (machineId) {
            setupQuantityInputListener(machineId);
        }
    });
}

/**
 * Configura observer para novas m√°quinas
 */
function setupMachinesObserver(roomId) {
    if (ventilationState.get(roomId)?.observer) return;
    
    const observer = new MutationObserver((mutations) => {
        let shouldRefresh = false;
        
        mutations.forEach(mutation => {
            if (mutation.type === 'childList') {
                if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
                    shouldRefresh = true;
                    
                    // Configura listeners para novas m√°quinas
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) {
                                const newMachines = node.querySelectorAll('[data-machine-id]');
                                newMachines.forEach(machine => {
                                    const machineId = machine.dataset.machineId;
                                    if (machineId) {
                                        setupQuantityInputListener(machineId);
                                    }
                                });
                            }
                        });
                    }
                }
            }
            
            if (mutation.type === 'attributes') {
                const target = mutation.target;
                if (target.id?.startsWith('aplicacao-') || 
                    target.id?.startsWith('capacidade-') ||
                    target.id?.startsWith('tipo-')) {
                    shouldRefresh = true;
                }
            }
        });
        
        if (shouldRefresh) {
            refreshVentilationForRoom(roomId);
        }
    });
    
    const machinesContainer = document.getElementById(`machines-${roomId}`);
    if (machinesContainer) {
        observer.observe(machinesContainer, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['value']
        });
        
        ventilationState.set(roomId, { observer });
    }
}

// =============================================================================
// FUN√á√ÉO PRINCIPAL DE REFRESH
// =============================================================================

window.refreshVentilationForRoom = function(roomId) {
    // üö´ BLOQUEIA C√ÅLCULOS DURANTE CARREGAMENTO
    if (isLoadingForRoom(roomId)) {
        console.log(`‚è∏Ô∏è [VENTILA√á√ÉO] C√°lculo bloqueado - sala ${roomId} em carregamento`);
        return;
    }
    
    if (!roomId || !roomId.includes('_proj_') || !roomId.includes('_sala_')) {
        return;
    }
    
    if (!window.systemConstants) {
        setTimeout(() => refreshVentilationForRoom(roomId), 62);
        return;
    }
    
    if (window[`_vent_frame_${roomId}`]) {
        cancelAnimationFrame(window[`_vent_frame_${roomId}`]);
    }
    
    window[`_vent_frame_${roomId}`] = requestAnimationFrame(() => {
        const inputs = collectRoomInputs(roomId);
        updateTechnicalTable(roomId, inputs);
        updateSolutionTable(roomId, inputs);
        delete window[`_vent_frame_${roomId}`];
    });
};

// =============================================================================
// HANDLERS DE EVENTOS (GLOBAIS)
// =============================================================================

window.handleVentilacaoAplicacaoChange = function(machineId) {
    const machine = document.getElementById(`tipo-${machineId}`)?.closest('.climatization-machine');
    const roomId = machine?.dataset.roomId;
    
    // üö´ BLOQUEIA DURANTE CARREGAMENTO
    if (roomId && isLoadingForRoom(roomId)) {
        console.log(`‚è∏Ô∏è [VENTILA√á√ÉO] Aplica√ß√£o alterada ignorada - sala ${roomId} em carregamento`);
        return;
    }
    
    const aplicacaoSelect = document.getElementById(`aplicacao-${machineId}`);
    const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
    
    if (!roomId) return;
    
    const aplicacao = aplicacaoSelect?.value;
    
    if (capacidadeSelect) {
        capacidadeSelect.disabled = !VALID_APPLICATIONS.includes(aplicacao);
        if (capacidadeSelect.disabled) {
            capacidadeSelect.value = '';
        }
    }
    
    refreshVentilationForRoom(roomId);
};

window.handleVentilacaoPowerChange = function(machineId) {
    const capacidadeSelect = document.getElementById(`capacidade-${machineId}`);
    const machine = capacidadeSelect?.closest('.climatization-machine');
    const roomId = machine?.dataset.roomId;
    
    // üö´ BLOQUEIA DURANTE CARREGAMENTO
    if (roomId && isLoadingForRoom(roomId)) {
        console.log(`‚è∏Ô∏è [VENTILA√á√ÉO] Capacidade alterada ignorada - sala ${roomId} em carregamento`);
        return;
    }
    
    if (roomId) {
        refreshVentilationForRoom(roomId);
    }
};

window.handleVentilacaoTipoChange = function(machineId) {
    const tipoSelect = document.getElementById(`tipo-${machineId}`);
    const machine = tipoSelect?.closest('.climatization-machine');
    const roomId = machine?.dataset.roomId;
    
    // üö´ BLOQUEIA DURANTE CARREGAMENTO
    if (roomId && isLoadingForRoom(roomId)) {
        console.log(`‚è∏Ô∏è [VENTILA√á√ÉO] Tipo alterado ignorado - sala ${roomId} em carregamento`);
        return;
    }
    
    if (roomId) {
        refreshVentilationForRoom(roomId);
    }
};

// =============================================================================
// CONFIGURA√á√ÉO INICIAL
// =============================================================================

function setupVentilationForRoom(roomId) {
    if (!roomId || !roomId.includes('_proj_') || !roomId.includes('_sala_')) {
        return;
    }
    
    if (ventilationState.get(roomId)?.configured) return;
    
    setupTechnicalListeners(roomId);
    
    const checkContainer = setInterval(() => {
        const container = document.getElementById(`machines-${roomId}`);
        if (container) {
            clearInterval(checkContainer);
            setupMachinesObserver(roomId);
            
            ventilationState.set(roomId, { 
                ...ventilationState.get(roomId),
                configured: true 
            });
            
            refreshVentilationForRoom(roomId);
        }
    }, 500);
    
    ventilationState.set(roomId, { 
        ...ventilationState.get(roomId),
        checkInterval: checkContainer 
    });
}

// =============================================================================
// FUN√á√ÉO PRINCIPAL EXPORTADA
// =============================================================================

export function buildVentilacaoSection(roomId) {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå buildVentilacaoSection: Room ID inv√°lido`);
        return '';
    }
    
    if (!roomId.includes('_proj_') || !roomId.includes('_sala_')) {
        console.warn(`‚ö†Ô∏è ID n√£o parece ser de sala: ${roomId}`);
        return '';
    }
    
    setTimeout(() => {
        setupVentilationForRoom(roomId);
    }, 12);
    
    return `
    <div class="section-block ventilation-section" id="ventilacao-section-${roomId}" data-room-id="${roomId}">
      <div class="section-header">
        <button class="minimizer" onclick="toggleSection('${roomId}ventilacao')">+</button>
        <h4 class="section-title">Ventila√ß√£o</h4>
      </div>
      <div class="section-content collapsed" id="section-content-${roomId}ventilacao">
        
        <!-- TABELA 1 - C√ÅLCULO T√âCNICO -->
        <div class="technical-table">
          <h5>C√°lculo T√©cnico</h5>
          <div class="vertical-table-container">
            <table class="vertical-table">
              <tr>
                <td>Pot√™ncia (kW)</td>
                <td>
                  <input type="number" 
                         id="potencia-${roomId}" 
                         class="vertical-input" 
                         step="any" 
                         placeholder="Ex: 100">
                </td>
              </tr>
              <tr>
                <td>Temp. Int. (¬∞C)</td>
                <td>
                  <input type="number" 
                         id="temp-interna-${roomId}" 
                         class="vertical-input" 
                         step="any" 
                         value="45"
                         placeholder="¬∞C">
                </td>
              </tr>
              <tr>
                <td>Temp. Ext. (¬∞C)</td>
                <td>
                  <input type="number" 
                         id="temp-externa-${roomId}" 
                         class="vertical-input" 
                         step="any" 
                         value="35"
                         placeholder="¬∞C">
                </td>
              </tr>
              <tr>
                <td>Q (cal/h)</td>
                <td><span id="q-cal-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>Massa (gramas)</td>
                <td><span id="massa-gramas-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>ŒîT (¬∞C)</td>
                <td><span id="delta-t-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>Massa de Ar (kg/h)</td>
                <td><span id="massa-ar-${roomId}" class="result-venti-value">-</span></td>
              </tr>
              <tr>
                <td>Vaz. Vol. (m¬≥/h)</td>
                <td><span id="vazao-${roomId}" class="result-venti-value">-</span></td>
              </tr>
            </table>
          </div>
        </div>

        <!-- TABELA 2 - SOLU√á√ÉO DAS M√ÅQUINAS -->
        <div class="solution-table">
          <h5>Solu√ß√£o das M√°quinas</h5>
          <div class="horizontal-table-container">
            <table class="machines-solution-table">
              <thead>
                <tr>
                  <th>Nome da M√°quina</th>
                  <th>Tipo de Ventilador / Filtro</th>
                  <th>Aplica√ß√£o</th>
                  <th>Cap. Unit. (m¬≥/h)</th>
                  <th>Solu√ß√£o</th>
                  <th>Vaz√£o (m¬≥/h)</th>
                  <th>Qtd. Inst.</th>
                  <th>Cap. Total (m¬≥/h)</th>
                  <th>Saldo (m¬≥/h)</th>
                </tr>
              </thead>
              <tbody id="solucao-body-${roomId}">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 20px; color: var(--color-gray-500);">
                    Aguardando m√°quinas...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
}
/* ==== FIM: data/modules/ventilacao.js ==== */
