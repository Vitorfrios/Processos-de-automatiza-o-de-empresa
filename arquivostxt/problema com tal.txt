
/* ==== IN√çCIO: data/builders/ui-folder/data-fillers.js ==== */
// data/modules/climatizacao/data-fill.js 

import { calculateVazaoArAndThermalGains } from '../../../features/calculations/air-flow.js';
import { triggerCalculation } from '../../../core/shared-utils.js';

// ‚úÖ ADICIONAR: Fun√ß√µes de sincroniza√ß√£o locais
function setupRoomTitleChangeListener(roomId) {
    console.log(`üéØ Configurando listener de t√≠tulo para sala: ${roomId}`);
    
    const roomTitle = document.querySelector(`[data-room-id="${roomId}"] .room-title`);
    const ambienteInput = document.querySelector(`input[data-field="ambiente"][data-room-id="${roomId}"]`);
    
    if (roomTitle && ambienteInput) {
        // Sincroniza√ß√£o Ambiente ‚Üí T√≠tulo
        ambienteInput.addEventListener('input', function() {
            if (this.value && this.value.trim() !== '' && this.value !== roomTitle.textContent) {
                if (typeof window.syncAmbienteToTitle === 'function') {
                    window.syncAmbienteToTitle(roomId, this.value);
                } else {
                    // Fallback direto
                    roomTitle.textContent = this.value;
                    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
                    if (roomBlock) {
                        roomBlock.dataset.roomName = this.value;
                    }
                    console.log(`üîÑ Ambiente ‚Üí T√≠tulo: "${this.value}"`);
                }
                triggerCalculation(roomId);
            }
        });
        
        console.log(`‚úÖ Listener t√≠tulo‚Üîambiente configurado para ${roomId}`);
    }
}

// ‚úÖ ADICIONAR: Tornar fun√ß√µes globais para compatibilidade
if (typeof window !== 'undefined') {
    window.setupRoomTitleChangeListener = setupRoomTitleChangeListener;
}

/**
 * Preenche os campos de climatiza√ß√£o de uma sala com dados do JSON
 */
function fillClimatizationInputs(roomElement, inputsData) {
    if (!roomElement || !inputsData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos para preenchimento');
        return;
    }

    console.log(`üîÑ Preenchendo inputs de climatiza√ß√£o:`, inputsData);

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    // ‚úÖ CORRE√á√ÉO: Preencher campo ambiente com nome da sala se estiver vazio
    const ambienteInput = roomElement.querySelector(`input[data-field="ambiente"]`);
    if (ambienteInput && (!inputsData.ambiente || inputsData.ambiente === '') && roomName) {
        inputsData.ambiente = roomName;
        console.log(`‚úÖ Campo ambiente preenchido automaticamente com nome da sala: "${roomName}"`);
    }
    
    // PRIMEIRO: Processar pressuriza√ß√£o (radio buttons) - CR√çTICO
    if (inputsData.pressurizacao !== undefined) {
        console.log(`üéØ Processando pressuriza√ß√£o para sala ${roomId}:`, inputsData.pressurizacao);
        
        // ‚úÖ CORRE√á√ÉO: Garantir que pressurizacao seja boolean
        const isPressurizacaoAtiva = typeof inputsData.pressurizacao === 'boolean' 
            ? inputsData.pressurizacao 
            : inputsData.pressurizacao === 'true' || inputsData.pressurizacao === true || inputsData.pressurizacao === 1;
        
        const pressurizacaoValue = isPressurizacaoAtiva ? 'sim' : 'nao';
        
        console.log(`üîç Buscando radio buttons para sala ${roomId}, valor: ${pressurizacaoValue}`);
        
        // Buscar todos os radios de pressuriza√ß√£o na sala
        const pressurizacaoRadios = roomElement.querySelectorAll(`input[type="radio"][name*="pressurizacao"]`);
        
        console.log(`üìª Encontrados ${pressurizacaoRadios.length} radios de pressuriza√ß√£o`);
        
        let radioToCheck = null;
        pressurizacaoRadios.forEach(radio => {
            console.log(`üîò Radio: value="${radio.value}", checked=${radio.checked}`);
            if (radio.value === pressurizacaoValue) {
                radioToCheck = radio;
            }
        });

        if (radioToCheck) {
            // Desselecionar todos primeiro
            pressurizacaoRadios.forEach(radio => {
                radio.checked = false;
            });
            
            // Selecionar o correto
            radioToCheck.checked = true;
            console.log(`‚úÖ Pressuriza√ß√£o definida: ${pressurizacaoValue} para sala ${roomId}`);
            
            // Disparar evento change para atualizar campos dependentes
            setTimeout(() => {
                console.log(`üé¨ Disparando evento change para pressuriza√ß√£o`);
                const event = new Event('change', { bubbles: true });
                radioToCheck.dispatchEvent(event);
            }, 100);
        } else {
            console.error(`‚ùå Radio button de pressuriza√ß√£o n√£o encontrado para valor: ${pressurizacaoValue}`);
        }
    }

    // SEGUNDO: Preencher inputs espec√≠ficos da pressuriza√ß√£o primeiro
    setTimeout(() => {
        console.log(`üîß Preenchendo campos espec√≠ficos de pressuriza√ß√£o para ${roomId}`);
        
        // ‚úÖ CORRE√á√ÉO: Preencher pressurizacaoSetpoint como n√∫mero
        if (inputsData.pressurizacaoSetpoint !== undefined) {
            const pressurizacaoInput = roomElement.querySelector(`.clima-input[data-field="pressurizacaoSetpoint"]`);
            if (pressurizacaoInput) {
                // Converter para n√∫mero garantido
                const numericValue = parseFloat(inputsData.pressurizacaoSetpoint) || 25;
                pressurizacaoInput.value = numericValue;
                console.log(`‚úÖ Campo pressurizacaoSetpoint definido: ${numericValue}`);
                
                setTimeout(() => {
                    const event = new Event('change', { bubbles: true });
                    pressurizacaoInput.dispatchEvent(event);
                }, 50);
            } else {
                console.warn(`‚ö†Ô∏è Campo pressurizacaoSetpoint n√£o encontrado na sala ${roomId}`);
            }
        }

        // ‚úÖ CORRE√á√ÉO: Preencher numPortasDuplas como n√∫mero
        if (inputsData.numPortasDuplas !== undefined) {
            const portasDuplasInput = roomElement.querySelector(`.clima-input[data-field="numPortasDuplas"]`);
            if (portasDuplasInput) {
                const numericValue = parseFloat(inputsData.numPortasDuplas) || 0;
                portasDuplasInput.value = numericValue;
                console.log(`‚úÖ Campo numPortasDuplas definido: ${numericValue}`);
            }
        }

        // ‚úÖ CORRE√á√ÉO: Preencher numPortasSimples como n√∫mero
        if (inputsData.numPortasSimples !== undefined) {
            const portasSimplesInput = roomElement.querySelector(`.clima-input[data-field="numPortasSimples"]`);
            if (portasSimplesInput) {
                const numericValue = parseFloat(inputsData.numPortasSimples) || 0;
                portasSimplesInput.value = numericValue;
                console.log(`‚úÖ Campo numPortasSimples definido: ${numericValue}`);
            }
        }

    }, 200);

    // TERCEIRO: Preencher outros inputs gerais
    setTimeout(() => {
        const textInputs = roomElement.querySelectorAll('.clima-input[type="text"], .clima-input[type="number"], .clima-input[data-field]');
        console.log(`üìã Encontrados ${textInputs.length} inputs para processar`);
        
        textInputs.forEach(input => {
            const field = input.getAttribute('data-field');
            if (!field || inputsData[field] === undefined) {
                console.log(`‚è≠Ô∏è  Campo ${field} n√£o encontrado nos dados, pulando`);
                return;
            }

            // Pular campos j√° preenchidos espec√≠ficos da pressuriza√ß√£o
            if (field === 'pressurizacaoSetpoint' || field === 'numPortasDuplas' || field === 'numPortasSimples') {
                console.log(`‚è≠Ô∏è  Campo ${field} j√° preenchido, pulando`);
                return;
            }
            
            let value = inputsData[field];
            
            // ‚úÖ CORRE√á√ÉO: Converter boolean e valores inv√°lidos para n√∫mero
            if (input.type === 'number') {
                if (value === false || value === 'false' || value === null || value === '') {
                    value = 0;
                }
                if (value === true || value === 'true') {
                    value = 1;
                }
                
                // Garantir que √© um n√∫mero v√°lido
                const numericValue = parseFloat(value);
                value = isNaN(numericValue) ? 0 : numericValue;
            }
            
            input.value = value;
            console.log(`‚úÖ Campo ${field} preenchido: ${value}`);

            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }, 50);
        });

        // QUARTO: Preencher selects
        const selectInputs = roomElement.querySelectorAll('select.clima-input[data-field]');
        selectInputs.forEach(select => {
            const field = select.getAttribute('data-field');
            if (!field || inputsData[field] === undefined) return;

            const value = inputsData[field];
            select.value = value;
            console.log(`‚úÖ Select ${field} preenchido: ${value}`);

            setTimeout(() => {
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
            }, 50);
        });

        // QUINTO: Verifica√ß√£o final do estado
        setTimeout(() => {
            console.log(`üîç Verifica√ß√£o final do estado para sala ${roomId}`);
            
            // Verificar estado dos campos de pressuriza√ß√£o
            const pressurizacaoInput = roomElement.querySelector('.clima-input[data-field="pressurizacaoSetpoint"]');
            const portasDuplasInput = roomElement.querySelector('.clima-input[data-field="numPortasDuplas"]');
            const portasSimplesInput = roomElement.querySelector('.clima-input[data-field="numPortasSimples"]');
            
            console.log(`üìä Estado final dos campos:`);
            console.log(`- Pressuriza√ß√£o Setpoint:`, pressurizacaoInput?.value);
            console.log(`- Portas Duplas:`, portasDuplasInput?.value);
            console.log(`- Portas Simples:`, portasSimplesInput?.value);
            console.log(`- Pressuriza√ß√£o ativa:`, inputsData.pressurizacao);
            
            // Se pressuriza√ß√£o for false, garantir que campos relacionados estejam zerados
            if (inputsData.pressurizacao === false) {
                console.log(`üîí Pressuriza√ß√£o desativada - verificando campos`);
                if (pressurizacaoInput && (!inputsData.pressurizacaoSetpoint || inputsData.pressurizacaoSetpoint === "0" || inputsData.pressurizacaoSetpoint === 0)) {
                    pressurizacaoInput.value = "0";
                    console.log(`‚úÖ Pressuriza√ß√£o desativada - setpoint zerado`);
                }
                if (portasDuplasInput && (!inputsData.numPortasDuplas || inputsData.numPortasDuplas === "0" || inputsData.numPortasDuplas === 0)) {
                    portasDuplasInput.value = "0";
                    console.log(`‚úÖ Pressuriza√ß√£o desativada - portas duplas zeradas`);
                }
                if (portasSimplesInput && (!inputsData.numPortasSimples || inputsData.numPortasSimples === "0" || inputsData.numPortasSimples === 0)) {
                    portasSimplesInput.value = "0";
                    console.log(`‚úÖ Pressuriza√ß√£o desativada - portas simples zeradas`);
                }
            }
            
            // ‚úÖ CORRE√á√ÉO MELHORADA: Configurar TODAS as sincroniza√ß√µes ap√≥s preenchimento
            setTimeout(() => {
                console.log(`üéØ CONFIGURANDO TODAS AS SINCRONIZA√á√ïES PARA: ${roomId}`);
                
                // 1. Sincroniza√ß√£o T√≠tulo ‚Üî Ambiente
                setupRoomTitleChangeListener(roomId);
                
                // 2. Sincroniza√ß√£o das Paredes usando a l√≥gica escolhida
                if (typeof window.setupCompleteRoomSync === 'function') {
                    window.setupCompleteRoomSync(roomId);
                }
                
                console.log(`‚úÖ Todas as sincroniza√ß√µes configuradas para: ${roomId}`);
            }, 500);

            console.log(`‚úÖ Processo de preenchimento iniciado para sala ${roomId}`);
            
            // Disparar c√°lculo final ap√≥s todos os campos estarem preenchidos
            if (roomId && typeof calculateVazaoArAndThermalGains === 'function') {
                setTimeout(() => {
                    console.log(`üßÆ Disparando c√°lculo final para sala ${roomId}`);
                    calculateVazaoArAndThermalGains(roomId);
                }, 300);
            }

        }, 150);

    }, 400); // Delay maior para garantir que a pressuriza√ß√£o foi processada primeiro

    console.log(`‚úÖ Processo de preenchimento iniciado para sala ${roomId}`);
}

/**
 * Preenche os dados de ganhos t√©rmicos nos elementos da sala
 */
function fillThermalGainsData(roomElement, thermalGainsData) {
    if (!roomElement || !thermalGainsData) {
        console.error('‚ùå Elemento da sala ou dados de ganhos t√©rmicos inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;
    console.log(`üîÑ Preenchendo ganhos t√©rmicos para sala ${roomId}:`, thermalGainsData);

    // ‚úÖ CORRE√á√ÉO: Atualizar os seletores para os novos IDs
    const gainSelectors = {
        'total-ganhos-w': `#total-ganhos-w-${roomId}`,
        'total-tr-aprox': `#total-tr-aprox-${roomId}`, // ‚úÖ NOVO: valor aproximado
        'total-tr-exato': `#total-tr-exato-${roomId}`, // ‚úÖ NOVO: valor exato
        'total-externo': `#total-externo-${roomId}`,
        'total-divisoes': `#total-divisoes-${roomId}`,
        'total-piso': `#total-piso-${roomId}`,
        'total-iluminacao': `#total-iluminacao-${roomId}`,
        'total-dissi': `#total-dissi-${roomId}`,
        'total-pessoas': `#total-pessoas-${roomId}`,
        'total-ar-sensivel': `#total-ar-sensivel-${roomId}`,
        'total-ar-latente': `#total-ar-latente-${roomId}`
    };

    Object.entries(gainSelectors).forEach(([key, selector]) => {
        const element = document.querySelector(selector);
        if (element && thermalGainsData[key] !== undefined) {
            // ‚úÖ CORRE√á√ÉO: Para valor TR exato, manter 3 casas decimais
            if (key === 'total-tr-exato' && typeof thermalGainsData[key] === 'number') {
                element.textContent = thermalGainsData[key].toFixed(3);
            } else {
                element.textContent = thermalGainsData[key];
            }
            console.log(`‚úÖ ${key} preenchido: ${thermalGainsData[key]}`);
        }
    });

    console.log(`‚úÖ Ganhos t√©rmicos preenchidos para sala ${roomId}`);
}

/**
 * Preenche os dados de capacidade de refrigera√ß√£o da sala
 */
function fillCapacityData(roomElement, capacityData) {
    if (!roomElement || !capacityData) {
        console.error('‚ùå Elemento da sala ou dados de capacidade inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;
    console.log(`üîÑ Preenchendo dados de capacidade para sala ${roomId}:`, capacityData);

    const fatorSegurancaInput = document.getElementById(`fator-seguranca-${roomId}`);
    if (fatorSegurancaInput && capacityData.fatorSeguranca !== undefined) {
        fatorSegurancaInput.value = capacityData.fatorSeguranca;
        console.log(`‚úÖ Fator seguran√ßa preenchido: ${capacityData.fatorSeguranca}`);
    }

    const capacidadeUnitariaSelect = document.getElementById(`capacidade-unitaria-${roomId}`);
    if (capacidadeUnitariaSelect && capacityData.capacidadeUnitaria !== undefined) {
        capacidadeUnitariaSelect.value = capacityData.capacidadeUnitaria;
        console.log(`‚úÖ Capacidade unit√°ria preenchida: ${capacityData.capacidadeUnitaria}`);
    }

    const backupSelect = roomElement.querySelector('.backup-select');
    if (backupSelect && capacityData.backup !== undefined) {
        backupSelect.value = capacityData.backup;
        console.log(`‚úÖ Backup preenchido: ${capacityData.backup}`);
    }

    console.log(`‚úÖ Dados de capacidade preenchidos para sala ${roomId}`);
}

/**
 * Preenche os dados dos equipamentos na sala
 */
function fillEquipamentosData(roomElement, equipamentosData) {
    if (!roomElement || !equipamentosData) {
        console.error('‚ùå Elemento da sala ou dados de equipamentos inv√°lidos');
        return;
    }

    const roomId = roomElement.dataset.roomId;
    console.log(`üîÑ Preenchendo equipamentos para sala ${roomId}:`, equipamentosData);

    // Verificar se a se√ß√£o de equipamentos existe
    const equipamentosSection = roomElement.querySelector(`#section-content-${roomId}equipamentos`);
    if (!equipamentosSection) {
        console.error(`‚ùå Se√ß√£o de equipamentos n√£o encontrada para sala ${roomId}`);
        return;
    }

    // Se n√£o houver equipamentos, sair
    if (!Array.isArray(equipamentosData) || equipamentosData.length === 0) {
        console.log(`‚ÑπÔ∏è Nenhum equipamento para preencher na sala ${roomId}`);
        return;
    }

    // Garantir que a tabela existe
    const tbodyId = `equipamentos-list-${roomId}`;
    let tbody = document.getElementById(tbodyId);
    
    if (!tbody) {
        console.log(`üìã Criando tabela de equipamentos para sala ${roomId}`);
        
        // Buscar o container da tabela
        const tableContainer = equipamentosSection.querySelector('.equipamentos-table-container');
        if (tableContainer) {
            // Criar tabela b√°sica se n√£o existir
            const tableHTML = `
                <table class="equipamentos-table" id="equipamentos-table-${roomId}">
                    <thead>
                        <tr>
                            <th width="30%">Equipamento</th>
                            <th width="25%">Dimens√£o</th>
                            <th width="15%">Qtd</th>
                            <th width="20%">Valor Unit.</th>
                            <th width="10%">Total</th>
                            <th width="10%">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="${tbodyId}">
                        <!-- Equipamentos ser√£o adicionados aqui -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL:</td>
                            <td id="equipamentos-total-${roomId}" style="font-weight: bold;">R$ 0,00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
            tbody = document.getElementById(tbodyId);
        }
    }

    if (tbody) {
        // Limpar tabela atual
        tbody.innerHTML = '';
        
        // Adicionar cada equipamento
        equipamentosData.forEach(equipamento => {
            adicionarEquipamentoNaTabela(roomId, equipamento);
        });
        
        // Atualizar total
        atualizarTotalEquipamentos(roomId);
        
        console.log(`‚úÖ ${equipamentosData.length} equipamento(s) preenchido(s) na sala ${roomId}`);
    }
}


/**
 * Garante que todas as se√ß√µes da sala est√£o criadas e inicializadas
 */
async function ensureAllRoomSections(roomElement) {
    if (!roomElement) {
        console.error('‚ùå Elemento da sala inv√°lido');
        return false;
    }

    const obraId = roomElement.dataset.obraId;
    const projectId = roomElement.dataset.projectId; 
    const roomName = roomElement.dataset.roomName;
    const roomId = roomElement.dataset.roomId;

    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå Room ID inv√°lido: "${roomId}" para sala ${roomName}`);
        return false;
    }

    console.log(`üî® Verificando se√ß√µes da sala ${roomName} (ID: ${roomId})`);

    // ‚úÖ CORRE√á√ÉO: Usar as novas fun√ß√µes para verificar se√ß√µes
    const climatizationSection = findSectionByTitle(roomElement, 'Climatiza√ß√£o');
    const machinesSection = findMachinesSection(roomElement);
    const accessorySection = findSectionByTitle(roomElement, 'Acessorios');

    if (climatizationSection && machinesSection && accessorySection) {
        console.log(`‚úÖ Todas as se√ß√µes j√° existem para sala ${roomName}`);
        return true;
    }

    console.log(`üîÑ Criando se√ß√µes faltantes para sala ${roomName}`);

    try {
        const roomContent = roomElement.querySelector('.room-content');
        if (!roomContent) {
            console.error(`‚ùå Container de conte√∫do da sala n√£o encontrado`);
            return false;
        }

        if (!climatizationSection) {
            console.log(`üèóÔ∏è Criando todas as se√ß√µes para sala ${roomName}`);

            if (typeof window.buildClimatizationSection !== 'function' || 
                typeof buildMachinesSection !== 'function' ||
                typeof window.buildEquipamentosSection !== 'function'
                // aqui falta duto e tubula√ß√£o
                ) {
                console.error('‚ùå Fun√ß√µes de constru√ß√£o de se√ß√µes n√£o dispon√≠veis');
                return false;
            }

            // Criar se√ß√£o de climatiza√ß√£o
            const climatizationHTML = await window.buildClimatizationSection(obraId, projectId, roomName, roomId);
            if (climatizationHTML) {
                roomContent.insertAdjacentHTML('beforeend', climatizationHTML);
                console.log(`‚úÖ Se√ß√£o de climatiza√ß√£o criada`);
            }

            await new Promise(resolve => setTimeout(resolve, 300));

            // Criar se√ß√£o de m√°quinas
            const machinesHTML = await buildMachinesSection(obraId, projectId, roomName, roomId);
            if (machinesHTML) {
                roomContent.insertAdjacentHTML('beforeend', machinesHTML);
                console.log(`‚úÖ Se√ß√£o de m√°quinas criada`);
            }

            await new Promise(resolve => setTimeout(resolve, 300));

            // Criar se√ß√£o de configura√ß√£o
            const configurationHTML = await window.buildEquipamentosSection(obraId, projectId, roomName, roomId);
            if (configurationHTML) {
                roomContent.insertAdjacentHTML('beforeend', configurationHTML);
                console.log(`‚úÖ Se√ß√£o de configura√ß√£o criada`);
            }

            await new Promise(resolve => setTimeout(resolve, 500));

            console.log(`‚úÖ Todas as se√ß√µes criadas para sala ${roomName}`);
            return true;
        }

        // Criar apenas se√ß√µes faltantes
        if (climatizationSection && !machinesSection) {
            console.log(`üî® Criando apenas se√ß√£o de m√°quinas para sala ${roomName}`);

            const machinesHTML = await buildMachinesSection(obraId, projectId, roomName, roomId);
            if (machinesHTML) {
                climatizationSection.insertAdjacentHTML('afterend', machinesHTML);
                console.log(`‚úÖ Se√ß√£o de m√°quinas criada`);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                return true;
            }
        }
        setTimeout(() => {
            console.log(`üîß CONFIGURANDO SINCRONIZA√á√ïES AP√ìS CRIAR SE√á√ïES: ${roomId}`);
            
            if (typeof window.setupCompleteRoomSync === 'function') {
                window.setupCompleteRoomSync(roomId);
            }
            
            console.log(`‚úÖ Sincroniza√ß√µes configuradas ap√≥s cria√ß√£o de se√ß√µes: ${roomId}`);
        }, 1000);
        console.log(`‚ùå N√£o foi poss√≠vel criar todas as se√ß√µes para sala ${roomName}`);
        return false;

    } catch (error) {
        console.error(`‚ùå Erro ao criar se√ß√µes da sala ${roomName}:`, error);
        return false;
    }
}

/**
 * Fun√ß√£o auxiliar para adicionar equipamento na tabela
 * (Essa fun√ß√£o deve ser a mesma do equipamentos.js)
 */
function adicionarEquipamentoNaTabela(roomId, equipamento) {
    const tbody = document.getElementById(`equipamentos-list-${roomId}`);
    if (!tbody) return;
    
    const row = document.createElement('tr');
    row.id = `equipamento-${equipamento.id}`;
    row.className = 'equipamento-row';
    row.setAttribute('data-equipamento', JSON.stringify(equipamento));
    
    row.innerHTML = `
        <td>${equipamento.descricao || equipamento.tipo}</td>
        <td>${equipamento.dimensao}</td>
        <td>${equipamento.quantidade}</td>
        <td>R$ ${formatarMoeda(equipamento.valor_unitario)}</td>
        <td>R$ ${formatarMoeda(equipamento.valor_total)}</td>
        <td>
            <button class="btn-remove-equipamento" onclick="removerEquipamento('${roomId}', '${equipamento.id}')">
                üóëÔ∏è
            </button>
            <button class="btn-edit-equipamento" onclick="editarEquipamento('${roomId}', '${equipamento.id}')">
                ‚úèÔ∏è
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
}

/**
 * Fun√ß√£o auxiliar para formatar moeda
 */
function formatarMoeda(valor) {
    return valor.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

/**
 * Fun√ß√£o auxiliar para atualizar total
 */
function atualizarTotalEquipamentos(roomId) {
    const tbody = document.getElementById(`equipamentos-list-${roomId}`);
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('.equipamento-row');
    let total = 0;
    
    rows.forEach(row => {
        try {
            const equipamentoData = JSON.parse(row.getAttribute('data-equipamento'));
            total += equipamentoData.valor_total || 0;
        } catch (error) {
            console.error('‚ùå Erro ao calcular total:', error);
        }
    });
    
    const totalElement = document.getElementById(`equipamentos-total-${roomId}`);
    if (totalElement) {
        totalElement.textContent = `R$ ${formatarMoeda(total)}`;
    }
}

// EXPORTS NO FINAL
export {
    fillClimatizationInputs,
    fillThermalGainsData,
    fillCapacityData,
    fillEquipamentosData,
    ensureAllRoomSections,
    setupRoomTitleChangeListener
};
/* ==== FIM: data/builders/ui-folder/data-fillers.js ==== */

/* ==== IN√çCIO: data/modules/equipamentos.js ==== */
/**
 * equipamentos.js - Sistema de sele√ß√£o de Equipamentos de Difus√£o
 * Interface para selecionar e adicionar equipamentos ao projeto
 */

/**
 * Constr√≥i a se√ß√£o de Equipamentos de Difus√£o e Controle de Ar
 */
function buildEquipamentosSection(obraId, projectId, roomName, finalRoomId) {
    // ‚úÖ CORRE√á√ÉO: Validar ID √∫nico
    if (!finalRoomId || finalRoomId === 'undefined' || finalRoomId === 'null') {
        console.error(`ERRO FALBACK (buildEquipamentosSection) equipamentos.js [Room ID inv√°lido: ${finalRoomId}]`);
        return '';
    }
    
    const roomId = finalRoomId;
    console.log(`üîß Construindo se√ß√£o de Equipamentos para sala: ${roomName} (ID: ${roomId})`);
    
    return `
    <div class="section-block">
      <div class="section-header">
        <button class="minimizer" onclick="toggleSection('${roomId}equipamentos')">+</button>
        <h4 class="section-title">Equipamentos de Difus√£o e Controle de Ar</h4>
      </div>
      <div class="section-content collapsed" id="section-content-${roomId}equipamentos">
        <div class="form-grid">
          <!-- Seletor de Equipamentos -->
          <div class="form-group full-width">
            <label class="acess-label">Adicionar Equipamento:</label>
            <div class="equipamento-selector">
              <div class="selector-grid">
                <div class="selector-item">
                  <label for="equipamento-tipo-${roomId}">Tipo:</label>
                  <select id="equipamento-tipo-${roomId}" class="equipamento-select" onchange="loadEquipamentoDimensoes('${roomId}')">
                    <option value="">Selecione um tipo...</option>
                    <!-- Tipos ser√£o carregados via JavaScript -->
                  </select>
                </div>
                <div class="selector-item">
                  <label for="equipamento-dimensao-${roomId}">Dimens√£o:</label>
                  <select id="equipamento-dimensao-${roomId}" class="equipamento-select" disabled>
                    <option value="">Selecione uma dimens√£o...</option>
                  </select>
                </div>
                <div class="selector-item">
                  <label for="equipamento-quantidade-${roomId}">Qtd:</label>
                  <input type="number" id="equipamento-quantidade-${roomId}" class="equipamento-input" value="1" min="1" max="100">
                </div>
                <div class="selector-item">
                  <label for="equipamento-valor-${roomId}">Valor:</label>
                  <input type="text" id="equipamento-valor-${roomId}" class="equipamento-input" placeholder="R$ 0,00" readonly>
                </div>
                <div class="selector-item">
                  <button class="btn-add-equipamento" onclick="adicionarEquipamento('${roomId}')">
                    <span class="btn-icon">+</span> Adicionar
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tabela de Equipamentos Adicionados -->
          <div class="form-group full-width">
            <label class="acess-label">Equipamentos Selecionados:</label>
            <div class="equipamentos-table-container">
              <table class="equipamentos-table" id="equipamentos-table-${roomId}">
                <thead>
                  <tr>
                    <th width="30%">Equipamento</th>
                    <th width="25%">Dimens√£o</th>
                    <th width="15%">Qtd</th>
                    <th width="20%">Valor Unit.</th>
                    <th width="10%">Total</th>
                    <th width="10%">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="equipamentos-list-${roomId}">
                  <!-- Lista de equipamentos ser√° gerada dinamicamente -->
                  <tr class="empty-row">
                    <td colspan="6">Nenhum equipamento adicionado</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL:</td>
                    <td id="equipamentos-total-${roomId}" style="font-weight: bold;">R$ 0,00</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          
          <!-- Bot√µes de A√ß√£o -->
          <div class="form-group full-width text-center">
            <button class="btn-save-equipamentos" onclick="salvarEquipamentos('${roomId}')">
              üíæ Salvar Equipamentos
            </button>
            <button class="btn-load-equipamentos" onclick="carregarEquipamentos('${roomId}')">
              üìã Carregar Salvos
            </button>
            <button class="btn-clear-equipamentos" onclick="limparEquipamentos('${roomId}')">
              üóëÔ∏è Limpar Tudo
            </button>
          </div>
        </div>
      </div>
    </div>
    `;
}

/**
 * Inicializa o sistema de equipamentos para uma sala
 */
function initEquipamentosSystem(roomId) {
    console.log(`üîß Inicializando sistema de equipamentos para sala: ${roomId}`);
    
    // Carregar tipos de equipamentos da API
    carregarTiposEquipamentos(roomId);
    
    // Carregar equipamentos salvos
    carregarEquipamentos(roomId);
    
    // Inicializar eventos
    setupEquipamentosEvents(roomId);
}

/**
 * Carrega os tipos de equipamentos da API
 */
async function carregarTiposEquipamentos(roomId) {
    try {
        const response = await fetch('/api/equipamentos/types');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById(`equipamento-tipo-${roomId}`);
            if (!select) return;
            
            // Limpar op√ß√µes existentes (exceto a primeira)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Adicionar op√ß√µes
            data.types.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${data.types.length} tipos de equipamentos carregados`);
        } else {
            console.error('‚ùå Erro ao carregar tipos:', data.error);
        }
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
    }
}

/**
 * Carrega as dimens√µes dispon√≠veis para o equipamento selecionado
 */
async function loadEquipamentoDimensoes(roomId) {
    const tipoSelect = document.getElementById(`equipamento-tipo-${roomId}`);
    const dimensaoSelect = document.getElementById(`equipamento-dimensao-${roomId}`);
    const valorInput = document.getElementById(`equipamento-valor-${roomId}`);
    
    const tipo = tipoSelect.value;
    
    if (!tipo) {
        dimensaoSelect.disabled = true;
        valorInput.value = 'R$ 0,00';
        return;
    }
    
    try {
        const response = await fetch(`/api/equipamentos/type/${tipo}`);
        const data = await response.json();
        
        if (data.success) {
            const equipamento = data.equipamento;
            const valores = equipamento.valores_padrao || {};
            
            // Limpar e preencher dimens√µes
            dimensaoSelect.innerHTML = '<option value="">Selecione uma dimens√£o...</option>';
            
            Object.keys(valores).forEach(dimensao => {
                const option = document.createElement('option');
                option.value = dimensao;
                option.textContent = dimensao;
                option.setAttribute('data-valor', valores[dimensao]);
                dimensaoSelect.appendChild(option);
            });
            
            dimensaoSelect.disabled = false;
            valorInput.value = 'R$ 0,00';
            
            // Adicionar evento para atualizar valor
            dimensaoSelect.onchange = function() {
                const selectedOption = this.options[this.selectedIndex];
                const valor = selectedOption.getAttribute('data-valor');
                if (valor) {
                    const valorFormatado = formatarMoeda(parseFloat(valor));
                    valorInput.value = `R$ ${valorFormatado}`;
                } else {
                    valorInput.value = 'R$ 0,00';
                }
            };
            
            console.log(`‚úÖ ${Object.keys(valores).length} dimens√µes carregadas para ${tipo}`);
        } else {
            console.error('‚ùå Erro ao carregar dimens√µes:', data.error);
            dimensaoSelect.disabled = true;
            valorInput.value = 'R$ 0,00';
        }
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        dimensaoSelect.disabled = true;
        valorInput.value = 'R$ 0,00';
    }
}

/**
 * Adiciona um equipamento √† lista
 */
function adicionarEquipamento(roomId) {
    const tipoSelect = document.getElementById(`equipamento-tipo-${roomId}`);
    const dimensaoSelect = document.getElementById(`equipamento-dimensao-${roomId}`);
    const quantidadeInput = document.getElementById(`equipamento-quantidade-${roomId}`);
    const valorInput = document.getElementById(`equipamento-valor-${roomId}`);
    
    // Valida√ß√µes
    if (!tipoSelect.value) {
        alert('Por favor, selecione um tipo de equipamento.');
        return;
    }
    
    if (!dimensaoSelect.value) {
        alert('Por favor, selecione uma dimens√£o.');
        return;
    }
    
    const quantidade = parseInt(quantidadeInput.value) || 1;
    if (quantidade < 1) {
        alert('A quantidade deve ser no m√≠nimo 1.');
        return;
    }
    
    // Extrair valor (remover "R$ " e converter v√≠rgula para ponto)
    let valorTexto = valorInput.value.replace('R$ ', '').replace('.', '').replace(',', '.');
    const valorUnitario = parseFloat(valorTexto) || 0;
    
    if (valorUnitario <= 0) {
        alert('Valor inv√°lido.');
        return;
    }
    
    // Criar objeto do equipamento
    const equipamento = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        tipo: tipoSelect.value,
        dimensao: dimensaoSelect.value,
        quantidade: quantidade,
        valor_unitario: valorUnitario,
        valor_total: valorUnitario * quantidade,
        descricao: tipoSelect.options[tipoSelect.selectedIndex].textContent
    };
    
    // Adicionar √† lista
    adicionarEquipamentoNaTabela(roomId, equipamento);
    
    // Limpar campos
    dimensaoSelect.selectedIndex = 0;
    quantidadeInput.value = 1;
    valorInput.value = 'R$ 0,00';
    
    console.log(`‚úÖ Equipamento adicionado: ${equipamento.tipo} ${equipamento.dimensao}`);
}

/**
 * Adiciona equipamento na tabela HTML
 */
function adicionarEquipamentoNaTabela(roomId, equipamento) {
    const tbody = document.getElementById(`equipamentos-list-${roomId}`);
    const emptyRow = tbody.querySelector('.empty-row');
    
    // Remover linha vazia se existir
    if (emptyRow) {
        emptyRow.remove();
    }
    
    // Criar nova linha
    const row = document.createElement('tr');
    row.id = `equipamento-${equipamento.id}`;
    row.className = 'equipamento-row';
    row.setAttribute('data-equipamento', JSON.stringify(equipamento));
    
    row.innerHTML = `
        <td>${equipamento.descricao}</td>
        <td>${equipamento.dimensao}</td>
        <td>${equipamento.quantidade}</td>
        <td>R$ ${formatarMoeda(equipamento.valor_unitario)}</td>
        <td>R$ ${formatarMoeda(equipamento.valor_total)}</td>
        <td>
            <button class="btn-remove-equipamento" onclick="removerEquipamento('${roomId}', '${equipamento.id}')">
                üóëÔ∏è
            </button>
            <button class="btn-edit-equipamento" onclick="editarEquipamento('${roomId}', '${equipamento.id}')">
                ‚úèÔ∏è
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    
    // Atualizar total
    atualizarTotalEquipamentos(roomId);
}

/**
 * Remove um equipamento da lista
 */
function removerEquipamento(roomId, equipamentoId) {
    const row = document.getElementById(`equipamento-${equipamentoId}`);
    if (row) {
        row.remove();
        
        // Verificar se a tabela est√° vazia
        const tbody = document.getElementById(`equipamentos-list-${roomId}`);
        if (tbody.children.length === 0) {
            // Adicionar linha vazia
            const emptyRow = document.createElement('tr');
            emptyRow.className = 'empty-row';
            emptyRow.innerHTML = '<td colspan="6">Nenhum equipamento adicionado</td>';
            tbody.appendChild(emptyRow);
        }
        
        // Atualizar total
        atualizarTotalEquipamentos(roomId);
        
        console.log(`üóëÔ∏è Equipamento removido: ${equipamentoId}`);
    }
}

/**
 * Edita um equipamento existente
 */
function editarEquipamento(roomId, equipamentoId) {
    const row = document.getElementById(`equipamento-${equipamentoId}`);
    if (!row) return;
    
    const equipamentoData = JSON.parse(row.getAttribute('data-equipamento'));
    
    // Preencher campos de entrada
    const tipoSelect = document.getElementById(`equipamento-tipo-${roomId}`);
    const dimensaoSelect = document.getElementById(`equipamento-dimensao-${roomId}`);
    const quantidadeInput = document.getElementById(`equipamento-quantidade-${roomId}`);
    const valorInput = document.getElementById(`equipamento-valor-${roomId}`);
    
    // Selecionar tipo
    for (let i = 0; i < tipoSelect.options.length; i++) {
        if (tipoSelect.options[i].value === equipamentoData.tipo) {
            tipoSelect.selectedIndex = i;
            break;
        }
    }
    
    // Carregar dimens√µes e selecionar
    loadEquipamentoDimensoes(roomId).then(() => {
        setTimeout(() => {
            for (let i = 0; i < dimensaoSelect.options.length; i++) {
                if (dimensaoSelect.options[i].value === equipamentoData.dimensao) {
                    dimensaoSelect.selectedIndex = i;
                    break;
                }
            }
            
            // Preencher quantidade e valor
            quantidadeInput.value = equipamentoData.quantidade;
            valorInput.value = `R$ ${formatarMoeda(equipamentoData.valor_unitario)}`;
            
            // Remover equipamento da lista
            removerEquipamento(roomId, equipamentoId);
            
            console.log(`‚úèÔ∏è Equipamento em edi√ß√£o: ${equipamentoId}`);
        }, 500);
    });
}

/**
 * Atualiza o total de equipamentos
 */
function atualizarTotalEquipamentos(roomId) {
    const tbody = document.getElementById(`equipamentos-list-${roomId}`);
    const rows = tbody.querySelectorAll('.equipamento-row');
    
    let total = 0;
    
    rows.forEach(row => {
        const equipamentoData = JSON.parse(row.getAttribute('data-equipamento'));
        total += equipamentoData.valor_total;
    });
    
    const totalElement = document.getElementById(`equipamentos-total-${roomId}`);
    if (totalElement) {
        totalElement.textContent = `R$ ${formatarMoeda(total)}`;
    }
}

/**
 * Salva os equipamentos no localStorage
 */
function salvarEquipamentos(roomId) {
    const tbody = document.getElementById(`equipamentos-list-${roomId}`);
    const rows = tbody.querySelectorAll('.equipamento-row');
    
    const equipamentos = [];
    rows.forEach(row => {
        const equipamentoData = JSON.parse(row.getAttribute('data-equipamento'));
        equipamentos.push(equipamentoData);
    });
    
    // Salvar no localStorage
    const key = `equipamentos_${roomId}`;
    localStorage.setItem(key, JSON.stringify(equipamentos));
    
    alert(`‚úÖ ${equipamentos.length} equipamento(s) salvo(s) com sucesso!`);
    console.log(`üíæ Equipamentos salvos para sala ${roomId}:`, equipamentos);
}

/**
 * Carrega equipamentos do localStorage
 */
function carregarEquipamentos(roomId) {
    const key = `equipamentos_${roomId}`;
    const equipamentosSalvos = localStorage.getItem(key);
    
    if (!equipamentosSalvos) {
        console.log(`üìã Nenhum equipamento salvo para sala ${roomId}`);
        return;
    }
    
    try {
        const equipamentos = JSON.parse(equipamentosSalvos);
        
        // Limpar lista atual
        const tbody = document.getElementById(`equipamentos-list-${roomId}`);
        tbody.innerHTML = '';
        
        // Adicionar equipamentos salvos
        equipamentos.forEach(equipamento => {
            adicionarEquipamentoNaTabela(roomId, equipamento);
        });
        
        console.log(`üìã ${equipamentos.length} equipamento(s) carregado(s) para sala ${roomId}`);
    } catch (error) {
        console.error('‚ùå Erro ao carregar equipamentos:', error);
    }
}

/**
 * Limpa todos os equipamentos
 */
function limparEquipamentos(roomId) {
    if (confirm('Tem certeza que deseja limpar todos os equipamentos?')) {
        const tbody = document.getElementById(`equipamentos-list-${roomId}`);
        tbody.innerHTML = '';
        
        // Adicionar linha vazia
        const emptyRow = document.createElement('tr');
        emptyRow.className = 'empty-row';
        emptyRow.innerHTML = '<td colspan="6">Nenhum equipamento adicionado</td>';
        tbody.appendChild(emptyRow);
        
        // Atualizar total
        atualizarTotalEquipamentos(roomId);
        
        // Limpar localStorage
        const key = `equipamentos_${roomId}`;
        localStorage.removeItem(key);
        
        console.log(`üóëÔ∏è Todos os equipamentos removidos da sala ${roomId}`);
    }
}

/**
 * Formata valor para moeda brasileira
 */
function formatarMoeda(valor) {
    return valor.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

/**
 * Configura eventos para o sistema de equipamentos
 */
function setupEquipamentosEvents(roomId) {
    const quantidadeInput = document.getElementById(`equipamento-quantidade-${roomId}`);
    if (quantidadeInput) {
        quantidadeInput.addEventListener('change', function() {
            if (this.value < 1) this.value = 1;
            if (this.value > 100) this.value = 100;
        });
    }
}

// Exportar fun√ß√µes
export {
    buildEquipamentosSection,
    initEquipamentosSystem,
    carregarTiposEquipamentos,
    loadEquipamentoDimensoes,
    adicionarEquipamento,
    salvarEquipamentos,
    carregarEquipamentos,
    limparEquipamentos
};
/* ==== FIM: data/modules/equipamentos.js ==== */

/* ==== IN√çCIO: data/builders/ui-folder/room-renderer.js ==== */
import { ensureStringId } from '../../utils/id-generator.js';

/**
 * Renderiza uma sala individual a partir dos dados carregados
 */
function renderRoomFromData(projectId, projectName, roomData, obraId = null, obraName = null) {
    const roomName = roomData.nome;
    const roomId = ensureStringId(roomData.id);

    console.log(`üéØ Renderizando sala: ${roomName} no projeto ${projectName}`, {
        obra: obraName,
        projectId: projectId,
        roomId: roomId,
        inputs: Object.keys(roomData.inputs || {}).length,
        maquinas: roomData.maquinas?.length || 0,
        capacidade: Object.keys(roomData.capacidade || {}).length,
        ganhosTermicos: Object.keys(roomData.ganhosTermicos || {}).length,
        equipamentos: roomData.equipamentos?.length || 0  
        // adicionar aqui tubula√ß√£o e dutos
    });

    setTimeout(() => {
        createEmptyRoom(obraId, projectId, roomName, roomId);

        setTimeout(() => {
            populateRoomInputs(projectId, projectName, roomId, roomName, roomData, obraId, obraName);
        }, 100);
        
    }, 100);
}

/**
 * Preenche uma sala espec√≠fica dentro de um projeto
 */
async function populateRoomData(roomElement, roomData) {
    if (!roomElement || !roomData) {
        console.error('‚ùå Elemento da sala ou dados inv√°lidos');
        return false;
    }

    const roomId = roomElement.dataset.roomId;
    const roomName = roomElement.dataset.roomName;
    
    // ‚úÖ CORRE√á√ÉO: Validar roomId antes de prosseguir
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`‚ùå Room ID inv√°lido no populateRoomData: "${roomId}"`);
        console.log('üîç Elemento da sala:', roomElement);
        console.log('üîç Dataset:', roomElement.dataset);
        return false;
    }
    
    console.log(`üîÑ Preenchendo sala "${roomName}" (ID: ${roomId})`, roomData);

    try {
        // ‚úÖ CORRE√á√ÉO: Garantir que todas as se√ß√µes existam antes de preencher
        console.log(`üèóÔ∏è Garantindo que todas as se√ß√µes existem para sala ${roomName}`);
        const sectionsReady = await ensureAllRoomSections(roomElement);
        if (!sectionsReady) {
            console.error(`‚ùå N√£o foi poss√≠vel garantir se√ß√µes para sala ${roomName}`);
            return false;
        }

        const roomTitle = roomElement.querySelector('.room-title');
        if (roomTitle && roomData.nome) {
            roomTitle.textContent = roomData.nome;
            console.log(`‚úÖ T√≠tulo da sala atualizado: ${roomData.nome}`);
        }

        if (roomData.inputs) {
            console.log(`üå°Ô∏è Preenchendo inputs de climatiza√ß√£o para sala ${roomName}`);
            fillClimatizationInputs(roomElement, roomData.inputs);
        }

        if (roomData.ganhosTermicos) {
            console.log(`üìä Preenchendo ganhos t√©rmicos para sala ${roomName}`);
            fillThermalGainsData(roomElement, roomData.ganhosTermicos);
        }

        if (roomData.capacidade) {
            console.log(`‚ö° Preenchendo dados de capacidade para sala ${roomName}`);
            fillCapacityData(roomElement, roomData.capacidade);
        }

        // ‚úÖ CORRE√á√ÉO: Atualizar para o novo sistema de equipamentos
        if (roomData.equipamentos && Array.isArray(roomData.equipamentos)) {
            console.log(`üîß Preenchendo ${roomData.equipamentos.length} equipamento(s) para sala ${roomName}`);
            fillEquipamentosData(roomElement, roomData.equipamentos);
        }

        if (roomData.maquinas && Array.isArray(roomData.maquinas)) {
            console.log(`ü§ñ Agendando preenchimento de ${roomData.maquinas.length} m√°quina(s) para sala ${roomName}`);
            
            // ‚úÖ Aumentar o tempo de espera para garantir que tudo esteja carregado
            setTimeout(async () => {
                try {
                    console.log(`üöÄ Iniciando preenchimento de m√°quinas para sala ${roomName}`);
                    
                    // ‚úÖ Verificar novamente se as se√ß√µes est√£o prontas
                    const sectionsReady = await ensureAllRoomSections(roomElement);
                    if (!sectionsReady) {
                        console.error(`‚ùå Se√ß√µes n√£o prontas para preencher m√°quinas`);
                        return;
                    }
                    
                    const success = await fillMachinesData(roomElement, roomData.maquinas);
                    
                    if (success) {
                        console.log(`üéâ Todas as m√°quinas preenchidas com sucesso para sala ${roomName}`);
                    } else {
                        console.error(`‚ùå Falha ao preencher m√°quinas para sala ${roomName}`);
                    }
                } catch (error) {
                    console.error(`üí• Erro ao preencher m√°quinas para sala ${roomName}:`, error);
                }
            }, 3000); // ‚úÖ Aumentado para 3 segundos
        }

        console.log(`‚úÖ Sala "${roomName}" preenchida com sucesso`);
        return true;

    } catch (error) {
        console.error(`‚ùå Erro ao preencher sala "${roomName}":`, error);
        return false;
    }
}

// EXPORTS NO FINAL
export {
    renderRoomFromData,
    populateRoomData
};
/* ==== FIM: data/builders/ui-folder/room-renderer.js ==== */

/* ==== IN√çCIO: data/modules/rooms.js ==== */
/**
 * data/modules/rooms.js
 * üéØ FUS√ÉO COMPLETA: room-operations.js + salas.js
 * ‚ö° REDU√á√ÉO: 2 arquivos ‚Üí 1 arquivo (~350 ‚Üí ~250 linhas)
 */

import { buildClimatizationSection } from './climatizacao.js';
import { buildMachinesSection } from './machines/machines-core.js';
import { buildEquipamentosSection, initEquipamentosSystem } from './equipamentos.js';
import { generateRoomId } from '../utils/id-generator.js';
import { removeEmptyProjectMessage, showEmptyProjectMessageIfNeeded } from '../../ui/helpers.js';
import { triggerCalculation, syncTitleToAmbienteDirect } from '../../core/shared-utils.js';

// Cache para m√≥dulo de m√°quinas
let machinesPreloadModule = null;

/**
 * üèóÔ∏è FUN√á√ïES DE CONSTRU√á√ÉO DE HTML (salas.js)
 */

/**
 * Constr√≥i o HTML completo de uma sala com todas as se√ß√µes
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML completo da sala
 */
function buildRoomHTML(obraId, projectId, roomName, roomId) {
    if (!obraId || obraId === 'undefined' || obraId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHTML) [Obra ID inv√°lido: ${obraId}]`);
        return '';
    }

    if (!projectId || projectId === 'undefined' || projectId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHTML) [Project ID inv√°lido: ${projectId}]`);
        return '';
    }

    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHTML) [Room ID inv√°lido: ${roomId}]`);
        return '';
    }

    console.log(`[BUILD ROOM] Par√¢metros:`, { obraId, projectId, roomName, roomId });
    console.log(`[BUILD ROOM] ID √öNICO: ${roomId}`);

    return `
      <div class="room-block" data-room-id="${roomId}" data-room-name="${roomName}" data-project-id="${projectId}" data-obra-id="${obraId}">
        <div class="room-header">
          <button class="minimizer" onclick="toggleRoom('${roomId}', event)">+</button>
          <h4 class="room-title editable-title" data-editable="true" onclick="makeEditable(this, 'room')">${roomName}</h4>
          <div class="room-actions">
            <button class="btn btn-delete" onclick="deleteRoom('${obraId}', '${projectId}', '${roomId}')">Remover</button>
          </div>
        </div>
        <div class="room-content collapsed" id="room-content-${roomId}">
          ${buildClimatizationSection(obraId, projectId, roomName, roomId)}
          ${buildMachinesSection(obraId, projectId, roomName, roomId)}
          ${buildEquipamentosSection(obraId, projectId, roomName, roomId)}
        
        </div>
      </div>
    `;
} //adicionar ao final de build as sessoes de tubula√ß√£o e dutos;

/**
 * Constr√≥i apenas o cabe√ßalho da sala com t√≠tulo e a√ß√µes
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML do cabe√ßalho da sala
 */
function buildRoomHeader(obraId, projectId, roomName, roomId) {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (buildRoomHeader) [Room ID inv√°lido: ${roomId}]`);
        return '';
    }

    return `
    <div class="room-header">
      <button class="minimizer" onclick="toggleRoom('${roomId}', event)">+</button>
      <h3 class="room-title editable-title" data-editable="true" onclick="makeEditable(this, 'room')">${roomName}</h3>
      <button class="btn btn-delete-small" onclick="deleteRoom('${obraId}', '${projectId}', '${roomId}')">Remover</button>
    </div>
  `;
}

/**
 * Constr√≥i a se√ß√£o de a√ß√µes da sala (reservado para futuras implementa√ß√µes)
 * @param {string} roomId - ID √∫nico da sala
 * @returns {string} HTML vazio
 */
function buildRoomActions(roomId) {
    return "";
}

/**
 * üîß FUN√á√ïES DE OPERA√á√ïES (room-operations.js)
 */

/**
 * Carrega o m√≥dulo de m√°quinas para pr√©-carregamento ass√≠ncrono
 * @returns {Promise<Object|null>} M√≥dulo de m√°quinas carregado
 */
async function loadMachinesPreloadModule() {
    if (!machinesPreloadModule) {
        try {
            machinesPreloadModule = await import('./machines/machines-core.js');
            console.log("‚úÖ M√≥dulo de m√°quinas carregado para pr√©-carregamento");
        } catch (error) {
            console.error("‚ùå Erro ao carregar m√≥dulo de m√°quinas:", error);
        }
    }
    return machinesPreloadModule;
}

/**
 * Cria uma nova sala vazia no projeto especificado
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto  
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala (opcional)
 * @returns {Promise<boolean>} True se a sala foi criada com sucesso
 */
async function createEmptyRoom(obraId, projectId, roomName, roomId) {
    console.log(`üîÑ Criando sala: ${roomName} na obra "${obraId}", projeto "${projectId}"`);

    if (!obraId || obraId === 'undefined' || obraId === 'null') {
        console.error(`ERRO FALBACK (createEmptyRoom) [Obra ID inv√°lido: ${obraId}]`);
        return false;
    }

    if (!projectId || projectId === 'undefined' || projectId === 'null') {
        console.error(`ERRO FALBACK (createEmptyRoom) [Project ID inv√°lido: ${projectId}]`);
        return false;
    }

    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);

    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);

        console.log('üîç Projetos dispon√≠veis no DOM:');
        document.querySelectorAll('.project-block').forEach(proj => {
            console.log(`  - Projeto: ${proj.dataset.projectName}, 
                         ProjectID: ${proj.dataset.projectId}, 
                         ObraID: ${proj.dataset.obraId}, 
                         ObraName: ${proj.dataset.obraName}`);
        });
        return false;
    }

    console.log(`‚úÖ Projeto encontrado:`, projectElement.dataset);

    let finalRoomId;

    if (roomId && roomId !== 'undefined' && roomId !== 'null' && !roomId.includes('undefined')) {
        finalRoomId = roomId;
    } else {
        const roomCount = getRoomCountInProject(obraId, projectId);
        finalRoomId = generateRoomId(projectElement, roomCount + 1);
    }

    finalRoomId = finalRoomId.toString()
        .replace(/-undefined/g, '')
        .replace(/-null/g, '')
        .trim();

    console.log(`üìù ID SEGURO DEFINITIVO DA SALA: "${finalRoomId}"`);

    try {
        const machinesModule = await loadMachinesPreloadModule();
        if (machinesModule && machinesModule.preloadMachinesDataForRoom) {
            await machinesModule.preloadMachinesDataForRoom(finalRoomId);
        }
    } catch (error) {
        console.error("‚ö†Ô∏è Aviso: N√£o foi poss√≠vel pr√©-carregar dados das m√°quinas:", error);
    }

    const roomHTML = buildRoomHTML(obraId, projectId, roomName, finalRoomId);

    const projectContent = projectElement.querySelector('.project-content');

    if (!projectContent) {
        console.error(`‚ùå Conte√∫do do projeto n√£o encontrado em ${projectId}`);
        return false;
    }

    removeEmptyProjectMessage(projectContent);

    const addRoomSection = projectContent.querySelector('.add-room-section');
    if (addRoomSection) {
        addRoomSection.insertAdjacentHTML('beforebegin', roomHTML);
    } else {
        projectContent.insertAdjacentHTML('beforeend', roomHTML);
    }

    console.log(`‚úÖ Sala ${roomName} criada (ID: ${finalRoomId}) na obra "${obraId}", projeto "${projectId}"`);

    initializeRoomComponents(obraId, projectId, roomName, finalRoomId);

    return true;
}

/**
 * Conta quantas salas j√° existem no projeto espec√≠fico
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @returns {number} Quantidade de salas no projeto
 */
function getRoomCountInProject(obraId, projectId) {
    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);
    if (!projectElement) return 0;

    const rooms = projectElement.querySelectorAll('.room-block');
    return rooms.length;
}

/**
 * Inicializa todos os componentes da sala ap√≥s cria√ß√£o
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomName - Nome da sala
 * @param {string} roomId - ID √∫nico da sala
 * @returns {void}
 */

function initializeRoomComponents(obraId, projectId, roomName, roomId) {
    console.log(`üîß INICIALIZA√á√ÉO COMPLETA DA SALA: ${roomName} (ID: ${roomId})`);

    // ‚úÖ CONFIGURA√á√ÉO COM TIMING CORRETO
    setTimeout(() => {
        console.log(`üéØ CONFIGURANDO TODAS AS SINCRONIZA√á√ïES PARA: ${roomId}`);

        // 1. SINCRONIZA√á√ÉO T√çTULO ‚Üî AMBIENTE (BIDIRECIONAL)
        setupBidirectionalTitleAmbienteSync(roomId, roomName);

        // 2. SINCRONIZA√á√ÉO PAREDES (APENAS PRIMEIRA INTERA√á√ÉO)
        setupFirstInteractionWallSync(roomId);

        // 3. SINCRONIZA√á√ÉO INICIAL DOS VALORES
        initializeDefaultValues(roomId, roomName);

        // 4. INICIALIZAR SISTEMA DE EQUIPAMENTOS
        initializeEquipamentosSystem(roomId);

        console.log(`‚úÖ TODAS AS SINCRONIZA√á√ïES CONFIGURADAS PARA: ${roomId}`);

    }, 1000);

    // Outras inicializa√ß√µes...
    setTimeout(async () => {
        try {
            const machinesModule = await import('./machines/machines-core.js');
            if (machinesModule.preloadMachinesDataForRoom) {
                await machinesModule.preloadMachinesDataForRoom(roomId);
                console.log(`‚úÖ Dados das m√°quinas pr√©-carregados para ${roomId}`);
            }
        } catch (error) {
            console.log(`‚ÑπÔ∏è N√£o foi poss√≠vel pr√©-carregar dados das m√°quinas para ${roomId}`);
        }
    }, 800);

    // ‚úÖ INICIALIZA√á√ÉO DE FATOR DE SEGURAN√áA
    setTimeout(() => {
        safeInitializeFatorSeguranca(roomId);
    }, 1200);

    // ‚úÖ VERIFICA√á√ÉO FINAL
    setTimeout(() => {
        console.log(`üîç VERIFICA√á√ÉO FINAL DA SALA: ${roomName} (ID: ${roomId})`);
        verifyRoomSetupComplete(roomId);
    }, 2000);
}

// ‚úÖ FUN√á√ÉO PARA SINCRONIZA√á√ÉO BIDIRECIONAL T√çTULO ‚Üî AMBIENTE
function setupBidirectionalTitleAmbienteSync(roomId, roomName) {
    console.log(`üîß CONFIGURANDO SINCRONIZA√á√ÉO BIDIRECIONAL T√çTULO‚ÜîAMBIENTE: ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) {
        console.error(`‚ùå Room block n√£o encontrado: ${roomId}`);
        return;
    }

    const roomTitle = roomBlock.querySelector('.room-title');
    const ambienteInput = findAmbienteInput(roomId);

    if (roomTitle && ambienteInput) {
        console.log(`‚úÖ Elementos encontrados para sincroniza√ß√£o bidirecional`);

        // ‚úÖ SINCRONIZA√á√ÉO INICIAL: T√≠tulo ‚Üí Ambiente
        if (!ambienteInput.value || ambienteInput.value.trim() === '' || ambienteInput.value === 'Sala1') {
            ambienteInput.value = roomTitle.textContent || roomName;
            console.log(`‚úÖ Sincroniza√ß√£o inicial: T√≠tulo ‚Üí Ambiente: "${ambienteInput.value}"`);
        }

        // ‚úÖ SINCRONIZA√á√ÉO CONT√çNUA: Ambiente ‚Üí T√≠tulo
        ambienteInput.addEventListener('input', function () {
            if (this.value && this.value.trim() !== '' && this.value !== roomTitle.textContent) {
                roomTitle.textContent = this.value;
                roomBlock.dataset.roomName = this.value;
                console.log(`üîÑ Ambiente ‚Üí T√≠tulo: "${this.value}"`);
                triggerCalculation(roomId);
            }
        });

        // ‚úÖ SINCRONIZA√á√ÉO CONT√çNUA: T√≠tulo ‚Üí Ambiente (via Observer para edi√ß√£o inline)
        setupTitleChangeObserver(roomTitle, roomId);

        console.log(`‚úÖ Sincroniza√ß√£o bidirecional T√≠tulo‚ÜîAmbiente configurada`);

    } else {
        console.error(`‚ùå Elementos n√£o encontrados para sincroniza√ß√£o:`, {
            roomTitle: !!roomTitle,
            ambienteInput: !!ambienteInput
        });
    }
}

// ‚úÖ FUN√á√ÉO PARA OBSERVAR MUDAN√áAS NO T√çTULO (edi√ß√£o inline)
function setupTitleChangeObserver(roomTitle, roomId) {
    let isEditing = false;

    // Observar quando entra em modo de edi√ß√£o
    roomTitle.addEventListener('click', function () {
        isEditing = true;
        console.log(`‚úèÔ∏è T√≠tulo em modo de edi√ß√£o: ${roomId}`);
    });

    // Observar mudan√ßas no conte√∫do do t√≠tulo
    const observer = new MutationObserver((mutations) => {
        if (!isEditing) return;

        mutations.forEach((mutation) => {
            if (mutation.type === 'characterData' || mutation.type === 'childList') {
                const newTitle = roomTitle.textContent.trim();
                if (newTitle && newTitle !== mutation.oldValue) {
                    console.log(`üéØ T√≠tulo alterado via edi√ß√£o inline: "${mutation.oldValue}" ‚Üí "${newTitle}"`);
                    syncTitleToAmbienteDirect(roomId, newTitle);
                }
            }
        });
    });

    // Observar quando sai do modo de edi√ß√£o (blur)
    roomTitle.addEventListener('blur', function () {
        isEditing = false;
        const newTitle = roomTitle.textContent.trim();
        if (newTitle) {
            console.log(`üíæ Edi√ß√£o conclu√≠da: "${newTitle}"`);
            syncTitleToAmbienteDirect(roomId, newTitle);
        }
    });

    observer.observe(roomTitle, {
        characterData: true,
        childList: true,
        subtree: true,
        characterDataOldValue: true
    });

    console.log(`‚úÖ Observer configurado para t√≠tulo da sala ${roomId}`);
}

// ‚úÖ FUN√á√ÉO PARA SINCRONIZA√á√ÉO DE PAREDES (APENAS PRIMEIRA INTERA√á√ÉO)
function setupFirstInteractionWallSync(roomId) {
    console.log(`üß± CONFIGURANDO SINCRONIZA√á√ÉO PAREDES (PRIMEIRA INTERA√á√ÉO): ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) {
        console.error(`‚ùå Room block n√£o encontrado: ${roomId}`);
        return;
    }

    // Buscar inputs de parede
    const paredeOeste = roomBlock.querySelector('input[data-field="paredeOeste"]');
    const paredeLeste = roomBlock.querySelector('input[data-field="paredeLeste"]');
    const paredeNorte = roomBlock.querySelector('input[data-field="paredeNorte"]');
    const paredeSul = roomBlock.querySelector('input[data-field="paredeSul"]');

    console.log(`üìä Elementos de parede encontrados:`, {
        paredeOeste: !!paredeOeste,
        paredeLeste: !!paredeLeste,
        paredeNorte: !!paredeNorte,
        paredeSul: !!paredeSul
    });

    // ‚úÖ SINCRONIZA√á√ÉO LESTE/OESTE (apenas primeira intera√ß√£o)
    if (paredeOeste && paredeLeste) {
        setupFirstInteractionWallPair(paredeOeste, paredeLeste, roomId, 'Oeste', 'Leste');
    } else {
        console.warn(`‚ö†Ô∏è Par Leste/Oeste incompleto para ${roomId}`);
    }

    // ‚úÖ SINCRONIZA√á√ÉO NORTE/SUL (apenas primeira intera√ß√£o)
    if (paredeNorte && paredeSul) {
        setupFirstInteractionWallPair(paredeNorte, paredeSul, roomId, 'Norte', 'Sul');
    } else {
        console.warn(`‚ö†Ô∏è Par Norte/Sul incompleto para ${roomId}`);
    }
}

// ‚úÖ FUN√á√ÉO PARA SINCRONIZA√á√ÉO DE PAR DE PAREDES (APENAS PRIMEIRA INTERA√á√ÉO)
function setupFirstInteractionWallPair(input1, input2, roomId, name1, name2) {
    console.log(`üîß Configurando par ${name1}/${name2} (primeira intera√ß√£o) para ${roomId}`);

    let firstInteraction1 = true;
    let firstInteraction2 = true;

    const placeholderValues = ['Ex: 5.5', 'Ex: 8.0', ''];

    // Input 1 ‚Üí Input 2 (apenas primeira intera√ß√£o)
    input1.addEventListener('input', function () {
        if (firstInteraction1 && this.value && !placeholderValues.includes(this.value)) {
            const shouldSync = !input2.value || placeholderValues.includes(input2.value);
            if (shouldSync && input2.value !== this.value) {
                input2.value = this.value;
                console.log(`üîÑ Primeira intera√ß√£o: ${name1} ‚Üí ${name2}: ${this.value}`);
                triggerCalculation(roomId);
            }
            firstInteraction1 = false;
        }
    });

    // Input 2 ‚Üí Input 1 (apenas primeira intera√ß√£o)
    input2.addEventListener('input', function () {
        if (firstInteraction2 && this.value && !placeholderValues.includes(this.value)) {
            const shouldSync = !input1.value || placeholderValues.includes(input1.value);
            if (shouldSync && input1.value !== this.value) {
                input1.value = this.value;
                console.log(`üîÑ Primeira intera√ß√£o: ${name2} ‚Üí ${name1}: ${this.value}`);
                triggerCalculation(roomId);
            }
            firstInteraction2 = false;
        }
    });

    console.log(`‚úÖ Sincroniza√ß√£o ${name1}/${name2} (primeira intera√ß√£o) configurada`);
}

// ‚úÖ FUN√á√ÉO PARA INICIALIZA√á√ÉO DOS VALORES PADR√ÉO
function initializeDefaultValues(roomId, roomName) {
    console.log(`‚ö° INICIALIZANDO VALORES PADR√ÉO PARA: ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) return;

    // Verificar e sincronizar valores iniciais das paredes
    const walls = [
        { field: 'paredeOeste', selector: 'input[data-field="paredeOeste"]' },
        { field: 'paredeLeste', selector: 'input[data-field="paredeLeste"]' },
        { field: 'paredeNorte', selector: 'input[data-field="paredeNorte"]' },
        { field: 'paredeSul', selector: 'input[data-field="paredeSul"]' }
    ];

    walls.forEach(wall => {
        const input = roomBlock.querySelector(wall.selector);
        if (input && input.value && input.value !== 'Ex: 5.5' && input.value !== 'Ex: 8.0') {
            syncOppositeWallInitial(roomId, wall.field, input.value);
        }
    });
}



// ‚úÖ FUN√á√ÉO AUXILIAR PARA SINCRONIZA√á√ÉO INICIAL DAS PAREDES
function syncOppositeWallInitial(roomId, field, value) {
    const oppositeMap = {
        'paredeOeste': 'paredeLeste',
        'paredeLeste': 'paredeOeste',
        'paredeNorte': 'paredeSul',
        'paredeSul': 'paredeNorte'
    };

    const oppositeField = oppositeMap[field];
    if (oppositeField) {
        const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
        if (roomBlock) {
            const oppositeInput = roomBlock.querySelector(`input[data-field="${oppositeField}"]`);
            if (oppositeInput && (!oppositeInput.value || oppositeInput.value === 'Ex: 5.5' || oppositeInput.value === 'Ex: 8.0')) {
                oppositeInput.value = value;
                console.log(`‚úÖ Sincroniza√ß√£o inicial ${field} ‚Üí ${oppositeField}: ${value}`);
            }
        }
    }
}

// ‚úÖ FUN√á√ÉO AUXILIAR PARA BUSCAR INPUT AMBIENTE
function findAmbienteInput(roomId) {
    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) return null;

    // Estrat√©gias de busca em ordem de prioridade
    return roomBlock.querySelector('input[data-field="ambiente"]') ||
        roomBlock.querySelector('input[placeholder*="ambiente" i]') ||
        roomBlock.querySelector('input[placeholder*="sala" i]');
}

async function initializeEquipamentosSystem(roomId) {
    console.log(`üîß Inicializando sistema de equipamentos para sala: ${roomId}`);

    try {
        // Verificar se a fun√ß√£o est√° dispon√≠vel
        if (typeof window.initEquipamentosSystem === 'function') {
            await window.initEquipamentosSystem(roomId);
            console.log(`‚úÖ Sistema de equipamentos inicializado para sala: ${roomId}`);
        } else {
            console.warn(`‚ö†Ô∏è Fun√ß√£o initEquipamentosSystem n√£o dispon√≠vel. Tentando importar...`);

            // Tentar importar dinamicamente
            const equipamentosModule = await import('./equipamentos.js');
            if (equipamentosModule && equipamentosModule.initEquipamentosSystem) {
                equipamentosModule.initEquipamentosSystem(roomId);
                console.log(`‚úÖ Sistema de equipamentos inicializado via import din√¢mico`);
            } else {
                console.error(`‚ùå N√£o foi poss√≠vel inicializar sistema de equipamentos`);
            }
        }
    } catch (error) {
        console.error(`‚ùå Erro ao inicializar sistema de equipamentos:`, error);
    }
}



// ‚úÖ FUN√á√ÉO PARA VERIFICA√á√ÉO COMPLETA DO SETUP
function verifyRoomSetupComplete(roomId) {
    console.log(`üîç VERIFICA√á√ÉO COMPLETA DA SALA: ${roomId}`);

    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    if (!roomBlock) {
        console.error(`‚ùå Room block n√£o encontrado: ${roomId}`);
        return false;
    }

    const elements = {
        'T√≠tulo': roomBlock.querySelector('.room-title'),
        'Ambiente': findAmbienteInput(roomId),
        'Parede Oeste': roomBlock.querySelector('input[data-field="paredeOeste"]'),
        'Parede Leste': roomBlock.querySelector('input[data-field="paredeLeste"]'),
        'Parede Norte': roomBlock.querySelector('input[data-field="paredeNorte"]'),
        'Parede Sul': roomBlock.querySelector('input[data-field="paredeSul"]')
    };

    let allFound = true;
    let foundCount = 0;

    Object.entries(elements).forEach(([name, element]) => {
        const found = !!element;
        if (!found) allFound = false;
        if (found) foundCount++;
        console.log(`üìä ${name}: ${found ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado'}`);
    });

    if (allFound) {
        console.log(`üéâ TODOS OS ${foundCount} ELEMENTOS ENCONTRADOS PARA: ${roomId}`);
    } else {
        console.warn(`‚ö†Ô∏è ${foundCount}/6 ELEMENTOS ENCONTRADOS PARA: ${roomId}`);
    }

    return allFound;
}

// ‚úÖ ADICIONAR FUN√á√ÉO GLOBAL PARA DEBUG
if (typeof window !== 'undefined') {
    window.debugRoomSync = function (roomId) {
        console.log(`üêõ DEBUG COMPLETO DA SALA: ${roomId}`);
        const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
        if (roomBlock) {
            console.log('üìã Elementos encontrados:');
            console.log('- T√≠tulo:', roomBlock.querySelector('.room-title')?.textContent);
            console.log('- Ambiente:', findAmbienteInput(roomId)?.value);
            console.log('- Parede Oeste:', roomBlock.querySelector('input[data-field="paredeOeste"]')?.value);
            console.log('- Parede Leste:', roomBlock.querySelector('input[data-field="paredeLeste"]')?.value);
            console.log('- Parede Norte:', roomBlock.querySelector('input[data-field="paredeNorte"]')?.value);
            console.log('- Parede Sul:', roomBlock.querySelector('input[data-field="paredeSul"]')?.value);

            // Testar sincroniza√ß√£o manual
            const roomTitle = roomBlock.querySelector('.room-title');
            if (roomTitle) {
                console.log('üîÑ Testando sincroniza√ß√£o t√≠tulo ‚Üí ambiente...');
                syncTitleToAmbienteDirect(roomId, roomTitle.textContent);
            }
        }
    };
}



/**
 * Fun√ß√£o auxiliar para inicializar fator de seguran√ßa de forma segura
 * @param {string} roomId - ID √∫nico da sala
 * @returns {void}
 */
function safeInitializeFatorSeguranca(roomId) {
    if (typeof window.initializeFatorSeguranca === 'function') {
        try {
            window.initializeFatorSeguranca(roomId);
            console.log(`‚úÖ Fator de seguran√ßa inicializado para ${roomId}`);
        } catch (error) {
            console.log(`‚ÑπÔ∏è Erro ao inicializar fator de seguran√ßa para ${roomId}:`, error.message);
        }
    } else {
        console.log(`‚ÑπÔ∏è initializeFatorSeguranca n√£o dispon√≠vel - aguardando carregamento`);
    }
}

/**
 * Insere o HTML de uma sala no conte√∫do do projeto
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomHTML - HTML da sala a ser inserida
 * @param {string} roomId - ID √∫nico da sala
 * @returns {void}
 */
function insertRoomIntoProject(obraId, projectId, roomHTML, roomId) {
    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);
    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);
        return;
    }

    const projectContent = projectElement.querySelector('.project-content');
    if (!projectContent) {
        console.error(`‚ùå Conte√∫do do projeto ${projectId} n√£o encontrado`);
        return;
    }

    const addRoomSection = projectContent.querySelector(".add-room-section");
    if (addRoomSection) {
        addRoomSection.insertAdjacentHTML("beforebegin", roomHTML);
    } else {
        projectContent.insertAdjacentHTML("beforeend", roomHTML);
    }

    removeEmptyProjectMessage(projectContent);
    console.log(`‚úÖ Sala inserida no projeto ${projectId} (ID √∫nico: ${roomId})`);
}

/**
 * Adiciona uma nova sala ao projeto
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @returns {Promise<void>}
 */
async function addNewRoom(obraId, projectId) {
    console.log(`‚ûï Adicionando nova sala √† obra "${obraId}", projeto "${projectId}"`);

    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);

    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);
        return;
    }

    const roomCount = getRoomCountInProject(obraId, projectId);
    const roomName = `Sala${roomCount + 1}`;

    await createEmptyRoom(obraId, projectId, roomName, null);
    console.log(`‚úÖ ${roomName} adicionada √† obra "${obraId}", projeto "${projectId}"`);
}

/**
 * Adiciona uma nova sala ao projeto (alias para compatibilidade)
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @returns {Promise<void>}
 */
async function addNewRoomToProject(obraId, projectId) {
    console.log(`‚ûï Adicionando nova sala √† obra "${obraId}", projeto "${projectId}"`);

    const projectElement = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`);

    if (!projectElement) {
        console.error(`‚ùå Projeto ${projectId} n√£o encontrado na obra ${obraId}`);
        return;
    }

    const roomCount = getRoomCountInProject(obraId, projectId);
    const roomName = `Sala${roomCount + 1}`;

    await createEmptyRoom(obraId, projectId, roomName, null);
    console.log(`‚úÖ ${roomName} adicionada √† obra "${obraId}", projeto "${projectId}"`);
}

/**
 * Fun√ß√£o de compatibilidade para c√≥digo existente que usa apenas projectName
 * @param {string} projectName - Nome do projeto
 * @returns {Promise<void>}
 */
async function addNewRoomLegacy(projectName) {
    const projectBlock = document.querySelector(`[data-project-name="${projectName}"]`);
    const obraId = projectBlock?.dataset.obraId;
    const projectId = projectBlock?.dataset.projectId;

    if (obraId && projectId) {
        return addNewRoomToProject(obraId, projectId);
    } else {
        console.error('‚ùå N√£o foi poss√≠vel determinar a obra do projeto:', projectName);
    }
}

/**
 * Remove uma sala do projeto ap√≥s confirma√ß√£o do usu√°rio
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @param {string} roomId - ID √∫nico da sala a ser removida
 * @returns {void}
 */
function deleteRoom(obraId, projectId, roomId) {
    const roomBlock = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"][data-room-id="${roomId}"]`);

    if (!roomBlock) {
        console.error(`‚ùå Sala com ID ${roomId} n√£o encontrada no projeto ${projectId}, obra ${obraId}`);
        return;
    }

    const roomName = roomBlock.dataset.roomName;
    const projectContent = roomBlock.closest(".project-content");

    roomBlock.remove();

    if (projectContent && typeof window.showEmptyProjectMessageIfNeeded === 'function') {
        window.showEmptyProjectMessageIfNeeded(projectContent);
    }

    console.log(`üóëÔ∏è Sala ${roomName} (ID: ${roomId}) removida da obra "${obraId}", projeto "${projectId}"`);
}

/**
 * Fun√ß√£o de compatibilidade para c√≥digo existente que usa apenas projectName e roomName
 * @param {string} projectName - Nome do projeto
 * @param {string} roomName - Nome da sala
 * @returns {void}
 */
function deleteRoomLegacy(projectName, roomName) {
    const projectBlock = document.querySelector(`[data-project-name="${projectName}"]`);
    const obraId = projectBlock?.dataset.obraId;
    const projectId = projectBlock?.dataset.projectId;

    if (obraId && projectId) {
        const roomBlock = document.querySelector(`[data-obra-id="${obraId}"][data-project-id="${projectId}"][data-room-name="${roomName}"]`);
        const roomId = roomBlock?.dataset.roomId;

        if (roomId) {
            return deleteRoom(obraId, projectId, roomId);
        } else {
            console.error(`‚ùå ID da sala ${roomName} n√£o encontrado`);
        }
    } else {
        console.error('‚ùå N√£o foi poss√≠vel determinar a obra do projeto:', projectName);
    }
}

/**
 * Corrige inputs de fator de seguran√ßa que estejam vazios
 * Aplica valores padr√£o baseados nas constantes do sistema
 * @returns {void}
 */
function fixExistingCapacityInputs() {
    console.log('üîÑ Verificando inputs de capacidade existentes...');

    const roomBlocks = document.querySelectorAll('.room-block');

    roomBlocks.forEach(roomBlock => {
        const roomId = roomBlock.dataset.roomId;
        const roomName = roomBlock.dataset.roomName;
        const projectBlock = roomBlock.closest('.project-block');
        const projectId = projectBlock?.dataset.projectId;
        const obraId = projectBlock?.dataset.obraId;

        if (roomId) {
            const input = document.getElementById(`fator-seguranca-${roomId}`);

            if (input && input.value === '') {
                const valor = window.systemConstants?.FATOR_SEGURANCA_CAPACIDADE.value || 10;
                input.value = valor;
                console.log(`‚úÖ Input ${roomId} : ${valor}% (Obra: ${obraId}, Projeto: ${projectId})`);
            }
        }
    });
}

// Executar quando o projeto for carregado
document.addEventListener('DOMContentLoaded', function () {
    setTimeout(fixExistingCapacityInputs, 2000);
});

/**
 * üåê EXPORTA√á√ïES E COMPATIBILIDADE GLOBAL
 */

// Exporta√ß√µes para m√≥dulos ES6
export {
    // Constru√ß√£o
    buildRoomHTML,
    buildRoomHeader,
    buildRoomActions,

    // Opera√ß√µes
    createEmptyRoom,
    insertRoomIntoProject,
    addNewRoom,
    deleteRoom,
    deleteRoomLegacy,
    safeInitializeFatorSeguranca,
    addNewRoomToProject,

    // Utilit√°rios
    getRoomCountInProject,
    initializeRoomComponents,
    fixExistingCapacityInputs,
    loadMachinesPreloadModule,


    triggerCalculation,
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
    window.addNewRoom = addNewRoom;
    window.deleteRoom = deleteRoom;
    window.addNewRoomToProject = addNewRoomToProject;
    window.createEmptyRoom = createEmptyRoom;
    window.safeInitializeFatorSeguranca = safeInitializeFatorSeguranca;
    window.buildRoomHTML = buildRoomHTML;
}
/* ==== FIM: data/modules/rooms.js ==== */

/* ==== IN√çCIO: main-folder/system-init.js ==== */
/* ==== IN√çCIO: main-folder/system-init.js ==== */
/**
 * system-init.js - INICIALIZA√á√ÉO DO SISTEMA PRINCIPAL
 * üéØ Carrega constantes, m√≥dulos e componentes principais
 */

// ‚úÖ IMPORTAR M√ìDULOS COM CAMINHOS CORRETOS
import { loadObrasFromServer } from '../data/adapters/obra-adapter.js';
import { getGeralCount } from '../data/adapters/session-adapter.js';
import { shutdownManual } from '../data/adapters/shutdown-adapter.js';
import EmpresaCadastroInline from '../data/builders/empresa-cadastro-inline.js';

// üî• Importar m√≥dulo de filtros separado
import { initializeFilterSystem } from './filter-init.js';

/**
 * Sistema de Shutdown Manual
 */
class ShutdownManager {
  constructor() {
    this.init();
  }

  init() {
    console.log('üîí Sistema de shutdown manual ativado');
    this.disableAutoShutdown();
    this.createShutdownButton();
  }

  disableAutoShutdown() {
    window.removeEventListener('beforeunload', this.autoShutdown);
    window.removeEventListener('unload', this.autoShutdown);
    window.removeEventListener('pagehide', this.autoShutdown);
  }

  createShutdownButton() {
    if (document.querySelector('.shutdown-btn')) return;

    const headerRight = document.querySelector('.header-right');
    if (headerRight) {
      const shutdownBtn = document.createElement('button');
      shutdownBtn.className = 'shutdown-btn';
      shutdownBtn.innerHTML = '‚èª';
      shutdownBtn.title = 'Encerrar Servidor';
      shutdownBtn.onclick = () => this.shutdownManual();

      headerRight.appendChild(shutdownBtn);
      console.log('‚úÖ Bot√£o de shutdown adicionado ao header');
    }
  }

  async shutdownManual() {
    if (confirm('Deseja realmente ENCERRAR o servidor?')) {
      try {
        console.log('üîÑ Executando shutdown COMPLETO...');
        await shutdownManual();
      } catch (error) {
        console.log('üîå Servidor encerrado ou n√£o responde:', error);
      }
    }
  }
}

/**
 * Carrega as constantes do sistema do servidor
 */
async function loadSystemConstants() {
  try {
    console.log("üîç Carregando constantes do sistema...");
    const response = await fetch(`/constants`);

    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }

    const constantsData = await response.json();
    window.systemConstants = constantsData;
    console.log("‚úÖ Constantes carregadas do JSON:", window.systemConstants);

    if (!window.systemConstants.VARIAVEL_PD.value
      || !window.systemConstants.VARIAVEL_PS.value
    ) {
      throw new Error("Constantes essenciais n√£o encontradas no JSON");
    }

    return true;
  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao carregar constantes:", error);
    throw error;
  }
}

/**
 * Carrega todos os m√≥dulos do sistema dinamicamente
 */
async function loadAllModules() {
  if (window.modulesLoaded) return;

  try {
    console.log("üì¶ Iniciando carregamento de m√≥dulos...");

    const modules = await Promise.all([
      import('../ui/interface.js'),
      import('../ui/components/edit.js'),
      import('../ui/components/status.js'),
      import('../ui/components/modal/modal.js'),
      import('../ui/components/modal/exit-modal.js'),
      import('../ui/helpers.js'),
      import('../features/managers/obra-manager.js'),
      import('../features/managers/project-manager.js'),
      import('../data/modules/rooms.js'),
      import('../data/modules/climatizacao.js'),
      import('../data/modules/equipamentos.js'),
      import('../data/modules/machines/machines-core.js'),
      import('../data/modules/machines/capacity-calculator.js'),
      import('../features/calculations/air-flow.js'),
      import('../features/calculations/calculations-core.js'),
      import('../data/utils/id-generator.js'),
      import('../data/utils/data-utils.js'),
      import('../data/builders/ui-builders.js'),
      import('../data/builders/data-builders.js')
    ]);

    const [
      interfaceModule,
      editModule,
      statusModule,
      modalModule,
      modalExitModule,
      helpersModule,
      obraManagerModule,
      projectManagerModule,
      roomsModule,
      climatizationModule,
      equipamentosModule,
      machinesCoreModule,
      capacityCalculatorModule,
      airFlowModule,
      calculationsCoreModule,
      idGeneratorModule,
      dataUtilsModule,
      uiBuildersModule,
      dataBuildersModule
    ] = modules;

    const allFunctions = {
      toggleSection: interfaceModule.toggleSection,
      toggleSubsection: interfaceModule.toggleSubsection,
      toggleObra: interfaceModule.toggleObra,
      toggleProject: interfaceModule.toggleProject,
      toggleRoom: interfaceModule.toggleRoom,
      collapseElement: helpersModule.collapseElement,
      expandElement: helpersModule.expandElement,
      showSystemStatus: statusModule.showSystemStatus,

      addNewObra: obraManagerModule.addNewObra,
      saveOrUpdateObra: obraManagerModule.saveObra,
      verifyObraData: obraManagerModule.verifyObraData,
      deleteObra: obraManagerModule.deleteObra,
      saveObra: obraManagerModule.saveObra,
      fetchObras: obraManagerModule.fetchObras,
      supportFrom_saveObra: obraManagerModule.supportFrom_saveObra,
      atualizarObra: obraManagerModule.atualizarObra,

      addNewProjectToObra: projectManagerModule.addNewProjectToObra,
      deleteProject: projectManagerModule.deleteProject,

      addNewRoom: roomsModule.addNewRoom,
      deleteRoom: roomsModule.deleteRoom,
      createEmptyRoom: roomsModule.createEmptyRoom,

      buildClimatizationSection: climatizationModule.buildClimatizationSection,
      buildMachinesSection: machinesCoreModule.buildMachinesSection,

      buildEquipamentosSection: equipamentosModule.buildEquipamentosSection,
      initEquipamentosSystem: equipamentosModule.initEquipamentosSystem,
      carregarTiposEquipamentos: equipamentosModule.carregarTiposEquipamentos,
      loadEquipamentoDimensoes: equipamentosModule.loadEquipamentoDimensoes,
      adicionarEquipamento: equipamentosModule.adicionarEquipamento,
      salvarEquipamentos: equipamentosModule.salvarEquipamentos,
      carregarEquipamentos: equipamentosModule.carregarEquipamentos,
      limparEquipamentos: equipamentosModule.limparEquipamentos,

      calculateVazaoArAndThermalGains: airFlowModule.calculateVazaoArAndThermalGains,
      calculateVazaoArAndThermalGainsDebounced: calculationsCoreModule.calculateVazaoArAndThermalGainsDebounced,

      calculateCapacitySolution: capacityCalculatorModule.calculateCapacitySolution,
      updateBackupConfiguration: capacityCalculatorModule.updateBackupConfiguration,
      toggleOption: machinesCoreModule.toggleOption,
      addMachine: machinesCoreModule.addMachine,
      deleteMachine: machinesCoreModule.deleteMachine,

      makeEditable: editModule.makeEditable,

      ensureStringId: idGeneratorModule.ensureStringId,
      getNextObraNumber: dataUtilsModule.getNextObraNumber,
      getNextProjectNumber: dataUtilsModule.getNextProjectNumber,
      getNextRoomNumber: dataUtilsModule.getNextRoomNumber,

      showConfirmationModal: modalModule.showConfirmationModal,
      closeConfirmationModal: modalModule.closeConfirmationModal,
      undoDeletion: modalModule.undoDeletion,

      removeEmptyObraMessage: helpersModule.removeEmptyObraMessage,
      showEmptyObraMessageIfNeeded: helpersModule.showEmptyObraMessageIfNeeded,
      removeEmptyProjectMessage: helpersModule.removeEmptyProjectMessage,
      showEmptyProjectMessageIfNeeded: helpersModule.showEmptyProjectMessageIfNeeded,

      populateObraData: uiBuildersModule.populateObraData,
      renderObraFromData: uiBuildersModule.renderObraFromData,
      renderProjectFromData: uiBuildersModule.renderProjectFromData,
      renderRoomFromData: uiBuildersModule.renderRoomFromData,
      fillMachinesData: uiBuildersModule.fillMachinesData,
      fillClimatizationInputs: uiBuildersModule.fillClimatizationInputs,
      fillThermalGainsData: uiBuildersModule.fillThermalGainsData,
      fillCapacityData: uiBuildersModule.fillCapacityData,
      fillEquipamentosData: uiBuildersModule.fillEquipamentosData,
      ensureAllRoomSections: uiBuildersModule.ensureAllRoomSections,
      ensureMachinesSection: uiBuildersModule.ensureMachinesSection,
      populateMachineData: uiBuildersModule.populateMachineData,

      buildObraData: dataBuildersModule.buildObraData,
      buildProjectData: dataBuildersModule.buildProjectData,
      extractRoomData: dataBuildersModule.extractRoomData,
      extractMachinesData: dataBuildersModule.extractMachinesData,
      extractThermalGainsData: dataBuildersModule.extractThermalGainsData,
      extractClimatizationInputs: dataBuildersModule.extractClimatizationInputs,
      extractCapacityData: dataBuildersModule.extractCapacityData,
      extractEquipamentosData: dataBuildersModule.extractEquipamentosData,

      loadObrasFromServer: loadObrasFromServer
    };

    window.systemFunctions = {};

    Object.keys(allFunctions).forEach(funcName => {
      if (typeof allFunctions[funcName] === 'function') {
        window[funcName] = allFunctions[funcName];
        window.systemFunctions[funcName] = allFunctions[funcName];
        console.log(`‚úÖ ${funcName} atribu√≠da ao window e systemFunctions`);
      }
    });

    window.modulesLoaded = true;
    console.log("‚úÖ Todos os m√≥dulos foram carregados com sucesso");
    return true;

  } catch (error) {
    console.error("‚ùå Erro ao carregar m√≥dulos:", error);
    throw error;
  }
}

/**
 * Inicializa o sistema de cadastro de empresas
 */
async function initializeEmpresaCadastro() {
  try {
    console.log("üè¢ Inicializando sistema de cadastro de empresas...");

    await new Promise(resolve => setTimeout(resolve, 500));

    window.empresaCadastro = new EmpresaCadastroInline();

    console.log("‚úÖ Sistema de cadastro de empresas inicializado");

    const spansCadastro = document.querySelectorAll('.projetc-header-record.very-dark span');
    console.log(`üîç Encontrados ${spansCadastro.length} elementos de cadastro de empresas`);

    return true;
  } catch (error) {
    console.error("‚ùå Erro ao inicializar sistema de cadastro de empresas:", error);
    throw error;
  }
}

/**
 * Inicializa o sistema completo
 */
export async function initializeSystem() {
  try {
    console.log("üöÄ [SYSTEM-INIT] Iniciando sistema completo...");

    window.systemLoadingStart = Date.now();

    console.log("üîí [SYSTEM-INIT] Inicializando shutdown manager...");
    window.shutdownManager = new ShutdownManager();

    console.log("üìä [SYSTEM-INIT] Carregando constantes do sistema...");
    await loadSystemConstants();
    console.log("‚úÖ [SYSTEM-INIT] Constantes carregadas");

    console.log("üì¶ [SYSTEM-INIT] Carregando m√≥dulos do sistema...");
    await loadAllModules();
    console.log("‚úÖ [SYSTEM-INIT] M√≥dulos carregados");

    console.log("üè¢ [SYSTEM-INIT] Inicializando sistema de empresas...");
    await initializeEmpresaCadastro();
    console.log("‚úÖ [SYSTEM-INIT] Sistema de empresas inicializado");

    console.log("üîß [SYSTEM-INIT] Inicializando sistema de filtros...");
    await initializeFilterSystem();
    console.log("‚úÖ [SYSTEM-INIT] Sistema de filtros inicializado");

    const loadingTime = Date.now() - window.systemLoadingStart;
    window.systemLoaded = true;
    window.systemLoadTime = loadingTime;

    console.log(`üéâ [SYSTEM-INIT] Sistema completamente inicializado em ${loadingTime}ms!`);

    const event = new CustomEvent('systemInitialized', {
      detail: {
        time: loadingTime,
        timestamp: new Date().toISOString(),
        modules: window.modulesLoaded,
        constants: !!window.systemConstants
      }
    });
    document.dispatchEvent(event);

    return true;

  } catch (error) {
    console.error("‚ùå [SYSTEM-INIT] ERRO CR√çTICO na inicializa√ß√£o do sistema:", error);
    throw error;
  }
}
/* ==== FIM: main-folder/system-init.js ==== */
/* ==== FIM: main-folder/system-init.js ==== */
