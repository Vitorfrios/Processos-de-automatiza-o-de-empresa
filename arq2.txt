/**
 * ORQUESTRADOR PRINCIPAL - data-utils.js
 * Mant√©m compatibilidade com imports existentes enquanto delega para m√≥dulos especializados
 */


console.log('üîÑ data-utils.js carregado - vers√£o modularizada')


export {
    buildObraData,
    buildProjectData,
    extractRoomData
} from './data-files/data-builders.js'

export {
    extractThermalGainsData,
    extractClimatizationInputs,
    extractMachinesData,
    extractClimatizationMachineData,
    extractCapacityData,
    extractConfigurationData
} from './data-files/data-extractors.js'

export {
    generateObraId,
    generateProjectId,
    generateRoomId,
    getRoomFullId,
    extractNumberFromText,
    getObraName,
    getProjectName,
    getRoomName,
    getMachineName,
    parseMachinePrice,
    safeNumber,
    debugThermalGainsElements
} from './data-files/data-utils-core.js'

console.log('‚úÖ data-utils.js carregado com sucesso - estrutura modularizada ativa')
/**
 * rooms.js
 * M√≥dulo de salas - SISTEMA CORRIGIDO COM IDs √öNICOS
 */

import { 
  createEmptyRoom, 
  insertRoomIntoProject, 
  addNewRoom, 
  deleteRoom 
} from './modules/room-operations.js'

import { 
  buildRoomHTML, 
  buildRoomHeader, 
  buildRoomActions 
} from './modules/salas.js'

import { 
  buildClimatizationSection,
  buildClimatizationTable,
  buildClimaRow,
  buildClimaCell,
  buildSelectInput,
  buildTextInput,
  buildResultRow,
  buildThermalGainsSection
} from './modules/climatizacao.js'

import { 
  buildMachinesSection,
  addMachine,
  deleteClimatizationMachine,
  calculateCapacitySolution,
  updateCapacityFromThermalGains,
  initializeStaticCapacityTable
} from './modules/maquinas.js';

import { 
  buildConfigurationSection 
} from './modules/configuracao.js'

window.calculateCapacitySolution = calculateCapacitySolution;
window.updateCapacityFromThermalGains = updateCapacityFromThermalGains;
window.initializeStaticCapacityTable = initializeStaticCapacityTable;

/**
 * Inicializa todos os inputs de capacidade com valores padr√£o do sistema
 * Aplica o fator de seguran√ßa padr√£o a todos os campos de capacidade vazios
 * @returns {void}
 */
function initializeAllCapacityInputs() {
  console.log('[INIT] Inicializando todos os inputs de capacidade...');
  
  // Verificar se systemConstants est√° dispon√≠vel
  if (!window.systemConstants || window.systemConstants.FATOR_SEGURANCA_CAPACIDADE === undefined) {
    console.error('[INIT] ‚ùå systemConstants n√£o carregado - abortando inicializa√ß√£o');
    return;
  }
  
  // ‚úÖ CORRE√á√ÉO: Buscar inputs por data attributes em vez de apenas ID
  const inputs = document.querySelectorAll('input[id^="fator-seguranca-"]');
  const valor = window.systemConstants.FATOR_SEGURANCA_CAPACIDADE;
  
  inputs.forEach(input => {
    // ‚úÖ CORRE√á√ÉO: Validar que o input pertence a uma sala v√°lida
    const roomId = input.id.replace('fator-seguranca-', '');
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    
    if (roomElement && input.value === '') {
      input.value = valor;
      console.log(`[INIT] ‚úÖ ${input.id} inicializado: ${valor}% (Sala: ${roomId})`);
    }
  });
}

// Executar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
  // Tentar inicializar ap√≥s um delay
  setTimeout(initializeAllCapacityInputs, 3000);
});

/**
 * For√ßa a reinicializa√ß√£o dos inputs de capacidade quando systemConstants estiver dispon√≠vel
 * √ötil para quando as constantes do sistema s√£o carregadas de forma ass√≠ncrona
 * @returns {void}
 */
window.reinitializeCapacityInputs = function() {
  console.log('[REINIT] Reinicializando inputs de capacidade...');
  initializeAllCapacityInputs();
};

/**
 * Gera um ID √∫nico para uma sala baseado em obra, projeto e nome da sala
 * Inclui timestamp para garantir unicidade - FUN√á√ÉO LEGACY
 * @param {string} obraName - Nome da obra
 * @param {string} projectName - Nome do projeto
 * @param {string} roomName - Nome da sala
 * @returns {string} ID √∫nico gerado para a sala
 */
function generateUniqueRoomId(obraName, projectName, roomName) {
    const baseId = roomName.toLowerCase().replace(/\s+/g, '-');
    const timestamp = Date.now().toString().slice(-6);
    return `${obraName}-${projectName}-${baseId}-${timestamp}`.replace(/\s+/g, '-');
}



/**
 * Encontra uma sala no DOM pelo seu ID √∫nico
 * Retorna informa√ß√µes completas da sala incluindo obra e projeto
 * @param {string} roomId - ID √∫nico da sala
 * @returns {Object|null} Objeto com dados da sala ou null se n√£o encontrada
 */
function findRoomByUniqueId(roomId) {
    // ‚úÖ CORRE√á√ÉO: Buscar APENAS por data-room-id
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (roomElement) {
        return {
            element: roomElement,
            obraId: roomElement.dataset.obraId,
            obraName: roomElement.dataset.obraName,
            projectId: roomElement.dataset.projectId,
            projectName: roomElement.dataset.projectName,
            roomName: roomElement.dataset.roomName
        };
    }
    return null;
}

/**
 * Encontra todas as salas de um projeto espec√≠fico
 * @param {string} obraId - ID √∫nico da obra
 * @param {string} projectId - ID √∫nico do projeto
 * @returns {Array} Lista de elementos de sala
 */
function findRoomsByProject(obraId, projectId) {
    // ‚úÖ CORRE√á√ÉO: Buscar por IDs √∫nicos
    return Array.from(document.querySelectorAll(`[data-obra-id="${obraId}"][data-project-id="${projectId}"]`));
}

/**
 * Obt√©m informa√ß√µes completas de uma sala pelo ID
 * @param {string} roomId - ID √∫nico da sala
 * @returns {Object|null} Informa√ß√µes da sala
 */
function getRoomInfo(roomId) {
    const roomData = findRoomByUniqueId(roomId);
    if (!roomData) return null;
    
    return {
        ...roomData,
        fullId: roomId,
        isSecureId: roomId.includes('_proj_') && roomId.includes('_sala_')
    };
}

// Exporta√ß√µes atualizadas - FUN√á√ïES PRINCIPAIS V√äM DO room-operations.js
export {
  // Projeto - FUN√á√ïES DO room-operations.js
  createEmptyRoom,
  insertRoomIntoProject,
  addNewRoom,
  deleteRoom,
  
  // Salas
  buildRoomHTML,
  buildRoomHeader,
  buildRoomActions,
  
  // Fun√ß√µes auxiliares de IDs √∫nicos
  generateUniqueRoomId,
  findRoomByUniqueId,
  findRoomsByProject,
  getRoomInfo,
  
  // Climatiza√ß√£o
  buildClimatizationSection,
  buildClimatizationTable,
  buildClimaRow,
  buildClimaCell,
  buildSelectInput,
  buildTextInput,
  buildResultRow,
  buildThermalGainsSection,
  
  // M√°quinas
  buildMachinesSection,
  addMachine,
  deleteClimatizationMachine,
  initializeAllCapacityInputs, 
  
  // Configura√ß√£o
  buildConfigurationSection
}

// Disponibilizar fun√ß√µes globalmente
if (typeof window !== 'undefined') {
    window.generateUniqueRoomId = generateUniqueRoomId;
    window.findRoomByUniqueId = findRoomByUniqueId;
    window.findRoomsByProject = findRoomsByProject;
    window.getRoomInfo = getRoomInfo;
}
// server.js - ARQUIVO PRINCIPAL ORQUESTRADOR

// Importar m√≥dulos
import { 
    isSessionActive, 
    setSessionActive, 
    getSessionObras, 
    addObraToSession,
    removeObraFromSessionLocal,
    clearSessionObras,
    clearRenderedObras,
    initializeGeralCount,
    incrementGeralCount,
    decrementGeralCount,
    getGeralCount,
    saveFirstObraIdOfSession,
    addObraToRemovedList,
    getRemovedObrasList,
    isObraRemoved,
    resetDisplayLogic,
    startNewSession,
    startSessionOnFirstSave
} from './adapters/session-adapter.js';

import { 
    loadObrasFromServer,
    removeBaseObraFromHTML
} from './adapters/obra-adapter.js';

import { 
    shutdownManual,
    ensureSingleActiveSession,
    initializeSession
} from './adapters/shutdown-adapter.js';

// Re-exportar todas as fun√ß√µes
export {
    // Session Manager
    isSessionActive,
    setSessionActive,
    getSessionObras,
    addObraToSession,
    removeObraFromSessionLocal,
    clearSessionObras,
    clearRenderedObras,
    initializeGeralCount,
    incrementGeralCount,
    decrementGeralCount,
    getGeralCount,
    saveFirstObraIdOfSession,
    addObraToRemovedList,
    getRemovedObrasList,
    isObraRemoved,
    resetDisplayLogic,
    startNewSession,
    startSessionOnFirstSave,
    
    // Obra Loader
    loadObrasFromServer,
    removeBaseObraFromHTML,
    
    // Shutdown Manager
    shutdownManual,
    ensureSingleActiveSession,
    initializeSession
};

// Inicializa√ß√£o
initializeGeralCount();
