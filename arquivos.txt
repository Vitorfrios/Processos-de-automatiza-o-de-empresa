
/* ==== IN√çCIO: air-flow.js ==== */
/**
 * features/calculations/air-flow.js
 * Sistema unificado de c√°lculos de vaz√£o de ar - FUS√ÉO: airFlowCalculations.js + airFlowDisplay.js
 * C√°lculos de fluxo de ar baseados em pressuriza√ß√£o e portas
 */

import { CALCULATION_CONSTANTS } from '../../core/constants.js';
import {  
    waitForSystemConstants, 
    validateSystemConstants, 
    collectClimatizationInputs,
    findClimatizationSection,
    safeNumber 
} from './calculations-core.js';

// =============================================================================
// C√ÅLCULOS DE FLUXO DE AR
// =============================================================================

/**
 * Calcula fluxo de ar individual por porta
 * @param {number} doorCount - N√∫mero de portas
 * @param {number} doorVariable - Vari√°vel espec√≠fica da porta
 * @param {number} pressure - Pressuriza√ß√£o em Pa
 * @returns {number} Fluxo de ar em m¬≥/h
 */
function calculateDoorFlow(doorCount, doorVariable, pressure) {
    const count = safeNumber(doorCount);
    const variable = safeNumber(doorVariable);
    const press = safeNumber(pressure);

    const pressureExponent = press > 0 ? Math.pow(press, CALCULATION_CONSTANTS.PRESSURE_EXPONENT) : 0;

    return CALCULATION_CONSTANTS.FLOW_COEFFICIENT *
           count *
           variable *
           pressureExponent *
           CALCULATION_CONSTANTS.SECONDS_PER_HOUR;
}

/**
 * Calcula vaz√£o total de ar baseada em portas e pressuriza√ß√£o
 * @param {Object} inputData - Dados de entrada
 * @returns {number} Vaz√£o total em l/s
 */
function computeAirFlowRate(inputData) {
    const numPortasDuplas = safeNumber(inputData.numPortasDuplas);
    const numPortasSimples = safeNumber(inputData.numPortasSimples);
    const pressure = inputData.pressurizacao ? safeNumber(inputData.setpointTemp) : 0;

    // Valida√ß√£o de constantes
    if (!window.systemConstants?.VARIAVEL_PD || !window.systemConstants?.VARIAVEL_PS) {
        console.error("Constantes do sistema n√£o dispon√≠veis");
        return 0;
    }

    const doubleDoorFlow = calculateDoorFlow(numPortasDuplas, window.systemConstants.VARIAVEL_PD, pressure);
    const singleDoorFlow = calculateDoorFlow(numPortasSimples, window.systemConstants.VARIAVEL_PS, pressure);

    const totalFlow = doubleDoorFlow + singleDoorFlow;
    const adjustedFlow = totalFlow / CALCULATION_CONSTANTS.FLOW_DIVISOR;
    const finalFlow = adjustedFlow * CALCULATION_CONSTANTS.SAFETY_FACTOR;

    return Math.ceil(finalFlow);
}

// =============================================================================
// ORQUESTRA√á√ÉO DE C√ÅLCULOS
// =============================================================================

/**
 * Executa c√°lculo completo de vaz√£o de ar
 * @param {string} roomId - ID √∫nico da sala
 * @param {boolean} calculateThermal - Calcular ganhos t√©rmicos ap√≥s
 * @returns {Promise<number>} Vaz√£o calculada em l/s
 */
async function calculateVazaoAr(roomId, calculateThermal = true) {
    try {
        if (!roomId) {
            console.error("ID de sala inv√°lido");
            return 0;
        }

        await waitForSystemConstants();

        if (!validateSystemConstants()) {
            console.error("Constantes do sistema inv√°lidas");
            return 0;
        }

        const climaSection = findClimatizationSection(roomId);
        if (!climaSection) {
            console.error(`Se√ß√£o de climatiza√ß√£o n√£o encontrada: ${roomId}`);
            return 0;
        }

        const inputData = collectClimatizationInputs(climaSection, roomId);
        const flowRate = computeAirFlowRate(inputData);

        updateFlowRateDisplay(roomId, flowRate);

        // C√°lculo de ganhos t√©rmicos se solicitado
        if (calculateThermal) {
            const { calculateThermalGains } = await import('./thermal-gains.js');
            await calculateThermalGains(roomId, flowRate);
        }

        return flowRate;

    } catch (error) {
        console.error(`Erro no c√°lculo de vaz√£o para ${roomId}:`, error);
        return 0;
    }
}

/**
 * Coordena c√°lculo sequencial de vaz√£o e ganhos t√©rmicos
 * @param {string} roomId - ID √∫nico da sala
 * @returns {Promise<void>}
 */
async function calculateVazaoArAndThermalGains(roomId) {
    try {
        if (!roomId) {
            console.error("ID de sala inv√°lido");
            return;
        }
        
        const flowRate = await calculateVazaoAr(roomId, false);
        
        const { calculateThermalGains } = await import('./thermal-gains.js');
        await calculateThermalGains(roomId, flowRate);
        
    } catch (error) {
        console.error(`Erro no c√°lculo coordenado para ${roomId}:`, error);
    }
}

// =============================================================================
// ATUALIZA√á√ÉO DE DISPLAY
// =============================================================================

/**
 * Atualiza exibi√ß√£o do resultado de vaz√£o na interface
 * @param {string} roomId - ID da sala
 * @param {number} flowRate - Vaz√£o calculada
 */
function updateFlowRateDisplay(roomId, flowRate) {
    const resultElement = document.getElementById(`vazao-ar-${roomId}`);
    if (resultElement) {
        resultElement.textContent = flowRate;
        console.log(`‚úÖ Vaz√£o atualizada para ${roomId}: ${flowRate} l/s`);
    } else {
        console.error(`Elemento de vaz√£o n√£o encontrado: vazao-ar-${roomId}`);
    }
}

// =============================================================================
// VALIDA√á√ïES E UTILIT√ÅRIOS
// =============================================================================

/**
 * Valida dados de entrada para c√°lculo de vaz√£o
 * @param {Object} inputData - Dados de entrada
 * @returns {boolean} True se dados s√£o v√°lidos
 */
function validateAirFlowInputs(inputData) {
    const required = ['numPortasDuplas', 'numPortasSimples'];
    const missing = required.filter(field => 
        inputData[field] === undefined || inputData[field] === null || inputData[field] === ''
    );
    
    if (missing.length > 0) {
        console.warn(`Campos obrigat√≥rios faltando: ${missing.join(', ')}`);
        return false;
    }
    
    // Valida√ß√µes num√©ricas
    if (safeNumber(inputData.numPortasDuplas) < 0 || safeNumber(inputData.numPortasSimples) < 0) {
        console.warn("Quantidade de portas n√£o pode ser negativa");
        return false;
    }
    
    if (inputData.pressurizacao && safeNumber(inputData.setpointTemp) < 0) {
        console.warn("Pressuriza√ß√£o n√£o pode ser negativa");
        return false;
    }
    
    return true;
}

/**
 * Prepara dados para c√°lculo de vaz√£o
 * @param {Object} rawData - Dados brutos
 * @returns {Object} Dados preparados
 */
function prepareAirFlowData(rawData) {
    const prepared = { ...rawData };
    
    // Converter campos num√©ricos
    const numericFields = ['numPortasDuplas', 'numPortasSimples', 'setpointTemp'];
    numericFields.forEach(field => {
        if (prepared[field] !== undefined) {
            prepared[field] = safeNumber(prepared[field]);
        }
    });
    
    // Garantir valores padr√£o
    if (prepared.numPortasDuplas === undefined) prepared.numPortasDuplas = 0;
    if (prepared.numPortasSimples === undefined) prepared.numPortasSimples = 0;
    if (prepared.pressurizacao === undefined) prepared.pressurizacao = false;
    if (prepared.setpointTemp === undefined) prepared.setpointTemp = 0;
    
    return prepared;
}

/**
 * Obt√©m estat√≠sticas do c√°lculo de vaz√£o
 * @param {Object} inputData - Dados de entrada
 * @param {number} result - Resultado do c√°lculo
 * @returns {Object} Estat√≠sticas
 */
function getAirFlowStats(inputData, result) {
    const numPortasDuplas = safeNumber(inputData.numPortasDuplas);
    const numPortasSimples = safeNumber(inputData.numPortasSimples);
    const pressure = inputData.pressurizacao ? safeNumber(inputData.setpointTemp) : 0;
    
    return {
        totalPortas: numPortasDuplas + numPortasSimples,
        portasDuplas: numPortasDuplas,
        portasSimples: numPortasSimples,
        pressurizacaoAtiva: inputData.pressurizacao,
        pressurizacaoValue: pressure,
        vazaoResultante: result,
        timestamp: new Date().toISOString()
    };
}

// =============================================================================
// EXPORTA√á√ïES
// =============================================================================

export {
    // C√°lculos principais
    calculateDoorFlow,
    computeAirFlowRate,
    calculateVazaoAr,
    calculateVazaoArAndThermalGains,
    
    // Display
    updateFlowRateDisplay,
    
    // Valida√ß√µes e utilit√°rios
    validateAirFlowInputs,
    prepareAirFlowData,
    getAirFlowStats
};

// =============================================================================
// DISPONIBILIZA√á√ÉO GLOBAL
// =============================================================================

if (typeof window !== 'undefined') {
    window.airFlowCalculations = {
        calculateVazaoAr,
        calculateVazaoArAndThermalGains,
        updateFlowRateDisplay,
        computeAirFlowRate
    };
}
/* ==== FIM: air-flow.js ==== */

/* ==== IN√çCIO: app.js ==== */
/**
 * core/app.js
 * Bootstrap e inicializa√ß√£o da P√°gina 2
 */

import { initializeManagerInterface } from '../ui/interface.js';
import { showSystemStatus } from '../../01_Create_Obra/ui/components/status.js';
import { loadSystemConstantsFromJSON } from '../data/adapters/constants-adapter.js';



/**
 * Bootstrap da aplica√ß√£o da P√°gina 2
 */
export async function bootstrapManagerApplication() {
    console.log('üéØ Iniciando bootstrap da P√°gina 2 (Gerenciamento)...');
    
    // Verificar se j√° est√° inicializado
    if (window.managerInitialized) {
        console.log('‚ö†Ô∏è Gerenciador j√° inicializado');
        return;
    }
    
    try {
        // 1. PRIMEIRO: Carregar constantes do sistema
        console.log('üì• Carregando constantes do sistema...');
        await loadSystemConstantsFromJSON();
        
        // 2. Configurar contexto global
        window.managerContext = {
            page: 'manager',
            version: '2.0.0',
            timestamp: new Date().toISOString()
        };
        
        // 3. Inicializar interface
        initializeManagerInterface();
        
        // 4. Marcar como inicializado
        window.managerInitialized = true;
        
        console.log('‚úÖ Bootstrap da P√°gina 2 conclu√≠do');
        showSystemStatus('Gerenciamento de obras carregado', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro no bootstrap da P√°gina 2:', error);
        showSystemStatus('Erro ao carregar gerenciamento', 'error');
    }
}

/**
 * Reinicializa o gerenciador
 */
export function reinitializeManager() {
    console.log('üîÑ Reinicializando gerenciador...');
    
    window.managerInitialized = false;
    
    // Limpar interface
    if (typeof clearManagerInterface === 'function') {
        clearManagerInterface();
    }
    
    // Recarregar
    setTimeout(bootstrapManagerApplication, 500);
}

/**
 * Status do gerenciador
 */
export function getManagerStatus() {
    return {
        initialized: !!window.managerInitialized,
        context: window.managerContext || {},
        obrasCount: document.querySelectorAll('.obra-block').length,
        timestamp: new Date().toISOString()
    };
}
/* ==== FIM: app.js ==== */

/* ==== IN√çCIO: calculations-core.js ==== */
/**
 * features/calculations/calculations-core.js
 * N√∫cleo de c√°lculos unificado - FUS√ÉO OTIMIZADA: calculos-manager.js + helpers.js
 * Sistema centralizado para c√°lculos de climatiza√ß√£o
 */


import { 
    safeNumber as coreSafeNumber, 
    updateElementText as coreUpdateElementText,
    waitForElement as coreWaitForElement,
    debounce as coreDebounce
} from '../../utils/core-utils.js';

import {
    collectClimatizationInputs as dataCollectClimatizationInputs,
    findClimatizationSection as dataFindClimatizationSection
} from '../../data/utils/data-utils.js';

// ‚úÖ RE-EXPORTAR fun√ß√µes de data-utils para compatibilidade
export const collectClimatizationInputs = dataCollectClimatizationInputs;
export const findClimatizationSection = dataFindClimatizationSection;

// ‚úÖ RE-EXPORTAR fun√ß√µes de core-utils para compatibilidade  
export const safeNumber = coreSafeNumber;
export const updateElementText = coreUpdateElementText;


// =============================================================================
// SISTEMA DE DEBOUNCE E PERFORMANCE
// =============================================================================

const calculationTimeouts = new Map();

/**
 * Sistema de debounce para otimizar c√°lculos
 * @param {string} roomId - ID da sala
 * @param {Function} calculationFunction - Fun√ß√£o a executar
 * @param {number} delay - Delay em ms (padr√£o: 300ms)
 */
function debouncedCalculation(roomId, calculationFunction, delay = 300) {
    if (calculationTimeouts.has(roomId)) {
        clearTimeout(calculationTimeouts.get(roomId));
    }
    
    const timeoutId = setTimeout(() => {
        calculationFunction(roomId);
        calculationTimeouts.delete(roomId);
    }, delay);
    
    calculationTimeouts.set(roomId, timeoutId);
}

/**
 * Limpa todos os timeouts de c√°lculo
 */
function clearAllCalculationTimeouts() {
    calculationTimeouts.forEach((timeoutId, roomId) => {
        clearTimeout(timeoutId);
        calculationTimeouts.delete(roomId);
    });
}

// =============================================================================
// SISTEMA DE CONSTANTES
// =============================================================================

/**
 * Aguarda carregamento das constantes do sistema
 */
async function waitForSystemConstants() {
    let attempts = 0;
    const maxAttempts = 100;
    
    while ((!window.systemConstants || !window.systemConstants.VARIAVEL_PD) && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 200));
        attempts++;
    }
    
    if (attempts >= maxAttempts) {
        throw new Error("Constantes do sistema n√£o carregadas");
    }
    
    return true;
}

/**
 * Valida integridade das constantes necess√°rias
 */
function validateSystemConstants() {
    if (!window.systemConstants) {
        console.error("systemConstants n√£o dispon√≠vel");
        return false;
    }
    
    const required = [
        'VARIAVEL_PD', 'VARIAVEL_PS', 'AUX_U_Value_Piso', 'AUX_Fator_Iluminacao',
        'AUX_Fs_Iluminacao', 'AUX_Fator_Conver_Painel', 'AUX_Fs_Paineis',
        'AUX_OCp_Csp', 'AUX_OCp_Clp', 'Densi_ar', 'AUX_c_ArExterno',
        'AUX_deltaT_ArExterno', 'AUX_f_ArExterno', 'AUX_deltaUa_ArExterno',
        'deltaT_piso', 'deltaT_teto', 'deltaT_parede_Oes', 'deltaT_parede_Les',
        'deltaT_parede_Nor', 'deltaT_parede_Sul', 'deltaT_divi_N_clim1',
        'deltaT_divi_N_clim2', 'deltaT_divi_clim1', 'deltaT_divi_clim2'
    ];
    
    const missing = required.filter(constant => 
        window.systemConstants[constant] === undefined || window.systemConstants[constant] === null
    );
    
    if (missing.length > 0) {
        console.error("Constantes faltando:", missing);
        return false;
    }
    
    return true;
}

// =============================================================================
// COLETA E PROCESSAMENTO DE DADOS
// =============================================================================






// =============================================================================
// SISTEMA DE C√ÅLCULOS COORDENADOS
// =============================================================================

/**
 * Executa c√°lculo coordenado de vaz√£o e ganhos t√©rmicos com debounce
 */
async function calculateVazaoArAndThermalGainsDebounced(roomId) {
    debouncedCalculation(roomId, async (id) => {
        try {
            // Importa√ß√£o din√¢mica para evitar depend√™ncia circular
            const { calculateVazaoAr } = await import('./air-flow.js');
            const { calculateThermalGains } = await import('./thermal-gains.js');
            
            const flowRate = await calculateVazaoAr(id, false);
            await calculateThermalGains(id, flowRate);
            
        } catch (error) {
            console.error(`Erro em c√°lculo para ${id}:`, error);
        }
    }, 300);
}

/**
 * Executa c√°lculo imediato (sem debounce)
 */
async function calculateVazaoArAndThermalGainsImmediate(roomId) {
    try {
        const { calculateVazaoAr } = await import('./air-flow.js');
        const { calculateThermalGains } = await import('./thermal-gains.js');
        
        const flowRate = await calculateVazaoAr(roomId, false);
        await calculateThermalGains(roomId, flowRate);
        
    } catch (error) {
        console.error(`Erro em c√°lculo imediato para ${roomId}:`, error);
    }
}

// =============================================================================
// FUN√á√ïES DE COMPATIBILIDADE
// =============================================================================




// =============================================================================
// UTILIT√ÅRIOS DE VALIDA√á√ÉO
// =============================================================================

/**
 * Valida se os dados coletados s√£o suficientes para c√°lculos
 */
function validateCalculationData(inputData) {
    const requiredFields = ['area', 'altura', 'qtdPessoas', 'qtdEquipamentos'];
    const missingFields = requiredFields.filter(field => 
        !inputData[field] || inputData[field] === ''
    );
    
    if (missingFields.length > 0) {
        console.warn(`Campos obrigat√≥rios faltando: ${missingFields.join(', ')}`);
        return false;
    }
    
    return true;
}

/**
 * Prepara dados para c√°lculo (convers√µes e formata√ß√µes)
 */
function prepareCalculationData(rawData) {
    const prepared = { ...rawData };
    
    // Converter n√∫meros
    const numericFields = ['area', 'altura', 'qtdPessoas', 'qtdEquipamentos', 'potenciaIluminacao'];
    numericFields.forEach(field => {
        if (prepared[field]) {
            prepared[field] = coreSafeNumber(prepared[field]);
        }
    });
    
    // Aplicar fatores de seguran√ßa
    if (prepared.fatorSeguranca) {
        const factor = coreSafeNumber(prepared.fatorSeguranca);
        if (factor > 1) {
            prepared.area = prepared.area * factor;
        }
    }
    
    return prepared;
}

// =============================================================================
// EXPORTA√á√ïES
// =============================================================================

export {
    // Sistema de Performance
    debouncedCalculation,
    clearAllCalculationTimeouts,
    
    // Sistema de Constantes
    waitForSystemConstants,
    validateSystemConstants,

    
    // Sistema de C√°lculos
    calculateVazaoArAndThermalGainsDebounced,
    calculateVazaoArAndThermalGainsImmediate,
    
    // Valida√ß√£o e Prepara√ß√£o
    validateCalculationData,
    prepareCalculationData,
    


};

// =============================================================================
// INICIALIZA√á√ÉO E CONFIGURA√á√ÉO
// =============================================================================

// Configura√ß√£o padr√£o do sistema de c√°lculos
const CALCULATION_CONFIG = {
    debounceDelay: 300,
    maxRetryAttempts: 3,
    validationStrict: false,
    enableLogging: window.location.hostname === 'localhost'
};


// Disponibiliza√ß√£o global para compatibilidade
if (typeof window !== 'undefined') {
    window.calculationCore = {
        debouncedCalculation,
        waitForSystemConstants,
        collectClimatizationInputs,

        calculateVazaoArAndThermalGainsDebounced
    };
}

// Limpeza de timeouts ao descarregar a p√°gina
if (typeof window !== 'undefined') {
    window.addEventListener('beforeunload', clearAllCalculationTimeouts);
}
/* ==== FIM: calculations-core.js ==== */

/* ==== IN√çCIO: constants-adapter.js ==== */
/**
 * data/adapters/constants-adapter.js
 * Carrega constantes do sistema do arquivo JSON
 */

export async function loadSystemConstantsFromJSON() {
    try {
        console.log('üì¶ Carregando constantes do sistema do JSON...');
        
        const response = await fetch('/json/dados.json');
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const constants = await response.json();
        
        // Disponibilizar globalmente (como na P√°gina 1)
        window.systemConstants = constants;
        
        console.log('‚úÖ Constantes do sistema carregadas do JSON:', Object.keys(constants).length, 'constantes');
        return constants;
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar constantes do JSON:', error);
        throw error;
    }
}
/* ==== FIM: constants-adapter.js ==== */

/* ==== IN√çCIO: global-stubs.js ==== */
/**
 * utils/global-stubs.js
 * Stubs para fun√ß√µes globais que podem n√£o estar dispon√≠veis
 */


console.log('üöÄ global-stubs.js CARREGANDO...');

// Verificar se toggleSection j√° existe ANTES de definir o stub
console.log(`üîç toggleSection existe antes do stub? ${typeof window.toggleSection}`);
console.log(`üîç toggleSubsection existe antes do stub? ${typeof window.toggleSubsection}`);


// Stub para calculateVazaoArAndThermalGains
if (typeof window.calculateVazaoArAndThermalGains !== 'function') {
    window.calculateVazaoArAndThermalGains = function(roomId) {
        console.log(`üîß calculateVazaoArAndThermalGains stub chamado para sala: ${roomId}`);
        // Esta fun√ß√£o ser√° substitu√≠da quando o m√≥dulo real for carregado
    };
}

// Stub para toggleObra
if (typeof window.toggleObra !== 'function') {
    window.toggleObra = function(obraId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleObra stub chamado para obra: ${obraId}`);
        
        const obraContent = document.getElementById(`obra-content-${obraId}`);
        const minimizer = event?.target;
        
        if (obraContent && minimizer) {
            const isCollapsed = obraContent.classList.contains('collapsed');
            obraContent.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
        }
    };
}

// Stub para toggleRoom
if (typeof window.toggleRoom !== 'function') {
    window.toggleRoom = function(roomId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleRoom stub chamado para sala: ${roomId}`);
        
        const roomContent = document.getElementById(`room-content-${roomId}`);
        const minimizer = event?.target;
        
        if (roomContent && minimizer) {
            const isCollapsed = roomContent.classList.contains('collapsed');
            roomContent.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
        }
    };
}

// Stub para toggleProject
if (typeof window.toggleProject  !== 'function') {
    window.toggleProject  = function(projectId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleProject  stub chamado para sala: ${projectId}`);
        
        const projectContent = document.getElementById(`project-content-${projectId}`);
        const minimizer = event?.target;
        
        if (projectContent && minimizer) {
            const isCollapsed = projectContent.classList.contains('collapsed');
            projectContent.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
        }
    };
}

// Stub para toggleSubsection - VERS√ÉO DEFINITIVA
if (typeof window.toggleSubsection !== 'function') {
    window.toggleSubsection = function(subsectionId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleSubsection stub chamado para subse√ß√£o: ${subsectionId}`);
        
        // ‚úÖ USAR O ID EXATO QUE EST√Å NO DOM
        const contentId = `subsection-content-${subsectionId}`;
        const content = document.getElementById(contentId);
        const minimizer = event?.target;
        
        if (content && minimizer) {
            const isCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
            
            // Tamb√©m alternar a classe no bloco pai para estiliza√ß√£o
            const subsectionBlock = content.closest('.subsection-block');
            if (subsectionBlock) {
                subsectionBlock.classList.toggle('collapsed', !isCollapsed);
            }
            
            console.log(`‚úÖ Subse√ß√£o ${subsectionId} ${isCollapsed ? 'expandida' : 'recolhida'}`);
        } else {
            console.error(`‚ùå Conte√∫do da subse√ß√£o n√£o encontrado: ${contentId}`);
            
            // ‚úÖ M√âTODO ALTERNATIVO
            if (minimizer) {
                const subsectionBlock = minimizer.closest('.subsection-block');
                if (subsectionBlock) {
                    const altContent = subsectionBlock.querySelector('.subsection-content');
                    if (altContent) {
                        const isCollapsed = altContent.classList.contains('collapsed');
                        altContent.classList.toggle('collapsed', !isCollapsed);
                        minimizer.textContent = isCollapsed ? '‚àí' : '+';
                        subsectionBlock.classList.toggle('collapsed', !isCollapsed);
                        console.log(`‚úÖ Subse√ß√£o encontrada via m√©todo alternativo: ${isCollapsed ? 'expandida' : 'recolhida'}`);
                    }
                }
            }
        }
    };
}

// Stub para toggleMachineSection - VERS√ÉO DEFINITIVA
if (typeof window.toggleMachineSection !== 'function') {
    window.toggleMachineSection = function(machineId, event) {
        if (event) event.stopPropagation();
        console.log(`üîß toggleMachineSection stub chamado para m√°quina: ${machineId}`);
        
        // ‚úÖ USAR O ID EXATO QUE EST√Å NO DOM
        const contentId = `machine-content-${machineId}`;
        const content = document.getElementById(contentId);
        const minimizer = event?.target;
        
        if (content && minimizer) {
            const isCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed', !isCollapsed);
            minimizer.textContent = isCollapsed ? '‚àí' : '+';
            
            console.log(`‚úÖ M√°quina ${machineId} ${isCollapsed ? 'expandida' : 'recolhida'}`);
        } else {
            console.error(`‚ùå Conte√∫do da m√°quina n√£o encontrado: ${contentId}`);
            
            // ‚úÖ M√âTODO ALTERNATIVO
            if (minimizer) {
                const machineElement = minimizer.closest('.climatization-machine, .machine-block');
                if (machineElement) {
                    const altContent = machineElement.querySelector('.machine-content');
                    if (altContent) {
                        const isCollapsed = altContent.classList.contains('collapsed');
                        altContent.classList.toggle('collapsed', !isCollapsed);
                        minimizer.textContent = isCollapsed ? '‚àí' : '+';
                        console.log(`‚úÖ M√°quina encontrada via m√©todo alternativo: ${isCollapsed ? 'expandida' : 'recolhida'}`);
                    }
                }
            }
        }
    };
}

// Stub para makeEditable
if (typeof window.makeEditable !== 'function') {
    window.makeEditable = function(element, type) {
        console.log(`üîß makeEditable stub chamado para: ${type}`);
        
        if (element.getAttribute('contenteditable') === 'true') return;
        
        element.setAttribute('contenteditable', 'true');
        element.classList.add('editing');
        element.focus();
        
        const originalText = element.textContent;
        
        function saveChanges() {
            element.setAttribute('contenteditable', 'false');
            element.classList.remove('editing');
            console.log(`‚úÖ ${type} atualizado: ${element.textContent}`);
        }
        
        element.addEventListener('blur', saveChanges, { once: true });
        element.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveChanges();
            } else if (e.key === 'Escape') {
                element.textContent = originalText;
                saveChanges();
            }
        });
    };
}

// Stub para outras fun√ß√µes comuns
const stubFunctions = [
    'toggleMachineSection',
    'updateMachineTitle', 
    'deleteMachine',
    'updateMachineOptions',
    'handlePowerChange',
    'calculateMachinePrice',
    'updateBackupConfiguration',
    'initializeFatorSeguranca',
    'syncCapacityTableBackup'
];

stubFunctions.forEach(funcName => {
    if (typeof window[funcName] !== 'function') {
        window[funcName] = function(...args) {
            console.log(`üîß ${funcName} stub chamado com:`, args);
            // Stub vazio - ser√° substitu√≠do quando o m√≥dulo real for carregado
        };
    }
});

console.log('‚úÖ Stubs globais carregados');
/* ==== FIM: global-stubs.js ==== */

/* ==== IN√çCIO: interface.js ==== */
/**
 * ui/interface.js
 * Interface e gerenciamento de eventos da P√°gina 2
 */

import { loadAndRenderObras } from '../features/managers/obras-manager.js';
import { showShutdownConfirmationModal } from '../../01_Create_Obra/ui/components/modal/exit-modal.js';
import { MESSAGES, SELECTORS } from '../core/constants.js';

/**
 * Inicializa a interface da P√°gina 2
 */
export function initializeManagerInterface() {
    console.log('üéØ Inicializando interface do gerenciador...');
    
    try {
        // 1. Configurar contexto da P√°gina 2
        document.body.dataset.page = 'manager';
        
        // 2. Adicionar header espec√≠fico
        addManagerHeader();
        
        // 3. Configurar container de projetos
        setupProjectsContainer();
        
        // 4. Configurar bot√£o de shutdown
        setupShutdownButton();
        
        // 5. Carregar e renderizar obras
        loadAndRenderObras();
        
        console.log('‚úÖ Interface do gerenciador inicializada');
        
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o da interface:', error);
    }
}

/**
 * Adiciona header espec√≠fico da P√°gina 2
 */
function addManagerHeader() {
    const mainContent = document.querySelector('main, .main-content') || document.body;
    
    const managerHeader = document.createElement('div');
    managerHeader.className = 'manager-header';
    managerHeader.innerHTML = `
        <h1>Gerenciamento de Obras <span class="manager-badge">Todos os Registros</span></h1>
        <div class="subtitle">Visualize, atualize e gerencie todas as obras do sistema</div>
    `;
    
    // Inserir no in√≠cio do conte√∫do principal
    if (mainContent.firstChild) {
        mainContent.insertBefore(managerHeader, mainContent.firstChild);
    } else {
        mainContent.appendChild(managerHeader);
    }
}

/**
 * Configura o container de projetos para a P√°gina 2
 */
function setupProjectsContainer() {
    let container = document.getElementById('projects-container');
    
    if (!container) {
        container = document.createElement('div');
        container.id = 'projects-container';
        
        const mainContent = document.querySelector('main, .main-content') || document.body;
        mainContent.appendChild(container);
    }
    
    // Limpar conte√∫do existente (se houver)
    container.innerHTML = '<!-- Obras carregadas do backup.json -->';
    
    console.log('‚úÖ Container de projetos configurado');
}

/**
 * Configura bot√£o de shutdown (se existir)
 */
function setupShutdownButton() {
    const shutdownBtn = document.querySelector('.shutdown-btn');
    
    if (shutdownBtn) {
        shutdownBtn.addEventListener('click', async () => {
            console.log('üîÑ Bot√£o de shutdown clicado na P√°gina 2');
            
            const confirmed = await showShutdownConfirmationModal();
            
            if (confirmed) {
                console.log('‚úÖ Confirma√ß√£o de shutdown recebida');
                // O modal j√° cuida do shutdown, apenas log
                showSystemStatus('Servidor sendo encerrado...', 'warning');
            } else {
                console.log('‚ùå Shutdown cancelado pelo usu√°rio');
            }
        });
        
        console.log('‚úÖ Bot√£o de shutdown configurado');
    }
}

/**
 * Limpa a interface (para futuros recarregamentos)
 */
export function clearManagerInterface() {
    const container = document.getElementById('projects-container');
    if (container) {
        container.innerHTML = '';
    }
    
    const managerHeader = document.querySelector('.manager-header');
    if (managerHeader) {
        managerHeader.remove();
    }
    
    console.log('‚úÖ Interface do gerenciador limpa');
}
/* ==== FIM: interface.js ==== */

/* ==== IN√çCIO: obras-manager.js ==== */
/**
 * features/managers/obras-manager.js
 * Gerenciador principal da P√°gina 2 - Coordena carregamento e renderiza√ß√£o
 */

import { loadBackupObras, removeObraFromBackup } from '../../data/adapters/obras-adapter.js';
import { getObraStats, formatObraStats, applyFilters as applyObraFilters } from '../../data/builders/obras-builder.js';
import { showSystemStatus } from '../../../01_Create_Obra/ui/components/status.js';
import { showConfirmationModal } from '../../../01_Create_Obra/ui/components/modal/modal.js';
import { loadSystemConstantsFromJSON } from '../../data/adapters/constants-adapter.js';

// Cache para fun√ß√µes da P√°gina 1
let page1Functions = null;
let globalFunctionsLoaded = false;



/**
 * Carrega TODAS as fun√ß√µes globais da P√°gina 1
 */
async function loadAllPage1Functions() {
    if (globalFunctionsLoaded) return;
    
    try {
        console.log('üì¶ Carregando TODAS as fun√ß√µes da P√°gina 1...');
        
        // 1. Primeiro carregar constantes do JSON
        await loadSystemConstantsFromJSON();
        
        // 2. Carregar fun√ß√µes essenciais da P√°gina 1
        const obraManager = await import('../../../01_Create_Obra/features/managers/obra-manager.js');
        const uiBuilders = await import('../../../01_Create_Obra/data/builders/ui-builders.js');
        const interfaceModule = await import('../../../01_Create_Obra/ui/interface.js');
        
        // 3. Carregar m√≥dulos que definem fun√ß√µes globais
        await import('../../../01_Create_Obra/features/calculations/air-flow.js');
        await import('../../../01_Create_Obra/features/calculations/thermal-gains.js');
        await import('../../../01_Create_Obra/ui/helpers.js');
        await import('../../../01_Create_Obra/data/modules/climatizacao.js');
        await import('../../../01_Create_Obra/data/modules/machines/machines-core.js');
        await import('../../../01_Create_Obra/data/modules/rooms.js');
        
        page1Functions = {
            createEmptyObra: obraManager.createEmptyObra,
            insertObraIntoDOM: obraManager.insertObraIntoDOM,
            populateObraData: uiBuilders.populateObraData,
            updateObraButtonAfterSave: obraManager.updateObraButtonAfterSave,
        };
        
        console.log('‚úÖ TODAS as fun√ß√µes da P√°gina 1 carregadas');
        
        // Verificar se as fun√ß√µes principais foram carregadas
        const requiredFunctions = [
            'toggleObra', 'toggleRoom', 'toggleProject', 'toggleSection', 'toggleSubsection',
            'toggleMachineSection', 'calculateVazaoArAndThermalGains', 'makeEditable'
        ];
        
        let loadedFunctions = [];
        let missingFunctions = [];
        
        requiredFunctions.forEach(funcName => {
            if (typeof window[funcName] === 'function') {
                loadedFunctions.push(funcName);
            } else {
                missingFunctions.push(funcName);
            }
        });
        
        console.log(`üìä Fun√ß√µes carregadas: ${loadedFunctions.length}/${requiredFunctions.length}`);
        console.log('‚úÖ Carregadas:', loadedFunctions);
        if (missingFunctions.length > 0) {
            console.warn('‚ö†Ô∏è Faltando:', missingFunctions);
        }
        
        globalFunctionsLoaded = true;
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar fun√ß√µes da P√°gina 1:', error);
        throw error;
    }
}

/**
 * Renderiza uma obra usando as fun√ß√µes da P√°gina 1
 */
async function renderObra(obraData) {
    try {
        // ‚úÖ CARREGAR TODAS AS FUN√á√ïES E CONSTANTES PRIMEIRO
        await loadAllPage1Functions();
        
        const { createEmptyObra, populateObraData } = page1Functions;
        
        console.log(`üé® Renderizando obra: ${obraData.nome} (ID: ${obraData.id})`);
        
        // Criar obra vazia usando fun√ß√£o da P√°gina 1
        const obraCreated = await createEmptyObra(obraData.nome, obraData.id);
        
        if (!obraCreated) {
            console.error(`‚ùå Falha ao criar obra: ${obraData.nome}`);
            return false;
        }
        
        // Aguardar a obra ser inserida no DOM
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Popular dados completos usando fun√ß√£o da P√°gina 1
        await populateObraData(obraData);
        
        console.log(`‚úÖ Obra renderizada: ${obraData.nome}`);
        return true;
        
    } catch (error) {
        console.error(`‚ùå Erro ao renderizar obra ${obraData.nome}:`, error);
        return false;
    }
}

/**
 * Aplica p√≥s-processamento espec√≠fico da P√°gina 2
 */
function applyPage2PostProcessing() {
    console.log('üîß Aplicando p√≥s-processamento da P√°gina 2...');
    
    // 1. Esconder bot√µes de Salvar
    const saveButtons = document.querySelectorAll('.btn-salvar');
    saveButtons.forEach(btn => {
        btn.style.display = 'none';
    });
    
    // 2. Esconder se√ß√µes de adicionar projeto/sala
    const addSections = document.querySelectorAll('.add-project-section, .add-room-section');
    addSections.forEach(section => {
        section.style.display = 'none';
    });
    
    // 3. Atualizar textos e adicionar badge
    const obraHeaders = document.querySelectorAll('.obra-header');
    obraHeaders.forEach(header => {

        
        // Atualizar a√ß√£o de deletar para usar adapter da P√°gina 2
        const deleteBtn = header.querySelector('.btn-delete');
        if (deleteBtn) {
            const obraId = deleteBtn.closest('.obra-block').dataset.obraId;
            const obraName = deleteBtn.closest('.obra-block').dataset.obraName;
            
            deleteBtn.textContent = 'Excluir do Backup';
            deleteBtn.className = 'btn btn-manager-delete';
            deleteBtn.onclick = () => handleObraDeletion(obraId, obraName);
        }
    });
    
    // 4. Adicionar estat√≠sticas √†s obras
    const obraBlocks = document.querySelectorAll('.obra-block');
    obraBlocks.forEach(obraBlock => {
        const obraId = obraBlock.dataset.obraId;
        addObraStatsToHeader(obraBlock, obraId);
    });
    
    console.log('‚úÖ P√≥s-processamento aplicado');
}

/**
 * Adiciona estat√≠sticas ao header da obra
 */
function addObraStatsToHeader(obraBlock, obraId) {
    const obraHeader = obraBlock.querySelector('.obra-header');
    const spacer = obraBlock.querySelector('.obra-header-spacer');
    
    if (spacer) {
        // Buscar dados da obra para calcular estat√≠sticas
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (obraElement) {
            const projetos = obraElement.querySelectorAll('.project-block');
            let totalSalas = 0;
            let totalMaquinas = 0;
            
            projetos.forEach(projeto => {
                const salas = projeto.querySelectorAll('.room-block');
                totalSalas += salas.length;
                
                salas.forEach(sala => {
                    const maquinas = sala.querySelectorAll('.climatization-machine, .machine-block');
                    totalMaquinas += maquinas.length;
                });
            });
            
            const statsText = formatObraStats({
                projetos: projetos.length,
                salas: totalSalas,
                maquinas: totalMaquinas
            });
            
            spacer.innerHTML = `<span>${statsText}</span>`;
        }
    }
}

/**
 * Manipula a exclus√£o de obra (P√°gina 2)
 */
async function handleObraDeletion(obraId, obraName) {
    console.log(`üóëÔ∏è Iniciando exclus√£o da obra: ${obraName} (ID: ${obraId})`);
    
    // Usar modal de confirma√ß√£o da P√°gina 1, mas com comportamento da P√°gina 2
    showConfirmationModal(obraName, obraId, document.querySelector(`[data-obra-id="${obraId}"]`));
    
    // Sobrescrever o comportamento padr√£o do modal
    window.confirmDeletion = async () => {
        console.log(`‚úÖ Confirmada exclus√£o da obra: ${obraName}`);
        
        try {
            // Remover do backup usando adapter da P√°gina 2
            const success = await removeObraFromBackup(obraId);
            
            if (success) {
                // Remover do DOM
                const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
                if (obraBlock) {
                    obraBlock.remove();
                    console.log(`‚úÖ Obra ${obraName} removida do DOM`);
                }
                
                showSystemStatus(`Obra "${obraName}" removida do backup`, 'success');
            } else {
                // Fallback: remover apenas do DOM se o servidor n√£o suportar
                console.log('üîÑ Fallback: removendo apenas do DOM');
                const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
                if (obraBlock) {
                    obraBlock.remove();
                    showSystemStatus(`Obra "${obraName}" removida da visualiza√ß√£o`, 'warning');
                }
            }
            
        } catch (error) {
            console.error('‚ùå Erro na exclus√£o:', error);
            showSystemStatus('Erro ao remover obra', 'error');
        }
    };
}

/**
 * Carrega e renderiza todas as obras do backup
 */
export async function loadAndRenderObras() {
    try {
        console.log('üöÄ Iniciando carregamento e renderiza√ß√£o de obras...');
        showSystemStatus('Carregando obras...', 'info');
        
        // Carregar obras do backup
        const obras = await loadBackupObras();
        
        if (obras.length === 0) {
            showSystemStatus('Nenhuma obra encontrada no backup', 'warning');
            return;
        }
        
        console.log(`üìä ${obras.length} obra(s) para renderizar`);
        
        // Renderizar cada obra
        let successCount = 0;
        for (const obra of obras) {
            const success = await renderObra(obra);
            if (success) successCount++;
            
            // Pequena pausa entre renderiza√ß√µes
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // Aplicar p√≥s-processamento da P√°gina 2
        applyPage2PostProcessing();
        
        console.log(`üéâ Renderiza√ß√£o conclu√≠da: ${successCount}/${obras.length} obra(s)`);
        showSystemStatus(`${successCount} obra(s) carregada(s)`, 'success');
        
    } catch (error) {
        console.error('‚ùå Erro no carregamento e renderiza√ß√£o:', error);
        showSystemStatus('Erro ao carregar obras', 'error');
    }
}

/**
 * Stub para filtros futuros
 */
export function applyFilters(criteria = {}) {
    console.log('üîç Aplicando filtros (stub):', criteria);
    
    // Usar a fun√ß√£o do builder com alias para evitar conflito
    const filteredObras = applyObraFilters([], criteria); // Array vazio por enquanto
    
    // Esta fun√ß√£o ser√° conectada ao UI de busca quando implementado
    return {
        criteria,
        filteredCount: filteredObras.length,
        message: 'Sistema de filtros ser√° implementado futuramente',
        timestamp: new Date().toISOString()
    };
}

// Exporta√ß√µes
export {
    renderObra,
    applyPage2PostProcessing,
    handleObraDeletion
};
/* ==== FIM: obras-manager.js ==== */

/* ==== IN√çCIO: thermal-gains.js ==== */
/**
 * thermal-gains.js
 * üéØ FUS√ÉO COMPLETA: thermalCalculations + thermalComponents + thermalDisplay
 * ‚ö° REDU√á√ÉO: 3 arquivos ‚Üí 1 arquivo (~600 ‚Üí ~350 linhas)
 */


import { 
    waitForSystemConstants, 
    validateSystemConstants,
    collectClimatizationInputs,
} from './calculations-core.js'  

import { safeNumber, updateElementText } from '../../utils/core-utils.js';

/**
 * üî• C√ÅLCULOS DE COMPONENTES T√âRMICOS (thermalComponents.js)
 */

function calculateCeilingGain(area, uValue, deltaT) {
  const areaNum = safeNumber(area);
  const uValueNum = safeNumber(uValue);
  const deltaTNum = safeNumber(deltaT);
  const result = areaNum * uValueNum * deltaTNum;
  console.log(`[DEBUG DETAIL] calculateCeilingGain: ${areaNum} * ${uValueNum} * ${deltaTNum} = ${result}`);
  return result;
}

function calculateWallGain(comprimento, peDireito, uValue, deltaT) {
  const compNum = safeNumber(comprimento);
  const peDireitoNum = safeNumber(peDireito);
  const uValueNum = safeNumber(uValue);
  const deltaTNum = safeNumber(deltaT);
  const area = compNum * peDireitoNum;
  const result = area * uValueNum * deltaTNum;
  console.log(`[DEBUG DETAIL] calculateWallGain: (${compNum} * ${peDireitoNum}) = ${area}m¬≤ * ${uValueNum} * ${deltaTNum} = ${result}`);
  return result;
}

function calculatePartitionGain(inputArea, peDireito, uValue, deltaT) {
  const area = safeNumber(inputArea) * safeNumber(peDireito);
  const result = area * uValue * deltaT;
  return result;
}

function calculateFloorGain(area, constants) {
  const uValue = window.systemConstants?.AUX_U_Value_Piso || 2.7;
  const deltaT = window.systemConstants?.deltaT_piso || 7.5;
  const result = safeNumber(area) * uValue * deltaT;
  return result;
}

function calculateLightingGain(area, constants) {
  const fatorIluminacao = window.systemConstants?.AUX_Fator_Iluminacao || 7;
  const fsIluminacao = window.systemConstants?.AUX_Fs_Iluminacao || 1;
  const result = safeNumber(area) * fatorIluminacao * fsIluminacao;
  return result;
}

function calculateDissipationGain(dissipacao, constants) {
  const fatorConversao = window.systemConstants?.AUX_Fator_Conver_Painel || 1;
  const fsPaineis = window.systemConstants?.AUX_Fs_Paineis || 100;
  const result = (fatorConversao * safeNumber(dissipacao) * fsPaineis) / 100;
  return result;
}

function calculatePeopleGain(numPessoas, constants) {
  const csp = window.systemConstants?.AUX_OCp_Csp || 86.5;
  const clp = window.systemConstants?.AUX_OCp_Clp || 133.3;
  const fsPessoas = 100;
  const pessoas = safeNumber(numPessoas);
  const ganhoSensivel = (csp * pessoas * fsPessoas) / 100;
  const ganhoLatente = (clp * pessoas * fsPessoas) / 100;
  const result = ganhoSensivel + ganhoLatente;
  return result;
}

function calculateExternalAirSensibleGain(vazaoArExterno, auxVars, constants) {
  const c_ArExterno = window.systemConstants?.AUX_c_ArExterno || 0.24;
  const deltaT_ArExterno = window.systemConstants?.AUX_deltaT_ArExterno || 10;
  
  const calc_Gsens_ArE = auxVars.m_ArExterno * c_ArExterno * deltaT_ArExterno;
  const resultado = (calc_Gsens_ArE / 1000) * 1.16;
  
  return resultado;
}

function calculateExternalAirLatentGain(vazaoArExterno, constants) {
  const f_ArExterno = window.systemConstants?.AUX_f_ArExterno || 3.01;
  const deltaUa_ArExterno = window.systemConstants?.AUX_deltaUa_ArExterno || 8.47;
  
  const vazao = safeNumber(vazaoArExterno);
  const ganho = vazao * f_ArExterno * deltaUa_ArExterno;
  
  return ganho;
}

/**
 * üìä C√ÅLCULOS DE TOTAIS E DISPLAY (thermalDisplay.js)
 */

function calculateTotals(gains) {
  const totalExterno = gains.teto + gains.paredeOeste + gains.paredeLeste + gains.paredeNorte + gains.paredeSul;
  const totalDivisoes = gains.divisoriaNaoClima1 + gains.divisoriaNaoClima2 + gains.divisoriaClima1 + gains.divisoriaClima2;
  const totalPiso = gains.piso;
  const totalIluminacao = gains.iluminacao;
  const totalEquipamentos = gains.dissipacao;
  const totalPessoas = gains.pessoas;
  const totalArSensivel = gains.arSensivel;
  const totalArLatente = gains.arLatente;
  const totalArExterno = totalArSensivel + totalArLatente;

  const totalGeralW = totalExterno + totalDivisoes + totalPiso + totalIluminacao + totalEquipamentos + totalPessoas + totalArExterno;
  const totalGeralTR = totalGeralW / 3517;

  const totals = {
    externo: Math.ceil(totalExterno),
    divisoes: Math.ceil(totalDivisoes),
    piso: Math.ceil(totalPiso),
    iluminacao: Math.ceil(totalIluminacao),
    equipamentos: Math.ceil(totalEquipamentos),
    pessoas: Math.ceil(totalPessoas),
    arSensivel: Math.ceil(totalArSensivel),
    arLatente: Math.ceil(totalArLatente),
    arExterno: Math.ceil(totalArExterno),
    geralW: Math.ceil(totalGeralW),
    geralTR: Math.ceil(totalGeralTR),
  };

  return totals;
}

function updateWallDisplay(roomId, direction, gain, uValue, inputWidth, peDireito, deltaT) {
  const area = safeNumber(inputWidth) * safeNumber(peDireito);
  updateElementText(`area-parede-${direction}-${roomId}`, Math.ceil(area));
  updateElementText(`uvalue-parede-${direction}-${roomId}`, uValue.toFixed(3));
  updateElementText(`deltat-parede-${direction}-${roomId}`, deltaT || 0);
  updateElementText(`ganho-parede-${direction}-${roomId}`, Math.ceil(gain));
}

function updatePartitionDisplay(roomId, type, gain, uValue, inputArea, peDireito, deltaT) {
  const areaCalculada = safeNumber(inputArea) * safeNumber(peDireito);
  updateElementText(`area-divi-${type}-${roomId}`, Math.ceil(areaCalculada));
  updateElementText(`uvalue-divi-${type}-${roomId}`, uValue.toFixed(3));
  updateElementText(`deltat-divi-${type}-${roomId}`, deltaT || 0);
  updateElementText(`ganho-divi-${type}-${roomId}`, Math.ceil(gain));
}

function updateThermalGainsDisplay(roomId, gains, totals, uValues, inputData) {
  console.log(`üî• Atualizando display t√©rmico para sala: ${roomId}`);
  
  updateElementText(`total-ganhos-w-${roomId}`, totals.geralW);
  updateElementText(`total-tr-${roomId}`, totals.geralTR);

  updateElementText(`area-teto-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`uvalue-teto-${roomId}`, uValues.teto.toFixed(3));
  updateElementText(`deltat-teto-${roomId}`, window.systemConstants?.deltaT_teto || 20);
  updateElementText(`ganho-teto-${roomId}`, Math.ceil(gains.teto));

  updateWallDisplay(roomId, "oeste", gains.paredeOeste, uValues.parede, inputData.paredeOeste, inputData.peDireito, window.systemConstants?.deltaT_parede_Oes || 0);
  updateWallDisplay(roomId, "leste", gains.paredeLeste, uValues.parede, inputData.paredeLeste, inputData.peDireito, window.systemConstants?.deltaT_parede_Les || 0);
  updateWallDisplay(roomId, "norte", gains.paredeNorte, uValues.parede, inputData.paredeNorte, inputData.peDireito, window.systemConstants?.deltaT_parede_Nor || 0);
  updateWallDisplay(roomId, "sul", gains.paredeSul, uValues.parede, inputData.paredeSul, inputData.peDireito, window.systemConstants?.deltaT_parede_Sul || 0);

  updatePartitionDisplay(roomId, "nc1", gains.divisoriaNaoClima1, uValues.parede, inputData.divisoriaNaoClima1, inputData.peDireito, window.systemConstants?.deltaT_divi_N_clim1 || 0);
  updatePartitionDisplay(roomId, "nc2", gains.divisoriaNaoClima2, uValues.parede, inputData.divisoriaNaoClima2, inputData.peDireito, window.systemConstants?.deltaT_divi_N_clim2 || 0);
  updatePartitionDisplay(roomId, "c1", gains.divisoriaClima1, uValues.parede, inputData.divisoriaClima1, inputData.peDireito, window.systemConstants?.deltaT_divi_clim1 || 0);
  updatePartitionDisplay(roomId, "c2", gains.divisoriaClima2, uValues.parede, inputData.divisoriaClima2, inputData.peDireito, window.systemConstants?.deltaT_divi_clim2 || 0);

  updateElementText(`area-piso-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`uvalue-piso-${roomId}`, uValues.piso.toFixed(3));
  updateElementText(`deltat-piso-${roomId}`, window.systemConstants?.deltaT_piso || 5);
  updateElementText(`ganho-piso-${roomId}`, Math.ceil(gains.piso));
  updateElementText(`total-piso-${roomId}`, totals.piso);

  updateElementText(`area-iluminacao-${roomId}`, Math.ceil(inputData.area || 0));
  updateElementText(`fator-iluminacao-${roomId}`, window.systemConstants?.AUX_Fator_Iluminacao || 7);
  updateElementText(`fs-iluminacao-${roomId}`, window.systemConstants?.AUX_Fs_Iluminacao || 1);
  updateElementText(`ganho-iluminacao-${roomId}`, Math.ceil(gains.iluminacao));
  updateElementText(`total-iluminacao-${roomId}`, totals.iluminacao);

  updateElementText(`fator-conversao-dissi-${roomId}`, window.systemConstants?.AUX_Fator_Conver_Painel || 1);
  updateElementText(`pe-dissi-${roomId}`, inputData.dissipacao || 0);
  updateElementText(`fs-dissi-${roomId}`, window.systemConstants?.AUX_Fs_Paineis || 100);
  updateElementText(`ganho-dissi-${roomId}`, Math.ceil(gains.dissipacao));
  updateElementText(`total-dissi-${roomId}`, totals.equipamentos);

  updateElementText(`csp-pessoas-${roomId}`, window.systemConstants?.AUX_OCp_Csp || 86.5);
  updateElementText(`clp-pessoas-${roomId}`, window.systemConstants?.AUX_OCp_Clp || 133.3);
  updateElementText(`o-pessoas-${roomId}`, inputData.numPessoas || 0);
  updateElementText(`fs-pessoas-${roomId}`, 100);
  updateElementText(`ganho-pessoas-${roomId}`, Math.ceil(gains.pessoas));
  updateElementText(`total-pessoas-${roomId}`, totals.pessoas);

  const densiAr = window.systemConstants?.Densi_ar || 1.17;
  const m_ArExterno = (inputData.vazaoArExterno || 0) * 3.6 * densiAr * 1000;

  updateElementText(`m-ar-sensivel-${roomId}`, Math.ceil(m_ArExterno));
  updateElementText(`c-ar-sensivel-${roomId}`, window.systemConstants?.AUX_c_ArExterno || 0.24);
  updateElementText(`deltat-ar-sensivel-${roomId}`, window.systemConstants?.AUX_deltaT_ArExterno || 10);
  updateElementText(`ganho-ar-sensivel-${roomId}`, Math.ceil(gains.arSensivel));
  updateElementText(`total-ar-sensivel-${roomId}`, totals.arSensivel);

  updateElementText(`var-ar-latente-${roomId}`, inputData.vazaoArExterno || 0);
  updateElementText(`f-ar-latente-${roomId}`, window.systemConstants?.AUX_f_ArExterno || 3.01);
  updateElementText(`deltaua-ar-latente-${roomId}`, window.systemConstants?.AUX_deltaUa_ArExterno || 8.47);
  updateElementText(`ganho-ar-latente-${roomId}`, Math.ceil(gains.arLatente));
  updateElementText(`total-ar-latente-${roomId}`, totals.arLatente);

  updateElementText(`total-externo-${roomId}`, totals.externo);
  updateElementText(`total-divisoes-${roomId}`, totals.divisoes);
  
  console.log(`‚úÖ Display t√©rmico atualizado para sala: ${roomId}`);
}

/**
 * üîç FUN√á√ïES AUXILIARES DE BUSCA (thermalCalculations.js)
 */

function findRoomContentThermal(roomId) {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (findRoomContentThermal) thermalCalculations.js [ID de sala inv√°lido: ${roomId}]`);
        return null;
    }
    
    console.log(`üîç [THERMAL] Procurando sala: "${roomId}"`);
    
    let roomContent = document.getElementById(`room-content-${roomId}`);
    
    if (roomContent) {
        console.log(`‚úÖ [THERMAL] Sala encontrada pelo ID: room-content-${roomId}`);
        return roomContent;
    }
    
    const roomBlock = document.querySelector(`[data-room-id="${roomId}"]`);
    
    if (roomBlock) {
        const foundId = roomBlock.dataset.roomId;
        console.log(`‚úÖ [THERMAL] Sala encontrada pelo data-room-id: ${foundId}`);
        
        const finalRoomContent = document.getElementById(`room-content-${foundId}`);
        if (finalRoomContent) {
            return finalRoomContent;
        }
    }
  
    console.error(`‚ùå [THERMAL] Sala n√£o encontrada: ${roomId}`);
    const allRooms = document.querySelectorAll('.room-block');
    console.log('üîç [THERMAL] Todas as salas dispon√≠veis no DOM:');
    allRooms.forEach(room => {
        console.log(`  - ID: "${room.dataset.roomId}", Nome: "${room.dataset.roomName}", Projeto: "${room.dataset.projectId}", Obra: "${room.dataset.obraId}"`);
    });
    
    return null;
}

function calculateUValues(tipoConstrucao) {
  const U_VALUE_ALVENARIA_TETO = 3.961;
  const U_VALUE_ALVENARIA_PAREDE = 2.546;
  const U_VALUE_LA_ROCHA_TETO = 1.145;
  const U_VALUE_LA_ROCHA_PAREDE = 1.12;

  console.log(`[THERMAL UVALUES] tipoConstrucao recebido: "${tipoConstrucao}"`);

  let uValueParede, uValueTeto;

  const tipoLower = tipoConstrucao ? tipoConstrucao.toLowerCase() : "";
  
  if (tipoLower === "eletrocentro") {
    uValueParede = U_VALUE_LA_ROCHA_PAREDE;
    uValueTeto = U_VALUE_LA_ROCHA_TETO;
  } else if (tipoLower === "alvenaria") {
    uValueParede = U_VALUE_ALVENARIA_PAREDE;
    uValueTeto = U_VALUE_ALVENARIA_TETO;
  } else {
    uValueParede = 0;
    uValueTeto = 0;
  }

  const result = {
    parede: uValueParede,
    teto: uValueTeto,
    piso: window.systemConstants?.AUX_U_Value_Piso || 2.7,
  };

  console.log("[THERMAL UVALUES] UValues calculados:", result);
  return result;
}

function calculateAuxiliaryVariables(inputData) {
  const vazaoArExterno = safeNumber(inputData.vazaoArExterno);
  const densiAr = window.systemConstants?.Densi_ar || 1.17;

  const m_ArExterno = vazaoArExterno * 3.6 * densiAr * 1000;

  return {
    m_ArExterno: m_ArExterno,
    vazaoArExterno: vazaoArExterno
  };
}

/**
 * üéØ FUN√á√ÉO PRINCIPAL DE C√ÅLCULO (thermalCalculations.js)
 */

async function calculateThermalGains(roomId, vazaoArExterno = 0) {
  try {
    if (!roomId || roomId === 'undefined' || roomId === 'null') {
        console.error(`ERRO FALBACK (calculateThermalGains) thermalCalculations.js [ID de sala inv√°lido: ${roomId}]`);
        return;
    }
    
    console.log(`üî• [THERMAL] Iniciando c√°lculos para sala: ${roomId}`);
    
    await waitForSystemConstants();

    if (!validateSystemConstants()) {
      console.error(`[THERMAL] validateSystemConstants FALHOU para ${roomId}`);
      return;
    }

    const roomContent = findRoomContentThermal(roomId);
    if (!roomContent) {
      console.error(`[THERMAL] room-content-${roomId} N√ÉO ENCONTRADO`);
      return;
    }

    const climaSection = roomContent.querySelector('[id*="-clima"]');
    if (!climaSection) {
      console.error(`[THERMAL] Se√ß√£o clima N√ÉO ENCONTRADA para ${roomId}`);
      return;
    }

    const inputData = collectClimatizationInputs(climaSection, roomId);

    const calcData = {
      ...inputData,
      area: safeNumber(inputData.area),
      paredeOeste: safeNumber(inputData.paredeOeste),
      paredeLeste: safeNumber(inputData.paredeLeste),
      paredeNorte: safeNumber(inputData.paredeNorte),
      paredeSul: safeNumber(inputData.paredeSul),
      peDireito: safeNumber(inputData.peDireito),
      divisoriaNaoClima1: safeNumber(inputData.divisoriaNaoClima1),
      divisoriaNaoClima2: safeNumber(inputData.divisoriaNaoClima2),
      divisoriaClima1: safeNumber(inputData.divisoriaClima1),
      divisoriaClima2: safeNumber(inputData.divisoriaClima2),
      dissipacao: safeNumber(inputData.dissipacao),
      numPessoas: safeNumber(inputData.numPessoas),
      vazaoArExterno: vazaoArExterno
    };

    const uValues = calculateUValues(calcData.tipoConstrucao);
    const auxVars = calculateAuxiliaryVariables({...calcData, vazaoArExterno});

    const gains = {
      teto: calculateCeilingGain(calcData.area, uValues.teto, window.systemConstants.deltaT_teto),
      paredeOeste: calculateWallGain(calcData.paredeOeste, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Oes),
      paredeLeste: calculateWallGain(calcData.paredeLeste, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Les),
      paredeNorte: calculateWallGain(calcData.paredeNorte, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Nor),
      paredeSul: calculateWallGain(calcData.paredeSul, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_parede_Sul),
      divisoriaNaoClima1: calculatePartitionGain(calcData.divisoriaNaoClima1, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_N_clim1),
      divisoriaNaoClima2: calculatePartitionGain(calcData.divisoriaNaoClima2, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_N_clim2),
      divisoriaClima1: calculatePartitionGain(calcData.divisoriaClima1, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_clim1),
      divisoriaClima2: calculatePartitionGain(calcData.divisoriaClima2, calcData.peDireito, uValues.parede, window.systemConstants.deltaT_divi_clim2),
      piso: calculateFloorGain(calcData.area, window.systemConstants),
      iluminacao: calculateLightingGain(calcData.area, window.systemConstants),
      dissipacao: calculateDissipationGain(calcData.dissipacao, window.systemConstants),
      pessoas: calculatePeopleGain(calcData.numPessoas, window.systemConstants),
      arSensivel: calculateExternalAirSensibleGain(vazaoArExterno, auxVars, window.systemConstants),
      arLatente: calculateExternalAirLatentGain(vazaoArExterno, window.systemConstants),
    };

    const totals = calculateTotals(gains);

    console.log(`üî• [THERMAL] Ganhos calculados para ${roomId}:`, gains);
    console.log(`üî• [THERMAL] Totais para ${roomId}:`, totals);
    console.log("üî• [THERMAL] ===== FIM DO C√ÅLCULO DE GANHOS T√âRMICOS =====");

    updateThermalGainsDisplay(roomId, gains, totals, uValues, {...inputData, vazaoArExterno});

    console.log(`üî• [THERMAL] Tentando atualizar tabela de capacidade para ${roomId}`);
    setTimeout(() => {
      if (typeof calculateCapacitySolution === 'function') {
        calculateCapacitySolution(roomId);
      } else if (typeof window.calculateCapacitySolution === 'function') {
        window.calculateCapacitySolution(roomId);
      } else if (typeof updateCapacityFromThermalGains === 'function') {
        updateCapacityFromThermalGains(roomId);
      } else if (typeof window.updateCapacityFromThermalGains === 'function') {
        window.updateCapacityFromThermalGains(roomId);
      } else {
        console.error(`[THERMAL] Nenhuma fun√ß√£o de capacidade encontrada para ${roomId}`);
        
        const capacityTable = document.querySelector(`#room-content-${roomId} .capacity-calculation-table`);
        if (capacityTable) {
          console.log(`[THERMAL] Tabela de capacidade encontrada, tentando inicializa√ß√£o manual`);
          const cargaEstimadaElement = document.getElementById(`carga-estimada-${roomId}`);
          const totalTRElement = document.getElementById(`total-tr-${roomId}`);
          
          if (totalTRElement && cargaEstimadaElement) {
            const totalTR = parseFloat(totalTRElement.textContent) || 0;
            cargaEstimadaElement.textContent = totalTR.toFixed(1);
            console.log(`[THERMAL] Carga estimada atualizada manualmente: ${totalTR}`);
          }
        }
      }
    }, 300);
    
  } catch (error) {
    console.error(`[THERMAL] Erro em calculateThermalGains para ${roomId}:`, error);
  }
}

/**
 * üåê EXPORTA√á√ïES E COMPATIBILIDADE GLOBAL
 */

// Exporta√ß√µes para m√≥dulos ES6
export {
  calculateThermalGains,
  calculateUValues,
  calculateAuxiliaryVariables,
  findRoomContentThermal,
  calculateCeilingGain,
  calculateWallGain,
  calculatePartitionGain,
  calculateFloorGain,
  calculateLightingGain,
  calculateDissipationGain,
  calculatePeopleGain,
  calculateExternalAirSensibleGain,
  calculateExternalAirLatentGain,
  calculateTotals,
  updateThermalGainsDisplay,
  updateWallDisplay,
  updatePartitionDisplay
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
  window.calculateThermalGains = calculateThermalGains;
  window.calculateUValues = calculateUValues;
  window.calculateAuxiliaryVariables = calculateAuxiliaryVariables;
  window.findRoomContentThermal = findRoomContentThermal;
  window.calculateCeilingGain = calculateCeilingGain;
  window.calculateWallGain = calculateWallGain;
  window.calculatePartitionGain = calculatePartitionGain;
  window.calculateFloorGain = calculateFloorGain;
  window.calculateLightingGain = calculateLightingGain;
  window.calculateDissipationGain = calculateDissipationGain;
  window.calculatePeopleGain = calculatePeopleGain;
  window.calculateExternalAirSensibleGain = calculateExternalAirSensibleGain;
  window.calculateExternalAirLatentGain = calculateExternalAirLatentGain;
  window.calculateTotals = calculateTotals;
  window.updateThermalGainsDisplay = updateThermalGainsDisplay;
  window.updateWallDisplay = updateWallDisplay;
  window.updatePartitionDisplay = updatePartitionDisplay;
}
/* ==== FIM: thermal-gains.js ==== */
