
/* ==== IN√çCIO: data/builders/empresa-cadastro-inline.js ==== */
/**
 * features/empresa-cadastro-inline.js
 * Sistema de cadastro inline de empresas para P√°gina 1
 * Integra√ß√£o com dados.json (empresas) e backup.json (obras)
 */

import { showSystemStatus } from '../../ui/components/status.js';
import { extractNumberFromText } from '../../data/utils/data-utils.js';

class EmpresaCadastroInline {
    constructor() {
        this.empresas = [];
        this.obrasExistentes = [];
        this.container = null;
        this.isActive = false;
        
        this.init();
    }

    async init() {
        await this.carregarDados();
        this.vincularEventos();
    }

    async carregarDados() {
        try {
            // Carregar empresas do dados.json
            const responseEmpresas = await fetch('/api/dados/empresas');
            if (responseEmpresas.ok) {
                const dados = await responseEmpresas.json();
                this.empresas = dados.empresas || [];
            }

            // Carregar obras existentes do backup.json
            const responseBackup = await fetch('/api/backup-completo');
            if (responseBackup.ok) {
                const backup = await responseBackup.json();
                this.obrasExistentes = backup.obras || [];
            }

            console.log(`üìä Dados carregados: ${this.empresas.length} empresas, ${this.obrasExistentes.length} obras`);
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados:', error);
        }
    }

    vincularEventos() {
        // Encontrar todos os spans de cadastro de empresas e transformar em bot√µes
        const spansCadastro = document.querySelectorAll('.projetc-header-record.very-dark span');
        
        spansCadastro.forEach(span => {
            // Transformar span em bot√£o
            const button = document.createElement('button');
            button.className = 'btn-empresa-cadastro';
            button.textContent = span.textContent;
            button.setAttribute('type', 'button');
            
            // Substituir span por bot√£o
            span.parentNode.replaceChild(button, span);
            
            // Vincular eventos
            button.addEventListener('click', (e) => this.ativarCadastro(e));
            button.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.ativarCadastro(e);
                }
            });
        });
    }

    ativarCadastro(event) {
        if (this.isActive) return;

        const span = event.target;
        this.container = span.closest('.projetc-header-record');
        
        if (!this.container) {
            console.error('‚ùå Container n√£o encontrado');
            return;
        }

        // Ocultar span e mostrar formul√°rio inline
        span.style.display = 'none';
        this.renderizarFormulario();
        this.isActive = true;

        console.log('‚úÖ Cadastro inline ativado');
    }

    renderizarFormulario() {
        const formHTML = this.criarHTMLFormulario();
        this.container.insertAdjacentHTML('beforeend', formHTML);
        
        // Vincular eventos do formul√°rio
        this.vincularEventosFormulario();
        
        // Focar no primeiro campo
        setTimeout(() => {
            const empresaInput = this.container.querySelector('#empresa-input');
            if (empresaInput) empresaInput.focus();
        }, 100);
    }

    criarHTMLFormulario() {
        return `
        <div class="empresa-cadastro-inline" id="empresa-cadastro-inline">
            <div class="empresa-form-grid">
                <!-- Empresa -->
                <div class="form-group">
                    <label for="empresa-input">Empresa *</label>
                    <input type="text" 
                           id="empresa-input" 
                           class="empresa-input" 
                           placeholder="Digite sigla ou nome..."
                           autocomplete="off">
                    <div class="autocomplete-suggestions" id="empresa-suggestions"></div>
                </div>

                <!-- N√∫mero Cliente Final -->
                <div class="form-group">
                    <label for="numero-cliente-final">N√∫mero Cliente Final</label>
                    <input type="text" 
                           id="numero-cliente-final" 
                           class="numero-cliente-final" 
                           readonly
                           placeholder="Ser√° calculado automaticamente">
                </div>

                <!-- Cliente Final -->
                <div class="form-group">
                    <label for="cliente-final">Cliente Final</label>
                    <input type="text" 
                           id="cliente-final" 
                           class="cliente-final" 
                           placeholder="Nome do cliente final">
                </div>

                <!-- C√≥digo Cliente -->
                <div class="form-group">
                    <label for="codigo-cliente">C√≥digo Cliente</label>
                    <input type="text" 
                           id="codigo-cliente" 
                           class="codigo-cliente" 
                           placeholder="C√≥digo interno do cliente">
                </div>

                <!-- Data do Cadastro -->
                <div class="form-group">
                    <label for="data-cadastro">Data do Cadastro</label>
                    <input type="text" 
                           id="data-cadastro" 
                           class="data-cadastro" 
                           readonly
                           value="${new Date().toLocaleString('pt-BR')}">
                </div>

                <!-- Or√ßamentista Respons√°vel -->
                <div class="form-group">
                    <label for="orcamentista-responsavel">Or√ßamentista Respons√°vel</label>
                    <input type="text" 
                           id="orcamentista-responsavel" 
                           class="orcamentista-responsavel" 
                           placeholder="Nome do or√ßamentista">
                </div>
            </div>

            <div class="empresa-form-actions">
                <button type="button" class="btn btn-cancel" onclick="window.empresaCadastro.cancelarCadastro()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-confirm" onclick="window.empresaCadastro.prepararDados()">
                    Confirmar Dados
                </button>
            </div>

            
        </div>
        `;
    }

    vincularEventosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.addEventListener('input', (e) => this.buscarEmpresas(e.target.value));
            empresaInput.addEventListener('blur', () => {
                setTimeout(() => this.ocultarSugestoes(), 200);
            });
            empresaInput.addEventListener('keydown', (e) => this.tratarTecladoAutocomplete(e));
        }
    }

    async buscarEmpresas(termo) {
        if (!termo || termo.length < 2) {
            this.ocultarSugestoes();
            return;
        }

        const termoNormalizado = this.normalizarTermo(termo);
        const sugestoes = this.filtrarEmpresas(termoNormalizado);
        
        this.exibirSugestoes(sugestoes);
    }

    normalizarTermo(termo) {
        return termo.trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    filtrarEmpresas(termo) {
        return this.empresas.filter(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const primeiroNome = nome.split(' ')[0].toUpperCase();
            
            return sigla === termo || 
                   nomeNormalizado.includes(termo) ||
                   primeiroNome.includes(termo);
        });
    }

    exibirSugestoes(sugestoes) {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (!containerSugestoes) return;

        if (sugestoes.length === 0) {
            this.ocultarSugestoes();
            return;
        }

        const html = sugestoes.map(empresaObj => {
            const [sigla, nome] = Object.entries(empresaObj)[0];
            const primeiroNome = nome.split(' ')[0];

            return `
                <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}">
                    <strong>${sigla}</strong> - ${primeiroNome}
                </div>
            `;
        }).join('');

        containerSugestoes.innerHTML = html;
        containerSugestoes.style.display = 'block';

        // Vincular eventos de clique nas sugest√µes
        containerSugestoes.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                const sigla = item.dataset.sigla;
                const nome = item.dataset.nome;
                this.selecionarEmpresa(sigla, nome);
            });
        });
    }

    ocultarSugestoes() {
        const containerSugestoes = this.container.querySelector('#empresa-suggestions');
        if (containerSugestoes) {
            containerSugestoes.style.display = 'none';
        }
    }

    tratarTecladoAutocomplete(event) {
        const sugestoes = this.container.querySelectorAll('.suggestion-item');
        if (sugestoes.length === 0) return;

        const sugestaoAtiva = this.container.querySelector('.suggestion-item.active');
        
        switch (event.key) {
            case 'ArrowDown':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, 1);
                break;
            case 'ArrowUp':
                event.preventDefault();
                this.navegarSugestoes(sugestoes, sugestaoAtiva, -1);
                break;
            case 'Enter':
                event.preventDefault();
                if (sugestaoAtiva) {
                    const sigla = sugestaoAtiva.dataset.sigla;
                    const nome = sugestaoAtiva.dataset.nome;
                    this.selecionarEmpresa(sigla, nome);
                }
                break;
            case 'Escape':
                this.ocultarSugestoes();
                break;
        }
    }

    navegarSugestoes(sugestoes, atual, direcao) {
        let index = Array.from(sugestoes).indexOf(atual);
        
        if (index === -1) index = direcao > 0 ? -1 : sugestoes.length;
        
        index = (index + direcao + sugestoes.length) % sugestoes.length;
        
        sugestoes.forEach(s => s.classList.remove('active'));
        sugestoes[index].classList.add('active');
    }

    selecionarEmpresa(sigla, nome) {
        const empresaInput = this.container.querySelector('#empresa-input');
        if (empresaInput) {
            empresaInput.value = `${sigla} - ${nome}`;
            empresaInput.dataset.siglaSelecionada = sigla;
            empresaInput.dataset.nomeSelecionado = nome;
        }

        this.ocultarSugestoes();
        this.calcularNumeroClienteFinal(sigla);
    }

    calcularNumeroClienteFinal(sigla) {
        // Filtrar obras existentes pela sigla
        const obrasDaEmpresa = this.obrasExistentes.filter(obra => {
            return obra.empresaSigla === sigla || 
                   (obra.idGerado && obra.idGerado.startsWith(`obra_${sigla}_`));
        });

        // Encontrar maior n√∫mero existente
        let maiorNumero = 0;
        obrasDaEmpresa.forEach(obra => {
            if (obra.numeroClienteFinal && obra.numeroClienteFinal > maiorNumero) {
                maiorNumero = obra.numeroClienteFinal;
            }
            
            // Tamb√©m tentar extrair do ID gerado
            if (obra.idGerado) {
                const match = obra.idGerado.match(new RegExp(`obra_${sigla}_(\\d+)`));
                if (match) {
                    const numero = parseInt(match[1]);
                    if (numero > maiorNumero) maiorNumero = numero;
                }
            }
        });

        const novoNumero = maiorNumero + 1;
        
        const numeroInput = this.container.querySelector('#numero-cliente-final');
        if (numeroInput) {
            numeroInput.value = novoNumero;
        }

        // Atualizar preview do ID da obra
        this.atualizarPreviewIdObra(sigla, novoNumero);
    }

    atualizarPreviewIdObra(sigla, numero) {
        const idObraValue = this.container.querySelector('#obra-id-value');
        
        if (idObraContainer && idObraValue) {
            const idObra = `obra_${sigla}_${numero}`;
            idObraValue.textContent = idObra;
            idObraContainer.style.display = 'block';
        }
    }

    async prepararDados() {
        const dados = this.coletarDadosFormulario();
        
        if (!this.validarDados(dados)) {
            return;
        }

        // Verificar se precisa cadastrar nova empresa
        if (!dados.empresaExistente) {
            const sucesso = await this.cadastrarNovaEmpresa(dados.sigla, dados.nomeEmpresa);
            if (!sucesso) return;
        }

        // Preparar dados para a obra
        this.prepararDadosObra(dados);
        
        showSystemStatus('Dados da empresa preparados! Agora salve a obra.', 'success');
        
        // Ocultar formul√°rio mas manter dados preparados
        this.ocultarFormulario();
    }

    coletarDadosFormulario() {
        const empresaInput = this.container.querySelector('#empresa-input');
        const siglaSelecionada = empresaInput?.dataset.siglaSelecionada;
        const nomeSelecionado = empresaInput?.dataset.nomeSelecionado;
        
        return {
            empresaInput: empresaInput?.value || '',
            sigla: siglaSelecionada,
            nomeEmpresa: nomeSelecionado,
            empresaExistente: !!siglaSelecionada,
            numeroClienteFinal: this.container.querySelector('#numero-cliente-final')?.value || '',
            clienteFinal: this.container.querySelector('#cliente-final')?.value || '',
            codigoCliente: this.container.querySelector('#codigo-cliente')?.value || '',
            dataCadastro: this.container.querySelector('#data-cadastro')?.value || '',
            orcamentistaResponsavel: this.container.querySelector('#orcamentista-responsavel')?.value || ''
        };
    }

    validarDados(dados) {
        if (!dados.empresaInput.trim()) {
            showSystemStatus('Por favor, informe a empresa', 'error');
            return false;
        }

        if (!dados.empresaExistente) {
            // Validar formato da sigla para nova empresa
            const siglaMatch = dados.empresaInput.match(/^[A-Za-z]{3}$/);
            if (siglaMatch) {
                // Usu√°rio digitou apenas sigla - solicitar nome completo
                const nomeCompleto = prompt(`Voc√™ digitou apenas a sigla "${dados.empresaInput}". Por favor, informe o nome completo da empresa:`);
                if (!nomeCompleto || !nomeCompleto.trim()) {
                    showSystemStatus('Nome completo da empresa √© obrigat√≥rio', 'error');
                    return false;
                }
                dados.nomeEmpresa = nomeCompleto.trim();
                dados.sigla = dados.empresaInput.toUpperCase();
            } else {
                // Usu√°rio digitou nome - sugerir sigla
                const primeiraPalavra = dados.empresaInput.split(' ')[0];
                const siglaSugerida = primeiraPalavra.substring(0, 3).toUpperCase();
                
                const siglaConfirmada = prompt(`Empresa n√£o encontrada. Sugerimos a sigla "${siglaSugerida}". Confirme ou digite outra sigla de 3 letras:`, siglaSugerida);
                
                if (!siglaConfirmada || siglaConfirmada.length !== 3) {
                    showSystemStatus('Sigla deve ter exatamente 3 letras', 'error');
                    return false;
                }
                
                dados.sigla = siglaConfirmada.toUpperCase();
                dados.nomeEmpresa = dados.empresaInput;
            }
        }

        return true;
    }

    async cadastrarNovaEmpresa(sigla, nome) {
        try {
            // Verificar se sigla j√° existe
            const siglaExistente = this.empresas.find(empresaObj => {
                const [siglaExistente] = Object.keys(empresaObj);
                return siglaExistente === sigla;
            });

            if (siglaExistente) {
                showSystemStatus(`Sigla ${sigla} j√° est√° em uso. Escolha outra sigla.`, 'error');
                return false;
            }

            // Adicionar nova empresa
            const novaEmpresa = { [sigla]: nome };
            this.empresas.push(novaEmpresa);

            // Salvar no dados.json
            const response = await fetch('/api/dados/empresas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(novaEmpresa)
            });

            if (!response.ok) {
                throw new Error('Erro ao salvar empresa');
            }

            showSystemStatus(`Empresa ${sigla} - ${nome} cadastrada com sucesso!`, 'success');
            return true;

        } catch (error) {
            console.error('‚ùå Erro ao cadastrar nova empresa:', error);
            showSystemStatus('Erro ao cadastrar empresa', 'error');
            return false;
        }
    }

    /**
     * Atualiza o header da obra com a sigla e numera√ß√£o
     * @param {HTMLElement} obraElement - Elemento da obra
     * @param {Object} dadosEmpresa - Dados da empresa
     */


    atualizarHeaderObra(obraElement, dadosEmpresa) {
        try {
            const headerSpacer = obraElement.querySelector('.obra-header-spacer');
            if (!headerSpacer) {
                console.error('‚ùå Elemento .obra-header-spacer n√£o encontrado');
                return;
            }

            // Limpar conte√∫do atual
            headerSpacer.innerHTML = '';

            if (dadosEmpresa.empresaSigla && dadosEmpresa.numeroClienteFinal) {
                // Criar bot√£o com sigla e n√∫mero
                const button = document.createElement('button');
                button.className = 'btn-empresa-identifier';
                const textoHeader = `${dadosEmpresa.empresaSigla}-${dadosEmpresa.numeroClienteFinal}`;
                button.textContent = textoHeader;
                button.setAttribute('data-tooltip', this.criarTooltipEmpresa(dadosEmpresa));
                button.onclick = (e) => this.ativarCadastro(e);
                
                headerSpacer.appendChild(button);
                console.log(`‚úÖ Header da obra atualizado: ${textoHeader}`);
            } else {
                // Bot√£o padr√£o
                this.resetHeaderObra(headerSpacer);
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar header da obra:', error);
        }
    }



    /**
     * Cria texto de tooltip com informa√ß√µes completas da empresa
     * @param {Object} dadosEmpresa - Dados da empresa
     * @returns {string} Texto do tooltip
     */
    criarTooltipEmpresa(dadosEmpresa) {
        const partes = [];
        
        if (dadosEmpresa.empresaNome) {
            partes.push(`Empresa: ${dadosEmpresa.empresaNome}`);
        }
        if (dadosEmpresa.clienteFinal) {
            partes.push(`Cliente: ${dadosEmpresa.clienteFinal}`);
        }
        if (dadosEmpresa.codigoCliente) {
            partes.push(`C√≥digo: ${dadosEmpresa.codigoCliente}`);
        }
        if (dadosEmpresa.dataCadastro) {
            // üÜï FORMATAR DATA PARA dd/mm/aaaa
            const dataFormatada = this.formatarDataParaTooltip(dadosEmpresa.dataCadastro);
            partes.push(`Data: ${dataFormatada}`);
        }
        if (dadosEmpresa.orcamentistaResponsavel) {
            partes.push(`Or√ßamentista: ${dadosEmpresa.orcamentistaResponsavel}`);
        }
        
        return partes.join('\n');
    }

    /**
     * Formata data para o formato dd/mm/aaaa no tooltip
     * @param {string} dataString - Data em qualquer formato
     * @returns {string} Data formatada como dd/mm/aaaa
     */
    formatarDataParaTooltip(dataString) {
        if (!dataString) return '';
        
        try {
            // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }
            
            // Tentar converter para Date
            const data = new Date(dataString);
            
            if (isNaN(data.getTime())) {
                console.warn(`‚ö†Ô∏è Data inv√°lida no tooltip: ${dataString}`);
                return dataString;
            }
            
            // Formatar para dd/mm/aaaa
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            
            return `${dia}/${mes}/${ano}`;
            
        } catch (error) {
            console.error(`‚ùå Erro ao formatar data para tooltip ${dataString}:`, error);
            return dataString;
        }
    }

    /**
     * Reseta o header para o estado original
     * @param {HTMLElement} headerSpacer - Elemento do header
     */
    /**
     * Reseta o header para o estado original
     */
    resetHeaderObra(headerSpacer) {
        const button = document.createElement('button');
        button.className = 'btn-empresa-cadastro';
        button.textContent = 'Adicionar campos de cadastro de empresas';
        button.onclick = (e) => this.ativarCadastro(e);
        
        headerSpacer.innerHTML = '';
        headerSpacer.appendChild(button);
    }

    /**
     * Prepara dados da obra e atualiza o header
     * @param {Object} dados - Dados coletados do formul√°rio
     */
    prepararDadosObra(dados) {
        // Armazenar dados no container da obra para uso posterior
        const obraBlock = this.container.closest('.obra-block');
        if (obraBlock) {
            obraBlock.dataset.empresaSigla = dados.sigla;
            obraBlock.dataset.empresaNome = dados.nomeEmpresa;
            obraBlock.dataset.numeroClienteFinal = dados.numeroClienteFinal;
            obraBlock.dataset.clienteFinal = dados.clienteFinal;
            obraBlock.dataset.codigoCliente = dados.codigoCliente;
            
            // üÜï USAR DATA FORMATADA
            const dataFormatada = this.formatarData(dados.dataCadastro);
            obraBlock.dataset.dataCadastro = dataFormatada;
            
            obraBlock.dataset.orcamentistaResponsavel = dados.orcamentistaResponsavel;
            obraBlock.dataset.idGerado = `obra_${dados.sigla}_${dados.numeroClienteFinal}`;
            
            // üÜï ATUALIZAR HEADER DA OBRA
            this.atualizarHeaderObra(obraBlock, {
                empresaSigla: dados.sigla,
                empresaNome: dados.nomeEmpresa,
                numeroClienteFinal: dados.numeroClienteFinal,
                clienteFinal: dados.clienteFinal,
                codigoCliente: dados.codigoCliente,
                dataCadastro: dataFormatada, // üÜï DATA FORMATADA
                orcamentistaResponsavel: dados.orcamentistaResponsavel
            });
            
            console.log('üì¶ Dados da obra preparados:', obraBlock.dataset);
        }
    }

    cancelarCadastro() {
        this.ocultarFormulario();
        this.mostrarSpanOriginal();
        
        // üÜï RESETAR HEADER SE N√ÉO HOUVER DADOS DE EMPRESA
        const obraBlock = this.container.closest('.obra-block');
        if (obraBlock) {
            const headerSpacer = obraBlock.querySelector('.obra-header-spacer span');
            if (headerSpacer && !obraBlock.dataset.empresaSigla) {
                this.resetHeaderObra(headerSpacer);
            }
        }
    }

    ocultarFormulario() {
        const form = this.container.querySelector('#empresa-cadastro-inline');
        if (form) {
            form.remove();
        }
        this.isActive = false;
    }

    mostrarSpanOriginal() {
        const span = this.container.querySelector('span');
        if (span) {
            span.style.display = 'inline';
        }
    }

    // M√©todo para obter dados preparados (usado pelo sistema de salvamento)
    obterDadosPreparados(obraId) {
        const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraBlock) return null;

        return {
            empresaSigla: obraBlock.dataset.empresaSigla,
            empresaNome: obraBlock.dataset.empresaNome,
            numeroClienteFinal: obraBlock.dataset.numeroClienteFinal ? parseInt(obraBlock.dataset.numeroClienteFinal) : null,
            clienteFinal: obraBlock.dataset.clienteFinal,
            codigoCliente: obraBlock.dataset.codigoCliente,
            dataCadastro: obraBlock.dataset.dataCadastro,
            orcamentistaResponsavel: obraBlock.dataset.orcamentistaResponsavel,
            idGerado: obraBlock.dataset.idGerado
        };
    }
    /**
     * Formata data para dd/mm/aaaa
     */
    formatarData(dataString) {
        if (!dataString) return '';
        
        try {
            // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
            if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataString;
            }
            
            const data = new Date(dataString);
            
            if (isNaN(data.getTime())) {
                console.warn(`‚ö†Ô∏è Data inv√°lida: ${dataString}`);
                return dataString;
            }
            
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            
            return `${dia}/${mes}/${ano}`;
            
        } catch (error) {
            console.error(`‚ùå Erro ao formatar data ${dataString}:`, error);
            return dataString;
        }
    }
}

// Exporta√ß√£o e inicializa√ß√£o
export default EmpresaCadastroInline;

if (typeof window !== 'undefined') {
    window.EmpresaCadastroInline = EmpresaCadastroInline;
    
    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        window.empresaCadastro = new EmpresaCadastroInline();
    });
}
/* ==== FIM: data/builders/empresa-cadastro-inline.js ==== */

/* ==== IN√çCIO: data/adapters/obra-adapter.js ==== */
// adapters/obra-adapter.js - CORRE√á√ÉO COMPLETA COM EMPRESAS:

/**
 * Remove todas as obras base do container HTML
 */
function removeBaseObraFromHTML() {
    const obrasContainer = document.getElementById("projects-container")
    if (!obrasContainer) return

    const existingObras = obrasContainer.querySelectorAll(".obra-block")
    existingObras.forEach((obra) => obra.remove())
}

/**
 * Carrega obras salvas do servidor para a sess√£o atual - 
 */
async function loadObrasFromServer() {
    console.log("üîÑ [LOAD OBRAS] Carregando OBRAS do servidor...");
    
    try {
        const sessionResponse = await fetch('/api/session-obras');
        if (!sessionResponse.ok) {
            console.log("üì≠ Nenhuma sess√£o ativa encontrada");
            return;
        }
        
        const sessionData = await sessionResponse.json();
        const obraIds = sessionData.obras || [];
        
        console.log(`üìä [LOAD OBRAS] Sess√£o com ${obraIds.length} obras:`, obraIds);
        
        if (obraIds.length === 0) {
            console.log("üì≠ [LOAD OBRAS] Nenhuma obra na sess√£o");
            return;
        }

        // Buscar TODAS as obras do servidor
        const obrasResponse = await fetch('/obras');
        if (!obrasResponse.ok) {
            console.error("‚ùå [LOAD OBRAS] Erro ao buscar dados das obras");
            return;
        }

        const todasObras = await obrasResponse.json();
        console.log(`üì¶ [LOAD OBRAS] ${todasObras.length} obras dispon√≠veis no servidor`);
        
        // Converter IDs da sess√£o para string e encontrar correspond√™ncias
        const obrasDaSessao = todasObras.filter(obra => {
            // Tentar encontrar por ID exato (novo formato)
            if (obraIds.includes(obra.id)) {
                return true;
            }
            
            // Tentar encontrar por ID num√©rico (compatibilidade com sess√£o antiga)
            const obraIdNumero = obra.id.toString();
            if (obraIds.includes(obraIdNumero)) {
                return true;
            }
            
            return false;
        });
        
        console.log(`üéØ [LOAD OBRAS] ${obrasDaSessao.length} obras da sess√£o encontradas:`, 
            obrasDaSessao.map(o => ({id: o.id, nome: o.nome})));

        if (obrasDaSessao.length === 0) {
            console.log("üì≠ [LOAD OBRAS] Nenhuma obra correspondente encontrada");
            
            // Limpar sess√£o se n√£o encontrar obras correspondentes
            console.log("üîÑ [LOAD OBRAS] Tentando migrar sess√£o para novos IDs...");
            //await migrateSessionToNewIds(obraIds, todasObras);
            return;
        }

        // Limpar interface antes de carregar
        removeBaseObraFromHTML();
        
        // Carregar cada obra individualmente com await
        let loadedCount = 0;
        for (const obraData of obrasDaSessao) {
            const success = await loadSingleObra(obraData);
            if (success) loadedCount++;
        }
        
        console.log(`‚úÖ [LOAD OBRAS] ${loadedCount}/${obrasDaSessao.length} obras carregadas com sucesso`);
        
    } catch (error) {
        console.error("‚ùå [LOAD OBRAS] Erro ao carregar obras da sess√£o:", error);
    }
}

/**
 * Fun√ß√£o para carregar uma obra individual
 */
async function loadSingleObra(obraData) {
    if (!obraData || !obraData.id) {
        console.error('‚ùå [LOAD OBRAS] Dados de obra inv√°lidos:', obraData);
        return false;
    }

    console.log(`üîÑ [LOAD OBRAS] Carregando obra: "${obraData.nome}" (ID: ${obraData.id})`);
    
    try {
        // Verificar se a obra j√° existe no DOM
        const obraExistente = document.querySelector(`[data-obra-id="${obraData.id}"]`);
        if (obraExistente) {
            console.log(`‚ö†Ô∏è [LOAD OBRAS] Obra "${obraData.nome}" j√° existe no DOM, atualizando...`);
            
            if (typeof window.populateObraData === 'function') {
                await window.populateObraData(obraData);
                console.log(`‚úÖ [LOAD OBRAS] Obra "${obraData.nome}" atualizada com sucesso`);
                return true;
            }
        }
        
        // Se n√£o existe, criar nova obra
        if (typeof window.createEmptyObra === 'function') {
            console.log(`üî® [LOAD OBRAS] Criando nova obra: "${obraData.nome}"`);
            
            // Criar obra vazia com ID espec√≠fico
            await window.createEmptyObra(obraData.nome, obraData.id);
            
            // Aguardar cria√ß√£o no DOM
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Verificar se foi criada
            const obraCriada = document.querySelector(`[data-obra-id="${obraData.id}"]`);
            if (obraCriada && typeof window.populateObraData === 'function') {
                console.log(`üé® [LOAD OBRAS] Preenchendo dados da obra "${obraData.nome}"...`);
                await window.populateObraData(obraData);
                
                // üÜï PREPARAR DADOS DE EMPRESA SE EXISTIREM
                await prepararDadosEmpresaNaObra(obraData, obraCriada);
                
                console.log(`‚úÖ [LOAD OBRAS] Obra "${obraData.nome}" carregada com sucesso`);
                return true;
            } else {
                console.error(`‚ùå [LOAD OBRAS] Falha ao criar obra "${obraData.nome}" no DOM`);
            }
        } else {
            console.error(`‚ùå [LOAD OBRAS] createEmptyObra n√£o dispon√≠vel`);
        }
        
        return false;
    } catch (error) {
        console.error(`üí• [LOAD OBRAS] ERRO ao carregar obra "${obraData.nome}":`, error);
        return false;
    }
}

/**
 * üÜï PREPARA DADOS DE EMPRESA NA OBRA CARREGADA
 */
async function prepararDadosEmpresaNaObra(obraData, obraElement) {
    try {
        // Verificar se a obra tem dados de empresa
        const camposEmpresa = [
            'empresaSigla', 'empresaNome', 'numeroClienteFinal', 
            'clienteFinal', 'codigoCliente', 'dataCadastro', 
            'orcamentistaResponsavel', 'idGerado'
        ];
        
        const temDadosEmpresa = camposEmpresa.some(campo => obraData[campo]);
        
        if (!temDadosEmpresa) {
            console.log(`üì≠ [EMPRESA] Obra "${obraData.nome}" n√£o possui dados de empresa`);
            return;
        }
        
        console.log(`üè¢ [EMPRESA] Preparando dados de empresa para obra "${obraData.nome}"`);
        
        // Preencher dados da empresa nos data attributes da obra
        camposEmpresa.forEach(campo => {
            if (obraData[campo]) {
                obraElement.dataset[campo] = obraData[campo];
                console.log(`üìù [EMPRESA] ${campo}: ${obraData[campo]}`);
            }
        });
        
        // üÜï ATUALIZAR INTERFACE COM DADOS DA EMPRESA
        await atualizarInterfaceComEmpresa(obraElement, obraData);
        
        // üÜï ATUALIZAR HEADER DA OBRA
        if (window.empresaCadastro && typeof window.empresaCadastro.atualizarHeaderObra === 'function') {
            window.empresaCadastro.atualizarHeaderObra(obraElement, obraData);
        }
        
        console.log(`‚úÖ [EMPRESA] Dados de empresa preparados para obra "${obraData.nome}"`);
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao preparar dados de empresa:`, error);
    }
}

/**
 * üÜï ATUALIZA A INTERFACE COM OS DADOS DA EMPRESA
 */
async function atualizarInterfaceComEmpresa(obraElement, obraData) {
    try {
        // Encontrar o container de cadastro de empresas
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (!empresaContainer) {
            console.log(`‚ùå [EMPRESA] Container de empresa n√£o encontrado na obra "${obraData.nome}"`);
            return;
        }
        
        // üÜï SEMPRE CRIAR FORMUL√ÅRIO ATIVO (n√£o verificar se j√° existe)
        criarVisualizacaoEmpresa(obraData, empresaContainer);
        
        console.log(`‚úÖ [EMPRESA] Interface atualizada com formul√°rio ativo`);
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao atualizar interface:`, error);
    }
}

/**
 * üÜï ATUALIZA CAMPOS DO FORMUL√ÅRIO DE EMPRESA EXISTENTE - COM DATA FORMATADA
 */
function atualizarCamposEmpresaForm(obraData, formElement) {
    const camposMapping = {
        'empresaSigla': 'empresa-input',
        'numeroClienteFinal': 'numero-cliente-final',
        'clienteFinal': 'cliente-final',
        'codigoCliente': 'codigo-cliente',
        'dataCadastro': 'data-cadastro',
        'orcamentistaResponsavel': 'orcamentista-responsavel'
    };
    
    Object.entries(camposMapping).forEach(([dataField, inputId]) => {
        const input = formElement.querySelector(`#${inputId}`);
        if (input && obraData[dataField]) {
            // üÜï FORMATAR DATA SE FOR O CAMPO dataCadastro
            if (dataField === 'dataCadastro') {
                input.value = formatarData(obraData[dataField]);
            } else {
                input.value = obraData[dataField];
            }
            
            // Configurar dados adicionais para empresa
            if (dataField === 'empresaSigla' && obraData.empresaNome) {
                input.dataset.siglaSelecionada = obraData.empresaSigla;
                input.dataset.nomeSelecionado = obraData.empresaNome;
            }
        }
    });
    
    // Atualizar preview do ID da obra
    const idObraValue = formElement.querySelector('#obra-id-value');
    if (idObraContainer && idObraValue && obraData.idGerado) {
        idObraValue.textContent = obraData.idGerado;
        idObraContainer.style.display = 'block';
    }
}

/**
 * üÜï CRIA FORMUL√ÅRIO DE EMPRESA COM DADOS EXISTENTES - COM DATA FORMATADA
 */
function criarVisualizacaoEmpresa(obraData, container) {
    // Ocultar bot√£o se existir
    const botao = container.querySelector('.btn-empresa-cadastro');
    if (botao) {
        botao.style.display = 'none';
    }
    
    // üÜï FORMATAR DATA
    const dataFormatada = formatarData(obraData.dataCadastro);
    
    // Criar formul√°rio
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Dados da Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <div class="form-group-horizontal">
                <label>Empresa</label>
                <input type="text" class="empresa-input-readonly" 
                    value="${obraData.empresaSigla || ''} - ${obraData.empresaNome || ''}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" class="numero-cliente-final-readonly" 
                    value="${obraData.numeroClienteFinal || ''}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" class="cliente-final-input" 
                    value="${obraData.clienteFinal || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'clienteFinal', '${obraData.id}')">
            </div>

            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" class="codigo-cliente-input" 
                    value="${obraData.codigoCliente || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'codigoCliente', '${obraData.id}')">
            </div>

            <div class="form-group-horizontal">
                <label>Data</label>
                <input type="text" class="data-cadastro-readonly" 
                    value="${dataFormatada}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" class="orcamentista-responsavel-input" 
                    value="${obraData.orcamentistaResponsavel || ''}" 
                    onchange="atualizarDadosEmpresa(this, 'orcamentistaResponsavel', '${obraData.id}')">
            </div>
        </div>



        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraData.id}')">
                Ocultar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    console.log(`‚úÖ [EMPRESA] Formul√°rio criado para obra ${obraData.id} com data: ${dataFormatada}`);
}

/**
 * üÜï FUN√á√ÉO GLOBAL PARA EDITAR DADOS DA EMPRESA
 */
/**
 * üÜï FUN√á√ÉO GLOBAL PARA EDITAR DADOS DA EMPRESA
 */
window.editarDadosEmpresa = function(button, obraId = null) {
    try {
        const visualizacao = button.closest('.empresa-dados-visualizacao');
        let obraBlock;
        
        if (obraId) {
            // Se recebeu obraId, buscar por ID
            obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        } else {
            // Buscar pelo DOM
            obraBlock = visualizacao.closest('.obra-block');
        }
        
        if (!obraBlock) {
            console.error('‚ùå [EMPRESA] Obra n√£o encontrada para edi√ß√£o');
            return;
        }
        
        // Remover visualiza√ß√£o se existir
        if (visualizacao) {
            visualizacao.remove();
        }
        
        // Mostrar span original para ativar cadastro
        const spanOriginal = obraBlock.querySelector('.projetc-header-record.very-dark span');
        if (spanOriginal) {
            spanOriginal.style.display = 'inline';
            
            // Simular clique para ativar cadastro
            if (window.empresaCadastro && typeof window.empresaCadastro.ativarCadastro === 'function') {
                const event = new Event('click');
                spanOriginal.dispatchEvent(event);
            } else {
                spanOriginal.click();
            }
        }
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro ao editar dados da empresa:', error);
    }
};

/**
 * üÜï OBT√âM DADOS DE EMPRESA DE UMA OBRA ESPEC√çFICA
 */
function obterDadosEmpresaDaObra(obraId) {
    try {
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra com ID ${obraId} n√£o encontrada`);
            return null;
        }
        
        const camposEmpresa = [
            'empresaSigla', 'empresaNome', 'numeroClienteFinal', 
            'clienteFinal', 'codigoCliente', 'dataCadastro', 
            'orcamentistaResponsavel', 'idGerado'
        ];
        
        const dadosEmpresa = {};
        let temDados = false;
        
        camposEmpresa.forEach(campo => {
            if (obraElement.dataset[campo]) {
                dadosEmpresa[campo] = obraElement.dataset[campo];
                temDados = true;
            }
        });
        
        return temDados ? dadosEmpresa : null;
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao obter dados de empresa:`, error);
        return null;
    }
}

// Fun√ß√£o alternativa para debug
async function debugLoadObras() {
    console.log("üêõ [DEBUG] Iniciando debug do carregamento...");
    
    // Verificar fun√ß√µes globais
    console.log("üîç [DEBUG] Fun√ß√µes dispon√≠veis:", {
        createEmptyObra: typeof window.createEmptyObra,
        populateObraData: typeof window.populateObraData,
        createEmptyProject: typeof window.createEmptyProject,
        createEmptyRoom: typeof window.createEmptyRoom,
        obterDadosEmpresa: typeof window.obterDadosEmpresa
    });
    
    // Verificar obras no servidor
    try {
        const response = await fetch('/obras');
        if (response.ok) {
            const obras = await response.json();
            console.log(`üì¶ [DEBUG] Obras no servidor: ${obras.length}`, obras.map(o => ({
                id: o.id, 
                nome: o.nome,
                empresaSigla: o.empresaSigla,
                idGerado: o.idGerado
            })));
        }
    } catch (error) {
        console.error("‚ùå [DEBUG] Erro ao buscar obras:", error);
    }
}


/**
 * üÜï FORMATA DATA PARA dd/mm/aaaa
 */
function formatarData(dataString) {
    if (!dataString) return '';
    
    try {
        // Se j√° estiver no formato dd/mm/aaaa, retornar como est√°
        if (typeof dataString === 'string' && dataString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return dataString;
        }
        
        // Tentar parse como Date
        const data = new Date(dataString);
        
        // Verificar se √© uma data v√°lida
        if (isNaN(data.getTime())) {
            console.warn(`‚ö†Ô∏è [EMPRESA] Data inv√°lida: ${dataString}`);
            return dataString; // Retorna original se n√£o conseguir formatar
        }
        
        // Formatar para dd/mm/aaaa
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        
        return `${dia}/${mes}/${ano}`;
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao formatar data ${dataString}:`, error);
        return dataString; // Retorna original em caso de erro
    }
}


/**
 * üÜï ATUALIZA DADOS DA EMPRESA EM TEMPO REAL
 */
window.atualizarDadosEmpresa = function(input, campo, obraId) {
    try {
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra ${obraId} n√£o encontrada`);
            return;
        }
        
        // Atualizar data attribute
        obraElement.dataset[campo] = input.value;
        
        console.log(`üìù [EMPRESA] Campo ${campo} atualizado para:`, input.value);
        
        // Se for cliente final ou or√ßamentista, atualizar tooltip do header
        if (campo === 'clienteFinal' || campo === 'orcamentistaResponsavel') {
            if (window.empresaCadastro && typeof window.empresaCadastro.atualizarHeaderObra === 'function') {
                const dadosAtuais = obterDadosEmpresaDaObra(obraId);
                if (dadosAtuais) {
                    window.empresaCadastro.atualizarHeaderObra(obraElement, dadosAtuais);
                }
            }
        }
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao atualizar campo ${campo}:`, error);
    }
};

/**
 * üÜï OCULTAR FORMUL√ÅRIO DE EMPRESA E RESTAURAR BOT√ÉO
 */
window.ocultarFormularioEmpresa = function(button, obraId) {
    try {
        const formulario = button.closest('.empresa-formulario-ativo');
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra ${obraId} n√£o encontrada`);
            return;
        }
        
        // Encontrar o container de empresa
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (!empresaContainer) {
            console.error(`‚ùå [EMPRESA] Container de empresa n√£o encontrado`);
            return;
        }
        
        // Remover formul√°rio se existir
        if (formulario) {
            formulario.remove();
        }
        
        // Verificar se j√° existe bot√£o
        const botaoExistente = empresaContainer.querySelector('.btn-empresa-cadastro');
        if (!botaoExistente) {
            // Criar e adicionar bot√£o
            const botao = document.createElement('button');
            botao.className = 'btn-empresa-cadastro';
            botao.textContent = 'Adicionar campos de cadastro de empresas';
            botao.onclick = () => window.ativarCadastroEmpresa(obraId);
            
            empresaContainer.appendChild(botao);
        } else {
            // Garantir que o bot√£o est√° vis√≠vel
            botaoExistente.style.display = 'block';
        }
        
        console.log(`üëÅÔ∏è [EMPRESA] Formul√°rio ocultado e bot√£o restaurado para obra ${obraId}`);
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro ao ocultar formul√°rio:', error);
    }
};

/**
 * üÜï FUN√á√ÉO GLOBAL PARA ATIVAR CADASTRO DE EMPRESA - CORRIGIDA
 */
window.ativarCadastroEmpresa = function(obraId) {
    try {
        console.log(`üéØ [EMPRESA] Ativando cadastro para obra: ${obraId}`);
        
        const obraElement = document.querySelector(`[data-obra-id="${obraId}"]`);
        if (!obraElement) {
            console.error(`‚ùå [EMPRESA] Obra ${obraId} n√£o encontrada`);
            return;
        }
        
        // Encontrar container de empresa
        const empresaContainer = obraElement.querySelector('.projetc-header-record.very-dark');
        if (!empresaContainer) {
            console.error(`‚ùå [EMPRESA] Container de empresa n√£o encontrado`);
            return;
        }
        
        // ‚úÖ CORRE√á√ÉO: Verificar se j√° existe formul√°rio ativo
        const formularioExistente = empresaContainer.querySelector('.empresa-formulario-ativo');
        if (formularioExistente) {
            console.log(`‚úÖ [EMPRESA] Formul√°rio j√° est√° ativo para obra ${obraId}`);
            return; // ‚úÖ IMPEDE EXECU√á√ÉO DUPLICADA
        }
        
        // Ocultar bot√£o
        const botao = empresaContainer.querySelector('.btn-empresa-cadastro');
        if (botao) {
            botao.style.display = 'none';
        }
        
        // Verificar se h√° dados de empresa existentes
        const dadosEmpresa = obterDadosEmpresaDaObra(obraId);
        
        if (dadosEmpresa) {
            // Se j√° tem dados, criar formul√°rio com dados existentes
            console.log(`üìä [EMPRESA] Criando formul√°rio com dados existentes para obra ${obraId}`);
            criarVisualizacaoEmpresa({...dadosEmpresa, id: obraId}, empresaContainer);
        } else {
            // Se n√£o tem dados, criar formul√°rio vazio para cadastro
            console.log(`üÜï [EMPRESA] Criando novo formul√°rio para obra ${obraId}`);
            criarFormularioVazioEmpresa(obraId, empresaContainer);
        }
        
    } catch (error) {
        console.error(`‚ùå [EMPRESA] Erro ao ativar cadastro para obra ${obraId}:`, error);
    }
};

/**
 * üÜï CRIA FORMUL√ÅRIO VAZIO PARA NOVO CADASTRO COM INPUT H√çBRIDO
 */
function criarFormularioVazioEmpresa(obraId, container) {
    const formularioHTML = `
    <div class="empresa-formulario-ativo">
        <h4>Cadastro de Empresa</h4>

        <div class="empresa-form-grid-horizontal">
            <div class="form-group-horizontal">
                <label>Empresa *</label>
                <div class="empresa-input-container">
                    <input type="text" 
                           class="empresa-input-cadastro" 
                           id="empresa-input-${obraId}"
                           placeholder="Digite sigla ou nome ou selecione..."
                           autocomplete="off">
                    <div class="empresa-dropdown" id="empresa-dropdown-${obraId}">
                        <div class="dropdown-options" id="empresa-options-${obraId}"></div>
                    </div>
                </div>
            </div>

            <div class="form-group-horizontal">
                <label>N¬∫ Cliente</label>
                <input type="text" class="numero-cliente-final-cadastro" readonly
                    placeholder="Ser√° gerado automaticamente">
            </div>

            <div class="form-group-horizontal">
                <label>Cliente Final</label>
                <input type="text" class="cliente-final-cadastro" 
                    placeholder="Nome do cliente final">
            </div>

            <div class="form-group-horizontal">
                <label>C√≥digo</label>
                <input type="text" class="codigo-cliente-cadastro" 
                    placeholder="C√≥digo do cliente">
            </div>

            <div class="form-group-horizontal">
                <label>Data</label>
                <input type="text" class="data-cadastro-cadastro" 
                    value="${new Date().toLocaleDateString('pt-BR')}" readonly>
            </div>

            <div class="form-group-horizontal">
                <label>Or√ßamentista</label>
                <input type="text" class="orcamentista-responsavel-cadastro" 
                    placeholder="Nome do or√ßamentista">
            </div>
        </div>

        <div class="empresa-form-actions">
            <button type="button" class="btn-cancel" 
                    onclick="window.ocultarFormularioEmpresa(this, '${obraId}')">
                Cancelar
            </button>
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formularioHTML);
    
    // Inicializar o input h√≠brido
    setTimeout(() => {
        inicializarInputEmpresaHibrido(obraId);
    }, 100);
}

/**
 * üÜï INICIALIZA INPUT H√çBRIDO DE EMPRESA - COMPLETA E CORRIGIDA
 */
async function inicializarInputEmpresaHibrido(obraId) {
    console.log(`üîß [INPUT H√çBRIDO] Inicializando para obra: ${obraId}`);
    
    const input = document.getElementById(`empresa-input-${obraId}`);
    const dropdown = document.getElementById(`empresa-dropdown-${obraId}`);
    const optionsContainer = document.getElementById(`empresa-options-${obraId}`);
    
    if (!input) {
        console.error(`‚ùå [INPUT H√çBRIDO] Input n√£o encontrado para obra ${obraId}`);
        return;
    }
    
    let empresas = [];
    let empresasCarregadas = false;
    
    // Carregar empresas do banco de dados
    try {
        console.log(`üì° [INPUT H√çBRIDO] Buscando empresas da API...`);
        const response = await fetch('/api/dados/empresas');
        
        if (response.ok) {
            const dados = await response.json();
            
            if (dados.success && Array.isArray(dados.empresas)) {
                empresas = dados.empresas;
                empresasCarregadas = true;
                console.log(`üìä [INPUT H√çBRIDO] ${empresas.length} empresas carregadas com sucesso`);
            } else {
                console.error(`‚ùå [INPUT H√çBRIDO] Resposta da API inv√°lida:`, dados);
            }
        } else {
            console.error(`‚ùå [INPUT H√çBRIDO] Erro HTTP na API: ${response.status} ${response.statusText}`);
        }
    } catch (error) {
        console.error('‚ùå [INPUT H√çBRIDO] Erro de rede ao carregar empresas:', error);
    }
    
    // Se n√£o conseguiu carregar empresas, mostrar mensagem
    if (!empresasCarregadas) {
        console.warn('‚ö†Ô∏è [INPUT H√çBRIDO] N√£o foi poss√≠vel carregar empresas do servidor');
        
        // Mostrar mensagem no dropdown quando o usu√°rio tentar usar
        input.addEventListener('focus', function() {
            optionsContainer.innerHTML = `
                <div class="dropdown-no-results">
                    ‚ùå Erro ao carregar empresas<br>
                    <small>Tente recarregar a p√°gina</small>
                </div>
            `;
            dropdown.style.display = 'block';
        });
        
        return; // N√£o inicializa o resto da funcionalidade
    }
    
    // Verificar se encontrou empresas
    if (empresas.length === 0) {
        console.warn('‚ö†Ô∏è [INPUT H√çBRIDO] Nenhuma empresa cadastrada no sistema');
        
        input.addEventListener('focus', function() {
            optionsContainer.innerHTML = `
                <div class="dropdown-no-results">
                    üìù Nenhuma empresa cadastrada<br>
                    <small>Cadastre empresas primeiro</small>
                </div>
            `;
            dropdown.style.display = 'block';
        });
        
        return;
    }
    
    // ‚úÖ EMPRESAS CARREGADAS COM SUCESSO - INICIALIZAR FUNCIONALIDADE COMPLETA
    
    // Evento de input para busca em tempo real
    input.addEventListener('input', function(e) {
        const termo = e.target.value.trim();
        console.log(`üîç [INPUT H√çBRIDO] Buscando: "${termo}"`);
        
        // üîÑ SINCRONIZA√á√ÉO: Se o usu√°rio apagou a empresa, limpa o n√∫mero
        if (termo.length === 0) {
            limparNumeroCliente(obraId);
            
            // Limpa dados de sele√ß√£o
            delete input.dataset.siglaSelecionada;
            delete input.dataset.nomeSelecionado;
            
            // ‚úÖ MOSTRA TODAS AS EMPRESAS NOVAMENTE PARA NOVA SELE√á√ÉO
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
            return;
        }
        
        const sugestoes = filtrarEmpresas(termo, empresas);
        console.log(`üéØ [INPUT H√çBRIDO] ${sugestoes.length} sugest√µes encontradas`);
        
        exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
    });
    
    // Evento de foco - mostrar todas as op√ß√µes (ATUALIZADO)
    input.addEventListener('focus', function() {
        const valorAtual = this.value.trim();
        const empresaJaSelecionada = this.dataset.siglaSelecionada;
        
        // üî• SE J√Å TEM EMPRESA SELECIONADA, N√ÉO MOSTRA DROPDOWN
        if (empresaJaSelecionada && valorAtual === `${this.dataset.siglaSelecionada} - ${this.dataset.nomeSelecionado}`) {
            dropdown.style.display = 'none';
            return;
        }
        
        if (valorAtual.length === 0) {
            limparNumeroCliente(obraId);
            exibirTodasEmpresas(empresas, optionsContainer, input, dropdown, obraId);
        } else {
            const sugestoes = filtrarEmpresas(valorAtual, empresas);
            exibirSugestoes(sugestoes, optionsContainer, input, dropdown, obraId);
        }
    });

    
    // Evento de blur - verifica se deve limpar quando perde foco
    input.addEventListener('blur', function() {
        setTimeout(() => {
            const valorAtual = this.value.trim();
            if (valorAtual.length === 0) {
                limparNumeroCliente(obraId);
            }
            
            // Fecha dropdown ap√≥s um delay para permitir clique
            setTimeout(() => {
                dropdown.style.display = 'none';
            }, 150);
        }, 200);
    });
    
    // Evento de teclado para navega√ß√£o
    input.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            navegarDropdown('down', optionsContainer, input);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navegarDropdown('up', optionsContainer, input);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            selecionarOpcaoAtiva(optionsContainer, input, dropdown, obraId);
        } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
            input.blur();
        }
    });
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    console.log(`‚úÖ [INPUT H√çBRIDO] Inicializado com sucesso para obra ${obraId}`);
}

/**
 * üÜï LIMPAR N√öMERO DO CLIENTE QUANDO EMPRESA FOR REMOVIDA
 */
function limparNumeroCliente(obraId) {
    const numeroInput = document.querySelector(`[data-obra-id="${obraId}"] .numero-cliente-final-cadastro`);
    if (numeroInput) {
        numeroInput.value = '';
        console.log(`üîÑ [EMPRESA] N√∫mero do cliente limpo para obra ${obraId}`);
    }
}

/**
 * üÜï FILTRAR EMPRESAS POR TERMO - CORRIGIDA
 */
function filtrarEmpresas(termo, empresas) {
    if (!termo || termo.length < 1) return [];
    
    const termoNormalizado = termo.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    
    return empresas.filter(empresaObj => {
        // Cada empresaObj √© um objeto como { "ACT": "AeroCool Technologies" }
        const [sigla, nome] = Object.entries(empresaObj)[0];
        const nomeNormalizado = nome.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        
        // Buscar por sigla exata ou parcial no nome
        return sigla === termoNormalizado || 
               sigla.includes(termoNormalizado) ||
               nomeNormalizado.includes(termoNormalizado);
    });
}

/**
 * üÜï EXIBIR SUGEST√ïES NO DROPDOWN - COM MENSAGEM PARA CRIA√á√ÉO
 */
function exibirSugestoes(sugestoes, container, input, dropdown, obraId) {
    const valorAtual = input.value.trim();
    const empresaJaSelecionada = input.dataset.siglaSelecionada;
    
    // üî• SE J√Å TEM UMA EMPRESA SELECIONADA E O USU√ÅRIO N√ÉO DIGITOU NADA NOVO
    if (empresaJaSelecionada && valorAtual === `${input.dataset.siglaSelecionada} - ${input.dataset.nomeSelecionado}`) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }
    
    if (!sugestoes || sugestoes.length === 0) {
        // üî• MENSAGEM DIFERENCIADA: Se n√£o encontrou empresas para o termo digitado
        if (valorAtual.length > 0) {
            container.innerHTML = `
                <div class="dropdown-no-results">
                    üìù Nenhuma empresa encontrada<br>
                    <small>Criando nova empresa: "${valorAtual}"</small>
                </div>
            `;
        } else {
            container.innerHTML = '<div class="dropdown-no-results">Digite para buscar empresas</div>';
        }
        dropdown.style.display = 'block';
        return;
    }
    
    const html = sugestoes.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        const primeiroNome = nome.split(' ')[0];
        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}">
                <strong>${sigla}</strong> - ${primeiroNome}
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
    dropdown.style.display = 'block';
    
    // Vincular eventos de clique
    container.querySelectorAll('.dropdown-option').forEach(option => {
        option.addEventListener('click', function() {
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            selecionarEmpresa(sigla, nome, input, dropdown, obraId);
        });
    });
}

/**
 * üÜï EXIBIR TODAS AS EMPRESAS - CORRIGIDO
 */
function exibirTodasEmpresas(empresas, container, input, dropdown, obraId) {
    const empresaJaSelecionada = input.dataset.siglaSelecionada;
    
    // üî• SE J√Å TEM UMA EMPRESA SELECIONADA, N√ÉO MOSTRA O DROPDOWN
    if (empresaJaSelecionada) {
        container.innerHTML = '';
        dropdown.style.display = 'none';
        return;
    }
    
    if (!empresas || empresas.length === 0) {
        container.innerHTML = `
            <div class="dropdown-no-results">
                üìù Nenhuma empresa cadastrada<br>
                <small>Digite o nome para criar uma nova</small>
            </div>
        `;
        dropdown.style.display = 'block';
        return;
    }
    
    const html = empresas.map(empresaObj => {
        const [sigla, nome] = Object.entries(empresaObj)[0];
        const primeiroNome = nome.split(' ')[0];
        return `
            <div class="dropdown-option" data-sigla="${sigla}" data-nome="${nome}">
                <strong>${sigla}</strong> - ${primeiroNome}
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
    dropdown.style.display = 'block';
    
    // Vincular eventos de clique
    container.querySelectorAll('.dropdown-option').forEach(option => {
        option.addEventListener('click', function() {
            const sigla = this.dataset.sigla;
            const nome = this.dataset.nome;
            selecionarEmpresa(sigla, nome, input, dropdown, obraId);
        });
    });
}

/**
 * üÜï NAVEGAR NO DROPDOWN COM TECLADO
 */
function navegarDropdown(direcao, container, input) {
    const options = container.querySelectorAll('.dropdown-option');
    if (options.length === 0) return;
    
    const activeOption = container.querySelector('.dropdown-option.active');
    let nextIndex = 0;
    
    if (activeOption) {
        const currentIndex = Array.from(options).indexOf(activeOption);
        nextIndex = direcao === 'down' 
            ? Math.min(currentIndex + 1, options.length - 1)
            : Math.max(currentIndex - 1, 0);
    }
    
    options.forEach(opt => opt.classList.remove('active'));
    options[nextIndex].classList.add('active');
    
    // Scroll para a op√ß√£o ativa
    options[nextIndex].scrollIntoView({ block: 'nearest' });
}

/**
 * üÜï SELECIONAR OP√á√ÉO ATIVA COM ENTER
 */
function selecionarOpcaoAtiva(container, input, dropdown, obraId) {
    const activeOption = container.querySelector('.dropdown-option.active');
    if (activeOption) {
        const sigla = activeOption.dataset.sigla;
        const nome = activeOption.dataset.nome;
        selecionarEmpresa(sigla, nome, input, dropdown, obraId);
    }
}

/**
 * üÜï SELECIONAR EMPRESA
 */
function selecionarEmpresa(sigla, nome, input, dropdown, obraId) {
    input.value = `${sigla} - ${nome}`;
    input.dataset.siglaSelecionada = sigla;
    input.dataset.nomeSelecionado = nome;
    dropdown.style.display = 'none';
    
    // üîÑ S√ì CALCULA O N√öMERO SE UMA EMPRESA FOI SELECIONADA
    calcularNumeroClienteFinal(sigla, obraId);
    
    console.log(`‚úÖ [EMPRESA] Empresa selecionada: ${sigla} - ${nome}`);
}

/**
 * üÜï CALCULAR N√öMERO DO CLIENTE FINAL - CORRIGIDO E MAIS ROBUSTO
 */
async function calcularNumeroClienteFinal(sigla, obraId) {
    try {
        console.log(`üî¢ [EMPRESA] Calculando n√∫mero para: ${sigla}`);
        
        // Tentar a API primeiro
        const response = await fetch(`/api/dados/empresas/numero/${encodeURIComponent(sigla)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const dados = await response.json();
        
        if (dados.success) {
            const novoNumero = dados.numero;
            atualizarNumeroClienteInput(novoNumero, obraId);
            console.log(`‚úÖ [EMPRESA] N√∫mero da API: ${novoNumero} para ${sigla}`);
        } else {
            console.warn('‚ö†Ô∏è [EMPRESA] API retornou erro, usando c√°lculo local:', dados.error);
            calcularNumeroLocal(sigla, obraId);
        }
        
    } catch (error) {
        console.warn('‚ö†Ô∏è [EMPRESA] Erro na API, usando c√°lculo local:', error.message);
        calcularNumeroLocal(sigla, obraId);
    }
}

/**
 * üÜï CALCULAR N√öMERO LOCALMENTE COMO FALLBACK
 */
async function calcularNumeroLocal(sigla, obraId) {
    try {
        // Buscar todas as obras para calcular localmente
        const response = await fetch('/api/backup-completo');
        if (!response.ok) {
            throw new Error('N√£o foi poss√≠vel carregar obras');
        }
        
        const backup = await response.json();
        const obrasExistentes = backup.obras || [];
        
        // Filtrar obras da mesma empresa
        const obrasDaEmpresa = obrasExistentes.filter(obra => 
            obra.empresaSigla === sigla || 
            (obra.idGerado && obra.idGerado.startsWith(`obra_${sigla}_`))
        );
        
        // Encontrar maior n√∫mero
        let maiorNumero = 0;
        obrasDaEmpresa.forEach(obra => {
            if (obra.numeroClienteFinal && obra.numeroClienteFinal > maiorNumero) {
                maiorNumero = obra.numeroClienteFinal;
            }
            
            if (obra.idGerado) {
                const match = obra.idGerado.match(new RegExp(`obra_${sigla}_(\\d+)`));
                if (match) {
                    const numero = parseInt(match[1]);
                    if (numero > maiorNumero) maiorNumero = numero;
                }
            }
        });
        
        const novoNumero = maiorNumero + 1;
        atualizarNumeroClienteInput(novoNumero, obraId);
        console.log(`üî¢ [EMPRESA] N√∫mero local: ${novoNumero} para ${sigla}`);
        
    } catch (error) {
        console.error('‚ùå [EMPRESA] Erro no c√°lculo local:', error);
        // Fallback final: n√∫mero aleat√≥rio
        const numeroFallback = Math.floor(Math.random() * 100) + 1;
        atualizarNumeroClienteInput(numeroFallback, obraId);
        console.log(`üîÑ [EMPRESA] N√∫mero fallback: ${numeroFallback} para ${sigla}`);
    }
}

/**
 * üÜï ATUALIZAR INPUT DO N√öMERO DO CLIENTE
 */
function atualizarNumeroClienteInput(numero, obraId) {
    const numeroInput = document.querySelector(`[data-obra-id="${obraId}"] .numero-cliente-final-cadastro`);
    if (numeroInput) {
        numeroInput.value = numero;
    }
}




export {
    formatarData,
    loadObrasFromServer,
    removeBaseObraFromHTML,
    loadSingleObra,
    debugLoadObras,
    obterDadosEmpresaDaObra,
    prepararDadosEmpresaNaObra
};
/* ==== FIM: data/adapters/obra-adapter.js ==== */

/* ==== IN√çCIO: features/managers/obra-manager.js ==== */
/**
 * features/managers/obra-manager.js
 * üéØ FUS√ÉO COMPLETA: projects.js + obra-manager.js
 * ‚ö° REDU√á√ÉO: 2 arquivos ‚Üí 1 arquivo (~700 ‚Üí ~450 linhas)
 */
import{getNextObraNumber} from '../../data/utils/data-utils.js'
import { ensureStringId, generateObraId } from '../../data/utils/id-generator.js';
import { buildObraData } from '../../data/builders/data-builders.js';
import { showSystemStatus } from '../../ui/components/status.js';
import { showConfirmationModal } from '../../ui/components/modal/modal.js';
import { addNewProjectToObra } from './project-manager.js';
import { isSessionActive, startSessionOnFirstSave } from '../../data/adapters/session-adapter.js';
import { calculateRoomCompletionStats } from '../../ui/helpers.js';

/**
 * üèóÔ∏è FUN√á√ïES DE CONSTRU√á√ÉO DE INTERFACE (obra-manager.js)
 */

function buildObraHTML(obraName, obraId, hasId = false) {
    if (!obraId || obraId === 'undefined' || obraId === 'null') {
        console.error(`ERRO FALBACK (buildObraHTML) [ID de obra inv√°lido: ${obraId}]`);
        obraId = generateObraId();
    }
    
    console.log(`üîç Build Obra HTML: ${obraName}, ID: ${obraId}`);

    return `
    <div class="obra-block" data-obra-id="${obraId}" data-obra-name="${obraName}">
        <div class="obra-header">
            <button class="minimizer" onclick="toggleObra('${obraId}', event)">+</button>
            <h2 class="obra-title compact-title editable-title" data-editable="true" onclick="makeEditable(this, 'obra')">${obraName}</h2>
            <div class="obra-header-spacer"><button class="btn-empresa-identifier" onclick="window.ativarCadastroEmpresa('${obraId}')">Adicionar campos de cadastro de empresas</button></div>
            <div class="obra-actions">
                <button class="btn btn-delete" onclick="window.deleteObra('${obraName}', '${obraId}')">Remover Obra</button>
            </div>
        </div>

        <div class="obra-content collapsed" id="obra-content-${obraId}">
            <div class="projetc-header-record very-dark">
                <button class="btn-empresa-cadastro" onclick="window.ativarCadastroEmpresa('${obraId}')">Adicionar campos de cadastro de empresas</button>
            </div>
            <div class="projects-container" id="projects-${obraId}"></div>
            <div class="add-project-section">
                <button class="btn btn-add-secondary" onclick="addNewProjectToObra('${obraId}')">+ Adicionar Projeto</button>
            </div>
            ${buildObraActionsFooter(obraId, obraName, hasId)} 
        </div>
    </div>
    `;
}

function buildObraActionsFooter(obraId, obraName, hasId = false) {
    const buttonText = hasId ? "Atualizar Obra" : "Salvar Obra";
    const buttonClass = hasId ? "btn-update" : "btn-save";

    console.log(`üîß Build Obra Footer: ${obraName}, ID: ${obraId}, HasId: ${hasId}, Button: ${buttonText}`);

    return `
    <div class="obra-actions-footer">
        <button class="btn btn-verify" onclick="verifyObraData('${obraId}')">Verificar Dados</button>
        <button class="btn ${buttonClass}" onclick="event.preventDefault(); saveOrUpdateObra('${obraId}')">${buttonText}</button>      
        <button class="btn btn-download" onclick="downloadPDF('${obraId}')">Baixar PDF</button>
        <button class="btn btn-download" onclick="downloadWord('${obraId}')">Baixar Word</button>
    </div>
    `;
}

async function insertObraIntoDOM(obraHTML, obraId) {
    console.log(`üì§ Inserindo obra no DOM: ${obraId}`);
    
    const projectsContainer = document.getElementById("projects-container");
    
    if (!projectsContainer) {
        console.error('‚ùå Container de projetos n√£o encontrado');
        
        const mainContent = document.querySelector('main, body');
        if (mainContent) {
            const newContainer = document.createElement('div');
            newContainer.id = 'projects-container';
            newContainer.innerHTML = '<!-- Hierarquia: Obra ‚Üí Projeto ‚Üí Sala -->';
            mainContent.appendChild(newContainer);
            console.log('‚úÖ projects-container criado');
            return insertObraIntoDOM(obraHTML, obraId);
        }
        
        return false;
    }
    
    console.log(`‚úÖ Container encontrado, inserindo obra ${obraId}...`);
    console.log(`üì¶ Container antes:`, projectsContainer.children.length, 'elementos');
    
    try {
        projectsContainer.insertAdjacentHTML("beforeend", obraHTML);
        
        setTimeout(() => {
            const obraInserida = document.querySelector(`[data-obra-id="${obraId}"]`);
            if (obraInserida) {
                console.log(`‚úÖ Obra ${obraId} INSERIDA COM SUCESSO no container`);
                console.log(`üì¶ Container depois:`, projectsContainer.children.length, 'elementos');
            } else {
                console.error(`‚ùå FALHA: Obra ${obraId} N√ÉO FOI INSERIDA no container`);
            }
        }, 50);
        
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao inserir obra no DOM:', error);
        return false;
    }
}

async function createEmptyObra(obraName, obraId) {
    const finalObraId = obraId || generateObraId();
    const obraHTML = buildObraHTML(obraName, finalObraId);
    
    console.log(`üèóÔ∏è Criando obra: ${obraName} com ID: ${finalObraId}`);
    console.log(`üìù HTML gerado:`, obraHTML.substring(0, 200) + '...');
    
    const inserted = await insertObraIntoDOM(obraHTML, finalObraId);
    
    if (inserted) {
        console.log(`‚úÖ Obra ${obraName} criada e INSERIDA NO DOM - ID: ${finalObraId}`);
        
        setTimeout(() => {
            const obraNoDOM = document.querySelector(`[data-obra-id="${finalObraId}"]`);
            if (obraNoDOM) {
                console.log(`‚úÖ CONFIRMADO: Obra ${finalObraId} encontrada no DOM`);
            } else {
                console.error(`‚ùå FALHA CR√çTICA: Obra ${finalObraId} N√ÉO est√° no DOM ap√≥s cria√ß√£o`);
            }
        }, 100);
    } else {
        console.error(`‚ùå FALHA: Obra ${obraName} N√ÉO FOI INSERIDA NO DOM`);
    }
    
    return inserted;
}

/**
 * üîÑ FUN√á√ïES DE ATUALIZA√á√ÉO DE INTERFACE
 */

function updateObraButtonAfterSave(obraName, obraId) {
    console.log(`üîÑ Atualizando bot√£o da obra: ${obraName} (${obraId})`);
    
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraBlock) {
        console.error(`‚ùå Obra com ID ${obraId} n√£o encontrada para atualizar bot√£o`);
        return;
    }

    obraBlock.dataset.obraId = obraId;

    const obraContent = document.getElementById(`obra-content-${obraId}`);
    if (!obraContent) {
        console.error(`‚ùå Conte√∫do da obra ${obraId} n√£o encontrado`);
        return;
    }

    const oldFooter = obraContent.querySelector('.obra-actions-footer');
    if (!oldFooter) {
        console.error(`‚ùå Rodap√© n√£o encontrado na obra ${obraId}`);
        return;
    }

    const saveButton = oldFooter.querySelector('.btn-save, .btn-update');
    if (saveButton) {
        saveButton.textContent = "Atualizar Obra";
        saveButton.className = "btn btn-update";
        saveButton.setAttribute('onclick', `event.preventDefault(); saveOrUpdateObra('${obraId}')`);
        console.log(`‚úÖ Bot√£o atualizado para: "Atualizar Obra" (ID: ${obraId})`);
    } else {
        console.error(`‚ùå Bot√£o de salvar n√£o encontrado na obra ${obraId}`);
    }

    const projectsContainer = document.getElementById(`projects-${obraId}`);
    if (!projectsContainer) {
        console.error(`‚ùå CR√çTICO: Container de projetos PERDIDO na obra ${obraId}!`);
    }
}



/**
 * üöÄ FUN√á√ïES PRINCIPAIS DE GERENCIAMENTO
 */

async function addNewObra() {
    try {
        const obraNumber = getNextObraNumber();
        const obraName = `Obra${obraNumber}`;
        const obraId = generateObraId();

        console.log(`üèóÔ∏è Criando nova obra: ${obraName} com ID: ${obraId}`);
        await createEmptyObra(obraName, obraId);
        console.log(`‚úÖ ${obraName} adicionada com ID √∫nico: ${obraId}`);

        setTimeout(async () => {
            console.log(`üîÑ Criando projeto e sala autom√°ticos para ${obraName}`);
            if (typeof window.addNewProjectToObra === 'function') {
                await window.addNewProjectToObra(obraId);
                console.log(`‚úÖ Projeto e sala autom√°ticos criados para ${obraName}`);
            } else {
                console.error('‚ùå addNewProjectToObra n√£o dispon√≠vel');
            }
        }, 500);

    } catch (error) {
        console.error("‚ùå Erro ao adicionar nova obra:", error);
        alert("Erro ao criar nova obra. Verifique o console para detalhes.");
    }
}

async function deleteObra(obraName, obraId) {
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraBlock) {
        console.error(`‚ùå Obra com ID ${obraId} n√£o encontrada`);
        return;
    }

    showConfirmationModal(obraName, obraId, obraBlock);
}

/**
 * üíæ FUN√á√ïES DE PERSIST√äNCIA (projects.js)
 */

async function fetchObras() {
    try {
        const response = await fetch('/obras');

        if (!response.ok) {
            if (response.status === 404) {
                return [];
            }
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        const obras = await response.json();
        return obras || [];
    } catch (error) {
        console.error("‚ùå Erro ao buscar obras:", error);
        return [];
    }
}

async function atualizarObra(obraId, obraData) {
    try {
        if (!obraId || obraId === 'undefined' || obraId === 'null') {
            console.error(`ERRO FALBACK (atualizarObra) [ID de obra inv√°lido: ${obraId}]`);
            showSystemStatus("ERRO: ID da obra inv√°lido para atualiza√ß√£o", "error");
            return null;
        }

        if (!isSessionActive()) {
            console.warn("‚ö†Ô∏è Sess√£o n√£o est√° ativa - obra n√£o ser√° atualizada");
            showSystemStatus("ERRO: Sess√£o n√£o est√° ativa. Obra n√£o atualizada.", "error");
            return null;
        }

        obraId = ensureStringId(obraId);

        console.log(`üîç Verificando se obra ${obraId} existe no servidor...`);
        
        const todasObrasResponse = await fetch('/api/backup-completo');
        if (!todasObrasResponse.ok) {
            throw new Error('Falha ao carregar backup para verifica√ß√£o');
        }
        
        const backupData = await todasObrasResponse.json();
        const todasObras = backupData.obras || [];
        const obraExistente = todasObras.find(obra => String(obra.id) === String(obraId));
        
        console.log(`üìä Verifica√ß√£o: Obra ${obraId} existe? ${!!obraExistente}`);
        console.log(`üìã TODAS as obras no backup:`, todasObras.map(o => ({ id: o.id, nome: o.nome })));

        if (!obraExistente) {
            console.log(`‚ùå Obra ${obraId} n√£o encontrada no backup, criando nova...`);
            console.log(`üÜï Criando nova obra com ID seguro preservado: ${obraId}`);
            obraData.id = obraId;
            return await salvarObra(obraData);
        }

        console.log('üîÑ ATUALIZANDO OBRA EXISTENTE:', {
            id: obraData.id,
            nome: obraData.nome,
            projetos: obraData.projetos?.length || 0
        });

        const url = `/obras/${obraId}`;
        console.log(`üéØ Fazendo PUT para: ${url}`);
        
        const response = await fetch(url, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(obraData),
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro ao atualizar obra: ${errorText}`);
        }

        const updatedObra = await response.json();
        showSystemStatus("Obra atualizada com sucesso!", "success");
        
        console.log('‚úÖ OBRA ATUALIZADA:', {
            id: updatedObra.id,
            nome: updatedObra.nome,
            projetos: updatedObra.projetos?.length || 0
        });
        return updatedObra;
    } catch (error) {
        console.error("‚ùå Erro ao ATUALIZAR obra:", error);
        showSystemStatus("ERRO: N√£o foi poss√≠vel atualizar a obra", "error");
        return null;
    }
}

async function salvarObra(obraData) {
    try {
        if (!obraData || !obraData.nome) {
            console.error(`ERRO FALBACK (salvarObra) [Dados da obra inv√°lidos: ${JSON.stringify(obraData)}]`);
            showSystemStatus("ERRO: Dados da obra inv√°lidos", "error");
            return null;
        }

        if (!isSessionActive()) {
            console.warn("‚ö†Ô∏è Sess√£o n√£o est√° ativa - obra n√£o ser√° salva");
            showSystemStatus("ERRO: Sess√£o n√£o est√° ativa. Obra n√£o salva.", "error");
            return null;
        }

        if (!obraData.id || obraData.id === 'undefined' || obraData.id === 'null') {
            console.error(`ERRO FALBACK (salvarObra) [Obra sem ID seguro: ${obraData.id}]`);
            showSystemStatus("ERRO: Obra n√£o possui ID v√°lido", "error");
            return null;
        }

        console.log('üì§ SALVANDO NOVA OBRA:', {
            id: obraData.id,
            nome: obraData.nome,
            projetos: obraData.projetos?.length || 0,
            timestamp: obraData.timestamp
        });

        const response = await fetch('/obras', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(obraData),
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro ao salvar obra: ${errorText}`);
        }

        const createdObra = await response.json();
        
        console.log(`üìù Adicionando obra ${createdObra.id} √† sess√£o...`);
        await fetch('/api/sessions/add-obra', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ obra_id: createdObra.id })
        });
        
        showSystemStatus("Obra salva com sucesso!", "success");
        
        console.log('‚úÖ NOVA OBRA SALVA E ADICIONADA √Ä SESS√ÉO:', {
            id: createdObra.id,
            nome: createdObra.nome,
            projetos: createdObra.projetos?.length || 0
        });
        return createdObra;
    } catch (error) {
        console.error("‚ùå Erro ao SALVAR obra:", error);
        showSystemStatus("ERRO: N√£o foi poss√≠vel salvar a obra", "error");
        return null;
    }
}

/**
 * üîç FUN√á√ïES AUXILIARES DE BUSCA E VERIFICA√á√ÉO
 */

function findObraBlock(obraId) {
    console.log(`üîç Buscando obra pelo ID: "${obraId}"`);
    
    let obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (obraBlock) {
        console.log(`‚úÖ Obra encontrada por ID exato: "${obraId}"`);
        return obraBlock;
    }
    
    const todasObras = document.querySelectorAll('[data-obra-id]');
    console.log(`üìã Obras encontradas no DOM: ${todasObras.length}`);
    
    todasObras.forEach((obra, index) => {
        console.log(`  ${index + 1}.`, {
            id: obra.dataset.obraId,
            name: obra.dataset.obraName,
            classes: obra.className
        });
    });
    
    console.log(`‚ùå Obra com ID "${obraId}" n√£o encontrada no DOM`);
    return null;
}

async function findObraBlockWithRetry(obraId, maxAttempts = 10) {
    console.log(`üîç Buscando obra com retry: "${obraId}"`);
    
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
        
        if (obraBlock) {
            console.log(`‚úÖ Obra encontrada na tentativa ${attempt}/${maxAttempts}`);
            return obraBlock;
        }
        
        console.log(`‚è≥ Tentativa ${attempt}/${maxAttempts} - obra n√£o encontrada, aguardando...`);
        
        if (attempt < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 200));
        }
    }
    
    console.log(`‚ùå Obra n√£o encontrada ap√≥s ${maxAttempts} tentativas`);
    return null;
}



/**
 * üíæ FUN√á√ÉO PRINCIPAL DE SALVAMENTO
 */

async function saveObra(obraId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    console.log(`üíæ SALVANDO OBRA pelo ID: "${obraId}"`);

    let obraBlock = await findObraBlockWithRetry(obraId, 15);
    
    if (!obraBlock) {
        console.error('‚ùå Obra n√£o encontrada no DOM ap√≥s m√∫ltiplas tentativas:', obraId);
        
        const todasObras = document.querySelectorAll('[data-obra-id]');
        console.log('üìã Obras dispon√≠veis no DOM:', Array.from(todasObras).map(o => ({
            id: o.dataset.obraId,
            name: o.dataset.obraName
        })));
        
        showSystemStatus("ERRO: Obra n√£o encontrada na interface", "error");
        return;
    }

    const obraOriginalReference = obraBlock;
    const obraContainer = obraBlock.parentElement;
    
    console.log('üîí REFER√äNCIA SALVA:', {
        obra: obraOriginalReference,
        container: obraContainer,
        obraNoContainer: obraContainer.contains(obraOriginalReference)
    });

    if (!isSessionActive()) {
        console.log("üÜï Iniciando sess√£o para primeira obra...");
        await startSessionOnFirstSave();
    }

    if (!isSessionActive()) {
        console.warn("‚ö†Ô∏è Sess√£o n√£o est√° ativa - obra n√£o ser√° salva");
        showSystemStatus("ERRO: Sess√£o n√£o est√° ativa. Obra n√£o salva.", "error");
        return;
    }

    console.log('‚úÖ Obra confirmada no DOM:', {
        element: obraBlock,
        dataset: obraBlock.dataset,
        id: obraBlock.dataset.obraId,
        name: obraBlock.dataset.obraName
    });

    console.log('üî® Construindo dados da obra...');
    const obraData = buildObraData(obraBlock);

    if (!obraData) {
        console.error('‚ùå Falha ao construir dados da obra');
        showSystemStatus("ERRO: Falha ao construir dados da obra", "error");
        return;
    }

    const obraIdFromDOM = obraBlock.dataset.obraId;
    const obraIdFromData = obraData.id;
    const finalObraId = obraIdFromDOM || obraIdFromData;
    
    console.log('üîç VERIFICA√á√ÉO DE OBRA MELHORADA:');
    console.log('- ID no DOM:', obraIdFromDOM);
    console.log('- ID nos dados:', obraIdFromData);
    console.log('- ID final para uso:', finalObraId);
    console.log('- √â ID seguro?:', finalObraId?.startsWith('obra_'));
    
    let isNewObra = true;
    
    try {
        const todasObrasResponse = await fetch('/api/backup-completo');
        if (todasObrasResponse.ok) {
            const backupData = await todasObrasResponse.json();
            const todasObras = backupData.obras || [];
            const obraExistente = todasObras.find(obra => String(obra.id) === String(finalObraId));
            
            isNewObra = !obraExistente;
            console.log(`- J√° existe no servidor?: ${!isNewObra}`);
        }
    } catch (error) {
        console.log('- N√£o foi poss√≠vel verificar servidor, assumindo como nova obra');
    }

    console.log('- √â nova obra?:', isNewObra);

    let result = null;
    
    if (isNewObra) {
        console.log('üÜï SALVANDO COMO NOVA OBRA COM ID SEGURO:', finalObraId);
        
        obraData.id = finalObraId;
        
        if (!obraData.id || !obraData.id.startsWith('obra_')) {
            console.error('‚ùå Obra n√£o possui ID seguro v√°lido para salvar');
            showSystemStatus("ERRO: Obra n√£o possui ID v√°lido", "error");
            return;
        }
        
        result = await salvarObra(obraData);
    } else {
        console.log('üìù ATUALIZANDO OBRA EXISTENTE, ID SEGURO:', finalObraId);
        
        if (!finalObraId.startsWith('obra_')) {
            console.error(`ERRO: ID n√£o seguro para atualiza√ß√£o: ${finalObraId}`);
            showSystemStatus("ERRO: ID da obra inv√°lido para atualiza√ß√£o", "error");
            return;
        }
        
        result = await atualizarObra(finalObraId, obraData);
    }

    if (result) {
        const finalId = ensureStringId(result.id);
        
        let obraBlockAtual = document.querySelector(`[data-obra-id="${finalId}"]`);
        
        if (!obraBlockAtual) {
            console.error('‚ùå CR√çTICO: Obra desapareceu do DOM durante salvamento!');
            console.log('üîç Tentando recuperar da refer√™ncia original...');
            
            if (obraContainer && document.body.contains(obraContainer)) {
                const obrasNoContainer = obraContainer.querySelectorAll('[data-obra-id]');
                console.log(`üì¶ Obras no container original: ${obrasNoContainer.length}`);
                
                if (obraContainer.contains(obraOriginalReference)) {
                    obraBlockAtual = obraOriginalReference;
                    console.log('‚úÖ Obra recuperada da refer√™ncia original');
                } else {
                    console.error('‚ùå Obra n√£o est√° mais no container original');
                    showSystemStatus("ERRO: Obra perdida durante salvamento", "error");
                    return;
                }
            } else {
                console.error('‚ùå Container original n√£o encontrado');
                showSystemStatus("ERRO: Obra perdida durante salvamento", "error");
                return;
            }
        }

        obraBlockAtual.dataset.obraId = finalId;
        obraBlockAtual.dataset.obraName = obraData.nome;
        
        const titleElement = obraBlockAtual.querySelector('.obra-title');
        if (titleElement && titleElement.textContent !== obraData.nome) {
            titleElement.textContent = obraData.nome;
        }

        if (typeof updateObraButtonAfterSave === 'function' && document.body.contains(obraBlockAtual)) {
            console.log("‚úÖ Obra confirmada no DOM, atualizando bot√£o...");
            updateObraButtonAfterSave(obraData.nome, finalId);
        } else {
            console.error('‚ùå Obra n√£o est√° no DOM para atualizar bot√£o');
        }

        console.log(`‚úÖ OBRA SALVA/ATUALIZADA COM SUCESSO! ID SEGURO: ${finalId}`);
        
        showSystemStatus("Obra salva com sucesso!", "success");
    } else {
        console.error('‚ùå FALHA AO SALVAR OBRA NO SERVIDOR');
        showSystemStatus("ERRO: Falha ao salvar obra no servidor", "error");
    }
}

/**
 * üóëÔ∏è FUN√á√ïES DE REMO√á√ÉO E VERIFICA√á√ÉO
 */

async function deleteObraFromServer(obraName, obraId) {
    try {
        if (!obraId || obraId === 'undefined' || obraId === 'null' || !obraId.startsWith('obra_')) {
            console.error(`ERRO FALBACK (deleteObraFromServer) [ID de obra inv√°lido: ${obraId}]`);
            showSystemStatus("ERRO: ID da obra inv√°lido para remo√ß√£o", "error");
            return;
        }

        if (!isSessionActive()) {
            console.warn("‚ö†Ô∏è Sess√£o n√£o est√° ativa - obra n√£o ser√° removida do servidor");
            return;
        }

        obraId = ensureStringId(obraId);

        console.log(`üóëÔ∏è Removendo obra ${obraId} do servidor...`);

        const response = await fetch(`/obras/${obraId}`, {
            method: "DELETE",
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro ao remover obra: ${errorText}`);
        }

        console.log(`‚úÖ Obra ${obraId} removida do servidor`);
        showSystemStatus("Obra removida do servidor com sucesso", "success");
    } catch (error) {
        console.error("‚ùå Erro ao remover obra do servidor:", error);
        showSystemStatus("ERRO: N√£o foi poss√≠vel remover a obra do servidor", "error");
    }
}

function verifyObraData(obraId) {
    const obraBlock = document.querySelector(`[data-obra-id="${obraId}"]`);
    if (!obraBlock) {
        console.error(`‚ùå Obra com ID "${obraId}" n√£o encontrada para verifica√ß√£o`);
        alert(`ERRO: Obra com ID "${obraId}" n√£o encontrada`);
        return;
    }

    const obraName = obraBlock.dataset.obraName;
    const projects = obraBlock.querySelectorAll(".project-block");
    let totalRooms = 0;
    
    let report = `Verifica√ß√£o da Obra "${obraName}" (ID: ${obraId}):\n\n`;
    report += `Total de projetos: ${projects.length}\n\n`;

    projects.forEach((project, index) => {
        const projectName = project.dataset.projectName;
        const rooms = project.querySelectorAll(".room-block");
        totalRooms += rooms.length;
        
        report += `Projeto ${index + 1}: ${projectName}\n`;
        report += `  - Salas: ${rooms.length}\n`;
        
        rooms.forEach((room, roomIndex) => {
            const roomName = room.querySelector(".room-title")?.textContent || `Sala ${roomIndex + 1}`;
            const stats = calculateRoomCompletionStats(room);
            report += `    - ${roomName}: ${stats.filled}/${stats.total} campos (${stats.percentage}%)\n`;
        });
        report += '\n';
    });

    report += `RESUMO: ${projects.length} projetos, ${totalRooms} salas`;

    console.log(`üîç Relat√≥rio gerado para obra: ${obraName} (ID: ${obraId})`);
    alert(report);
}

/**
 * üåê EXPORTA√á√ïES E COMPATIBILIDADE GLOBAL
 */

// Exporta√ß√µes para m√≥dulos ES6
export {
    // Interface
    createEmptyObra,
    buildObraHTML,
    buildObraActionsFooter,
    insertObraIntoDOM,
    updateObraButtonAfterSave,
    addNewObra,
    deleteObra,
    
    // Persist√™ncia
    fetchObras,
    salvarObra,
    atualizarObra,
    saveObra,
    deleteObraFromServer,
    
    // Utilit√°rios
    verifyObraData,
    findObraBlock,
    findObraBlockWithRetry,

    // IDs
    generateObraId,
    ensureStringId
};

// Compatibilidade global para scripts legados
if (typeof window !== 'undefined') {
    window.deleteObra = deleteObra;
    window.addNewObra = addNewObra;
    window.saveObra = saveObra;
    window.verifyObraData = verifyObraData;
    window.findObraBlock = findObraBlock;
    window.generateObraId = generateObraId;
    window.ensureStringId = ensureStringId;
}
/* ==== FIM: features/managers/obra-manager.js ==== */
